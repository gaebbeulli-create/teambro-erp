<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEAM BRO - 통합 ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes neonGlow { 0%, 100% { filter: drop-shadow(0 0 10px #39FF14); } 50% { filter: drop-shadow(0 0 20px #39FF14); } }
        .neon-text { color: #FFF; animation: neonGlow 2s ease-in-out infinite; }
        .glass-card { background: rgba(15, 15, 15, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(57, 255, 20, 0.2); }
        .cyber-grid { background-image: linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px); background-size: 50px 50px; }
        body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .hidden { display: none; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: rgba(57, 255, 20, 0.1); padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #39FF14; white-space: nowrap; }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 13px; }
        .data-table tr:hover { background: rgba(57, 255, 20, 0.05); cursor: pointer; }
        .input-field { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(57, 255, 20, 0.3); color: white; padding: 10px 14px; border-radius: 8px; width: 100%; }
        .input-field:focus { outline: none; border-color: #39FF14; box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #39FF14, #32CD32); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(57, 255, 20, 0.5); }
        .btn-secondary { background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); color: #39FF14; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #EF4444; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 10px; }
        .modal-content { background: #0a0a0a; border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 16px; padding: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; }
        .badge-active { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-delinquent { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-completed { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-rent { background: rgba(147, 51, 234, 0.2); color: #9333EA; }
        .badge-lease { background: rgba(236, 72, 153, 0.2); color: #EC4899; }
        .badge-pending { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-failed { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-accrual { background: rgba(57, 255, 20, 0.2); color: #39FF14; }
        .badge-receipt { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-adjust { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-admin { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-manager { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-staff { background: rgba(107, 114, 128, 0.2); color: #9CA3AF; }
        .badge-waiting { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-progress { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-complete { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-paid { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-unpaid { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-low { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-normal { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-vip { background: rgba(234, 179, 8, 0.2); color: #EAB308; }
        .tab-active { color: #39FF14 !important; border-bottom: 2px solid #39FF14; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-label { color: #9CA3AF; font-size: 13px; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(57,255,20,0.3); border-top-color: #39FF14; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(57, 255, 20, 0.3); border-radius: 4px; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 200; }
        .toast-success { background: rgba(16, 185, 129, 0.9); }
        .toast-error { background: rgba(239, 68, 68, 0.9); }
        .system-card { transition: all 0.3s; cursor: pointer; }
        .system-card:hover { transform: translateY(-4px); border-color: rgba(57, 255, 20, 0.5); }
        .system-card.selected { border-color: #39FF14; box-shadow: 0 0 20px rgba(57, 255, 20, 0.3); }
        .setting-tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .setting-tab:hover { background: rgba(57, 255, 20, 0.05); }
        .setting-tab.active { border-bottom-color: #39FF14; color: #39FF14; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .data-table { display: block; overflow-x: auto; white-space: nowrap; }
            .data-table th, .data-table td { padding: 8px 6px; font-size: 11px; }
            .modal-content { padding: 12px; border-radius: 12px; }
            .glass-card { padding: 12px !important; }
            .btn-primary, .btn-secondary { padding: 8px 12px; font-size: 12px; }
            .btn-sm { padding: 5px 8px; font-size: 10px; }
            .input-field { padding: 8px 10px; font-size: 14px; }
            .text-2xl { font-size: 1.25rem; }
            .text-xl { font-size: 1rem; }
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-5 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .flex-wrap { flex-wrap: wrap; }
            .gap-4 { gap: 8px; }
            .gap-3 { gap: 6px; }
            .mb-6 { margin-bottom: 16px; }
            .mb-4 { margin-bottom: 12px; }
            .p-6 { padding: 12px; }
            .p-4 { padding: 10px; }
            .px-4 { padding-left: 10px; padding-right: 10px; }
            .py-3 { padding-top: 8px; padding-bottom: 8px; }
            h1.text-5xl { font-size: 2rem; }
            .neon-text { font-size: 1.8rem; }
            /* 탭 버튼 스크롤 */
            .tab-scroll { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
            .tab-scroll::-webkit-scrollbar { display: none; }
            .tab-scroll button { flex-shrink: 0; }
            /* 필터 영역 */
            .filter-row { flex-direction: column; align-items: stretch !important; }
            .filter-row > div { width: 100% !important; }
            .filter-row input, .filter-row select { width: 100% !important; margin-bottom: 6px; }
            /* 기간 필터 버튼 */
            .period-btns { display: flex; flex-wrap: wrap; gap: 4px; }
            .period-btns button { padding: 6px 10px; font-size: 11px; flex: 1; min-width: 50px; }
        }
        
        @media (max-width: 480px) {
            .grid-cols-2 { grid-template-columns: 1fr; }
            .data-table th, .data-table td { padding: 6px 4px; font-size: 10px; }
            .badge { padding: 2px 6px; font-size: 9px; }
            h1.text-5xl { font-size: 1.5rem; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="cyber-grid fixed inset-0 pointer-events-none"></div>
    <div id="toast-container"></div>

    <!-- ======================= 로그인 페이지 ======================= -->
    <div id="loginPage" class="relative z-10 min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-lg">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-black neon-text mb-3">TEAM BRO</h1>
                <p class="text-lime-400/70 text-sm">통합 ERP 시스템</p>
            </div>
            <div class="glass-card rounded-2xl p-8">
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-2">아이디</label>
                        <input type="text" id="username" class="input-field" placeholder="아이디 입력" required />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-2">비밀번호</label>
                        <input type="password" id="password" class="input-field" placeholder="비밀번호 입력" required />
                    </div>
                    
                    <!-- 시스템 선택 -->
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-3">시스템 선택</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="system-card glass-card rounded-xl p-4 text-center selected" onclick="selectSystem('settlement')">
                                <div class="text-3xl mb-2">💰</div>
                                <div class="font-bold">정산관리</div>
                                <div class="text-xs text-gray-400 mt-1">렌트·리스 정산</div>
                                <input type="radio" name="system" value="settlement" checked class="hidden">
                            </div>
                            <div class="system-card glass-card rounded-xl p-4 text-center" onclick="selectSystem('bromotors')">
                                <div class="text-3xl mb-2">🔧</div>
                                <div class="font-bold">브로모터스</div>
                                <div class="text-xs text-gray-400 mt-1">직영수리점</div>
                                <input type="radio" name="system" value="bromotors" class="hidden">
                            </div>
                        </div>
                    </div>
                    
                    <div id="loginError" class="hidden p-3 rounded-lg bg-red-400/10 text-red-400 text-sm"></div>
                    <button type="submit" class="w-full btn-primary text-lg py-3">⚡ 로그인</button>
                </form>
            </div>
            <p class="text-center text-gray-500 text-xs mt-4">꿈이 있는 거북이는 지치지 않습니다.</p>
        </div>
    </div>

    <!-- ======================= 정산관리 시스템 ======================= -->
    <div id="settlementSystem" class="hidden">
        <!-- 헤더 -->
        <div class="relative z-10 border-b border-lime-500/30" style="background: linear-gradient(180deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <div onclick="showSettlementTab('overview')" class="cursor-pointer">
                    <h1 class="text-2xl font-black neon-text">정산관리</h1>
                    <p class="text-lime-400/50 text-xs italic">TEAM BRO</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-center">
                        <div class="text-xs text-lime-400/70">오늘 날짜</div>
                        <div class="text-sm font-bold text-lime-400" id="s-today-date"></div>
                    </div>
                    <button onclick="switchSystem()" class="btn-secondary btn-sm">🔧 브로모터스</button>
                    <div class="px-3 py-2 rounded-lg glass-card text-right">
                        <div class="text-xs text-lime-400/70" id="s-userRole">관리자</div>
                        <div class="text-sm font-bold" id="s-userName">Admin</div>
                    </div>
                    <button onclick="handleLogout()" class="btn-danger btn-sm">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="relative z-10 border-b border-lime-500/20 bg-black/50">
            <div class="max-w-7xl mx-auto px-6 flex space-x-1 overflow-x-auto">
                <button onclick="showSettlementTab('overview')" id="s-tab-overview" class="px-4 py-3 font-bold text-sm tab-active">📊 통합현황</button>
                <button onclick="showSettlementTab('contracts')" id="s-tab-contracts" class="px-4 py-3 font-bold text-sm text-gray-500">📋 계약관리</button>
                <button onclick="showSettlementTab('vehicles')" id="s-tab-vehicles" class="px-4 py-3 font-bold text-sm text-gray-500">🚗 차량관리</button>
                <button onclick="showSettlementTab('customers')" id="s-tab-customers" class="px-4 py-3 font-bold text-sm text-gray-500">👥 고객관리</button>
                <button onclick="showSettlementTab('charges')" id="s-tab-charges" class="px-4 py-3 font-bold text-sm text-gray-500">💳 자동결제</button>
                <button onclick="showSettlementTab('ledger')" id="s-tab-ledger" class="px-4 py-3 font-bold text-sm text-gray-500">📖 원장</button>
                <button onclick="showSettlementTab('delinquent')" id="s-tab-delinquent" class="px-4 py-3 font-bold text-sm text-gray-500">⚠️ 연체</button>
                <button onclick="showSettlementTab('settings')" id="s-tab-settings" class="px-4 py-3 font-bold text-sm text-gray-500">⚙️ 설정</button>
            </div>
        </div>

        <!-- 컨텐츠 영역 -->
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-6">
            <!-- 통합현황 -->
            <div id="s-content-overview" class="s-tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-lime-400/50" onclick="showSettlementTab('contracts')">
                        <div class="text-3xl mb-2">📋</div>
                        <div class="text-gray-400 text-xs mb-1">총 계약</div>
                        <div class="text-2xl font-black text-lime-400" id="s-total">12건</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-emerald-400/50" onclick="openMonthlyReceiptModal()">
                        <div class="text-3xl mb-2">💰</div>
                        <div class="text-gray-400 text-xs mb-1">이번달 수납</div>
                        <div class="text-2xl font-black text-emerald-400" id="s-revenue">₩6,500,000</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-orange-400/50" onclick="openArrearsModal()">
                        <div class="text-3xl mb-2">⚠️</div>
                        <div class="text-gray-400 text-xs mb-1">미납 총액</div>
                        <div class="text-2xl font-black text-orange-400" id="s-arrears">₩850,000</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-blue-400/50" onclick="showSettlementTab('ledger')">
                        <div class="text-3xl mb-2">📅</div>
                        <div class="text-gray-400 text-xs mb-1">오늘 발생</div>
                        <div class="text-2xl font-black text-blue-400" id="s-today">₩217,000</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="font-bold text-orange-400 mb-4">🚨 연체 계약</h3>
                        <div class="space-y-2" id="s-delinquent-list"></div>
                    </div>
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="font-bold text-emerald-400 mb-4">💳 최근 결제</h3>
                        <div class="space-y-2" id="s-recent-payments"></div>
                    </div>
                </div>
            </div>

            <!-- 계약관리 -->
            <div id="s-content-contracts" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterContracts('')"><div class="text-2xl mb-1">📋</div><div class="text-gray-400 text-xs">전체 계약</div><div class="text-xl font-black text-lime-400" id="contract-total">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterContracts('active')"><div class="text-2xl mb-1">✅</div><div class="text-gray-400 text-xs">진행중</div><div class="text-xl font-black text-blue-400" id="contract-active">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterContracts('delinquent')"><div class="text-2xl mb-1">⚠️</div><div class="text-gray-400 text-xs">연체</div><div class="text-xl font-black text-orange-400" id="contract-delinquent">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-emerald-400/50" onclick="openMonthlyRevenueModal()"><div class="text-2xl mb-1">💰</div><div class="text-gray-400 text-xs">월 정산금액</div><div class="text-xl font-black text-emerald-400" id="contract-revenue">-</div><div class="text-xs text-gray-500 mt-1" id="contract-revenue-count">- 건</div></div>
                </div>
                <!-- 렌트/리스 탭 -->
                <div class="flex gap-2 mb-4">
                    <button onclick="switchContractType('rent')" id="contract-tab-rent" class="px-6 py-2 rounded-lg font-bold text-sm bg-purple-500/20 text-purple-400 border border-purple-500/30">🏍️ 렌트</button>
                    <button onclick="switchContractType('lease')" id="contract-tab-lease" class="px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10">📄 리스</button>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="contract-search" class="input-field" style="width:180px" placeholder="고객명, 번호판 검색...">
                        <select id="contract-status" class="input-field" style="width:100px">
                            <option value="">전체</option>
                            <option value="active">진행중</option>
                            <option value="delinquent">연체</option>
                        </select>
                        <button onclick="loadContracts()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('contracts')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openModal('contractModal')" class="btn-primary btn-sm">+ 계약 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>번호</th><th>고객</th><th>연락처</th><th>차량</th><th>번호판</th><th>연료</th><th>계약기간</th><th>월납입</th><th>미납</th><th>상태</th><th>서류</th></tr></thead>
                        <tbody id="contract-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 차량관리 -->
            <div id="s-content-vehicles" class="s-tab-content hidden">
                <div class="grid grid-cols-5 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterVehicles('입고')"><div class="text-2xl mb-1">📥</div><div class="text-gray-400 text-xs">입고(대기)</div><div class="text-xl font-black text-lime-400" id="v-stock">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterVehicles('출고')"><div class="text-2xl mb-1">📤</div><div class="text-gray-400 text-xs">출고(계약중)</div><div class="text-xl font-black text-blue-400" id="v-out">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterVehicles('반납')"><div class="text-2xl mb-1">🔄</div><div class="text-gray-400 text-xs">반납(점검)</div><div class="text-xl font-black text-yellow-400" id="v-return">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterVehicles('정비')"><div class="text-2xl mb-1">🔧</div><div class="text-gray-400 text-xs">정비중</div><div class="text-xl font-black text-orange-400" id="v-repair">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-gray-400/50" onclick="filterVehicles('폐차')"><div class="text-2xl mb-1">🚫</div><div class="text-gray-400 text-xs">폐차/매각</div><div class="text-xl font-black text-gray-400" id="v-disposed">-</div></div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="vehicle-search" class="input-field" style="width:180px" placeholder="번호판, 모델 검색...">
                        <select id="vehicle-status" class="input-field" style="width:120px">
                            <option value="">전체 상태</option>
                            <option value="입고">입고(대기)</option>
                            <option value="출고">출고(계약중)</option>
                            <option value="반납">반납(점검)</option>
                            <option value="정비">정비중</option>
                            <option value="폐차">폐차/매각</option>
                        </select>
                        <button onclick="loadVehicles()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('vehicles')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openModal('vehicleModal')" class="btn-primary btn-sm">+ 차량 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>번호판</th><th>모델</th><th>연식</th><th>색상</th><th>주행거리</th><th>상태</th><th>연결계약</th></tr></thead>
                        <tbody id="vehicle-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 고객관리 -->
            <div id="s-content-customers" class="s-tab-content hidden">
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterCustomers('')"><div class="text-2xl mb-1">👥</div><div class="text-gray-400 text-xs">전체 고객</div><div class="text-xl font-black text-lime-400" id="cust-total">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterCustomers('상')"><div class="text-2xl mb-1">⭐</div><div class="text-gray-400 text-xs">등급 상</div><div class="text-xl font-black text-yellow-400" id="cust-high">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterCustomers('중')"><div class="text-2xl mb-1">✅</div><div class="text-gray-400 text-xs">등급 중</div><div class="text-xl font-black text-blue-400" id="cust-mid">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-gray-400/50" onclick="filterCustomers('하')"><div class="text-2xl mb-1">📋</div><div class="text-gray-400 text-xs">등급 하</div><div class="text-xl font-black text-gray-400" id="cust-low">-</div></div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="cust-search" class="input-field" style="width:180px" placeholder="이름, 연락처 검색...">
                        <select id="cust-grade" class="input-field" style="width:100px">
                            <option value="">전체 등급</option>
                            <option value="상">상</option>
                            <option value="중">중</option>
                            <option value="하">하</option>
                        </select>
                        <button onclick="loadCustomers()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('customers')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openCustomerModal()" class="btn-primary btn-sm">+ 고객 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>고객명</th><th>연락처</th><th>주소</th><th>거래등급</th><th>메모</th><th>등록일</th></tr></thead>
                        <tbody id="cust-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 자동결제(PG) -->
            <div id="s-content-charges" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 cursor-pointer hover:bg-lime-400/5" onclick="filterPgPayments('')">
                        <div class="text-lime-400 text-xs mb-1">💳 등록 카드</div>
                        <div class="text-2xl font-black text-lime-400" id="pg-cards">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 cursor-pointer hover:bg-blue-400/5" onclick="filterPgPayments('active')">
                        <div class="text-blue-400 text-xs mb-1">✅ 활성 카드</div>
                        <div class="text-2xl font-black text-blue-400" id="pg-active">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 cursor-pointer hover:bg-yellow-400/5" onclick="filterPgPayments('scheduled')">
                        <div class="text-yellow-400 text-xs mb-1">📅 결제 예정</div>
                        <div class="text-2xl font-black text-yellow-400" id="pg-scheduled">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 cursor-pointer hover:bg-emerald-400/5" onclick="filterPgPayments('success')">
                        <div class="text-emerald-400 text-xs mb-1">💰 결제 완료</div>
                        <div class="text-2xl font-black text-emerald-400" id="pg-completed">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="filterPgPayments('failed')">
                        <div class="text-red-400 text-xs mb-1">❌ 결제 실패</div>
                        <div class="text-2xl font-black text-red-400" id="pg-failed">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="pg-status" class="input-field" style="width:120px">
                            <option value="">전체 상태</option>
                            <option value="active">활성</option>
                            <option value="inactive">비활성</option>
                            <option value="scheduled">예정</option>
                            <option value="success">성공</option>
                            <option value="failed">실패</option>
                        </select>
                        <select id="pg-contract-filter" class="input-field" style="width:150px">
                            <option value="">전체 계약</option>
                        </select>
                        <input type="text" id="pg-search" class="input-field" style="width:150px" placeholder="고객명 검색...">
                        <button onclick="loadPgPayments()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('pg')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openPgCardModal()" class="btn-primary btn-sm">+ 카드 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>계약번호</th><th>고객명</th><th>차량</th><th>카드정보</th><th>결제금액</th><th>결제주기</th><th>최근결제</th><th>카드상태</th><th>관리</th></tr></thead>
                        <tbody id="pg-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 원장 -->
            <div id="s-content-ledger" class="s-tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 cursor-pointer hover:bg-emerald-400/5" onclick="openMonthlyReceiptModal()">
                        <div class="text-emerald-400 text-xs mb-1">✅ 이번달 수납</div>
                        <div class="text-2xl font-black text-emerald-400" id="ledger-receipt">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="ledger-receipt-count">- 건</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 cursor-pointer hover:bg-orange-400/5" onclick="filterLedgerUnpaid()">
                        <div class="text-orange-400 text-xs mb-1">⚠️ 총 미수금</div>
                        <div class="text-2xl font-black text-orange-400" id="ledger-arrears">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="ledger-arrears-count">- 건</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400 cursor-pointer hover:bg-purple-400/5" onclick="openCollectionRateModal()">
                        <div class="text-purple-400 text-xs mb-1">📊 이번달 수납률</div>
                        <div class="text-2xl font-black text-purple-400" id="ledger-rate">-</div>
                        <div class="text-xs text-gray-500 mt-1">클릭하여 상세보기</div>
                    </div>
                </div>
                
                <!-- 수납 방법별 그래프 -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lime-400">💳 이번달 수납 현황</h3>
                        <span class="text-xs text-gray-500" id="ledger-month-label">-</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 수납 방법별 막대 그래프 -->
                        <div>
                            <div class="text-xs text-gray-400 mb-3">결제 방법별</div>
                            <div class="space-y-3" id="ledger-method-bars"></div>
                        </div>
                        <!-- 수납 방법별 원형 비율 -->
                        <div>
                            <div class="text-xs text-gray-400 mb-3">비율</div>
                            <div class="flex items-center justify-center gap-6">
                                <div class="relative w-32 h-32">
                                    <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                        <circle id="ledger-pie-card" cx="18" cy="18" r="16" fill="none" stroke="#3B82F6" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                        <circle id="ledger-pie-cash" cx="18" cy="18" r="16" fill="none" stroke="#10B981" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                        <circle id="ledger-pie-transfer" cx="18" cy="18" r="16" fill="none" stroke="#F59E0B" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="text-xs text-gray-400">총액</div>
                                            <div class="text-sm font-bold text-emerald-400" id="ledger-pie-total">₩0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2" id="ledger-method-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="ledger-type" class="input-field" style="width:100px">
                            <option value="">전체</option>
                            <option value="accrual">발생</option>
                            <option value="receipt">수납</option>
                            <option value="adjust">조정</option>
                        </select>
                        <select id="ledger-contract" class="input-field" style="width:150px">
                            <option value="">전체 계약</option>
                        </select>
                        <input type="date" id="ledger-start" class="input-field" style="width:140px">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="ledger-end" class="input-field" style="width:140px">
                        <button onclick="loadLedger()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('ledger')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openLedgerModal()" class="btn-primary btn-sm">+ 내역 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>일자</th><th>고객명</th><th>구분</th><th>내용</th><th>발생</th><th>수납</th><th>잔액</th></tr></thead>
                        <tbody id="ledger-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 연체 -->
            <div id="s-content-delinquent" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="filterDelinquent('')">
                        <div class="text-red-400 text-xs mb-1">🚨 연체 계약</div>
                        <div class="text-2xl font-black text-red-400" id="del-count">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 cursor-pointer hover:bg-orange-400/5" onclick="filterDelinquent('')">
                        <div class="text-orange-400 text-xs mb-1">💸 연체 총액</div>
                        <div class="text-2xl font-black text-orange-400" id="del-total">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 cursor-pointer hover:bg-yellow-400/5" onclick="filterDelinquent('30')">
                        <div class="text-yellow-400 text-xs mb-1">⏰ 30일 미만</div>
                        <div class="text-2xl font-black text-yellow-400" id="del-30">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-600 cursor-pointer hover:bg-red-600/5" onclick="filterDelinquent('90')">
                        <div class="text-red-600 text-xs mb-1">🔥 60일 이상</div>
                        <div class="text-2xl font-black text-red-600" id="del-60">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="del-period" class="input-field" style="width:120px">
                            <option value="">전체 기간</option>
                            <option value="30">30일 미만</option>
                            <option value="60">30~60일</option>
                            <option value="90">60일 이상</option>
                        </select>
                        <select id="del-sort" class="input-field" style="width:100px">
                            <option value="amount">금액순</option>
                            <option value="days">기간순</option>
                            <option value="name">이름순</option>
                        </select>
                        <input type="text" id="del-search" class="input-field" style="width:150px" placeholder="고객명, 차량 검색...">
                        <button onclick="loadDelinquent()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <button onclick="downloadExcel('delinquent')" class="btn-secondary btn-sm">📥 엑셀</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>고객명</th><th>연락처</th><th>차량</th><th>연체금액</th><th>연체일수</th><th>최근연락</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="del-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 설정 -->
            <div id="s-content-settings" class="s-tab-content hidden">
                <div class="flex border-b border-white/10 mb-6">
                    <div class="setting-tab active" onclick="showSettingTab('staff', this)">👥 직원 관리</div>
                    <div class="setting-tab" onclick="showSettingTab('pg', this)">💳 PG 설정</div>
                    <div class="setting-tab" onclick="showSettingTab('system', this)">🔧 시스템 설정</div>
                </div>
                
                <!-- 직원 관리 -->
                <div id="setting-staff" class="setting-content">
                    <div class="glass-card rounded-xl p-4 mb-4 flex justify-between items-center">
                        <div><h3 class="font-bold text-lime-400 text-lg">직원 관리</h3><p class="text-gray-400 text-sm mt-1">통합 ERP 시스템 직원을 관리합니다. (정산관리 + 브로모터스)</p></div>
                        <button onclick="openStaffModal()" class="btn-primary">+ 직원 등록</button>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>이름</th><th>아이디</th><th>연락처</th><th>부서</th><th>권한등급</th><th>상태</th><th>등록일</th><th>관리</th></tr></thead>
                            <tbody id="staff-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PG 설정 -->
                <div id="setting-pg" class="setting-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- PG 가맹점 설정 -->
                        <div class="glass-card rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="font-bold text-lime-400 text-lg">💳 PG 가맹점 설정</h3>
                                    <p class="text-gray-400 text-xs mt-1">결제 대행사 연동 설정</p>
                                </div>
                                <span class="badge badge-active" id="pg-status-badge">연동중</span>
                            </div>
                            
                            <form id="pgSettingsForm" class="space-y-4">
                                <div>
                                    <label class="block text-xs text-lime-400 mb-1">PG사 선택*</label>
                                    <select id="pg-provider" class="input-field" onchange="onPgProviderChange(this.value)">
                                        <option value="nicepay">나이스페이 (NicePay)</option>
                                        <option value="inicis">KG이니시스</option>
                                        <option value="toss">토스페이먼츠</option>
                                        <option value="kakao">카카오페이</option>
                                        <option value="danal">다날</option>
                                        <option value="settle">세틀뱅크</option>
                                        <option value="kcp">NHN KCP</option>
                                    </select>
                                </div>
                                
                                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                    <div class="text-xs text-blue-400 mb-3">🔑 API 인증 정보</div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">가맹점 ID (MID)*</label>
                                            <input type="text" id="pg-mid" class="input-field font-mono" placeholder="예: nicepay00m">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">상점 키 (Merchant Key)*</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="pg-merchant-key" class="input-field font-mono flex-1" placeholder="••••••••••••••••">
                                                <button type="button" onclick="toggleKeyVisibility('pg-merchant-key')" class="btn-secondary btn-sm">👁️</button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">시크릿 키 (Secret Key)</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="pg-secret-key" class="input-field font-mono flex-1" placeholder="••••••••••••••••">
                                                <button type="button" onclick="toggleKeyVisibility('pg-secret-key')" class="btn-secondary btn-sm">👁️</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                    <div class="text-xs text-emerald-400 mb-3">🌐 API 엔드포인트</div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">결제 요청 URL</label>
                                            <input type="text" id="pg-api-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/payments">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">결제 취소 URL</label>
                                            <input type="text" id="pg-cancel-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/payments/cancel">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">빌링키 발급 URL</label>
                                            <input type="text" id="pg-billing-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/subscribe/regist">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">운영 모드</label>
                                        <select id="pg-mode" class="input-field">
                                            <option value="test">테스트 모드</option>
                                            <option value="production">운영 모드</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">타임아웃 (초)</label>
                                        <input type="number" id="pg-timeout" class="input-field" value="30" min="10" max="120">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-2">
                                    <button type="button" onclick="testPgConnection()" class="btn-secondary flex-1">🔍 연결 테스트</button>
                                    <button type="button" onclick="savePgSettings()" class="btn-primary flex-1">💾 저장</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- API 문서 및 결제 설정 -->
                        <div class="space-y-6">
                            <!-- 빌링 설정 -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-blue-400 text-lg mb-4">🔄 정기결제 (빌링) 설정</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">자동 빌링 활성화</div>
                                            <div class="text-xs text-gray-400">등록된 카드로 자동 결제</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-billing-enabled" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">기본 결제일</label>
                                            <select id="pg-default-pay-day" class="input-field">
                                                <option value="1">매월 1일</option>
                                                <option value="5">매월 5일</option>
                                                <option value="10" selected>매월 10일</option>
                                                <option value="15">매월 15일</option>
                                                <option value="20">매월 20일</option>
                                                <option value="25">매월 25일</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">결제 시간</label>
                                            <select id="pg-pay-time" class="input-field">
                                                <option value="09">오전 9시</option>
                                                <option value="10">오전 10시</option>
                                                <option value="14">오후 2시</option>
                                                <option value="18">오후 6시</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">실패 시 재시도</label>
                                            <select id="pg-retry-count" class="input-field">
                                                <option value="0">재시도 안함</option>
                                                <option value="1">1회</option>
                                                <option value="2">2회</option>
                                                <option value="3" selected>3회</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">재시도 간격</label>
                                            <select id="pg-retry-interval" class="input-field">
                                                <option value="1">1일</option>
                                                <option value="2" selected>2일</option>
                                                <option value="3">3일</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- API 문서 참조 -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-purple-400 text-lg mb-4">📚 API 문서</h3>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('nicepay')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">나이스페이 API 문서</div>
                                                <div class="text-xs text-gray-400">developers.nicepay.co.kr</div>
                                            </div>
                                            <span class="text-purple-400">→</span>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('inicis')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">KG이니시스 API 문서</div>
                                                <div class="text-xs text-gray-400">manual.inicis.com</div>
                                            </div>
                                            <span class="text-purple-400">→</span>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('toss')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">토스페이먼츠 API 문서</div>
                                                <div class="text-xs text-gray-400">docs.tosspayments.com</div>
                                            </div>
                                            <span class="text-purple-400">→</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Webhook 설정 -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-orange-400 text-lg mb-4">🔔 Webhook 설정</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Webhook URL</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="pg-webhook-url" class="input-field font-mono text-xs flex-1" placeholder="https://yourdomain.com/api/webhook/pg">
                                            <button type="button" onclick="copyWebhookUrl()" class="btn-secondary btn-sm">📋</button>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">결제 완료 알림</div>
                                            <div class="text-xs text-gray-400">결제 성공 시 Webhook 발송</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-webhook-success" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">결제 실패 알림</div>
                                            <div class="text-xs text-gray-400">결제 실패 시 Webhook 발송</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-webhook-fail" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 시스템 설정 -->
                <div id="setting-system" class="setting-content hidden">
                    <div class="glass-card rounded-xl p-6">
                        <div class="text-lime-400 font-bold mb-4">🔧 시스템 설정</div>
                        <div class="text-gray-500">시스템 설정 (준비중)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= 브로모터스 시스템 ======================= -->
    <div id="bromotorsSystem" class="hidden">
        <!-- 헤더 -->
        <div class="relative z-10 border-b border-lime-500/30" style="background: linear-gradient(180deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <div onclick="showBromotorsTab('overview')" class="cursor-pointer">
                    <h1 class="text-2xl font-black neon-text">브로모터스</h1>
                    <p class="text-lime-400/50 text-xs italic">직영수리점</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-center">
                        <div class="text-xs text-lime-400/70">오늘 날짜</div>
                        <div class="text-sm font-bold text-lime-400" id="b-today-date"></div>
                    </div>
                    <button onclick="switchSystem()" class="btn-secondary btn-sm">💰 정산관리</button>
                    <div class="px-3 py-2 rounded-lg glass-card text-right">
                        <div class="text-xs text-lime-400/70" id="b-userRole">관리자</div>
                        <div class="text-sm font-bold" id="b-userName">Admin</div>
                    </div>
                    <button onclick="handleLogout()" class="btn-danger btn-sm">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="relative z-10 border-b border-lime-500/20 bg-black/50">
            <div class="max-w-7xl mx-auto px-6 flex space-x-1 overflow-x-auto">
                <button onclick="showBromotorsTab('overview')" id="b-tab-overview" class="px-4 py-3 font-bold text-sm tab-active">📊 대시보드</button>
                <button onclick="showBromotorsTab('work')" id="b-tab-work" class="px-4 py-3 font-bold text-sm text-gray-500">📝 작업내용</button>
                <button onclick="showBromotorsTab('cashbook')" id="b-tab-cashbook" class="px-4 py-3 font-bold text-sm text-gray-500">💰 금전출납부</button>
                <button onclick="showBromotorsTab('parts')" id="b-tab-parts" class="px-4 py-3 font-bold text-sm text-gray-500">📦 부품관리</button>
                <button onclick="showBromotorsTab('customers')" id="b-tab-customers" class="px-4 py-3 font-bold text-sm text-gray-500">👥 고객</button>
                <button onclick="showBromotorsTab('settings')" id="b-tab-settings" class="px-4 py-3 font-bold text-sm text-gray-500">⚙️ 설정</button>
            </div>
        </div>

        <!-- 컨텐츠 영역 -->
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-6">
            <!-- 대시보드 -->
            <div id="b-content-overview" class="b-tab-content">
                <!-- 날짜 구간 필터 -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-lime-400 text-sm font-bold">📅 조회 기간</span>
                            <input type="date" id="b-dash-start" class="input-field" style="width:140px">
                            <span class="text-gray-500">~</span>
                            <input type="date" id="b-dash-end" class="input-field" style="width:140px">
                            <button onclick="loadBroDashboard()" class="btn-secondary btn-sm">조회</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setBroDashPeriod('today')" class="btn-secondary btn-sm">오늘</button>
                            <button onclick="setBroDashPeriod('week')" class="btn-secondary btn-sm">7일</button>
                            <button onclick="setBroDashPeriod('month')" class="btn-secondary btn-sm">이번달</button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 stat-card cursor-pointer hover:border-lime-400" onclick="filterBroCashbook('today')">
                        <div class="text-lime-400 text-xs mb-1">💵 기간 수입</div>
                        <div class="text-2xl font-black" id="b-today-income">₩0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-income-count">0건</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 stat-card cursor-pointer hover:border-red-400" onclick="filterBroCashbook('month-expense')">
                        <div class="text-red-400 text-xs mb-1">💸 기간 지출</div>
                        <div class="text-2xl font-black" id="b-month-expense">₩0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-expense-count">0건</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 stat-card cursor-pointer hover:border-blue-400" onclick="openBroTodayWorkModal()">
                        <div class="text-blue-400 text-xs mb-1">🔧 기간 작업</div>
                        <div class="text-2xl font-black" id="b-period-work">0건</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-work-amount">₩0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 stat-card cursor-pointer hover:border-emerald-400" onclick="openBroMonthSummary()">
                        <div class="text-emerald-400 text-xs mb-1">📊 기간 순이익</div>
                        <div class="text-2xl font-black" id="b-month-profit">₩0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-profit-rate">-</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lime-400">📋 오늘 작업</h3>
                            <span class="text-xs text-gray-500" id="b-today-work-count">0건</span>
                        </div>
                        <div class="space-y-2" id="b-today-work-list"></div>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-orange-400">⚠️ 재고 알림</h3>
                            <span class="text-xs text-gray-500" id="b-low-stock-count">0건</span>
                        </div>
                        <div class="space-y-2" id="b-low-stock-list"></div>
                    </div>
                </div>
            </div>

            <!-- 작업내용 -->
            <div id="b-content-work" class="b-tab-content hidden">
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="date" id="b-work-start" class="input-field" style="width:140px">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="b-work-end" class="input-field" style="width:140px">
                        <select id="b-work-status" class="input-field" style="width:100px">
                            <option value="">전체상태</option>
                            <option value="waiting">대기</option>
                            <option value="progress">진행중</option>
                            <option value="complete">완료</option>
                        </select>
                        <input type="text" id="b-work-search" class="input-field" style="width:150px" placeholder="고객명, 차량...">
                        <button onclick="loadBroWork()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBroCardPayModal()" class="btn-secondary btn-sm">💳 카드결제</button>
                        <button onclick="downloadExcel('broWork')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openModal('workModal')" class="btn-primary btn-sm">+ 작업 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>접수번호</th><th>날짜</th><th>고객</th><th>차량</th><th>작업내용</th><th>공임</th><th>부품</th><th>합계</th><th>상태</th><th>결제</th></tr></thead>
                        <tbody id="b-work-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 금전출납부 -->
            <div id="b-content-cashbook" class="b-tab-content hidden">
                <!-- 요약 카드 (클릭하면 상세 모달) -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 cursor-pointer hover:bg-lime-400/5" onclick="openCashbookDetail('income')">
                        <div class="text-lime-400 text-xs mb-1">💵 이번달 수입</div>
                        <div class="text-2xl font-black text-lime-400" id="b-cb-income">₩0</div>
                        <div class="text-xs text-gray-500 mt-1">클릭하여 상세보기</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="openCashbookDetail('expense')">
                        <div class="text-red-400 text-xs mb-1">💸 이번달 지출</div>
                        <div class="text-2xl font-black text-red-400" id="b-cb-expense">₩0</div>
                        <div class="text-xs text-gray-500 mt-1">클릭하여 상세보기</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 cursor-pointer hover:bg-blue-400/5" onclick="openCashbookDetail('profit')">
                        <div class="text-blue-400 text-xs mb-1">📊 순이익</div>
                        <div class="text-2xl font-black text-blue-400" id="b-cb-profit">₩0</div>
                        <div class="text-xs text-gray-500 mt-1">클릭하여 상세보기</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400 cursor-pointer hover:bg-purple-400/5" onclick="openCashbookDetail('balance')">
                        <div class="text-purple-400 text-xs mb-1">💰 현재 잔액</div>
                        <div class="text-2xl font-black text-purple-400" id="b-cb-balance">₩0</div>
                        <div class="text-xs text-gray-500 mt-1">클릭하여 상세보기</div>
                    </div>
                </div>
                
                <!-- 그래프 영역 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4">
                        <div class="text-sm text-lime-400 font-bold mb-3">📈 월별 수입/지출 추이</div>
                        <canvas id="cashbook-chart" height="200"></canvas>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <div class="text-sm text-orange-400 font-bold mb-3">🍩 지출 분류별 비율</div>
                        <canvas id="expense-chart" height="200"></canvas>
                    </div>
                </div>
                
                <!-- 기간 필터 버튼 -->
                <div class="flex flex-wrap gap-2 mb-4 period-btns">
                    <button onclick="filterCashbookPeriod('1w')" id="cb-filter-1w" class="px-4 py-2 rounded-lg text-sm font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30">1주일</button>
                    <button onclick="filterCashbookPeriod('1m')" id="cb-filter-1m" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10">1개월</button>
                    <button onclick="filterCashbookPeriod('3m')" id="cb-filter-3m" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10">3개월</button>
                    <button onclick="filterCashbookPeriod('all')" id="cb-filter-all" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10">전체</button>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="date" id="b-cb-start-date" class="input-field" style="width:140px" title="시작일">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="b-cb-end-date" class="input-field" style="width:140px" title="종료일">
                        <select id="b-cb-type" class="input-field" style="width:100px">
                            <option value="">전체</option>
                            <option value="income">수입</option>
                            <option value="expense">지출</option>
                        </select>
                        <select id="b-cb-category-filter" class="input-field" style="width:120px">
                            <option value="">전체 분류</option>
                            <optgroup label="수입">
                                <option value="정비수입">정비수입</option>
                                <option value="부품판매">부품판매</option>
                            </optgroup>
                            <optgroup label="운영비">
                                <option value="임대료">임대료</option>
                                <option value="전기요금">전기요금</option>
                                <option value="수도요금">수도요금</option>
                                <option value="가스요금">가스요금</option>
                                <option value="인터넷/통신">인터넷/통신</option>
                            </optgroup>
                            <optgroup label="인건비">
                                <option value="급여">급여</option>
                                <option value="4대보험">4대보험</option>
                                <option value="식대">식대</option>
                            </optgroup>
                        </select>
                        <input type="text" id="b-cb-search" class="input-field" style="width:150px" placeholder="내용 검색...">
                        <button onclick="loadBroCashbook()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('broCashbook')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openModal('cashbookModal')" class="btn-primary btn-sm">+ 내역 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>날짜</th><th>구분</th><th>분류</th><th>내용</th><th>금액</th><th>잔액</th><th>관리</th></tr></thead>
                        <tbody id="b-cb-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 부품관리 -->
            <div id="b-content-parts" class="b-tab-content hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterBroParts('')">
                        <div class="text-2xl mb-1">📦</div>
                        <div class="text-gray-400 text-xs">전체 부품</div>
                        <div class="text-xl font-black text-lime-400" id="b-parts-total">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-parts-total-qty">총 0개</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterBroParts('low')">
                        <div class="text-2xl mb-1">⚠️</div>
                        <div class="text-gray-400 text-xs">재고 부족</div>
                        <div class="text-xl font-black text-orange-400" id="b-parts-low">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-parts-low-list">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="openPartsValueModal()">
                        <div class="text-2xl mb-1">💰</div>
                        <div class="text-gray-400 text-xs">재고 금액</div>
                        <div class="text-xl font-black text-blue-400" id="b-parts-value">-</div>
                        <div class="text-xs text-gray-500 mt-1">클릭하여 상세보기</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-parts-category" class="input-field" style="width:120px">
                            <option value="">전체 분류</option>
                            <option value="오일류">오일류</option>
                            <option value="타이어">타이어</option>
                            <option value="브레이크">브레이크</option>
                            <option value="필터">필터</option>
                            <option value="배터리">배터리</option>
                            <option value="전장">전장</option>
                            <option value="기타">기타</option>
                        </select>
                        <select id="b-parts-stock-filter" class="input-field" style="width:100px">
                            <option value="">전체상태</option>
                            <option value="low">부족</option>
                            <option value="normal">정상</option>
                            <option value="zero">품절</option>
                        </select>
                        <input type="text" id="b-parts-search" class="input-field" style="width:150px" placeholder="부품명 검색...">
                        <button onclick="loadBroParts()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('broParts')" class="btn-secondary btn-sm">📥 엑셀</button>
                        <button onclick="openPartsModal()" class="btn-primary btn-sm">+ 부품 등록</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>부품명</th><th>분류</th><th>재고</th><th>최소재고</th><th>단가</th><th>재고금액</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="b-parts-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 고객 -->
            <div id="b-content-customers" class="b-tab-content hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterBroCustomers('')">
                        <div class="text-2xl mb-1">👥</div>
                        <div class="text-gray-400 text-xs">전체 고객</div>
                        <div class="text-xl font-black text-lime-400" id="b-cust-total">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterBroCustomers('month')">
                        <div class="text-2xl mb-1">🔧</div>
                        <div class="text-gray-400 text-xs">이번달 방문</div>
                        <div class="text-xl font-black text-blue-400" id="b-cust-month">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterBroCustomers('vip')">
                        <div class="text-2xl mb-1">⭐</div>
                        <div class="text-gray-400 text-xs">단골 고객</div>
                        <div class="text-xl font-black text-yellow-400" id="b-cust-vip">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-cust-filter" class="input-field" style="width:100px">
                            <option value="">전체</option>
                            <option value="month">이번달 방문</option>
                            <option value="vip">단골 (3회+)</option>
                        </select>
                        <input type="text" id="b-cust-search" class="input-field" style="width:180px" placeholder="고객명, 연락처, 차량 검색...">
                        <button onclick="loadBroCustomers()" class="btn-secondary btn-sm">검색</button>
                    </div>
                    <button onclick="openModal('broCustModal')" class="btn-primary btn-sm">+ 고객 등록</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>고객명</th><th>연락처</th><th>차량</th><th>번호판</th><th>방문횟수</th><th>최근방문</th><th>관리</th></tr></thead>
                        <tbody id="b-cust-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 설정 -->
            <div id="b-content-settings" class="b-tab-content hidden">
                <div class="glass-card rounded-xl p-6">
                    <div class="text-lime-400 font-bold mb-4">⚙️ 설정</div>
                    <div class="text-gray-400 text-sm">직원 관리는 <span class="text-lime-400 cursor-pointer" onclick="goToSettlementSettings()">정산관리 → 설정</span>에서 통합 관리합니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= 모달: 직원 등록 ======================= -->
    <div id="staffModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="staffModalTitle" class="text-xl font-bold text-lime-400">👤 직원 등록</h2><button onclick="closeModal('staffModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitStaff(event)" id="staffForm" class="space-y-4">
                <input type="hidden" id="staff-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">이름*</label><input name="name" id="staff-name" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">아이디*</label><input name="username" id="staff-username" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">비밀번호*</label><input type="password" name="password" id="staff-password" class="input-field"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">비밀번호 확인*</label><input type="password" name="password_confirm" id="staff-password-confirm" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">연락처*</label><input name="phone" id="staff-phone" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">이메일</label><input type="email" name="email" id="staff-email" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">부서*</label>
                        <select name="department" id="staff-department" class="input-field" required>
                            <option value="">선택</option>
                            <option value="정산팀">정산팀</option>
                            <option value="정비팀">정비팀</option>
                            <option value="영업팀">영업팀</option>
                            <option value="고객지원팀">고객지원팀</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-400 mb-1">상태*</label>
                        <select name="status" id="staff-status" class="input-field" required>
                            <option value="active">재직</option>
                            <option value="inactive">퇴사</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">권한 등급* (1~4단계)</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-gray-400/50 has-[:checked]:border-gray-400 has-[:checked]:bg-gray-400/10">
                            <input type="radio" name="level" value="1" class="hidden" checked>
                            <span class="text-lg mb-1">👤</span>
                            <span class="text-xs font-bold text-gray-400">Lv.1</span>
                            <span class="text-[10px] text-gray-500">사원</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-blue-400/50 has-[:checked]:border-blue-400 has-[:checked]:bg-blue-400/10">
                            <input type="radio" name="level" value="2" class="hidden">
                            <span class="text-lg mb-1">⭐</span>
                            <span class="text-xs font-bold text-blue-400">Lv.2</span>
                            <span class="text-[10px] text-gray-500">팀원</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-orange-400/50 has-[:checked]:border-orange-400 has-[:checked]:bg-orange-400/10">
                            <input type="radio" name="level" value="3" class="hidden">
                            <span class="text-lg mb-1">👑</span>
                            <span class="text-xs font-bold text-orange-400">Lv.3</span>
                            <span class="text-[10px] text-gray-500">매니저</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-red-400/50 has-[:checked]:border-red-400 has-[:checked]:bg-red-400/10">
                            <input type="radio" name="level" value="4" class="hidden">
                            <span class="text-lg mb-1">🔥</span>
                            <span class="text-xs font-bold text-red-400">Lv.4</span>
                            <span class="text-[10px] text-gray-500">최고관리자</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('staffModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1" id="staffSubmitBtn">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 모달: 고객 등록/수정 ======================= -->
    <div id="customerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="customerModalTitle" class="text-xl font-bold text-lime-400">👤 고객 등록</h2><button onclick="closeModal('customerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitCustomer(event)" id="customerForm" class="space-y-4">
                <input type="hidden" id="cust-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">고객명*</label><input name="name" id="cust-name" class="input-field" placeholder="홍길동" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">주민번호</label><input name="ssn" id="cust-ssn" class="input-field" placeholder="000000-0000000"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">연락처*</label><input name="phone" id="cust-phone" class="input-field" placeholder="010-0000-0000" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">이메일</label><input type="email" name="email" id="cust-email" class="input-field" placeholder="example@email.com"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">주소</label><input name="address" id="cust-address" class="input-field" placeholder="주소"></div>
                <div><label class="block text-xs text-lime-400 mb-1">거래등급*</label>
                    <select name="grade" id="cust-grade-select" class="input-field" required>
                        <option value="">선택</option>
                        <option value="상">상</option>
                        <option value="중">중</option>
                        <option value="하">하</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">메모</label><textarea name="memo" id="cust-memo" class="input-field" rows="2" placeholder="고객 메모"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('customerModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1" id="customerSubmitBtn">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 모달: 고객 상세 ======================= -->
    <div id="customerDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">👤 고객 상세</h2><button onclick="closeModal('customerDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="customer-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 작업 등록 ======================= -->
    <div id="workModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">🔧 작업 등록</h2><button onclick="closeModal('workModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroWork(event)" class="space-y-4">
                <!-- 고객 검색 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">👤 고객 정보</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="block text-xs text-gray-400 mb-1">고객명* (검색)</label>
                            <input name="customer" id="work-customer" class="input-field" placeholder="이름 입력 후 검색" required oninput="searchBroCustomer()">
                            <div id="customer-search-results" class="absolute z-50 w-full bg-black border border-lime-400/30 rounded-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">연락처*</label>
                            <input name="phone" id="work-phone" class="input-field" required onblur="checkPhoneDuplicate()">
                            <div id="phone-check-result" class="text-xs mt-1"></div>
                        </div>
                    </div>
                    <div id="customer-info-box" class="mt-3 p-2 rounded bg-lime-400/10 border border-lime-400/30 hidden">
                        <div class="text-xs text-lime-400">✅ 기존 고객</div>
                        <div id="customer-info-detail" class="text-sm text-gray-300 mt-1"></div>
                    </div>
                    <div id="new-customer-box" class="mt-3 p-2 rounded bg-blue-400/10 border border-blue-400/30 hidden">
                        <div class="text-xs text-blue-400">🆕 신규 고객으로 등록됩니다</div>
                    </div>
                </div>
                
                <!-- 차량 정보 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-purple-400 mb-3">🏍️ 차량 정보</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">차량*</label><input name="vehicle" id="work-vehicle" class="input-field" placeholder="PCX 125" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">번호판</label><input name="plate" id="work-plate" class="input-field" placeholder="12가3456"></div>
                    </div>
                </div>
                
                <!-- 작업 내용 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">🔧 작업 내용</div>
                    <div><label class="block text-xs text-gray-400 mb-1">작업내용*</label><input name="content" id="work-content" class="input-field" placeholder="엔진오일 교환" required></div>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">공임</label><input type="number" name="labor" id="work-labor" class="input-field" value="0" oninput="calcWorkTotal()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">부품비</label><input type="number" name="parts_cost" id="work-parts" class="input-field" value="0" oninput="calcWorkTotal()"></div>
                        <div><label class="block text-xs text-emerald-400 mb-1">합계금액</label><input type="text" id="work-total" class="input-field bg-emerald-400/10 text-emerald-400 font-bold" value="₩0" readonly></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">메모</label><textarea name="memo" id="work-memo" class="input-field" rows="2"></textarea></div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('workModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 금전출납 등록 ======================= -->
    <div id="cashbookModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="cashbookModalTitle" class="text-xl font-bold text-lime-400">💰 내역 등록</h2><button onclick="closeModal('cashbookModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroCashbook(event)" class="space-y-4">
                <input type="hidden" id="cashbook-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">날짜*</label><input type="date" name="date" id="cb-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">구분*</label>
                        <select name="type" id="cb-type" class="input-field" required onchange="updateCategoryOptions()">
                            <option value="income">수입</option>
                            <option value="expense">지출</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">분류*</label>
                    <select name="category" id="cb-category" class="input-field" required>
                        <optgroup label="📈 수입">
                            <option value="정비수입">정비수입</option>
                            <option value="부품판매">부품판매</option>
                            <option value="기타수입">기타수입</option>
                        </optgroup>
                        <optgroup label="🏢 운영비">
                            <option value="임대료">임대료</option>
                            <option value="전기요금">전기요금</option>
                            <option value="수도요금">수도요금</option>
                            <option value="가스요금">가스요금</option>
                            <option value="인터넷/통신">인터넷/통신</option>
                            <option value="부품구매">부품구매</option>
                            <option value="소모품">소모품</option>
                        </optgroup>
                        <optgroup label="👷 인건비">
                            <option value="급여">급여</option>
                            <option value="4대보험">4대보험</option>
                            <option value="식대">식대</option>
                            <option value="복리후생">복리후생</option>
                        </optgroup>
                        <optgroup label="🚗 차량/장비">
                            <option value="장비구매">장비구매</option>
                            <option value="장비수리">장비수리</option>
                            <option value="차량유지비">차량유지비</option>
                            <option value="주유비">주유비</option>
                        </optgroup>
                        <optgroup label="📋 세금/보험">
                            <option value="세금">세금</option>
                            <option value="보험료">보험료</option>
                        </optgroup>
                        <optgroup label="기타">
                            <option value="기타지출">기타지출</option>
                        </optgroup>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">내용*</label><input name="description" id="cb-description" class="input-field" required placeholder="상세 내용 입력..."></div>
                <div><label class="block text-xs text-lime-400 mb-1">금액*</label><input type="number" name="amount" id="cb-amount" class="input-field" required></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('cashbookModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" id="cashbookSubmitBtn" class="btn-primary flex-1">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 금전출납부 상세 ======================= -->
    <div id="cashbookDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px; max-height:85vh; overflow-y:auto;">
            <div class="flex justify-between mb-4">
                <h2 id="cashbookDetailTitle" class="text-xl font-bold text-lime-400">💰 상세 내역</h2>
                <button onclick="closeModal('cashbookDetailModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="cashbook-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 부품 등록/수정 ======================= -->
    <div id="partsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="partsModalTitle" class="text-xl font-bold text-lime-400">📦 부품 등록</h2><button onclick="closeModal('partsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroParts(event)" id="partsForm" class="space-y-4">
                <input type="hidden" id="parts-edit-id">
                <div><label class="block text-xs text-lime-400 mb-1">부품명*</label><input name="name" id="parts-name" class="input-field" required></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">분류*</label>
                        <select name="category" id="parts-category" class="input-field" required>
                            <option value="오일류">오일류</option>
                            <option value="타이어">타이어</option>
                            <option value="브레이크">브레이크</option>
                            <option value="필터">필터</option>
                            <option value="배터리">배터리</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-400 mb-1">재고수량*</label><input type="number" name="stock" id="parts-stock" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">단가*</label><input type="number" name="price" id="parts-price" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">최소재고</label><input type="number" name="min_stock" id="parts-min" class="input-field" value="5"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('partsModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" id="partsSubmitBtn" class="btn-primary flex-1">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 고객 등록 ======================= -->
    <div id="broCustModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">👤 고객 등록</h2><button onclick="closeModal('broCustModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroCustomer(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">고객명*</label><input name="name" id="bro-cust-name" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">연락처*</label><input name="phone" id="bro-cust-phone" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">차량</label><input name="vehicle" id="bro-cust-vehicle" class="input-field" placeholder="PCX 125"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">번호판</label><input name="plate" id="bro-cust-plate" class="input-field" placeholder="12가3456"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">메모</label><textarea name="memo" id="bro-cust-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('broCustModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 작업 상세 ======================= -->
    <div id="workDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">🔧 작업 상세</h2><button onclick="closeModal('workDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="work-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 고객 상세 ======================= -->
    <div id="broCustDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">👤 고객 상세 정보</h2><button onclick="closeModal('broCustDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-cust-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 월간 요약 ======================= -->
    <div id="broMonthSummaryModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">📊 이번달 수익 현황</h2><button onclick="closeModal('broMonthSummaryModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-month-summary-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 오늘 작업 상세 ======================= -->
    <div id="broTodayWorkModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">📋 오늘 작업 현황</h2><button onclick="closeModal('broTodayWorkModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-today-work-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 재고 알림 상세 ======================= -->
    <div id="broLowStockModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">⚠️ 재고 부족 현황</h2><button onclick="closeModal('broLowStockModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-low-stock-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 재고 금액 상세 ======================= -->
    <div id="broPartsValueModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-blue-400">💰 재고 금액 현황</h2><button onclick="closeModal('broPartsValueModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-parts-value-content"></div>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 카드결제 ======================= -->
    <div id="broCardPayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-blue-400">💳 카드 수동결제</h2><button onclick="closeModal('broCardPayModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="processBroCardPayment(event)" class="space-y-4">
                <!-- 결제자 유형 -->
                <div>
                    <label class="block text-xs text-lime-400 mb-2">결제자 유형*</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50 has-[:checked]:border-lime-400 has-[:checked]:bg-lime-400/10">
                            <input type="radio" name="payer_type" value="personal" class="accent-lime-400" checked onchange="togglePayerType(this.value)">
                            <div><div class="font-bold">👤 개인</div><div class="text-xs text-gray-400">개인 카드 결제</div></div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-blue-400/50 has-[:checked]:border-blue-400 has-[:checked]:bg-blue-400/10">
                            <input type="radio" name="payer_type" value="business" class="accent-blue-400" onchange="togglePayerType(this.value)">
                            <div><div class="font-bold">🏢 사업자/법인</div><div class="text-xs text-gray-400">사업자/법인 카드</div></div>
                        </label>
                    </div>
                </div>
                
                <!-- 사업자 정보 (사업자 선택시만 표시) -->
                <div id="business-info" class="hidden space-y-3 p-4 rounded-lg bg-blue-400/5 border border-blue-400/20">
                    <div class="text-xs text-blue-400 font-bold mb-2">🏢 사업자 정보</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">사업자등록번호</label><input name="biz_no" class="input-field" placeholder="000-00-00000"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">상호명</label><input name="biz_name" class="input-field" placeholder="회사명"></div>
                    </div>
                    <div><label class="block text-xs text-gray-400 mb-1">대표자명</label><input name="biz_ceo" class="input-field" placeholder="대표자명"></div>
                </div>
                
                <!-- 결제 정보 -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">고객명*</label><input name="customer_name" id="bro-pay-customer" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">연락처*</label><input name="phone" id="bro-pay-phone" class="input-field" required></div>
                </div>
                
                <!-- 카드 정보 -->
                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 font-bold mb-3">💳 카드 정보</div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="block text-xs text-gray-400 mb-1">카드번호*</label><input name="card_no" id="bro-card-no" class="input-field" placeholder="0000-0000-0000-0000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">유효기간*</label><input name="card_expiry" id="bro-card-expiry" class="input-field" placeholder="MM/YY" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">CVC*</label><input name="card_cvc" type="password" maxlength="4" class="input-field" placeholder="000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">할부</label>
                            <select name="installment" class="input-field">
                                <option value="0">일시불</option>
                                <option value="2">2개월</option>
                                <option value="3">3개월</option>
                                <option value="6">6개월</option>
                                <option value="12">12개월</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">결제금액*</label><input type="number" name="amount" id="bro-pay-amount" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- 작업 선택 (선택사항) -->
                <div>
                    <label class="block text-xs text-lime-400 mb-1">연결 작업 (선택)</label>
                    <select name="work_id" id="bro-pay-work" class="input-field">
                        <option value="">작업 선택 안함</option>
                    </select>
                </div>
                
                <div><label class="block text-xs text-lime-400 mb-1">결제 메모</label><input name="memo" class="input-field" placeholder="결제 내용 메모"></div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('broCardPayModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1">💳 결제 실행</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 브로모터스 모달: 결제 완료 ======================= -->
    <div id="broPayCompleteModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:450px">
            <div class="text-center py-6">
                <div class="text-6xl mb-4">✅</div>
                <h2 class="text-2xl font-black text-emerald-400 mb-2">결제 완료</h2>
                <div id="bro-pay-complete-info" class="text-gray-400"></div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4" id="bro-pay-receipt"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('broPayCompleteModal')" class="btn-secondary flex-1">닫기</button>
                <button onclick="printBroReceipt()" class="btn-primary flex-1">🖨️ 영수증 출력</button>
            </div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 미납 고객 목록 ======================= -->
    <div id="arrearsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">⚠️ 미납 고객 목록</h2><button onclick="closeModal('arrearsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div class="mb-4 p-4 rounded-xl bg-orange-400/10 border border-orange-400/30">
                <div class="flex justify-between items-center">
                    <span class="text-orange-400 font-bold">총 미납 금액</span>
                    <span class="text-2xl font-black text-orange-400" id="arrears-total-amount">₩0</span>
                </div>
            </div>
            <div class="glass-card rounded-xl overflow-hidden">
                <table class="data-table">
                    <thead><tr><th>고객명</th><th>연락처</th><th>차량</th><th>미납금액</th><th>연체일</th><th>상세</th></tr></thead>
                    <tbody id="arrears-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 미수금 상세 ======================= -->
    <div id="arrearsDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">📋 미수금 상세</h2><button onclick="closeModal('arrearsDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="arrears-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 수납 처리 ======================= -->
    <div id="paymentProcessModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">💰 수납 처리</h2><button onclick="closeModal('paymentProcessModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="payment-info" class="mb-4"></div>
            <form onsubmit="processPayment(event)" class="space-y-4">
                <input type="hidden" id="payment-contract-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">수납일*</label><input type="date" name="pay_date" id="payment-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">수납금액*</label><input type="number" name="pay_amount" id="payment-amount" class="input-field" required></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">수납방법*</label>
                    <select name="pay_method" class="input-field" required>
                        <option value="카드">카드</option>
                        <option value="현금">현금</option>
                        <option value="계좌이체">계좌이체</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">메모</label><input type="text" name="pay_memo" class="input-field" placeholder="메모 입력..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('paymentProcessModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1">수납 처리</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 최근 결제 내역 ======================= -->
    <div id="recentPaymentsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">💳 최근 결제 내역</h2><button onclick="closeModal('recentPaymentsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="recent-payments-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 계약 등록 ======================= -->
    <div id="contractModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4"><h2 id="contractModalTitle" class="text-xl font-bold text-lime-400">📋 계약 등록</h2><button onclick="closeModal('contractModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitContract(event)" id="contractForm" class="space-y-4">
                <input type="hidden" id="contract-edit-id">
                
                <!-- 계약 유형 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <label class="block text-xs text-lime-400 mb-2">계약 유형*</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="contract_type" value="rent" checked class="accent-purple-500">
                            <span class="text-purple-400 font-bold">🏍️ 렌트</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="contract_type" value="lease" class="accent-pink-500">
                            <span class="text-pink-400 font-bold">📄 리스</span>
                        </label>
                    </div>
                </div>
                
                <!-- 기본 정보 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-blue-400 mb-3">👤 계약자 정보</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">고객명*</label><input name="customer_name" id="con-customer" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">연락처*</label><input name="phone" id="con-phone" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- 차량 정보 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-emerald-400 mb-3">🚗 차량 정보</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">차량*</label><input name="vehicle" id="con-vehicle" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">번호판*</label><input name="plate" id="con-plate" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">연료*</label>
                            <select name="fuel_type" id="con-fuel" class="input-field" required>
                                <option value="휘발유">휘발유</option>
                                <option value="경유">경유</option>
                                <option value="LPG">LPG</option>
                                <option value="전기">전기</option>
                                <option value="하이브리드">하이브리드</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 계약 조건 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">📅 계약 조건</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">월 납입금*</label><input type="number" name="monthly" id="con-monthly" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">계약 시작일*</label><input type="date" name="start_date" id="con-start" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">계약 종료일*</label><input type="date" name="end_date" id="con-end" class="input-field" required></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">메모</label><textarea name="memo" id="con-memo" class="input-field" rows="2" placeholder="계약 관련 메모..."></textarea></div>
                </div>
                
                <!-- 계약자 서류 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">📎 계약자 서류</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">신분증</label>
                            <input type="file" name="contractor_id" id="con-contractor-id" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            <div id="con-contractor-id-preview" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">기타서류</label>
                            <input type="file" name="contractor_doc" id="con-contractor-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            <div id="con-contractor-doc-preview" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 연대보증인 (선택) -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="con-has-guarantor" onchange="toggleGuarantor()" class="accent-lime-500">
                        <label class="text-xs text-yellow-400 cursor-pointer" for="con-has-guarantor">👥 연대보증인 추가</label>
                    </div>
                    <div id="guarantor-section" class="hidden space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs text-gray-400 mb-1">보증인 이름</label><input name="guarantor_name" id="con-guarantor-name" class="input-field"></div>
                            <div><label class="block text-xs text-gray-400 mb-1">보증인 연락처</label><input name="guarantor_phone" id="con-guarantor-phone" class="input-field"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">보증인 신분증</label>
                                <input type="file" name="guarantor_id" id="con-guarantor-id" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">보증인 기타서류</label>
                                <input type="file" name="guarantor_doc" id="con-guarantor-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 차량 서류 -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-purple-400 mb-3">🚗 차량 서류</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">차량등록증</label>
                            <input type="file" name="vehicle_reg" id="con-vehicle-reg" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">폐지서류</label>
                            <input type="file" name="vehicle_disposal" id="con-vehicle-disposal" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">기타서류</label>
                            <input type="file" name="vehicle_doc" id="con-vehicle-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('contractModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1" id="contractSubmitBtn">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 계약 상세 ======================= -->
    <div id="contractDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">📋 계약 상세</h2><button onclick="closeModal('contractDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="contract-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 차량 등록 ======================= -->
    <div id="vehicleModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="vehicleModalTitle" class="text-xl font-bold text-lime-400">🚗 차량 등록</h2><button onclick="closeModal('vehicleModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitVehicle(event)" id="vehicleForm" class="space-y-4">
                <input type="hidden" id="vehicle-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">번호판*</label><input name="plate" id="veh-plate" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">모델*</label><input name="model" id="veh-model" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">연식</label><input type="number" name="year" id="veh-year" class="input-field" value="2024"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">색상</label><input name="color" id="veh-color" class="input-field"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">주행거리</label><input type="number" name="mileage" id="veh-mileage" class="input-field" value="0"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">메모</label><input name="memo" id="veh-memo" class="input-field"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('vehicleModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1" id="vehicleSubmitBtn">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 차량 상세 ======================= -->
    <div id="vehicleDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">🚗 차량 상세</h2><button onclick="closeModal('vehicleDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="vehicle-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: PG 카드 등록 ======================= -->
    <div id="pgModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 id="pgModalTitle" class="text-xl font-bold text-lime-400">💳 자동결제 카드 등록</h2><button onclick="closeModal('pgModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitPgCard(event)" id="pgForm" class="space-y-4">
                <input type="hidden" id="pg-edit-id">
                <div><label class="block text-xs text-lime-400 mb-1">계약 선택*</label>
                    <select name="contract_id" id="pg-contract" class="input-field" required onchange="onPgContractChange(this)">
                        <option value="">계약 선택</option>
                    </select>
                </div>
                
                <!-- 카드 소유자 정보 -->
                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 font-bold mb-3">👤 카드 소유자 정보</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">카드 소유자명*</label><input name="card_holder" id="pg-card-holder" class="input-field" placeholder="홍길동" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">생년월일 (6자리)*</label><input name="birth_date" id="pg-birth-date" class="input-field" placeholder="990101" maxlength="6" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">연락처*</label><input name="card_phone" id="pg-card-phone" class="input-field" placeholder="010-1234-5678" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">이메일</label><input type="email" name="card_email" id="pg-card-email" class="input-field" placeholder="email@example.com"></div>
                    </div>
                </div>
                
                <!-- 카드 정보 -->
                <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20">
                    <div class="text-xs text-blue-400 font-bold mb-3">💳 카드 정보</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">카드번호*</label><input name="card_no" id="pg-card-no" class="input-field" placeholder="0000-0000-0000-0000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">유효기간*</label><input name="expiry" id="pg-expiry" class="input-field" placeholder="MM/YY" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">CVC*</label><input name="cvc" id="pg-cvc" type="password" class="input-field" placeholder="000" maxlength="4" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">카드 비밀번호 앞2자리*</label><input name="card_pw" id="pg-card-pw" type="password" class="input-field" placeholder="**" maxlength="2" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">카드사</label>
                            <select name="card_company" id="pg-card-company" class="input-field">
                                <option value="">선택</option>
                                <option value="삼성">삼성카드</option>
                                <option value="현대">현대카드</option>
                                <option value="KB">KB국민카드</option>
                                <option value="신한">신한카드</option>
                                <option value="롯데">롯데카드</option>
                                <option value="하나">하나카드</option>
                                <option value="우리">우리카드</option>
                                <option value="NH">NH농협카드</option>
                                <option value="BC">BC카드</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 결제 설정 -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">결제금액*</label><input type="number" name="amount" id="pg-amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">카드상태</label>
                        <select name="card_status" id="pg-card-status" class="input-field">
                            <option value="active">활성</option>
                            <option value="inactive">비활성</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">결제 타입*</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="daily" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">일일결제</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="weekly" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">주일결제</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="monthly" onchange="togglePayOption(this.value)" class="accent-lime-400" checked>
                            <span class="text-sm">월결제</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="custom" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">날짜지정</span>
                        </label>
                    </div>
                </div>
                <div id="pg-option-daily" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">매일 결제 시간</label>
                    <select name="pay_hour" id="pg-pay-hour" class="input-field">
                        <option value="9">오전 9시</option>
                        <option value="12">오후 12시</option>
                        <option value="18">오후 6시</option>
                    </select>
                </div>
                <div id="pg-option-weekly" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">매주 결제 요일</label>
                    <select name="pay_weekday" id="pg-pay-weekday" class="input-field">
                        <option value="1">월요일</option>
                        <option value="2">화요일</option>
                        <option value="3">수요일</option>
                        <option value="4">목요일</option>
                        <option value="5">금요일</option>
                    </select>
                </div>
                <div id="pg-option-monthly">
                    <label class="block text-xs text-lime-400 mb-1">매월 결제일</label>
                    <select name="pay_day" id="pg-pay-day" class="input-field">
                        <option value="1">매월 1일</option>
                        <option value="5">매월 5일</option>
                        <option value="10">매월 10일</option>
                        <option value="15">매월 15일</option>
                        <option value="20">매월 20일</option>
                        <option value="25">매월 25일</option>
                    </select>
                </div>
                <div id="pg-option-custom" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">결제 시작일</label>
                    <input type="date" name="pay_date" id="pg-pay-date" class="input-field">
                </div>
                
                <div class="p-3 rounded-lg bg-yellow-400/10 border border-yellow-400/30 text-xs text-yellow-400">
                    ⚠️ 카드 정보는 암호화되어 안전하게 저장됩니다. 등록 후 자동결제가 진행됩니다.
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('pgModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1" id="pgSubmitBtn">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: PG 카드 상세 ======================= -->
    <div id="pgDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">💳 카드 상세 정보</h2><button onclick="closeModal('pgDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="pg-detail-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 수동 결제 ======================= -->
    <div id="manualPayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">💰 수동 결제 실행</h2><button onclick="closeModal('manualPayModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="manual-pay-info" class="mb-4"></div>
            <form onsubmit="executeManualPayment(event)" class="space-y-4">
                <input type="hidden" id="manual-pay-pg-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">결제금액*</label><input type="number" name="amount" id="manual-pay-amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">결제일*</label><input type="date" name="pay_date" id="manual-pay-date" class="input-field" required></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">메모</label><input type="text" name="memo" class="input-field" placeholder="결제 메모..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('manualPayModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1">💳 결제 실행</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 원장 내역 등록 ======================= -->
    <div id="ledgerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">📝 원장 내역 등록</h2><button onclick="closeModal('ledgerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitLedgerEntry(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">일자*</label><input type="date" name="date" id="ledger-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">계약 선택*</label>
                        <select name="contract_id" id="ledger-contract-select" class="input-field" required>
                            <option value="">계약 선택</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">구분*</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="accrual" class="accent-lime-400" checked>
                            <span class="text-sm">발생(청구)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="receipt" class="accent-lime-400">
                            <span class="text-sm">수납(입금)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="adjust" class="accent-lime-400">
                            <span class="text-sm">조정</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">금액*</label><input type="number" name="amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">결제방법</label>
                        <select name="method" class="input-field">
                            <option value="카드">카드</option>
                            <option value="현금">현금</option>
                            <option value="이체">계좌이체</option>
                            <option value="PG">PG(자동결제)</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">내용</label><input type="text" name="desc" class="input-field" placeholder="내용 입력..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('ledgerModal')" class="btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn-primary flex-1">등록</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 이번달 수납 상세 ======================= -->
    <div id="monthlyReceiptModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">✅ 이번달 수납 현황</h2><button onclick="closeModal('monthlyReceiptModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="monthly-receipt-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 월 정산금액 상세 ======================= -->
    <div id="monthlyRevenueModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">💰 월 정산금액 현황</h2><button onclick="closeModal('monthlyRevenueModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="monthly-revenue-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 미수금 목록 ======================= -->
    <div id="unpaidListModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">⚠️ 미수금 현황</h2><button onclick="closeModal('unpaidListModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="unpaid-list-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 수납률 상세 ======================= -->
    <div id="collectionRateModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-purple-400">📊 수납률 상세 분석</h2><button onclick="closeModal('collectionRateModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="collection-rate-content"></div>
        </div>
    </div>

    <!-- ======================= 정산관리 모달: 연체 관리 ======================= -->
    <div id="delActionModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">📞 연체 관리</h2><button onclick="closeModal('delActionModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="del-action-content"></div>
        </div>
    </div>

<script>
// ======================= Supabase 설정 =======================
const SUPABASE_URL = 'https://jizaefuhiikpkcxolibc.supabase.co';
const SUPABASE_KEY = 'sb_publishable_GmXxpaZB2wffSDKJn5P1kg_22B7VGpD';

// Supabase API 호출 함수
async function supabaseCall(table, method = 'GET', data = null, query = '') {
    const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
    const options = {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'
        }
    };
    if (data && (method === 'POST' || method === 'PATCH')) {
        options.body = JSON.stringify(data);
    }
    try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        if (method === 'DELETE') return true;
        const text = await res.text();
        return text ? JSON.parse(text) : [];
    } catch (e) {
        console.error('Supabase error:', e);
        return null;
    }
}

// 데이터 로드 함수들
async function loadFromDB(table) {
    return await supabaseCall(table, 'GET', null, '?order=id.desc');
}

async function insertToDB(table, data) {
    return await supabaseCall(table, 'POST', data);
}

async function updateInDB(table, id, data) {
    return await supabaseCall(table, 'PATCH', data, `?id=eq.${id}`);
}

async function deleteFromDB(table, id) {
    return await supabaseCall(table, 'DELETE', null, `?id=eq.${id}`);
}

// ======================= 전역 변수 =======================
let currentSystem = 'settlement'; // 'settlement' or 'bromotors'
let currentUser = null;

// 데이터 배열 (DB에서 로드)
let staffList = [];
let customerList = [];
let contractList = [];
let arrearsDetailList = [];
let recentPayments = [];
let pgPaymentsList = [];
let paymentHistory = [];
let ledgerList = [];
let vehicleList = [];
let broWorkList = [];
let broCashbookList = [];
let broPartsList = [];
let broCustList = [];

// ======================= 유틸리티 =======================
const fmt = n => '₩' + (n||0).toLocaleString();
const roleBadge = r => ({admin:['badge-admin','관리자'],manager:['badge-manager','매니저'],staff:['badge-staff','일반']}[r]||['','']);
const statusBadge = s => s==='active'?['badge-active','활성']:['badge-failed','비활성'];
const gradeBadge = g => ({ '상': ['badge-active', '상'], '중': ['badge-completed', '중'], '하': ['badge-failed', '하'] }[g] || ['badge-staff', '-']);

function showToast(msg, type = 'success') {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast toast-${type}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ======================= 로그인 =======================
function selectSystem(system) {
    document.querySelectorAll('.system-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    currentSystem = system;
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    // DB에서 직원 정보 확인
    const users = await supabaseCall('staff', 'GET', null, `?username=eq.${username}&password=eq.${password}`);
    
    if (users && users.length > 0) {
        const user = users[0];
        currentUser = user;
        
        // 모든 데이터 로드
        await loadAllData();
        
        document.getElementById('loginPage').classList.add('hidden');
        
        // 선택한 시스템으로 이동
        if (currentSystem === 'settlement') {
            document.getElementById('settlementSystem').classList.remove('hidden');
            document.getElementById('s-userName').textContent = user.name;
            document.getElementById('s-userRole').textContent = roleBadge(user.role)[1];
            renderStaffList();
            loadOverview();
            initDates();
        } else {
            document.getElementById('bromotorsSystem').classList.remove('hidden');
            document.getElementById('b-userName').textContent = user.name;
            document.getElementById('b-userRole').textContent = roleBadge(user.role)[1];
            initDates();
        }
        
        showToast(`${user.name}님 환영합니다!`);
    } else {
        document.getElementById('loginError').textContent = '아이디 또는 비밀번호가 올바르지 않습니다.';
        document.getElementById('loginError').classList.remove('hidden');
    }
}

// 모든 데이터 로드
async function loadAllData() {
    showToast('데이터 로딩 중...', 'info');
    
    const [staff, customers, contracts, vehicles, ledger, pgPayments, works, cashbook, parts, broCustomers] = await Promise.all([
        loadFromDB('staff'),
        loadFromDB('customers'),
        loadFromDB('contracts'),
        loadFromDB('vehicles'),
        loadFromDB('ledger'),
        loadFromDB('pg_payments'),
        loadFromDB('bro_works'),
        loadFromDB('bro_cashbook'),
        loadFromDB('bro_parts'),
        loadFromDB('bro_customers')
    ]);
    
    staffList = staff || [];
    customerList = customers || [];
    contractList = contracts || [];
    vehicleList = vehicles || [];
    ledgerList = (ledger || []).map(l => ({...l, desc: l.description}));
    pgPaymentsList = pgPayments || [];
    broWorkList = works || [];
    broCashbookList = cashbook || [];
    broPartsList = parts || [];
    broCustList = broCustomers || [];
    
    // recentPayments는 ledger에서 추출
    recentPayments = ledgerList.filter(l => l.type === 'receipt').slice(0, 5).map((l, i) => ({
        id: i + 1,
        customer_name: l.customer_name,
        amount: l.receipt,
        date: l.date,
        time: '09:00'
    }));
}

// 날짜 초기화 함수
function initDates() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const today = `${year}-${month}-${day}`;
    const todayKor = `${year}년 ${month}월 ${day}일`;
    
    // 헤더 날짜 표시
    if (document.getElementById('s-today-date')) document.getElementById('s-today-date').textContent = todayKor;
    if (document.getElementById('b-today-date')) document.getElementById('b-today-date').textContent = todayKor;
    
    // 모든 date input 기본값 설정
    document.querySelectorAll('input[type="date"]').forEach(el => {
        if (!el.value) el.value = today;
    });
    
    // month input 기본값 설정
    document.querySelectorAll('input[type="month"]').forEach(el => {
        if (!el.value) el.value = `${year}-${month}`;
    });
}

function handleLogout() {
    currentUser = null;
    location.reload();
}

// ======================= 시스템 전환 =======================
function switchSystem() {
    if (currentSystem === 'settlement') {
        document.getElementById('settlementSystem').classList.add('hidden');
        document.getElementById('bromotorsSystem').classList.remove('hidden');
        document.getElementById('b-userName').textContent = currentUser.name;
        document.getElementById('b-userRole').textContent = roleBadge(currentUser.role)[1];
        currentSystem = 'bromotors';
        showBromotorsTab('overview');
    } else {
        document.getElementById('bromotorsSystem').classList.add('hidden');
        document.getElementById('settlementSystem').classList.remove('hidden');
        document.getElementById('s-userName').textContent = currentUser.name;
        document.getElementById('s-userRole').textContent = roleBadge(currentUser.role)[1];
        currentSystem = 'settlement';
        showSettlementTab('overview');
    }
}

function goToSettlementSettings() {
    document.getElementById('bromotorsSystem').classList.add('hidden');
    document.getElementById('settlementSystem').classList.remove('hidden');
    currentSystem = 'settlement';
    showSettlementTab('settings');
}

// ======================= 정산관리 탭 =======================
function showSettlementTab(name) {
    document.querySelectorAll('[id^="s-tab-"]').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
    document.getElementById('s-tab-' + name).classList.add('tab-active');
    document.getElementById('s-tab-' + name).classList.remove('text-gray-500');
    document.querySelectorAll('.s-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('s-content-' + name).classList.remove('hidden');
    
    if (name === 'overview') loadOverview();
    if (name === 'contracts') loadContracts();
    if (name === 'vehicles') loadVehicles();
    if (name === 'customers') loadCustomers();
    if (name === 'charges') loadPgPayments();
    if (name === 'ledger') loadLedger();
    if (name === 'delinquent') loadDelinquent();
    if (name === 'settings') renderStaffList();
}

function showSettingTab(name, el) {
    document.querySelectorAll('.setting-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.setting-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('setting-' + name).classList.remove('hidden');
    
    if (name === 'pg') loadPgSettings();
}

// ======================= PG 설정 =======================
let pgSettings = {
    provider: 'nicepay',
    mid: '',
    merchantKey: '',
    secretKey: '',
    apiUrl: 'https://api.nicepay.co.kr/v1/payments',
    cancelUrl: 'https://api.nicepay.co.kr/v1/payments/cancel',
    billingUrl: 'https://api.nicepay.co.kr/v1/subscribe/regist',
    mode: 'test',
    timeout: 30,
    billingEnabled: true,
    defaultPayDay: 10,
    payTime: '09',
    retryCount: 3,
    retryInterval: 2,
    webhookUrl: '',
    webhookSuccess: true,
    webhookFail: true
};

const pgProviderInfo = {
    nicepay: {
        name: '나이스페이',
        apiUrl: 'https://api.nicepay.co.kr/v1/payments',
        cancelUrl: 'https://api.nicepay.co.kr/v1/payments/cancel',
        billingUrl: 'https://api.nicepay.co.kr/v1/subscribe/regist',
        docsUrl: 'https://developers.nicepay.co.kr'
    },
    inicis: {
        name: 'KG이니시스',
        apiUrl: 'https://iniapi.inicis.com/api/v1/pay',
        cancelUrl: 'https://iniapi.inicis.com/api/v1/cancel',
        billingUrl: 'https://iniapi.inicis.com/api/v1/billing',
        docsUrl: 'https://manual.inicis.com'
    },
    toss: {
        name: '토스페이먼츠',
        apiUrl: 'https://api.tosspayments.com/v1/payments',
        cancelUrl: 'https://api.tosspayments.com/v1/payments/cancel',
        billingUrl: 'https://api.tosspayments.com/v1/billing/authorizations',
        docsUrl: 'https://docs.tosspayments.com'
    },
    kakao: {
        name: '카카오페이',
        apiUrl: 'https://kapi.kakao.com/v1/payment/ready',
        cancelUrl: 'https://kapi.kakao.com/v1/payment/cancel',
        billingUrl: 'https://kapi.kakao.com/v1/payment/subscription',
        docsUrl: 'https://developers.kakao.com/docs/latest/ko/kakaopay'
    },
    danal: {
        name: '다날',
        apiUrl: 'https://api.danal.co.kr/payment',
        cancelUrl: 'https://api.danal.co.kr/payment/cancel',
        billingUrl: 'https://api.danal.co.kr/billing',
        docsUrl: 'https://developers.danal.co.kr'
    },
    settle: {
        name: '세틀뱅크',
        apiUrl: 'https://api.settlebank.co.kr/v1/payment',
        cancelUrl: 'https://api.settlebank.co.kr/v1/cancel',
        billingUrl: 'https://api.settlebank.co.kr/v1/billing',
        docsUrl: 'https://developers.settlebank.co.kr'
    },
    kcp: {
        name: 'NHN KCP',
        apiUrl: 'https://api.kcp.co.kr/v1/payment',
        cancelUrl: 'https://api.kcp.co.kr/v1/cancel',
        billingUrl: 'https://api.kcp.co.kr/v1/batch',
        docsUrl: 'https://developer.kcp.co.kr'
    }
};

function loadPgSettings() {
    document.getElementById('pg-provider').value = pgSettings.provider;
    document.getElementById('pg-mid').value = pgSettings.mid;
    document.getElementById('pg-merchant-key').value = pgSettings.merchantKey;
    document.getElementById('pg-secret-key').value = pgSettings.secretKey;
    document.getElementById('pg-api-url').value = pgSettings.apiUrl;
    document.getElementById('pg-cancel-url').value = pgSettings.cancelUrl;
    document.getElementById('pg-billing-url').value = pgSettings.billingUrl;
    document.getElementById('pg-mode').value = pgSettings.mode;
    document.getElementById('pg-timeout').value = pgSettings.timeout;
    document.getElementById('pg-billing-enabled').checked = pgSettings.billingEnabled;
    document.getElementById('pg-default-pay-day').value = pgSettings.defaultPayDay;
    document.getElementById('pg-pay-time').value = pgSettings.payTime;
    document.getElementById('pg-retry-count').value = pgSettings.retryCount;
    document.getElementById('pg-retry-interval').value = pgSettings.retryInterval;
    document.getElementById('pg-webhook-url').value = pgSettings.webhookUrl;
    document.getElementById('pg-webhook-success').checked = pgSettings.webhookSuccess;
    document.getElementById('pg-webhook-fail').checked = pgSettings.webhookFail;
    
    updatePgStatusBadge();
}

function onPgProviderChange(provider) {
    const info = pgProviderInfo[provider];
    if (info) {
        document.getElementById('pg-api-url').value = info.apiUrl;
        document.getElementById('pg-cancel-url').value = info.cancelUrl;
        document.getElementById('pg-billing-url').value = info.billingUrl;
    }
}

function toggleKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

function savePgSettings() {
    pgSettings = {
        provider: document.getElementById('pg-provider').value,
        mid: document.getElementById('pg-mid').value,
        merchantKey: document.getElementById('pg-merchant-key').value,
        secretKey: document.getElementById('pg-secret-key').value,
        apiUrl: document.getElementById('pg-api-url').value,
        cancelUrl: document.getElementById('pg-cancel-url').value,
        billingUrl: document.getElementById('pg-billing-url').value,
        mode: document.getElementById('pg-mode').value,
        timeout: parseInt(document.getElementById('pg-timeout').value) || 30,
        billingEnabled: document.getElementById('pg-billing-enabled').checked,
        defaultPayDay: parseInt(document.getElementById('pg-default-pay-day').value) || 10,
        payTime: document.getElementById('pg-pay-time').value,
        retryCount: parseInt(document.getElementById('pg-retry-count').value) || 3,
        retryInterval: parseInt(document.getElementById('pg-retry-interval').value) || 2,
        webhookUrl: document.getElementById('pg-webhook-url').value,
        webhookSuccess: document.getElementById('pg-webhook-success').checked,
        webhookFail: document.getElementById('pg-webhook-fail').checked
    };
    
    updatePgStatusBadge();
    showToast('✅ PG 설정이 저장되었습니다');
}

function updatePgStatusBadge() {
    const badge = document.getElementById('pg-status-badge');
    if (pgSettings.mid && pgSettings.merchantKey) {
        if (pgSettings.mode === 'production') {
            badge.className = 'badge badge-active';
            badge.textContent = '🟢 운영중';
        } else {
            badge.className = 'badge badge-pending';
            badge.textContent = '🟡 테스트';
        }
    } else {
        badge.className = 'badge badge-failed';
        badge.textContent = '⚪ 미설정';
    }
}

function testPgConnection() {
    const mid = document.getElementById('pg-mid').value;
    const merchantKey = document.getElementById('pg-merchant-key').value;
    
    if (!mid || !merchantKey) {
        showToast('❌ 가맹점 ID와 상점 키를 입력해주세요', 'error');
        return;
    }
    
    // 테스트 연결 시뮬레이션
    showToast('🔄 연결 테스트 중...');
    setTimeout(() => {
        // 실제로는 API 호출하여 확인
        showToast('✅ PG 연결 테스트 성공!');
    }, 1500);
}

function openPgDocs(provider) {
    const info = pgProviderInfo[provider];
    if (info && info.docsUrl) {
        window.open(info.docsUrl, '_blank');
    }
}

function copyWebhookUrl() {
    const url = document.getElementById('pg-webhook-url').value;
    if (url) {
        navigator.clipboard.writeText(url);
        showToast('📋 Webhook URL이 복사되었습니다');
    } else {
        showToast('❌ Webhook URL을 먼저 입력해주세요', 'error');
    }
}

// ======================= 브로모터스 탭 =======================
function showBromotorsTab(name) {
    document.querySelectorAll('[id^="b-tab-"]').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
    document.getElementById('b-tab-' + name).classList.add('tab-active');
    document.getElementById('b-tab-' + name).classList.remove('text-gray-500');
    document.querySelectorAll('.b-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('b-content-' + name).classList.remove('hidden');
    
    if (name === 'overview') loadBroDashboard();
    if (name === 'work') loadBroWork();
    if (name === 'cashbook') loadBroCashbook();
    if (name === 'parts') loadBroParts();
    if (name === 'customers') loadBroCustomers();
}

// ======================= 직원 관리 =======================
const levelBadge = l => ({ 
    1: ['bg-gray-500/20 text-gray-400', '👤 Lv.1 사원'], 
    2: ['bg-blue-500/20 text-blue-400', '⭐ Lv.2 팀원'], 
    3: ['bg-orange-500/20 text-orange-400', '👑 Lv.3 매니저'], 
    4: ['bg-red-500/20 text-red-400', '🔥 Lv.4 최고관리자'] 
}[l] || ['', '']);

function renderStaffList() {
    let h = '';
    staffList.forEach(s => {
        const [lc, ll] = levelBadge(s.level || 1);
        const [stc, stl] = statusBadge(s.status);
        h += `<tr>
            <td class="font-bold">${s.name}</td>
            <td class="text-lime-400">${s.username}</td>
            <td class="text-gray-400">${s.phone}</td>
            <td>${s.department}</td>
            <td><span class="badge ${lc}">${ll}</span></td>
            <td><span class="badge ${stc}">${stl}</span></td>
            <td class="text-gray-400 text-xs">${s.created_at}</td>
            <td>
                <button onclick="editStaff(${s.id})" class="text-lime-400 text-xs hover:underline mr-2">수정</button>
                <button onclick="deleteStaff(${s.id})" class="text-red-400 text-xs hover:underline">삭제</button>
            </td>
        </tr>`;
    });
    document.getElementById('staff-tbody').innerHTML = h;
}

function openStaffModal(editId = null) {
    document.getElementById('staffForm').reset();
    document.getElementById('staff-edit-id').value = '';
    document.querySelector('input[name="level"][value="1"]').checked = true;
    document.getElementById('staff-password').required = true;
    document.getElementById('staff-password-confirm').required = true;
    
    if (editId) {
        const s = staffList.find(x => x.id === editId);
        if (s) {
            document.getElementById('staffModalTitle').textContent = '👤 직원 수정';
            document.getElementById('staffSubmitBtn').textContent = '수정';
            document.getElementById('staff-edit-id').value = s.id;
            document.getElementById('staff-name').value = s.name;
            document.getElementById('staff-username').value = s.username;
            document.getElementById('staff-phone').value = s.phone;
            document.getElementById('staff-email').value = s.email || '';
            document.getElementById('staff-department').value = s.department;
            document.getElementById('staff-status').value = s.status;
            document.querySelector(`input[name="level"][value="${s.level || 1}"]`).checked = true;
            // 수정시 비밀번호는 선택사항
            document.getElementById('staff-password').required = false;
            document.getElementById('staff-password-confirm').required = false;
            document.getElementById('staff-password').placeholder = '변경시에만 입력';
            document.getElementById('staff-password-confirm').placeholder = '변경시에만 입력';
        }
    } else {
        document.getElementById('staffModalTitle').textContent = '👤 직원 등록';
        document.getElementById('staffSubmitBtn').textContent = '등록';
        document.getElementById('staff-password').placeholder = '';
        document.getElementById('staff-password-confirm').placeholder = '';
    }
    
    openModal('staffModal');
}

async function submitStaff(e) {
    e.preventDefault();
    const editId = document.getElementById('staff-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // 수정 모드
        const s = staffList.find(x => x.id === parseInt(editId));
        if (s) {
            // 비밀번호 변경하는 경우에만 체크
            if (d.password || d.password_confirm) {
                if (d.password !== d.password_confirm) {
                    showToast('비밀번호가 일치하지 않습니다', 'error');
                    return;
                }
                s.password = d.password;
            }
            
            // 아이디 중복 체크 (본인 제외)
            if (staffList.find(x => x.username === d.username && x.id !== parseInt(editId))) {
                showToast('이미 존재하는 아이디입니다', 'error');
                return;
            }
            
            s.name = d.name;
            s.username = d.username;
            s.phone = d.phone;
            s.email = d.email || null;
            s.department = d.department;
            s.level = parseInt(d.level) || 1;
            s.status = d.status;
            
            await updateInDB('staff', editId, {
                name: s.name, username: s.username, password: s.password,
                phone: s.phone, email: s.email, department: s.department,
                level: s.level, status: s.status
            });
        }
        showToast('✅ 직원 정보가 수정되었습니다');
    } else {
        // 등록 모드
        if (d.password !== d.password_confirm) {
            showToast('비밀번호가 일치하지 않습니다', 'error');
            return;
        }
        
        // 중복 아이디 체크
        if (staffList.find(s => s.username === d.username)) {
            showToast('이미 존재하는 아이디입니다', 'error');
            return;
        }
        
        const staffData = {
            name: d.name,
            username: d.username,
            password: d.password,
            phone: d.phone,
            email: d.email || null,
            department: d.department,
            level: parseInt(d.level) || 1,
            role: d.level >= 3 ? 'manager' : 'staff',
            status: d.status || 'active'
        };
        
        const result = await insertToDB('staff', staffData);
        if (result && result[0]) staffList.unshift(result[0]);
        showToast('✅ 직원이 등록되었습니다');
    }
    
    closeModal('staffModal');
    renderStaffList();
}

function editStaff(id) {
    openStaffModal(id);
}

async function deleteStaff(id) {
    const s = staffList.find(x => x.id === id);
    if (!s) return;
    
    if (s.level === 4) {
        showToast('최고관리자는 삭제할 수 없습니다', 'error');
        return;
    }
    
    if (!confirm(`${s.name} 직원을 삭제하시겠습니까?`)) return;
    
    await deleteFromDB('staff', id);
    staffList = staffList.filter(x => x.id !== id);
    showToast('✅ 직원이 삭제되었습니다');
    renderStaffList();
}

// ======================= 정산관리: 계약관리 =======================
function filterContracts(status) {
    document.getElementById('contract-status').value = status;
    loadContracts();
}

function loadContracts() {
    const search = document.getElementById('contract-search').value.toLowerCase();
    const status = document.getElementById('contract-status').value;
    
    let list = contractList;
    
    // 렌트/리스 타입 필터
    list = list.filter(c => (c.type || 'rent') === currentContractType);
    
    if (status === 'delinquent') list = list.filter(c => c.arrears > 0);
    else if (status === 'active') list = list.filter(c => c.status === 'active' && c.arrears === 0);
    else if (status) list = list.filter(c => c.status === status);
    if (search) list = list.filter(c => c.customer_name.toLowerCase().includes(search) || c.plate.toLowerCase().includes(search));
    
    // 요약 (현재 타입 기준)
    const typeContracts = contractList.filter(c => (c.type || 'rent') === currentContractType);
    const activeContracts = typeContracts.filter(c => c.status === 'active');
    const delinquentContracts = typeContracts.filter(c => c.arrears > 0);
    const monthlyRevenue = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    document.getElementById('contract-total').textContent = typeContracts.length + '건';
    document.getElementById('contract-active').textContent = activeContracts.length + '건';
    document.getElementById('contract-delinquent').textContent = delinquentContracts.length + '건';
    document.getElementById('contract-revenue').textContent = fmt(monthlyRevenue);
    document.getElementById('contract-revenue-count').textContent = activeContracts.length + '건 계약';
    
    // 테이블
    let h = '';
    list.forEach(c => {
        const hasArrears = c.arrears > 0;
        const statusBadge = hasArrears ? ['badge-delinquent', '연체'] : c.status === 'active' ? ['badge-active', '진행중'] : ['badge-pending', '대기'];
        const period = c.start_date && c.end_date ? `${c.start_date.substring(5)} ~ ${c.end_date.substring(5)}` : c.start_date ? c.start_date.substring(5) + ' ~' : '-';
        const hasDoc = c.contractor_id_url || c.vehicle_reg_url;
        
        h += `<tr onclick="viewContractDetail(${c.id})" class="cursor-pointer hover:bg-white/5">
            <td class="text-lime-400">#${String(c.id).padStart(3,'0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="font-mono">${c.plate}</td>
            <td class="text-xs">${c.fuel_type || '-'}</td>
            <td class="text-xs text-gray-400">${period}</td>
            <td class="font-bold">${fmt(c.monthly)}</td>
            <td class="${hasArrears ? 'text-orange-400 font-bold' : 'text-gray-500'}">${hasArrears ? fmt(c.arrears) : '-'}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td>${hasDoc ? '<span class="text-cyan-400">📎</span>' : '<span class="text-gray-600">-</span>'}</td>
        </tr>`;
    });
    document.getElementById('contract-tbody').innerHTML = h || '<tr><td colspan="11" class="text-center text-gray-500 py-6">계약 없음</td></tr>';
}

// 월 정산금액 상세 모달
function openMonthlyRevenueModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    const monthName = today.substring(0, 7).replace('-', '년 ') + '월';
    
    const activeContracts = contractList.filter(c => c.status === 'active');
    const monthlyRevenue = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    // 이번달 수납 금액 (원장 기준)
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const actualReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    const receiptRate = monthlyRevenue > 0 ? Math.round((actualReceipt / monthlyRevenue) * 100) : 0;
    
    // 계약 유형별 집계
    const leaseContracts = activeContracts.filter(c => c.type === 'lease');
    const rentContracts = activeContracts.filter(c => c.type === 'rent');
    const leaseRevenue = leaseContracts.reduce((s, c) => s + c.monthly, 0);
    const rentRevenue = rentContracts.reduce((s, c) => s + c.monthly, 0);
    
    // 계약별 테이블
    let tableRows = '';
    activeContracts.sort((a, b) => b.monthly - a.monthly).forEach(c => {
        const typeLabel = c.type === 'lease' ? '리스' : '렌트';
        const typeBadge = c.type === 'lease' ? 'badge-progress' : 'badge-pending';
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="closeModal('monthlyRevenueModal'); viewContractDetail(${c.id});">
            <td class="text-lime-400">#${String(c.id).padStart(3, '0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td>${c.vehicle}</td>
            <td><span class="badge ${typeBadge}">${typeLabel}</span></td>
            <td class="text-blue-400 font-bold">${fmt(c.monthly)}</td>
        </tr>`;
    });
    
    document.getElementById('monthly-revenue-content').innerHTML = `
        <div class="text-center text-lg font-bold text-lime-400 mb-4">${monthName}</div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">월 예상 수익</div>
                <div class="text-xl font-black text-emerald-400">${fmt(monthlyRevenue)}</div>
                <div class="text-xs text-gray-500">${activeContracts.length}건 계약</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">실제 수납</div>
                <div class="text-xl font-black text-blue-400">${fmt(actualReceipt)}</div>
                <div class="text-xs text-gray-500">${thisMonthReceipts.length}건</div>
            </div>
            <div class="p-4 rounded-xl ${receiptRate >= 80 ? 'bg-emerald-400/10 border-emerald-400/30' : 'bg-orange-400/10 border-orange-400/30'} text-center">
                <div class="text-xs ${receiptRate >= 80 ? 'text-emerald-400' : 'text-orange-400'} mb-1">수납률</div>
                <div class="text-xl font-black ${receiptRate >= 80 ? 'text-emerald-400' : 'text-orange-400'}">${receiptRate}%</div>
                <div class="text-xs text-gray-500">${receiptRate >= 80 ? '양호' : '미달'}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">📊 계약 유형별</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-400 w-12">리스</span>
                    <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-400" style="width:${monthlyRevenue > 0 ? Math.round((leaseRevenue / monthlyRevenue) * 100) : 0}%"></div>
                    </div>
                    <span class="text-xs text-blue-400 w-24 text-right">${fmt(leaseRevenue)}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-400 w-12">렌트</span>
                    <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-yellow-400" style="width:${monthlyRevenue > 0 ? Math.round((rentRevenue / monthlyRevenue) * 100) : 0}%"></div>
                    </div>
                    <span class="text-xs text-yellow-400 w-24 text-right">${fmt(rentRevenue)}</span>
                </div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:250px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>계약</th><th>고객</th><th>차량</th><th>유형</th><th>월납입</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">계약 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('monthlyRevenueModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('monthlyRevenueModal'); showSettlementTab('ledger');" class="btn-primary flex-1">원장 보기</button>
        </div>
    `;
    
    openModal('monthlyRevenueModal');
}

function viewContractDetail(id) {
    const c = contractList.find(x => x.id === id);
    if (!c) return;
    
    const statusBadge = c.status === 'active' ? ['badge-active', '진행중'] : ['badge-delinquent', '연체'];
    const typeBadge = (c.type || 'rent') === 'rent' ? ['badge-rent', '렌트'] : ['badge-lease', '리스'];
    
    // 서류 링크 생성
    const docLinks = [];
    if (c.contractor_id_url) docLinks.push(`<a href="${c.contractor_id_url}" target="_blank" class="text-cyan-400 hover:underline text-xs">📎 계약자 신분증</a>`);
    if (c.contractor_doc_url) docLinks.push(`<a href="${c.contractor_doc_url}" target="_blank" class="text-cyan-400 hover:underline text-xs">📎 계약자 기타서류</a>`);
    if (c.guarantor_id_url) docLinks.push(`<a href="${c.guarantor_id_url}" target="_blank" class="text-yellow-400 hover:underline text-xs">📎 보증인 신분증</a>`);
    if (c.guarantor_doc_url) docLinks.push(`<a href="${c.guarantor_doc_url}" target="_blank" class="text-yellow-400 hover:underline text-xs">📎 보증인 기타서류</a>`);
    if (c.vehicle_reg_url) docLinks.push(`<a href="${c.vehicle_reg_url}" target="_blank" class="text-purple-400 hover:underline text-xs">📎 차량등록증</a>`);
    if (c.vehicle_disposal_url) docLinks.push(`<a href="${c.vehicle_disposal_url}" target="_blank" class="text-purple-400 hover:underline text-xs">📎 폐지서류</a>`);
    if (c.vehicle_doc_url) docLinks.push(`<a href="${c.vehicle_doc_url}" target="_blank" class="text-purple-400 hover:underline text-xs">📎 차량 기타서류</a>`);
    
    document.getElementById('contract-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">계약번호</span><span class="text-lime-400 font-bold">#${String(c.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">계약유형</span><span class="badge ${typeBadge[0]}">${typeBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">상태</span><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">차량</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">번호판</span><span>${c.plate}</span></div>
                <div class="info-row"><span class="info-label">연료</span><span>${c.fuel_type || '-'}</span></div>
                <div class="info-row"><span class="info-label">월 납입금</span><span class="text-blue-400 font-bold">${fmt(c.monthly)}</span></div>
                <div class="info-row"><span class="info-label">계약 시작일</span><span>${c.start_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">계약 종료일</span><span>${c.end_date || '-'}</span></div>
            </div>
            ${c.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-sm text-gray-400">📝 ${c.memo}</div>` : ''}
        </div>
        
        ${c.guarantor_name ? `
        <div class="p-4 rounded-lg bg-yellow-400/10 border border-yellow-400/30 mb-4">
            <div class="text-xs text-yellow-400 mb-2">👥 연대보증인</div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-400 text-xs">이름:</span> <span class="font-bold">${c.guarantor_name}</span></div>
                <div><span class="text-gray-400 text-xs">연락처:</span> <span>${c.guarantor_phone || '-'}</span></div>
            </div>
        </div>` : ''}
        
        ${docLinks.length > 0 ? `
        <div class="p-4 rounded-lg bg-cyan-400/10 border border-cyan-400/30 mb-4">
            <div class="text-xs text-cyan-400 mb-2">📎 첨부 서류</div>
            <div class="flex flex-wrap gap-3">${docLinks.join('')}</div>
        </div>` : ''}
        
        ${c.arrears > 0 ? `
        <div class="p-4 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-orange-400 font-bold">미납 금액</span>
                <span class="text-xl font-black text-orange-400">${fmt(c.arrears)}</span>
            </div>
        </div>` : ''}
        <div class="flex gap-3">
            <button onclick="deleteContract(${c.id})" class="btn-danger flex-1">삭제</button>
            <button onclick="closeModal('contractDetailModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="editContract(${c.id})" class="btn-primary flex-1">수정</button>
        </div>
    `;
    openModal('contractDetailModal');
}

function editContract(id) {
    closeModal('contractDetailModal');
    const c = contractList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('contractModalTitle').textContent = '📋 계약 수정';
    document.getElementById('contractSubmitBtn').textContent = '수정';
    document.getElementById('contract-edit-id').value = c.id;
    document.getElementById('con-customer').value = c.customer_name;
    document.getElementById('con-phone').value = c.phone;
    document.getElementById('con-vehicle').value = c.vehicle;
    document.getElementById('con-plate').value = c.plate;
    document.getElementById('con-monthly').value = c.monthly;
    document.getElementById('con-start').value = c.start_date;
    document.getElementById('con-end').value = c.end_date || '';
    document.getElementById('con-fuel').value = c.fuel_type || '휘발유';
    document.getElementById('con-memo').value = c.memo || '';
    
    // 계약 유형 선택
    const typeRadio = document.querySelector(`input[name="contract_type"][value="${c.type || 'rent'}"]`);
    if (typeRadio) typeRadio.checked = true;
    
    // 연대보증인
    if (c.guarantor_name) {
        document.getElementById('con-has-guarantor').checked = true;
        toggleGuarantor();
        document.getElementById('con-guarantor-name').value = c.guarantor_name || '';
        document.getElementById('con-guarantor-phone').value = c.guarantor_phone || '';
    }
    
    openModal('contractModal');
}

// 연대보증인 토글
function toggleGuarantor() {
    const checked = document.getElementById('con-has-guarantor').checked;
    document.getElementById('guarantor-section').classList.toggle('hidden', !checked);
}

// 렌트/리스 탭 전환
let currentContractType = 'rent';
function switchContractType(type) {
    currentContractType = type;
    document.getElementById('contract-tab-rent').className = type === 'rent' 
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-purple-500/20 text-purple-400 border border-purple-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    document.getElementById('contract-tab-lease').className = type === 'lease'
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-pink-500/20 text-pink-400 border border-pink-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    loadContracts();
}

// 파일 업로드 함수
async function uploadFile(file, folder) {
    if (!file) return null;
    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const filePath = `${folder}/${fileName}`;
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const res = await fetch(`${SUPABASE_URL}/storage/v1/object/documents/${filePath}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY,
                'Content-Type': file.type || 'application/octet-stream',
                'x-upsert': 'true'
            },
            body: arrayBuffer
        });
        
        if (res.ok) {
            console.log('Upload success:', filePath);
            return `${SUPABASE_URL}/storage/v1/object/public/documents/${filePath}`;
        } else {
            const err = await res.text();
            console.error('Upload failed:', res.status, err);
        }
    } catch (e) {
        console.error('Upload error:', e);
    }
    return null;
}

async function submitContract(e) {
    e.preventDefault();
    showToast('저장 중...', 'info');
    
    const editId = document.getElementById('contract-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    // 파일 업로드
    const contractorIdFile = document.getElementById('con-contractor-id').files[0];
    const contractorDocFile = document.getElementById('con-contractor-doc').files[0];
    const guarantorIdFile = document.getElementById('con-guarantor-id').files[0];
    const guarantorDocFile = document.getElementById('con-guarantor-doc').files[0];
    const vehicleRegFile = document.getElementById('con-vehicle-reg').files[0];
    const vehicleDisposalFile = document.getElementById('con-vehicle-disposal').files[0];
    const vehicleDocFile = document.getElementById('con-vehicle-doc').files[0];
    
    const [contractorIdUrl, contractorDocUrl, guarantorIdUrl, guarantorDocUrl, vehicleRegUrl, vehicleDisposalUrl, vehicleDocUrl] = await Promise.all([
        uploadFile(contractorIdFile, 'contractor'),
        uploadFile(contractorDocFile, 'contractor'),
        uploadFile(guarantorIdFile, 'guarantor'),
        uploadFile(guarantorDocFile, 'guarantor'),
        uploadFile(vehicleRegFile, 'vehicle'),
        uploadFile(vehicleDisposalFile, 'vehicle'),
        uploadFile(vehicleDocFile, 'vehicle')
    ]);
    
    const contractData = {
        customer_name: d.customer_name,
        phone: d.phone,
        vehicle: d.vehicle,
        plate: d.plate,
        monthly: parseInt(d.monthly) || 0,
        start_date: d.start_date,
        end_date: d.end_date || null,
        fuel_type: d.fuel_type || '휘발유',
        memo: d.memo || null,
        type: d.contract_type || 'rent',
        guarantor_name: d.guarantor_name || null,
        guarantor_phone: d.guarantor_phone || null
    };
    
    // 새 파일이 업로드된 경우에만 URL 업데이트
    if (contractorIdUrl) contractData.contractor_id_url = contractorIdUrl;
    if (contractorDocUrl) contractData.contractor_doc_url = contractorDocUrl;
    if (guarantorIdUrl) contractData.guarantor_id_url = guarantorIdUrl;
    if (guarantorDocUrl) contractData.guarantor_doc_url = guarantorDocUrl;
    if (vehicleRegUrl) contractData.vehicle_reg_url = vehicleRegUrl;
    if (vehicleDisposalUrl) contractData.vehicle_disposal_url = vehicleDisposalUrl;
    if (vehicleDocUrl) contractData.vehicle_doc_url = vehicleDocUrl;
    
    if (editId) {
        await updateInDB('contracts', editId, contractData);
        const c = contractList.find(x => x.id === parseInt(editId));
        if (c) Object.assign(c, contractData);
        showToast('✅ 계약이 수정되었습니다');
    } else {
        contractData.arrears = 0;
        contractData.status = 'active';
        const result = await insertToDB('contracts', contractData);
        if (result && result[0]) contractList.unshift(result[0]);
        showToast('✅ 계약이 등록되었습니다');
    }
    
    closeModal('contractModal');
    document.getElementById('contractForm').reset();
    document.getElementById('contract-edit-id').value = '';
    document.getElementById('guarantor-section').classList.add('hidden');
    document.getElementById('con-has-guarantor').checked = false;
    document.getElementById('contractModalTitle').textContent = '📋 계약 등록';
    document.getElementById('contractSubmitBtn').textContent = '등록';
    loadContracts();
}

async function deleteContract(id) {
    if (!confirm('정말 이 계약을 삭제하시겠습니까?')) return;
    await deleteFromDB('contracts', id);
    contractList = contractList.filter(c => c.id !== id);
    showToast('✅ 계약이 삭제되었습니다');
    closeModal('contractDetailModal');
    loadContracts();
}

// ======================= 정산관리: 차량관리 =======================
const vStatusBadge = s => ({ '입고': ['badge-active', '입고(대기)'], '출고': ['badge-completed', '출고(계약중)'], '반납': ['badge-pending', '반납(점검)'], '정비': ['badge-delinquent', '정비중'], '폐차': ['badge-staff', '폐차/매각'] }[s] || ['', '']);

function loadVehicles() {
    const search = document.getElementById('vehicle-search').value.toLowerCase();
    const status = document.getElementById('vehicle-status').value;
    
    let list = vehicleList;
    if (status) list = list.filter(v => v.status === status);
    if (search) list = list.filter(v => v.plate.toLowerCase().includes(search) || v.model.toLowerCase().includes(search));
    
    // 요약
    document.getElementById('v-stock').textContent = vehicleList.filter(v => v.status === '입고').length + '대';
    document.getElementById('v-out').textContent = vehicleList.filter(v => v.status === '출고').length + '대';
    document.getElementById('v-return').textContent = vehicleList.filter(v => v.status === '반납').length + '대';
    document.getElementById('v-repair').textContent = vehicleList.filter(v => v.status === '정비').length + '대';
    document.getElementById('v-disposed').textContent = vehicleList.filter(v => v.status === '폐차').length + '대';
    
    // 테이블
    let h = '';
    list.forEach(v => {
        const [sc, sl] = vStatusBadge(v.status);
        const contract = v.contract_id ? contractList.find(c => c.id === v.contract_id) : null;
        h += `<tr onclick="viewVehicleDetail(${v.id})" class="cursor-pointer">
            <td class="font-mono font-bold text-lime-400">${v.plate}</td>
            <td>${v.model}</td>
            <td>${v.year}</td>
            <td>${v.color || '-'}</td>
            <td>${v.mileage.toLocaleString()} km</td>
            <td><span class="badge ${sc}">${sl}</span></td>
            <td class="${contract ? 'text-blue-400' : 'text-gray-500'}">${contract ? '#' + String(contract.id).padStart(3,'0') : '-'}</td>
        </tr>`;
    });
    document.getElementById('vehicle-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">차량 없음</td></tr>';
}

function filterVehicles(status) {
    document.getElementById('vehicle-status').value = status;
    loadVehicles();
}

function viewVehicleDetail(id) {
    const v = vehicleList.find(x => x.id === id);
    if (!v) return;
    
    const [sc, sl] = vStatusBadge(v.status);
    const contract = v.contract_id ? contractList.find(c => c.id === v.contract_id) : null;
    
    let actionBtns = '';
    if (v.status === '입고') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, '출고')" class="btn-primary flex-1">📤 출고</button><button onclick="changeVehicleStatus(${v.id}, '정비')" class="btn-secondary flex-1">🔧 정비</button>`;
    else if (v.status === '출고') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, '반납')" class="btn-primary flex-1">🔄 반납</button>`;
    else if (v.status === '반납') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, '입고')" class="btn-primary flex-1">✅ 점검완료</button><button onclick="changeVehicleStatus(${v.id}, '정비')" class="btn-secondary flex-1">🔧 정비</button>`;
    else if (v.status === '정비') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, '입고')" class="btn-primary flex-1">✅ 정비완료</button>`;
    
    // 폐차/매각 버튼 (출고 상태가 아닐 때만)
    if (v.status !== '출고' && v.status !== '폐차') {
        actionBtns += `<button onclick="changeVehicleStatus(${v.id}, '폐차')" class="flex-1 p-2 rounded-lg bg-red-500/20 border border-red-500/50 text-red-400 text-sm hover:bg-red-500/30">🚫 폐차/매각</button>`;
    }
    
    document.getElementById('vehicle-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">번호판</span><span class="text-lime-400 font-bold">${v.plate}</span></div>
                <div class="info-row"><span class="info-label">상태</span><span class="badge ${sc}">${sl}</span></div>
                <div class="info-row"><span class="info-label">모델</span><span class="font-bold">${v.model}</span></div>
                <div class="info-row"><span class="info-label">연식</span><span>${v.year}년</span></div>
                <div class="info-row"><span class="info-label">색상</span><span>${v.color || '-'}</span></div>
                <div class="info-row"><span class="info-label">주행거리</span><span>${v.mileage.toLocaleString()} km</span></div>
                ${contract ? `<div class="info-row col-span-2"><span class="info-label">연결계약</span><span class="text-blue-400">#${String(contract.id).padStart(3,'0')} ${contract.customer_name}</span></div>` : ''}
            </div>
        </div>
        ${v.memo ? `<div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4"><div class="text-xs text-lime-400 mb-2">📝 메모</div><div class="text-sm">${v.memo}</div></div>` : ''}
        <div class="flex gap-3 mb-3">${actionBtns}</div>
        <div class="flex gap-3">
            <button onclick="deleteVehicle(${v.id})" class="btn-danger flex-1">삭제</button>
            <button onclick="closeModal('vehicleDetailModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="editVehicle(${v.id})" class="btn-primary flex-1">수정</button>
        </div>
    `;
    openModal('vehicleDetailModal');
}

function changeVehicleStatus(id, newStatus) {
    const v = vehicleList.find(x => x.id === id);
    if (v) {
        v.status = newStatus;
        if (newStatus !== '출고') v.contract_id = null;
    }
    showToast(`✅ 차량 상태가 "${newStatus}"로 변경되었습니다`);
    closeModal('vehicleDetailModal');
    loadVehicles();
}

function editVehicle(id) {
    closeModal('vehicleDetailModal');
    const v = vehicleList.find(x => x.id === id);
    if (!v) return;
    
    document.getElementById('vehicleModalTitle').textContent = '🚗 차량 수정';
    document.getElementById('vehicleSubmitBtn').textContent = '수정';
    document.getElementById('vehicle-edit-id').value = v.id;
    document.getElementById('veh-plate').value = v.plate;
    document.getElementById('veh-model').value = v.model;
    document.getElementById('veh-year').value = v.year;
    document.getElementById('veh-color').value = v.color || '';
    document.getElementById('veh-mileage').value = v.mileage;
    document.getElementById('veh-memo').value = v.memo || '';
    openModal('vehicleModal');
}

function submitVehicle(e) {
    e.preventDefault();
    const editId = document.getElementById('vehicle-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        const v = vehicleList.find(x => x.id === parseInt(editId));
        if (v) {
            v.plate = d.plate;
            v.model = d.model;
            v.year = parseInt(d.year) || 2024;
            v.color = d.color || '';
            v.mileage = parseInt(d.mileage) || 0;
            v.memo = d.memo || '';
        }
        showToast('✅ 차량이 수정되었습니다');
    } else {
        vehicleList.push({
            id: Math.max(...vehicleList.map(v => v.id), 0) + 1,
            plate: d.plate,
            model: d.model,
            year: parseInt(d.year) || 2024,
            color: d.color || '',
            mileage: parseInt(d.mileage) || 0,
            status: '입고',
            contract_id: null,
            memo: d.memo || ''
        });
        showToast('✅ 차량이 등록되었습니다');
    }
    
    closeModal('vehicleModal');
    document.getElementById('vehicleForm').reset();
    document.getElementById('vehicle-edit-id').value = '';
    document.getElementById('vehicleModalTitle').textContent = '🚗 차량 등록';
    document.getElementById('vehicleSubmitBtn').textContent = '등록';
    loadVehicles();
}

function deleteVehicle(id) {
    if (!confirm('정말 이 차량을 삭제하시겠습니까?')) return;
    vehicleList = vehicleList.filter(v => v.id !== id);
    showToast('✅ 차량이 삭제되었습니다');
    closeModal('vehicleDetailModal');
    loadVehicles();
}

// ======================= 고객 관리 =======================
function filterCustomers(grade) {
    document.getElementById('cust-grade').value = grade;
    loadCustomers();
}

function loadCustomers() {
    const search = document.getElementById('cust-search').value.toLowerCase();
    const grade = document.getElementById('cust-grade').value;
    
    let customers = customerList;
    if (grade) customers = customers.filter(c => c.grade === grade);
    if (search) customers = customers.filter(c => c.name.toLowerCase().includes(search) || c.phone.includes(search));
    
    // 요약 카운트 업데이트
    document.getElementById('cust-total').textContent = customerList.length + '명';
    document.getElementById('cust-high').textContent = customerList.filter(c => c.grade === '상').length + '명';
    document.getElementById('cust-mid').textContent = customerList.filter(c => c.grade === '중').length + '명';
    document.getElementById('cust-low').textContent = customerList.filter(c => c.grade === '하').length + '명';
    
    // 테이블 렌더링
    let h = '';
    customers.forEach(c => {
        const [gc, gl] = gradeBadge(c.grade);
        h += `<tr onclick="viewCustomerDetail(${c.id})">
            <td class="font-bold">${c.name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td class="text-gray-400 text-xs">${c.address || '-'}</td>
            <td><span class="badge ${gc}">${gl}</span></td>
            <td class="text-gray-500 text-xs">${c.memo || '-'}</td>
            <td class="text-gray-500 text-xs">${c.created_at}</td>
        </tr>`;
    });
    document.getElementById('cust-tbody').innerHTML = h || '<tr><td colspan="6" class="text-center text-gray-500 py-6">고객 없음</td></tr>';
}

function openCustomerModal(editId = null) {
    document.getElementById('customerForm').reset();
    document.getElementById('cust-edit-id').value = '';
    
    if (editId) {
        const c = customerList.find(x => x.id === editId);
        if (c) {
            document.getElementById('customerModalTitle').textContent = '👤 고객 수정';
            document.getElementById('customerSubmitBtn').textContent = '수정';
            document.getElementById('cust-edit-id').value = c.id;
            document.getElementById('cust-name').value = c.name;
            document.getElementById('cust-ssn').value = c.ssn || '';
            document.getElementById('cust-phone').value = c.phone;
            document.getElementById('cust-email').value = c.email || '';
            document.getElementById('cust-address').value = c.address || '';
            document.getElementById('cust-grade-select').value = c.grade || '';
            document.getElementById('cust-memo').value = c.memo || '';
        }
    } else {
        document.getElementById('customerModalTitle').textContent = '👤 고객 등록';
        document.getElementById('customerSubmitBtn').textContent = '등록';
    }
    
    openModal('customerModal');
}

function submitCustomer(e) {
    e.preventDefault();
    const editId = document.getElementById('cust-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // 수정 모드
        const c = customerList.find(x => x.id === parseInt(editId));
        if (c) {
            c.name = d.name;
            c.ssn = d.ssn || null;
            c.phone = d.phone;
            c.email = d.email || null;
            c.address = d.address || null;
            c.grade = d.grade;
            c.memo = d.memo || null;
        }
        showToast('✅ 고객 정보가 수정되었습니다');
    } else {
        // 등록 모드
        customerList.push({
            id: Math.max(...customerList.map(c => c.id)) + 1,
            name: d.name,
            ssn: d.ssn || null,
            phone: d.phone,
            email: d.email || null,
            address: d.address || null,
            grade: d.grade,
            memo: d.memo || null,
            created_at: new Date().toISOString().split('T')[0]
        });
        showToast('✅ 고객이 등록되었습니다');
    }
    
    closeModal('customerModal');
    loadCustomers();
}

function viewCustomerDetail(id) {
    const c = customerList.find(x => x.id === id);
    if (!c) return;
    
    const [gc, gl] = gradeBadge(c.grade);
    
    document.getElementById('customer-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 font-bold mb-3">👤 고객 정보</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${c.name}</span></div>
                <div class="info-row"><span class="info-label">주민번호</span><span>${c.ssn || '-'}</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">이메일</span><span>${c.email || '-'}</span></div>
                <div class="info-row"><span class="info-label">주소</span><span>${c.address || '-'}</span></div>
                <div class="info-row"><span class="info-label">거래등급</span><span class="badge ${gc}">${gl}</span></div>
            </div>
        </div>
        
        ${c.memo ? `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 font-bold mb-3">📝 메모</div>
            <div class="text-sm text-gray-300">${c.memo}</div>
        </div>
        ` : ''}
        
        <div class="flex gap-3">
            <button onclick="deleteCustomer(${c.id})" class="btn-danger flex-1">삭제</button>
            <button onclick="closeModal('customerDetailModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="editCustomer(${c.id})" class="btn-primary flex-1">수정</button>
        </div>
    `;
    openModal('customerDetailModal');
}

function editCustomer(id) {
    closeModal('customerDetailModal');
    openCustomerModal(id);
}

function deleteCustomer(id) {
    const c = customerList.find(x => x.id === id);
    if (!c) return;
    
    if (!confirm(`정말 "${c.name}" 고객을 삭제하시겠습니까?`)) return;
    
    customerList = customerList.filter(x => x.id !== id);
    showToast('✅ 고객이 삭제되었습니다');
    closeModal('customerDetailModal');
    loadCustomers();
}

// ======================= 정산관리: 통합현황 =======================
function loadOverview() {
    // 한국시간 기준
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    // 요약 카드 업데이트
    const totalContracts = contractList.length;
    const totalArrears = contractList.reduce((s, c) => s + c.arrears, 0);
    
    // 이번달 수납 금액 (원장에서 계산)
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const monthlyReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    
    // 오늘 발생 금액
    const todayAccrual = ledgerList.filter(l => l.type === 'accrual' && l.date === today).reduce((s, l) => s + l.accrual, 0);
    
    document.getElementById('s-total').textContent = totalContracts + '건';
    document.getElementById('s-revenue').textContent = fmt(monthlyReceipt);
    document.getElementById('s-arrears').textContent = fmt(totalArrears);
    document.getElementById('s-today').textContent = fmt(todayAccrual);
    
    // 연체 계약 목록 (미수금 있는 계약)
    const delinquents = contractList.filter(c => c.arrears > 0);
    let dh = '';
    delinquents.forEach(c => {
        dh += `<div class="p-3 rounded-xl bg-orange-400/5 border border-orange-400/20 flex items-center justify-between cursor-pointer hover:bg-orange-400/10" onclick="viewArrearsDetail(${c.id})">
            <div><div class="font-bold text-sm">${c.customer_name}</div><div class="text-xs text-gray-500">${c.vehicle} · ${c.plate}</div></div>
            <div class="text-orange-400 font-bold">${fmt(c.arrears)}</div>
        </div>`;
    });
    document.getElementById('s-delinquent-list').innerHTML = dh || '<div class="text-gray-500 text-sm text-center py-4">연체 계약 없음</div>';
    
    // 최근 결제 목록
    let ph = '';
    recentPayments.forEach(p => {
        const dateStr = p.date === today ? '오늘' : p.date === new Date(koreaTime.getTime() - 86400000).toISOString().split('T')[0] ? '어제' : p.date;
        ph += `<div class="p-3 rounded-xl bg-emerald-400/5 border border-emerald-400/20 flex items-center justify-between cursor-pointer hover:bg-emerald-400/10" onclick="viewPaymentDetail(${p.id})">
            <div><div class="font-bold text-sm">${p.customer_name}</div><div class="text-xs text-gray-500">${dateStr} ${p.time}</div></div>
            <div class="text-emerald-400 font-bold">${fmt(p.amount)}</div>
        </div>`;
    });
    document.getElementById('s-recent-payments').innerHTML = ph || '<div class="text-gray-500 text-sm text-center py-4">최근 결제 없음</div>';
}

function viewPaymentDetail(paymentId) {
    const p = recentPayments.find(x => x.id === paymentId);
    if (!p) return;
    
    // 해당 고객 계약 찾기
    const contract = contractList.find(c => c.customer_name === p.customer_name);
    
    let content = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">결제금액</span><span class="text-emerald-400 font-bold">${fmt(p.amount)}</span></div>
                <div class="info-row"><span class="info-label">결제일시</span><span>${p.date} ${p.time}</span></div>
                <div class="info-row"><span class="info-label">결제방법</span><span>카드</span></div>
            </div>
        </div>
    `;
    
    if (contract) {
        content += `
            <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20 mb-4">
                <div class="text-xs text-blue-400 mb-2">📋 계약 정보</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="info-row"><span class="info-label">차량</span><span>${contract.vehicle}</span></div>
                    <div class="info-row"><span class="info-label">번호판</span><span>${contract.plate}</span></div>
                    <div class="info-row"><span class="info-label">월 납입금</span><span>${fmt(contract.monthly)}</span></div>
                    <div class="info-row"><span class="info-label">미납금</span><span class="${contract.arrears > 0 ? 'text-orange-400' : ''}">${fmt(contract.arrears)}</span></div>
                </div>
            </div>
        `;
    }
    
    content += `
        <div class="flex gap-3">
            <button onclick="closeModal('recentPaymentsModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="showSettlementTab('ledger'); closeModal('recentPaymentsModal');" class="btn-primary flex-1">원장에서 보기</button>
        </div>
    `;
    
    document.getElementById('recent-payments-content').innerHTML = content;
    openModal('recentPaymentsModal');
}

function openArrearsModal() {
    const delinquents = contractList.filter(c => c.arrears > 0);
    const totalArrears = delinquents.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('arrears-total-amount').textContent = fmt(totalArrears);
    
    let h = '';
    delinquents.forEach(c => {
        h += `<tr>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="text-red-400">${c.delinquent_days || 0}일</td>
            <td><button onclick="viewArrearsDetail(${c.id})" class="text-lime-400 text-xs hover:underline">상세</button></td>
        </tr>`;
    });
    document.getElementById('arrears-tbody').innerHTML = h || '<tr><td colspan="6" class="text-center text-gray-500 py-6">미납 고객 없음</td></tr>';
    
    openModal('arrearsModal');
}

function viewArrearsDetail(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    closeModal('arrearsModal');
    
    // 해당 계약의 미수금 내역
    const details = arrearsDetailList.filter(d => d.contract_id === contractId);
    
    // 고객 정보 찾기
    const customer = customerList.find(cu => cu.name === c.customer_name);
    const phoneClean = c.phone.replace(/-/g, '');
    
    let detailRows = '';
    details.forEach(d => {
        const statusBadge = d.status === 'unpaid' ? '<span class="badge badge-failed">미납</span>' : '<span class="badge badge-pending">일부납</span>';
        const paidInfo = d.status === 'partial' ? `<div class="text-xs text-gray-500">납부: ${fmt(d.paid)}</div>` : '';
        detailRows += `<tr>
            <td class="text-gray-400">${d.date}</td>
            <td>${d.type}</td>
            <td class="text-orange-400 font-bold">${fmt(d.amount)}</td>
            <td>${statusBadge}${paidInfo}</td>
        </tr>`;
    });
    
    document.getElementById('arrears-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold text-lime-400 cursor-pointer hover:underline" onclick="closeModal('arrearsDetailModal'); ${customer ? `viewCustomerDetail(${customer.id})` : `showToast('고객정보 없음', 'error')`}">${c.customer_name} →</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">차량</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">번호판</span><span>${c.plate}</span></div>
                <div class="info-row"><span class="info-label">월 렌트료</span><span class="text-blue-400 font-bold">${fmt(c.monthly)}</span></div>
                <div class="info-row"><span class="info-label">연체일수</span><span class="text-red-400 font-bold">${c.delinquent_days || 0}일</span></div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">📞 전화</div>
                <div class="text-xs text-gray-400">${c.phone}</div>
            </a>
            <a href="sms:${phoneClean}?body=${encodeURIComponent('[팀브로] ' + c.customer_name + '님, 미납금 ' + fmt(c.arrears) + ' 납부 부탁드립니다.')}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">💬 문자</div>
                <div class="text-xs text-gray-400">독촉 문자 발송</div>
            </a>
        </div>
        
        <div class="p-4 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-orange-400 font-bold">총 미납 금액</span>
                <span class="text-2xl font-black text-orange-400">${fmt(c.arrears)}</span>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4">
            <table class="data-table">
                <thead><tr><th>발생일</th><th>구분</th><th>금액</th><th>상태</th></tr></thead>
                <tbody>${detailRows || '<tr><td colspan="4" class="text-center text-gray-500 py-4">내역 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('arrearsDetailModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="openPaymentModal(${c.id})" class="btn-primary flex-1">💰 수납 처리</button>
        </div>
    `;
    
    openModal('arrearsDetailModal');
}

// 수납 처리 모달 열기
function openPaymentModal(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    closeModal('arrearsDetailModal');
    
    document.getElementById('payment-contract-id').value = contractId;
    document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('payment-amount').value = c.arrears;
    
    document.getElementById('payment-info').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">차량</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">미납금액</span><span class="text-orange-400 font-bold">${fmt(c.arrears)}</span></div>
            </div>
        </div>
    `;
    
    openModal('paymentProcessModal');
}

// 수납 처리 실행
function processPayment(e) {
    e.preventDefault();
    const contractId = parseInt(document.getElementById('payment-contract-id').value);
    const amount = parseInt(document.getElementById('payment-amount').value) || 0;
    const date = document.getElementById('payment-date').value;
    const method = e.target.pay_method.value;
    const memo = e.target.pay_memo.value;
    
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    // 미납금 차감
    c.arrears = Math.max(0, c.arrears - amount);
    if (c.arrears === 0) {
        c.status = 'active';
        c.delinquent_days = 0;
    }
    
    // 원장에 수납 기록 추가
    ledgerList.unshift({
        id: Math.max(...ledgerList.map(l => l.id), 0) + 1,
        date: date,
        contract_id: contractId,
        customer_name: c.customer_name,
        type: 'receipt',
        desc: `수납 (${method})${memo ? ' - ' + memo : ''}`,
        accrual: 0,
        receipt: amount
    });
    
    // 최근결제 내역에 추가
    recentPayments.unshift({
        id: Math.max(...recentPayments.map(p => p.id), 0) + 1,
        customer_name: c.customer_name,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5)
    });
    
    showToast(`✅ ${c.customer_name}님 ${fmt(amount)} 수납 완료`);
    closeModal('paymentProcessModal');
    loadOverview();
}

// ======================= 엑셀 다운로드 =======================
function downloadExcel(type) {
    let data = [];
    let filename = '';
    
    switch(type) {
        case 'contracts':
            filename = '계약목록';
            data = contractList.map(c => ({
                '계약번호': '#' + String(c.id).padStart(3, '0'),
                '고객명': c.customer_name,
                '연락처': c.phone,
                '차량': c.vehicle,
                '번호판': c.plate,
                '월납입금': c.monthly,
                '미납금': c.arrears,
                '상태': c.status === 'active' ? '진행중' : '연체',
                '계약시작일': c.start_date
            }));
            break;
        case 'vehicles':
            filename = '차량목록';
            data = vehicleList.map(v => ({
                '번호판': v.plate,
                '모델': v.model,
                '연식': v.year,
                '색상': v.color,
                '주행거리': v.mileage,
                '상태': v.status,
                '메모': v.memo || ''
            }));
            break;
        case 'customers':
            filename = '고객목록';
            data = customerList.map(c => ({
                '고객명': c.name,
                '연락처': c.phone,
                '이메일': c.email || '',
                '주소': c.address || '',
                '등급': c.grade,
                '메모': c.memo || '',
                '등록일': c.created_at
            }));
            break;
        case 'ledger':
            filename = '원장내역';
            data = ledgerList.map(l => ({
                '일자': l.date,
                '고객명': l.customer_name,
                '구분': l.type === 'accrual' ? '발생' : l.type === 'receipt' ? '수납' : '조정',
                '내용': l.desc,
                '발생': l.accrual,
                '수납': l.receipt
            }));
            break;
        case 'delinquent':
            filename = '연체목록';
            data = contractList.filter(c => c.arrears > 0).map(c => ({
                '고객명': c.customer_name,
                '연락처': c.phone,
                '차량': c.vehicle,
                '번호판': c.plate,
                '연체금액': c.arrears,
                '연체일수': c.delinquent_days || 0,
                '월납입금': c.monthly
            }));
            break;
        case 'pg':
            filename = '자동결제목록';
            data = pgPaymentsList.map(p => ({
                '고객명': p.customer_name,
                '카드번호': p.card_no,
                '결제타입': payTypeLabel(p.pay_type),
                '결제금액': p.amount,
                '최근결제': p.last_pay,
                '상태': p.status === 'success' ? '성공' : p.status === 'failed' ? '실패' : '예정'
            }));
            break;
        case 'broWork':
            filename = '작업내역';
            data = broWorkList.map(w => ({
                '접수번호': '#W' + String(w.id).padStart(3, '0'),
                '고객명': w.customer,
                '연락처': w.phone,
                '차량': w.vehicle,
                '번호판': w.plate,
                '작업내용': w.content,
                '공임': w.labor,
                '부품비': w.parts_cost,
                '합계': w.labor + w.parts_cost,
                '상태': w.status === 'complete' ? '완료' : w.status === 'progress' ? '진행중' : '대기',
                '날짜': w.date
            }));
            break;
        case 'broCashbook':
            filename = '금전출납부';
            data = broCashbookList.map(c => ({
                '날짜': c.date,
                '구분': c.type === 'income' ? '수입' : '지출',
                '분류': c.category,
                '내용': c.description,
                '금액': c.amount
            }));
            break;
        case 'broParts':
            filename = '부품재고';
            data = broPartsList.map(p => ({
                '부품명': p.name,
                '분류': p.category,
                '재고': p.stock,
                '단가': p.price,
                '최소재고': p.min_stock
            }));
            break;
        default:
            showToast('다운로드 오류', 'error');
            return;
    }
    
    if (data.length === 0) {
        showToast('다운로드할 데이터가 없습니다', 'error');
        return;
    }
    
    // CSV 생성
    const headers = Object.keys(data[0]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    data.forEach(row => {
        csv += headers.map(h => {
            let val = row[h];
            if (typeof val === 'string' && (val.includes(',') || val.includes('\n'))) {
                val = '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
        }).join(',') + '\n';
    });
    
    // 다운로드
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showToast(`✅ ${filename} 다운로드 완료`);
}

// ======================= 브로모터스: 작업내용 =======================
const workStatusBadge = s => ({ waiting: ['badge-waiting', '대기'], progress: ['badge-progress', '진행중'], complete: ['badge-complete', '완료'] }[s] || ['', '']);

function loadBroWork() {
    const search = document.getElementById('b-work-search').value.toLowerCase();
    const statusFilter = document.getElementById('b-work-status').value;
    
    // 날짜 구간 기본값: 앞으로 7일
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let startDate = document.getElementById('b-work-start').value;
    let endDate = document.getElementById('b-work-end').value;
    
    if (!startDate || !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
        endDate = today;
        document.getElementById('b-work-start').value = startDate;
        document.getElementById('b-work-end').value = endDate;
    }
    
    let works = broWorkList.filter(w => w.date >= startDate && w.date <= endDate);
    if (statusFilter) works = works.filter(w => w.status === statusFilter);
    if (search) works = works.filter(w => 
        w.customer.toLowerCase().includes(search) || 
        w.vehicle.toLowerCase().includes(search) ||
        (w.plate && w.plate.toLowerCase().includes(search)) ||
        w.content.toLowerCase().includes(search)
    );
    
    // 날짜 내림차순 정렬
    works.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    
    let h = '';
    works.forEach(w => {
        const [sc, sl] = workStatusBadge(w.status);
        const total = w.labor + w.parts_cost;
        const isPaid = w.status === 'complete';
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewWorkDetail(${w.id})">
            <td class="text-lime-400">#W${String(w.id).padStart(3,'0')}</td>
            <td class="text-gray-400">${w.date}</td>
            <td class="font-bold">${w.customer}</td>
            <td>${w.vehicle}</td>
            <td>${w.content}</td>
            <td class="text-gray-400">${fmt(w.labor)}</td>
            <td class="text-gray-400">${fmt(w.parts_cost)}</td>
            <td class="font-bold">${fmt(total)}</td>
            <td><span class="badge ${sc}">${sl}</span></td>
            <td>
                ${isPaid 
                    ? '<span class="text-emerald-400 text-xs">✅ 완료</span>' 
                    : `<button onclick="event.stopPropagation(); openBroCardPayModal(${w.id})" class="text-blue-400 text-xs hover:underline">💳</button>`
                }
            </td>
        </tr>`;
    });
    document.getElementById('b-work-tbody').innerHTML = h || '<tr><td colspan="10" class="text-center text-gray-500 py-6">작업 없음</td></tr>';
}

async function submitBroWork(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // 작업 등록
    const workData = {
        customer: d.customer,
        phone: d.phone,
        vehicle: d.vehicle,
        plate: d.plate || '',
        content: d.content,
        labor: parseInt(d.labor) || 0,
        parts_cost: parseInt(d.parts_cost) || 0,
        status: 'waiting',
        memo: d.memo || '',
        date: today
    };
    
    const result = await insertToDB('bro_works', workData);
    if (result && result[0]) broWorkList.unshift(result[0]);
    
    // 고객 정보 자동 저장/업데이트
    const existingCust = broCustList.find(c => c.name === d.customer || c.phone === d.phone);
    if (existingCust) {
        existingCust.visits = (existingCust.visits || 0) + 1;
        existingCust.last_visit = today;
        await updateInDB('bro_customers', existingCust.id, { visits: existingCust.visits, last_visit: today });
    } else {
        const custData = {
            name: d.customer,
            phone: d.phone,
            vehicle: d.vehicle || '',
            plate: d.plate || '',
            visits: 1,
            last_visit: today
        };
        const custResult = await insertToDB('bro_customers', custData);
        if (custResult && custResult[0]) broCustList.unshift(custResult[0]);
        showToast('👤 신규 고객이 자동 등록되었습니다');
    }
    
    showToast('✅ 작업이 등록되었습니다');
    closeModal('workModal');
    e.target.reset();
    loadBroWork();
    loadBroDashboard();
}

function viewWorkDetail(id) {
    const w = broWorkList.find(x => x.id === id);
    if (!w) return;
    
    const [sc, sl] = workStatusBadge(w.status);
    const total = w.labor + w.parts_cost;
    const isPaid = w.status === 'complete';
    const phoneClean = w.phone.replace(/-/g, '');
    
    let statusBtns = '';
    if (w.status === 'waiting') statusBtns = `<button onclick="updateWorkStatus(${w.id}, 'progress')" class="btn-secondary flex-1">▶ 진행</button>`;
    else if (w.status === 'progress') statusBtns = `<button onclick="updateWorkStatus(${w.id}, 'complete')" class="btn-secondary flex-1">✅ 완료</button>`;
    
    const payBtn = isPaid 
        ? '<div class="text-emerald-400 text-center py-3">✅ 결제완료</div>' 
        : `<button onclick="closeModal('workDetailModal'); openBroCardPayModal(${w.id})" class="btn-primary flex-1">💳 카드결제</button>`;
    
    document.getElementById('work-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">접수번호</span><span class="text-lime-400 font-bold">#W${String(w.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">상태</span><span class="badge ${sc}">${sl}</span></div>
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${w.customer}</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${w.phone}</span></div>
                <div class="info-row"><span class="info-label">차량</span><span>${w.vehicle}</span></div>
                <div class="info-row"><span class="info-label">번호판</span><span>${w.plate || '-'}</span></div>
                <div class="info-row"><span class="info-label">작업내용</span><span>${w.content}</span></div>
                <div class="info-row"><span class="info-label">날짜</span><span>${w.date}</span></div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">📞 전화</div>
            </a>
            <a href="sms:${phoneClean}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">💬 문자</div>
            </a>
        </div>
        
        <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 mb-4">
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><div class="text-xs text-gray-400">공임</div><div class="font-bold text-blue-400">${fmt(w.labor)}</div></div>
                <div><div class="text-xs text-gray-400">부품비</div><div class="font-bold text-orange-400">${fmt(w.parts_cost)}</div></div>
                <div><div class="text-xs text-lime-400">합계</div><div class="font-bold text-xl text-lime-400">${fmt(total)}</div></div>
            </div>
        </div>
        
        <div class="flex gap-3">
            ${statusBtns}
            ${payBtn}
            <button onclick="closeModal('workDetailModal')" class="btn-secondary flex-1">닫기</button>
        </div>
    `;
    openModal('workDetailModal');
}

function updateWorkStatus(id, status) {
    const w = broWorkList.find(x => x.id === id);
    if (w) w.status = status;
    showToast('✅ 상태가 변경되었습니다');
    closeModal('workDetailModal');
    loadBroWork();
}

// ======================= 브로모터스: 금전출납부 =======================
let currentCbPeriod = '1w';
let cashbookChart = null;
let expenseChart = null;

function filterCashbookPeriod(period) {
    currentCbPeriod = period;
    
    // 버튼 스타일 업데이트
    ['1w', '1m', '3m', 'all'].forEach(p => {
        const btn = document.getElementById(`cb-filter-${p}`);
        if (btn) {
            btn.className = p === period 
                ? 'px-4 py-2 rounded-lg text-sm font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30'
                : 'px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10';
        }
    });
    
    // 날짜 계산
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    let startDate = '';
    
    if (period === '1w') {
        const d = new Date(koreaTime);
        d.setDate(d.getDate() - 7);
        startDate = d.toISOString().split('T')[0];
    } else if (period === '1m') {
        const d = new Date(koreaTime);
        d.setMonth(d.getMonth() - 1);
        startDate = d.toISOString().split('T')[0];
    } else if (period === '3m') {
        const d = new Date(koreaTime);
        d.setMonth(d.getMonth() - 3);
        startDate = d.toISOString().split('T')[0];
    }
    
    document.getElementById('b-cb-start-date').value = startDate;
    document.getElementById('b-cb-end-date').value = period === 'all' ? '' : today;
    
    loadBroCashbook();
}

function loadBroCashbook() {
    const typeFilter = document.getElementById('b-cb-type').value;
    const categoryFilter = document.getElementById('b-cb-category-filter')?.value || '';
    const startDate = document.getElementById('b-cb-start-date').value;
    const endDate = document.getElementById('b-cb-end-date').value;
    const search = document.getElementById('b-cb-search').value.toLowerCase();
    
    // 이번달 계산
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonth = koreaTime.toISOString().substring(0, 7);
    
    // 이번달 데이터
    const thisMonthData = broCashbookList.filter(c => c.date && c.date.startsWith(thisMonth));
    const monthIncome = thisMonthData.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
    const monthExpense = thisMonthData.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
    
    // 전체 잔액
    const totalIncome = broCashbookList.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
    const totalExpense = broCashbookList.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
    
    document.getElementById('b-cb-income').textContent = fmt(monthIncome);
    document.getElementById('b-cb-expense').textContent = fmt(monthExpense);
    document.getElementById('b-cb-profit').textContent = fmt(monthIncome - monthExpense);
    document.getElementById('b-cb-balance').textContent = fmt(totalIncome - totalExpense);
    
    // 필터 적용
    let list = broCashbookList;
    if (typeFilter) list = list.filter(c => c.type === typeFilter);
    if (categoryFilter) list = list.filter(c => c.category === categoryFilter);
    if (startDate) list = list.filter(c => c.date >= startDate);
    if (endDate) list = list.filter(c => c.date <= endDate);
    if (search) list = list.filter(c => c.description && c.description.toLowerCase().includes(search));
    
    // 날짜순 정렬 (최신순)
    list = list.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    
    // 테이블
    let h = '', runningBalance = totalIncome - totalExpense;
    list.forEach(c => {
        h += `<tr>
            <td class="text-gray-400">${c.date || '-'}</td>
            <td><span class="badge ${c.type === 'income' ? 'badge-active' : 'badge-failed'}">${c.type === 'income' ? '수입' : '지출'}</span></td>
            <td class="text-xs">${c.category || '-'}</td>
            <td>${c.description || '-'}</td>
            <td class="${c.type === 'income' ? 'text-lime-400' : 'text-red-400'} font-bold">${c.type === 'income' ? '+' : '-'}${fmt(c.amount || 0)}</td>
            <td class="text-gray-400">${fmt(runningBalance)}</td>
            <td>
                <button onclick="editCashbook(${c.id})" class="text-blue-400 text-xs hover:underline mr-2">수정</button>
                <button onclick="deleteCashbook(${c.id})" class="text-red-400 text-xs hover:underline">삭제</button>
            </td>
        </tr>`;
        runningBalance -= c.type === 'income' ? (c.amount || 0) : -(c.amount || 0);
    });
    document.getElementById('b-cb-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">내역 없음</td></tr>';
    
    // 그래프 업데이트
    updateCashbookCharts();
}

// 그래프 업데이트
function updateCashbookCharts() {
    // 최근 6개월 데이터 집계
    const months = [];
    const incomeData = [];
    const expenseData = [];
    
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthKey = d.toISOString().substring(0, 7);
        const monthLabel = (d.getMonth() + 1) + '월';
        
        const monthItems = broCashbookList.filter(c => c.date && c.date.startsWith(monthKey));
        const income = monthItems.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
        const expense = monthItems.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
        
        months.push(monthLabel);
        incomeData.push(income);
        expenseData.push(expense);
    }
    
    // 월별 수입/지출 차트
    const ctx1 = document.getElementById('cashbook-chart');
    if (ctx1) {
        if (cashbookChart) cashbookChart.destroy();
        cashbookChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: '수입', data: incomeData, backgroundColor: 'rgba(57, 255, 20, 0.6)', borderColor: '#39FF14', borderWidth: 1 },
                    { label: '지출', data: expenseData, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: '#EF4444', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#fff' } } },
                scales: {
                    x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#9CA3AF', callback: v => '₩' + (v/10000).toFixed(0) + '만' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });
    }
    
    // 지출 분류별 차트
    const expenseByCategory = {};
    broCashbookList.filter(c => c.type === 'expense').forEach(c => {
        const cat = c.category || '기타';
        expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (c.amount || 0);
    });
    
    const ctx2 = document.getElementById('expense-chart');
    if (ctx2 && Object.keys(expenseByCategory).length > 0) {
        if (expenseChart) expenseChart.destroy();
        expenseChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(expenseByCategory),
                datasets: [{
                    data: Object.values(expenseByCategory),
                    backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#6B7280', '#14B8A6']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 11 } } } }
            }
        });
    }
}

// 상세 모달
function openCashbookDetail(type) {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonth = koreaTime.toISOString().substring(0, 7);
    const monthName = thisMonth.replace('-', '년 ') + '월';
    
    const thisMonthData = broCashbookList.filter(c => c.date && c.date.startsWith(thisMonth));
    const totalIncome = broCashbookList.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
    const totalExpense = broCashbookList.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
    
    let title = '', content = '';
    
    if (type === 'income') {
        title = '💵 이번달 수입 상세';
        const incomeData = thisMonthData.filter(c => c.type === 'income');
        const total = incomeData.reduce((s, c) => s + (c.amount || 0), 0);
        
        // 분류별 집계
        const byCategory = {};
        incomeData.forEach(c => {
            const cat = c.category || '기타';
            byCategory[cat] = (byCategory[cat] || 0) + (c.amount || 0);
        });
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">${monthName}</div>
                <div class="text-3xl font-black text-lime-400">${fmt(total)}</div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
                <div class="text-xs text-lime-400 mb-3">📊 분류별 수입</div>
                ${Object.entries(byCategory).map(([cat, amt]) => `
                    <div class="flex justify-between py-2 border-b border-white/5">
                        <span>${cat}</span>
                        <span class="text-lime-400 font-bold">${fmt(amt)}</span>
                    </div>
                `).join('')}
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                <div class="text-xs text-gray-400 mb-3">📋 상세 내역 (${incomeData.length}건)</div>
                <div class="max-h-48 overflow-y-auto">
                    ${incomeData.slice(0, 10).map(c => `
                        <div class="flex justify-between py-2 border-b border-white/5 text-sm">
                            <span class="text-gray-400">${c.date}</span>
                            <span>${c.description || '-'}</span>
                            <span class="text-lime-400">${fmt(c.amount)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (type === 'expense') {
        title = '💸 이번달 지출 상세';
        const expenseData = thisMonthData.filter(c => c.type === 'expense');
        const total = expenseData.reduce((s, c) => s + (c.amount || 0), 0);
        
        // 분류별 집계
        const byCategory = {};
        expenseData.forEach(c => {
            const cat = c.category || '기타';
            byCategory[cat] = (byCategory[cat] || 0) + (c.amount || 0);
        });
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">${monthName}</div>
                <div class="text-3xl font-black text-red-400">${fmt(total)}</div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
                <div class="text-xs text-red-400 mb-3">📊 분류별 지출</div>
                ${Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([cat, amt]) => `
                    <div class="flex justify-between py-2 border-b border-white/5">
                        <span>${cat}</span>
                        <span class="text-red-400 font-bold">${fmt(amt)}</span>
                    </div>
                `).join('')}
            </div>
        `;
    } else if (type === 'profit') {
        title = '📊 이번달 순이익';
        const income = thisMonthData.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
        const expense = thisMonthData.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
        const profit = income - expense;
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">${monthName}</div>
                <div class="text-3xl font-black ${profit >= 0 ? 'text-blue-400' : 'text-red-400'}">${fmt(profit)}</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 text-center">
                    <div class="text-xs text-lime-400 mb-1">총 수입</div>
                    <div class="text-xl font-bold text-lime-400">${fmt(income)}</div>
                </div>
                <div class="p-4 rounded-lg bg-red-400/10 border border-red-400/30 text-center">
                    <div class="text-xs text-red-400 mb-1">총 지출</div>
                    <div class="text-xl font-bold text-red-400">${fmt(expense)}</div>
                </div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                <div class="text-xs text-gray-400 mb-2">수익률</div>
                <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-lime-500 to-emerald-500" style="width: ${income > 0 ? Math.min(100, (profit / income) * 100) : 0}%"></div>
                </div>
                <div class="text-right text-sm text-gray-400 mt-1">${income > 0 ? ((profit / income) * 100).toFixed(1) : 0}%</div>
            </div>
        `;
    } else if (type === 'balance') {
        title = '💰 현재 잔액';
        const balance = totalIncome - totalExpense;
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">누적 잔액</div>
                <div class="text-3xl font-black text-purple-400">${fmt(balance)}</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 text-center">
                    <div class="text-xs text-lime-400 mb-1">누적 수입</div>
                    <div class="text-xl font-bold text-lime-400">${fmt(totalIncome)}</div>
                </div>
                <div class="p-4 rounded-lg bg-red-400/10 border border-red-400/30 text-center">
                    <div class="text-xs text-red-400 mb-1">누적 지출</div>
                    <div class="text-xl font-bold text-red-400">${fmt(totalExpense)}</div>
                </div>
            </div>
        `;
    }
    
    document.getElementById('cashbookDetailTitle').textContent = title;
    document.getElementById('cashbook-detail-content').innerHTML = content + `
        <div class="flex gap-3 mt-4">
            <button onclick="closeModal('cashbookDetailModal')" class="btn-secondary flex-1">닫기</button>
        </div>
    `;
    openModal('cashbookDetailModal');
}

// 고객 검색 (작업등록)
function searchBroCustomer() {
    const query = document.getElementById('work-customer').value.toLowerCase();
    const resultsDiv = document.getElementById('customer-search-results');
    
    if (query.length < 1) {
        resultsDiv.classList.add('hidden');
        document.getElementById('customer-info-box').classList.add('hidden');
        document.getElementById('new-customer-box').classList.add('hidden');
        return;
    }
    
    const matches = broCustList.filter(c => c.name.toLowerCase().includes(query) || (c.phone && c.phone.includes(query)));
    
    if (matches.length > 0) {
        resultsDiv.innerHTML = matches.slice(0, 5).map(c => `
            <div class="p-2 hover:bg-lime-400/10 cursor-pointer border-b border-white/5" onclick="selectBroCustomer(${c.id})">
                <div class="font-bold text-sm">${c.name}</div>
                <div class="text-xs text-gray-400">${c.phone || '-'} | ${c.vehicle || '-'}</div>
            </div>
        `).join('');
        resultsDiv.classList.remove('hidden');
        document.getElementById('new-customer-box').classList.add('hidden');
    } else {
        resultsDiv.classList.add('hidden');
        document.getElementById('new-customer-box').classList.remove('hidden');
        document.getElementById('customer-info-box').classList.add('hidden');
    }
}

function selectBroCustomer(id) {
    const c = broCustList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('work-customer').value = c.name;
    document.getElementById('work-phone').value = c.phone || '';
    document.getElementById('work-vehicle').value = c.vehicle || '';
    document.getElementById('work-plate').value = c.plate || '';
    
    document.getElementById('customer-search-results').classList.add('hidden');
    document.getElementById('new-customer-box').classList.add('hidden');
    document.getElementById('customer-info-box').classList.remove('hidden');
    document.getElementById('customer-info-detail').innerHTML = `
        ${c.name} | ${c.phone || '-'} | 방문 ${c.visits || 0}회
    `;
}

// 연락처 중복 확인
function checkPhoneDuplicate() {
    const phone = document.getElementById('work-phone').value;
    const resultDiv = document.getElementById('phone-check-result');
    
    if (!phone) {
        resultDiv.innerHTML = '';
        return;
    }
    
    const existing = broCustList.find(c => c.phone === phone);
    if (existing) {
        resultDiv.innerHTML = `<span class="text-yellow-400">⚠️ 기존 고객: ${existing.name}</span>`;
        // 기존 고객 정보 자동 채우기
        document.getElementById('work-customer').value = existing.name;
        document.getElementById('work-vehicle').value = existing.vehicle || '';
        document.getElementById('work-plate').value = existing.plate || '';
        document.getElementById('customer-info-box').classList.remove('hidden');
        document.getElementById('customer-info-detail').innerHTML = `${existing.name} | 방문 ${existing.visits || 0}회`;
    } else {
        resultDiv.innerHTML = `<span class="text-lime-400">✅ 신규 연락처</span>`;
    }
}

// 합계금액 계산
function calcWorkTotal() {
    const labor = parseInt(document.getElementById('work-labor').value) || 0;
    const parts = parseInt(document.getElementById('work-parts').value) || 0;
    document.getElementById('work-total').value = fmt(labor + parts);
}

// 금전출납부 수정
function editCashbook(id) {
    const c = broCashbookList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('cashbook-edit-id').value = c.id;
    document.getElementById('cb-date').value = c.date;
    document.getElementById('cb-type').value = c.type;
    document.getElementById('cb-category').value = c.category;
    document.getElementById('cb-description').value = c.description;
    document.getElementById('cb-amount').value = c.amount;
    
    document.getElementById('cashbookModalTitle').textContent = '💰 내역 수정';
    document.getElementById('cashbookSubmitBtn').textContent = '수정';
    openModal('cashbookModal');
}

// 금전출납부 삭제
async function deleteCashbook(id) {
    if (!confirm('이 내역을 삭제하시겠습니까?')) return;
    
    await deleteFromDB('bro_cashbook', id);
    broCashbookList = broCashbookList.filter(c => c.id !== id);
    showToast('✅ 내역이 삭제되었습니다');
    loadBroCashbook();
}

async function submitBroCashbook(e) {
    e.preventDefault();
    const editId = document.getElementById('cashbook-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    const cashData = {
        date: d.date,
        type: d.type,
        category: d.category,
        description: d.description,
        amount: parseInt(d.amount) || 0
    };
    
    if (editId) {
        await updateInDB('bro_cashbook', editId, cashData);
        const c = broCashbookList.find(x => x.id === parseInt(editId));
        if (c) Object.assign(c, cashData);
        showToast('✅ 내역이 수정되었습니다');
    } else {
        const result = await insertToDB('bro_cashbook', cashData);
        if (result && result[0]) broCashbookList.unshift(result[0]);
        showToast('✅ 내역이 등록되었습니다');
    }
    
    closeModal('cashbookModal');
    e.target.reset();
    document.getElementById('cashbook-edit-id').value = '';
    document.getElementById('cashbookModalTitle').textContent = '💰 내역 등록';
    document.getElementById('cashbookSubmitBtn').textContent = '등록';
    document.getElementById('cb-date').value = new Date().toISOString().split('T')[0];
    loadBroCashbook();
}

// ======================= 브로모터스: 부품관리 =======================
function filterBroParts(type) {
    document.getElementById('b-parts-stock-filter').value = type;
    loadBroParts();
}

function loadBroParts() {
    const search = document.getElementById('b-parts-search').value.toLowerCase();
    const categoryFilter = document.getElementById('b-parts-category').value;
    const stockFilter = document.getElementById('b-parts-stock-filter').value;
    
    let parts = broPartsList;
    if (categoryFilter) parts = parts.filter(p => p.category === categoryFilter);
    if (stockFilter === 'low') parts = parts.filter(p => p.stock > 0 && p.stock <= p.min_stock);
    else if (stockFilter === 'normal') parts = parts.filter(p => p.stock > p.min_stock);
    else if (stockFilter === 'zero') parts = parts.filter(p => p.stock === 0);
    if (search) parts = parts.filter(p => p.name.toLowerCase().includes(search) || p.category.toLowerCase().includes(search));
    
    // 요약
    const totalQty = broPartsList.reduce((s, p) => s + p.stock, 0);
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock);
    const lowStockNames = lowStockParts.slice(0, 3).map(p => p.name.substring(0, 8)).join(', ');
    const totalValue = broPartsList.reduce((s, p) => s + p.stock * p.price, 0);
    
    document.getElementById('b-parts-total').textContent = broPartsList.length + '종';
    document.getElementById('b-parts-total-qty').textContent = '총 ' + totalQty + '개';
    document.getElementById('b-parts-low').textContent = lowStockParts.length + '종';
    document.getElementById('b-parts-low-list').textContent = lowStockNames ? lowStockNames + (lowStockParts.length > 3 ? '...' : '') : '-';
    document.getElementById('b-parts-value').textContent = fmt(totalValue);
    
    // 테이블
    let h = '';
    parts.forEach(p => {
        const isLow = p.stock <= p.min_stock;
        const isZero = p.stock === 0;
        const statusBadge = isZero ? ['badge-failed', '품절'] : isLow ? ['badge-low', '부족'] : ['badge-normal', '정상'];
        h += `<tr class="cursor-pointer hover:bg-white/5">
            <td class="font-bold" onclick="editParts(${p.id})">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td class="${isZero ? 'text-red-400' : isLow ? 'text-orange-400' : ''} font-bold">${p.stock}개</td>
            <td class="text-gray-500">${p.min_stock}개</td>
            <td class="text-gray-400">${fmt(p.price)}</td>
            <td class="text-blue-400">${fmt(p.stock * p.price)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td>
                <button onclick="editParts(${p.id})" class="text-lime-400 text-xs hover:underline mr-2">수정</button>
                <button onclick="deleteParts(${p.id})" class="text-red-400 text-xs hover:underline">삭제</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-parts-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">부품 없음</td></tr>';
}

// 부품 삭제
function deleteParts(id) {
    if (!confirm('정말 삭제하시겠습니까?')) return;
    broPartsList = broPartsList.filter(p => p.id !== id);
    showToast('🗑️ 부품이 삭제되었습니다');
    loadBroParts();
}

// 재고 금액 상세 모달
function openPartsValueModal() {
    // 분류별 재고금액 집계
    let categoryStats = {};
    broPartsList.forEach(p => {
        if (!categoryStats[p.category]) {
            categoryStats[p.category] = { count: 0, qty: 0, value: 0 };
        }
        categoryStats[p.category].count++;
        categoryStats[p.category].qty += p.stock;
        categoryStats[p.category].value += p.stock * p.price;
    });
    
    const totalValue = broPartsList.reduce((s, p) => s + p.stock * p.price, 0);
    
    // 분류별 바 차트
    let barsHtml = '';
    Object.entries(categoryStats).sort((a, b) => b[1].value - a[1].value).forEach(([cat, data]) => {
        const pct = totalValue > 0 ? Math.round((data.value / totalValue) * 100) : 0;
        barsHtml += `<div class="flex items-center gap-3 mb-2">
            <span class="w-16 text-xs text-gray-400">${cat}</span>
            <div class="flex-1 h-5 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full bg-blue-400 rounded-full" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-blue-400 w-24 text-right">${fmt(data.value)}</span>
            <span class="text-xs text-gray-500 w-12">${pct}%</span>
        </div>`;
    });
    
    // 부품별 상위 5개
    const topParts = [...broPartsList].sort((a, b) => (b.stock * b.price) - (a.stock * a.price)).slice(0, 5);
    let topRows = '';
    topParts.forEach(p => {
        topRows += `<tr>
            <td class="font-bold">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td>${p.stock}개</td>
            <td class="text-blue-400 font-bold">${fmt(p.stock * p.price)}</td>
        </tr>`;
    });
    
    document.getElementById('bro-parts-value-content').innerHTML = `
        <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 mb-4 text-center">
            <div class="text-xs text-blue-400 mb-1">총 재고 금액</div>
            <div class="text-3xl font-black text-blue-400">${fmt(totalValue)}</div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">📊 분류별 재고 금액</div>
            ${barsHtml || '<div class="text-gray-500 text-center py-2">데이터 없음</div>'}
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">🏆 재고금액 Top 5</div>
            <table class="data-table">
                <thead><tr><th>부품명</th><th>분류</th><th>수량</th><th>금액</th></tr></thead>
                <tbody>${topRows || '<tr><td colspan="4" class="text-center text-gray-500 py-2">데이터 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broPartsValueModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('broPartsValueModal'); showBromotorsTab('parts');" class="btn-primary flex-1">부품관리 이동</button>
        </div>
    `;
    
    openModal('broPartsValueModal');
}

function openPartsModal(editId = null) {
    document.getElementById('partsForm').reset();
    document.getElementById('parts-edit-id').value = '';
    document.getElementById('parts-min').value = '5';
    
    if (editId) {
        const p = broPartsList.find(x => x.id === editId);
        if (p) {
            document.getElementById('partsModalTitle').textContent = '📦 부품 수정';
            document.getElementById('partsSubmitBtn').textContent = '수정';
            document.getElementById('parts-edit-id').value = p.id;
            document.getElementById('parts-name').value = p.name;
            document.getElementById('parts-category').value = p.category;
            document.getElementById('parts-stock').value = p.stock;
            document.getElementById('parts-price').value = p.price;
            document.getElementById('parts-min').value = p.min_stock;
        }
    } else {
        document.getElementById('partsModalTitle').textContent = '📦 부품 등록';
        document.getElementById('partsSubmitBtn').textContent = '등록';
    }
    
    openModal('partsModal');
}

function editParts(id) {
    openPartsModal(id);
}

function submitBroParts(e) {
    e.preventDefault();
    const editId = document.getElementById('parts-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // 수정 모드
        const p = broPartsList.find(x => x.id === parseInt(editId));
        if (p) {
            p.name = d.name;
            p.category = d.category;
            p.stock = parseInt(d.stock) || 0;
            p.price = parseInt(d.price) || 0;
            p.min_stock = parseInt(d.min_stock) || 5;
        }
        showToast('✅ 부품이 수정되었습니다');
    } else {
        // 등록 모드
        broPartsList.push({
            id: Math.max(...broPartsList.map(p => p.id), 0) + 1,
            name: d.name,
            category: d.category,
            stock: parseInt(d.stock) || 0,
            price: parseInt(d.price) || 0,
            min_stock: parseInt(d.min_stock) || 5
        });
        showToast('✅ 부품이 등록되었습니다');
    }
    
    closeModal('partsModal');
    loadBroParts();
}

// ======================= 브로모터스: 고객관리 =======================
function filterBroCustomers(type) {
    document.getElementById('b-cust-filter').value = type;
    loadBroCustomers();
}

function loadBroCustomers() {
    const search = document.getElementById('b-cust-search').value.toLowerCase();
    const filter = document.getElementById('b-cust-filter').value;
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonthStart = koreaTime.toISOString().split('T')[0].substring(0, 7) + '-01';
    
    let custs = broCustList;
    
    // 필터 적용
    if (filter === 'month') custs = custs.filter(c => c.last_visit >= thisMonthStart);
    if (filter === 'vip') custs = custs.filter(c => c.visits >= 3);
    if (search) custs = custs.filter(c => 
        c.name.toLowerCase().includes(search) || 
        c.phone.includes(search) || 
        (c.vehicle && c.vehicle.toLowerCase().includes(search)) ||
        (c.plate && c.plate.toLowerCase().includes(search))
    );
    
    // 요약
    document.getElementById('b-cust-total').textContent = broCustList.length + '명';
    document.getElementById('b-cust-month').textContent = broCustList.filter(c => c.last_visit >= thisMonthStart).length + '명';
    document.getElementById('b-cust-vip').textContent = broCustList.filter(c => c.visits >= 3).length + '명';
    
    // 테이블
    let h = '';
    custs.forEach(c => {
        const vipBadge = c.visits >= 3 ? '<span class="badge badge-vip ml-1">단골</span>' : '';
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewBroCustDetail(${c.id})">
            <td class="font-bold">${c.name}${vipBadge}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle || '-'}</td>
            <td class="text-gray-400">${c.plate || '-'}</td>
            <td class="text-blue-400">${c.visits}회</td>
            <td class="text-gray-400">${c.last_visit}</td>
            <td>
                <button onclick="event.stopPropagation(); viewBroCustDetail(${c.id})" class="text-lime-400 text-xs hover:underline">상세</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-cust-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">고객 없음</td></tr>';
}

// 고객 상세 모달
function viewBroCustDetail(custId) {
    const c = broCustList.find(x => x.id === custId);
    if (!c) return;
    
    const phoneClean = c.phone.replace(/-/g, '');
    const vipBadge = c.visits >= 3 ? '<span class="badge badge-vip">⭐ 단골 고객</span>' : '';
    
    // 해당 고객의 작업 내역
    const custWorks = broWorkList.filter(w => w.customer === c.name).slice(0, 5);
    let workRows = '';
    custWorks.forEach(w => {
        const statusBadge = { waiting: ['badge-pending', '대기'], progress: ['badge-progress', '진행중'], complete: ['badge-complete', '완료'] }[w.status] || ['', ''];
        workRows += `<tr>
            <td class="text-gray-400">${w.date}</td>
            <td>${w.work}</td>
            <td class="text-blue-400">${fmt(w.total)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    // 총 이용 금액
    const totalSpent = broWorkList.filter(w => w.customer === c.name).reduce((s, w) => s + w.total, 0);
    
    document.getElementById('bro-cust-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="text-xl font-bold">${c.name} ${vipBadge}</div>
                    <div class="text-gray-400">${c.vehicle || '-'} · ${c.plate || '-'}</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">총 이용금액</div>
                    <div class="text-xl font-black text-emerald-400">${fmt(totalSpent)}</div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="info-row"><span class="info-label">연락처</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">방문횟수</span><span class="text-blue-400 font-bold">${c.visits}회</span></div>
                <div class="info-row"><span class="info-label">최근방문</span><span>${c.last_visit}</span></div>
            </div>
            ${c.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-xs text-gray-400">📝 ${c.memo}</div>` : ''}
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">📞 전화</div>
                <div class="text-xs text-gray-400">${c.phone}</div>
            </a>
            <a href="sms:${phoneClean}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">💬 문자</div>
                <div class="text-xs text-gray-400">문자 보내기</div>
            </a>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">🔧 최근 작업 내역</div>
            <table class="data-table">
                <thead><tr><th>날짜</th><th>작업</th><th>금액</th><th>상태</th></tr></thead>
                <tbody>${workRows || '<tr><td colspan="4" class="text-center text-gray-500 py-3">작업 내역 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broCustDetailModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('broCustDetailModal'); showBromotorsTab('work'); document.getElementById('b-work-search').value='${c.name}'; loadBroWork();" class="btn-primary flex-1">전체 작업 보기</button>
        </div>
    `;
    
    openModal('broCustDetailModal');
}

function submitBroCustomer(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    broCustList.push({
        id: Math.max(...broCustList.map(c => c.id), 0) + 1,
        name: d.name,
        phone: d.phone,
        vehicle: d.vehicle || '',
        plate: d.plate || '',
        memo: d.memo || '',
        visits: 0,
        last_visit: new Date().toISOString().split('T')[0]
    });
    
    showToast('✅ 고객이 등록되었습니다');
    closeModal('broCustModal');
    e.target.reset();
    loadBroCustomers();
}

// ======================= 브로모터스: 대시보드 =======================
function loadBroDashboard() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // 날짜 구간 기본값: 앞으로 7일 기준 (오늘 - 7일 전 ~ 오늘)
    let startDate = document.getElementById('b-dash-start').value;
    let endDate = document.getElementById('b-dash-end').value;
    
    if (!startDate || !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
        endDate = today;
        document.getElementById('b-dash-start').value = startDate;
        document.getElementById('b-dash-end').value = endDate;
    }
    
    // 기간 내 수입/지출 계산
    const periodCashbook = broCashbookList.filter(c => c.date >= startDate && c.date <= endDate);
    const periodIncome = periodCashbook.filter(c => c.type === 'income');
    const periodExpense = periodCashbook.filter(c => c.type === 'expense');
    const incomeTotal = periodIncome.reduce((s, c) => s + c.amount, 0);
    const expenseTotal = periodExpense.reduce((s, c) => s + c.amount, 0);
    const profit = incomeTotal - expenseTotal;
    const profitRate = incomeTotal > 0 ? Math.round((profit / incomeTotal) * 100) : 0;
    
    // 기간 내 작업
    const periodWorks = broWorkList.filter(w => w.date >= startDate && w.date <= endDate);
    const workAmount = periodWorks.reduce((s, w) => s + (w.labor + w.parts_cost), 0);
    
    document.getElementById('b-today-income').textContent = fmt(incomeTotal);
    document.getElementById('b-income-count').textContent = periodIncome.length + '건';
    document.getElementById('b-month-expense').textContent = fmt(expenseTotal);
    document.getElementById('b-expense-count').textContent = periodExpense.length + '건';
    document.getElementById('b-period-work').textContent = periodWorks.length + '건';
    document.getElementById('b-work-amount').textContent = fmt(workAmount);
    document.getElementById('b-month-profit').textContent = fmt(profit);
    document.getElementById('b-profit-rate').textContent = profit >= 0 ? `이익률 ${profitRate}%` : '적자';
    
    // 오늘 작업
    const todayWorks = broWorkList.filter(w => w.date === today);
    document.getElementById('b-today-work-count').textContent = todayWorks.length + '건';
    
    let workHtml = '';
    todayWorks.slice(0, 4).forEach(w => {
        const statusBadge = { waiting: ['badge-pending', '대기'], progress: ['badge-progress', '진행중'], complete: ['badge-complete', '완료'] }[w.status] || ['', ''];
        workHtml += `<div class="p-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between cursor-pointer hover:bg-white/10" onclick="viewWorkDetail(${w.id})">
            <div><div class="font-bold text-sm">${w.content}</div><div class="text-xs text-gray-500">${w.customer} · ${w.plate}</div></div>
            <span class="badge ${statusBadge[0]}">${statusBadge[1]}</span>
        </div>`;
    });
    if (todayWorks.length > 4) {
        workHtml += `<div class="text-center py-2"><button onclick="openBroTodayWorkModal()" class="text-lime-400 text-xs hover:underline">+ ${todayWorks.length - 4}건 더보기</button></div>`;
    }
    document.getElementById('b-today-work-list').innerHTML = workHtml || '<div class="text-gray-500 text-sm text-center py-4">오늘 작업 없음</div>';
    
    // 재고 부족
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock);
    document.getElementById('b-low-stock-count').textContent = lowStockParts.length + '건';
    
    let stockHtml = '';
    lowStockParts.slice(0, 4).forEach(p => {
        const critical = p.stock === 0;
        stockHtml += `<div class="p-3 rounded-xl ${critical ? 'bg-red-400/10 border-red-400/30' : 'bg-orange-400/5 border-orange-400/20'} border flex items-center justify-between cursor-pointer hover:bg-orange-400/10" onclick="openBroLowStockModal()">
            <div><div class="font-bold text-sm">${p.name}</div><div class="text-xs text-gray-500">현재: ${p.stock}개 (최소: ${p.min_stock})</div></div>
            <span class="badge ${critical ? 'badge-failed' : 'badge-low'}">${critical ? '품절' : '부족'}</span>
        </div>`;
    });
    if (lowStockParts.length > 4) {
        stockHtml += `<div class="text-center py-2"><button onclick="openBroLowStockModal()" class="text-orange-400 text-xs hover:underline">+ ${lowStockParts.length - 4}건 더보기</button></div>`;
    }
    document.getElementById('b-low-stock-list').innerHTML = stockHtml || '<div class="text-gray-500 text-sm text-center py-4">재고 부족 없음</div>';
}

// 대시보드 기간 설정
function setBroDashPeriod(period) {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let startDate = today;
    if (period === 'today') {
        startDate = today;
    } else if (period === 'week') {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
    } else if (period === 'month') {
        startDate = today.substring(0, 7) + '-01';
    }
    
    document.getElementById('b-dash-start').value = startDate;
    document.getElementById('b-dash-end').value = today;
    loadBroDashboard();
}

// 오늘 작업 상세 모달
function openBroTodayWorkModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    const todayWorks = broWorkList.filter(w => w.date === today);
    const totalAmount = todayWorks.reduce((s, w) => s + w.total, 0);
    const completed = todayWorks.filter(w => w.status === 'complete').length;
    
    let tableRows = '';
    todayWorks.forEach(w => {
        const statusBadge = { waiting: ['badge-pending', '대기'], progress: ['badge-progress', '진행중'], complete: ['badge-complete', '완료'] }[w.status] || ['', ''];
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="closeModal('broTodayWorkModal'); viewWorkDetail(${w.id})">
            <td class="text-lime-400">#${String(w.id).padStart(3, '0')}</td>
            <td class="font-bold">${w.customer}</td>
            <td>${w.work}</td>
            <td class="text-blue-400">${fmt(w.total)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    document.getElementById('bro-today-work-content').innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="p-4 rounded-xl bg-lime-400/10 border border-lime-400/30 text-center">
                <div class="text-xs text-lime-400 mb-1">전체</div>
                <div class="text-xl font-black text-lime-400">${todayWorks.length}건</div>
            </div>
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">완료</div>
                <div class="text-xl font-black text-emerald-400">${completed}건</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">매출</div>
                <div class="text-xl font-black text-blue-400">${fmt(totalAmount)}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>접수</th><th>고객</th><th>작업</th><th>금액</th><th>상태</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">작업 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broTodayWorkModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('broTodayWorkModal'); showBromotorsTab('work');" class="btn-primary flex-1">작업내용 이동</button>
        </div>
    `;
    
    openModal('broTodayWorkModal');
}

// 재고 부족 상세 모달
function openBroLowStockModal() {
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock).sort((a, b) => a.stock - b.stock);
    const critical = lowStockParts.filter(p => p.stock === 0).length;
    
    let tableRows = '';
    lowStockParts.forEach(p => {
        const statusBadge = p.stock === 0 ? ['badge-failed', '품절'] : ['badge-low', '부족'];
        tableRows += `<tr>
            <td class="font-bold">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td class="${p.stock === 0 ? 'text-red-400' : 'text-orange-400'} font-bold">${p.stock}개</td>
            <td class="text-gray-500">${p.min_stock}개</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    document.getElementById('bro-low-stock-content').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 text-center">
                <div class="text-xs text-orange-400 mb-1">재고 부족</div>
                <div class="text-xl font-black text-orange-400">${lowStockParts.length}건</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">품절</div>
                <div class="text-xl font-black text-red-400">${critical}건</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>부품명</th><th>분류</th><th>현재</th><th>최소</th><th>상태</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">재고 부족 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broLowStockModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('broLowStockModal'); showBromotorsTab('parts');" class="btn-primary flex-1">부품관리 이동</button>
        </div>
    `;
    
    openModal('broLowStockModal');
}

// 월간 요약 모달
function openBroMonthSummary() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonthStart = koreaTime.toISOString().split('T')[0].substring(0, 7) + '-01';
    const monthName = koreaTime.toISOString().split('T')[0].substring(0, 7).replace('-', '년 ') + '월';
    
    const monthData = broCashbookList.filter(c => c.date >= thisMonthStart);
    const monthIncome = monthData.filter(c => c.type === 'income').reduce((s, c) => s + c.amount, 0);
    const monthExpense = monthData.filter(c => c.type === 'expense').reduce((s, c) => s + c.amount, 0);
    const monthProfit = monthIncome - monthExpense;
    
    // 카테고리별 집계
    let categoryStats = {};
    monthData.forEach(c => {
        const key = c.type + '-' + c.category;
        categoryStats[key] = (categoryStats[key] || 0) + c.amount;
    });
    
    let incomeBars = '', expenseBars = '';
    Object.entries(categoryStats).forEach(([key, amount]) => {
        const [type, cat] = key.split('-');
        const total = type === 'income' ? monthIncome : monthExpense;
        const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
        const bar = `<div class="flex items-center gap-3 mb-2">
            <span class="w-16 text-xs text-gray-400">${cat}</span>
            <div class="flex-1 h-3 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full ${type === 'income' ? 'bg-emerald-400' : 'bg-red-400'}" style="width:${pct}%"></div>
            </div>
            <span class="text-xs ${type === 'income' ? 'text-emerald-400' : 'text-red-400'} w-20 text-right">${fmt(amount)}</span>
        </div>`;
        if (type === 'income') incomeBars += bar;
        else expenseBars += bar;
    });
    
    document.getElementById('bro-month-summary-content').innerHTML = `
        <div class="text-center text-lg font-bold text-lime-400 mb-4">${monthName}</div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">수입</div>
                <div class="text-xl font-black text-emerald-400">${fmt(monthIncome)}</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">지출</div>
                <div class="text-xl font-black text-red-400">${fmt(monthExpense)}</div>
            </div>
            <div class="p-4 rounded-xl ${monthProfit >= 0 ? 'bg-blue-400/10 border-blue-400/30' : 'bg-orange-400/10 border-orange-400/30'} text-center">
                <div class="text-xs ${monthProfit >= 0 ? 'text-blue-400' : 'text-orange-400'} mb-1">순이익</div>
                <div class="text-xl font-black ${monthProfit >= 0 ? 'text-blue-400' : 'text-orange-400'}">${fmt(monthProfit)}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-emerald-400 mb-3">📈 수입 내역</div>
            ${incomeBars || '<div class="text-gray-500 text-sm text-center py-2">데이터 없음</div>'}
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-red-400 mb-3">📉 지출 내역</div>
            ${expenseBars || '<div class="text-gray-500 text-sm text-center py-2">데이터 없음</div>'}
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broMonthSummaryModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('broMonthSummaryModal'); showBromotorsTab('cashbook');" class="btn-primary flex-1">금전출납부 이동</button>
        </div>
    `;
    
    openModal('broMonthSummaryModal');
}

// 금전출납 필터 (대시보드에서 호출)
function filterBroCashbook(type) {
    showBromotorsTab('cashbook');
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    if (type === 'today') {
        document.getElementById('b-cb-date').value = today;
        document.getElementById('b-cb-type').value = '';
    } else if (type === 'month-income') {
        document.getElementById('b-cb-date').value = thisMonthStart;
        document.getElementById('b-cb-type').value = 'income';
    } else if (type === 'month-expense') {
        document.getElementById('b-cb-date').value = thisMonthStart;
        document.getElementById('b-cb-type').value = 'expense';
    }
    loadBroCashbook();
}

// ======================= 브로모터스: 카드결제 =======================
let broPaymentHistory = [];

function togglePayerType(type) {
    if (type === 'business') {
        document.getElementById('business-info').classList.remove('hidden');
    } else {
        document.getElementById('business-info').classList.add('hidden');
    }
}

function openBroCardPayModal(workId = null) {
    // 작업 옵션 업데이트
    let opts = '<option value="">작업 선택 안함</option>';
    broWorkList.filter(w => w.status !== 'complete').forEach(w => {
        opts += `<option value="${w.id}" ${workId === w.id ? 'selected' : ''}>#${String(w.id).padStart(3, '0')} ${w.customer} - ${w.work} (${fmt(w.total)})</option>`;
    });
    document.getElementById('bro-pay-work').innerHTML = opts;
    
    // 작업 선택시 자동 입력
    if (workId) {
        const work = broWorkList.find(w => w.id === workId);
        if (work) {
            document.getElementById('bro-pay-customer').value = work.customer;
            document.getElementById('bro-pay-amount').value = work.total;
            // 고객 정보 찾기
            const cust = broCustList.find(c => c.name === work.customer);
            if (cust) {
                document.getElementById('bro-pay-phone').value = cust.phone;
            }
        }
    }
    
    openModal('broCardPayModal');
}

// 작업 선택시 자동 입력
document.addEventListener('DOMContentLoaded', () => {
    const workSelect = document.getElementById('bro-pay-work');
    if (workSelect) {
        workSelect.addEventListener('change', function() {
            const workId = parseInt(this.value);
            if (workId) {
                const work = broWorkList.find(w => w.id === workId);
                if (work) {
                    document.getElementById('bro-pay-customer').value = work.customer;
                    document.getElementById('bro-pay-amount').value = work.total;
                    const cust = broCustList.find(c => c.name === work.customer);
                    if (cust) {
                        document.getElementById('bro-pay-phone').value = cust.phone;
                    }
                }
            }
        });
    }
});

function processBroCardPayment(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    // 결제 처리 (실제로는 PG사 연동 필요)
    const paymentId = 'PAY' + Date.now();
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const time = koreaTime.toTimeString().slice(0, 5);
    
    const payment = {
        id: paymentId,
        date: today,
        time: time,
        payer_type: d.payer_type,
        customer_name: d.customer_name,
        phone: d.phone,
        card_no: '****-****-****-' + d.card_no.slice(-4),
        amount: parseInt(d.amount) || 0,
        installment: parseInt(d.installment) || 0,
        work_id: d.work_id ? parseInt(d.work_id) : null,
        memo: d.memo || '',
        status: 'success',
        biz_info: d.payer_type === 'business' ? {
            biz_no: d.biz_no,
            biz_name: d.biz_name,
            biz_ceo: d.biz_ceo
        } : null
    };
    
    broPaymentHistory.unshift(payment);
    
    // 금전출납부에 수입 추가
    broCashbookList.unshift({
        id: Math.max(...broCashbookList.map(c => c.id), 0) + 1,
        date: today,
        type: 'income',
        category: '카드결제',
        description: `${d.customer_name} ${d.memo || '카드결제'}`,
        amount: payment.amount
    });
    
    // 작업 상태 업데이트
    if (payment.work_id) {
        const work = broWorkList.find(w => w.id === payment.work_id);
        if (work) {
            work.status = 'complete';
            work.payment_id = paymentId;
        }
    }
    
    // 결제 완료 모달 표시
    const installText = payment.installment > 0 ? `${payment.installment}개월` : '일시불';
    const payerText = payment.payer_type === 'business' ? '사업자/법인' : '개인';
    
    document.getElementById('bro-pay-complete-info').innerHTML = `
        <p class="text-lg">${payment.customer_name}님</p>
        <p class="text-2xl font-black text-emerald-400">${fmt(payment.amount)}</p>
    `;
    
    document.getElementById('bro-pay-receipt').innerHTML = `
        <div class="text-center text-xs text-gray-500 mb-3">[ 결제 영수증 ]</div>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">결제번호</span><span>${paymentId}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">결제일시</span><span>${today} ${time}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">결제자</span><span>${payment.customer_name} (${payerText})</span></div>
            ${payment.biz_info ? `<div class="flex justify-between"><span class="text-gray-400">사업자번호</span><span>${payment.biz_info.biz_no}</span></div>` : ''}
            ${payment.biz_info ? `<div class="flex justify-between"><span class="text-gray-400">상호명</span><span>${payment.biz_info.biz_name}</span></div>` : ''}
            <div class="flex justify-between"><span class="text-gray-400">카드번호</span><span>${payment.card_no}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">할부</span><span>${installText}</span></div>
            <div class="flex justify-between border-t border-white/10 pt-2 mt-2"><span class="text-gray-400">결제금액</span><span class="text-emerald-400 font-bold">${fmt(payment.amount)}</span></div>
        </div>
    `;
    
    closeModal('broCardPayModal');
    e.target.reset();
    document.getElementById('business-info').classList.add('hidden');
    openModal('broPayCompleteModal');
    
    loadBroWork();
    loadBroCashbook();
    loadBroDashboard();
}

function printBroReceipt() {
    const receiptContent = document.getElementById('bro-pay-receipt').innerHTML;
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>영수증</title>
            <style>
                body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background: #fff; color: #000; }
                .receipt { max-width: 300px; margin: 0 auto; }
                .title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
                .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                .label { color: #666; }
                .total { font-weight: bold; color: #10B981; }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="title">🏍️ 브로모터스</div>
                ${receiptContent.replace(/text-gray-400/g, 'label').replace(/text-emerald-400/g, 'total').replace(/bg-white\/10/g, '').replace(/border-white\/10/g, '')}
                <div style="text-align:center; margin-top:20px; color:#666; font-size:12px;">
                    감사합니다. 안전운행하세요!
                </div>
            </div>
            <scr` + `ipt>window.print(); window.close();</scr` + `ipt>
        </body>
        </html>
    `);
}

// 작업 테이블에 결제 버튼 추가를 위한 loadBroWork 수정 필요

// ======================= 정산관리: 자동결제(PG) =======================
const payTypeLabel = t => ({ daily: '일일결제', weekly: '주일결제', monthly: '월결제', custom: '날짜지정' }[t] || '');
const weekdayLabel = d => ['', '월', '화', '수', '목', '금', '토', '일'][d] || '';

function filterPgPayments(status) {
    document.getElementById('pg-status').value = status;
    loadPgPayments();
}

function loadPgPayments() {
    const statusFilter = document.getElementById('pg-status').value;
    const contractFilter = document.getElementById('pg-contract-filter').value;
    const search = document.getElementById('pg-search').value.toLowerCase();
    
    let list = pgPaymentsList;
    if (statusFilter === 'active' || statusFilter === 'inactive') {
        list = list.filter(p => p.card_status === statusFilter);
    } else if (statusFilter) {
        list = list.filter(p => p.last_status === statusFilter);
    }
    if (contractFilter) list = list.filter(p => p.contract_id === parseInt(contractFilter));
    if (search) list = list.filter(p => p.customer_name.toLowerCase().includes(search));
    
    // 요약
    document.getElementById('pg-cards').textContent = pgPaymentsList.length + '건';
    document.getElementById('pg-active').textContent = pgPaymentsList.filter(p => p.card_status === 'active').length + '건';
    document.getElementById('pg-scheduled').textContent = pgPaymentsList.filter(p => p.last_status === 'scheduled').length + '건';
    document.getElementById('pg-completed').textContent = pgPaymentsList.filter(p => p.last_status === 'success').length + '건';
    document.getElementById('pg-failed').textContent = pgPaymentsList.filter(p => p.last_status === 'failed').length + '건';
    
    // 계약 select 업데이트
    let opts = '<option value="">계약 선택</option>';
    let filterOpts = '<option value="">전체 계약</option>';
    contractList.forEach(c => {
        const contractNo = '#' + String(c.id).padStart(3, '0');
        opts += `<option value="${c.id}">${contractNo} ${c.customer_name} - ${c.vehicle}</option>`;
        filterOpts += `<option value="${c.id}">${contractNo} ${c.customer_name}</option>`;
    });
    document.getElementById('pg-contract').innerHTML = opts;
    document.getElementById('pg-contract-filter').innerHTML = filterOpts;
    
    // 테이블
    let h = '';
    list.forEach(p => {
        const contract = contractList.find(c => c.id === p.contract_id);
        const contractNo = '#' + String(p.contract_id).padStart(3, '0');
        const vehicle = contract ? contract.vehicle : '-';
        const contractType = contract ? (contract.type === 'lease' ? '리스' : '렌트') : '-';
        
        const cardStatusBadge = p.card_status === 'active' ? ['badge-active', '활성'] : ['badge-failed', '비활성'];
        
        let cycleText = '';
        if (p.pay_type === 'daily') cycleText = `매일 ${p.pay_hour || 9}시`;
        else if (p.pay_type === 'weekly') cycleText = `매주 ${weekdayLabel(p.pay_weekday)}요일`;
        else if (p.pay_type === 'monthly') cycleText = `매월 ${p.pay_day}일`;
        else if (p.pay_type === 'custom') cycleText = p.pay_date || '날짜지정';
        
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewPgDetail(${p.id})">
            <td class="text-lime-400 font-bold">${contractNo}</td>
            <td class="font-bold">${p.customer_name}</td>
            <td class="text-gray-400">${vehicle} <span class="text-xs text-blue-400">(${contractType})</span></td>
            <td class="text-gray-400">${p.card_no}</td>
            <td class="text-blue-400 font-bold">${fmt(p.amount)}</td>
            <td><span class="text-xs px-2 py-1 rounded bg-white/10">${cycleText}</span></td>
            <td class="text-gray-400">${p.last_pay}</td>
            <td><span class="badge ${cardStatusBadge[0]}">${cardStatusBadge[1]}</span></td>
            <td><button onclick="event.stopPropagation(); openManualPayModal(${p.id})" class="text-lime-400 text-xs hover:underline">결제</button></td>
        </tr>`;
    });
    document.getElementById('pg-tbody').innerHTML = h || '<tr><td colspan="9" class="text-center text-gray-500 py-6">등록된 카드 없음</td></tr>';
}

function togglePayOption(type) {
    document.getElementById('pg-option-daily').classList.add('hidden');
    document.getElementById('pg-option-weekly').classList.add('hidden');
    document.getElementById('pg-option-monthly').classList.add('hidden');
    document.getElementById('pg-option-custom').classList.add('hidden');
    document.getElementById('pg-option-' + type).classList.remove('hidden');
}

function openPgCardModal() {
    document.getElementById('pgForm').reset();
    document.getElementById('pg-edit-id').value = '';
    document.getElementById('pgModalTitle').textContent = '💳 자동결제 카드 등록';
    document.getElementById('pgSubmitBtn').textContent = '등록';
    
    // 계약 옵션 업데이트
    let opts = '<option value="">계약 선택</option>';
    contractList.forEach(c => {
        const contractNo = '#' + String(c.id).padStart(3, '0');
        const contractType = c.type === 'lease' ? '리스' : '렌트';
        opts += `<option value="${c.id}" data-monthly="${c.monthly}" data-customer="${c.customer_name}" data-phone="${c.phone}">${contractNo} ${c.customer_name} - ${c.vehicle} (${contractType})</option>`;
    });
    document.getElementById('pg-contract').innerHTML = opts;
    document.querySelectorAll('input[name="pay_type"]')[2].checked = true;
    togglePayOption('monthly');
    openModal('pgModal');
}

// 계약 선택 시 금액 및 카드 소유자 정보 자동 입력
function onPgContractChange(select) {
    const option = select.options[select.selectedIndex];
    const monthly = option.getAttribute('data-monthly');
    const customerName = option.getAttribute('data-customer');
    const phone = option.getAttribute('data-phone');
    
    if (monthly) {
        document.getElementById('pg-amount').value = monthly;
    }
    if (customerName) {
        document.getElementById('pg-card-holder').value = customerName;
    }
    if (phone) {
        document.getElementById('pg-card-phone').value = phone;
    }
}

function submitPgCard(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const contract = contractList.find(c => c.id === parseInt(d.contract_id));
    
    const newPg = {
        id: Math.max(...pgPaymentsList.map(p => p.id), 0) + 1,
        contract_id: parseInt(d.contract_id),
        customer_name: contract ? contract.customer_name : '',
        // 카드 소유자 정보
        card_holder: d.card_holder || '',
        birth_date: d.birth_date || '',
        card_phone: d.card_phone || '',
        card_email: d.card_email || '',
        // 카드 정보 (마스킹)
        card_no: '****-****-****-' + d.card_no.slice(-4),
        expiry: d.expiry || '',
        card_company: d.card_company || '',
        // 결제 설정
        pay_type: d.pay_type,
        amount: parseInt(d.amount) || 0,
        last_pay: '-',
        last_status: 'scheduled',
        card_status: d.card_status || 'active',
        created_at: new Date().toISOString().split('T')[0]
    };
    
    if (d.pay_type === 'daily') newPg.pay_hour = parseInt(d.pay_hour) || 9;
    else if (d.pay_type === 'weekly') newPg.pay_weekday = parseInt(d.pay_weekday) || 1;
    else if (d.pay_type === 'monthly') newPg.pay_day = parseInt(d.pay_day) || 1;
    else if (d.pay_type === 'custom') newPg.pay_date = d.pay_date || '';
    
    pgPaymentsList.push(newPg);
    
    showToast('✅ 카드가 등록되었습니다');
    closeModal('pgModal');
    e.target.reset();
    loadPgPayments();
}

// PG 카드 상세보기
function viewPgDetail(id) {
    const p = pgPaymentsList.find(x => x.id === id);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    const contractNo = '#' + String(p.contract_id).padStart(3, '0');
    const contractType = contract ? (contract.type === 'lease' ? '리스' : '렌트') : '-';
    const cardStatusBadge = p.card_status === 'active' ? ['badge-active', '활성'] : ['badge-failed', '비활성'];
    
    let cycleText = '';
    if (p.pay_type === 'daily') cycleText = `매일 ${p.pay_hour || 9}시`;
    else if (p.pay_type === 'weekly') cycleText = `매주 ${weekdayLabel(p.pay_weekday)}요일`;
    else if (p.pay_type === 'monthly') cycleText = `매월 ${p.pay_day}일`;
    else if (p.pay_type === 'custom') cycleText = p.pay_date;
    
    // 결제 이력
    const history = paymentHistory.filter(h => h.pg_id === p.id).slice(0, 5);
    let historyRows = '';
    history.forEach(h => {
        const statusBadge = h.status === 'success' ? ['badge-success', '성공'] : ['badge-failed', '실패'];
        historyRows += `<tr>
            <td class="text-gray-400">${h.date}</td>
            <td class="text-blue-400">${fmt(h.amount)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td class="text-gray-500 text-xs">${h.fail_reason || '-'}</td>
        </tr>`;
    });
    
    document.getElementById('pg-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 mb-3">📋 계약 정보</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">계약번호</span><span class="text-lime-400 font-bold">${contractNo}</span></div>
                <div class="info-row"><span class="info-label">계약유형</span><span class="text-blue-400">${contractType}</span></div>
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">차량</span><span>${contract ? contract.vehicle : '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20 mb-4">
            <div class="text-xs text-blue-400 mb-3">👤 카드 소유자 정보</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">소유자명</span><span class="font-bold">${p.card_holder || p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">생년월일</span><span>${p.birth_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${p.card_phone || '-'}</span></div>
                <div class="info-row"><span class="info-label">이메일</span><span>${p.card_email || '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-emerald-400/5 border border-emerald-400/20 mb-4">
            <div class="text-xs text-emerald-400 mb-3">💳 카드 정보</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">카드번호</span><span class="font-mono">${p.card_no}</span></div>
                <div class="info-row"><span class="info-label">유효기간</span><span>${p.expiry || '-'}</span></div>
                <div class="info-row"><span class="info-label">카드사</span><span>${p.card_company || '-'}</span></div>
                <div class="info-row"><span class="info-label">카드상태</span><span class="badge ${cardStatusBadge[0]}">${cardStatusBadge[1]}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-gray-400 mb-3">⏰ 결제 설정</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">결제금액</span><span class="text-blue-400 font-bold">${fmt(p.amount)}</span></div>
                <div class="info-row"><span class="info-label">결제주기</span><span>${cycleText}</span></div>
                <div class="info-row"><span class="info-label">최근결제</span><span>${p.last_pay}</span></div>
                <div class="info-row"><span class="info-label">등록일</span><span>${p.created_at}</span></div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">📋 최근 결제 이력</div>
            <table class="data-table">
                <thead><tr><th>일자</th><th>금액</th><th>결과</th><th>사유</th></tr></thead>
                <tbody>${historyRows || '<tr><td colspan="4" class="text-center text-gray-500 py-3">결제 이력 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="toggleCardStatus(${p.id})" class="btn-secondary flex-1">${p.card_status === 'active' ? '🔒 비활성화' : '🔓 활성화'}</button>
            <button onclick="deletePgCard(${p.id})" class="btn-danger flex-1">🗑️ 삭제</button>
            <button onclick="closeModal('pgDetailModal'); openManualPayModal(${p.id});" class="btn-primary flex-1">💳 결제</button>
        </div>
    `;
    
    openModal('pgDetailModal');
}

// 수동 결제 모달
function openManualPayModal(pgId) {
    const p = pgPaymentsList.find(x => x.id === pgId);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    const contractNo = '#' + String(p.contract_id).padStart(3, '0');
    
    document.getElementById('manual-pay-pg-id').value = pgId;
    document.getElementById('manual-pay-amount').value = p.amount;
    document.getElementById('manual-pay-date').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('manual-pay-info').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">계약번호</span><span class="text-lime-400 font-bold">${contractNo}</span></div>
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">카드번호</span><span>${p.card_no}</span></div>
                <div class="info-row"><span class="info-label">미납금</span><span class="text-orange-400">${contract ? fmt(contract.arrears) : '-'}</span></div>
            </div>
        </div>
    `;
    
    openModal('manualPayModal');
}

// 수동 결제 실행
function executeManualPayment(e) {
    e.preventDefault();
    const pgId = parseInt(document.getElementById('manual-pay-pg-id').value);
    const amount = parseInt(document.getElementById('manual-pay-amount').value) || 0;
    const date = document.getElementById('manual-pay-date').value;
    const memo = e.target.memo ? e.target.memo.value : '';
    
    const p = pgPaymentsList.find(x => x.id === pgId);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    
    // 결제 처리
    p.last_pay = date;
    p.last_status = 'success';
    
    // 결제 이력 추가
    paymentHistory.unshift({
        id: Math.max(...paymentHistory.map(h => h.id), 0) + 1,
        pg_id: pgId,
        contract_id: p.contract_id,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5),
        status: 'success',
        method: 'PG'
    });
    
    // 원장에 수납 기록
    ledgerList.unshift({
        id: Math.max(...ledgerList.map(l => l.id), 0) + 1,
        date: date,
        contract_id: p.contract_id,
        customer_name: p.customer_name,
        type: 'receipt',
        desc: `카드결제${memo ? ' - ' + memo : ''}`,
        accrual: 0,
        receipt: amount,
        method: 'PG'
    });
    
    // 계약 미납금 차감
    if (contract) {
        contract.arrears = Math.max(0, contract.arrears - amount);
        if (contract.arrears === 0) {
            contract.status = 'active';
            contract.delinquent_days = 0;
        }
    }
    
    // 최근결제 내역에 추가
    recentPayments.unshift({
        id: Math.max(...recentPayments.map(r => r.id), 0) + 1,
        customer_name: p.customer_name,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5)
    });
    
    showToast(`✅ ${p.customer_name}님 ${fmt(amount)} 결제 완료`);
    closeModal('manualPayModal');
    loadPgPayments();
    loadOverview();
}

// 카드 상태 토글
function toggleCardStatus(id) {
    const p = pgPaymentsList.find(x => x.id === id);
    if (p) {
        p.card_status = p.card_status === 'active' ? 'inactive' : 'active';
        showToast(`✅ 카드가 ${p.card_status === 'active' ? '활성화' : '비활성화'}되었습니다`);
        closeModal('pgDetailModal');
        loadPgPayments();
    }
}

// 카드 삭제
function deletePgCard(id) {
    if (!confirm('정말 이 카드를 삭제하시겠습니까?')) return;
    pgPaymentsList = pgPaymentsList.filter(p => p.id !== id);
    showToast('✅ 카드가 삭제되었습니다');
    closeModal('pgDetailModal');
    loadPgPayments();
}

// ======================= 정산관리: 원장 =======================
function filterLedger(type) {
    if (type === 'arrears') {
        // 미수금만 표시 (잔액이 남아있는 고객)
        document.getElementById('ledger-type').value = '';
    } else {
        document.getElementById('ledger-type').value = type;
    }
    loadLedger();
}

function loadLedger() {
    const typeFilter = document.getElementById('ledger-type').value;
    const contractFilter = document.getElementById('ledger-contract').value;
    const startDate = document.getElementById('ledger-start').value;
    const endDate = document.getElementById('ledger-end').value;
    
    // 한국 시간 기준 날짜 계산
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
    const today = koreaTime.toISOString().split('T')[0];
    
    // 이번달 시작일 (요약 카드용)
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    // 기본값: 최근 7일
    if (!startDate && !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        document.getElementById('ledger-start').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('ledger-end').value = today;
    }
    
    const filterStart = document.getElementById('ledger-start').value;
    const filterEnd = document.getElementById('ledger-end').value;
    
    // 테이블용 필터링
    let list = ledgerList;
    if (typeFilter) list = list.filter(l => l.type === typeFilter);
    if (contractFilter) list = list.filter(l => l.contract_id === parseInt(contractFilter));
    if (filterStart) list = list.filter(l => l.date >= filterStart);
    if (filterEnd) list = list.filter(l => l.date <= filterEnd);
    
    // 이번달 수납 (원장 기준)
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const monthReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    
    // 이번달 예상 수익 (활성 계약 기준)
    const activeContracts = contractList.filter(c => c.status === 'active');
    const expectedMonthly = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    // 수납률 = 실제수납 / 예상수익 (%)
    const monthRate = expectedMonthly > 0 ? Math.round((monthReceipt / expectedMonthly) * 100) : 0;
    
    // 총 미수금 (계약 기준)
    const contractsWithArrears = contractList.filter(c => c.arrears > 0);
    const totalArrears = contractsWithArrears.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('ledger-receipt').textContent = fmt(monthReceipt);
    document.getElementById('ledger-receipt-count').textContent = thisMonthReceipts.length + '건';
    document.getElementById('ledger-arrears').textContent = fmt(totalArrears);
    document.getElementById('ledger-arrears-count').textContent = contractsWithArrears.length + '건';
    document.getElementById('ledger-rate').textContent = monthRate + '%';
    
    // 계약 select 업데이트
    let opts = '<option value="">전체 계약</option>';
    contractList.forEach(c => {
        opts += `<option value="${c.id}">${c.customer_name} - ${c.vehicle}</option>`;
    });
    document.getElementById('ledger-contract').innerHTML = opts;
    if (contractFilter) document.getElementById('ledger-contract').value = contractFilter;
    
    document.getElementById('ledger-date').value = today;
    
    // 테이블 (날짜 내림차순)
    list.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    
    let h = '', balance = 0;
    // 잔액 계산을 위해 전체 데이터로 계산
    ledgerList.forEach(l => {
        balance += l.accrual - l.receipt;
    });
    
    list.forEach(l => {
        const typeBadge = { accrual: ['badge-accrual', '발생'], receipt: ['badge-receipt', '수납'], adjust: ['badge-adjust', '조정'] }[l.type] || ['', ''];
        const methodLabel = l.method ? `<span class="text-xs text-gray-500 ml-1">(${l.method})</span>` : '';
        h += `<tr>
            <td class="text-gray-400">${l.date}</td>
            <td class="font-bold">${l.customer_name}</td>
            <td><span class="badge ${typeBadge[0]}">${typeBadge[1]}</span></td>
            <td>${l.desc}${methodLabel}</td>
            <td class="${l.accrual > 0 ? 'text-orange-400' : 'text-gray-500'}">${l.accrual > 0 ? fmt(l.accrual) : '-'}</td>
            <td class="${l.receipt > 0 ? 'text-emerald-400' : 'text-gray-500'}">${l.receipt > 0 ? fmt(l.receipt) : '-'}</td>
            <td class="font-bold">${fmt(balance)}</td>
        </tr>`;
    });
    document.getElementById('ledger-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">내역 없음</td></tr>';
    
    // 수납 방법별 그래프 업데이트
    updateLedgerChart(thisMonthReceipts, monthReceipt, today.substring(0, 7).replace('-', '년 ') + '월');
}

// 수납 방법별 그래프 업데이트
function updateLedgerChart(receipts, total, monthLabel) {
    document.getElementById('ledger-month-label').textContent = monthLabel;
    document.getElementById('ledger-pie-total').textContent = fmt(total);
    
    // 결제 방법별 집계
    let methodStats = { '카드': 0, '현금': 0, '이체': 0, '기타': 0 };
    receipts.forEach(l => {
        const method = l.method || '기타';
        if (method.includes('카드') || method === 'PG') methodStats['카드'] += l.receipt;
        else if (method.includes('현금')) methodStats['현금'] += l.receipt;
        else if (method.includes('이체') || method.includes('계좌')) methodStats['이체'] += l.receipt;
        else methodStats['기타'] += l.receipt;
    });
    
    const colors = { '카드': '#3B82F6', '현금': '#10B981', '이체': '#F59E0B', '기타': '#9CA3AF' };
    const icons = { '카드': '💳', '현금': '💵', '이체': '🏦', '기타': '📋' };
    
    // 막대 그래프
    let barsHtml = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        if (amount > 0 || method !== '기타') {
            const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
            barsHtml += `<div class="flex items-center gap-3">
                <span class="w-12 text-xs">${icons[method]} ${method}</span>
                <div class="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                    <div class="h-full rounded-full" style="width:${pct}%; background:${colors[method]}"></div>
                </div>
                <span class="text-xs w-20 text-right" style="color:${colors[method]}">${fmt(amount)}</span>
                <span class="text-xs text-gray-500 w-10">${pct}%</span>
            </div>`;
        }
    });
    document.getElementById('ledger-method-bars').innerHTML = barsHtml || '<div class="text-gray-500 text-sm text-center py-4">데이터 없음</div>';
    
    // 원형 그래프 (SVG stroke-dasharray)
    const circumference = 2 * Math.PI * 16; // 약 100.53
    let offset = 0;
    
    const cardPct = total > 0 ? (methodStats['카드'] / total) * 100 : 0;
    const cashPct = total > 0 ? (methodStats['현금'] / total) * 100 : 0;
    const transferPct = total > 0 ? (methodStats['이체'] / total) * 100 : 0;
    
    document.getElementById('ledger-pie-card').style.strokeDasharray = `${cardPct} ${100 - cardPct}`;
    document.getElementById('ledger-pie-card').style.strokeDashoffset = -offset;
    offset += cardPct;
    
    document.getElementById('ledger-pie-cash').style.strokeDasharray = `${cashPct} ${100 - cashPct}`;
    document.getElementById('ledger-pie-cash').style.strokeDashoffset = -offset;
    offset += cashPct;
    
    document.getElementById('ledger-pie-transfer').style.strokeDasharray = `${transferPct} ${100 - transferPct}`;
    document.getElementById('ledger-pie-transfer').style.strokeDashoffset = -offset;
    
    // 범례
    let legendHtml = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        if (amount > 0) {
            const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
            legendHtml += `<div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background:${colors[method]}"></div>
                <span class="text-xs text-gray-400">${method}</span>
                <span class="text-xs font-bold" style="color:${colors[method]}">${pct}%</span>
            </div>`;
        }
    });
    document.getElementById('ledger-method-legend').innerHTML = legendHtml || '<div class="text-xs text-gray-500">데이터 없음</div>';
}

// 이번달 수납 상세 모달
function openMonthlyReceiptModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    const monthName = today.substring(0, 7).replace('-', '년 ') + '월';
    
    // 이번달 수납 내역
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const totalReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    
    // 고객별 수납 집계
    let customerStats = {};
    thisMonthReceipts.forEach(l => {
        if (!customerStats[l.customer_name]) {
            customerStats[l.customer_name] = { name: l.customer_name, amount: 0, count: 0, lastDate: l.date };
        }
        customerStats[l.customer_name].amount += l.receipt;
        customerStats[l.customer_name].count++;
        if (l.date > customerStats[l.customer_name].lastDate) {
            customerStats[l.customer_name].lastDate = l.date;
        }
    });
    
    const customerList = Object.values(customerStats).sort((a, b) => b.amount - a.amount);
    
    // 결제 방법별 집계
    let methodStats = {};
    thisMonthReceipts.forEach(l => {
        const method = l.method || '기타';
        methodStats[method] = (methodStats[method] || 0) + l.receipt;
    });
    
    let tableRows = '';
    customerList.forEach(c => {
        tableRows += `<tr>
            <td class="font-bold">${c.name}</td>
            <td class="text-emerald-400 font-bold">${fmt(c.amount)}</td>
            <td class="text-gray-400">${c.count}건</td>
            <td class="text-gray-400">${c.lastDate}</td>
        </tr>`;
    });
    
    let methodBars = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        const pct = totalReceipt > 0 ? Math.round((amount / totalReceipt) * 100) : 0;
        methodBars += `<div class="flex items-center gap-3 mb-2">
            <span class="w-20 text-xs text-gray-400">${method}</span>
            <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-400" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-emerald-400 w-16 text-right">${fmt(amount)}</span>
        </div>`;
    });
    
    document.getElementById('monthly-receipt-content').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">총 수납금액</div>
                <div class="text-2xl font-black text-emerald-400">${fmt(totalReceipt)}</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">수납 건수</div>
                <div class="text-2xl font-black text-blue-400">${thisMonthReceipts.length}건</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">💳 결제방법별</div>
            ${methodBars || '<div class="text-gray-500 text-sm text-center py-2">데이터 없음</div>'}
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>고객명</th><th>수납금액</th><th>건수</th><th>최근수납</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="4" class="text-center text-gray-500 py-4">수납 내역 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('monthlyReceiptModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('monthlyReceiptModal'); showSettlementTab('ledger'); document.getElementById('ledger-type').value='receipt'; loadLedger();" class="btn-primary flex-1">전체 내역 보기</button>
        </div>
    `;
    
    openModal('monthlyReceiptModal');
}

// 미수금 필터 (원장 테이블에서 미수금 있는 계약만 보기)
function filterLedgerUnpaid() {
    // 미수금 있는 계약 목록
    const unpaidContracts = contractList.filter(c => c.arrears > 0);
    
    if (unpaidContracts.length === 0) {
        showToast('미수금이 있는 계약이 없습니다', 'info');
        return;
    }
    
    let tableRows = '';
    unpaidContracts.sort((a, b) => b.arrears - a.arrears).forEach(c => {
        const customer = customerList.find(cu => cu.name === c.customer_name);
        const phoneClean = c.phone.replace(/-/g, '');
        
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewArrearsDetail(${c.id})">
            <td class="font-bold text-lime-400">#${String(c.id).padStart(3, '0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="text-red-400">${c.delinquent_days || 0}일</td>
            <td>
                <div class="flex gap-2">
                    <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="text-blue-400 text-xs hover:underline">📞</a>
                    <a href="sms:${phoneClean}?body=${encodeURIComponent('[팀브로] ' + c.customer_name + '님, 미납금 ' + fmt(c.arrears) + ' 납부 부탁드립니다.')}" onclick="event.stopPropagation()" class="text-emerald-400 text-xs hover:underline">💬</a>
                </div>
            </td>
        </tr>`;
    });
    
    const totalArrears = unpaidContracts.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('unpaid-list-content').innerHTML = `
        <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 mb-4 text-center">
            <div class="text-xs text-orange-400 mb-1">총 미수금</div>
            <div class="text-2xl font-black text-orange-400">${fmt(totalArrears)}</div>
            <div class="text-xs text-gray-500 mt-1">${unpaidContracts.length}건</div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:350px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>계약번호</th><th>고객명</th><th>차량</th><th>미수금</th><th>연체일</th><th>연락</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('unpaidListModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="closeModal('unpaidListModal'); showSettlementTab('delinquent');" class="btn-primary flex-1">연체관리 이동</button>
        </div>
    `;
    
    openModal('unpaidListModal');
}

// 수납률 상세 모달
function openCollectionRateModal() {
    const totalAccrual = ledgerList.reduce((s, l) => s + l.accrual, 0);
    const totalReceipt = ledgerList.reduce((s, l) => s + l.receipt, 0);
    const arrears = totalAccrual - totalReceipt;
    const rate = totalAccrual > 0 ? Math.round((totalReceipt / totalAccrual) * 100) : 0;
    
    // 계약별 수납률 계산
    let contractStats = [];
    contractList.forEach(c => {
        const cLedger = ledgerList.filter(l => l.contract_id === c.id);
        const cAccrual = cLedger.reduce((s, l) => s + l.accrual, 0);
        const cReceipt = cLedger.reduce((s, l) => s + l.receipt, 0);
        const cRate = cAccrual > 0 ? Math.round((cReceipt / cAccrual) * 100) : 100;
        contractStats.push({
            id: c.id,
            name: c.customer_name,
            vehicle: c.vehicle,
            accrual: cAccrual,
            receipt: cReceipt,
            arrears: cAccrual - cReceipt,
            rate: cRate
        });
    });
    
    // 수납률 낮은 순 정렬
    contractStats.sort((a, b) => a.rate - b.rate);
    
    let tableRows = '';
    contractStats.forEach(s => {
        const rateColor = s.rate >= 100 ? 'text-emerald-400' : s.rate >= 80 ? 'text-blue-400' : s.rate >= 50 ? 'text-yellow-400' : 'text-red-400';
        const barWidth = Math.min(s.rate, 100);
        tableRows += `<tr>
            <td class="font-bold">${s.name}</td>
            <td class="text-gray-400">${s.vehicle}</td>
            <td class="text-orange-400">${fmt(s.accrual)}</td>
            <td class="text-emerald-400">${fmt(s.receipt)}</td>
            <td class="${s.arrears > 0 ? 'text-red-400' : 'text-gray-500'}">${s.arrears > 0 ? fmt(s.arrears) : '-'}</td>
            <td>
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full ${s.rate >= 100 ? 'bg-emerald-400' : s.rate >= 80 ? 'bg-blue-400' : s.rate >= 50 ? 'bg-yellow-400' : 'bg-red-400'}" style="width:${barWidth}%"></div>
                    </div>
                    <span class="${rateColor} font-bold text-sm">${s.rate}%</span>
                </div>
            </td>
        </tr>`;
    });
    
    document.getElementById('collection-rate-content').innerHTML = `
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 text-center">
                <div class="text-xs text-orange-400 mb-1">총 발생액</div>
                <div class="text-xl font-black text-orange-400">${fmt(totalAccrual)}</div>
            </div>
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">총 수납액</div>
                <div class="text-xl font-black text-emerald-400">${fmt(totalReceipt)}</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">미수금</div>
                <div class="text-xl font-black text-red-400">${fmt(arrears)}</div>
            </div>
            <div class="p-4 rounded-xl bg-purple-400/10 border border-purple-400/30 text-center">
                <div class="text-xs text-purple-400 mb-1">전체 수납률</div>
                <div class="text-xl font-black text-purple-400">${rate}%</div>
            </div>
        </div>
        
        <div class="text-sm text-lime-400 font-bold mb-3">📋 계약별 수납률 (낮은 순)</div>
        <div class="glass-card rounded-xl overflow-hidden mb-4">
            <table class="data-table">
                <thead><tr><th>고객명</th><th>차량</th><th>발생</th><th>수납</th><th>미수금</th><th>수납률</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="6" class="text-center text-gray-500 py-4">데이터 없음</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('collectionRateModal')" class="btn-secondary flex-1">닫기</button>
        </div>
    `;
    
    openModal('collectionRateModal');
}

// 원장 내역 등록 모달
function openLedgerModal() {
    // 한국 시간 기준 오늘
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    document.getElementById('ledger-date').value = koreaTime.toISOString().split('T')[0];
    
    // 계약 옵션 업데이트
    let opts = '<option value="">계약 선택</option>';
    contractList.forEach(c => {
        opts += `<option value="${c.id}">${c.customer_name} - ${c.vehicle}</option>`;
    });
    document.getElementById('ledger-contract-select').innerHTML = opts;
    
    openModal('ledgerModal');
}

// 원장 내역 등록 처리
async function submitLedgerEntry(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const contract = contractList.find(c => c.id === parseInt(d.contract_id));
    
    const isAccrual = d.entry_type === 'accrual';
    const isReceipt = d.entry_type === 'receipt';
    
    const ledgerData = {
        date: d.date,
        contract_id: parseInt(d.contract_id),
        customer_name: contract ? contract.customer_name : '',
        type: d.entry_type,
        description: d.desc || (isAccrual ? '청구' : isReceipt ? '수납' : '조정'),
        accrual: isAccrual ? parseInt(d.amount) || 0 : 0,
        receipt: isReceipt ? parseInt(d.amount) || 0 : 0,
        method: d.method
    };
    
    const result = await insertToDB('ledger', ledgerData);
    if (result && result[0]) {
        ledgerList.unshift({...result[0], desc: result[0].description});
    }
    
    // 계약 미납금 업데이트
    if (contract) {
        if (isAccrual) {
            contract.arrears += parseInt(d.amount) || 0;
        } else if (isReceipt) {
            contract.arrears = Math.max(0, contract.arrears - (parseInt(d.amount) || 0));
        }
        await updateInDB('contracts', contract.id, { arrears: contract.arrears });
    }
    
    showToast('✅ 내역이 등록되었습니다');
    closeModal('ledgerModal');
    e.target.reset();
    loadLedger();
}

// ======================= 정산관리: 연체관리 =======================
function filterDelinquent(period) {
    document.getElementById('del-period').value = period;
    loadDelinquent();
}

function loadDelinquent() {
    const periodFilter = document.getElementById('del-period').value;
    const sortBy = document.getElementById('del-sort').value;
    const search = document.getElementById('del-search').value.toLowerCase();
    
    let list = contractList.filter(c => c.arrears > 0);
    
    if (periodFilter === '30') list = list.filter(c => (c.delinquent_days || 0) < 30);
    else if (periodFilter === '60') list = list.filter(c => (c.delinquent_days || 0) >= 30 && (c.delinquent_days || 0) < 60);
    else if (periodFilter === '90') list = list.filter(c => (c.delinquent_days || 0) >= 60);
    
    if (search) list = list.filter(c => 
        c.customer_name.toLowerCase().includes(search) || 
        c.vehicle.toLowerCase().includes(search) ||
        c.plate.toLowerCase().includes(search)
    );
    
    // 정렬
    if (sortBy === 'amount') list.sort((a, b) => b.arrears - a.arrears);
    else if (sortBy === 'days') list.sort((a, b) => (b.delinquent_days || 0) - (a.delinquent_days || 0));
    else if (sortBy === 'name') list.sort((a, b) => a.customer_name.localeCompare(b.customer_name));
    
    // 요약
    const allDel = contractList.filter(c => c.arrears > 0);
    document.getElementById('del-count').textContent = allDel.length + '건';
    document.getElementById('del-total').textContent = fmt(allDel.reduce((s, c) => s + c.arrears, 0));
    document.getElementById('del-30').textContent = allDel.filter(c => (c.delinquent_days || 0) < 30).length + '건';
    document.getElementById('del-60').textContent = allDel.filter(c => (c.delinquent_days || 0) >= 60).length + '건';
    
    // 테이블
    let h = '';
    list.forEach(c => {
        const days = c.delinquent_days || 0;
        const severity = days >= 60 ? 'text-red-500' : days >= 30 ? 'text-orange-400' : 'text-yellow-400';
        const phoneClean = c.phone.replace(/-/g, '');
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewArrearsDetail(${c.id})">
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="${severity} font-bold">${days}일</td>
            <td class="text-gray-400">-</td>
            <td><span class="badge badge-delinquent">연체</span></td>
            <td>
                <div class="flex gap-2">
                    <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="text-blue-400 text-xs hover:underline">📞</a>
                    <a href="sms:${phoneClean}?body=${encodeURIComponent('[팀브로] ' + c.customer_name + '님, 미납금 ' + fmt(c.arrears) + ' 납부 부탁드립니다.')}" onclick="event.stopPropagation()" class="text-emerald-400 text-xs hover:underline">💬</a>
                    <button onclick="event.stopPropagation(); openDelAction(${c.id})" class="text-lime-400 text-xs hover:underline">관리</button>
                </div>
            </td>
        </tr>`;
    });
    document.getElementById('del-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">연체 계약 없음</td></tr>';
}

function openDelAction(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    // 전화번호에서 하이픈 제거
    const phoneClean = c.phone.replace(/-/g, '');
    
    document.getElementById('del-action-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">고객명</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">연락처</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">연체금액</span><span class="text-orange-400 font-bold">${fmt(c.arrears)}</span></div>
                <div class="info-row"><span class="info-label">연체일수</span><span class="text-red-400 font-bold">${c.delinquent_days || 0}일</span></div>
            </div>
        </div>
        
        <div class="space-y-3 mb-4">
            <a href="tel:${phoneClean}" class="block w-full p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-left hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">📞 전화 걸기</div>
                <div class="text-xs text-gray-400">${c.phone}로 바로 전화 연결</div>
            </a>
            <a href="sms:${phoneClean}?body=${encodeURIComponent('[팀브로] ' + c.customer_name + '님, 미납금 ' + fmt(c.arrears) + ' 납부 부탁드립니다.')}" class="block w-full p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-left hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">💬 문자 보내기</div>
                <div class="text-xs text-gray-400">독촉 문자 바로 발송</div>
            </a>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('delActionModal')" class="btn-secondary flex-1">닫기</button>
            <button onclick="viewArrearsDetail(${c.id}); closeModal('delActionModal');" class="btn-primary flex-1">미수금 상세</button>
        </div>
    `;
    openModal('delActionModal');
}

function exportDelinquent() {
    downloadExcel('delinquent');
}
</script>
</body>
</html>
