<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TEAM BRO - í†µí•© ERP</title>
    
    <!-- PWA ë©”íƒ€íƒœê·¸ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TEAM BRO">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="TEAM BRO í†µí•© ERP - ì •ì‚°ê´€ë¦¬ & ë¸Œë¡œëª¨í„°ìŠ¤">
    
    <!-- ì•± ì•„ì´ì½˜ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='%2339FF14'>TB</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100' rx='20'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='%2339FF14'>TB</text></svg>">
    
    <!-- manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes neonGlow { 0%, 100% { filter: drop-shadow(0 0 10px #39FF14); } 50% { filter: drop-shadow(0 0 20px #39FF14); } }
        .neon-text { color: #FFF; animation: neonGlow 2s ease-in-out infinite; }
        .glass-card { background: rgba(15, 15, 15, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(57, 255, 20, 0.2); }
        .cyber-grid { background-image: linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px); background-size: 50px 50px; }
        body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .hidden { display: none; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: rgba(57, 255, 20, 0.1); padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #39FF14; white-space: nowrap; }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 13px; }
        .data-table tr:hover { background: rgba(57, 255, 20, 0.05); cursor: pointer; }
        .input-field { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(57, 255, 20, 0.3); color: white; padding: 10px 14px; border-radius: 8px; width: 100%; }
        .input-field:focus { outline: none; border-color: #39FF14; box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #39FF14, #32CD32); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(57, 255, 20, 0.5); }
        .btn-secondary { background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); color: #39FF14; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #EF4444; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 10px; }
        .modal-content { background: #0a0a0a; border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 16px; padding: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; }
        .badge-active { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-delinquent { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-completed { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-rent { background: rgba(147, 51, 234, 0.2); color: #9333EA; }
        .badge-lease { background: rgba(236, 72, 153, 0.2); color: #EC4899; }
        .badge-pending { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-failed { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-accrual { background: rgba(57, 255, 20, 0.2); color: #39FF14; }
        .badge-receipt { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-adjust { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-admin { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-manager { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-staff { background: rgba(107, 114, 128, 0.2); color: #9CA3AF; }
        .badge-waiting { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-progress { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-complete { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-paid { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-unpaid { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-low { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-normal { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-vip { background: rgba(234, 179, 8, 0.2); color: #EAB308; }
        .tab-active { color: #39FF14 !important; border-bottom: 2px solid #39FF14; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-label { color: #9CA3AF; font-size: 13px; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(57,255,20,0.3); border-top-color: #39FF14; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(57, 255, 20, 0.3); border-radius: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 200; }
        .toast-success { background: rgba(16, 185, 129, 0.9); }
        .toast-error { background: rgba(239, 68, 68, 0.9); }
        .system-card { transition: all 0.3s; cursor: pointer; }
        .system-card:hover { transform: translateY(-4px); border-color: rgba(57, 255, 20, 0.5); }
        .system-card.selected { border-color: #39FF14; box-shadow: 0 0 20px rgba(57, 255, 20, 0.3); }
        .setting-tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .setting-tab:hover { background: rgba(57, 255, 20, 0.05); }
        .setting-tab.active { border-bottom-color: #39FF14; color: #39FF14; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .data-table { display: block; overflow-x: auto; white-space: nowrap; }
            .data-table th, .data-table td { padding: 8px 6px; font-size: 11px; }
            .modal-content { padding: 12px; border-radius: 12px; }
            .glass-card { padding: 10px !important; }
            .btn-primary, .btn-secondary { padding: 8px 12px; font-size: 12px; }
            .btn-sm { padding: 5px 8px; font-size: 10px; }
            .input-field { padding: 8px 10px; font-size: 14px; }
            .text-2xl { font-size: 1.1rem; }
            .text-xl { font-size: 0.95rem; }
            .text-lg { font-size: 0.85rem; }
            .text-sm { font-size: 0.75rem; }
            .text-xs { font-size: 0.65rem; }
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-5 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .flex-wrap { flex-wrap: wrap; }
            .gap-4 { gap: 6px; }
            .gap-3 { gap: 4px; }
            .gap-2 { gap: 3px; }
            .mb-6 { margin-bottom: 12px; }
            .mb-4 { margin-bottom: 10px; }
            .p-6 { padding: 10px; }
            .p-4 { padding: 8px; }
            .px-4 { padding-left: 8px; padding-right: 8px; }
            .py-3 { padding-top: 6px; padding-bottom: 6px; }
            h1.text-5xl { font-size: 1.8rem; }
            .neon-text { font-size: 1.5rem; }
            
            /* í—¤ë” ìµœì í™” */
            header .flex { flex-wrap: wrap; gap: 6px; }
            header .glass-card { padding: 6px 10px !important; min-width: auto; }
            header .text-2xl { font-size: 0.9rem; }
            header .text-sm { font-size: 0.65rem; }
            
            /* íƒ­ ë²„íŠ¼ ìŠ¤í¬ë¡¤ */
            .tab-scroll { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding-bottom: 4px; }
            .tab-scroll::-webkit-scrollbar { display: none; }
            .tab-scroll button { flex-shrink: 0; padding: 6px 10px !important; font-size: 10px !important; }
            
            /* ìƒë‹¨ íƒ­ ë°” */
            .flex.overflow-x-auto button { padding: 6px 8px; font-size: 9px; }
            
            /* í†µê³„ ì¹´ë“œ */
            .stat-card .text-2xl, .glass-card .text-2xl { font-size: 1rem; }
            .stat-card .text-xl, .glass-card .text-xl { font-size: 0.9rem; }
            .stat-card .text-xs, .glass-card .text-xs { font-size: 0.6rem; }
            
            /* í•„í„° ì˜ì—­ */
            .filter-row { flex-direction: column; align-items: stretch !important; }
            .filter-row > div { width: 100% !important; }
            .filter-row input, .filter-row select { width: 100% !important; margin-bottom: 6px; }
            
            /* ê¸°ê°„ í•„í„° ë²„íŠ¼ */
            .period-btns { display: flex; flex-wrap: wrap; gap: 4px; }
            .period-btns button { padding: 5px 8px; font-size: 10px; flex: 1; min-width: 45px; }
            
            /* ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ­ */
            #contract-tab-rent, #contract-tab-lease { padding: 6px 12px !important; font-size: 11px !important; }
            
            /* ì¹´ë“œ ë‚´ë¶€ ì•„ì´ì½˜ */
            .glass-card .text-2xl.mb-1 { font-size: 1.2rem; margin-bottom: 2px; }
        }
        
        @media (max-width: 480px) {
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .data-table th, .data-table td { padding: 5px 3px; font-size: 9px; }
            .badge { padding: 2px 5px; font-size: 8px; }
            h1.text-5xl { font-size: 1.3rem; }
            .neon-text { font-size: 1.2rem; }
            
            /* í—¤ë” ë” ì••ì¶• */
            header { padding: 8px !important; }
            header .glass-card { padding: 4px 8px !important; }
            header .text-2xl { font-size: 0.75rem; }
            
            /* ë©”ì¸ ì»¨í…ì¸  */
            main { padding: 8px !important; }
            
            /* ë²„íŠ¼ í¬ê¸° */
            .btn-primary, .btn-secondary { padding: 6px 10px; font-size: 11px; }
            .btn-sm { padding: 4px 6px; font-size: 9px; }
            
            /* í†µê³„ ì¹´ë“œ ì••ì¶• */
            .glass-card { padding: 8px !important; }
            .glass-card .text-xl { font-size: 0.85rem; }
            .glass-card .text-2xl { font-size: 0.95rem; }
            
            /* ì•„ì´ì½˜ í¬ê¸° */
            .glass-card .text-2xl.mb-1 { font-size: 1rem; }
            
            /* íƒ­ ë” ìž‘ê²Œ */
            .flex.overflow-x-auto button { padding: 5px 6px; font-size: 8px; }
            
            /* ìž…ë ¥ í•„ë“œ */
            .input-field { padding: 6px 8px; font-size: 13px; }
        }
        
        @media (max-width: 380px) {
            .grid-cols-2 { grid-template-columns: 1fr; }
            header .flex { justify-content: center; }
            .glass-card .text-xl { font-size: 0.8rem; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="cyber-grid fixed inset-0 pointer-events-none"></div>
    <div id="toast-container"></div>

    <!-- ======================= ë¡œê·¸ì¸ íŽ˜ì´ì§€ ======================= -->
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <div class="text-center">
            <h1 class="text-4xl font-black neon-text mb-4">TEAM BRO</h1>
            <div class="flex items-center justify-center gap-2">
                <div class="w-2 h-2 bg-lime-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-lime-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-lime-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
            <p class="text-gray-500 text-xs mt-4">ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <div id="loginPage" class="hidden relative z-10 min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-lg">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-black neon-text mb-3">TEAM BRO</h1>
                <p class="text-lime-400/70 text-sm">í†µí•© ERP ì‹œìŠ¤í…œ</p>
                <p class="text-gray-500 text-xs mt-1">v1.29</p>
            </div>
            <div class="glass-card rounded-2xl p-8">
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-2">ì•„ì´ë””</label>
                        <input type="text" id="username" class="input-field" placeholder="ì•„ì´ë”” ìž…ë ¥" required />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ ìž…ë ¥" required />
                    </div>
                    
                    <!-- ì‹œìŠ¤í…œ ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-3">ì‹œìŠ¤í…œ ì„ íƒ <span class="text-red-400">*</span></label>
                        <div class="grid grid-cols-2 gap-4">
                            <div id="card-settlement" class="system-card glass-card rounded-xl p-4 text-center" onclick="selectSystem('settlement')">
                                <div class="text-3xl mb-2">ðŸ’°</div>
                                <div class="font-bold">ì •ì‚°ê´€ë¦¬</div>
                                <div class="text-xs text-gray-400 mt-1">ë ŒíŠ¸Â·ë¦¬ìŠ¤ ì •ì‚°</div>
                            </div>
                            <div id="card-bromotors" class="system-card glass-card rounded-xl p-4 text-center" onclick="selectSystem('bromotors')">
                                <div class="text-3xl mb-2">ðŸ”§</div>
                                <div class="font-bold">ë¸Œë¡œëª¨í„°ìŠ¤</div>
                                <div class="text-xs text-gray-400 mt-1">ì§ì˜ìˆ˜ë¦¬ì </div>
                            </div>
                        </div>
                        <div id="systemError" class="hidden mt-2 text-xs text-red-400 text-center">âš ï¸ ì‹œìŠ¤í…œì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                    </div>
                    
                    <div id="loginError" class="hidden p-3 rounded-lg bg-red-400/10 text-red-400 text-sm"></div>
                    <button type="submit" class="w-full btn-primary text-lg py-3">âš¡ ë¡œê·¸ì¸</button>
                </form>
                
                <!-- ì•± ì„¤ì¹˜ ë²„íŠ¼ -->
            </div>
            <p class="text-center text-gray-500 text-xs mt-4">ê¿ˆì´ ìžˆëŠ” ê±°ë¶ì´ëŠ” ì§€ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ======================= -->
    <div id="settlementSystem" class="hidden">
        <!-- í—¤ë” -->
        <div class="relative z-10 border-b border-lime-500/30" style="background: linear-gradient(180deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <!-- ëª¨ë°”ì¼: 2ì¤„ / PC: 1ì¤„ -->
                <div class="flex items-center justify-between flex-wrap gap-2">
                    <!-- ë¡œê³  -->
                    <div onclick="showSettlementTab('overview')" class="cursor-pointer flex-shrink-0">
                        <div class="flex items-baseline gap-2">
                            <h1 class="text-xl md:text-2xl font-black neon-text">ì •ì‚°ê´€ë¦¬</h1>
                            <span class="text-[9px] text-gray-500">v1.6.0</span>
                        </div>
                        <p class="text-lime-400/50 text-[10px] italic">TEAM BRO</p>
                    </div>
                    
                    <!-- ì˜¤ë¥¸ìª½ ìš”ì†Œë“¤ -->
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        <!-- ë‚ ì§œ -->
                        <div class="px-2 py-1 md:px-3 md:py-2 rounded-lg bg-white/5 border border-white/10 text-center">
                            <div class="text-[10px] text-lime-400/70">ì˜¤ëŠ˜ ë‚ ì§œ</div>
                            <div class="text-xs md:text-sm font-bold text-lime-400" id="s-today-date"></div>
                        </div>
                        <!-- ë¸Œë¡œëª¨í„°ìŠ¤ ë²„íŠ¼ -->
                        <button onclick="switchSystem()" class="px-2 py-1 md:px-3 md:py-2 rounded-lg bg-lime-500/10 border border-lime-500/30 text-lime-400 text-[10px] md:text-xs font-bold">ðŸ”§ ë¸Œë¡œëª¨í„°ìŠ¤</button>
                        <!-- ì‚¬ìš©ìž ì •ë³´ -->
                        <div class="px-2 py-1 md:px-3 md:py-2 rounded-lg glass-card text-right">
                            <div class="text-[10px] text-lime-400/70" id="s-userRole">ê´€ë¦¬ìž</div>
                            <div class="text-xs md:text-sm font-bold" id="s-userName">Admin</div>
                        </div>
                        <!-- ë¡œê·¸ì•„ì›ƒ -->
                        <button onclick="handleLogout()" class="px-2 py-1 md:px-3 md:py-2 rounded-lg bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] md:text-xs font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="relative z-10 border-b border-lime-500/20 bg-black/50">
            <div class="max-w-7xl mx-auto px-2 md:px-6 flex overflow-x-auto scrollbar-hide">
                <button onclick="showSettlementTab('overview')" id="s-tab-overview" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm tab-active whitespace-nowrap">ðŸ“Š í†µí•©í˜„í™©</button>
                <button onclick="showSettlementTab('contracts')" id="s-tab-contracts" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ“‹ ê³„ì•½ê´€ë¦¬</button>
                <button onclick="showSettlementTab('vehicles')" id="s-tab-vehicles" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸš— ì°¨ëŸ‰ê´€ë¦¬</button>
                <button onclick="showSettlementTab('customers')" id="s-tab-customers" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ‘¥ ê³ ê°ê´€ë¦¬</button>
                <button onclick="showSettlementTab('charges')" id="s-tab-charges" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ’³ ìžë™ê²°ì œ</button>
                <button onclick="showSettlementTab('ledger')" id="s-tab-ledger" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ“– ì›ìž¥</button>
                <button onclick="showSettlementTab('fines')" id="s-tab-fines" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸš¨ ê³¼íƒœë£Œ</button>
                <button onclick="showSettlementTab('delinquent')" id="s-tab-delinquent" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">âš ï¸ ì—°ì²´</button>
                <button onclick="showSettlementTab('settings')" id="s-tab-settings" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">âš™ï¸ ì„¤ì •</button>
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="relative z-10 max-w-7xl mx-auto px-3 md:px-6 py-4 md:py-6">
            <!-- í†µí•©í˜„í™© -->
            <div id="s-content-overview" class="s-tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-lime-400/50" onclick="showSettlementTab('contracts')">
                        <div class="text-3xl mb-2">ðŸ“‹</div>
                        <div class="text-gray-400 text-xs mb-1">ì´ ê³„ì•½</div>
                        <div class="text-2xl font-black text-lime-400" id="s-total">12ê±´</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-emerald-400/50" onclick="openMonthlyReceiptModal()">
                        <div class="text-3xl mb-2">ðŸ’°</div>
                        <div class="text-gray-400 text-xs mb-1">ì´ë²ˆë‹¬ ìˆ˜ë‚©</div>
                        <div class="text-2xl font-black text-emerald-400" id="s-revenue">â‚©6,500,000</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-orange-400/50" onclick="openArrearsModal()">
                        <div class="text-3xl mb-2">âš ï¸</div>
                        <div class="text-gray-400 text-xs mb-1">ë¯¸ë‚© ì´ì•¡</div>
                        <div class="text-2xl font-black text-orange-400" id="s-arrears">â‚©850,000</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-blue-400/50" onclick="showSettlementTab('ledger')">
                        <div class="text-3xl mb-2">ðŸ“…</div>
                        <div class="text-gray-400 text-xs mb-1">ì˜¤ëŠ˜ ë°œìƒ</div>
                        <div class="text-2xl font-black text-blue-400" id="s-today">â‚©217,000</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="font-bold text-orange-400 mb-4">ðŸš¨ ì—°ì²´ ê³„ì•½</h3>
                        <div class="space-y-2" id="s-delinquent-list"></div>
                    </div>
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="font-bold text-emerald-400 mb-4">ðŸ’³ ìµœê·¼ ê²°ì œ</h3>
                        <div class="space-y-2" id="s-recent-payments"></div>
                    </div>
                </div>
            </div>

            <!-- ê³„ì•½ê´€ë¦¬ -->
            <div id="s-content-contracts" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterContracts('')"><div class="text-2xl mb-1">ðŸ“‹</div><div class="text-gray-400 text-xs">ì „ì²´ ê³„ì•½</div><div class="text-xl font-black text-lime-400" id="contract-total">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterContracts('active')"><div class="text-2xl mb-1">âœ…</div><div class="text-gray-400 text-xs">ì§„í–‰ì¤‘</div><div class="text-xl font-black text-blue-400" id="contract-active">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterContracts('delinquent')"><div class="text-2xl mb-1">âš ï¸</div><div class="text-gray-400 text-xs">ì—°ì²´</div><div class="text-xl font-black text-orange-400" id="contract-delinquent">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-emerald-400/50" onclick="openMonthlyRevenueModal()"><div class="text-2xl mb-1">ðŸ’°</div><div class="text-gray-400 text-xs">ì›” ì •ì‚°ê¸ˆì•¡</div><div class="text-xl font-black text-emerald-400" id="contract-revenue">-</div><div class="text-xs text-gray-500 mt-1" id="contract-revenue-count">- ê±´</div></div>
                </div>
                <!-- ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ­ -->
                <div class="flex gap-2 mb-4">
                    <button onclick="switchContractType('')" id="contract-tab-all" class="px-6 py-2 rounded-lg font-bold text-sm bg-lime-500/20 text-lime-400 border border-lime-500/30">ðŸ“‹ ì „ì²´</button>
                    <button onclick="switchContractType('rent')" id="contract-tab-rent" class="px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10">ðŸï¸ ë ŒíŠ¸</button>
                    <button onclick="switchContractType('lease')" id="contract-tab-lease" class="px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10">ðŸ“„ ë¦¬ìŠ¤</button>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="contract-search" class="input-field" style="width:180px" placeholder="ê³ ê°ëª…, ë²ˆí˜¸íŒ ê²€ìƒ‰...">
                        <select id="contract-status" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="active">ì§„í–‰ì¤‘</option>
                            <option value="delinquent">ì—°ì²´</option>
                            <option value="completed">ì¢…ë£Œ</option>
                            <option value="cancelled">í•´ì§€</option>
                        </select>
                        <button onclick="loadContracts()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('contracts')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openContractModal()" class="btn-primary btn-sm">+ ê³„ì•½ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë²ˆí˜¸</th><th>ê³ ê°</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ë²ˆí˜¸íŒ</th><th>ì£¼ê¸°</th><th>ê³„ì•½ê¸°ê°„</th><th>ë‚©ìž…ê¸ˆ</th><th>ë¯¸ë‚©</th><th>ìˆ˜ë‚©</th><th>ìƒíƒœ</th><th>ì„œë¥˜</th></tr></thead>
                        <tbody id="contract-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì°¨ëŸ‰ê´€ë¦¬ -->
            <div id="s-content-vehicles" class="s-tab-content hidden">
                <!-- ì°¨ëŸ‰ ìœ í˜• íƒ­ -->
                <div class="flex gap-2 mb-4">
                    <button onclick="switchVehicleType('all')" id="v-tab-all" class="flex-1 py-3 rounded-xl font-bold text-sm bg-lime-500/20 border-2 border-lime-500 text-lime-400">ðŸ“‹ ì „ì²´ë³´ê¸°</button>
                    <button onclick="switchVehicleType('motorcycle')" id="v-tab-motorcycle" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white/5 border border-white/20 text-gray-400">ðŸï¸ ì´ë¥œì°¨</button>
                    <button onclick="switchVehicleType('car')" id="v-tab-car" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white/5 border border-white/20 text-gray-400">ðŸš— ìžë™ì°¨</button>
                </div>
                
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterVehicles('ìž…ê³ ')"><div class="text-2xl mb-1">ðŸ“¥</div><div class="text-gray-400 text-xs">ìž…ê³ (ëŒ€ê¸°)</div><div class="text-xl font-black text-lime-400" id="v-stock">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterVehicles('ë°˜ë‚©')"><div class="text-2xl mb-1">ðŸ”„</div><div class="text-gray-400 text-xs">ë°˜ë‚©(ì ê²€)</div><div class="text-xl font-black text-yellow-400" id="v-return">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterVehicles('ì •ë¹„')"><div class="text-2xl mb-1">ðŸ”§</div><div class="text-gray-400 text-xs">ì •ë¹„ì¤‘</div><div class="text-xl font-black text-orange-400" id="v-repair">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-gray-400/50" onclick="filterVehicles('íì°¨')"><div class="text-2xl mb-1">ðŸš«</div><div class="text-gray-400 text-xs">íì°¨/ë§¤ê°</div><div class="text-xl font-black text-gray-400" id="v-disposed">-</div></div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="vehicle-search" class="input-field" style="width:180px" placeholder="ë²ˆí˜¸íŒ, ëª¨ë¸ ê²€ìƒ‰..." oninput="loadVehicles()">
                        <select id="vehicle-status" class="input-field" style="width:120px" onchange="loadVehicles()">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="ìž…ê³ ">ìž…ê³ (ëŒ€ê¸°)</option>
                            <option value="ë°˜ë‚©">ë°˜ë‚©(ì ê²€)</option>
                            <option value="ì •ë¹„">ì •ë¹„ì¤‘</option>
                            <option value="íì°¨">íì°¨/ë§¤ê°</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('vehicles')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openVehicleModal()" class="btn-primary btn-sm">+ ì°¨ëŸ‰ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ìœ í˜•</th><th>ë²ˆí˜¸íŒ</th><th>ëª¨ë¸</th><th>ì—°ì‹</th><th>ìƒ‰ìƒ</th><th>ì£¼í–‰ê±°ë¦¬</th><th>ìƒíƒœ</th><th>ì—°ê²°ê³„ì•½</th></tr></thead>
                        <tbody id="vehicle-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³ ê°ê´€ë¦¬ -->
            <div id="s-content-customers" class="s-tab-content hidden">
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterCustomers('')"><div class="text-2xl mb-1">ðŸ‘¥</div><div class="text-gray-400 text-xs">ì „ì²´ ê³ ê°</div><div class="text-xl font-black text-lime-400" id="cust-total">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterCustomers('ìƒ')"><div class="text-2xl mb-1">â­</div><div class="text-gray-400 text-xs">ë“±ê¸‰ ìƒ</div><div class="text-xl font-black text-yellow-400" id="cust-high">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterCustomers('ì¤‘')"><div class="text-2xl mb-1">âœ…</div><div class="text-gray-400 text-xs">ë“±ê¸‰ ì¤‘</div><div class="text-xl font-black text-blue-400" id="cust-mid">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-gray-400/50" onclick="filterCustomers('í•˜')"><div class="text-2xl mb-1">ðŸ“‹</div><div class="text-gray-400 text-xs">ë“±ê¸‰ í•˜</div><div class="text-xl font-black text-gray-400" id="cust-low">-</div></div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="cust-search" class="input-field" style="width:180px" placeholder="ì´ë¦„, ì—°ë½ì²˜ ê²€ìƒ‰...">
                        <select id="cust-grade" class="input-field" style="width:100px">
                            <option value="">ì „ì²´ ë“±ê¸‰</option>
                            <option value="ìƒ">ìƒ</option>
                            <option value="ì¤‘">ì¤‘</option>
                            <option value="í•˜">í•˜</option>
                        </select>
                        <button onclick="loadCustomers()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('customers')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openCustomerModal()" class="btn-primary btn-sm">+ ê³ ê° ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì£¼ì†Œ</th><th>ê±°ëž˜ë“±ê¸‰</th><th>ë©”ëª¨</th><th>ë“±ë¡ì¼</th></tr></thead>
                        <tbody id="cust-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ìžë™ê²°ì œ(PG) -->
            <div id="s-content-charges" class="s-tab-content hidden">
                <!-- 위루트 PG 연동 상태 -->
                <div class="glass-card rounded-xl p-4 mb-4 border border-lime-400/30">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <span class="text-lime-400 font-bold">💳 위루트 파이낸셜</span>
                            <span id="pg-connection-status" class="badge badge-pending">연결 대기</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="runBatchPayment('arrears')" class="btn-secondary btn-sm bg-orange-500/20 border-orange-500/50 text-orange-400 hover:bg-orange-500/30">⚡ 미납자 일괄결제</button>
                            <button onclick="runBatchPayment('daily')" class="btn-secondary btn-sm">🔄 정기결제</button>
                            <button onclick="openBillingHistoryModal()" class="btn-secondary btn-sm">📜 결제내역</button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 cursor-pointer hover:bg-lime-400/5" onclick="filterPgPayments('')">
                        <div class="text-lime-400 text-xs mb-1">ðŸ’³ ë“±ë¡ ì¹´ë“œ</div>
                        <div class="text-2xl font-black text-lime-400" id="pg-cards">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 cursor-pointer hover:bg-blue-400/5" onclick="filterPgPayments('active')">
                        <div class="text-blue-400 text-xs mb-1">âœ… í™œì„± ì¹´ë“œ</div>
                        <div class="text-2xl font-black text-blue-400" id="pg-active">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 cursor-pointer hover:bg-yellow-400/5" onclick="filterPgPayments('scheduled')">
                        <div class="text-yellow-400 text-xs mb-1">ðŸ“… ê²°ì œ ì˜ˆì •</div>
                        <div class="text-2xl font-black text-yellow-400" id="pg-scheduled">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 cursor-pointer hover:bg-emerald-400/5" onclick="filterPgPayments('success')">
                        <div class="text-emerald-400 text-xs mb-1">ðŸ’° ê²°ì œ ì™„ë£Œ</div>
                        <div class="text-2xl font-black text-emerald-400" id="pg-completed">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="filterPgPayments('failed')">
                        <div class="text-red-400 text-xs mb-1">âŒ ê²°ì œ ì‹¤íŒ¨</div>
                        <div class="text-2xl font-black text-red-400" id="pg-failed">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="pg-status" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                            <option value="scheduled">ì˜ˆì •</option>
                            <option value="success">ì„±ê³µ</option>
                            <option value="failed">ì‹¤íŒ¨</option>
                        </select>
                        <select id="pg-contract-filter" class="input-field" style="width:150px">
                            <option value="">ì „ì²´ ê³„ì•½</option>
                        </select>
                        <input type="text" id="pg-search" class="input-field" style="width:150px" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                        <button onclick="loadPgPayments()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('pg')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openPgCardModal()" class="btn-primary btn-sm">+ ì¹´ë“œ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³„ì•½ë²ˆí˜¸</th><th>ê³ ê°ëª…</th><th>ì°¨ëŸ‰</th><th>ì¹´ë“œì •ë³´</th><th>ê²°ì œê¸ˆì•¡</th><th>ê²°ì œì£¼ê¸°</th><th>ìµœê·¼ê²°ì œ</th><th>ì¹´ë“œìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="pg-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì›ìž¥ -->
            <div id="s-content-ledger" class="s-tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 cursor-pointer hover:bg-emerald-400/5" onclick="openMonthlyReceiptModal()">
                        <div class="text-emerald-400 text-xs mb-1">âœ… ì´ë²ˆë‹¬ ìˆ˜ë‚©</div>
                        <div class="text-2xl font-black text-emerald-400" id="ledger-receipt">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="ledger-receipt-count">- ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 cursor-pointer hover:bg-orange-400/5" onclick="filterLedgerUnpaid()">
                        <div class="text-orange-400 text-xs mb-1">âš ï¸ ì´ ë¯¸ìˆ˜ê¸ˆ</div>
                        <div class="text-2xl font-black text-orange-400" id="ledger-arrears">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="ledger-arrears-count">- ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400 cursor-pointer hover:bg-purple-400/5" onclick="openCollectionRateModal()">
                        <div class="text-purple-400 text-xs mb-1">ðŸ“Š ì´ë²ˆë‹¬ ìˆ˜ë‚©ë¥ </div>
                        <div class="text-2xl font-black text-purple-400" id="ledger-rate">-</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                </div>
                
                <!-- ìˆ˜ë‚© ë°©ë²•ë³„ ê·¸ëž˜í”„ -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lime-400">ðŸ’³ ì´ë²ˆë‹¬ ìˆ˜ë‚© í˜„í™©</h3>
                        <span class="text-xs text-gray-500" id="ledger-month-label">-</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- ìˆ˜ë‚© ë°©ë²•ë³„ ë§‰ëŒ€ ê·¸ëž˜í”„ -->
                        <div>
                            <div class="text-xs text-gray-400 mb-3">ê²°ì œ ë°©ë²•ë³„</div>
                            <div class="space-y-3" id="ledger-method-bars"></div>
                        </div>
                        <!-- ìˆ˜ë‚© ë°©ë²•ë³„ ì›í˜• ë¹„ìœ¨ -->
                        <div>
                            <div class="text-xs text-gray-400 mb-3">ë¹„ìœ¨</div>
                            <div class="flex items-center justify-center gap-6">
                                <div class="relative w-32 h-32">
                                    <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                        <circle id="ledger-pie-card" cx="18" cy="18" r="16" fill="none" stroke="#3B82F6" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                        <circle id="ledger-pie-cash" cx="18" cy="18" r="16" fill="none" stroke="#10B981" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                        <circle id="ledger-pie-transfer" cx="18" cy="18" r="16" fill="none" stroke="#F59E0B" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="text-xs text-gray-400">ì´ì•¡</div>
                                            <div class="text-sm font-bold text-emerald-400" id="ledger-pie-total">â‚©0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2" id="ledger-method-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="ledger-type" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="accrual">ë°œìƒ</option>
                            <option value="receipt">ìˆ˜ë‚©</option>
                            <option value="adjust">ì¡°ì •</option>
                        </select>
                        <select id="ledger-contract" class="input-field" style="width:150px">
                            <option value="">ì „ì²´ ê³„ì•½</option>
                        </select>
                        <input type="date" id="ledger-start" class="input-field" style="width:140px">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="ledger-end" class="input-field" style="width:140px">
                        <button onclick="loadLedger()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('ledger')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openLedgerModal()" class="btn-primary btn-sm">+ ë‚´ì—­ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ì¼ìž</th><th>ê³ ê°ëª…</th><th>êµ¬ë¶„</th><th>ë‚´ìš©</th><th>ë°œìƒ</th><th>ìˆ˜ë‚©</th><th>ìž”ì•¡</th></tr></thead>
                        <tbody id="ledger-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³¼íƒœë£Œ -->
            <div id="s-content-fines" class="s-tab-content hidden">
                <!-- ê¸°ê°„ ì„ íƒ -->
                <div class="glass-card rounded-xl p-4 mb-4">
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="flex gap-2">
                            <button onclick="setFinePeriod('1m')" id="fine-period-1m" class="px-3 py-1 rounded-lg text-xs font-bold bg-lime-500/20 border border-lime-500 text-lime-400">1ê°œì›”</button>
                            <button onclick="setFinePeriod('6m')" id="fine-period-6m" class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 border border-white/20 text-gray-400">6ê°œì›”</button>
                            <button onclick="setFinePeriod('1y')" id="fine-period-1y" class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 border border-white/20 text-gray-400">1ë…„</button>
                            <button onclick="setFinePeriod('all')" id="fine-period-all" class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 border border-white/20 text-gray-400">ì „ì²´</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" id="fine-date-start" class="input-field text-xs" onchange="setFinePeriod('custom')">
                            <span class="text-gray-500">~</span>
                            <input type="date" id="fine-date-end" class="input-field text-xs" onchange="setFinePeriod('custom')">
                        </div>
                    </div>
                </div>
                
                <!-- í†µê³„ ì¹´ë“œ (ê¸°ê°„ë³„) -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400">
                        <div class="text-red-400 text-xs mb-1">ðŸš¨ ê¸°ê°„ ë‚´ ê³¼íƒœë£Œ</div>
                        <div class="text-2xl font-black text-red-400" id="fine-period-count">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400">
                        <div class="text-orange-400 text-xs mb-1">ðŸ’¸ ê¸°ê°„ ë‚´ ë¯¸ë‚©</div>
                        <div class="text-2xl font-black text-orange-400" id="fine-period-unpaid">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400">
                        <div class="text-emerald-400 text-xs mb-1">âœ… ê¸°ê°„ ë‚´ ë‚©ë¶€</div>
                        <div class="text-2xl font-black text-emerald-400" id="fine-period-paid">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400">
                        <div class="text-blue-400 text-xs mb-1">ðŸ“Š ê¸°ê°„ ë‚´ ì´ì•¡</div>
                        <div class="text-2xl font-black text-blue-400" id="fine-period-total">â‚©0</div>
                    </div>
                </div>
                
                <!-- ì´ ë¯¸ë‚©ê¸ˆ (ê¸°ê°„ ë¬´ê´€) -->
                <div class="glass-card rounded-xl p-4 mb-4 border-2 border-red-500/50 bg-red-500/5">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-red-400 text-xs mb-1">ðŸ”¥ ì´ ë¯¸ë‚©ê¸ˆ (ì „ì²´ ë¯¸ê²°ì œ)</div>
                            <div class="text-gray-400 text-xs">ê¸°ê°„ê³¼ ê´€ê³„ì—†ì´ ë¯¸ë‚©ëœ ì „ì²´ ê³¼íƒœë£Œ</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black text-red-400" id="fine-total-unpaid">â‚©0</div>
                            <div class="text-xs text-red-400/70" id="fine-total-unpaid-count">0ê±´</div>
                        </div>
                    </div>
                </div>
                
                <!-- ê²€ìƒ‰/í•„í„° -->
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="fine-search" placeholder="ê²€ìƒ‰ (ê³ ê°ëª…, ì°¨ëŸ‰ë²ˆí˜¸)" class="input-field w-48" oninput="loadFines()">
                        <select id="fine-status" class="input-field w-32" onchange="loadFines()">
                            <option value="">ì „ì²´</option>
                            <option value="unpaid">ë¯¸ë‚©</option>
                            <option value="paid">ë‚©ë¶€ì™„ë£Œ</option>
                        </select>
                    </div>
                    <button onclick="openFineModal()" class="btn-primary btn-sm">+ ê³¼íƒœë£Œ ë“±ë¡</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë²ˆí˜¸</th><th>ë‚ ì§œ</th><th>ê³„ì•½</th><th>ê³ ê°</th><th>ì°¨ëŸ‰ë²ˆí˜¸</th><th>ì‚¬ìœ </th><th>ê¸ˆì•¡</th><th>ì˜ìˆ˜ì¦</th><th>ìƒíƒœ</th></tr></thead>
                        <tbody id="fine-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì—°ì²´ -->
            <div id="s-content-delinquent" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="filterDelinquent('')">
                        <div class="text-red-400 text-xs mb-1">ðŸš¨ ì—°ì²´ ê³„ì•½</div>
                        <div class="text-2xl font-black text-red-400" id="del-count">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 cursor-pointer hover:bg-orange-400/5" onclick="filterDelinquent('')">
                        <div class="text-orange-400 text-xs mb-1">ðŸ’¸ ì—°ì²´ ì´ì•¡</div>
                        <div class="text-2xl font-black text-orange-400" id="del-total">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 cursor-pointer hover:bg-yellow-400/5" onclick="filterDelinquent('30')">
                        <div class="text-yellow-400 text-xs mb-1">â° 30ì¼ ë¯¸ë§Œ</div>
                        <div class="text-2xl font-black text-yellow-400" id="del-30">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-600 cursor-pointer hover:bg-red-600/5" onclick="filterDelinquent('90')">
                        <div class="text-red-600 text-xs mb-1">ðŸ”¥ 60ì¼ ì´ìƒ</div>
                        <div class="text-2xl font-black text-red-600" id="del-60">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="del-period" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ê¸°ê°„</option>
                            <option value="30">30ì¼ ë¯¸ë§Œ</option>
                            <option value="60">30~60ì¼</option>
                            <option value="90">60ì¼ ì´ìƒ</option>
                        </select>
                        <select id="del-sort" class="input-field" style="width:100px">
                            <option value="amount">ê¸ˆì•¡ìˆœ</option>
                            <option value="days">ê¸°ê°„ìˆœ</option>
                            <option value="name">ì´ë¦„ìˆœ</option>
                        </select>
                        <input type="text" id="del-search" class="input-field" style="width:150px" placeholder="ê³ ê°ëª…, ì°¨ëŸ‰ ê²€ìƒ‰...">
                        <button onclick="loadDelinquent()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <button onclick="downloadExcel('delinquent')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ì—°ì²´ê¸ˆì•¡</th><th>ì—°ì²´ì¼ìˆ˜</th><th>ìµœê·¼ì—°ë½</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="del-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì„¤ì • -->
            <div id="s-content-settings" class="s-tab-content hidden">
                <div class="flex border-b border-white/10 mb-6">
                    <div class="setting-tab active" onclick="showSettingTab('staff', this)">ðŸ‘¥ ì§ì› ê´€ë¦¬</div>
                    <div class="setting-tab" onclick="showSettingTab('pg', this)">ðŸ’³ PG ì„¤ì •</div>
                    <div class="setting-tab" onclick="showSettingTab('system', this)">ðŸ”§ ì‹œìŠ¤í…œ ì„¤ì •</div>
                </div>
                
                <!-- ì§ì› ê´€ë¦¬ -->
                <div id="setting-staff" class="setting-content">
                    <div class="glass-card rounded-xl p-4 mb-4 flex justify-between items-center">
                        <div><h3 class="font-bold text-lime-400 text-lg">ì§ì› ê´€ë¦¬</h3><p class="text-gray-400 text-sm mt-1">í†µí•© ERP ì‹œìŠ¤í…œ ì§ì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (ì •ì‚°ê´€ë¦¬ + ë¸Œë¡œëª¨í„°ìŠ¤)</p></div>
                        <button onclick="openStaffModal()" class="btn-primary">+ ì§ì› ë“±ë¡</button>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>ë¶€ì„œ</th><th>ê¶Œí•œë“±ê¸‰</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="staff-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PG ì„¤ì • -->
                <div id="setting-pg" class="setting-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- PG ê°€ë§¹ì  ì„¤ì • -->
                        <div class="glass-card rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="font-bold text-lime-400 text-lg">ðŸ’³ PG ê°€ë§¹ì  ì„¤ì •</h3>
                                    <p class="text-gray-400 text-xs mt-1">ê²°ì œ ëŒ€í–‰ì‚¬ ì—°ë™ ì„¤ì •</p>
                                </div>
                                <span class="badge badge-active" id="pg-status-badge">ì—°ë™ì¤‘</span>
                            </div>
                            
                            <form id="pgSettingsForm" class="space-y-4">
                                <div>
                                    <label class="block text-xs text-lime-400 mb-1">PGì‚¬ ì„ íƒ*</label>
                                    <select id="pg-provider" class="input-field" onchange="onPgProviderChange(this.value)">
                                        <option value="nicepay">ë‚˜ì´ìŠ¤íŽ˜ì´ (NicePay)</option>
                                        <option value="inicis">KGì´ë‹ˆì‹œìŠ¤</option>
                                        <option value="toss">í† ìŠ¤íŽ˜ì´ë¨¼ì¸ </option>
                                        <option value="kakao">ì¹´ì¹´ì˜¤íŽ˜ì´</option>
                                        <option value="danal">ë‹¤ë‚ </option>
                                        <option value="settle">ì„¸í‹€ë±…í¬</option>
                                        <option value="kcp">NHN KCP</option>
                                    </select>
                                </div>
                                
                                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                    <div class="text-xs text-blue-400 mb-3">ðŸ”‘ API ì¸ì¦ ì •ë³´</div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê°€ë§¹ì  ID (MID)*</label>
                                            <input type="text" id="pg-mid" class="input-field font-mono" placeholder="ì˜ˆ: nicepay00m">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ìƒì  í‚¤ (Merchant Key)*</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="pg-merchant-key" class="input-field font-mono flex-1" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                                <button type="button" onclick="toggleKeyVisibility('pg-merchant-key')" class="btn-secondary btn-sm">ðŸ‘ï¸</button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ì‹œí¬ë¦¿ í‚¤ (Secret Key)</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="pg-secret-key" class="input-field font-mono flex-1" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                                <button type="button" onclick="toggleKeyVisibility('pg-secret-key')" class="btn-secondary btn-sm">ðŸ‘ï¸</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                    <div class="text-xs text-emerald-400 mb-3">ðŸŒ API ì—”ë“œí¬ì¸íŠ¸</div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê²°ì œ ìš”ì²­ URL</label>
                                            <input type="text" id="pg-api-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/payments">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê²°ì œ ì·¨ì†Œ URL</label>
                                            <input type="text" id="pg-cancel-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/payments/cancel">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ë¹Œë§í‚¤ ë°œê¸‰ URL</label>
                                            <input type="text" id="pg-billing-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/subscribe/regist">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">ìš´ì˜ ëª¨ë“œ</label>
                                        <select id="pg-mode" class="input-field">
                                            <option value="test">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</option>
                                            <option value="production">ìš´ì˜ ëª¨ë“œ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">íƒ€ìž„ì•„ì›ƒ (ì´ˆ)</label>
                                        <input type="number" id="pg-timeout" class="input-field" value="30" min="10" max="120">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-2">
                                    <button type="button" onclick="testPgConnection()" class="btn-secondary flex-1">ðŸ” ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                                    <button type="button" onclick="savePgSettings()" class="btn-primary flex-1">ðŸ’¾ ì €ìž¥</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- API ë¬¸ì„œ ë° ê²°ì œ ì„¤ì • -->
                        <div class="space-y-6">
                            <!-- ë¹Œë§ ì„¤ì • -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-blue-400 text-lg mb-4">ðŸ”„ ì •ê¸°ê²°ì œ (ë¹Œë§) ì„¤ì •</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">ìžë™ ë¹Œë§ í™œì„±í™”</div>
                                            <div class="text-xs text-gray-400">ë“±ë¡ëœ ì¹´ë“œë¡œ ìžë™ ê²°ì œ</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-billing-enabled" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê¸°ë³¸ ê²°ì œì¼</label>
                                            <select id="pg-default-pay-day" class="input-field">
                                                <option value="1">ë§¤ì›” 1ì¼</option>
                                                <option value="5">ë§¤ì›” 5ì¼</option>
                                                <option value="10" selected>ë§¤ì›” 10ì¼</option>
                                                <option value="15">ë§¤ì›” 15ì¼</option>
                                                <option value="20">ë§¤ì›” 20ì¼</option>
                                                <option value="25">ë§¤ì›” 25ì¼</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê²°ì œ ì‹œê°„</label>
                                            <select id="pg-pay-time" class="input-field">
                                                <option value="09">ì˜¤ì „ 9ì‹œ</option>
                                                <option value="10">ì˜¤ì „ 10ì‹œ</option>
                                                <option value="14">ì˜¤í›„ 2ì‹œ</option>
                                                <option value="18">ì˜¤í›„ 6ì‹œ</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ì‹¤íŒ¨ ì‹œ ìž¬ì‹œë„</label>
                                            <select id="pg-retry-count" class="input-field">
                                                <option value="0">ìž¬ì‹œë„ ì•ˆí•¨</option>
                                                <option value="1">1íšŒ</option>
                                                <option value="2">2íšŒ</option>
                                                <option value="3" selected>3íšŒ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ìž¬ì‹œë„ ê°„ê²©</label>
                                            <select id="pg-retry-interval" class="input-field">
                                                <option value="1">1ì¼</option>
                                                <option value="2" selected>2ì¼</option>
                                                <option value="3">3ì¼</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- API ë¬¸ì„œ ì°¸ì¡° -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-purple-400 text-lg mb-4">ðŸ“š API ë¬¸ì„œ</h3>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('nicepay')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">ë‚˜ì´ìŠ¤íŽ˜ì´ API ë¬¸ì„œ</div>
                                                <div class="text-xs text-gray-400">developers.nicepay.co.kr</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('inicis')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">KGì´ë‹ˆì‹œìŠ¤ API ë¬¸ì„œ</div>
                                                <div class="text-xs text-gray-400">manual.inicis.com</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('toss')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">í† ìŠ¤íŽ˜ì´ë¨¼ì¸  API ë¬¸ì„œ</div>
                                                <div class="text-xs text-gray-400">docs.tosspayments.com</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Webhook ì„¤ì • -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-orange-400 text-lg mb-4">ðŸ”” Webhook ì„¤ì •</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Webhook URL</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="pg-webhook-url" class="input-field font-mono text-xs flex-1" placeholder="https://yourdomain.com/api/webhook/pg">
                                            <button type="button" onclick="copyWebhookUrl()" class="btn-secondary btn-sm">ðŸ“‹</button>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">ê²°ì œ ì™„ë£Œ ì•Œë¦¼</div>
                                            <div class="text-xs text-gray-400">ê²°ì œ ì„±ê³µ ì‹œ Webhook ë°œì†¡</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-webhook-success" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">ê²°ì œ ì‹¤íŒ¨ ì•Œë¦¼</div>
                                            <div class="text-xs text-gray-400">ê²°ì œ ì‹¤íŒ¨ ì‹œ Webhook ë°œì†¡</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-webhook-fail" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
                <div id="setting-system" class="setting-content hidden">
                    <div class="glass-card rounded-xl p-6">
                        <div class="text-lime-400 font-bold mb-4">ðŸ”§ ì‹œìŠ¤í…œ ì„¤ì •</div>
                        <div class="text-gray-500">ì‹œìŠ¤í…œ ì„¤ì • (ì¤€ë¹„ì¤‘)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ì‹œìŠ¤í…œ ======================= -->
    <div id="bromotorsSystem" class="hidden">
        <!-- í—¤ë” -->
        <div class="relative z-10 border-b border-lime-500/30" style="background: linear-gradient(180deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <!-- ëª¨ë°”ì¼: 2ì¤„ / PC: 1ì¤„ -->
                <div class="flex items-center justify-between flex-wrap gap-2">
                    <!-- ë¡œê³  -->
                    <div onclick="showBromotorsTab('overview')" class="cursor-pointer flex-shrink-0">
                        <div class="flex items-baseline gap-2">
                            <h1 class="text-xl md:text-2xl font-black neon-text">ë¸Œë¡œëª¨í„°ìŠ¤</h1>
                            <span class="text-[9px] text-gray-500">v1.6.0</span>
                        </div>
                        <p class="text-lime-400/50 text-[10px] italic">ì§ì˜ìˆ˜ë¦¬ì </p>
                    </div>
                    
                    <!-- ì˜¤ë¥¸ìª½ ìš”ì†Œë“¤ -->
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        <!-- ë‚ ì§œ -->
                        <div class="px-2 py-1 md:px-3 md:py-2 rounded-lg bg-white/5 border border-white/10 text-center">
                            <div class="text-[10px] text-lime-400/70">ì˜¤ëŠ˜ ë‚ ì§œ</div>
                            <div class="text-xs md:text-sm font-bold text-lime-400" id="b-today-date"></div>
                        </div>
                        <!-- ì •ì‚°ê´€ë¦¬ ë²„íŠ¼ -->
                        <button onclick="switchSystem()" class="px-2 py-1 md:px-3 md:py-2 rounded-lg bg-lime-500/10 border border-lime-500/30 text-lime-400 text-[10px] md:text-xs font-bold">ðŸ’° ì •ì‚°ê´€ë¦¬</button>
                        <!-- ì‚¬ìš©ìž ì •ë³´ -->
                        <div class="px-2 py-1 md:px-3 md:py-2 rounded-lg glass-card text-right">
                            <div class="text-[10px] text-lime-400/70" id="b-userRole">ê´€ë¦¬ìž</div>
                            <div class="text-xs md:text-sm font-bold" id="b-userName">Admin</div>
                        </div>
                        <!-- ë¡œê·¸ì•„ì›ƒ -->
                        <button onclick="handleLogout()" class="px-2 py-1 md:px-3 md:py-2 rounded-lg bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] md:text-xs font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="relative z-10 border-b border-lime-500/20 bg-black/50">
            <div class="max-w-7xl mx-auto px-2 md:px-6 flex overflow-x-auto scrollbar-hide">
                <button onclick="showBromotorsTab('overview')" id="b-tab-overview" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm tab-active whitespace-nowrap">ðŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button onclick="showBromotorsTab('work')" id="b-tab-work" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ“ ìž‘ì—…ë‚´ìš©</button>
                <button onclick="showBromotorsTab('accident')" id="b-tab-accident" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸš¨ ì‚¬ê³ ì°¨</button>
                <button onclick="showBromotorsTab('purchase')" id="b-tab-purchase" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸš— ë§¤ìž…ì°¨ëŸ‰</button>
                <button onclick="showBromotorsTab('cashbook')" id="b-tab-cashbook" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ’° ê¸ˆì „ì¶œë‚©ë¶€</button>
                <button onclick="showBromotorsTab('parts')" id="b-tab-parts" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ“¦ ë¶€í’ˆê´€ë¦¬</button>
                <button onclick="showBromotorsTab('customers')" id="b-tab-customers" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">ðŸ‘¥ ê³ ê°</button>
                <button onclick="showBromotorsTab('settings')" id="b-tab-settings" class="px-2 md:px-4 py-2 md:py-3 font-bold text-[10px] md:text-sm text-gray-500 whitespace-nowrap">âš™ï¸ ì„¤ì •</button>
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="relative z-10 max-w-7xl mx-auto px-3 md:px-6 py-4 md:py-6">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="b-content-overview" class="b-tab-content">
                <!-- ë‚ ì§œ êµ¬ê°„ í•„í„° -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-lime-400 text-sm font-bold">ðŸ“… ì¡°íšŒ ê¸°ê°„</span>
                            <input type="date" id="b-dash-start" class="input-field" style="width:140px">
                            <span class="text-gray-500">~</span>
                            <input type="date" id="b-dash-end" class="input-field" style="width:140px">
                            <button onclick="loadBroDashboard()" class="btn-secondary btn-sm">ì¡°íšŒ</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setBroDashPeriod('today')" class="btn-secondary btn-sm">ì˜¤ëŠ˜</button>
                            <button onclick="setBroDashPeriod('week')" class="btn-secondary btn-sm">7ì¼</button>
                            <button onclick="setBroDashPeriod('month')" class="btn-secondary btn-sm">ì´ë²ˆë‹¬</button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 stat-card cursor-pointer hover:border-lime-400" onclick="filterBroCashbook('today')">
                        <div class="text-lime-400 text-xs mb-1">ðŸ’µ ê¸°ê°„ ìˆ˜ìž…</div>
                        <div class="text-2xl font-black" id="b-today-income">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-income-count">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 stat-card cursor-pointer hover:border-red-400" onclick="filterBroCashbook('month-expense')">
                        <div class="text-red-400 text-xs mb-1">ðŸ’¸ ê¸°ê°„ ì§€ì¶œ</div>
                        <div class="text-2xl font-black" id="b-month-expense">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-expense-count">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 stat-card cursor-pointer hover:border-blue-400" onclick="openBroTodayWorkModal()">
                        <div class="text-blue-400 text-xs mb-1">ðŸ”§ ê¸°ê°„ ìž‘ì—…</div>
                        <div class="text-2xl font-black" id="b-period-work">0ê±´</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-work-amount">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 stat-card cursor-pointer hover:border-emerald-400" onclick="openBroMonthSummary()">
                        <div class="text-emerald-400 text-xs mb-1">ðŸ’° ê¸°ê°„ ì†ìµ</div>
                        <div class="text-2xl font-black" id="b-month-profit">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-profit-rate">-</div>
                        <div class="text-xs text-gray-400 mt-1" id="b-profit-detail">ìž…ê¸ˆ â‚©0 - ì§€ì¶œ â‚©0</div>
                    </div>
                </div>
                
                <!-- ì‚¬ê³ ì°¨/ë§¤ìž…ì°¨ëŸ‰ í˜„í™© -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 stat-card cursor-pointer hover:border-orange-400" onclick="showBromotorsTab('accident')">
                        <div class="text-orange-400 text-xs mb-1">ðŸš¨ ì‚¬ê³ ì°¨ ìˆ˜ìµ</div>
                        <div class="text-2xl font-black" id="b-accident-profit">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-accident-count">0ê±´ ì™„ë£Œ</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-cyan-400 stat-card cursor-pointer hover:border-cyan-400" onclick="showBromotorsTab('purchase')">
                        <div class="text-cyan-400 text-xs mb-1">ðŸš— ë§¤ìž…ì°¨ëŸ‰</div>
                        <div class="text-2xl font-black" id="b-purchase-count">0ëŒ€</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-purchase-status">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 stat-card cursor-pointer hover:border-yellow-400" onclick="showBromotorsTab('accident')">
                        <div class="text-yellow-400 text-xs mb-1">ðŸ”§ ì‚¬ê³ ì°¨ ìˆ˜ë¦¬ì¤‘</div>
                        <div class="text-2xl font-black" id="b-accident-progress">0ê±´</div>
                        <div class="text-xs text-gray-500 mt-1">ì§„í–‰ ì¤‘</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400 stat-card cursor-pointer hover:border-purple-400" onclick="showBromotorsTab('purchase')">
                        <div class="text-purple-400 text-xs mb-1">âœ… ìƒí’ˆí™” ì™„ë£Œ</div>
                        <div class="text-2xl font-black" id="b-purchase-complete">0ëŒ€</div>
                        <div class="text-xs text-gray-500 mt-1">íŒë§¤ ê°€ëŠ¥</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lime-400">ðŸ“‹ ì˜¤ëŠ˜ ìž‘ì—…</h3>
                            <span class="text-xs text-gray-500" id="b-today-work-count">0ê±´</span>
                        </div>
                        <div class="space-y-2" id="b-today-work-list"></div>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-orange-400">âš ï¸ ìž¬ê³  ì•Œë¦¼</h3>
                            <span class="text-xs text-gray-500" id="b-low-stock-count">0ê±´</span>
                        </div>
                        <div class="space-y-2" id="b-low-stock-list"></div>
                    </div>
                </div>
            </div>

            <!-- ìž‘ì—…ë‚´ìš© -->
            <div id="b-content-work" class="b-tab-content hidden">
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="date" id="b-work-start" class="input-field" style="width:140px">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="b-work-end" class="input-field" style="width:140px">
                        <select id="b-work-status" class="input-field" style="width:100px">
                            <option value="">ì „ì²´ìƒíƒœ</option>
                            <option value="waiting">ëŒ€ê¸°</option>
                            <option value="progress">ì§„í–‰ì¤‘</option>
                            <option value="complete">ì™„ë£Œ</option>
                        </select>
                        <input type="text" id="b-work-search" class="input-field" style="width:150px" placeholder="ê³ ê°ëª…, ì°¨ëŸ‰...">
                        <button onclick="loadBroWork()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBroCardPayModal()" class="btn-secondary btn-sm">ðŸ’³ ì¹´ë“œê²°ì œ</button>
                        <button onclick="downloadExcel('broWork')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openWorkModal()" class="btn-primary btn-sm">+ ìž‘ì—… ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ì ‘ìˆ˜ë²ˆí˜¸</th><th>ë‚ ì§œ</th><th>ê³ ê°</th><th>ì°¨ëŸ‰</th><th>ìž‘ì—…ë‚´ìš©</th><th>ê³µìž„</th><th>ë¶€í’ˆ</th><th>í•©ê³„</th><th>ìƒíƒœ</th><th>ê²°ì œ</th></tr></thead>
                        <tbody id="b-work-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì‚¬ê³ ì°¨ ìˆ˜ë¦¬ -->
            <div id="b-content-accident" class="b-tab-content hidden">
                <!-- ìƒíƒœ íƒ­ -->
                <div class="flex gap-2 mb-4">
                    <button onclick="filterAccident('')" id="acc-tab-all" class="flex-1 py-2 rounded-lg font-bold text-sm bg-lime-500/20 border border-lime-500/30 text-lime-400">ðŸ“‹ ì „ì²´ë³´ê¸°</button>
                    <button onclick="filterAccident('ìž…ê³ ')" id="acc-tab-pending" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white/5 border border-white/10 text-gray-400">ðŸ“¥ ìž…ê³ </button>
                    <button onclick="filterAccident('ìˆ˜ë¦¬ì¤‘')" id="acc-tab-progress" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white/5 border border-white/10 text-gray-400">ðŸ”§ ìˆ˜ë¦¬ì¤‘</button>
                    <button onclick="filterAccident('ì™„ë£Œ')" id="acc-tab-complete" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white/5 border border-white/10 text-gray-400">âœ… ì™„ë£Œ</button>
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-3 text-center">
                        <div class="text-gray-400 text-xs mb-1">ì „ì²´</div>
                        <div class="text-xl font-black text-white" id="b-acc-total">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-3 text-center">
                        <div class="text-orange-400 text-xs mb-1">ìž…ê³ </div>
                        <div class="text-xl font-black text-orange-400" id="b-acc-pending">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-3 text-center">
                        <div class="text-blue-400 text-xs mb-1">ìˆ˜ë¦¬ì¤‘</div>
                        <div class="text-xl font-black text-blue-400" id="b-acc-progress">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-3 text-center">
                        <div class="text-lime-400 text-xs mb-1">ì™„ë£Œ</div>
                        <div class="text-xl font-black text-lime-400" id="b-acc-complete">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-3 text-center border border-emerald-400/30">
                        <div class="text-emerald-400 text-xs mb-1">ì´ ìˆ˜ìµ</div>
                        <div class="text-xl font-black text-emerald-400" id="b-acc-profit">â‚©0</div>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="b-acc-search" class="input-field" style="width:180px" placeholder="ì°¨ëŸ‰ë²ˆí˜¸, ê³ ê°ëª…..." oninput="loadAccidentList()">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('accident')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('accidentModal')" class="btn-primary btn-sm">+ ì‚¬ê³ ì°¨ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden overflow-x-auto">
                    <table class="data-table" style="min-width:900px">
                        <thead><tr><th style="width:70px">ë²ˆí˜¸</th><th style="width:90px">ì ‘ìˆ˜ì¼</th><th style="width:100px">ì°¨ëŸ‰ë²ˆí˜¸</th><th style="width:80px">ê³ ê°</th><th style="width:80px">ë³´í—˜ì‚¬</th><th style="width:100px">ì²­êµ¬</th><th style="width:100px">ìŠ¹ì¸</th><th style="width:100px">ì‹¤ìˆ˜ë¦¬ë¹„</th><th style="width:100px">ìˆ˜ìµ</th><th style="width:80px">ìƒíƒœ</th></tr></thead>
                        <tbody id="b-acc-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ë§¤ìž…ì°¨ëŸ‰ -->
            <div id="b-content-purchase" class="b-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-cyan-400">
                        <div class="text-cyan-400 text-xs mb-1">ðŸš— ì „ì²´ ì°¨ëŸ‰</div>
                        <div class="text-2xl font-black text-cyan-400" id="b-pur-total">0ëŒ€</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400">
                        <div class="text-yellow-400 text-xs mb-1">ðŸ”§ ìƒí’ˆí™” ì§„í–‰ì¤‘</div>
                        <div class="text-2xl font-black text-yellow-400" id="b-pur-repair">0ëŒ€</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400">
                        <div class="text-lime-400 text-xs mb-1">âœ… ìƒí’ˆí™” ì™„ë£Œ</div>
                        <div class="text-2xl font-black text-lime-400" id="b-pur-ready">0ëŒ€</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400">
                        <div class="text-emerald-400 text-xs mb-1">ðŸ’µ ì˜ˆìƒ ìˆ˜ìµ</div>
                        <div class="text-2xl font-black text-emerald-400" id="b-pur-profit">â‚©0</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-pur-status" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                        </select>
                        <input type="text" id="b-pur-search" class="input-field" style="width:150px" placeholder="ì°¨ëŸ‰ë²ˆí˜¸, ëª¨ë¸...">
                        <button onclick="loadPurchaseList()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('purchase')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('purchaseModal')" class="btn-primary btn-sm">+ ë§¤ìž…ì°¨ëŸ‰ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë²ˆí˜¸</th><th>ë§¤ìž…ì¼</th><th>ì°¨ëŸ‰ë²ˆí˜¸</th><th>ëª¨ë¸</th><th>ë§¤ìž…ê°€</th><th>ìˆ˜ë¦¬ë¹„</th><th>ì´ë¹„ìš©</th><th>íŒë§¤ê°€</th><th>ìˆ˜ìµ</th><th>ìƒíƒœ</th></tr></thead>
                        <tbody id="b-pur-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê¸ˆì „ì¶œë‚©ë¶€ -->
            <div id="b-content-cashbook" class="b-tab-content hidden">
                <!-- ìš”ì•½ ì¹´ë“œ (í´ë¦­í•˜ë©´ ìƒì„¸ ëª¨ë‹¬) -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 cursor-pointer hover:bg-lime-400/5" onclick="openCashbookDetail('income')">
                        <div class="text-lime-400 text-xs mb-1">ðŸ’µ ì´ë²ˆë‹¬ ìˆ˜ìž…</div>
                        <div class="text-2xl font-black text-lime-400" id="b-cb-income">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="openCashbookDetail('expense')">
                        <div class="text-red-400 text-xs mb-1">ðŸ’¸ ì´ë²ˆë‹¬ ì§€ì¶œ</div>
                        <div class="text-2xl font-black text-red-400" id="b-cb-expense">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 cursor-pointer hover:bg-blue-400/5" onclick="openCashbookDetail('profit')">
                        <div class="text-blue-400 text-xs mb-1">ðŸ“Š ìˆœì´ìµ</div>
                        <div class="text-2xl font-black text-blue-400" id="b-cb-profit">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400 cursor-pointer hover:bg-purple-400/5" onclick="openCashbookDetail('balance')">
                        <div class="text-purple-400 text-xs mb-1">ðŸ’° í˜„ìž¬ ìž”ì•¡</div>
                        <div class="text-2xl font-black text-purple-400" id="b-cb-balance">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                </div>
                
                <!-- ê·¸ëž˜í”„ ì˜ì—­ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4">
                        <div class="text-sm text-lime-400 font-bold mb-3">ðŸ“ˆ ì›”ë³„ ìˆ˜ìž…/ì§€ì¶œ ì¶”ì´</div>
                        <canvas id="cashbook-chart" height="200"></canvas>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <div class="text-sm text-orange-400 font-bold mb-3">ðŸ© ì§€ì¶œ ë¶„ë¥˜ë³„ ë¹„ìœ¨</div>
                        <canvas id="expense-chart" height="200"></canvas>
                    </div>
                </div>
                
                <!-- ê¸°ê°„ í•„í„° ë²„íŠ¼ -->
                <div class="flex flex-wrap gap-2 mb-4 period-btns">
                    <button onclick="filterCashbookPeriod('1w')" id="cb-filter-1w" class="px-4 py-2 rounded-lg text-sm font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30">1ì£¼ì¼</button>
                    <button onclick="filterCashbookPeriod('1m')" id="cb-filter-1m" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10">1ê°œì›”</button>
                    <button onclick="filterCashbookPeriod('3m')" id="cb-filter-3m" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10">3ê°œì›”</button>
                    <button onclick="filterCashbookPeriod('all')" id="cb-filter-all" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10">ì „ì²´</button>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="date" id="b-cb-start-date" class="input-field" style="width:140px" title="ì‹œìž‘ì¼">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="b-cb-end-date" class="input-field" style="width:140px" title="ì¢…ë£Œì¼">
                        <select id="b-cb-type" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="income">ìˆ˜ìž…</option>
                            <option value="expense">ì§€ì¶œ</option>
                        </select>
                        <select id="b-cb-category-filter" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ë¶„ë¥˜</option>
                            <optgroup label="ìˆ˜ìž…">
                                <option value="ì •ë¹„ìˆ˜ìž…">ì •ë¹„ìˆ˜ìž…</option>
                                <option value="ë¶€í’ˆíŒë§¤">ë¶€í’ˆíŒë§¤</option>
                            </optgroup>
                            <optgroup label="ìš´ì˜ë¹„">
                                <option value="ë¶€í’ˆêµ¬ìž…">ë¶€í’ˆêµ¬ìž…</option>
                                <option value="ìž„ëŒ€ë£Œ">ìž„ëŒ€ë£Œ</option>
                                <option value="ì „ê¸°ìš”ê¸ˆ">ì „ê¸°ìš”ê¸ˆ</option>
                                <option value="ìˆ˜ë„ìš”ê¸ˆ">ìˆ˜ë„ìš”ê¸ˆ</option>
                                <option value="ê°€ìŠ¤ìš”ê¸ˆ">ê°€ìŠ¤ìš”ê¸ˆ</option>
                                <option value="ì¸í„°ë„·/í†µì‹ ">ì¸í„°ë„·/í†µì‹ </option>
                            </optgroup>
                            <optgroup label="ì¸ê±´ë¹„">
                                <option value="ê¸‰ì—¬">ê¸‰ì—¬</option>
                                <option value="4ëŒ€ë³´í—˜">4ëŒ€ë³´í—˜</option>
                                <option value="ì‹ëŒ€">ì‹ëŒ€</option>
                            </optgroup>
                        </select>
                        <input type="text" id="b-cb-search" class="input-field" style="width:150px" placeholder="ë‚´ìš© ê²€ìƒ‰...">
                        <button onclick="loadBroCashbook()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('broCashbook')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('cashbookModal')" class="btn-primary btn-sm">+ ë‚´ì—­ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ë¶„ë¥˜</th><th>ë‚´ìš©</th><th>ê¸ˆì•¡</th><th>ìž”ì•¡</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="b-cb-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ë¶€í’ˆê´€ë¦¬ -->
            <div id="b-content-parts" class="b-tab-content hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterBroParts('')">
                        <div class="text-2xl mb-1">ðŸ“¦</div>
                        <div class="text-gray-400 text-xs">ì „ì²´ ë¶€í’ˆ</div>
                        <div class="text-xl font-black text-lime-400" id="b-parts-total">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-parts-total-qty">ì´ 0ê°œ</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterBroParts('low')">
                        <div class="text-2xl mb-1">âš ï¸</div>
                        <div class="text-gray-400 text-xs">ìž¬ê³  ë¶€ì¡±</div>
                        <div class="text-xl font-black text-orange-400" id="b-parts-low">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-parts-low-list">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="openPartsValueModal()">
                        <div class="text-2xl mb-1">ðŸ’°</div>
                        <div class="text-gray-400 text-xs">ìž¬ê³  ê¸ˆì•¡</div>
                        <div class="text-xl font-black text-blue-400" id="b-parts-value">-</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-parts-category" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ë¶„ë¥˜</option>
                            <option value="ì˜¤ì¼ë¥˜">ì˜¤ì¼ë¥˜</option>
                            <option value="íƒ€ì´ì–´">íƒ€ì´ì–´</option>
                            <option value="ë¸Œë ˆì´í¬">ë¸Œë ˆì´í¬</option>
                            <option value="í•„í„°">í•„í„°</option>
                            <option value="ë°°í„°ë¦¬">ë°°í„°ë¦¬</option>
                            <option value="ì „ìž¥">ì „ìž¥</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                        <select id="b-parts-stock-filter" class="input-field" style="width:100px">
                            <option value="">ì „ì²´ìƒíƒœ</option>
                            <option value="low">ë¶€ì¡±</option>
                            <option value="normal">ì •ìƒ</option>
                            <option value="zero">í’ˆì ˆ</option>
                        </select>
                        <input type="text" id="b-parts-search" class="input-field" style="width:150px" placeholder="ë¶€í’ˆëª… ê²€ìƒ‰...">
                        <button onclick="loadBroParts()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('broParts')" class="btn-secondary btn-sm">ðŸ“¥ ì—‘ì…€</button>
                        <button onclick="openPartsModal()" class="btn-primary btn-sm">+ ë¶€í’ˆ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë¶€í’ˆëª…</th><th>ë¶„ë¥˜</th><th>ìž¬ê³ </th><th>ìµœì†Œìž¬ê³ </th><th>ë‹¨ê°€</th><th>ìž¬ê³ ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="b-parts-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³ ê° -->
            <div id="b-content-customers" class="b-tab-content hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterBroCustomers('')">
                        <div class="text-2xl mb-1">ðŸ‘¥</div>
                        <div class="text-gray-400 text-xs">ì „ì²´ ê³ ê°</div>
                        <div class="text-xl font-black text-lime-400" id="b-cust-total">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterBroCustomers('month')">
                        <div class="text-2xl mb-1">ðŸ”§</div>
                        <div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ë°©ë¬¸</div>
                        <div class="text-xl font-black text-blue-400" id="b-cust-month">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterBroCustomers('vip')">
                        <div class="text-2xl mb-1">â­</div>
                        <div class="text-gray-400 text-xs">ë‹¨ê³¨ ê³ ê°</div>
                        <div class="text-xl font-black text-yellow-400" id="b-cust-vip">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-cust-filter" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="month">ì´ë²ˆë‹¬ ë°©ë¬¸</option>
                            <option value="vip">ë‹¨ê³¨ (3íšŒ+)</option>
                        </select>
                        <input type="text" id="b-cust-search" class="input-field" style="width:180px" placeholder="ê³ ê°ëª…, ì—°ë½ì²˜, ì°¨ëŸ‰ ê²€ìƒ‰...">
                        <button onclick="loadBroCustomers()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <button onclick="openBroCustModal()" class="btn-primary btn-sm">+ ê³ ê° ë“±ë¡</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ë²ˆí˜¸íŒ</th><th>ë°©ë¬¸íšŸìˆ˜</th><th>ìµœê·¼ë°©ë¬¸</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="b-cust-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì„¤ì • -->
            <div id="b-content-settings" class="b-tab-content hidden">
                <div class="glass-card rounded-xl p-6">
                    <div class="text-lime-400 font-bold mb-4">âš™ï¸ ì„¤ì •</div>
                    <div class="text-gray-400 text-sm">ì§ì› ê´€ë¦¬ëŠ” <span class="text-lime-400 cursor-pointer" onclick="goToSettlementSettings()">ì •ì‚°ê´€ë¦¬ â†’ ì„¤ì •</span>ì—ì„œ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= ëª¨ë‹¬: ì§ì› ë“±ë¡ ======================= -->
    <div id="staffModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="staffModalTitle" class="text-xl font-bold text-lime-400">ðŸ‘¤ ì§ì› ë“±ë¡</h2><button onclick="closeModal('staffModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitStaff(event)" id="staffForm" class="space-y-4">
                <input type="hidden" id="staff-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì´ë¦„*</label><input name="name" id="staff-name" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì•„ì´ë””*</label><input name="username" id="staff-username" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë¹„ë°€ë²ˆí˜¸*</label><input type="password" name="password" id="staff-password" class="input-field"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸*</label><input type="password" name="password_confirm" id="staff-password-confirm" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="staff-phone" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì´ë©”ì¼</label><input type="email" name="email" id="staff-email" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë¶€ì„œ*</label>
                        <select name="department" id="staff-department" class="input-field" required>
                            <option value="">ì„ íƒ</option>
                            <option value="ì •ì‚°íŒ€">ì •ì‚°íŒ€</option>
                            <option value="ì •ë¹„íŒ€">ì •ë¹„íŒ€</option>
                            <option value="ì˜ì—…íŒ€">ì˜ì—…íŒ€</option>
                            <option value="ê³ ê°ì§€ì›íŒ€">ê³ ê°ì§€ì›íŒ€</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìƒíƒœ*</label>
                        <select name="status" id="staff-status" class="input-field" required>
                            <option value="active">ìž¬ì§</option>
                            <option value="inactive">í‡´ì‚¬</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ê¶Œí•œ ë“±ê¸‰* (1~4ë‹¨ê³„)</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-gray-400/50 has-[:checked]:border-gray-400 has-[:checked]:bg-gray-400/10">
                            <input type="radio" name="level" value="1" class="hidden" checked>
                            <span class="text-lg mb-1">ðŸ‘¤</span>
                            <span class="text-xs font-bold text-gray-400">Lv.1</span>
                            <span class="text-[10px] text-gray-500">ì‚¬ì›</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-blue-400/50 has-[:checked]:border-blue-400 has-[:checked]:bg-blue-400/10">
                            <input type="radio" name="level" value="2" class="hidden">
                            <span class="text-lg mb-1">â­</span>
                            <span class="text-xs font-bold text-blue-400">Lv.2</span>
                            <span class="text-[10px] text-gray-500">íŒ€ì›</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-orange-400/50 has-[:checked]:border-orange-400 has-[:checked]:bg-orange-400/10">
                            <input type="radio" name="level" value="3" class="hidden">
                            <span class="text-lg mb-1">ðŸ‘‘</span>
                            <span class="text-xs font-bold text-orange-400">Lv.3</span>
                            <span class="text-[10px] text-gray-500">ë§¤ë‹ˆì €</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-red-400/50 has-[:checked]:border-red-400 has-[:checked]:bg-red-400/10">
                            <input type="radio" name="level" value="4" class="hidden">
                            <span class="text-lg mb-1">ðŸ”¥</span>
                            <span class="text-xs font-bold text-red-400">Lv.4</span>
                            <span class="text-[10px] text-gray-500">ìµœê³ ê´€ë¦¬ìž</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('staffModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="staffSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ëª¨ë‹¬: ê³ ê° ë“±ë¡/ìˆ˜ì • ======================= -->
    <div id="customerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="customerModalTitle" class="text-xl font-bold text-lime-400">ðŸ‘¤ ê³ ê° ë“±ë¡</h2><button onclick="closeModal('customerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitCustomer(event)" id="customerForm" class="space-y-4">
                <input type="hidden" id="cust-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="name" id="cust-name" class="input-field" placeholder="í™ê¸¸ë™" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì£¼ë¯¼ë²ˆí˜¸</label><input name="ssn" id="cust-ssn" class="input-field" placeholder="000000-0000000"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="cust-phone" class="input-field" placeholder="010-0000-0000" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì´ë©”ì¼</label><input type="email" name="email" id="cust-email" class="input-field" placeholder="example@email.com"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ì£¼ì†Œ</label><input name="address" id="cust-address" class="input-field" placeholder="ì£¼ì†Œ"></div>
                <div><label class="block text-xs text-lime-400 mb-1">ê±°ëž˜ë“±ê¸‰*</label>
                    <select name="grade" id="cust-grade-select" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="ìƒ">ìƒ</option>
                        <option value="ì¤‘">ì¤‘</option>
                        <option value="í•˜">í•˜</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="cust-memo" class="input-field" rows="2" placeholder="ê³ ê° ë©”ëª¨"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('customerModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="customerSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ëª¨ë‹¬: ê³ ê° ìƒì„¸ ======================= -->
    <div id="customerDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ‘¤ ê³ ê° ìƒì„¸</h2><button onclick="closeModal('customerDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="customer-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ìž‘ì—… ë“±ë¡ ======================= -->
    <div id="workModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 id="workModalTitle" class="text-xl font-bold text-lime-400">ðŸ”§ ìž‘ì—… ë“±ë¡</h2><button onclick="closeModal('workModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroWork(event)" id="workForm" class="space-y-4">
                <input type="hidden" id="work-edit-id" value="">
                <input type="hidden" id="work-customer-id" value="">
                <!-- ê³ ê° ê²€ìƒ‰ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">ðŸ‘¤ ê³ ê° ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="block text-xs text-gray-400 mb-1">ê³ ê°ëª…* (ê²€ìƒ‰)</label>
                            <input name="customer" id="work-customer" class="input-field" placeholder="ì´ë¦„ ìž…ë ¥ í›„ ê²€ìƒ‰" required oninput="searchBroCustomer()">
                            <div id="customer-search-results" class="absolute z-50 w-full bg-black border border-lime-400/30 rounded-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ì—°ë½ì²˜*</label>
                            <input name="phone" id="work-phone" class="input-field" required onblur="checkPhoneDuplicate()">
                            <div id="phone-check-result" class="text-xs mt-1"></div>
                        </div>
                    </div>
                    <div id="customer-info-box" class="mt-3 p-2 rounded bg-lime-400/10 border border-lime-400/30 hidden">
                        <div class="text-xs text-lime-400">âœ… ê¸°ì¡´ ê³ ê°</div>
                        <div id="customer-info-detail" class="text-sm text-gray-300 mt-1"></div>
                    </div>
                    <div id="new-customer-box" class="mt-3 p-2 rounded bg-blue-400/10 border border-blue-400/30 hidden">
                        <div class="text-xs text-blue-400">ðŸ†• ì‹ ê·œ ê³ ê°ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</div>
                    </div>
                </div>
                
                <!-- ì°¨ëŸ‰ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-purple-400 mb-3">ðŸï¸ ì°¨ëŸ‰ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰*</label><input name="vehicle" id="work-vehicle" class="input-field" placeholder="PCX 125" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë²ˆí˜¸íŒ</label><input name="plate" id="work-plate" class="input-field" placeholder="12ê°€3456"></div>
                    </div>
                </div>
                
                <!-- ìž‘ì—… ë‚´ìš© -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">ðŸ”§ ìž‘ì—… ë‚´ìš©</div>
                    <div><label class="block text-xs text-gray-400 mb-1">ìž‘ì—…ë‚´ìš©*</label><input name="content" id="work-content" class="input-field" placeholder="ì—”ì§„ì˜¤ì¼ êµí™˜" required></div>
                    
                    <!-- ë¶€í’ˆ ê²€ìƒ‰ ë° ì¶”ê°€ -->
                    <div class="mt-3 p-3 rounded-lg bg-blue-400/10 border border-blue-400/30">
                        <div class="text-xs text-blue-400 mb-2">ðŸ”© ë¶€í’ˆ ì¶”ê°€ (ë¶€í’ˆê´€ë¦¬ì—ì„œ ê²€ìƒ‰)</div>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input type="text" id="work-part-search" class="input-field" placeholder="ë¶€í’ˆëª… ê²€ìƒ‰..." oninput="searchWorkParts()">
                                <div id="work-part-results" class="absolute z-50 w-full bg-black border border-blue-400/30 rounded-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                        </div>
                        <!-- ì¶”ê°€ëœ ë¶€í’ˆ ëª©ë¡ -->
                        <div id="work-parts-list" class="mt-2 space-y-1"></div>
                    </div>
                    
                    <!-- ê¸ˆì•¡ ê³„ì‚° -->
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë¶€í’ˆë¹„ (ìžë™ê³„ì‚°)</label><input type="number" name="parts_cost" id="work-parts" class="input-field bg-blue-400/10" value="0" readonly></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³µìž„ (ì´ê¸ˆì•¡ - ë¶€í’ˆë¹„)</label><input type="number" name="labor" id="work-labor" class="input-field" value="0" readonly></div>
                    </div>
                    
                    <!-- ê²°ì œê¸ˆì•¡ ìž…ë ¥ -->
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="block text-xs text-yellow-400 mb-1">ðŸ’° ê²°ì œê¸ˆì•¡ ìž…ë ¥*</label>
                            <input type="number" id="work-pay-amount" class="input-field border-yellow-400/50" placeholder="ì´ ë°›ì„ ê¸ˆì•¡" oninput="calcWorkFromTotal()" required>
                        </div>
                        <div>
                            <label class="block text-xs text-emerald-400 mb-1">í•©ê³„</label>
                            <input type="text" id="work-total" class="input-field bg-emerald-400/10 text-emerald-400 font-bold" value="â‚©0" readonly>
                        </div>
                    </div>
                    
                    <!-- ë¶€ê°€ì„¸ ì˜µì…˜ -->
                    <div class="mt-3 flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="work-vat-check" class="w-4 h-4 accent-lime-400" onchange="calcWorkFromTotal()">
                            <span class="text-xs text-gray-300">ë¶€ê°€ì„¸ ë³„ë„ (+10%)</span>
                        </label>
                        <span id="work-vat-amount" class="text-xs text-yellow-400 hidden">VAT: â‚©0</span>
                    </div>
                    
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="work-memo" class="input-field" rows="2"></textarea></div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('workModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="workSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê¸ˆì „ì¶œë‚© ë“±ë¡ ======================= -->
    <div id="cashbookModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="cashbookModalTitle" class="text-xl font-bold text-lime-400">ðŸ’° ë‚´ì—­ ë“±ë¡</h2><button onclick="closeModal('cashbookModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroCashbook(event)" class="space-y-4">
                <input type="hidden" id="cashbook-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë‚ ì§œ*</label><input type="date" name="date" id="cb-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">êµ¬ë¶„*</label>
                        <select name="type" id="cb-type" class="input-field" required onchange="updateCategoryOptions()">
                            <option value="income">ìˆ˜ìž…</option>
                            <option value="expense">ì§€ì¶œ</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë¶„ë¥˜*</label>
                    <select name="category" id="cb-category" class="input-field" required>
                        <optgroup label="ðŸ“ˆ ìˆ˜ìž…">
                            <option value="ì •ë¹„ìˆ˜ìž…">ì •ë¹„ìˆ˜ìž…</option>
                            <option value="ë¶€í’ˆíŒë§¤">ë¶€í’ˆíŒë§¤</option>
                            <option value="ê¸°íƒ€ìˆ˜ìž…">ê¸°íƒ€ìˆ˜ìž…</option>
                        </optgroup>
                        <optgroup label="ðŸ¢ ìš´ì˜ë¹„">
                            <option value="ìž„ëŒ€ë£Œ">ìž„ëŒ€ë£Œ</option>
                            <option value="ì „ê¸°ìš”ê¸ˆ">ì „ê¸°ìš”ê¸ˆ</option>
                            <option value="ìˆ˜ë„ìš”ê¸ˆ">ìˆ˜ë„ìš”ê¸ˆ</option>
                            <option value="ê°€ìŠ¤ìš”ê¸ˆ">ê°€ìŠ¤ìš”ê¸ˆ</option>
                            <option value="ì¸í„°ë„·/í†µì‹ ">ì¸í„°ë„·/í†µì‹ </option>
                            <option value="ë¶€í’ˆêµ¬ìž…">ë¶€í’ˆêµ¬ìž…</option>
                            <option value="ì†Œëª¨í’ˆ">ì†Œëª¨í’ˆ</option>
                        </optgroup>
                        <optgroup label="ðŸ‘· ì¸ê±´ë¹„">
                            <option value="ê¸‰ì—¬">ê¸‰ì—¬</option>
                            <option value="4ëŒ€ë³´í—˜">4ëŒ€ë³´í—˜</option>
                            <option value="ì‹ëŒ€">ì‹ëŒ€</option>
                            <option value="ë³µë¦¬í›„ìƒ">ë³µë¦¬í›„ìƒ</option>
                        </optgroup>
                        <optgroup label="ðŸš— ì°¨ëŸ‰/ìž¥ë¹„">
                            <option value="ìž¥ë¹„êµ¬ë§¤">ìž¥ë¹„êµ¬ë§¤</option>
                            <option value="ìž¥ë¹„ìˆ˜ë¦¬">ìž¥ë¹„ìˆ˜ë¦¬</option>
                            <option value="ì°¨ëŸ‰ìœ ì§€ë¹„">ì°¨ëŸ‰ìœ ì§€ë¹„</option>
                            <option value="ì£¼ìœ ë¹„">ì£¼ìœ ë¹„</option>
                        </optgroup>
                        <optgroup label="ðŸ“‹ ì„¸ê¸ˆ/ë³´í—˜">
                            <option value="ì„¸ê¸ˆ">ì„¸ê¸ˆ</option>
                            <option value="ë³´í—˜ë£Œ">ë³´í—˜ë£Œ</option>
                        </optgroup>
                        <optgroup label="ê¸°íƒ€">
                            <option value="ê¸°íƒ€ì§€ì¶œ">ê¸°íƒ€ì§€ì¶œ</option>
                        </optgroup>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë‚´ìš©*</label><input name="description" id="cb-description" class="input-field" required placeholder="ìƒì„¸ ë‚´ìš© ìž…ë ¥..."></div>
                <div><label class="block text-xs text-lime-400 mb-1">ê¸ˆì•¡*</label><input type="number" name="amount" id="cb-amount" class="input-field" required></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('cashbookModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="cashbookSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê¸ˆì „ì¶œë‚©ë¶€ ìƒì„¸ ======================= -->
    <div id="cashbookDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px; max-height:85vh; overflow-y:auto;">
            <div class="flex justify-between mb-4">
                <h2 id="cashbookDetailTitle" class="text-xl font-bold text-lime-400">ðŸ’° ìƒì„¸ ë‚´ì—­</h2>
                <button onclick="closeModal('cashbookDetailModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="cashbook-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì‚¬ê³ ì°¨ ë“±ë¡ ======================= -->
    <div id="accidentModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4">
                <h2 id="accidentModalTitle" class="text-xl font-bold text-orange-400">ðŸš¨ ì‚¬ê³ ì°¨ ë“±ë¡</h2>
                <button onclick="closeModal('accidentModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <form onsubmit="submitAccident(event)" id="accidentForm" class="space-y-4">
                <input type="hidden" id="accident-edit-id">
                
                <!-- ì°¨ëŸ‰/ê³ ê° ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">ðŸš— ì°¨ëŸ‰/ê³ ê° ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰ë²ˆí˜¸*</label><input name="plate" id="acc-plate" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰ëª¨ë¸</label><input name="model" id="acc-model" class="input-field"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê³ ê°ëª…*</label><input name="customer" id="acc-customer" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="acc-phone" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- ì‚¬ê³  ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">ðŸš¨ ì‚¬ê³  ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì ‘ìˆ˜ì¼*</label><input type="date" name="receipt_date" id="acc-date" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì‚¬ê³ ìœ í˜•</label>
                            <select name="accident_type" id="acc-type" class="input-field">
                                <option value="ë‹¨ë…ì‚¬ê³ ">ë‹¨ë…ì‚¬ê³ </option>
                                <option value="ì ‘ì´‰ì‚¬ê³ ">ì ‘ì´‰ì‚¬ê³ </option>
                                <option value="ì¶”ëŒì‚¬ê³ ">ì¶”ëŒì‚¬ê³ </option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ì‚¬ê³  ë‚´ìš©</label><textarea name="accident_desc" id="acc-desc" class="input-field" rows="2" placeholder="ì‚¬ê³  ìƒí™© ì„¤ëª…..."></textarea></div>
                </div>
                
                <!-- ë³´í—˜ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-blue-400 mb-3">ðŸ¢ ë³´í—˜ì‚¬ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ì‚¬</label>
                            <select name="insurance" id="acc-insurance" class="input-field">
                                <option value="">ì„ íƒ</option>
                                <option value="ì‚¼ì„±í™”ìž¬">ì‚¼ì„±í™”ìž¬</option>
                                <option value="í˜„ëŒ€í•´ìƒ">í˜„ëŒ€í•´ìƒ</option>
                                <option value="DBì†í•´ë³´í—˜">DBì†í•´ë³´í—˜</option>
                                <option value="KBì†í•´ë³´í—˜">KBì†í•´ë³´í—˜</option>
                                <option value="ë©”ë¦¬ì¸ í™”ìž¬">ë©”ë¦¬ì¸ í™”ìž¬</option>
                                <option value="í•œí™”ì†í•´ë³´í—˜">í•œí™”ì†í•´ë³´í—˜</option>
                                <option value="ë¡¯ë°ì†í•´ë³´í—˜">ë¡¯ë°ì†í•´ë³´í—˜</option>
                                <option value="í¥êµ­í™”ìž¬">í¥êµ­í™”ìž¬</option>
                                <option value="ìžë¹„ìˆ˜ë¦¬">ìžë¹„ìˆ˜ë¦¬ (ë³´í—˜X)</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ ë‹´ë‹¹ìž</label><input name="insurance_contact" id="acc-ins-contact" class="input-field"></div>
                    </div>
                </div>
                
                <!-- ê²¬ì  ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-purple-400 mb-3">ðŸ’° ë³´í—˜ ê²¬ì </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê²¬ì  ìš”ì²­ê¸ˆì•¡ (ë³´í—˜ì‚¬ ì²­êµ¬)</label><input type="number" name="estimate_request" id="acc-est-req" class="input-field" value="0" oninput="calcAccidentProfit()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ ìŠ¹ì¸ê¸ˆì•¡</label><input type="number" name="estimate_approved" id="acc-est-appr" class="input-field" value="0" oninput="calcAccidentProfit()"></div>
                    </div>
                </div>
                
                <!-- ì‹¤ì œ ë¹„ìš© -->
                <div class="p-3 rounded-lg bg-orange-400/10 border border-orange-400/30">
                    <div class="text-xs text-orange-400 mb-3">ðŸ”§ ì‹¤ì œ ìˆ˜ë¦¬ ë¹„ìš©</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë¶€í’ˆë¹„</label><input type="number" name="parts_cost" id="acc-parts" class="input-field" value="0" oninput="calcAccidentProfit()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³µìž„ë¹„</label><input type="number" name="labor_cost" id="acc-labor" class="input-field" value="0" oninput="calcAccidentProfit()"></div>
                    </div>
                    <div class="mt-3 p-2 rounded bg-white/5 border border-white/10">
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-400">ì‹¤ì œ ìˆ˜ë¦¬ë¹„ í•©ê³„</span>
                            <span class="font-bold text-orange-400" id="acc-actual-display">â‚©0</span>
                        </div>
                    </div>
                </div>
                
                <!-- ìˆ˜ìµ ê³„ì‚° -->
                <div class="p-3 rounded-lg bg-emerald-400/10 border border-emerald-400/30">
                    <div class="text-xs text-emerald-400 mb-3">ðŸ“Š ìˆ˜ìµ ê³„ì‚°</div>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div>
                            <div class="text-xs text-gray-400">ìŠ¹ì¸ê¸ˆì•¡</div>
                            <div class="font-bold text-cyan-400" id="acc-approved-display">â‚©0</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">-</div>
                            <div class="text-gray-500">ì‹¤ìˆ˜ë¦¬ë¹„</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">= ìˆ˜ìµ</div>
                            <div class="font-bold text-emerald-400" id="acc-profit-display">â‚©0</div>
                        </div>
                    </div>
                </div>
                
                <!-- ìƒíƒœ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 mb-3">ðŸ“‹ ì§„í–‰ ìƒíƒœ</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒíƒœ*</label>
                            <select name="status" id="acc-status" class="input-field" required>
                                <option value="ì ‘ìˆ˜">ì ‘ìˆ˜</option>
                                <option value="ê²¬ì ìš”ì²­">ê²¬ì ìš”ì²­</option>
                                <option value="ìŠ¹ì¸ëŒ€ê¸°">ìŠ¹ì¸ëŒ€ê¸°</option>
                                <option value="ìˆ˜ë¦¬ì¤‘">ìˆ˜ë¦¬ì¤‘</option>
                                <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì˜ˆìƒ ì™„ë£Œì¼</label><input type="date" name="expected_date" id="acc-expected" class="input-field"></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="acc-memo" class="input-field" rows="2"></textarea></div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('accidentModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="accidentSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì‚¬ê³ ì°¨ ìƒì„¸ ======================= -->
    <div id="accidentDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4">
                <h2 class="text-xl font-bold text-orange-400">ðŸš¨ ì‚¬ê³ ì°¨ ìƒì„¸</h2>
                <button onclick="closeModal('accidentDetailModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="accident-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ë§¤ìž…ì°¨ëŸ‰ ë“±ë¡ ======================= -->
    <div id="purchaseModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4">
                <h2 id="purchaseModalTitle" class="text-xl font-bold text-cyan-400">ðŸš— ë§¤ìž…ì°¨ëŸ‰ ë“±ë¡</h2>
                <button onclick="closeModal('purchaseModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <form onsubmit="submitPurchase(event)" id="purchaseForm" class="space-y-4">
                <input type="hidden" id="purchase-edit-id">
                
                <!-- ì°¨ëŸ‰ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">ðŸš— ì°¨ëŸ‰ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰ë²ˆí˜¸*</label><input name="plate" id="pur-plate" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ëª¨ë¸ëª…*</label><input name="model" id="pur-model" class="input-field" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ì‹</label><input type="number" name="year" id="pur-year" class="input-field" value="2024"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì£¼í–‰ê±°ë¦¬</label><input type="number" name="mileage" id="pur-mileage" class="input-field" value="0"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒ‰ìƒ</label><input name="color" id="pur-color" class="input-field"></div>
                    </div>
                </div>
                
                <!-- ë§¤ìž… ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-yellow-400 mb-3">ðŸ’° ë§¤ìž… ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë§¤ìž…ì¼*</label><input type="date" name="purchase_date" id="pur-date" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë§¤ìž…ì²˜</label><input name="source" id="pur-source" class="input-field" placeholder="ë§¤ìž…ì²˜ ìž…ë ¥..."></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë§¤ìž…ê°€*</label><input type="number" name="purchase_price" id="pur-price" class="input-field" required value="0" oninput="calcPurchaseProfit()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê¸°íƒ€ ë¹„ìš©</label><input type="number" name="other_cost" id="pur-other" class="input-field" value="0" oninput="calcPurchaseProfit()"></div>
                    </div>
                </div>
                
                <!-- ìˆ˜ë¦¬ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">ðŸ”§ ìˆ˜ë¦¬ ë¹„ìš©</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë¶€í’ˆë¹„</label><input type="number" name="parts_cost" id="pur-parts" class="input-field" value="0" oninput="calcPurchaseProfit()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³µìž„</label><input type="number" name="labor_cost" id="pur-labor" class="input-field" value="0" oninput="calcPurchaseProfit()"></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ìˆ˜ë¦¬ ë‚´ì—­</label><textarea name="repair_desc" id="pur-repair-desc" class="input-field" rows="2" placeholder="ìˆ˜ë¦¬ ë‚´ìš© ìž…ë ¥..."></textarea></div>
                </div>
                
                <!-- íŒë§¤ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-emerald-400 mb-3">ðŸ’µ íŒë§¤ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">íŒë§¤ ì˜ˆì •ê°€</label><input type="number" name="sell_price" id="pur-sell" class="input-field" value="0" oninput="calcPurchaseProfit()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒí’ˆí™”*</label>
                            <select name="status" id="pur-status" class="input-field" required>
                                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                                <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3 p-2 rounded bg-emerald-400/10 border border-emerald-400/30">
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-xs text-gray-400">ì´ ë¹„ìš©</span>
                                <span class="font-bold text-red-400" id="pur-total-cost">â‚©0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-xs text-gray-400">ì˜ˆìƒ ìˆ˜ìµ</span>
                                <span class="font-bold text-emerald-400" id="pur-profit-display">â‚©0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="pur-memo" class="input-field" rows="2"></textarea></div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('purchaseModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="purchaseSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ë§¤ìž…ì°¨ëŸ‰ ìƒì„¸ ======================= -->
    <div id="purchaseDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4">
                <h2 class="text-xl font-bold text-cyan-400">ðŸš— ë§¤ìž…ì°¨ëŸ‰ ìƒì„¸</h2>
                <button onclick="closeModal('purchaseDetailModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="purchase-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ë¶€í’ˆ ë“±ë¡/ìˆ˜ì • ======================= -->
    <div id="partsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="partsModalTitle" class="text-xl font-bold text-lime-400">ðŸ“¦ ë¶€í’ˆ ë“±ë¡</h2><button onclick="closeModal('partsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroParts(event)" id="partsForm" class="space-y-4">
                <input type="hidden" id="parts-edit-id">
                <div><label class="block text-xs text-lime-400 mb-1">ë¶€í’ˆëª…*</label><input name="name" id="parts-name" class="input-field" required></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë¶„ë¥˜*</label>
                        <select name="category" id="parts-category" class="input-field" required>
                            <option value="ì˜¤ì¼ë¥˜">ì˜¤ì¼ë¥˜</option>
                            <option value="íƒ€ì´ì–´">íƒ€ì´ì–´</option>
                            <option value="ë¸Œë ˆì´í¬">ë¸Œë ˆì´í¬</option>
                            <option value="í•„í„°">í•„í„°</option>
                            <option value="ë°°í„°ë¦¬">ë°°í„°ë¦¬</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìž¬ê³ ìˆ˜ëŸ‰*</label><input type="number" name="stock" id="parts-stock" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë‹¨ê°€*</label><input type="number" name="price" id="parts-price" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìµœì†Œìž¬ê³ </label><input type="number" name="min_stock" id="parts-min" class="input-field" value="5"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('partsModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="partsSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê³ ê° ë“±ë¡ ======================= -->
    <div id="broCustModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="broCustModalTitle" class="text-xl font-bold text-lime-400">ðŸ‘¤ ê³ ê° ë“±ë¡</h2><button onclick="closeModal('broCustModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroCustomer(event)" id="broCustForm" class="space-y-4">
                <input type="hidden" id="bro-cust-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="name" id="bro-cust-name" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="bro-cust-phone" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì°¨ëŸ‰</label><input name="vehicle" id="bro-cust-vehicle" class="input-field" placeholder="PCX 125"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ë²ˆí˜¸íŒ</label><input name="plate" id="bro-cust-plate" class="input-field" placeholder="12ê°€3456"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('broCustModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="broCustSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ìž‘ì—… ìƒì„¸ ======================= -->
    <div id="workDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ”§ ìž‘ì—… ìƒì„¸</h2><button onclick="closeModal('workDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="work-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê³ ê° ìƒì„¸ ======================= -->
    <div id="broCustDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ‘¤ ê³ ê° ìƒì„¸ ì •ë³´</h2><button onclick="closeModal('broCustDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-cust-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì›”ê°„ ìš”ì•½ ======================= -->
    <div id="broMonthSummaryModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ“Š ì´ë²ˆë‹¬ ìˆ˜ìµ í˜„í™©</h2><button onclick="closeModal('broMonthSummaryModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-month-summary-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì˜¤ëŠ˜ ìž‘ì—… ìƒì„¸ ======================= -->
    <div id="broTodayWorkModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ“‹ ì˜¤ëŠ˜ ìž‘ì—… í˜„í™©</h2><button onclick="closeModal('broTodayWorkModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-today-work-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ìž¬ê³  ì•Œë¦¼ ìƒì„¸ ======================= -->
    <div id="broLowStockModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">âš ï¸ ìž¬ê³  ë¶€ì¡± í˜„í™©</h2><button onclick="closeModal('broLowStockModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-low-stock-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ìž¬ê³  ê¸ˆì•¡ ìƒì„¸ ======================= -->
    <div id="broPartsValueModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-blue-400">ðŸ’° ìž¬ê³  ê¸ˆì•¡ í˜„í™©</h2><button onclick="closeModal('broPartsValueModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-parts-value-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì¹´ë“œê²°ì œ ======================= -->
    <div id="broCardPayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-blue-400">ðŸ’³ ì¹´ë“œ ìˆ˜ë™ê²°ì œ</h2><button onclick="closeModal('broCardPayModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="processBroCardPayment(event)" class="space-y-4">
                <!-- ê²°ì œìž ìœ í˜• -->
                <div>
                    <label class="block text-xs text-lime-400 mb-2">ê²°ì œìž ìœ í˜•*</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50 has-[:checked]:border-lime-400 has-[:checked]:bg-lime-400/10">
                            <input type="radio" name="payer_type" value="personal" class="accent-lime-400" checked onchange="togglePayerType(this.value)">
                            <div><div class="font-bold">ðŸ‘¤ ê°œì¸</div><div class="text-xs text-gray-400">ê°œì¸ ì¹´ë“œ ê²°ì œ</div></div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-blue-400/50 has-[:checked]:border-blue-400 has-[:checked]:bg-blue-400/10">
                            <input type="radio" name="payer_type" value="business" class="accent-blue-400" onchange="togglePayerType(this.value)">
                            <div><div class="font-bold">ðŸ¢ ì‚¬ì—…ìž/ë²•ì¸</div><div class="text-xs text-gray-400">ì‚¬ì—…ìž/ë²•ì¸ ì¹´ë“œ</div></div>
                        </label>
                    </div>
                </div>
                
                <!-- ì‚¬ì—…ìž ì •ë³´ (ì‚¬ì—…ìž ì„ íƒì‹œë§Œ í‘œì‹œ) -->
                <div id="business-info" class="hidden space-y-3 p-4 rounded-lg bg-blue-400/5 border border-blue-400/20">
                    <div class="text-xs text-blue-400 font-bold mb-2">ðŸ¢ ì‚¬ì—…ìž ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸</label><input name="biz_no" class="input-field" placeholder="000-00-00000"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒí˜¸ëª…</label><input name="biz_name" class="input-field" placeholder="íšŒì‚¬ëª…"></div>
                    </div>
                    <div><label class="block text-xs text-gray-400 mb-1">ëŒ€í‘œìžëª…</label><input name="biz_ceo" class="input-field" placeholder="ëŒ€í‘œìžëª…"></div>
                </div>
                
                <!-- ê²°ì œ ì •ë³´ -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="customer_name" id="bro-pay-customer" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="bro-pay-phone" class="input-field" required></div>
                </div>
                
                <!-- ì¹´ë“œ ì •ë³´ -->
                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 font-bold mb-3">ðŸ’³ ì¹´ë“œ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œë²ˆí˜¸*</label><input name="card_no" id="bro-card-no" class="input-field" placeholder="0000-0000-0000-0000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìœ íš¨ê¸°ê°„*</label><input name="card_expiry" id="bro-card-expiry" class="input-field" placeholder="MM/YY" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">CVC*</label><input name="card_cvc" type="password" maxlength="4" class="input-field" placeholder="000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">í• ë¶€</label>
                            <select name="installment" class="input-field">
                                <option value="0">ì¼ì‹œë¶ˆ</option>
                                <option value="2">2ê°œì›”</option>
                                <option value="3">3ê°œì›”</option>
                                <option value="6">6ê°œì›”</option>
                                <option value="12">12ê°œì›”</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê²°ì œê¸ˆì•¡*</label><input type="number" name="amount" id="bro-pay-amount" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- ìž‘ì—… ì„ íƒ (ì„ íƒì‚¬í•­) -->
                <div>
                    <label class="block text-xs text-lime-400 mb-1">ì—°ê²° ìž‘ì—… (ì„ íƒ)</label>
                    <select name="work_id" id="bro-pay-work" class="input-field">
                        <option value="">ìž‘ì—… ì„ íƒ ì•ˆí•¨</option>
                    </select>
                </div>
                
                <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œ ë©”ëª¨</label><input name="memo" class="input-field" placeholder="ê²°ì œ ë‚´ìš© ë©”ëª¨"></div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('broCardPayModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ðŸ’³ ê²°ì œ ì‹¤í–‰</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê²°ì œ ì™„ë£Œ ======================= -->
    <div id="broPayCompleteModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:450px">
            <div class="text-center py-6">
                <div class="text-6xl mb-4">âœ…</div>
                <h2 class="text-2xl font-black text-emerald-400 mb-2">ê²°ì œ ì™„ë£Œ</h2>
                <div id="bro-pay-complete-info" class="text-gray-400"></div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4" id="bro-pay-receipt"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('broPayCompleteModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
                <button onclick="printBroReceipt()" class="btn-primary flex-1">ðŸ–¨ï¸ ì˜ìˆ˜ì¦ ì¶œë ¥</button>
            </div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¯¸ë‚© ê³ ê° ëª©ë¡ ======================= -->
    <div id="arrearsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">âš ï¸ ë¯¸ë‚© ê³ ê° ëª©ë¡</h2><button onclick="closeModal('arrearsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div class="mb-4 p-4 rounded-xl bg-orange-400/10 border border-orange-400/30">
                <div class="flex justify-between items-center">
                    <span class="text-orange-400 font-bold">ì´ ë¯¸ë‚© ê¸ˆì•¡</span>
                    <span class="text-2xl font-black text-orange-400" id="arrears-total-amount">â‚©0</span>
                </div>
            </div>
            <div class="glass-card rounded-xl overflow-hidden">
                <table class="data-table">
                    <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ë¯¸ë‚©ê¸ˆì•¡</th><th>ì—°ì²´ì¼</th><th>ìƒì„¸</th></tr></thead>
                    <tbody id="arrears-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¯¸ìˆ˜ê¸ˆ ìƒì„¸ ======================= -->
    <div id="arrearsDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">ðŸ“‹ ë¯¸ìˆ˜ê¸ˆ ìƒì„¸</h2><button onclick="closeModal('arrearsDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="arrears-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìˆ˜ë‚© ì²˜ë¦¬ ======================= -->
    <div id="paymentProcessModal" class="modal-overlay hidden" style="z-index: 9999;">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ’° ìˆ˜ë‚© ì²˜ë¦¬</h2><button onclick="closeModal('paymentProcessModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="pp-info" class="mb-4"></div>
            <form onsubmit="processPayment(event)" class="space-y-4">
                <input type="hidden" id="pp-contract-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ìˆ˜ë‚©ì¼*</label><input type="date" name="pay_date" id="pp-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìˆ˜ë‚©ê¸ˆì•¡*</label><input type="number" name="pay_amount" id="pp-amount" class="input-field" required></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ìˆ˜ë‚©ë°©ë²•*</label>
                    <select name="pay_method" class="input-field" required>
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><input type="text" name="pay_memo" class="input-field" placeholder="ë©”ëª¨ ìž…ë ¥..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('paymentProcessModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ìˆ˜ë‚© ì²˜ë¦¬</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìµœê·¼ ê²°ì œ ë‚´ì—­ ======================= -->
    <div id="recentPaymentsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ’³ ìµœê·¼ ê²°ì œ ë‚´ì—­</h2><button onclick="closeModal('recentPaymentsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="recent-payments-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ê³¼íƒœë£Œ ìƒì„¸ ======================= -->
    <div id="fineDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-red-400">ðŸš¨ ê³¼íƒœë£Œ ìƒì„¸</h2><button onclick="closeModal('fineDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="fine-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ê³¼íƒœë£Œ ë“±ë¡ ======================= -->
    <div id="fineModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4"><h2 id="fineModalTitle" class="text-xl font-bold text-red-400">ðŸš¨ ê³¼íƒœë£Œ ë“±ë¡</h2><button onclick="closeModal('fineModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitFine(event)" id="fineForm" class="space-y-4">
                <input type="hidden" id="fine-edit-id">
                
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-blue-400 mb-3">ðŸ“‹ ê³„ì•½ ì„ íƒ</div>
                    <select id="fine-contract-id" class="input-field" required onchange="onFineContractChange()">
                        <option value="">ê³„ì•½ ì„ íƒ...</option>
                    </select>
                    <div id="fine-contract-info" class="mt-2 p-2 rounded bg-white/5 text-sm hidden"></div>
                </div>
                
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-red-400 mb-3">ðŸš¨ ê³¼íƒœë£Œ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë°œìƒì¼*</label><input type="date" name="fine_date" id="fine-date" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì‚¬ìœ *</label><input name="fine_reason" id="fine-reason" class="input-field" required placeholder="ì˜ˆ: ì£¼ì •ì°¨ìœ„ë°˜, ê³¼ì†"></div>
                    </div>
                </div>
                
                <!-- ê¸°ê°„ë‚´ ê³¼íƒœë£Œ -->
                <div class="p-3 rounded-lg bg-orange-400/10 border border-orange-400/30">
                    <div class="text-xs text-orange-400 mb-3">ðŸ“… ê¸°ê°„ë‚´ ê³¼íƒœë£Œ</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê¸°ê°„ë‚´ ê¸ˆì•¡</label><input type="number" name="amount_in_period" id="fine-amount-in" class="input-field" placeholder="0" oninput="calcFineTotals()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë‚©ë¶€ê¸°í•œ</label><input type="date" name="due_date_in" id="fine-due-in" class="input-field" onchange="calcFineTotals()"></div>
                    </div>
                </div>
                
                <!-- ê¸°ê°„ì™¸ ê³¼íƒœë£Œ -->
                <div class="p-3 rounded-lg bg-red-400/10 border border-red-400/30">
                    <div class="text-xs text-red-400 mb-3">â° ê¸°ê°„ì™¸ ê³¼íƒœë£Œ</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê¸°ê°„ì™¸ ê¸ˆì•¡</label><input type="number" name="amount_out_period" id="fine-amount-out" class="input-field" placeholder="0" oninput="calcFineTotals()"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë‚©ë¶€ê¸°í•œ</label><input type="date" name="due_date_out" id="fine-due-out" class="input-field" onchange="calcFineTotals()"></div>
                    </div>
                </div>
                
                <!-- í˜„ìž¬ ë‚©ë¶€ê¸ˆì•¡ í‘œì‹œ -->
                <div class="p-3 rounded-lg bg-purple-400/10 border border-purple-400/30">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-purple-400 text-sm font-bold">ðŸ’° í˜„ìž¬ ë‚©ë¶€ê¸ˆì•¡</span>
                            <div class="text-xs text-gray-400" id="fine-due-status">ê¸°ê°„ë‚´</div>
                        </div>
                        <span class="text-xl font-black text-purple-400" id="fine-total-display">â‚©0</span>
                    </div>
                </div>
                
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë‚©ë¶€ìƒíƒœ</label>
                            <select name="fine_status" id="fine-paid-status" class="input-field">
                                <option value="unpaid">ë¯¸ë‚©</option>
                                <option value="paid">ë‚©ë¶€ì™„ë£Œ</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë‚©ë¶€ì¼</label><input type="date" name="paid_date" id="fine-paid-date" class="input-field"></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><textarea name="fine_memo" id="fine-memo" class="input-field" rows="2" placeholder="ì¶”ê°€ ë©”ëª¨..."></textarea></div>
                </div>
                
                <!-- ì˜ìˆ˜ì¦ ì—…ë¡œë“œ -->
                <div class="p-3 rounded-lg bg-cyan-400/10 border border-cyan-400/30">
                    <div class="text-xs text-cyan-400 mb-3">ðŸ§¾ ì˜ìˆ˜ì¦ ì²¨ë¶€</div>
                    <input type="file" id="fine-receipt" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                    <div id="fine-receipt-preview" class="mt-2 text-xs text-gray-400"></div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('fineModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="fineSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¹ ë¥¸ ìˆ˜ë‚© ======================= -->
    <div id="quickPaymentModal" class="modal-overlay hidden" style="z-index: 9999;">
        <div class="modal-content" style="max-width:400px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ’° ë¹ ë¥¸ ìˆ˜ë‚©</h2><button onclick="closeModal('quickPaymentModal')" class="text-gray-400 text-2xl">&times;</button></div>
            
            <input type="hidden" id="quick-payment-contract-id">
            
            <div class="p-3 rounded-lg bg-white/5 border border-white/10 mb-4">
                <div class="text-xs text-gray-400 mb-1">ê³„ì•½ ì •ë³´</div>
                <div class="font-bold text-lime-400" id="quick-payment-info">-</div>
            </div>
            
            <div class="p-3 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
                <div class="flex justify-between items-center">
                    <span class="text-orange-400 text-sm">í˜„ìž¬ ë¯¸ë‚©ê¸ˆ</span>
                    <span class="text-xl font-black text-orange-400" id="quick-payment-arrears">â‚©0</span>
                </div>
            </div>
            
            <div class="space-y-3 mb-4">
                <div class="text-xs text-gray-400">ìˆ˜ë‚© ë°©ë²• ì„ íƒ</div>
                
                <!-- ì „ì•¡ ìˆ˜ë‚© -->
                <button onclick="quickPayFull()" class="w-full p-3 rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-left hover:bg-emerald-500/30 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-emerald-400">âœ… ì „ì•¡ ìˆ˜ë‚©</div>
                            <div class="text-xs text-gray-400">ë¯¸ë‚©ê¸ˆ ì „ì•¡ ìˆ˜ë‚© ì²˜ë¦¬</div>
                        </div>
                        <span class="text-emerald-400 font-bold" id="quick-full-amount">â‚©0</span>
                    </div>
                </button>
                
                <!-- 1íšŒë¶„ ìˆ˜ë‚© -->
                <button onclick="quickPayOne()" class="w-full p-3 rounded-lg bg-blue-500/20 border border-blue-500/30 text-left hover:bg-blue-500/30 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-blue-400">ðŸ’µ 1íšŒë¶„ ìˆ˜ë‚©</div>
                            <div class="text-xs text-gray-400" id="quick-cycle-label">ì›”ë‚©ìž…ê¸ˆ 1íšŒë¶„</div>
                        </div>
                        <span class="text-blue-400 font-bold" id="quick-one-amount">â‚©0</span>
                    </div>
                </button>
                
                <!-- ì§ì ‘ ìž…ë ¥ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="font-bold text-gray-300 mb-2">âœï¸ ì§ì ‘ ìž…ë ¥</div>
                    <div class="flex gap-2">
                        <input type="number" id="quick-custom-amount" class="input-field flex-1" placeholder="ê¸ˆì•¡ ìž…ë ¥...">
                        <button onclick="quickPayCustom()" class="btn-primary px-4">ìˆ˜ë‚©</button>
                    </div>
                </div>
            </div>
            
            <button onclick="closeModal('quickPaymentModal')" class="btn-secondary w-full">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë‚©ìž… ë“±ë¡ ======================= -->
    <div id="paymentModal" class="modal-overlay hidden" style="z-index: 9999;">
        <div class="modal-content" style="max-width:400px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ’° ë‚©ìž… ë“±ë¡</h2><button onclick="closeModal('paymentModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitPayment(event)" id="paymentForm" class="space-y-4">
                <input type="hidden" id="pm-contract-id">
                
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-1">ê³„ì•½ ì •ë³´</div>
                    <div class="font-bold text-lime-400" id="pm-contract-info">-</div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-gray-400 mb-1">ë‚©ìž…ì¼*</label><input type="date" id="pm-date" class="input-field" required></div>
                    <div><label class="block text-xs text-gray-400 mb-1">ê¸ˆì•¡*</label><input type="number" id="pm-amount" class="input-field" required></div>
                </div>
                
                <div><label class="block text-xs text-gray-400 mb-1">ë‚©ìž… ìœ í˜•</label>
                    <select id="pm-type" class="input-field">
                        <option value="ì›”ë‚©">ì›”ë‚©</option>
                        <option value="ì¼ë‚©">ì¼ë‚©</option>
                        <option value="ë³´ì¦ê¸ˆ">ë³´ì¦ê¸ˆ</option>
                        <option value="ì—°ì²´ê¸ˆ">ì—°ì²´ê¸ˆ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                
                <div><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><input id="pm-memo" class="input-field" placeholder="ë©”ëª¨..."></div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('paymentModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ê³„ì•½ ë“±ë¡ ======================= -->
    <div id="contractModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4"><h2 id="contractModalTitle" class="text-xl font-bold text-lime-400">ðŸ“‹ ê³„ì•½ ë“±ë¡</h2><button onclick="closeModal('contractModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitContract(event)" id="contractForm" class="space-y-4">
                <input type="hidden" id="contract-edit-id">
                
                <!-- ê³„ì•½ ìœ í˜• -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <label class="block text-xs text-lime-400 mb-2">ê³„ì•½ ìœ í˜•*</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="contract_type" value="rent" checked class="accent-purple-500">
                            <span class="text-purple-400 font-bold">ðŸï¸ ë ŒíŠ¸</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="contract_type" value="lease" class="accent-pink-500">
                            <span class="text-pink-400 font-bold">ðŸ“„ ë¦¬ìŠ¤</span>
                        </label>
                    </div>
                </div>
                
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-blue-400 mb-3">ðŸ‘¤ ê³„ì•½ìž ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê³ ê°ëª…*</label><input name="customer_name" id="con-customer" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="con-phone" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- ì°¨ëŸ‰ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-emerald-400 mb-3">ðŸš— ì°¨ëŸ‰ ì •ë³´</div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-400 mb-1">ë“±ë¡ëœ ì°¨ëŸ‰ì—ì„œ ì„ íƒ</label>
                        <select id="con-vehicle-select" class="input-field" onchange="onContractVehicleSelect()">
                            <option value="">-- ì§ì ‘ ìž…ë ¥ ë˜ëŠ” ì„ íƒ --</option>
                        </select>
                    </div>
                    <div id="con-vehicle-info" class="mb-3 p-2 rounded bg-white/5 text-xs hidden"></div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰*</label><input name="vehicle" id="con-vehicle" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë²ˆí˜¸íŒ*</label><input name="plate" id="con-plate" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë£Œ*</label>
                            <select name="fuel_type" id="con-fuel" class="input-field" required>
                                <option value="íœ˜ë°œìœ ">íœ˜ë°œìœ </option>
                                <option value="ê²½ìœ ">ê²½ìœ </option>
                                <option value="LPG">LPG</option>
                                <option value="ì „ê¸°">ì „ê¸°</option>
                                <option value="í•˜ì´ë¸Œë¦¬ë“œ">í•˜ì´ë¸Œë¦¬ë“œ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ê³„ì•½ ì¡°ê±´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">ðŸ“… ê³„ì•½ ì¡°ê±´</div>
                    <div class="grid grid-cols-4 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´ì¦ê¸ˆ</label><input type="number" name="deposit" id="con-deposit" class="input-field" value="0"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë‚©ìž…ê¸ˆ*</label><input type="number" name="monthly" id="con-monthly" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³„ì•½ ì‹œìž‘ì¼*</label><input type="date" name="start_date" id="con-start" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³„ì•½ ì¢…ë£Œì¼*</label><input type="date" name="end_date" id="con-end" class="input-field" required></div>
                    </div>
                    
                    <!-- ê²°ì œ íƒ€ìž… -->
                    <div class="mt-3 p-2 rounded bg-white/5 border border-white/10">
                        <label class="block text-xs text-gray-400 mb-2">ê²°ì œ íƒ€ìž…*</label>
                        <div class="flex gap-4 items-center">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="payment_cycle" value="daily" class="accent-red-500" onchange="togglePaymentDay()">
                                <span class="text-red-400 font-bold text-sm">ðŸ“… ì¼ì •ì‚°</span>
                                <span class="text-gray-500 text-xs">(ë§¤ì¼)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="payment_cycle" value="weekly" class="accent-yellow-500" onchange="togglePaymentDay()">
                                <span class="text-yellow-400 font-bold text-sm">ðŸ“† ì£¼ì •ì‚°</span>
                                <span class="text-gray-500 text-xs">(7ì¼)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="payment_cycle" value="monthly" checked class="accent-blue-500" onchange="togglePaymentDay()">
                                <span class="text-blue-400 font-bold text-sm">ðŸ—“ï¸ ì›”ê²°ì œ</span>
                            </label>
                            <div id="payment-day-section" class="flex items-center gap-2">
                                <span class="text-gray-400 text-xs">ë‚©ìž…ì¼:</span>
                                <input type="number" name="payment_day" id="con-payment-day" class="input-field" style="width:60px" min="1" max="31" value="1">
                                <span class="text-gray-400 text-xs">ì¼</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê³„ì•½ ìƒíƒœ*</label>
                            <select name="status" id="con-status" class="input-field" required>
                                <option value="active">ì§„í–‰ì¤‘</option>
                                <option value="completed">ì¢…ë£Œ</option>
                                <option value="cancelled">í•´ì§€</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><input name="memo" id="con-memo" class="input-field" placeholder="ë©”ëª¨..."></div>
                    </div>
                </div>
                
                <!-- ì²¨ë¶€ìžë£Œ ì•ˆë‚´ -->
                <div id="doc-upload-notice" class="hidden p-3 rounded-lg bg-blue-400/10 border border-blue-400/30">
                    <div class="text-xs text-blue-400 font-bold mb-1">ðŸ“Œ ì²¨ë¶€ìžë£Œ ì•ˆë‚´</div>
                    <div class="text-xs text-gray-400">â€¢ ìƒˆ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ê¸°ì¡´ íŒŒì¼ì´ <span class="text-yellow-400">êµì²´</span>ë©ë‹ˆë‹¤</div>
                    <div class="text-xs text-gray-400">â€¢ íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ì´ <span class="text-lime-400">ìœ ì§€</span>ë©ë‹ˆë‹¤</div>
                    <div id="existing-docs-list" class="mt-2 pt-2 border-t border-white/10"></div>
                </div>
                
                <!-- ê³„ì•½ìž ì„œë¥˜ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">ðŸ“Ž ê³„ì•½ìž ì„œë¥˜</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ì‹ ë¶„ì¦</label>
                            <input type="file" name="contractor_id" id="con-contractor-id" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            <div id="con-contractor-id-preview" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ê¸°íƒ€ì„œë¥˜</label>
                            <input type="file" name="contractor_doc" id="con-contractor-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            <div id="con-contractor-doc-preview" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ì—°ëŒ€ë³´ì¦ì¸ (ì„ íƒ) -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="con-has-guarantor" onchange="toggleGuarantor()" class="accent-lime-500">
                        <label class="text-xs text-yellow-400 cursor-pointer" for="con-has-guarantor">ðŸ‘¥ ì—°ëŒ€ë³´ì¦ì¸ ì¶”ê°€</label>
                    </div>
                    <div id="guarantor-section" class="hidden space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ì´ë¦„</label><input name="guarantor_name" id="con-guarantor-name" class="input-field"></div>
                            <div><label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ì—°ë½ì²˜</label><input name="guarantor_phone" id="con-guarantor-phone" class="input-field"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ì‹ ë¶„ì¦</label>
                                <input type="file" name="guarantor_id" id="con-guarantor-id" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ê¸°íƒ€ì„œë¥˜</label>
                                <input type="file" name="guarantor_doc" id="con-guarantor-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì°¨ëŸ‰ ì„œë¥˜ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-purple-400 mb-3">ðŸš— ì°¨ëŸ‰ ì„œë¥˜</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰ë“±ë¡ì¦</label>
                            <input type="file" name="vehicle_reg" id="con-vehicle-reg" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">íì§€ì„œë¥˜</label>
                            <input type="file" name="vehicle_disposal" id="con-vehicle-disposal" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ê¸°íƒ€ì„œë¥˜</label>
                            <input type="file" name="vehicle_doc" id="con-vehicle-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('contractModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="contractSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ê³„ì•½ ìƒì„¸ ======================= -->
    <div id="contractDetailModal" class="modal-overlay hidden" style="z-index: 200;">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ“‹ ê³„ì•½ ìƒì„¸</h2><button onclick="closeModal('contractDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="contract-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì°¨ëŸ‰ ë“±ë¡ ======================= -->
    <div id="vehicleModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4"><h2 id="vehicleModalTitle" class="text-xl font-bold text-lime-400">ðŸš— ì°¨ëŸ‰ ë“±ë¡</h2><button onclick="closeModal('vehicleModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitVehicle(event)" id="vehicleForm" class="space-y-4">
                <input type="hidden" id="vehicle-edit-id">
                
                <!-- ì°¨ëŸ‰ ìœ í˜• -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <label class="block text-xs text-lime-400 mb-2">ì°¨ëŸ‰ ìœ í˜•*</label>
                    <div class="flex gap-4 flex-wrap">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="vehicle_type" value="motorcycle" checked class="accent-orange-500">
                            <span class="text-orange-400 font-bold">ðŸï¸ ì´ë¥œì°¨</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="vehicle_type" value="car" class="accent-blue-500">
                            <span class="text-blue-400 font-bold">ðŸš— ìžë™ì°¨</span>
                        </label>
                    </div>
                </div>
                
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">ðŸš— ê¸°ë³¸ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë²ˆí˜¸íŒ*</label><input name="plate" id="veh-plate" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ëª¨ë¸*</label><input name="model" id="veh-model" class="input-field" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ì‹</label><input type="number" name="year" id="veh-year" class="input-field" value="2024"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒ‰ìƒ</label><input name="color" id="veh-color" class="input-field"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì£¼í–‰ê±°ë¦¬</label><input type="number" name="mileage" id="veh-mileage" class="input-field" value="0"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë£Œ</label>
                            <select name="fuel_type" id="veh-fuel" class="input-field">
                                <option value="íœ˜ë°œìœ ">íœ˜ë°œìœ </option>
                                <option value="ê²½ìœ ">ê²½ìœ </option>
                                <option value="LPG">LPG</option>
                                <option value="ì „ê¸°">ì „ê¸°</option>
                                <option value="í•˜ì´ë¸Œë¦¬ë“œ">í•˜ì´ë¸Œë¦¬ë“œ</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŒ€ë²ˆí˜¸</label><input name="vin" id="veh-vin" class="input-field" placeholder="VIN"></div>
                    </div>
                </div>
                
                <!-- ë³´í—˜ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-blue-400/10 border border-blue-400/30">
                    <div class="text-xs text-blue-400 mb-3">ðŸ›¡ï¸ ë³´í—˜ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ì‚¬</label>
                            <select name="insurance" id="veh-insurance" class="input-field">
                                <option value="">ì„ íƒ</option>
                                <option value="ì‚¼ì„±í™”ìž¬">ì‚¼ì„±í™”ìž¬</option>
                                <option value="í˜„ëŒ€í•´ìƒ">í˜„ëŒ€í•´ìƒ</option>
                                <option value="DBì†í•´ë³´í—˜">DBì†í•´ë³´í—˜</option>
                                <option value="KBì†í•´ë³´í—˜">KBì†í•´ë³´í—˜</option>
                                <option value="ë©”ë¦¬ì¸ í™”ìž¬">ë©”ë¦¬ì¸ í™”ìž¬</option>
                                <option value="í•œí™”ì†í•´ë³´í—˜">í•œí™”ì†í•´ë³´í—˜</option>
                                <option value="ë¡¯ë°ì†í•´ë³´í—˜">ë¡¯ë°ì†í•´ë³´í—˜</option>
                                <option value="í¥êµ­í™”ìž¬">í¥êµ­í™”ìž¬</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ë§Œë£Œì¼</label><input type="date" name="insurance_expiry" id="veh-ins-expiry" class="input-field"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ì¦ê¶Œë²ˆí˜¸</label><input name="insurance_no" id="veh-ins-no" class="input-field"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë³´í—˜ë£Œ (ì›”)</label><input type="number" name="insurance_fee" id="veh-ins-fee" class="input-field" value="0"></div>
                    </div>
                </div>
                
                <!-- ì •ë¹„ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-orange-400/10 border border-orange-400/30">
                    <div class="text-xs text-orange-400 mb-3">ðŸ”§ ì •ë¹„ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ìµœê·¼ ì •ë¹„ì¼</label><input type="date" name="last_maintenance" id="veh-last-maint" class="input-field"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë‹¤ìŒ ì •ë¹„ì˜ˆì •ì¼</label><input type="date" name="next_maintenance" id="veh-next-maint" class="input-field"></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ì •ë¹„ ë‚´ì—­</label><textarea name="maintenance_history" id="veh-maint-history" class="input-field" rows="2" placeholder="ì˜ˆ: 2024-01-15 ì—”ì§„ì˜¤ì¼ êµí™˜, 2024-02-20 íƒ€ì´ì–´ êµì²´"></textarea></div>
                </div>
                
                <!-- ì„œë¥˜ ì²¨ë¶€ -->
                <div class="p-3 rounded-lg bg-purple-400/10 border border-purple-400/30">
                    <div class="text-xs text-purple-400 mb-3">ðŸ“Ž ì„œë¥˜ ì²¨ë¶€</div>
                    <div id="veh-doc-notice" class="hidden mb-3 p-2 rounded bg-yellow-400/10 border border-yellow-400/30">
                        <div class="text-xs text-yellow-400">âš ï¸ ê¸°ì¡´ íŒŒì¼ì´ ìžˆìŠµë‹ˆë‹¤. ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ êµì²´ë©ë‹ˆë‹¤.</div>
                        <div id="veh-existing-docs" class="mt-2 text-xs text-gray-400"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰ë“±ë¡ì¦</label>
                            <input type="file" id="veh-reg-file" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ë³´í—˜ì¦ì„œ</label>
                            <input type="file" id="veh-ins-file" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
                
                <!-- ê¸°íƒ€ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-gray-400 mb-3">ðŸ“ ê¸°íƒ€</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì·¨ë“ì¼</label><input type="date" name="purchase_date" id="veh-purchase-date" class="input-field"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì·¨ë“ê°€</label><input type="number" name="purchase_price" id="veh-purchase-price" class="input-field" value="0"></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="veh-memo" class="input-field" rows="2"></textarea></div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('vehicleModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="vehicleSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì°¨ëŸ‰ ìƒì„¸ ======================= -->
    <div id="vehicleDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸš— ì°¨ëŸ‰ ìƒì„¸</h2><button onclick="closeModal('vehicleDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="vehicle-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: PG ì¹´ë“œ ë“±ë¡ ======================= -->
    <div id="pgModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 id="pgModalTitle" class="text-xl font-bold text-lime-400">ðŸ’³ ìžë™ê²°ì œ ì¹´ë“œ ë“±ë¡</h2><button onclick="closeModal('pgModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitPgCard(event)" id="pgForm" class="space-y-4">
                <input type="hidden" id="pg-edit-id">
                <div><label class="block text-xs text-lime-400 mb-1">ê³„ì•½ ì„ íƒ*</label>
                    <select name="contract_id" id="pg-contract" class="input-field" required onchange="onPgContractChange(this)">
                        <option value="">ê³„ì•½ ì„ íƒ</option>
                    </select>
                </div>
                
                <!-- ì¹´ë“œ ì†Œìœ ìž ì •ë³´ -->
                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 font-bold mb-3">ðŸ‘¤ ì¹´ë“œ ì†Œìœ ìž ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œ ì†Œìœ ìžëª…*</label><input name="card_holder" id="pg-card-holder" class="input-field" placeholder="í™ê¸¸ë™" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒë…„ì›”ì¼ (6ìžë¦¬)*</label><input name="birth_date" id="pg-birth-date" class="input-field" placeholder="990101" maxlength="6" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë½ì²˜*</label><input name="card_phone" id="pg-card-phone" class="input-field" placeholder="010-1234-5678" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì´ë©”ì¼</label><input type="email" name="card_email" id="pg-card-email" class="input-field" placeholder="email@example.com"></div>
                    </div>
                </div>
                
                <!-- ì¹´ë“œ ì •ë³´ -->
                <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20">
                    <div class="text-xs text-blue-400 font-bold mb-3">ðŸ’³ ì¹´ë“œ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œë²ˆí˜¸*</label><input name="card_no" id="pg-card-no" class="input-field" placeholder="0000-0000-0000-0000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìœ íš¨ê¸°ê°„*</label><input name="expiry" id="pg-expiry" class="input-field" placeholder="MM/YY" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">CVC*</label><input name="cvc" id="pg-cvc" type="password" class="input-field" placeholder="000" maxlength="4" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œ ë¹„ë°€ë²ˆí˜¸ ì•ž2ìžë¦¬*</label><input name="card_pw" id="pg-card-pw" type="password" class="input-field" placeholder="**" maxlength="2" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œì‚¬</label>
                            <select name="card_company" id="pg-card-company" class="input-field">
                                <option value="">ì„ íƒ</option>
                                <option value="ì‚¼ì„±">ì‚¼ì„±ì¹´ë“œ</option>
                                <option value="í˜„ëŒ€">í˜„ëŒ€ì¹´ë“œ</option>
                                <option value="KB">KBêµ­ë¯¼ì¹´ë“œ</option>
                                <option value="ì‹ í•œ">ì‹ í•œì¹´ë“œ</option>
                                <option value="ë¡¯ë°">ë¡¯ë°ì¹´ë“œ</option>
                                <option value="í•˜ë‚˜">í•˜ë‚˜ì¹´ë“œ</option>
                                <option value="ìš°ë¦¬">ìš°ë¦¬ì¹´ë“œ</option>
                                <option value="NH">NHë†í˜‘ì¹´ë“œ</option>
                                <option value="BC">BCì¹´ë“œ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ê²°ì œ ì„¤ì • -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œê¸ˆì•¡*</label><input type="number" name="amount" id="pg-amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì¹´ë“œìƒíƒœ</label>
                        <select name="card_status" id="pg-card-status" class="input-field">
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œ íƒ€ìž…*</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="daily" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">ì¼ì¼ê²°ì œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="weekly" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">ì£¼ì¼ê²°ì œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="monthly" onchange="togglePayOption(this.value)" class="accent-lime-400" checked>
                            <span class="text-sm">ì›”ê²°ì œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="custom" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">ë‚ ì§œì§€ì •</span>
                        </label>
                    </div>
                </div>
                <div id="pg-option-daily" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">ë§¤ì¼ ê²°ì œ ì‹œê°„</label>
                    <select name="pay_hour" id="pg-pay-hour" class="input-field">
                        <option value="9">ì˜¤ì „ 9ì‹œ</option>
                        <option value="12">ì˜¤í›„ 12ì‹œ</option>
                        <option value="18">ì˜¤í›„ 6ì‹œ</option>
                    </select>
                </div>
                <div id="pg-option-weekly" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">ë§¤ì£¼ ê²°ì œ ìš”ì¼</label>
                    <select name="pay_weekday" id="pg-pay-weekday" class="input-field">
                        <option value="1">ì›”ìš”ì¼</option>
                        <option value="2">í™”ìš”ì¼</option>
                        <option value="3">ìˆ˜ìš”ì¼</option>
                        <option value="4">ëª©ìš”ì¼</option>
                        <option value="5">ê¸ˆìš”ì¼</option>
                    </select>
                </div>
                <div id="pg-option-monthly">
                    <label class="block text-xs text-lime-400 mb-1">ë§¤ì›” ê²°ì œì¼</label>
                    <select name="pay_day" id="pg-pay-day" class="input-field">
                        <option value="1">ë§¤ì›” 1ì¼</option>
                        <option value="5">ë§¤ì›” 5ì¼</option>
                        <option value="10">ë§¤ì›” 10ì¼</option>
                        <option value="15">ë§¤ì›” 15ì¼</option>
                        <option value="20">ë§¤ì›” 20ì¼</option>
                        <option value="25">ë§¤ì›” 25ì¼</option>
                    </select>
                </div>
                <div id="pg-option-custom" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">ê²°ì œ ì‹œìž‘ì¼</label>
                    <input type="date" name="pay_date" id="pg-pay-date" class="input-field">
                </div>
                
                <div class="p-3 rounded-lg bg-yellow-400/10 border border-yellow-400/30 text-xs text-yellow-400">
                    âš ï¸ ì¹´ë“œ ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì €ìž¥ë©ë‹ˆë‹¤. ë“±ë¡ í›„ ìžë™ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('pgModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="pgSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: PG ì¹´ë“œ ìƒì„¸ ======================= -->
    <div id="pgDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ’³ ì¹´ë“œ ìƒì„¸ ì •ë³´</h2><button onclick="closeModal('pgDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="pg-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìˆ˜ë™ ê²°ì œ ======================= -->
    <div id="manualPayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ’° ìˆ˜ë™ ê²°ì œ ì‹¤í–‰</h2><button onclick="closeModal('manualPayModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="manual-pay-info" class="mb-4"></div>
            <form onsubmit="executeManualPayment(event)" class="space-y-4">
                <input type="hidden" id="manual-pay-pg-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œê¸ˆì•¡*</label><input type="number" name="amount" id="manual-pay-amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œì¼*</label><input type="date" name="pay_date" id="manual-pay-date" class="input-field" required></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><input type="text" name="memo" class="input-field" placeholder="ê²°ì œ ë©”ëª¨..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('manualPayModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ðŸ’³ ê²°ì œ ì‹¤í–‰</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì›ìž¥ ë‚´ì—­ ë“±ë¡ ======================= -->
    <div id="ledgerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ðŸ“ ì›ìž¥ ë‚´ì—­ ë“±ë¡</h2><button onclick="closeModal('ledgerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitLedgerEntry(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì¼ìž*</label><input type="date" name="date" id="ledger-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ê³„ì•½ ì„ íƒ*</label>
                        <select name="contract_id" id="ledger-contract-select" class="input-field" required>
                            <option value="">ê³„ì•½ ì„ íƒ</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">êµ¬ë¶„*</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="accrual" class="accent-lime-400" checked>
                            <span class="text-sm">ë°œìƒ(ì²­êµ¬)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="receipt" class="accent-lime-400">
                            <span class="text-sm">ìˆ˜ë‚©(ìž…ê¸ˆ)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="adjust" class="accent-lime-400">
                            <span class="text-sm">ì¡°ì •</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê¸ˆì•¡*</label><input type="number" name="amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œë°©ë²•</label>
                        <select name="method" class="input-field">
                            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                            <option value="ì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="PG">PG(ìžë™ê²°ì œ)</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë‚´ìš©</label><input type="text" name="desc" class="input-field" placeholder="ë‚´ìš© ìž…ë ¥..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('ledgerModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì´ë²ˆë‹¬ ìˆ˜ë‚© ìƒì„¸ ======================= -->
    <div id="monthlyReceiptModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">âœ… ì´ë²ˆë‹¬ ìˆ˜ë‚© í˜„í™©</h2><button onclick="closeModal('monthlyReceiptModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="monthly-receipt-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì›” ì •ì‚°ê¸ˆì•¡ ìƒì„¸ ======================= -->
    <div id="monthlyRevenueModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ðŸ’° ì›” ì •ì‚°ê¸ˆì•¡ í˜„í™©</h2><button onclick="closeModal('monthlyRevenueModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="monthly-revenue-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¯¸ìˆ˜ê¸ˆ ëª©ë¡ ======================= -->
    <div id="unpaidListModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">âš ï¸ ë¯¸ìˆ˜ê¸ˆ í˜„í™©</h2><button onclick="closeModal('unpaidListModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="unpaid-list-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìˆ˜ë‚©ë¥  ìƒì„¸ ======================= -->
    <div id="collectionRateModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-purple-400">ðŸ“Š ìˆ˜ë‚©ë¥  ìƒì„¸ ë¶„ì„</h2><button onclick="closeModal('collectionRateModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="collection-rate-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì—°ì²´ ê´€ë¦¬ ======================= -->
    <div id="delActionModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">ðŸ“ž ì—°ì²´ ê´€ë¦¬</h2><button onclick="closeModal('delActionModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="del-action-content"></div>
        </div>
    </div>

<script>
// ======================= Supabase ì„¤ì • =======================
const SUPABASE_URL = 'https://jizaefuhiikpkcxolibc.supabase.co';
const SUPABASE_KEY = 'sb_publishable_GmXxpaZB2wffSDKJn5P1kg_22B7VGpD';

// Supabase API í˜¸ì¶œ í•¨ìˆ˜
async function supabaseCall(table, method = 'GET', data = null, query = '') {
    const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
    const options = {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'
        }
    };
    if (data && (method === 'POST' || method === 'PATCH')) {
        options.body = JSON.stringify(data);
    }
    try {
        const res = await fetch(url, options);
        if (!res.ok) {
            const errorText = await res.text();
            console.error(`Supabase ${method} ${table} error:`, res.status, errorText);
            throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        if (method === 'DELETE') return true;
        const text = await res.text();
        return text ? JSON.parse(text) : [];
    } catch (e) {
        console.error('Supabase error:', e);
        return null;
    }
}

// ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤
async function loadFromDB(table) {
    return await supabaseCall(table, 'GET', null, '?order=id.desc');
}

async function insertToDB(table, data) {
    return await supabaseCall(table, 'POST', data);
}

async function updateInDB(table, id, data) {
    return await supabaseCall(table, 'PATCH', data, `?id=eq.${id}`);
}

async function deleteFromDB(table, id) {
    return await supabaseCall(table, 'DELETE', null, `?id=eq.${id}`);
}

// ======================= ì „ì—­ ë³€ìˆ˜ =======================
const APP_VERSION = '1.29';
let currentSystem = null; // null = ì„ íƒ ì•ˆ ë¨
let currentUser = null;
let currentTab = 'overview'; // í˜„ìž¬ íƒ­

// ë°ì´í„° ë°°ì—´ (DBì—ì„œ ë¡œë“œ)
let staffList = [];
let customerList = [];
let contractList = [];
let arrearsDetailList = [];
let recentPayments = [];
let pgPaymentsList = [];
let paymentHistory = [];
let ledgerList = [];
let vehicleList = [];
let fineList = [];
let broWorkList = [];
let broCashbookList = [];
let broPartsList = [];
let broCustList = [];

// ======================= ìœ í‹¸ë¦¬í‹° =======================
const fmt = n => 'â‚©' + (n||0).toLocaleString();
const roleBadge = r => ({admin:['badge-admin','ê´€ë¦¬ìž'],manager:['badge-manager','ë§¤ë‹ˆì €'],staff:['badge-staff','ì¼ë°˜']}[r]||['','']);
const statusBadge = s => s==='active'?['badge-active','í™œì„±']:['badge-failed','ë¹„í™œì„±'];
const gradeBadge = g => ({ 'ìƒ': ['badge-active', 'ìƒ'], 'ì¤‘': ['badge-completed', 'ì¤‘'], 'í•˜': ['badge-failed', 'í•˜'] }[g] || ['badge-staff', '-']);

function showToast(msg, type = 'success') {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast toast-${type}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ======================= ë¡œê·¸ì¸ =======================
function selectSystem(system) {
    document.querySelectorAll('.system-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('card-' + system).classList.add('selected');
    currentSystem = system;
    // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¹€
    document.getElementById('systemError').classList.add('hidden');
}

async function handleLogin(e) {
    e.preventDefault();
    
    // ì‹œìŠ¤í…œ ì„ íƒ í™•ì¸
    if (!currentSystem) {
        document.getElementById('systemError').classList.remove('hidden');
        return;
    }
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    // DBì—ì„œ ì§ì› ì •ë³´ í™•ì¸ (íŠ¹ìˆ˜ë¬¸ìž ì¸ì½”ë”©)
    const encodedUsername = encodeURIComponent(username);
    const encodedPassword = encodeURIComponent(password);
    const users = await supabaseCall('staff', 'GET', null, `?username=eq.${encodedUsername}&password=eq.${encodedPassword}`);
    
    if (users && users.length > 0) {
        const user = users[0];
        currentUser = user;
        
        // ì„¸ì…˜ ì €ìž¥
        const sessionData = {
            userId: user.id,
            system: currentSystem,
            tab: 'overview',
            timestamp: Date.now()
        };
        sessionStorage.setItem('teambro_session', JSON.stringify(sessionData));
        console.log('ðŸ’¾ ì„¸ì…˜ ì €ìž¥ ì™„ë£Œ:', sessionData);
        
        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        await loadAllData();
        
        document.getElementById('loginPage').classList.add('hidden');
        
        // ì„ íƒí•œ ì‹œìŠ¤í…œìœ¼ë¡œ ì´ë™
        if (currentSystem === 'settlement') {
            document.getElementById('settlementSystem').classList.remove('hidden');
            document.getElementById('s-userName').textContent = user.name;
            document.getElementById('s-userRole').textContent = roleBadge(user.role)[1];
            renderStaffList();
            initDates();
            // ì •ì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            loadSettlementDashboard();
        } else {
            document.getElementById('bromotorsSystem').classList.remove('hidden');
            document.getElementById('b-userName').textContent = user.name;
            document.getElementById('b-userRole').textContent = roleBadge(user.role)[1];
            initDates();
            // ë¸Œë¡œëª¨í„°ìŠ¤ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            loadBroDashboard();
        }
        
        showToast(`${user.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
    } else {
        document.getElementById('loginError').textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        document.getElementById('loginError').classList.remove('hidden');
    }
}

// ëª¨ë“  ë°ì´í„° ë¡œë“œ
async function loadAllData() {
    showToast('ë°ì´í„° ë¡œë”© ì¤‘...', 'info');
    
    const [staff, customers, contracts, vehicles, ledger, pgPayments, works, cashbook, parts, broCustomers, accidents, purchases, fines, contractPayments] = await Promise.all([
        loadFromDB('staff'),
        loadFromDB('customers'),
        loadFromDB('contracts'),
        loadFromDB('vehicles'),
        loadFromDB('ledger'),
        loadFromDB('pg_payments'),
        loadFromDB('bro_works'),
        loadFromDB('bro_cashbook'),
        loadFromDB('bro_parts'),
        loadFromDB('bro_customers'),
        loadFromDB('bro_accidents'),
        loadFromDB('bro_purchases'),
        loadFromDB('fines'),
        loadFromDB('contract_payments')
    ]);
    
    staffList = staff || [];
    customerList = customers || [];
    contractList = contracts || [];
    vehicleList = vehicles || [];
    ledgerList = (ledger || []).map(l => ({...l, desc: l.description}));
    pgPaymentsList = pgPayments || [];
    broWorkList = works || [];
    broCashbookList = cashbook || [];
    broPartsList = parts || [];
    broCustList = broCustomers || [];
    accidentList = accidents || [];
    purchaseList = purchases || [];
    fineList = fines || [];
    contractPaymentList = contractPayments || [];
    
    // ì—°ì²´ì¼ ê³„ì‚° (ë¯¸ìˆ˜ê¸ˆ ìžˆëŠ” ê³„ì•½ì— ëŒ€í•´)
    calculateDelinquentDays();
    
    // recentPaymentsëŠ” ledgerì—ì„œ ì¶”ì¶œ
    recentPayments = ledgerList.filter(l => l.type === 'receipt').slice(0, 5).map((l, i) => ({
        id: i + 1,
        customer_name: l.customer_name,
        amount: l.receipt,
        date: l.date,
        time: '09:00'
    }));
}

// ì—°ì²´ì¼ ê³„ì‚° í•¨ìˆ˜
function calculateDelinquentDays() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const todayDate = new Date(today + 'T00:00:00');
    
    contractList.forEach(c => {
        // ë¯¸ìˆ˜ê¸ˆì´ ì—†ìœ¼ë©´ ì—°ì²´ì¼ 0
        if (!c.arrears || c.arrears <= 0) {
            c.delinquent_days = 0;
            return;
        }
        
        // ì‹œìž‘ì¼ì´ ì—†ìœ¼ë©´ ì œì™¸
        if (!c.start_date) {
            c.delinquent_days = 0;
            return;
        }
        
        const startDate = new Date(c.start_date + 'T00:00:00');
        const cycle = c.payment_cycle || 'monthly';
        
        const paidPayments = contractPaymentList.filter(p => 
            p.contract_id === c.id && p.status === 'paid'
        ).sort((a, b) => (b.payment_date || '').localeCompare(a.payment_date || ''));
        
        let lastPaymentDate = paidPayments.length > 0 ? paidPayments[0].payment_date : null;
        let overdueStartDate;
        
        if (cycle === 'daily') {
            if (lastPaymentDate) {
                const lastDate = new Date(lastPaymentDate + 'T00:00:00');
                lastDate.setDate(lastDate.getDate() + 1);
                overdueStartDate = lastDate.toISOString().split('T')[0];
            } else {
                overdueStartDate = c.start_date;
            }
        } else if (cycle === 'weekly') {
            if (lastPaymentDate) {
                const lastDate = new Date(lastPaymentDate + 'T00:00:00');
                lastDate.setDate(lastDate.getDate() + 7);
                overdueStartDate = lastDate.toISOString().split('T')[0];
            } else {
                overdueStartDate = c.start_date;
            }
        } else {
            const paymentDay = c.payment_day || startDate.getDate();
            
            if (lastPaymentDate) {
                const [y, m] = lastPaymentDate.substring(0, 7).split('-').map(Number);
                const nextMonth = m === 12 ? `${y + 1}-01` : `${y}-${String(m + 1).padStart(2, '0')}`;
                overdueStartDate = `${nextMonth}-${String(paymentDay).padStart(2, '0')}`;
            } else {
                const startY = startDate.getFullYear();
                const startM = startDate.getMonth() + 1;
                const startD = startDate.getDate();
                
                if (startD <= paymentDay) {
                    overdueStartDate = `${startY}-${String(startM).padStart(2, '0')}-${String(paymentDay).padStart(2, '0')}`;
                } else {
                    const nextM = startM === 12 ? 1 : startM + 1;
                    const nextY = startM === 12 ? startY + 1 : startY;
                    overdueStartDate = `${nextY}-${String(nextM).padStart(2, '0')}-${String(paymentDay).padStart(2, '0')}`;
                }
            }
        }
        
        if (overdueStartDate && today >= overdueStartDate) {
            const overdueDateObj = new Date(overdueStartDate + 'T00:00:00');
            const diffTime = todayDate.getTime() - overdueDateObj.getTime();
            c.delinquent_days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        } else {
            c.delinquent_days = 0;
        }
    });
}

// ë‚ ì§œ ì´ˆê¸°í™” í•¨ìˆ˜
function initDates() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const today = `${year}-${month}-${day}`;
    const todayKor = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // í—¤ë” ë‚ ì§œ í‘œì‹œ
    if (document.getElementById('s-today-date')) document.getElementById('s-today-date').textContent = todayKor;
    if (document.getElementById('b-today-date')) document.getElementById('b-today-date').textContent = todayKor;
    
    // ëª¨ë“  date input ê¸°ë³¸ê°’ ì„¤ì •
    document.querySelectorAll('input[type="date"]').forEach(el => {
        if (!el.value) el.value = today;
    });
    
    // month input ê¸°ë³¸ê°’ ì„¤ì •
    document.querySelectorAll('input[type="month"]').forEach(el => {
        if (!el.value) el.value = `${year}-${month}`;
    });
}

function handleLogout() {
    currentUser = null;
    sessionStorage.removeItem('teambro_session');
    location.reload();
}

// ì°¸ê³ : ì´ì „ì—ëŠ” beforeunloadì—ì„œ ì„¸ì…˜ì„ ì‚­ì œí–ˆìœ¼ë‚˜,
// ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ì„¸ì…˜ì´ ì‚­ì œë˜ëŠ” ë¬¸ì œê°€ ìžˆì–´ ì œê±°í•¨.
// ì„¸ì…˜ì€ 24ì‹œê°„ ë§Œë£Œ ë˜ëŠ” ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ìžë™ ì‚­ì œë¨ (sessionStorage íŠ¹ì„±)

// ì„¸ì…˜ì— í˜„ìž¬ íƒ­ ì €ìž¥
function updateSessionTab(system, tab) {
    const sessionData = sessionStorage.getItem('teambro_session');
    if (!sessionData) return;
    
    try {
        const session = JSON.parse(sessionData);
        session.system = system;
        session.tab = tab;
        session.timestamp = Date.now();
        sessionStorage.setItem('teambro_session', JSON.stringify(session));
    } catch (e) {
        console.error('ì„¸ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
    }
}

// ======================= ì‹œìŠ¤í…œ ì „í™˜ =======================
function switchSystem() {
    if (currentSystem === 'settlement') {
        document.getElementById('settlementSystem').classList.add('hidden');
        document.getElementById('bromotorsSystem').classList.remove('hidden');
        document.getElementById('b-userName').textContent = currentUser.name;
        document.getElementById('b-userRole').textContent = roleBadge(currentUser.role)[1];
        currentSystem = 'bromotors';
        showBromotorsTab('overview');
    } else {
        document.getElementById('bromotorsSystem').classList.add('hidden');
        document.getElementById('settlementSystem').classList.remove('hidden');
        document.getElementById('s-userName').textContent = currentUser.name;
        document.getElementById('s-userRole').textContent = roleBadge(currentUser.role)[1];
        currentSystem = 'settlement';
        showSettlementTab('overview');
    }
}

function goToSettlementSettings() {
    document.getElementById('bromotorsSystem').classList.add('hidden');
    document.getElementById('settlementSystem').classList.remove('hidden');
    currentSystem = 'settlement';
    showSettlementTab('settings');
}

// ======================= ì •ì‚°ê´€ë¦¬ íƒ­ =======================
function showSettlementTab(name, skipHistory = false) {
    document.querySelectorAll('[id^="s-tab-"]').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
    document.getElementById('s-tab-' + name).classList.add('tab-active');
    document.getElementById('s-tab-' + name).classList.remove('text-gray-500');
    document.querySelectorAll('.s-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('s-content-' + name).classList.remove('hidden');
    
    // ížˆìŠ¤í† ë¦¬ ê´€ë¦¬
    if (!skipHistory) {
        history.pushState({ system: 'settlement', tab: name }, '', `#s-${name}`);
    }
    currentTab = name;
    
    // ì„¸ì…˜ì— í˜„ìž¬ íƒ­ ì €ìž¥
    updateSessionTab('settlement', name);
    
    if (name === 'overview') loadOverview();
    if (name === 'contracts') loadContracts();
    if (name === 'vehicles') loadVehicles();
    if (name === 'customers') loadCustomers();
    if (name === 'charges') loadPgPayments();
    if (name === 'ledger') loadLedger();
    if (name === 'fines') { initFinePeriod(); loadFines(); }
    if (name === 'delinquent') loadDelinquent();
    if (name === 'settings') renderStaffList();
}

function showSettingTab(name, el) {
    document.querySelectorAll('.setting-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.setting-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('setting-' + name).classList.remove('hidden');
    
    if (name === 'pg') loadPgSettings();
}

// ======================= PG ì„¤ì • =======================
let pgSettings = {
    provider: 'nicepay',
    mid: '',
    merchantKey: '',
    secretKey: '',
    apiUrl: 'https://api.nicepay.co.kr/v1/payments',
    cancelUrl: 'https://api.nicepay.co.kr/v1/payments/cancel',
    billingUrl: 'https://api.nicepay.co.kr/v1/subscribe/regist',
    mode: 'test',
    timeout: 30,
    billingEnabled: true,
    defaultPayDay: 10,
    payTime: '09',
    retryCount: 3,
    retryInterval: 2,
    webhookUrl: '',
    webhookSuccess: true,
    webhookFail: true
};

const pgProviderInfo = {
    nicepay: {
        name: 'ë‚˜ì´ìŠ¤íŽ˜ì´',
        apiUrl: 'https://api.nicepay.co.kr/v1/payments',
        cancelUrl: 'https://api.nicepay.co.kr/v1/payments/cancel',
        billingUrl: 'https://api.nicepay.co.kr/v1/subscribe/regist',
        docsUrl: 'https://developers.nicepay.co.kr'
    },
    inicis: {
        name: 'KGì´ë‹ˆì‹œìŠ¤',
        apiUrl: 'https://iniapi.inicis.com/api/v1/pay',
        cancelUrl: 'https://iniapi.inicis.com/api/v1/cancel',
        billingUrl: 'https://iniapi.inicis.com/api/v1/billing',
        docsUrl: 'https://manual.inicis.com'
    },
    toss: {
        name: 'í† ìŠ¤íŽ˜ì´ë¨¼ì¸ ',
        apiUrl: 'https://api.tosspayments.com/v1/payments',
        cancelUrl: 'https://api.tosspayments.com/v1/payments/cancel',
        billingUrl: 'https://api.tosspayments.com/v1/billing/authorizations',
        docsUrl: 'https://docs.tosspayments.com'
    },
    kakao: {
        name: 'ì¹´ì¹´ì˜¤íŽ˜ì´',
        apiUrl: 'https://kapi.kakao.com/v1/payment/ready',
        cancelUrl: 'https://kapi.kakao.com/v1/payment/cancel',
        billingUrl: 'https://kapi.kakao.com/v1/payment/subscription',
        docsUrl: 'https://developers.kakao.com/docs/latest/ko/kakaopay'
    },
    danal: {
        name: 'ë‹¤ë‚ ',
        apiUrl: 'https://api.danal.co.kr/payment',
        cancelUrl: 'https://api.danal.co.kr/payment/cancel',
        billingUrl: 'https://api.danal.co.kr/billing',
        docsUrl: 'https://developers.danal.co.kr'
    },
    settle: {
        name: 'ì„¸í‹€ë±…í¬',
        apiUrl: 'https://api.settlebank.co.kr/v1/payment',
        cancelUrl: 'https://api.settlebank.co.kr/v1/cancel',
        billingUrl: 'https://api.settlebank.co.kr/v1/billing',
        docsUrl: 'https://developers.settlebank.co.kr'
    },
    kcp: {
        name: 'NHN KCP',
        apiUrl: 'https://api.kcp.co.kr/v1/payment',
        cancelUrl: 'https://api.kcp.co.kr/v1/cancel',
        billingUrl: 'https://api.kcp.co.kr/v1/batch',
        docsUrl: 'https://developer.kcp.co.kr'
    }
};

function loadPgSettings() {
    document.getElementById('pg-provider').value = pgSettings.provider;
    document.getElementById('pg-mid').value = pgSettings.mid;
    document.getElementById('pg-merchant-key').value = pgSettings.merchantKey;
    document.getElementById('pg-secret-key').value = pgSettings.secretKey;
    document.getElementById('pg-api-url').value = pgSettings.apiUrl;
    document.getElementById('pg-cancel-url').value = pgSettings.cancelUrl;
    document.getElementById('pg-billing-url').value = pgSettings.billingUrl;
    document.getElementById('pg-mode').value = pgSettings.mode;
    document.getElementById('pg-timeout').value = pgSettings.timeout;
    document.getElementById('pg-billing-enabled').checked = pgSettings.billingEnabled;
    document.getElementById('pg-default-pay-day').value = pgSettings.defaultPayDay;
    document.getElementById('pg-pay-time').value = pgSettings.payTime;
    document.getElementById('pg-retry-count').value = pgSettings.retryCount;
    document.getElementById('pg-retry-interval').value = pgSettings.retryInterval;
    document.getElementById('pg-webhook-url').value = pgSettings.webhookUrl;
    document.getElementById('pg-webhook-success').checked = pgSettings.webhookSuccess;
    document.getElementById('pg-webhook-fail').checked = pgSettings.webhookFail;
    
    updatePgStatusBadge();
}

function onPgProviderChange(provider) {
    const info = pgProviderInfo[provider];
    if (info) {
        document.getElementById('pg-api-url').value = info.apiUrl;
        document.getElementById('pg-cancel-url').value = info.cancelUrl;
        document.getElementById('pg-billing-url').value = info.billingUrl;
    }
}

function toggleKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

function savePgSettings() {
    pgSettings = {
        provider: document.getElementById('pg-provider').value,
        mid: document.getElementById('pg-mid').value,
        merchantKey: document.getElementById('pg-merchant-key').value,
        secretKey: document.getElementById('pg-secret-key').value,
        apiUrl: document.getElementById('pg-api-url').value,
        cancelUrl: document.getElementById('pg-cancel-url').value,
        billingUrl: document.getElementById('pg-billing-url').value,
        mode: document.getElementById('pg-mode').value,
        timeout: parseInt(document.getElementById('pg-timeout').value) || 30,
        billingEnabled: document.getElementById('pg-billing-enabled').checked,
        defaultPayDay: parseInt(document.getElementById('pg-default-pay-day').value) || 10,
        payTime: document.getElementById('pg-pay-time').value,
        retryCount: parseInt(document.getElementById('pg-retry-count').value) || 3,
        retryInterval: parseInt(document.getElementById('pg-retry-interval').value) || 2,
        webhookUrl: document.getElementById('pg-webhook-url').value,
        webhookSuccess: document.getElementById('pg-webhook-success').checked,
        webhookFail: document.getElementById('pg-webhook-fail').checked
    };
    
    updatePgStatusBadge();
    showToast('âœ… PG ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updatePgStatusBadge() {
    const badge = document.getElementById('pg-status-badge');
    if (pgSettings.mid && pgSettings.merchantKey) {
        if (pgSettings.mode === 'production') {
            badge.className = 'badge badge-active';
            badge.textContent = 'ðŸŸ¢ ìš´ì˜ì¤‘';
        } else {
            badge.className = 'badge badge-pending';
            badge.textContent = 'ðŸŸ¡ í…ŒìŠ¤íŠ¸';
        }
    } else {
        badge.className = 'badge badge-failed';
        badge.textContent = 'âšª ë¯¸ì„¤ì •';
    }
}

function testPgConnection() {
    const mid = document.getElementById('pg-mid').value;
    const merchantKey = document.getElementById('pg-merchant-key').value;
    
    if (!mid || !merchantKey) {
        showToast('âŒ ê°€ë§¹ì  IDì™€ ìƒì  í‚¤ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    // í…ŒìŠ¤íŠ¸ ì—°ê²° ì‹œë®¬ë ˆì´ì…˜
    showToast('ðŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
    setTimeout(() => {
        // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œí•˜ì—¬ í™•ì¸
        showToast('âœ… PG ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
    }, 1500);
}

function openPgDocs(provider) {
    const info = pgProviderInfo[provider];
    if (info && info.docsUrl) {
        window.open(info.docsUrl, '_blank');
    }
}

function copyWebhookUrl() {
    const url = document.getElementById('pg-webhook-url').value;
    if (url) {
        navigator.clipboard.writeText(url);
        showToast('ðŸ“‹ Webhook URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        showToast('âŒ Webhook URLì„ ë¨¼ì € ìž…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    }
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤ íƒ­ =======================
function showBromotorsTab(name, skipHistory = false) {
    document.querySelectorAll('[id^="b-tab-"]').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
    document.getElementById('b-tab-' + name).classList.add('tab-active');
    document.getElementById('b-tab-' + name).classList.remove('text-gray-500');
    document.querySelectorAll('.b-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('b-content-' + name).classList.remove('hidden');
    
    // ížˆìŠ¤í† ë¦¬ ê´€ë¦¬
    if (!skipHistory) {
        history.pushState({ system: 'bromotors', tab: name }, '', `#b-${name}`);
    }
    currentTab = name;
    
    // ì„¸ì…˜ì— í˜„ìž¬ íƒ­ ì €ìž¥
    updateSessionTab('bromotors', name);
    
    if (name === 'overview') loadBroDashboard();
    if (name === 'work') loadBroWork();
    if (name === 'accident') loadAccidentList();
    if (name === 'purchase') loadPurchaseList();
    if (name === 'cashbook') loadBroCashbook();
    if (name === 'parts') loadBroParts();
    if (name === 'customers') loadBroCustomers();
}

// ======================= ì§ì› ê´€ë¦¬ =======================
const levelBadge = l => ({ 
    1: ['bg-gray-500/20 text-gray-400', 'ðŸ‘¤ Lv.1 ì‚¬ì›'], 
    2: ['bg-blue-500/20 text-blue-400', 'â­ Lv.2 íŒ€ì›'], 
    3: ['bg-orange-500/20 text-orange-400', 'ðŸ‘‘ Lv.3 ë§¤ë‹ˆì €'], 
    4: ['bg-red-500/20 text-red-400', 'ðŸ”¥ Lv.4 ìµœê³ ê´€ë¦¬ìž'] 
}[l] || ['', '']);

function renderStaffList() {
    let h = '';
    staffList.forEach(s => {
        const [lc, ll] = levelBadge(s.level || 1);
        const [stc, stl] = statusBadge(s.status);
        h += `<tr>
            <td class="font-bold">${s.name}</td>
            <td class="text-lime-400">${s.username}</td>
            <td class="text-gray-400">${s.phone}</td>
            <td>${s.department}</td>
            <td><span class="badge ${lc}">${ll}</span></td>
            <td><span class="badge ${stc}">${stl}</span></td>
            <td class="text-gray-400 text-xs">${s.created_at}</td>
            <td>
                <button onclick="editStaff(${s.id})" class="text-lime-400 text-xs hover:underline mr-2">ìˆ˜ì •</button>
                <button onclick="deleteStaff(${s.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
    });
    document.getElementById('staff-tbody').innerHTML = h;
}

function openStaffModal(editId = null) {
    document.getElementById('staffForm').reset();
    document.getElementById('staff-edit-id').value = '';
    document.querySelector('input[name="level"][value="1"]').checked = true;
    document.getElementById('staff-password').required = true;
    document.getElementById('staff-password-confirm').required = true;
    
    if (editId) {
        const s = staffList.find(x => x.id === editId);
        if (s) {
            document.getElementById('staffModalTitle').textContent = 'ðŸ‘¤ ì§ì› ìˆ˜ì •';
            document.getElementById('staffSubmitBtn').textContent = 'ìˆ˜ì •';
            document.getElementById('staff-edit-id').value = s.id;
            document.getElementById('staff-name').value = s.name;
            document.getElementById('staff-username').value = s.username;
            document.getElementById('staff-phone').value = s.phone;
            document.getElementById('staff-email').value = s.email || '';
            document.getElementById('staff-department').value = s.department;
            document.getElementById('staff-status').value = s.status;
            document.querySelector(`input[name="level"][value="${s.level || 1}"]`).checked = true;
            // ìˆ˜ì •ì‹œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì„ íƒì‚¬í•­
            document.getElementById('staff-password').required = false;
            document.getElementById('staff-password-confirm').required = false;
            document.getElementById('staff-password').placeholder = 'ë³€ê²½ì‹œì—ë§Œ ìž…ë ¥';
            document.getElementById('staff-password-confirm').placeholder = 'ë³€ê²½ì‹œì—ë§Œ ìž…ë ¥';
        }
    } else {
        document.getElementById('staffModalTitle').textContent = 'ðŸ‘¤ ì§ì› ë“±ë¡';
        document.getElementById('staffSubmitBtn').textContent = 'ë“±ë¡';
        document.getElementById('staff-password').placeholder = '';
        document.getElementById('staff-password-confirm').placeholder = '';
    }
    
    openModal('staffModal');
}

async function submitStaff(e) {
    e.preventDefault();
    const editId = document.getElementById('staff-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // ìˆ˜ì • ëª¨ë“œ
        const s = staffList.find(x => x.id === parseInt(editId));
        if (s) {
            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ëŠ” ê²½ìš°ì—ë§Œ ì²´í¬
            if (d.password || d.password_confirm) {
                if (d.password !== d.password_confirm) {
                    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                s.password = d.password;
            }
            
            // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ (ë³¸ì¸ ì œì™¸)
            if (staffList.find(x => x.username === d.username && x.id !== parseInt(editId))) {
                showToast('ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” ì•„ì´ë””ìž…ë‹ˆë‹¤', 'error');
                return;
            }
            
            s.name = d.name;
            s.username = d.username;
            s.phone = d.phone;
            s.email = d.email || null;
            s.department = d.department;
            s.level = parseInt(d.level) || 1;
            s.status = d.status;
            
            await updateInDB('staff', editId, {
                name: s.name, username: s.username, password: s.password,
                phone: s.phone, email: s.email, department: s.department,
                level: s.level, status: s.status
            });
        }
        showToast('âœ… ì§ì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ë“±ë¡ ëª¨ë“œ
        if (d.password !== d.password_confirm) {
            showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        // ì¤‘ë³µ ì•„ì´ë”” ì²´í¬
        if (staffList.find(s => s.username === d.username)) {
            showToast('ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” ì•„ì´ë””ìž…ë‹ˆë‹¤', 'error');
            return;
        }
        
        const staffData = {
            name: d.name,
            username: d.username,
            password: d.password,
            phone: d.phone,
            email: d.email || null,
            department: d.department,
            level: parseInt(d.level) || 1,
            role: d.level >= 3 ? 'manager' : 'staff',
            status: d.status || 'active'
        };
        
        const result = await insertToDB('staff', staffData);
        if (result && result[0]) staffList.unshift(result[0]);
        showToast('âœ… ì§ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('staffModal');
    renderStaffList();
}

function editStaff(id) {
    openStaffModal(id);
}

async function deleteStaff(id) {
    const s = staffList.find(x => x.id === id);
    if (!s) return;
    
    if (s.level === 4) {
        showToast('ìµœê³ ê´€ë¦¬ìžëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    if (!confirm(`${s.name} ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    await deleteFromDB('staff', id);
    staffList = staffList.filter(x => x.id !== id);
    showToast('âœ… ì§ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    renderStaffList();
}

// ======================= ì •ì‚°ê´€ë¦¬: ê³„ì•½ê´€ë¦¬ =======================
function filterContracts(status) {
    document.getElementById('contract-status').value = status;
    loadContracts();
}

function loadContracts() {
    const search = document.getElementById('contract-search').value.toLowerCase();
    const status = document.getElementById('contract-status').value;
    
    // ì—°ì²´ ìžë™ ê³„ì‚° (ê³„ì•½ ì‹œìž‘ì¼ ê¸°ì¤€)
    calculateAllArrears();
    
    let list = contractList;
    
    // ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ€ìž… í•„í„° (ì „ì²´ë©´ í•„í„° ì•ˆí•¨)
    if (currentContractType) {
        list = list.filter(c => (c.type || 'rent') === currentContractType);
    }
    
    // ìƒíƒœ í•„í„°
    if (status === 'delinquent') list = list.filter(c => c.arrears > 0);
    else if (status === 'active') list = list.filter(c => c.status === 'active' && c.arrears === 0);
    else if (status === 'completed') list = list.filter(c => c.status === 'completed');
    else if (status === 'cancelled') list = list.filter(c => c.status === 'cancelled');
    if (search) list = list.filter(c => c.customer_name.toLowerCase().includes(search) || c.plate.toLowerCase().includes(search));
    
    // ìš”ì•½ (í˜„ìž¬ íƒ€ìž… ê¸°ì¤€)
    const typeContracts = currentContractType ? contractList.filter(c => (c.type || 'rent') === currentContractType) : contractList;
    const activeContracts = typeContracts.filter(c => c.status === 'active');
    const delinquentContracts = typeContracts.filter(c => c.arrears > 0);
    const monthlyRevenue = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    document.getElementById('contract-total').textContent = typeContracts.length + 'ê±´';
    document.getElementById('contract-active').textContent = activeContracts.length + 'ê±´';
    document.getElementById('contract-delinquent').textContent = delinquentContracts.length + 'ê±´';
    document.getElementById('contract-revenue').textContent = fmt(monthlyRevenue);
    document.getElementById('contract-revenue-count').textContent = activeContracts.length + 'ê±´ ê³„ì•½';
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(c => {
        const hasArrears = c.arrears > 0;
        let statusBadge;
        if (hasArrears) statusBadge = ['badge-delinquent', 'ì—°ì²´'];
        else if (c.status === 'completed') statusBadge = ['badge-complete', 'ì¢…ë£Œ'];
        else if (c.status === 'cancelled') statusBadge = ['badge-failed', 'í•´ì§€'];
        else statusBadge = ['badge-active', 'ì§„í–‰ì¤‘'];
        
        const period = c.start_date && c.end_date ? `${c.start_date.substring(5)} ~ ${c.end_date.substring(5)}` : c.start_date ? c.start_date.substring(5) + ' ~' : '-';
        const hasDoc = c.contractor_id_url || c.vehicle_reg_url;
        
        // ì´ ê³„ì•½ì˜ ë¯¸ë‚© ê³¼íƒœë£Œ í•©ê³„
        const contractFines = fineList.filter(f => f.contract_id === c.id && f.status === 'unpaid');
        const fineTotal = contractFines.reduce((s, f) => s + (f.amount || 0), 0);
        
        // ì°¨ëŸ‰ ìœ í˜• ì•„ì´ì½˜
        const linkedVehicle = vehicleList.find(v => v.plate === c.plate);
        const vehIcon = linkedVehicle ? (linkedVehicle.vehicle_type === 'car' ? 'ðŸš—' : 'ðŸï¸') : 'ðŸï¸';
        
        // ê²°ì œì£¼ê¸° í‘œì‹œ
        const cycleLabel = { daily: 'ì¼', weekly: 'ì£¼', monthly: 'ì›”' }[c.payment_cycle] || 'ì›”';
        
        h += `<tr class="hover:bg-white/5">
            <td class="text-lime-400 cursor-pointer" onclick="viewContractDetail(${c.id})">#${String(c.id).padStart(3,'0')}</td>
            <td class="font-bold cursor-pointer" onclick="viewContractDetail(${c.id})">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td class="cursor-pointer" onclick="viewContractDetail(${c.id})">${vehIcon} ${c.vehicle}</td>
            <td class="font-mono">${c.plate}</td>
            <td class="text-xs">${cycleLabel}</td>
            <td class="text-xs text-gray-400">${period}</td>
            <td class="font-bold">${fmt(c.monthly)}</td>
            <td class="${hasArrears ? 'text-orange-400 font-bold' : 'text-gray-500'}">
                ${hasArrears ? `<span class="cursor-pointer" onclick="viewContractDetail(${c.id})">${fmt(c.arrears)}</span>` : '-'}
            </td>
            <td>
                ${hasArrears ? `<button onclick="event.stopPropagation(); openQuickPaymentModal(${c.id})" class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold hover:bg-emerald-500/30">ðŸ’° ìˆ˜ë‚©</button>` : '<span class="text-gray-500">-</span>'}
            </td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td>${hasDoc ? '<span class="text-cyan-400">ðŸ“Ž</span>' : '<span class="text-gray-600">-</span>'}</td>
        </tr>`;
    });
    document.getElementById('contract-tbody').innerHTML = h || '<tr><td colspan="12" class="text-center text-gray-500 py-6">ê³„ì•½ ì—†ìŒ</td></tr>';
}

// ì—°ì²´ ìžë™ ê³„ì‚° í•¨ìˆ˜
function calculateAllArrears() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const todayDate = new Date(today + 'T00:00:00');
    
    contractList.forEach(c => {
        // ì¢…ë£Œ/í•´ì§€ëœ ê³„ì•½ì€ ì œì™¸
        if (c.status === 'completed' || c.status === 'cancelled') {
            c.arrears = 0;
            c.delinquent_days = 0;
            return;
        }
        
        // ì‹œìž‘ì¼ì´ ì—†ìœ¼ë©´ ì œì™¸
        if (!c.start_date) {
            c.arrears = 0;
            c.delinquent_days = 0;
            return;
        }
        
        const startDate = new Date(c.start_date + 'T00:00:00');
        
        // ì‹œìž‘ì¼ì´ ì˜¤ëŠ˜ë³´ë‹¤ ë¯¸ëž˜ë©´ ì—°ì²´ ì—†ìŒ
        if (startDate > todayDate) {
            c.arrears = 0;
            c.delinquent_days = 0;
            return;
        }
        
        const cycle = c.payment_cycle || 'monthly';
        let totalDue = 0;
        
        if (cycle === 'daily') {
            // ì¼ì •ì‚°: ì‹œìž‘ì¼ = 1ê±´ (ë‹¹ì¼ í¬í•¨)
            // ì˜ˆ: ì‹œìž‘ì¼ 1/13, ì˜¤ëŠ˜ 1/13 â†’ 1ê±´
            // ì˜ˆ: ì‹œìž‘ì¼ 1/13, ì˜¤ëŠ˜ 1/14 â†’ 2ê±´
            const diffTime = todayDate.getTime() - startDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // ë‹¹ì¼ í¬í•¨
            totalDue = diffDays * (c.monthly || 0);
        } else if (cycle === 'weekly') {
            // ì£¼ì •ì‚°: ì‹œìž‘ì¼ë¶€í„° ì²« ì£¼ = 1ê±´
            const diffTime = todayDate.getTime() - startDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // ë‹¹ì¼ í¬í•¨
            const diffWeeks = Math.ceil(diffDays / 7); // ì˜¬ë¦¼ìœ¼ë¡œ ì²« ì£¼ í¬í•¨
            totalDue = diffWeeks * (c.monthly || 0);
        } else {
            // ì›”ì •ì‚°: ë‚©ìž…ì¼ ê¸°ì¤€
            const paymentDay = c.payment_day || startDate.getDate();
            const monthsElapsed = (todayDate.getFullYear() - startDate.getFullYear()) * 12 
                + (todayDate.getMonth() - startDate.getMonth());
            const currentDay = todayDate.getDate();
            // ë‹¹ì¼ì´ ë‚©ìž…ì¼ì´ê±°ë‚˜ ì§€ë‚¬ìœ¼ë©´ ì´ë²ˆë‹¬ í¬í•¨
            const additionalMonth = currentDay >= paymentDay ? 1 : 0;
            totalDue = (monthsElapsed + additionalMonth) * (c.monthly || 0);
        }
        
        // ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡ (ì™„ë£Œëœ ë‚©ìž…ë§Œ)
        const totalPaid = contractPaymentList
            .filter(p => p.contract_id === c.id && p.status === 'paid')
            .reduce((sum, p) => sum + (p.amount || 0), 0);
        
        // ì—°ì²´ = ë‚©ë¶€í•´ì•¼ í•  ê¸ˆì•¡ - ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡
        c.arrears = Math.max(0, totalDue - totalPaid);
        
        // ì—°ì²´ì¼ìˆ˜ ê³„ì‚° (ë¯¸ìˆ˜ê¸ˆì´ ìžˆëŠ” ê²½ìš°ë§Œ)
        if (c.arrears > 0) {
            // ì¼ì •ì‚°: ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚©ë¶€í•œ ë‚  ë‹¤ìŒë‚ ë¶€í„° ì—°ì²´
            // ì£¼ì •ì‚°: ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚©ë¶€í•œ ì£¼ ë‹¤ìŒì£¼ë¶€í„° ì—°ì²´  
            // ì›”ì •ì‚°: ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚©ë¶€í•œ ë‹¬ ë‚©ë¶€ì˜ˆì •ì¼ë¶€í„° ì—°ì²´
            
            const paidPayments = contractPaymentList.filter(p => 
                p.contract_id === c.id && p.status === 'paid'
            ).sort((a, b) => (b.payment_date || '').localeCompare(a.payment_date || ''));
            
            let lastPaymentDate = paidPayments.length > 0 ? paidPayments[0].payment_date : null;
            let overdueStartDate;
            
            if (cycle === 'daily') {
                // ì¼ì •ì‚°: ë§ˆì§€ë§‰ ë‚©ë¶€ì¼ ë‹¤ìŒë‚  ë˜ëŠ” ê³„ì•½ì‹œìž‘ì¼
                if (lastPaymentDate) {
                    const lastDate = new Date(lastPaymentDate + 'T00:00:00');
                    lastDate.setDate(lastDate.getDate() + 1);
                    overdueStartDate = lastDate.toISOString().split('T')[0];
                } else {
                    overdueStartDate = c.start_date;
                }
            } else if (cycle === 'weekly') {
                // ì£¼ì •ì‚°: ë§ˆì§€ë§‰ ë‚©ë¶€ì¼ + 7ì¼ ë˜ëŠ” ê³„ì•½ì‹œìž‘ì¼
                if (lastPaymentDate) {
                    const lastDate = new Date(lastPaymentDate + 'T00:00:00');
                    lastDate.setDate(lastDate.getDate() + 7);
                    overdueStartDate = lastDate.toISOString().split('T')[0];
                } else {
                    overdueStartDate = c.start_date;
                }
            } else {
                // ì›”ì •ì‚°: ë§ˆì§€ë§‰ ë‚©ë¶€ ì›”ì˜ ë‹¤ìŒë‹¬ ë‚©ë¶€ì˜ˆì •ì¼ ë˜ëŠ” ì²« ë‚©ë¶€ì˜ˆì •ì¼
                const paymentDay = c.payment_day || startDate.getDate();
                
                if (lastPaymentDate) {
                    const [y, m] = lastPaymentDate.substring(0, 7).split('-').map(Number);
                    const nextMonth = m === 12 ? `${y + 1}-01` : `${y}-${String(m + 1).padStart(2, '0')}`;
                    overdueStartDate = `${nextMonth}-${String(paymentDay).padStart(2, '0')}`;
                } else {
                    // ì²« ë‚©ë¶€ì˜ˆì •ì¼
                    const startY = startDate.getFullYear();
                    const startM = startDate.getMonth() + 1;
                    const startD = startDate.getDate();
                    
                    if (startD <= paymentDay) {
                        overdueStartDate = `${startY}-${String(startM).padStart(2, '0')}-${String(paymentDay).padStart(2, '0')}`;
                    } else {
                        const nextM = startM === 12 ? 1 : startM + 1;
                        const nextY = startM === 12 ? startY + 1 : startY;
                        overdueStartDate = `${nextY}-${String(nextM).padStart(2, '0')}-${String(paymentDay).padStart(2, '0')}`;
                    }
                }
            }
            
            // ì—°ì²´ì¼ ê³„ì‚°
            if (overdueStartDate && today >= overdueStartDate) {
                const overdueDateObj = new Date(overdueStartDate + 'T00:00:00');
                const diffTime = todayDate.getTime() - overdueDateObj.getTime();
                c.delinquent_days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // ë‹¹ì¼ í¬í•¨
            } else {
                c.delinquent_days = 0;
            }
        } else {
            c.delinquent_days = 0;
        }
        
        // ë””ë²„ê·¸ ë¡œê·¸ (ëª¨ë“  ì—°ì²´ ê³„ì•½)
        if (c.arrears > 0) {
            console.log(`ì—°ì²´ê³„ì‚° [${c.customer_name}]: ì‹œìž‘ì¼=${c.start_date}, ì£¼ê¸°=${cycle}, ì´ë°œìƒ=${totalDue}, ë‚©ë¶€=${totalPaid}, ì—°ì²´=${c.arrears}, ì—°ì²´ì¼=${c.delinquent_days}`);
        }
    });
}

// ì›” ì •ì‚°ê¸ˆì•¡ ìƒì„¸ ëª¨ë‹¬
function openMonthlyRevenueModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    const monthName = today.substring(0, 7).replace('-', 'ë…„ ') + 'ì›”';
    
    const activeContracts = contractList.filter(c => c.status === 'active');
    const monthlyRevenue = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© ê¸ˆì•¡ (contract_payments ê¸°ì¤€)
    const thisMonthPayments = contractPaymentList.filter(p => 
        p.status === 'paid' && p.payment_date >= thisMonthStart && p.payment_date <= today
    );
    const actualReceipt = thisMonthPayments.reduce((s, p) => s + (p.amount || 0), 0);
    const receiptRate = monthlyRevenue > 0 ? Math.round((actualReceipt / monthlyRevenue) * 100) : 0;
    
    // ê³„ì•½ ìœ í˜•ë³„ ì§‘ê³„
    const leaseContracts = activeContracts.filter(c => c.type === 'lease');
    const rentContracts = activeContracts.filter(c => c.type === 'rent');
    const leaseRevenue = leaseContracts.reduce((s, c) => s + c.monthly, 0);
    const rentRevenue = rentContracts.reduce((s, c) => s + c.monthly, 0);
    
    // ê³„ì•½ë³„ í…Œì´ë¸” (ì´ë²ˆë‹¬ ìˆ˜ë‚©ê¸ˆì•¡ í¬í•¨)
    let tableRows = '';
    activeContracts.sort((a, b) => b.monthly - a.monthly).forEach(c => {
        const typeLabel = c.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸';
        const typeBadge = c.type === 'lease' ? 'badge-progress' : 'badge-pending';
        // ì´ ê³„ì•½ì˜ ì´ë²ˆë‹¬ ìˆ˜ë‚© ê¸ˆì•¡
        const contractMonthPayments = thisMonthPayments.filter(p => p.contract_id === c.id);
        const contractReceipt = contractMonthPayments.reduce((s, p) => s + (p.amount || 0), 0);
        const isPaid = contractReceipt >= c.monthly;
        
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="closeModal('monthlyRevenueModal'); viewContractDetail(${c.id});">
            <td class="text-lime-400">#${String(c.id).padStart(3, '0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td>${c.vehicle}</td>
            <td><span class="badge ${typeBadge}">${typeLabel}</span></td>
            <td class="text-blue-400 font-bold">${fmt(c.monthly)}</td>
            <td class="${isPaid ? 'text-emerald-400' : 'text-orange-400'} font-bold">${fmt(contractReceipt)}</td>
        </tr>`;
    });
    
    document.getElementById('monthly-revenue-content').innerHTML = `
        <div class="text-center text-lg font-bold text-lime-400 mb-4">${monthName}</div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì›” ì˜ˆì • ìˆ˜ë‚©ê¸ˆì•¡</div>
                <div class="text-xl font-black text-emerald-400">${fmt(monthlyRevenue)}</div>
                <div class="text-xs text-gray-500">${activeContracts.length}ê±´ ê³„ì•½</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">ì‹¤ì œ ìˆ˜ë‚©</div>
                <div class="text-xl font-black text-blue-400">${fmt(actualReceipt)}</div>
                <div class="text-xs text-gray-500">${thisMonthPayments.length}ê±´</div>
            </div>
            <div class="p-4 rounded-xl ${receiptRate >= 80 ? 'bg-emerald-400/10 border-emerald-400/30' : 'bg-orange-400/10 border-orange-400/30'} text-center">
                <div class="text-xs ${receiptRate >= 80 ? 'text-emerald-400' : 'text-orange-400'} mb-1">ìˆ˜ë‚©ë¥ </div>
                <div class="text-xl font-black ${receiptRate >= 80 ? 'text-emerald-400' : 'text-orange-400'}">${receiptRate}%</div>
                <div class="text-xs text-gray-500">${receiptRate >= 80 ? 'ì–‘í˜¸' : 'ë¯¸ë‹¬'}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ“Š ê³„ì•½ ìœ í˜•ë³„</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-400 w-12">ë¦¬ìŠ¤</span>
                    <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-400" style="width:${monthlyRevenue > 0 ? Math.round((leaseRevenue / monthlyRevenue) * 100) : 0}%"></div>
                    </div>
                    <span class="text-xs text-blue-400 w-24 text-right">${fmt(leaseRevenue)}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-400 w-12">ë ŒíŠ¸</span>
                    <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-yellow-400" style="width:${monthlyRevenue > 0 ? Math.round((rentRevenue / monthlyRevenue) * 100) : 0}%"></div>
                    </div>
                    <span class="text-xs text-yellow-400 w-24 text-right">${fmt(rentRevenue)}</span>
                </div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:250px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³„ì•½</th><th>ê³ ê°</th><th>ì°¨ëŸ‰</th><th>ìœ í˜•</th><th>ì˜ˆì •</th><th>ìˆ˜ë‚©</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="6" class="text-center text-gray-500 py-4">ê³„ì•½ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('monthlyRevenueModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('monthlyRevenueModal'); showSettlementTab('ledger');" class="btn-primary flex-1">ì›ìž¥ ë³´ê¸°</button>
        </div>
    `;
    
    openModal('monthlyRevenueModal');
}

function viewContractDetail(id) {
    const c = contractList.find(x => x.id === id);
    if (!c) return;
    
    // ìƒíƒœ ë°°ì§€ (ì§„í–‰ì¤‘/ì¢…ë£Œ/í•´ì§€/ì—°ì²´)
    const getStatusBadge = (contract) => {
        if (contract.arrears > 0) return ['badge-delinquent', 'ì—°ì²´'];
        if (contract.status === 'completed') return ['badge-complete', 'ì¢…ë£Œ'];
        if (contract.status === 'cancelled') return ['badge-failed', 'í•´ì§€'];
        return ['badge-active', 'ì§„í–‰ì¤‘'];
    };
    const statusBadge = getStatusBadge(c);
    const typeBadge = (c.type || 'rent') === 'rent' ? ['badge-rent', 'ë ŒíŠ¸'] : ['badge-lease', 'ë¦¬ìŠ¤'];
    
    // ì°¨ëŸ‰ ìœ í˜• ê°€ì ¸ì˜¤ê¸°
    const linkedVehicle = vehicleList.find(v => v.plate === c.plate);
    const vehicleTypeBadge = linkedVehicle && linkedVehicle.vehicle_type === 'car' 
        ? ['text-blue-400', 'ðŸš— ìžë™ì°¨'] 
        : ['text-orange-400', 'ðŸï¸ ì´ë¥œì°¨'];
    
    // ì—°ì²´ ê³„ì‚° ì •ë³´ (ì‹œìž‘ì¼ ê¸°ì¤€)
    let arrearsInfo = null;
    if (c.start_date && c.status === 'active') {
        const startDate = new Date(c.start_date + 'T00:00:00');
        const now = new Date();
        const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        const todayDate = new Date(koreaTime.toISOString().split('T')[0] + 'T00:00:00');
        const cycle = c.payment_cycle || 'monthly';
        
        let cycleLabel = '';
        let periodCount = 0;
        let periodLabel = '';
        let totalDue = 0;
        
        // ì‹œìž‘ì¼ì´ ë¯¸ëž˜ë©´ ì•„ì§ ë‚©ë¶€ ì˜ˆì • ì—†ìŒ
        if (startDate > todayDate) {
            periodCount = 0;
            periodLabel = cycle === 'daily' ? 'ì¼' : cycle === 'weekly' ? 'ì£¼' : 'ê°œì›”';
            cycleLabel = cycle === 'daily' ? 'ðŸ“… ì¼ì •ì‚° (ë§¤ì¼)' : cycle === 'weekly' ? 'ðŸ“† ì£¼ì •ì‚° (7ì¼)' : 'ðŸ—“ï¸ ì›”ê²°ì œ';
            totalDue = 0;
        } else if (cycle === 'daily') {
            const diffTime = todayDate.getTime() - startDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 ë‹¹ì¼ í¬í•¨
            periodCount = Math.max(0, diffDays);
            periodLabel = 'ì¼';
            cycleLabel = 'ðŸ“… ì¼ì •ì‚° (ë§¤ì¼)';
            totalDue = periodCount * (c.monthly || 0);
        } else if (cycle === 'weekly') {
            const diffTime = todayDate.getTime() - startDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 ë‹¹ì¼ í¬í•¨
            periodCount = Math.ceil(diffDays / 7); // ì˜¬ë¦¼ìœ¼ë¡œ ì²« ì£¼ í¬í•¨
            periodLabel = 'ì£¼';
            cycleLabel = 'ðŸ“† ì£¼ì •ì‚° (7ì¼)';
            totalDue = Math.max(0, periodCount) * (c.monthly || 0);
        } else {
            const paymentDay = c.payment_day || startDate.getDate();
            const monthsElapsed = (todayDate.getFullYear() - startDate.getFullYear()) * 12 
                + (todayDate.getMonth() - startDate.getMonth());
            const currentDay = todayDate.getDate();
            const additionalMonth = currentDay >= paymentDay ? 1 : 0;
            periodCount = monthsElapsed + additionalMonth;
            periodLabel = 'ê°œì›”';
            cycleLabel = `ðŸ—“ï¸ ì›”ê²°ì œ (ë§¤ì›” ${paymentDay}ì¼)`;
            totalDue = periodCount * (c.monthly || 0);
        }
        
        const totalPaid = contractPaymentList
            .filter(p => p.contract_id === c.id && p.status === 'paid')
            .reduce((sum, p) => sum + (p.amount || 0), 0);
        
        arrearsInfo = {
            cycle,
            cycleLabel,
            periodCount,
            periodLabel,
            totalDue,
            totalPaid,
            arrears: Math.max(0, totalDue - totalPaid)
        };
    }
    
    // ì„œë¥˜ ë§í¬ ìƒì„±
    const docLinks = [];
    if (c.contractor_id_url) docLinks.push(`<a href="${c.contractor_id_url}" target="_blank" class="text-cyan-400 hover:underline text-xs">ðŸ“Ž ê³„ì•½ìž ì‹ ë¶„ì¦</a>`);
    if (c.contractor_doc_url) docLinks.push(`<a href="${c.contractor_doc_url}" target="_blank" class="text-cyan-400 hover:underline text-xs">ðŸ“Ž ê³„ì•½ìž ê¸°íƒ€ì„œë¥˜</a>`);
    if (c.guarantor_id_url) docLinks.push(`<a href="${c.guarantor_id_url}" target="_blank" class="text-yellow-400 hover:underline text-xs">ðŸ“Ž ë³´ì¦ì¸ ì‹ ë¶„ì¦</a>`);
    if (c.guarantor_doc_url) docLinks.push(`<a href="${c.guarantor_doc_url}" target="_blank" class="text-yellow-400 hover:underline text-xs">ðŸ“Ž ë³´ì¦ì¸ ê¸°íƒ€ì„œë¥˜</a>`);
    if (c.vehicle_reg_url) docLinks.push(`<a href="${c.vehicle_reg_url}" target="_blank" class="text-purple-400 hover:underline text-xs">ðŸ“Ž ì°¨ëŸ‰ë“±ë¡ì¦</a>`);
    if (c.vehicle_disposal_url) docLinks.push(`<a href="${c.vehicle_disposal_url}" target="_blank" class="text-purple-400 hover:underline text-xs">ðŸ“Ž íì§€ì„œë¥˜</a>`);
    if (c.vehicle_doc_url) docLinks.push(`<a href="${c.vehicle_doc_url}" target="_blank" class="text-purple-400 hover:underline text-xs">ðŸ“Ž ì°¨ëŸ‰ ê¸°íƒ€ì„œë¥˜</a>`);
    
    // ì „í™”ë²ˆí˜¸ ì •ë¦¬ (í•˜ì´í”ˆ ì œê±°)
    const phoneClean = (c.phone || '').replace(/-/g, '');
    const guarantorPhoneClean = (c.guarantor_phone || '').replace(/-/g, '');
    
    // ì´ ê³„ì•½ì˜ ê³¼íƒœë£Œ ëª©ë¡
    const contractFines = fineList.filter(f => f.contract_id === c.id);
    const unpaidFines = contractFines.filter(f => f.status === 'unpaid');
    const totalFineAmount = contractFines.reduce((s, f) => s + (f.amount || 0), 0);
    const unpaidFineAmount = unpaidFines.reduce((s, f) => s + (f.amount || 0), 0);
    
    document.getElementById('contract-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³„ì•½ë²ˆí˜¸</span><span class="text-lime-400 font-bold">#${String(c.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ìœ í˜•</span><span class="badge ${typeBadge[0]}">${typeBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row col-span-2">
                    <span class="info-label">ì—°ë½ì²˜</span>
                    <div class="flex items-center gap-2">
                        <span>${c.phone}</span>
                        <a href="tel:${phoneClean}" class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-bold hover:bg-green-500/30">ðŸ“ž ì „í™”</a>
                        <a href="sms:${phoneClean}" class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs font-bold hover:bg-blue-500/30">ðŸ’¬ ë¬¸ìž</a>
                    </div>
                </div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${c.plate}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë£Œ</span><span>${c.fuel_type || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰ìœ í˜•</span><span class="${vehicleTypeBadge[0]} font-bold">${vehicleTypeBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ë³´ì¦ê¸ˆ</span><span class="text-yellow-400 font-bold">${fmt(c.deposit || 0)}</span></div>
                <div class="info-row"><span class="info-label">ì›” ë‚©ìž…ê¸ˆ</span><span class="text-blue-400 font-bold">${fmt(c.monthly)}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ ì‹œìž‘ì¼</span><span>${c.start_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ ì¢…ë£Œì¼</span><span>${c.end_date || '-'}</span></div>
            </div>
            ${c.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-sm text-gray-400">ðŸ“ ${c.memo}</div>` : ''}
        </div>
        
        ${c.guarantor_name ? `
        <div class="p-4 rounded-lg bg-yellow-400/10 border border-yellow-400/30 mb-4">
            <div class="text-xs text-yellow-400 mb-2">ðŸ‘¥ ì—°ëŒ€ë³´ì¦ì¸</div>
            <div class="grid grid-cols-1 gap-2">
                <div><span class="text-gray-400 text-xs">ì´ë¦„:</span> <span class="font-bold">${c.guarantor_name}</span></div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-xs">ì—°ë½ì²˜:</span> 
                    <span>${c.guarantor_phone || '-'}</span>
                    ${c.guarantor_phone ? `
                    <a href="tel:${guarantorPhoneClean}" class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-bold hover:bg-green-500/30">ðŸ“ž ì „í™”</a>
                    <a href="sms:${guarantorPhoneClean}" class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs font-bold hover:bg-blue-500/30">ðŸ’¬ ë¬¸ìž</a>
                    ` : ''}
                </div>
            </div>
        </div>` : ''}
        
        ${contractFines.length > 0 ? `
        <div class="p-4 rounded-lg bg-red-400/10 border border-red-400/30 mb-4">
            <div class="flex justify-between items-center mb-2">
                <div class="text-xs text-red-400">ðŸš¨ ê³¼íƒœë£Œ (${contractFines.length}ê±´)</div>
                <button onclick="closeModal('contractDetailModal'); openFineModalForContract(${c.id})" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30">+ ì¶”ê°€</button>
            </div>
            <div class="space-y-2">
                ${contractFines.map(f => `
                    <div class="flex justify-between items-center p-2 rounded bg-white/5">
                        <div>
                            <span class="text-gray-300 text-sm">${f.reason || '-'}</span>
                            <span class="text-gray-500 text-xs ml-2">${f.fine_date || ''}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold ${f.status === 'paid' ? 'text-gray-500 line-through' : 'text-red-400'}">${fmt(f.amount)}</span>
                            <span class="badge ${f.status === 'paid' ? 'badge-complete' : 'badge-failed'} text-xs">${f.status === 'paid' ? 'ë‚©ë¶€' : 'ë¯¸ë‚©'}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            ${unpaidFineAmount > 0 ? `<div class="mt-2 pt-2 border-t border-red-400/30 flex justify-between"><span class="text-red-400 text-sm">ë¯¸ë‚© í•©ê³„</span><span class="font-bold text-red-400">${fmt(unpaidFineAmount)}</span></div>` : ''}
        </div>` : `
        <div class="p-3 rounded-lg bg-white/5 border border-white/10 mb-4 flex justify-between items-center">
            <span class="text-gray-500 text-sm">ê³¼íƒœë£Œ ì—†ìŒ</span>
            <button onclick="closeModal('contractDetailModal'); openFineModalForContract(${c.id})" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30">+ ê³¼íƒœë£Œ ë“±ë¡</button>
        </div>`}
        
        <!-- ë‚©ìž… ë‚´ì—­ (ì ‘ê¸°/íŽ¼ì¹˜ê¸°) -->
        <div class="p-4 rounded-lg bg-emerald-400/10 border border-emerald-400/30 mb-4">
            <div class="flex justify-between items-center cursor-pointer" onclick="togglePaymentList(${c.id})">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-emerald-400">ðŸ’° ë‚©ìž… ë‚´ì—­</span>
                    <span class="text-xs text-gray-500">(${contractPaymentList.filter(p => p.contract_id === c.id).length}ê±´)</span>
                    <span id="payment-toggle-icon-${c.id}" class="text-gray-400 text-xs">â–¼</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-emerald-400 text-sm">${fmt(getContractTotalPayments(c.id))}</span>
                    <button onclick="event.stopPropagation(); openPaymentModal(${c.id})" class="text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30">+ ë“±ë¡</button>
                </div>
            </div>
            <div id="contract-payment-list-${c.id}" class="space-y-2 max-h-48 overflow-y-auto mt-3 hidden">
                ${getContractPaymentsList(c.id)}
            </div>
        </div>
        
        ${docLinks.length > 0 ? `
        <div class="p-4 rounded-lg bg-cyan-400/10 border border-cyan-400/30 mb-4">
            <div class="text-xs text-cyan-400 mb-2">ðŸ“Ž ì²¨ë¶€ ì„œë¥˜</div>
            <div class="flex flex-wrap gap-3">${docLinks.join('')}</div>
        </div>` : ''}
        
        ${arrearsInfo ? `
        <div class="p-4 rounded-lg ${arrearsInfo.arrears > 0 ? 'bg-orange-400/10 border-orange-400/30' : 'bg-emerald-400/10 border-emerald-400/30'} border mb-4">
            <div class="text-xs ${arrearsInfo.arrears > 0 ? 'text-orange-400' : 'text-emerald-400'} mb-3">${arrearsInfo.cycleLabel}</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="flex justify-between"><span class="text-gray-400">ê²½ê³¼</span><span class="font-bold">${arrearsInfo.periodCount}${arrearsInfo.periodLabel}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ë‚©ìž…ê¸ˆ</span><span class="font-bold">${fmt(c.monthly)}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ì´ ë‚©ë¶€ ì˜ˆì •</span><span class="font-bold text-blue-400">${fmt(arrearsInfo.totalDue)}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ì‹¤ì œ ë‚©ë¶€</span><span class="font-bold text-emerald-400">${fmt(arrearsInfo.totalPaid)}</span></div>
            </div>
            <div class="mt-3 pt-3 border-t ${arrearsInfo.arrears > 0 ? 'border-orange-400/30' : 'border-emerald-400/30'} flex justify-between items-center">
                <span class="${arrearsInfo.arrears > 0 ? 'text-orange-400' : 'text-emerald-400'} font-bold">${arrearsInfo.arrears > 0 ? 'ðŸš¨ ë¯¸ë‚© ê¸ˆì•¡' : 'âœ… ë‚©ìž… ì™„ë£Œ'}</span>
                <span class="text-xl font-black ${arrearsInfo.arrears > 0 ? 'text-orange-400' : 'text-emerald-400'}">${arrearsInfo.arrears > 0 ? fmt(arrearsInfo.arrears) : 'ì •ìƒ'}</span>
            </div>
        </div>` : ''}
        <div class="flex gap-3">
            <button onclick="deleteContract(${c.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('contractDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editContract(${c.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('contractDetailModal');
}

// ë‚©ìž… ë‚´ì—­ ì ‘ê¸°/íŽ¼ì¹˜ê¸°
function togglePaymentList(contractId) {
    const listEl = document.getElementById('contract-payment-list-' + contractId);
    const iconEl = document.getElementById('payment-toggle-icon-' + contractId);
    
    if (listEl.classList.contains('hidden')) {
        listEl.classList.remove('hidden');
        if (iconEl) iconEl.textContent = 'â–²';
    } else {
        listEl.classList.add('hidden');
        if (iconEl) iconEl.textContent = 'â–¼';
    }
}

// ======================= ê³„ì•½ ë‚©ìž… ê´€ë¦¬ =======================
let contractPaymentList = [];

function getContractPaymentsList(contractId) {
    const payments = contractPaymentList.filter(p => p.contract_id === contractId);
    if (payments.length === 0) {
        return '<div class="text-center text-gray-500 text-sm py-2">ë‚©ìž… ë‚´ì—­ ì—†ìŒ</div>';
    }
    
    // ë‚ ì§œ ìµœì‹ ìˆœ ì •ë ¬
    payments.sort((a, b) => (b.payment_date || '').localeCompare(a.payment_date || ''));
    
    return payments.map(p => {
        const isPaid = p.status === 'paid';
        const statusBadge = isPaid 
            ? '<span class="badge badge-complete text-xs">ì™„ë£Œ</span>' 
            : '<span class="badge badge-failed text-xs">ë¯¸ë‚©</span>';
        
        return `
        <div class="flex justify-between items-center p-2 rounded ${isPaid ? 'bg-emerald-500/10' : 'bg-red-500/10'} hover:bg-white/10">
            <div class="flex items-center gap-3">
                <span class="text-gray-400 text-xs">${p.payment_date || '-'}</span>
                <span class="text-sm">${p.payment_type || 'ì›”ë‚©'}</span>
                ${statusBadge}
            </div>
            <div class="flex items-center gap-2">
                <span class="font-bold ${isPaid ? 'text-emerald-400' : 'text-red-400'}">${fmt(p.amount)}</span>
                ${!isPaid ? `<button onclick="processPayment(${p.id}, ${contractId})" class="text-emerald-400 text-xs hover:text-emerald-300 px-2 py-1 bg-emerald-500/20 rounded">ìˆ˜ë‚©</button>` : ''}
                <button onclick="deleteContractPayment(${p.id}, ${contractId})" class="text-red-400 text-xs hover:text-red-300">âœ•</button>
            </div>
        </div>`;
    }).join('');
}

function getContractTotalPayments(contractId) {
    return contractPaymentList
        .filter(p => p.contract_id === contractId && p.status === 'paid')
        .reduce((sum, p) => sum + (p.amount || 0), 0);
}

function getContractUnpaidAmount(contractId) {
    return contractPaymentList
        .filter(p => p.contract_id === contractId && p.status !== 'paid')
        .reduce((sum, p) => sum + (p.amount || 0), 0);
}

// ìˆ˜ë‚© ì²˜ë¦¬
async function processPayment(paymentId, contractId) {
    if (!confirm('ìˆ˜ë‚© ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const payment = contractPaymentList.find(p => p.id === paymentId);
    if (!payment) return;
    
    // ë‚©ìž… ìƒíƒœ ì—…ë°ì´íŠ¸
    await updateInDB('contract_payments', paymentId, { status: 'paid' });
    payment.status = 'paid';
    
    // ê³„ì•½ ì—°ì²´ê¸ˆ ì°¨ê°
    const contract = contractList.find(c => c.id === contractId);
    if (contract) {
        const newArrears = Math.max(0, (contract.arrears || 0) - (payment.amount || 0));
        await updateInDB('contracts', contractId, { arrears: newArrears });
        contract.arrears = newArrears;
    }
    
    showToast('âœ… ìˆ˜ë‚© ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    viewContractDetail(contractId);
}

// ======================= ë¹ ë¥¸ ìˆ˜ë‚© =======================
let quickPaymentContractId = null;

function openQuickPaymentModal(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    quickPaymentContractId = contractId;
    
    // ì—°ì²´ ìž¬ê³„ì‚°
    calculateAllArrears();
    const arrears = c.arrears || 0;
    
    // ê²°ì œ ì£¼ê¸° ë¼ë²¨
    const cycleLabels = { daily: 'ì¼ë‚©ìž…ê¸ˆ', weekly: 'ì£¼ë‚©ìž…ê¸ˆ', monthly: 'ì›”ë‚©ìž…ê¸ˆ' };
    const cycleLabel = cycleLabels[c.payment_cycle] || 'ì›”ë‚©ìž…ê¸ˆ';
    
    document.getElementById('quick-payment-info').textContent = `${c.customer_name} - ${c.plate}`;
    document.getElementById('quick-payment-arrears').textContent = fmt(arrears);
    document.getElementById('quick-full-amount').textContent = fmt(arrears);
    document.getElementById('quick-one-amount').textContent = fmt(c.monthly || 0);
    document.getElementById('quick-cycle-label').textContent = `${cycleLabel} 1íšŒë¶„`;
    document.getElementById('quick-custom-amount').value = '';
    
    openModal('quickPaymentModal');
}

async function quickPayFull() {
    const c = contractList.find(x => x.id === quickPaymentContractId);
    if (!c || c.arrears <= 0) {
        showToast('ìˆ˜ë‚©í•  ê¸ˆì•¡ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
    }
    
    await processQuickPayment(c.arrears);
}

async function quickPayOne() {
    const c = contractList.find(x => x.id === quickPaymentContractId);
    if (!c) return;
    
    await processQuickPayment(c.monthly || 0);
}

async function quickPayCustom() {
    const amount = parseInt(document.getElementById('quick-custom-amount').value) || 0;
    if (amount <= 0) {
        showToast('ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    await processQuickPayment(amount);
}

async function processQuickPayment(amount) {
    const contractId = quickPaymentContractId;
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    showToast('ìˆ˜ë‚© ì²˜ë¦¬ ì¤‘...', 'info');
    
    try {
        // ì˜¤ëŠ˜ ë‚ ì§œ
        const now = new Date();
        const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        const today = koreaTime.toISOString().split('T')[0];
        
        // ê²°ì œ ì£¼ê¸°ë³„ ë‚©ìž… ìœ í˜•
        const paymentTypes = { daily: 'ì¼ë‚©', weekly: 'ì£¼ë‚©', monthly: 'ì›”ë‚©' };
        const paymentType = paymentTypes[c.payment_cycle] || 'ì›”ë‚©';
        
        // ë‚©ìž… ê¸°ë¡ ì €ìž¥
        const paymentData = {
            contract_id: contractId,
            payment_date: today,
            amount: amount,
            payment_type: paymentType,
            status: 'paid',
            memo: 'ë¹ ë¥¸ ìˆ˜ë‚©'
        };
        
        const result = await insertToDB('contract_payments', paymentData);
        if (result && result[0]) {
            contractPaymentList.push(result[0]);
        }
        
        // ì—°ì²´ ìž¬ê³„ì‚°
        calculateAllArrears();
        
        showToast(`âœ… ${fmt(amount)} ìˆ˜ë‚© ì™„ë£Œ`);
        closeModal('quickPaymentModal');
        loadContracts();
    } catch (err) {
        console.error('ìˆ˜ë‚© ì²˜ë¦¬ ì˜¤ë¥˜:', err);
        showToast('âŒ ìˆ˜ë‚© ì²˜ë¦¬ ì‹¤íŒ¨', 'error');
    }
}

function openPaymentModal(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    document.getElementById('pm-contract-id').value = contractId;
    document.getElementById('pm-contract-info').textContent = `${c.customer_name} - ${c.plate}`;
    document.getElementById('pm-amount').value = c.monthly || 0;
    
    // ì˜¤ëŠ˜ ë‚ ì§œ
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    document.getElementById('pm-date').value = koreaTime.toISOString().split('T')[0];
    
    openModal('paymentModal');
}

async function submitPayment(e) {
    e.preventDefault();
    showToast('ì €ìž¥ ì¤‘...', 'info');
    
    const contractId = parseInt(document.getElementById('pm-contract-id').value);
    const amount = parseInt(document.getElementById('pm-amount').value) || 0;
    
    const paymentData = {
        contract_id: contractId,
        payment_date: document.getElementById('pm-date').value,
        amount: amount,
        payment_type: document.getElementById('pm-type').value,
        status: 'paid', // ìˆ˜ë™ ë“±ë¡ì€ ì™„ë£Œ ìƒíƒœ
        memo: document.getElementById('pm-memo').value || null
    };
    
    const result = await insertToDB('contract_payments', paymentData);
    if (result && result[0]) {
        contractPaymentList.push(result[0]);
        
        // ê³„ì•½ ì—°ì²´ê¸ˆ ì°¨ê°
        const contract = contractList.find(c => c.id === contractId);
        if (contract) {
            const newArrears = Math.max(0, (contract.arrears || 0) - amount);
            await updateInDB('contracts', contractId, { arrears: newArrears });
            contract.arrears = newArrears;
        }
    }
    
    showToast('âœ… ë‚©ìž…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('paymentModal');
    document.getElementById('paymentForm').reset();
    
    // ê³„ì•½ ìƒì„¸ ìƒˆë¡œê³ ì¹¨
    viewContractDetail(contractId);
}

async function deleteContractPayment(paymentId, contractId) {
    if (!confirm('ì´ ë‚©ìž… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await deleteFromDB('contract_payments', paymentId);
    contractPaymentList = contractPaymentList.filter(p => p.id !== paymentId);
    showToast('ðŸ—‘ï¸ ë‚©ìž… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    
    // ê³„ì•½ ìƒì„¸ ìƒˆë¡œê³ ì¹¨
    viewContractDetail(contractId);
}

function editContract(id) {
    closeModal('contractDetailModal');
    const c = contractList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('contractModalTitle').textContent = 'ðŸ“‹ ê³„ì•½ ìˆ˜ì •';
    document.getElementById('contractSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('contract-edit-id').value = c.id;
    document.getElementById('con-customer').value = c.customer_name;
    document.getElementById('con-phone').value = c.phone;
    document.getElementById('con-vehicle').value = c.vehicle;
    document.getElementById('con-plate').value = c.plate;
    document.getElementById('con-deposit').value = c.deposit || 0;
    document.getElementById('con-monthly').value = c.monthly;
    document.getElementById('con-start').value = c.start_date;
    document.getElementById('con-end').value = c.end_date || '';
    document.getElementById('con-fuel').value = c.fuel_type || 'íœ˜ë°œìœ ';
    document.getElementById('con-memo').value = c.memo || '';
    document.getElementById('con-status').value = c.status || 'active';
    
    // ê³„ì•½ ìœ í˜• ì„ íƒ
    const typeRadio = document.querySelector(`input[name="contract_type"][value="${c.type || 'rent'}"]`);
    if (typeRadio) typeRadio.checked = true;
    
    // ê²°ì œ íƒ€ìž… ì„ íƒ
    const cycleRadio = document.querySelector(`input[name="payment_cycle"][value="${c.payment_cycle || 'monthly'}"]`);
    if (cycleRadio) cycleRadio.checked = true;
    document.getElementById('con-payment-day').value = c.payment_day || 1;
    togglePaymentDay();
    
    // ì—°ëŒ€ë³´ì¦ì¸
    if (c.guarantor_name) {
        document.getElementById('con-has-guarantor').checked = true;
        toggleGuarantor();
        document.getElementById('con-guarantor-name').value = c.guarantor_name || '';
        document.getElementById('con-guarantor-phone').value = c.guarantor_phone || '';
    }
    
    // ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ëª©ë¡ í‘œì‹œ
    const existingDocs = [];
    if (c.contractor_id_url) existingDocs.push('âœ… ê³„ì•½ìž ì‹ ë¶„ì¦');
    if (c.contractor_doc_url) existingDocs.push('âœ… ê³„ì•½ìž ê¸°íƒ€ì„œë¥˜');
    if (c.guarantor_id_url) existingDocs.push('âœ… ë³´ì¦ì¸ ì‹ ë¶„ì¦');
    if (c.guarantor_doc_url) existingDocs.push('âœ… ë³´ì¦ì¸ ê¸°íƒ€ì„œë¥˜');
    if (c.vehicle_reg_url) existingDocs.push('âœ… ì°¨ëŸ‰ë“±ë¡ì¦');
    if (c.vehicle_disposal_url) existingDocs.push('âœ… íì§€ì„œë¥˜');
    if (c.vehicle_doc_url) existingDocs.push('âœ… ì°¨ëŸ‰ ê¸°íƒ€ì„œë¥˜');
    
    const noticeEl = document.getElementById('doc-upload-notice');
    const docsListEl = document.getElementById('existing-docs-list');
    
    if (existingDocs.length > 0) {
        noticeEl.classList.remove('hidden');
        docsListEl.innerHTML = `<div class="text-xs text-lime-400 mb-1">ðŸ“ ê¸°ì¡´ ì²¨ë¶€íŒŒì¼:</div><div class="text-xs text-gray-300">${existingDocs.join(' Â· ')}</div>`;
    } else {
        noticeEl.classList.remove('hidden');
        docsListEl.innerHTML = `<div class="text-xs text-gray-500">ðŸ“ ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ì—†ìŒ</div>`;
    }
    
    // ì°¨ëŸ‰ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë¡œë“œ
    loadContractVehicleOptions();
    
    openModal('contractModal');
}

// ê³„ì•½ ë“±ë¡ ëª¨ë‹¬ ì—´ ë•Œ ì•ˆë‚´ ìˆ¨ê¹€
function openContractModal() {
    document.getElementById('doc-upload-notice').classList.add('hidden');
    document.getElementById('existing-docs-list').innerHTML = '';
    
    // ì°¨ëŸ‰ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë¡œë“œ
    loadContractVehicleOptions();
    
    openModal('contractModal');
}

// ì°¨ëŸ‰ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë¡œë“œ
function loadContractVehicleOptions() {
    const select = document.getElementById('con-vehicle-select');
    select.innerHTML = '<option value="">-- ì§ì ‘ ìž…ë ¥ ë˜ëŠ” ì„ íƒ --</option>';
    
    // ìž…ê³  ìƒíƒœ ì°¨ëŸ‰ë§Œ
    const availableVehicles = vehicleList.filter(v => v.status === 'ìž…ê³ ');
    
    // ì´ë¥œì°¨
    const motorcycles = availableVehicles.filter(v => (v.vehicle_type || 'motorcycle') === 'motorcycle');
    if (motorcycles.length > 0) {
        select.innerHTML += '<optgroup label="ðŸï¸ ì´ë¥œì°¨">';
        motorcycles.forEach(v => {
            select.innerHTML += `<option value="${v.id}">[ì´ë¥œ] ${v.model} - ${v.plate}</option>`;
        });
        select.innerHTML += '</optgroup>';
    }
    
    // ìžë™ì°¨
    const cars = availableVehicles.filter(v => v.vehicle_type === 'car');
    if (cars.length > 0) {
        select.innerHTML += '<optgroup label="ðŸš— ìžë™ì°¨">';
        cars.forEach(v => {
            select.innerHTML += `<option value="${v.id}">[ìžë™ì°¨] ${v.model} - ${v.plate}</option>`;
        });
        select.innerHTML += '</optgroup>';
    }
}

// ì°¨ëŸ‰ ì„ íƒ ì‹œ ìžë™ ìž…ë ¥
function onContractVehicleSelect() {
    const select = document.getElementById('con-vehicle-select');
    const vehicleId = select.value;
    const infoBox = document.getElementById('con-vehicle-info');
    
    if (!vehicleId) {
        infoBox.classList.add('hidden');
        return;
    }
    
    const vehicle = vehicleList.find(v => v.id === parseInt(vehicleId));
    if (vehicle) {
        document.getElementById('con-vehicle').value = vehicle.model;
        document.getElementById('con-plate').value = vehicle.plate;
        document.getElementById('con-fuel').value = vehicle.fuel_type || 'íœ˜ë°œìœ ';
        
        // ì°¨ëŸ‰ ìœ í˜• í‘œì‹œ
        const vType = vehicle.vehicle_type || 'motorcycle';
        const typeLabel = vType === 'car' ? 'ðŸš— ìžë™ì°¨' : 'ðŸï¸ ì´ë¥œì°¨';
        const typeColor = vType === 'car' ? 'text-blue-400' : 'text-orange-400';
        
        infoBox.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="${typeColor} font-bold">${typeLabel}</span>
                <span class="text-gray-400">${vehicle.year}ë…„ì‹ Â· ${vehicle.color || '-'}</span>
            </div>
            ${vehicle.insurance ? `<div class="text-gray-500 mt-1">ë³´í—˜: ${vehicle.insurance} ${vehicle.insurance_expiry ? '(~' + vehicle.insurance_expiry + ')' : ''}</div>` : ''}
        `;
        infoBox.classList.remove('hidden');
    }
}

// ì—°ëŒ€ë³´ì¦ì¸ í† ê¸€
function toggleGuarantor() {
    const checked = document.getElementById('con-has-guarantor').checked;
    document.getElementById('guarantor-section').classList.toggle('hidden', !checked);
}

// ê²°ì œ íƒ€ìž…ì— ë”°ë¼ ë‚©ìž…ì¼ ìž…ë ¥ í‘œì‹œ/ìˆ¨ê¹€
function togglePaymentDay() {
    const cycle = document.querySelector('input[name="payment_cycle"]:checked')?.value || 'monthly';
    const section = document.getElementById('payment-day-section');
    if (cycle === 'monthly') {
        section.style.display = 'flex';
    } else {
        section.style.display = 'none';
    }
}

// ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ­ ì „í™˜
let currentContractType = ''; // ì „ì²´
function switchContractType(type) {
    currentContractType = type;
    document.getElementById('contract-tab-all').className = type === '' 
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-lime-500/20 text-lime-400 border border-lime-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    document.getElementById('contract-tab-rent').className = type === 'rent' 
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-purple-500/20 text-purple-400 border border-purple-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    document.getElementById('contract-tab-lease').className = type === 'lease'
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-pink-500/20 text-pink-400 border border-pink-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    loadContracts();
}

// íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
async function uploadFile(file, folder) {
    if (!file) return null;
    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const filePath = `${folder}/${fileName}`;
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const res = await fetch(`${SUPABASE_URL}/storage/v1/object/documents/${filePath}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY,
                'Content-Type': file.type || 'application/octet-stream',
                'x-upsert': 'true'
            },
            body: arrayBuffer
        });
        
        if (res.ok) {
            console.log('Upload success:', filePath);
            return `${SUPABASE_URL}/storage/v1/object/public/documents/${filePath}`;
        } else {
            const err = await res.text();
            console.error('Upload failed:', res.status, err);
        }
    } catch (e) {
        console.error('Upload error:', e);
    }
    return null;
}

async function submitContract(e) {
    e.preventDefault();
    showToast('ì €ìž¥ ì¤‘...', 'info');
    
    try {
    const editId = document.getElementById('contract-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    // ê¸°ì¡´ ê³„ì•½ ì •ë³´ (ìˆ˜ì • ì‹œ)
    const existingContract = editId ? contractList.find(x => x.id === parseInt(editId)) : null;
    
    // íŒŒì¼ ì—…ë¡œë“œ
    const contractorIdFile = document.getElementById('con-contractor-id').files[0];
    const contractorDocFile = document.getElementById('con-contractor-doc').files[0];
    const guarantorIdFile = document.getElementById('con-guarantor-id').files[0];
    const guarantorDocFile = document.getElementById('con-guarantor-doc').files[0];
    const vehicleRegFile = document.getElementById('con-vehicle-reg').files[0];
    const vehicleDisposalFile = document.getElementById('con-vehicle-disposal').files[0];
    const vehicleDocFile = document.getElementById('con-vehicle-doc').files[0];
    
    const [contractorIdUrl, contractorDocUrl, guarantorIdUrl, guarantorDocUrl, vehicleRegUrl, vehicleDisposalUrl, vehicleDocUrl] = await Promise.all([
        uploadFile(contractorIdFile, 'contractor'),
        uploadFile(contractorDocFile, 'contractor'),
        uploadFile(guarantorIdFile, 'guarantor'),
        uploadFile(guarantorDocFile, 'guarantor'),
        uploadFile(vehicleRegFile, 'vehicle'),
        uploadFile(vehicleDisposalFile, 'vehicle'),
        uploadFile(vehicleDocFile, 'vehicle')
    ]);
    
    const contractData = {
        customer_name: d.customer_name,
        phone: d.phone,
        vehicle: d.vehicle,
        plate: d.plate,
        deposit: parseInt(d.deposit) || 0,
        monthly: parseInt(d.monthly) || 0,
        start_date: d.start_date,
        end_date: d.end_date || null,
        fuel_type: d.fuel_type || 'íœ˜ë°œìœ ',
        memo: d.memo || null,
        type: d.contract_type || 'rent',
        status: d.status || 'active',
        payment_cycle: d.payment_cycle || 'monthly',
        payment_day: parseInt(d.payment_day) || 1,
        guarantor_name: d.guarantor_name || null,
        guarantor_phone: d.guarantor_phone || null,
        // ê¸°ì¡´ URL ìœ ì§€ (ìƒˆ íŒŒì¼ ì—†ìœ¼ë©´ ê¸°ì¡´ ê°’ ì‚¬ìš©)
        contractor_id_url: contractorIdUrl || (existingContract ? existingContract.contractor_id_url : null),
        contractor_doc_url: contractorDocUrl || (existingContract ? existingContract.contractor_doc_url : null),
        guarantor_id_url: guarantorIdUrl || (existingContract ? existingContract.guarantor_id_url : null),
        guarantor_doc_url: guarantorDocUrl || (existingContract ? existingContract.guarantor_doc_url : null),
        vehicle_reg_url: vehicleRegUrl || (existingContract ? existingContract.vehicle_reg_url : null),
        vehicle_disposal_url: vehicleDisposalUrl || (existingContract ? existingContract.vehicle_disposal_url : null),
        vehicle_doc_url: vehicleDocUrl || (existingContract ? existingContract.vehicle_doc_url : null)
    };
    
    // ê³„ì•½ ìƒíƒœ ë³€ê²½ ì‹œ ì°¨ëŸ‰ ìƒíƒœë„ ì—°ë™
    const oldContract = existingContract;
    const newStatus = d.status;
    
    if (editId) {
        await updateInDB('contracts', editId, contractData);
        const c = contractList.find(x => x.id === parseInt(editId));
        if (c) Object.assign(c, contractData);
        
        // ì°¨ëŸ‰ ìƒíƒœ ì—°ë™
        if (oldContract && oldContract.plate) {
            const linkedVehicle = vehicleList.find(v => v.plate === oldContract.plate);
            if (linkedVehicle) {
                if (newStatus === 'active' && linkedVehicle.status !== 'ì¶œê³ ') {
                    await updateInDB('vehicles', linkedVehicle.id, { status: 'ì¶œê³ ', contract_id: parseInt(editId) });
                    linkedVehicle.status = 'ì¶œê³ ';
                    linkedVehicle.contract_id = parseInt(editId);
                } else if ((newStatus === 'completed' || newStatus === 'cancelled') && linkedVehicle.status === 'ì¶œê³ ') {
                    await updateInDB('vehicles', linkedVehicle.id, { status: 'ë°˜ë‚©', contract_id: null });
                    linkedVehicle.status = 'ë°˜ë‚©';
                    linkedVehicle.contract_id = null;
                }
            }
        }
        
        showToast('âœ… ê³„ì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ì‹œìž‘ì¼ë¶€í„° í˜„ìž¬ê¹Œì§€ ì›” ìˆ˜ ê³„ì‚° â†’ ì—°ì²´ê¸ˆ ìžë™ ê³„ì‚°
        const startDate = new Date(d.start_date);
        const today = new Date();
        const monthsDiff = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
        const totalDue = Math.max(0, monthsDiff) * (parseInt(d.monthly) || 0); // ì‹œìž‘ì›”ë¶€í„° ì „ì›”ê¹Œì§€
        
        contractData.arrears = totalDue; // ë¯¸ë‚©ê¸ˆ = ë‚©ë¶€í•´ì•¼í•  ì´ì•¡ (ë‚˜ì¤‘ì— ìˆ˜ë‚©í•˜ë©´ ì°¨ê°)
        const result = await insertToDB('contracts', contractData);
        
        if (result && result[0]) {
            contractList.unshift(result[0]);
            
            // ì‹œìž‘ì¼ë¶€í„° í˜„ìž¬ê¹Œì§€ ì›”ë³„ ë‚©ìž… ì˜ˆì • ìžë™ ìƒì„±
            if (monthsDiff > 0) {
                for (let i = 0; i < monthsDiff; i++) {
                    const paymentDate = new Date(startDate);
                    paymentDate.setMonth(paymentDate.getMonth() + i);
                    const dateStr = paymentDate.toISOString().split('T')[0];
                    
                    // ë¯¸ë‚© ìƒíƒœë¡œ ë‚©ìž… ì˜ˆì • ìƒì„±
                    const scheduledPayment = {
                        contract_id: result[0].id,
                        payment_date: dateStr,
                        amount: parseInt(d.monthly) || 0,
                        payment_type: 'ì›”ë‚©',
                        status: 'unpaid',
                        memo: 'ìžë™ ìƒì„± (ë¯¸ë‚©)'
                    };
                    const payResult = await insertToDB('contract_payments', scheduledPayment);
                    if (payResult && payResult[0]) contractPaymentList.push(payResult[0]);
                }
            }
        }
        
        // ê³ ê° ìžë™ ë“±ë¡ (ì¤‘ë³µ ì²´í¬)
        const existingCustomer = customerList.find(cust => 
            cust.name === d.customer_name || cust.phone === d.phone
        );
        if (!existingCustomer) {
            const customerData = {
                name: d.customer_name,
                phone: d.phone,
                grade: 'ì¤‘',
                memo: `ê³„ì•½ ë“±ë¡ ì‹œ ìžë™ ì¶”ê°€ (${d.vehicle} ${d.plate})`
            };
            const custResult = await insertToDB('customers', customerData);
            if (custResult && custResult[0]) customerList.push(custResult[0]);
        }
        
        // ì„ íƒí•œ ì°¨ëŸ‰ ìƒíƒœë¥¼ ì¶œê³ ë¡œ ë³€ê²½
        const selectedVehicleId = document.getElementById('con-vehicle-select').value;
        if (selectedVehicleId && result && result[0]) {
            const linkedVehicle = vehicleList.find(v => v.id === parseInt(selectedVehicleId));
            if (linkedVehicle) {
                await updateInDB('vehicles', linkedVehicle.id, { status: 'ì¶œê³ ', contract_id: result[0].id });
                linkedVehicle.status = 'ì¶œê³ ';
                linkedVehicle.contract_id = result[0].id;
            }
        }
        
        showToast('âœ… ê³„ì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('contractModal');
    document.getElementById('contractForm').reset();
    document.getElementById('contract-edit-id').value = '';
    document.getElementById('guarantor-section').classList.add('hidden');
    document.getElementById('con-has-guarantor').checked = false;
    document.getElementById('contractModalTitle').textContent = 'ðŸ“‹ ê³„ì•½ ë“±ë¡';
    document.getElementById('contractSubmitBtn').textContent = 'ë“±ë¡';
    loadContracts();
    } catch (err) {
        console.error('ê³„ì•½ ì €ìž¥ ì˜¤ë¥˜:', err);
        showToast('âŒ ì €ìž¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
    }
}

async function deleteContract(id) {
    if (!confirm('ì •ë§ ì´ ê³„ì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await deleteFromDB('contracts', id);
    contractList = contractList.filter(c => c.id !== id);
    showToast('âœ… ê³„ì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('contractDetailModal');
    loadContracts();
}

// ======================= ì •ì‚°ê´€ë¦¬: ì°¨ëŸ‰ê´€ë¦¬ =======================
const vStatusBadge = s => ({ 'ìž…ê³ ': ['badge-active', 'ìž…ê³ (ëŒ€ê¸°)'], 'ì¶œê³ ': ['badge-completed', 'ì¶œê³ (ê³„ì•½ì¤‘)'], 'ë°˜ë‚©': ['badge-pending', 'ë°˜ë‚©(ì ê²€)'], 'ì •ë¹„': ['badge-delinquent', 'ì •ë¹„ì¤‘'], 'íì°¨': ['badge-staff', 'íì°¨/ë§¤ê°'] }[s] || ['', '']);

// ì°¨ëŸ‰ ìœ í˜• íƒ­
let currentVehicleType = 'all';

function switchVehicleType(type) {
    currentVehicleType = type;
    
    // íƒ­ ìŠ¤íƒ€ì¼ ë³€ê²½
    const tabs = ['all', 'motorcycle', 'car'];
    const colors = {
        all: ['lime', 'ðŸ“‹ ì „ì²´ë³´ê¸°'],
        motorcycle: ['orange', 'ðŸï¸ ì´ë¥œì°¨'],
        car: ['blue', 'ðŸš— ìžë™ì°¨']
    };
    
    tabs.forEach(t => {
        const btn = document.getElementById('v-tab-' + t);
        if (btn) {
            const color = colors[t][0];
            btn.className = t === type 
                ? `flex-1 py-3 rounded-xl font-bold text-sm bg-${color}-500/20 border-2 border-${color}-500 text-${color}-400`
                : 'flex-1 py-3 rounded-xl font-bold text-sm bg-white/5 border border-white/20 text-gray-400';
        }
    });
    
    loadVehicles();
}

function openVehicleModal() {
    document.getElementById('vehicleModalTitle').textContent = 'ðŸš— ì°¨ëŸ‰ ë“±ë¡';
    document.getElementById('vehicleSubmitBtn').textContent = 'ë“±ë¡';
    document.getElementById('vehicle-edit-id').value = '';
    document.getElementById('vehicleForm').reset();
    document.getElementById('veh-doc-notice').classList.add('hidden');
    document.getElementById('veh-reg-file').value = '';
    document.getElementById('veh-ins-file').value = '';
    
    // í˜„ìž¬ ì„ íƒëœ íƒ­ì— ë§žê²Œ ì°¨ëŸ‰ìœ í˜• ê¸°ë³¸ê°’ ì„¤ì •
    let defaultType = 'motorcycle';
    if (currentVehicleType === 'car') defaultType = 'car';
    
    const typeRadio = document.querySelector(`input[name="vehicle_type"][value="${defaultType}"]`);
    if (typeRadio) typeRadio.checked = true;
    
    openModal('vehicleModal');
}

function loadVehicles() {
    const search = document.getElementById('vehicle-search').value.toLowerCase();
    const status = document.getElementById('vehicle-status').value;
    
    // ë§¤ìž…ì°¨ëŸ‰ ìƒí’ˆí™” ì™„ë£Œëœ ê²ƒë“¤ í•©ì¹˜ê¸°
    const completedPurchases = purchaseList.filter(p => p.status === 'ì™„ë£Œ').map(p => ({
        id: 'pur_' + p.id,
        plate: p.plate,
        model: p.model,
        year: p.year || '-',
        color: p.color || '-',
        mileage: p.mileage || 0,
        status: 'ìž…ê³ ',
        memo: p.memo,
        is_purchase: true,
        purchase_id: p.id,
        purchase_price: p.purchase_price,
        sell_price: p.sell_price,
        vehicle_type: 'motorcycle' // ë§¤ìž…ì°¨ëŸ‰ì€ ì´ë¥œì°¨
    }));
    
    // ê¸°ì¡´ ì°¨ëŸ‰ + ë§¤ìž…ì™„ë£Œ ì°¨ëŸ‰
    let allVehicles = [...vehicleList, ...completedPurchases];
    
    // ì°¨ëŸ‰ìœ í˜• í•„í„°
    if (currentVehicleType !== 'all') {
        allVehicles = allVehicles.filter(v => (v.vehicle_type || 'motorcycle') === currentVehicleType);
    }
    
    let list = allVehicles;
    if (status) list = list.filter(v => v.status === status);
    if (search) list = list.filter(v => (v.plate && v.plate.toLowerCase().includes(search)) || (v.model && v.model.toLowerCase().includes(search)));
    
    // ìš”ì•½
    document.getElementById('v-stock').textContent = allVehicles.filter(v => v.status === 'ìž…ê³ ').length + 'ëŒ€';
    document.getElementById('v-return').textContent = allVehicles.filter(v => v.status === 'ë°˜ë‚©').length + 'ëŒ€';
    document.getElementById('v-repair').textContent = allVehicles.filter(v => v.status === 'ì •ë¹„').length + 'ëŒ€';
    document.getElementById('v-disposed').textContent = allVehicles.filter(v => v.status === 'íì°¨').length + 'ëŒ€';
    
    // í…Œì´ë¸”
    const typeIcon = { motorcycle: 'ðŸï¸', car: 'ðŸš—' };
    let h = '';
    list.forEach(v => {
        const [sc, sl] = vStatusBadge(v.status);
        const contract = v.contract_id ? contractList.find(c => c.id === v.contract_id) : null;
        const isPurchase = v.is_purchase;
        const icon = typeIcon[v.vehicle_type || 'motorcycle'] || 'ðŸï¸';
        h += `<tr onclick="${isPurchase ? `viewPurchaseVehicle(${v.purchase_id})` : `viewVehicleDetail(${v.id})`}" class="cursor-pointer">
            <td class="text-center">${icon}</td>
            <td class="font-mono font-bold ${isPurchase ? 'text-cyan-400' : 'text-lime-400'}">${v.plate}${isPurchase ? ' ðŸ·ï¸' : ''}</td>
            <td>${v.model}</td>
            <td>${v.year}</td>
            <td>${v.color || '-'}</td>
            <td>${(v.mileage || 0).toLocaleString()} km</td>
            <td><span class="badge ${sc}">${sl}</span></td>
            <td class="${contract ? 'text-blue-400' : 'text-gray-500'}">${contract ? '#' + String(contract.id).padStart(3,'0') : isPurchase ? 'ë§¤ìž…' : '-'}</td>
        </tr>`;
    });
    document.getElementById('vehicle-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">ì°¨ëŸ‰ ì—†ìŒ</td></tr>';
}

// ë§¤ìž…ì°¨ëŸ‰ ìƒì„¸ë³´ê¸° (ì •ì‚°ê´€ë¦¬ì—ì„œ)
function viewPurchaseVehicle(purchaseId) {
    const p = purchaseList.find(x => x.id === purchaseId);
    if (!p) return;
    
    const totalCost = (p.purchase_price || 0) + (p.parts_cost || 0) + (p.labor_cost || 0) + (p.other_cost || 0);
    const profit = (p.sell_price || 0) - totalCost;
    
    document.getElementById('vehicle-detail-content').innerHTML = `
        <div class="p-3 rounded-lg bg-cyan-400/10 border border-cyan-400/30 mb-4">
            <div class="text-xs text-cyan-400 font-bold">ðŸ·ï¸ ë¸Œë¡œëª¨í„°ìŠ¤ ë§¤ìž…ì°¨ëŸ‰</div>
        </div>
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span class="text-cyan-400 font-bold">${p.plate}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge badge-complete">ìƒí’ˆí™” ì™„ë£Œ</span></div>
                <div class="info-row"><span class="info-label">ëª¨ë¸</span><span class="font-bold">${p.model}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì‹</span><span>${p.year || '-'}ë…„</span></div>
                <div class="info-row"><span class="info-label">ìƒ‰ìƒ</span><span>${p.color || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì£¼í–‰ê±°ë¦¬</span><span>${(p.mileage || 0).toLocaleString()} km</span></div>
            </div>
        </div>
        <div class="p-4 rounded-lg bg-yellow-400/10 border border-yellow-400/30 mb-4">
            <div class="text-xs text-yellow-400 mb-2">ðŸ’° ë¹„ìš© ì •ë³´</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-400">ë§¤ìž…ê°€</span><span>${fmt(p.purchase_price || 0)}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ìˆ˜ë¦¬ë¹„</span><span>${fmt((p.parts_cost || 0) + (p.labor_cost || 0))}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ì´ ë¹„ìš©</span><span class="text-red-400 font-bold">${fmt(totalCost)}</span></div>
                <div class="flex justify-between"><span class="text-gray-400">íŒë§¤ê°€</span><span class="text-blue-400 font-bold">${fmt(p.sell_price || 0)}</span></div>
            </div>
            <div class="border-t border-white/10 mt-2 pt-2 flex justify-between">
                <span class="font-bold">ì˜ˆìƒ ìˆ˜ìµ</span>
                <span class="font-bold ${profit >= 0 ? 'text-emerald-400' : 'text-red-400'}">${fmt(profit)}</span>
            </div>
        </div>
        ${p.memo ? `<div class="p-3 rounded-lg bg-white/5 text-sm text-gray-400 mb-4">ðŸ“ ${p.memo}</div>` : ''}
        <div class="flex gap-3">
            <button onclick="closeModal('vehicleDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="goToBromotorsPurchase()" class="btn-primary flex-1">ë¸Œë¡œëª¨í„°ìŠ¤ì—ì„œ ë³´ê¸°</button>
        </div>
    `;
    openModal('vehicleDetailModal');
}

// ë¸Œë¡œëª¨í„°ìŠ¤ ë§¤ìž…ì°¨ëŸ‰ íƒ­ìœ¼ë¡œ ì´ë™
function goToBromotorsPurchase() {
    closeModal('vehicleDetailModal');
    // ì •ì‚°ê´€ë¦¬ ìˆ¨ê¸°ê³  ë¸Œë¡œëª¨í„°ìŠ¤ í‘œì‹œ
    document.getElementById('settlementSystem').classList.add('hidden');
    document.getElementById('bromotorsSystem').classList.remove('hidden');
    document.getElementById('b-userName').textContent = currentUser.name;
    document.getElementById('b-userRole').textContent = roleBadge(currentUser.role)[1];
    currentSystem = 'bromotors';
    // ë§¤ìž…ì°¨ëŸ‰ íƒ­ìœ¼ë¡œ ì´ë™
    showBromotorsTab('purchase');
}

function filterVehicles(status) {
    document.getElementById('vehicle-status').value = status;
    loadVehicles();
}

function viewVehicleDetail(id) {
    const v = vehicleList.find(x => x.id === id);
    if (!v) return;
    
    const [sc, sl] = vStatusBadge(v.status);
    const contract = v.contract_id ? contractList.find(c => c.id === v.contract_id) : null;
    const typeLabels = { motorcycle: ['text-orange-400', 'ðŸï¸ ì´ë¥œì°¨'], car: ['text-blue-400', 'ðŸš— ìžë™ì°¨'] };
    const typeBadge = typeLabels[v.vehicle_type || 'motorcycle'] || typeLabels.motorcycle;
    
    let actionBtns = '';
    if (v.status === 'ìž…ê³ ') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ì¶œê³ ')" class="btn-primary flex-1">ðŸ“¤ ì¶œê³ </button><button onclick="changeVehicleStatus(${v.id}, 'ì •ë¹„')" class="btn-secondary flex-1">ðŸ”§ ì •ë¹„</button>`;
    else if (v.status === 'ì¶œê³ ') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ë°˜ë‚©')" class="btn-primary flex-1">ðŸ”„ ë°˜ë‚©</button>`;
    else if (v.status === 'ë°˜ë‚©') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ìž…ê³ ')" class="btn-primary flex-1">âœ… ì ê²€ì™„ë£Œ</button><button onclick="changeVehicleStatus(${v.id}, 'ì •ë¹„')" class="btn-secondary flex-1">ðŸ”§ ì •ë¹„</button>`;
    else if (v.status === 'ì •ë¹„') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ìž…ê³ ')" class="btn-primary flex-1">âœ… ì •ë¹„ì™„ë£Œ</button>`;
    
    // íì°¨/ë§¤ê° ë²„íŠ¼ (ì¶œê³  ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ)
    if (v.status !== 'ì¶œê³ ' && v.status !== 'íì°¨') {
        actionBtns += `<button onclick="changeVehicleStatus(${v.id}, 'íì°¨')" class="flex-1 p-2 rounded-lg bg-red-500/20 border border-red-500/50 text-red-400 text-sm hover:bg-red-500/30">ðŸš« íì°¨/ë§¤ê°</button>`;
    }
    
    // ë³´í—˜ ë§Œë£Œ D-Day ê³„ì‚°
    let insuranceWarning = '';
    if (v.insurance_expiry) {
        const today = new Date();
        const expiry = new Date(v.insurance_expiry);
        const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) insuranceWarning = `<span class="text-red-400 font-bold">ë§Œë£Œë¨!</span>`;
        else if (diffDays <= 30) insuranceWarning = `<span class="text-orange-400">D-${diffDays}</span>`;
        else insuranceWarning = `<span class="text-gray-400">D-${diffDays}</span>`;
    }
    
    document.getElementById('vehicle-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span class="text-lime-400 font-bold">${v.plate}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${sc}">${sl}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰ìœ í˜•</span><span class="${typeBadge[0]} font-bold">${typeBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ëª¨ë¸</span><span class="font-bold">${v.model}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì‹</span><span>${v.year}ë…„</span></div>
                <div class="info-row"><span class="info-label">ìƒ‰ìƒ</span><span>${v.color || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë£Œ</span><span>${v.fuel_type || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì£¼í–‰ê±°ë¦¬</span><span>${(v.mileage || 0).toLocaleString()} km</span></div>
                ${v.vin ? `<div class="info-row col-span-2"><span class="info-label">ì°¨ëŒ€ë²ˆí˜¸</span><span class="font-mono text-xs">${v.vin}</span></div>` : ''}
                ${contract ? `<div class="info-row col-span-2"><span class="info-label">ì—°ê²°ê³„ì•½</span><span class="text-blue-400">#${String(contract.id).padStart(3,'0')} ${contract.customer_name}</span></div>` : ''}
            </div>
        </div>
        
        ${v.insurance ? `
        <div class="p-4 rounded-lg bg-blue-400/10 border border-blue-400/30 mb-4">
            <div class="text-xs text-blue-400 mb-2">ðŸ›¡ï¸ ë³´í—˜ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-gray-400">ë³´í—˜ì‚¬:</span> <span class="font-bold">${v.insurance}</span></div>
                <div><span class="text-gray-400">ë§Œë£Œì¼:</span> <span>${v.insurance_expiry || '-'}</span> ${insuranceWarning}</div>
                ${v.insurance_no ? `<div><span class="text-gray-400">ì¦ê¶Œë²ˆí˜¸:</span> <span>${v.insurance_no}</span></div>` : ''}
                ${v.insurance_fee ? `<div><span class="text-gray-400">ë³´í—˜ë£Œ:</span> <span>${fmt(v.insurance_fee)}/ì›”</span></div>` : ''}
            </div>
        </div>` : ''}
        
        ${(v.last_maintenance || v.next_maintenance || v.maintenance_history) ? `
        <div class="p-4 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
            <div class="text-xs text-orange-400 mb-2">ðŸ”§ ì •ë¹„ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                ${v.last_maintenance ? `<div><span class="text-gray-400">ìµœê·¼ ì •ë¹„:</span> <span>${v.last_maintenance}</span></div>` : ''}
                ${v.next_maintenance ? `<div><span class="text-gray-400">ë‹¤ìŒ ì˜ˆì •:</span> <span>${v.next_maintenance}</span></div>` : ''}
            </div>
            ${v.maintenance_history ? `<div class="mt-2 p-2 rounded bg-white/5 text-xs text-gray-300 whitespace-pre-line">${v.maintenance_history}</div>` : ''}
        </div>` : ''}
        
        ${(v.purchase_date || v.purchase_price) ? `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-cyan-400 mb-2">ðŸ’° ì·¨ë“ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                ${v.purchase_date ? `<div><span class="text-gray-400">ì·¨ë“ì¼:</span> <span>${v.purchase_date}</span></div>` : ''}
                ${v.purchase_price ? `<div><span class="text-gray-400">ì·¨ë“ê°€:</span> <span class="text-cyan-400 font-bold">${fmt(v.purchase_price)}</span></div>` : ''}
            </div>
        </div>` : ''}
        
        ${v.memo ? `<div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4"><div class="text-xs text-lime-400 mb-2">ðŸ“ ë©”ëª¨</div><div class="text-sm">${v.memo}</div></div>` : ''}
        
        ${(v.reg_doc_url || v.insurance_doc_url) ? `
        <div class="p-4 rounded-lg bg-purple-400/10 border border-purple-400/30 mb-4">
            <div class="text-xs text-purple-400 mb-2">ðŸ“Ž ì²¨ë¶€ ì„œë¥˜</div>
            <div class="flex gap-3">
                ${v.reg_doc_url ? `<a href="${v.reg_doc_url}" target="_blank" class="px-3 py-2 rounded bg-purple-500/20 text-purple-400 text-sm hover:bg-purple-500/30">ðŸ“„ ì°¨ëŸ‰ë“±ë¡ì¦</a>` : ''}
                ${v.insurance_doc_url ? `<a href="${v.insurance_doc_url}" target="_blank" class="px-3 py-2 rounded bg-blue-500/20 text-blue-400 text-sm hover:bg-blue-500/30">ðŸ“„ ë³´í—˜ì¦ì„œ</a>` : ''}
            </div>
        </div>` : ''}
        
        <div class="flex gap-3 mb-3">${actionBtns}</div>
        <div class="flex gap-3">
            <button onclick="deleteVehicle(${v.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('vehicleDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editVehicle(${v.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('vehicleDetailModal');
}

function changeVehicleStatus(id, newStatus) {
    const v = vehicleList.find(x => x.id === id);
    if (v) {
        v.status = newStatus;
        if (newStatus !== 'ì¶œê³ ') v.contract_id = null;
    }
    showToast(`âœ… ì°¨ëŸ‰ ìƒíƒœê°€ "${newStatus}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
    closeModal('vehicleDetailModal');
    loadVehicles();
}

function editVehicle(id) {
    closeModal('vehicleDetailModal');
    const v = vehicleList.find(x => x.id === id);
    if (!v) return;
    
    document.getElementById('vehicleModalTitle').textContent = 'ðŸš— ì°¨ëŸ‰ ìˆ˜ì •';
    document.getElementById('vehicleSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('vehicle-edit-id').value = v.id;
    
    // ê¸°ë³¸ ì •ë³´
    document.getElementById('veh-plate').value = v.plate;
    document.getElementById('veh-model').value = v.model;
    document.getElementById('veh-year').value = v.year;
    document.getElementById('veh-color').value = v.color || '';
    document.getElementById('veh-mileage').value = v.mileage;
    document.getElementById('veh-fuel').value = v.fuel_type || 'íœ˜ë°œìœ ';
    document.getElementById('veh-vin').value = v.vin || '';
    
    // ë³´í—˜ ì •ë³´
    document.getElementById('veh-insurance').value = v.insurance || '';
    document.getElementById('veh-ins-expiry').value = v.insurance_expiry || '';
    document.getElementById('veh-ins-no').value = v.insurance_no || '';
    document.getElementById('veh-ins-fee').value = v.insurance_fee || 0;
    
    // ì •ë¹„ ì •ë³´
    document.getElementById('veh-last-maint').value = v.last_maintenance || '';
    document.getElementById('veh-next-maint').value = v.next_maintenance || '';
    document.getElementById('veh-maint-history').value = v.maintenance_history || '';
    
    // ê¸°íƒ€
    document.getElementById('veh-purchase-date').value = v.purchase_date || '';
    document.getElementById('veh-purchase-price').value = v.purchase_price || 0;
    document.getElementById('veh-memo').value = v.memo || '';
    
    // ì°¨ëŸ‰ìœ í˜• ì„ íƒ
    const typeRadio = document.querySelector(`input[name="vehicle_type"][value="${v.vehicle_type || 'motorcycle'}"]`);
    if (typeRadio) typeRadio.checked = true;
    
    // ê¸°ì¡´ ì„œë¥˜ í‘œì‹œ
    const hasDoc = v.reg_doc_url || v.insurance_doc_url;
    const docNotice = document.getElementById('veh-doc-notice');
    const existingDocs = document.getElementById('veh-existing-docs');
    
    if (hasDoc) {
        docNotice.classList.remove('hidden');
        let docsHtml = '';
        if (v.reg_doc_url) docsHtml += `<a href="${v.reg_doc_url}" target="_blank" class="text-purple-400 hover:underline">ðŸ“Ž ì°¨ëŸ‰ë“±ë¡ì¦</a> `;
        if (v.insurance_doc_url) docsHtml += `<a href="${v.insurance_doc_url}" target="_blank" class="text-blue-400 hover:underline">ðŸ“Ž ë³´í—˜ì¦ì„œ</a>`;
        existingDocs.innerHTML = docsHtml;
    } else {
        docNotice.classList.add('hidden');
    }
    
    // íŒŒì¼ ìž…ë ¥ ì´ˆê¸°í™”
    document.getElementById('veh-reg-file').value = '';
    document.getElementById('veh-ins-file').value = '';
    
    openModal('vehicleModal');
}

async function submitVehicle(e) {
    e.preventDefault();
    showToast('ì €ìž¥ ì¤‘...', 'info');
    
    try {
        const editId = document.getElementById('vehicle-edit-id').value;
        const d = Object.fromEntries(new FormData(e.target));
        
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        const regFile = document.getElementById('veh-reg-file').files[0];
        const insFile = document.getElementById('veh-ins-file').files[0];
        
        let regUrl = null;
        let insUrl = null;
        
        if (regFile) {
            showToast('ì°¨ëŸ‰ë“±ë¡ì¦ ì—…ë¡œë“œ ì¤‘...', 'info');
            regUrl = await uploadFile(regFile, 'vehicle_docs');
        }
        
        if (insFile) {
            showToast('ë³´í—˜ì¦ì„œ ì—…ë¡œë“œ ì¤‘...', 'info');
            insUrl = await uploadFile(insFile, 'vehicle_docs');
        }
        
        // ê¸°ì¡´ URL ìœ ì§€ (ìˆ˜ì • ì‹œ ìƒˆ íŒŒì¼ ì—†ìœ¼ë©´)
        const existingVehicle = editId ? vehicleList.find(v => v.id === parseInt(editId)) : null;
        
        const vehicleData = {
            plate: d.plate,
            model: d.model,
            year: parseInt(d.year) || 2024,
            color: d.color || '',
            mileage: parseInt(d.mileage) || 0,
            fuel_type: d.fuel_type || 'íœ˜ë°œìœ ',
            vin: d.vin || '',
            insurance: d.insurance || '',
            insurance_expiry: d.insurance_expiry || null,
            insurance_no: d.insurance_no || '',
            insurance_fee: parseInt(d.insurance_fee) || 0,
            last_maintenance: d.last_maintenance || null,
            next_maintenance: d.next_maintenance || null,
            maintenance_history: d.maintenance_history || '',
            purchase_date: d.purchase_date || null,
            purchase_price: parseInt(d.purchase_price) || 0,
            memo: d.memo || '',
            vehicle_type: d.vehicle_type || 'motorcycle',
            reg_doc_url: regUrl || (existingVehicle ? existingVehicle.reg_doc_url : null),
            insurance_doc_url: insUrl || (existingVehicle ? existingVehicle.insurance_doc_url : null)
        };
        
        if (editId) {
            const result = await updateInDB('vehicles', editId, vehicleData);
            if (result === null) {
                showToast('âŒ ì €ìž¥ ì‹¤íŒ¨ - DB ì˜¤ë¥˜', 'error');
                return;
            }
            const v = vehicleList.find(x => x.id === parseInt(editId));
            if (v) Object.assign(v, vehicleData);
            showToast('âœ… ì°¨ëŸ‰ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
            vehicleData.status = 'ìž…ê³ ';
            vehicleData.contract_id = null;
            const result = await insertToDB('vehicles', vehicleData);
            if (result === null) {
                showToast('âŒ ì €ìž¥ ì‹¤íŒ¨ - DB ì˜¤ë¥˜ (ì»¬ëŸ¼ í™•ì¸ í•„ìš”)', 'error');
                return;
            }
            if (result && result[0]) {
                vehicleList.push(result[0]);
            }
            showToast('âœ… ì°¨ëŸ‰ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        closeModal('vehicleModal');
        document.getElementById('vehicleForm').reset();
        document.getElementById('vehicle-edit-id').value = '';
        document.getElementById('vehicleModalTitle').textContent = 'ðŸš— ì°¨ëŸ‰ ë“±ë¡';
        document.getElementById('vehicleSubmitBtn').textContent = 'ë“±ë¡';
        document.getElementById('veh-doc-notice').classList.add('hidden');
        loadVehicles();
    } catch (err) {
        console.error('ì°¨ëŸ‰ ì €ìž¥ ì˜¤ë¥˜:', err);
        showToast('âŒ ì €ìž¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
    }
}

async function deleteVehicle(id) {
    if (!confirm('ì •ë§ ì´ ì°¨ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await deleteFromDB('vehicles', id);
    vehicleList = vehicleList.filter(v => v.id !== id);
    showToast('âœ… ì°¨ëŸ‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('vehicleDetailModal');
    loadVehicles();
}

// ======================= ê³ ê° ê´€ë¦¬ =======================
function filterCustomers(grade) {
    document.getElementById('cust-grade').value = grade;
    loadCustomers();
}

function loadCustomers() {
    const search = document.getElementById('cust-search').value.toLowerCase();
    const grade = document.getElementById('cust-grade').value;
    
    let customers = customerList;
    if (grade) customers = customers.filter(c => c.grade === grade);
    if (search) customers = customers.filter(c => c.name.toLowerCase().includes(search) || c.phone.includes(search));
    
    // ìš”ì•½ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('cust-total').textContent = customerList.length + 'ëª…';
    document.getElementById('cust-high').textContent = customerList.filter(c => c.grade === 'ìƒ').length + 'ëª…';
    document.getElementById('cust-mid').textContent = customerList.filter(c => c.grade === 'ì¤‘').length + 'ëª…';
    document.getElementById('cust-low').textContent = customerList.filter(c => c.grade === 'í•˜').length + 'ëª…';
    
    // í…Œì´ë¸” ë Œë”ë§
    let h = '';
    customers.forEach(c => {
        const [gc, gl] = gradeBadge(c.grade);
        h += `<tr onclick="viewCustomerDetail(${c.id})">
            <td class="font-bold">${c.name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td class="text-gray-400 text-xs">${c.address || '-'}</td>
            <td><span class="badge ${gc}">${gl}</span></td>
            <td class="text-gray-500 text-xs">${c.memo || '-'}</td>
            <td class="text-gray-500 text-xs">${c.created_at}</td>
        </tr>`;
    });
    document.getElementById('cust-tbody').innerHTML = h || '<tr><td colspan="6" class="text-center text-gray-500 py-6">ê³ ê° ì—†ìŒ</td></tr>';
}

function openCustomerModal(editId = null) {
    document.getElementById('customerForm').reset();
    document.getElementById('cust-edit-id').value = '';
    
    if (editId) {
        const c = customerList.find(x => x.id === editId);
        if (c) {
            document.getElementById('customerModalTitle').textContent = 'ðŸ‘¤ ê³ ê° ìˆ˜ì •';
            document.getElementById('customerSubmitBtn').textContent = 'ìˆ˜ì •';
            document.getElementById('cust-edit-id').value = c.id;
            document.getElementById('cust-name').value = c.name;
            document.getElementById('cust-ssn').value = c.ssn || '';
            document.getElementById('cust-phone').value = c.phone;
            document.getElementById('cust-email').value = c.email || '';
            document.getElementById('cust-address').value = c.address || '';
            document.getElementById('cust-grade-select').value = c.grade || '';
            document.getElementById('cust-memo').value = c.memo || '';
        }
    } else {
        document.getElementById('customerModalTitle').textContent = 'ðŸ‘¤ ê³ ê° ë“±ë¡';
        document.getElementById('customerSubmitBtn').textContent = 'ë“±ë¡';
    }
    
    openModal('customerModal');
}

function submitCustomer(e) {
    e.preventDefault();
    const editId = document.getElementById('cust-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // ìˆ˜ì • ëª¨ë“œ
        const c = customerList.find(x => x.id === parseInt(editId));
        if (c) {
            c.name = d.name;
            c.ssn = d.ssn || null;
            c.phone = d.phone;
            c.email = d.email || null;
            c.address = d.address || null;
            c.grade = d.grade;
            c.memo = d.memo || null;
        }
        showToast('âœ… ê³ ê° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ë“±ë¡ ëª¨ë“œ
        customerList.push({
            id: Math.max(...customerList.map(c => c.id)) + 1,
            name: d.name,
            ssn: d.ssn || null,
            phone: d.phone,
            email: d.email || null,
            address: d.address || null,
            grade: d.grade,
            memo: d.memo || null,
            created_at: new Date().toISOString().split('T')[0]
        });
        showToast('âœ… ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('customerModal');
    loadCustomers();
}

function viewCustomerDetail(id) {
    const c = customerList.find(x => x.id === id);
    if (!c) return;
    
    const [gc, gl] = gradeBadge(c.grade);
    
    document.getElementById('customer-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 font-bold mb-3">ðŸ‘¤ ê³ ê° ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.name}</span></div>
                <div class="info-row"><span class="info-label">ì£¼ë¯¼ë²ˆí˜¸</span><span>${c.ssn || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì´ë©”ì¼</span><span>${c.email || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì£¼ì†Œ</span><span>${c.address || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê±°ëž˜ë“±ê¸‰</span><span class="badge ${gc}">${gl}</span></div>
            </div>
        </div>
        
        ${c.memo ? `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 font-bold mb-3">ðŸ“ ë©”ëª¨</div>
            <div class="text-sm text-gray-300">${c.memo}</div>
        </div>
        ` : ''}
        
        <div class="flex gap-3">
            <button onclick="deleteCustomer(${c.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('customerDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editCustomer(${c.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('customerDetailModal');
}

function editCustomer(id) {
    closeModal('customerDetailModal');
    openCustomerModal(id);
}

function deleteCustomer(id) {
    const c = customerList.find(x => x.id === id);
    if (!c) return;
    
    if (!confirm(`ì •ë§ "${c.name}" ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    customerList = customerList.filter(x => x.id !== id);
    showToast('âœ… ê³ ê°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('customerDetailModal');
    loadCustomers();
}

// ======================= ì •ì‚°ê´€ë¦¬: í†µí•©í˜„í™© =======================
// ì •ì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ ì „ì²´ ë¡œë“œ
function loadSettlementDashboard() {
    // ì—°ì²´ ìžë™ ê³„ì‚°
    calculateAllArrears();
    
    // ëŒ€ì‹œë³´ë“œ ìš”ì•½ ë¡œë“œ
    loadOverview();
    
    // ê³„ì•½ ëª©ë¡ ë¡œë“œ
    loadContracts();
    
    // ì°¨ëŸ‰ ëª©ë¡ ë¡œë“œ
    loadVehicles();
    
    // ê³ ê° ëª©ë¡ ë¡œë“œ
    loadCustomers();
    
    // ê³¼íƒœë£Œ ëª©ë¡ ë¡œë“œ
    loadFines();
    
    console.log('âœ… ì •ì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ');
}

function loadOverview() {
    // í•œêµ­ì‹œê°„ ê¸°ì¤€
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
    const totalContracts = contractList.length;
    const activeContracts = contractList.filter(c => c.status === 'active');
    const totalArrears = contractList.reduce((s, c) => s + (c.arrears || 0), 0);
    
    // ì›” ì˜ˆì • ìˆ˜ë‚©ê¸ˆì•¡ (ì§„í–‰ì¤‘ ê³„ì•½ ì›”ë‚©ìž…ê¸ˆ í•©ê³„)
    const monthlyExpected = activeContracts.reduce((s, c) => s + (c.monthly || 0), 0);
    
    // ì´ë²ˆë‹¬ ì‹¤ì œ ìˆ˜ë‚© ê¸ˆì•¡ (contract_paymentsì—ì„œ)
    const thisMonthPayments = contractPaymentList.filter(p => 
        p.status === 'paid' && p.payment_date >= thisMonthStart && p.payment_date <= today
    );
    const monthlyReceipt = thisMonthPayments.reduce((s, p) => s + (p.amount || 0), 0);
    
    // ì˜¤ëŠ˜ ìˆ˜ë‚© ê¸ˆì•¡
    const todayPayments = contractPaymentList.filter(p => p.status === 'paid' && p.payment_date === today);
    const todayReceipt = todayPayments.reduce((s, p) => s + (p.amount || 0), 0);
    
    document.getElementById('s-total').textContent = totalContracts + 'ê±´';
    document.getElementById('s-revenue').textContent = fmt(monthlyExpected);
    document.getElementById('s-arrears').textContent = fmt(totalArrears);
    document.getElementById('s-today').textContent = fmt(todayReceipt);
    
    // ì—°ì²´ ê³„ì•½ ëª©ë¡ (ë¯¸ìˆ˜ê¸ˆ ìžˆëŠ” ê³„ì•½)
    const delinquents = contractList.filter(c => (c.arrears || 0) > 0);
    let dh = '';
    delinquents.forEach(c => {
        dh += `<div class="p-3 rounded-xl bg-orange-400/5 border border-orange-400/20 flex items-center justify-between cursor-pointer hover:bg-orange-400/10" onclick="viewArrearsDetail(${c.id})">
            <div><div class="font-bold text-sm">${c.customer_name}</div><div class="text-xs text-gray-500">${c.vehicle} Â· ${c.plate}</div></div>
            <div class="text-orange-400 font-bold">${fmt(c.arrears || 0)}</div>
        </div>`;
    });
    document.getElementById('s-delinquent-list').innerHTML = dh || '<div class="text-gray-500 text-sm text-center py-4">ì—°ì²´ ê³„ì•½ ì—†ìŒ</div>';
    
    // ìµœê·¼ ìˆ˜ë‚© ëª©ë¡ (contract_paymentsì—ì„œ)
    const recentPaid = contractPaymentList
        .filter(p => p.status === 'paid')
        .sort((a, b) => (b.payment_date || '').localeCompare(a.payment_date || ''))
        .slice(0, 5);
    
    let ph = '';
    recentPaid.forEach(p => {
        const contract = contractList.find(c => c.id === p.contract_id);
        const customerName = contract ? contract.customer_name : '-';
        const dateStr = p.payment_date === today ? 'ì˜¤ëŠ˜' : p.payment_date;
        ph += `<div class="p-3 rounded-xl bg-emerald-400/5 border border-emerald-400/20 flex items-center justify-between cursor-pointer hover:bg-emerald-400/10" onclick="viewContractDetail(${p.contract_id})">
            <div><div class="font-bold text-sm">${customerName}</div><div class="text-xs text-gray-500">${dateStr}</div></div>
            <div class="text-emerald-400 font-bold">${fmt(p.amount || 0)}</div>
        </div>`;
    });
    document.getElementById('s-recent-payments').innerHTML = ph || '<div class="text-gray-500 text-sm text-center py-4">ìµœê·¼ ìˆ˜ë‚© ì—†ìŒ</div>';
}

function viewPaymentDetail(paymentId) {
    const p = recentPayments.find(x => x.id === paymentId);
    if (!p) return;
    
    // í•´ë‹¹ ê³ ê° ê³„ì•½ ì°¾ê¸°
    const contract = contractList.find(c => c.customer_name === p.customer_name);
    
    let content = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œê¸ˆì•¡</span><span class="text-emerald-400 font-bold">${fmt(p.amount)}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œì¼ì‹œ</span><span>${p.date} ${p.time}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œë°©ë²•</span><span>ì¹´ë“œ</span></div>
            </div>
        </div>
    `;
    
    if (contract) {
        content += `
            <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20 mb-4">
                <div class="text-xs text-blue-400 mb-2">ðŸ“‹ ê³„ì•½ ì •ë³´</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${contract.vehicle}</span></div>
                    <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${contract.plate}</span></div>
                    <div class="info-row"><span class="info-label">ì›” ë‚©ìž…ê¸ˆ</span><span>${fmt(contract.monthly)}</span></div>
                    <div class="info-row"><span class="info-label">ë¯¸ë‚©ê¸ˆ</span><span class="${contract.arrears > 0 ? 'text-orange-400' : ''}">${fmt(contract.arrears)}</span></div>
                </div>
            </div>
        `;
    }
    
    content += `
        <div class="flex gap-3">
            <button onclick="closeModal('recentPaymentsModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="showSettlementTab('ledger'); closeModal('recentPaymentsModal');" class="btn-primary flex-1">ì›ìž¥ì—ì„œ ë³´ê¸°</button>
        </div>
    `;
    
    document.getElementById('recent-payments-content').innerHTML = content;
    openModal('recentPaymentsModal');
}

function openArrearsModal() {
    const delinquents = contractList.filter(c => c.arrears > 0);
    const totalArrears = delinquents.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('arrears-total-amount').textContent = fmt(totalArrears);
    
    let h = '';
    delinquents.forEach(c => {
        h += `<tr>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="text-red-400">${c.delinquent_days || 0}ì¼</td>
            <td><button onclick="viewArrearsDetail(${c.id})" class="text-lime-400 text-xs hover:underline">ìƒì„¸</button></td>
        </tr>`;
    });
    document.getElementById('arrears-tbody').innerHTML = h || '<tr><td colspan="6" class="text-center text-gray-500 py-6">ë¯¸ë‚© ê³ ê° ì—†ìŒ</td></tr>';
    
    openModal('arrearsModal');
}

function viewArrearsDetail(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    closeModal('arrearsModal');
    
    // í•´ë‹¹ ê³„ì•½ì˜ ë¯¸ìˆ˜ê¸ˆ ë‚´ì—­
    const details = arrearsDetailList.filter(d => d.contract_id === contractId);
    
    // ê³ ê° ì •ë³´ ì°¾ê¸°
    const customer = customerList.find(cu => cu.name === c.customer_name);
    const phoneClean = c.phone.replace(/-/g, '');
    
    let detailRows = '';
    details.forEach(d => {
        const statusBadge = d.status === 'unpaid' ? '<span class="badge badge-failed">ë¯¸ë‚©</span>' : '<span class="badge badge-pending">ì¼ë¶€ë‚©</span>';
        const paidInfo = d.status === 'partial' ? `<div class="text-xs text-gray-500">ë‚©ë¶€: ${fmt(d.paid)}</div>` : '';
        detailRows += `<tr>
            <td class="text-gray-400">${d.date}</td>
            <td>${d.type}</td>
            <td class="text-orange-400 font-bold">${fmt(d.amount)}</td>
            <td>${statusBadge}${paidInfo}</td>
        </tr>`;
    });
    
    document.getElementById('arrears-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold text-lime-400 cursor-pointer hover:underline" onclick="closeModal('arrearsDetailModal'); ${customer ? `viewCustomerDetail(${customer.id})` : `showToast('ê³ ê°ì •ë³´ ì—†ìŒ', 'error')`}">${c.customer_name} â†’</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${c.plate}</span></div>
                <div class="info-row"><span class="info-label">ì›” ë ŒíŠ¸ë£Œ</span><span class="text-blue-400 font-bold">${fmt(c.monthly)}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì²´ì¼ìˆ˜</span><span class="text-red-400 font-bold">${c.delinquent_days || 0}ì¼</span></div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ðŸ“ž ì „í™”</div>
                <div class="text-xs text-gray-400">${c.phone}</div>
            </a>
            <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ðŸ’¬ ë¬¸ìž</div>
                <div class="text-xs text-gray-400">ë…ì´‰ ë¬¸ìž ë°œì†¡</div>
            </a>
        </div>
        
        <div class="p-4 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-orange-400 font-bold">ì´ ë¯¸ë‚© ê¸ˆì•¡</span>
                <span class="text-2xl font-black text-orange-400">${fmt(c.arrears)}</span>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4">
            <table class="data-table">
                <thead><tr><th>ë°œìƒì¼</th><th>êµ¬ë¶„</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${detailRows || '<tr><td colspan="4" class="text-center text-gray-500 py-4">ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('arrearsDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="openPaymentProcessModal(${c.id})" class="btn-primary flex-1">ðŸ’° ìˆ˜ë‚© ì²˜ë¦¬</button>
        </div>
    `;
    
    openModal('arrearsDetailModal');
}

// ìˆ˜ë‚© ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸° (ì—°ì²´ ìƒì„¸ì—ì„œ í˜¸ì¶œ)
function openPaymentProcessModal(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    closeModal('arrearsDetailModal');
    
    document.getElementById('pp-contract-id').value = contractId;
    document.getElementById('pp-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('pp-amount').value = c.arrears;
    
    document.getElementById('pp-info').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë¯¸ë‚©ê¸ˆì•¡</span><span class="text-orange-400 font-bold">${fmt(c.arrears)}</span></div>
            </div>
        </div>
    `;
    
    openModal('paymentProcessModal');
}

// ìˆ˜ë‚© ì²˜ë¦¬ ì‹¤í–‰
function processPayment(e) {
    e.preventDefault();
    const contractId = parseInt(document.getElementById('pp-contract-id').value);
    const amount = parseInt(document.getElementById('pp-amount').value) || 0;
    const date = document.getElementById('pp-date').value;
    const method = e.target.pay_method.value;
    const memo = e.target.pay_memo.value;
    
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    // ë¯¸ë‚©ê¸ˆ ì°¨ê°
    c.arrears = Math.max(0, c.arrears - amount);
    if (c.arrears === 0) {
        c.status = 'active';
        c.delinquent_days = 0;
    }
    
    // ì›ìž¥ì— ìˆ˜ë‚© ê¸°ë¡ ì¶”ê°€
    ledgerList.unshift({
        id: Math.max(...ledgerList.map(l => l.id), 0) + 1,
        date: date,
        contract_id: contractId,
        customer_name: c.customer_name,
        type: 'receipt',
        desc: `ìˆ˜ë‚© (${method})${memo ? ' - ' + memo : ''}`,
        accrual: 0,
        receipt: amount
    });
    
    // ìµœê·¼ê²°ì œ ë‚´ì—­ì— ì¶”ê°€
    recentPayments.unshift({
        id: Math.max(...recentPayments.map(p => p.id), 0) + 1,
        customer_name: c.customer_name,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5)
    });
    
    showToast(`âœ… ${c.customer_name}ë‹˜ ${fmt(amount)} ìˆ˜ë‚© ì™„ë£Œ`);
    closeModal('paymentProcessModal');
    loadOverview();
}

// ======================= ì—‘ì…€ ë‹¤ìš´ë¡œë“œ =======================
function downloadExcel(type) {
    let data = [];
    let filename = '';
    
    switch(type) {
        case 'contracts':
            filename = 'ê³„ì•½ëª©ë¡';
            data = contractList.map(c => ({
                'ê³„ì•½ë²ˆí˜¸': '#' + String(c.id).padStart(3, '0'),
                'ê³ ê°ëª…': c.customer_name,
                'ì—°ë½ì²˜': c.phone,
                'ì°¨ëŸ‰': c.vehicle,
                'ë²ˆí˜¸íŒ': c.plate,
                'ì›”ë‚©ìž…ê¸ˆ': c.monthly,
                'ë¯¸ë‚©ê¸ˆ': c.arrears,
                'ìƒíƒœ': c.status === 'active' ? 'ì§„í–‰ì¤‘' : 'ì—°ì²´',
                'ê³„ì•½ì‹œìž‘ì¼': c.start_date
            }));
            break;
        case 'vehicles':
            filename = 'ì°¨ëŸ‰ëª©ë¡';
            data = vehicleList.map(v => ({
                'ë²ˆí˜¸íŒ': v.plate,
                'ëª¨ë¸': v.model,
                'ì—°ì‹': v.year,
                'ìƒ‰ìƒ': v.color,
                'ì£¼í–‰ê±°ë¦¬': v.mileage,
                'ìƒíƒœ': v.status,
                'ë©”ëª¨': v.memo || ''
            }));
            break;
        case 'customers':
            filename = 'ê³ ê°ëª©ë¡';
            data = customerList.map(c => ({
                'ê³ ê°ëª…': c.name,
                'ì—°ë½ì²˜': c.phone,
                'ì´ë©”ì¼': c.email || '',
                'ì£¼ì†Œ': c.address || '',
                'ë“±ê¸‰': c.grade,
                'ë©”ëª¨': c.memo || '',
                'ë“±ë¡ì¼': c.created_at
            }));
            break;
        case 'ledger':
            filename = 'ì›ìž¥ë‚´ì—­';
            data = ledgerList.map(l => ({
                'ì¼ìž': l.date,
                'ê³ ê°ëª…': l.customer_name,
                'êµ¬ë¶„': l.type === 'accrual' ? 'ë°œìƒ' : l.type === 'receipt' ? 'ìˆ˜ë‚©' : 'ì¡°ì •',
                'ë‚´ìš©': l.desc,
                'ë°œìƒ': l.accrual,
                'ìˆ˜ë‚©': l.receipt
            }));
            break;
        case 'delinquent':
            filename = 'ì—°ì²´ëª©ë¡';
            data = contractList.filter(c => c.arrears > 0).map(c => ({
                'ê³ ê°ëª…': c.customer_name,
                'ì—°ë½ì²˜': c.phone,
                'ì°¨ëŸ‰': c.vehicle,
                'ë²ˆí˜¸íŒ': c.plate,
                'ì—°ì²´ê¸ˆì•¡': c.arrears,
                'ì—°ì²´ì¼ìˆ˜': c.delinquent_days || 0,
                'ì›”ë‚©ìž…ê¸ˆ': c.monthly
            }));
            break;
        case 'pg':
            filename = 'ìžë™ê²°ì œëª©ë¡';
            data = pgPaymentsList.map(p => ({
                'ê³ ê°ëª…': p.customer_name,
                'ì¹´ë“œë²ˆí˜¸': p.card_no,
                'ê²°ì œíƒ€ìž…': payTypeLabel(p.pay_type),
                'ê²°ì œê¸ˆì•¡': p.amount,
                'ìµœê·¼ê²°ì œ': p.last_pay,
                'ìƒíƒœ': p.status === 'success' ? 'ì„±ê³µ' : p.status === 'failed' ? 'ì‹¤íŒ¨' : 'ì˜ˆì •'
            }));
            break;
        case 'broWork':
            filename = 'ìž‘ì—…ë‚´ì—­';
            data = broWorkList.map(w => ({
                'ì ‘ìˆ˜ë²ˆí˜¸': '#W' + String(w.id).padStart(3, '0'),
                'ê³ ê°ëª…': w.customer,
                'ì—°ë½ì²˜': w.phone,
                'ì°¨ëŸ‰': w.vehicle,
                'ë²ˆí˜¸íŒ': w.plate,
                'ìž‘ì—…ë‚´ìš©': w.content,
                'ê³µìž„': w.labor,
                'ë¶€í’ˆë¹„': w.parts_cost,
                'í•©ê³„': w.labor + w.parts_cost,
                'ìƒíƒœ': w.status === 'complete' ? 'ì™„ë£Œ' : w.status === 'progress' ? 'ì§„í–‰ì¤‘' : 'ëŒ€ê¸°',
                'ë‚ ì§œ': w.date
            }));
            break;
        case 'broCashbook':
            filename = 'ê¸ˆì „ì¶œë‚©ë¶€';
            data = broCashbookList.map(c => ({
                'ë‚ ì§œ': c.date,
                'êµ¬ë¶„': c.type === 'income' ? 'ìˆ˜ìž…' : 'ì§€ì¶œ',
                'ë¶„ë¥˜': c.category,
                'ë‚´ìš©': c.description,
                'ê¸ˆì•¡': c.amount
            }));
            break;
        case 'broParts':
            filename = 'ë¶€í’ˆìž¬ê³ ';
            data = broPartsList.map(p => ({
                'ë¶€í’ˆëª…': p.name,
                'ë¶„ë¥˜': p.category,
                'ìž¬ê³ ': p.stock,
                'ë‹¨ê°€': p.price,
                'ìµœì†Œìž¬ê³ ': p.min_stock
            }));
            break;
        default:
            showToast('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜', 'error');
            return;
    }
    
    if (data.length === 0) {
        showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    // CSV ìƒì„±
    const headers = Object.keys(data[0]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    data.forEach(row => {
        csv += headers.map(h => {
            let val = row[h];
            if (typeof val === 'string' && (val.includes(',') || val.includes('\n'))) {
                val = '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
        }).join(',') + '\n';
    });
    
    // ë‹¤ìš´ë¡œë“œ
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showToast(`âœ… ${filename} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ìž‘ì—…ë‚´ìš© =======================
const workStatusBadge = s => ({ waiting: ['badge-waiting', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[s] || ['', '']);

function loadBroWork() {
    const search = document.getElementById('b-work-search').value.toLowerCase();
    const statusFilter = document.getElementById('b-work-status').value;
    
    // ë‚ ì§œ êµ¬ê°„ ê¸°ë³¸ê°’: ì•žìœ¼ë¡œ 7ì¼
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let startDate = document.getElementById('b-work-start').value;
    let endDate = document.getElementById('b-work-end').value;
    
    if (!startDate || !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
        endDate = today;
        document.getElementById('b-work-start').value = startDate;
        document.getElementById('b-work-end').value = endDate;
    }
    
    let works = broWorkList.filter(w => w.date >= startDate && w.date <= endDate);
    if (statusFilter) works = works.filter(w => w.status === statusFilter);
    if (search) works = works.filter(w => 
        w.customer.toLowerCase().includes(search) || 
        w.vehicle.toLowerCase().includes(search) ||
        (w.plate && w.plate.toLowerCase().includes(search)) ||
        w.content.toLowerCase().includes(search)
    );
    
    // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    works.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    
    let h = '';
    works.forEach(w => {
        const [sc, sl] = workStatusBadge(w.status);
        const total = w.labor + w.parts_cost;
        const isPaid = w.status === 'complete';
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewWorkDetail(${w.id})">
            <td class="text-lime-400">#W${String(w.id).padStart(3,'0')}</td>
            <td class="text-gray-400">${w.date}</td>
            <td class="font-bold">${w.customer}</td>
            <td>${w.vehicle}</td>
            <td>${w.content}</td>
            <td class="text-gray-400">${fmt(w.labor)}</td>
            <td class="text-gray-400">${fmt(w.parts_cost)}</td>
            <td class="font-bold">${fmt(total)}</td>
            <td><span class="badge ${sc}">${sl}</span></td>
            <td>
                ${isPaid 
                    ? '<span class="text-emerald-400 text-xs">âœ… ì™„ë£Œ</span>' 
                    : `<button onclick="event.stopPropagation(); openBroCardPayModal(${w.id})" class="text-blue-400 text-xs hover:underline">ðŸ’³</button>`
                }
            </td>
        </tr>`;
    });
    document.getElementById('b-work-tbody').innerHTML = h || '<tr><td colspan="10" class="text-center text-gray-500 py-6">ìž‘ì—… ì—†ìŒ</td></tr>';
}

async function submitBroWork(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const editId = document.getElementById('work-edit-id').value;
    const customerId = document.getElementById('work-customer-id').value;
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // ì‚¬ìš© ë¶€í’ˆ JSON ì €ìž¥
    const usedPartsJson = workPartsSelected.length > 0 ? JSON.stringify(workPartsSelected) : null;
    
    // ìž‘ì—… ë°ì´í„°
    const workData = {
        customer: d.customer,
        phone: d.phone,
        vehicle: d.vehicle,
        plate: d.plate || '',
        content: d.content,
        labor: parseInt(d.labor) || 0,
        parts_cost: parseInt(d.parts_cost) || 0,
        memo: d.memo || '',
        customer_id: customerId ? parseInt(customerId) : null,
        used_parts: usedPartsJson
    };
    
    if (editId) {
        // ìˆ˜ì •
        await updateInDB('bro_works', editId, workData);
        const w = broWorkList.find(x => x.id === parseInt(editId));
        if (w) Object.assign(w, workData);
        showToast('âœ… ìž‘ì—…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ì‹ ê·œ ë“±ë¡
        workData.status = 'waiting';
        workData.date = today;
        
        const result = await insertToDB('bro_works', workData);
        if (result && result[0]) broWorkList.unshift(result[0]);
        
        // ë¶€í’ˆ ìž¬ê³  ì°¨ê°
        for (const part of workPartsSelected) {
            const dbPart = broPartsList.find(p => p.id === part.id);
            if (dbPart) {
                const newStock = Math.max(0, (dbPart.stock || 0) - part.qty);
                dbPart.stock = newStock;
                await updateInDB('bro_parts', part.id, { stock: newStock });
            }
        }
        if (workPartsSelected.length > 0) {
            showToast('ðŸ“¦ ë¶€í’ˆ ìž¬ê³ ê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        // ê³ ê° ì •ë³´ ìžë™ ì €ìž¥/ì—…ë°ì´íŠ¸
        if (customerId) {
            // ê¸°ì¡´ ê³ ê° - ë°©ë¬¸ìˆ˜ ì¦ê°€
            const existingCust = broCustList.find(c => c.id === parseInt(customerId));
            if (existingCust) {
                existingCust.visits = (existingCust.visits || 0) + 1;
                existingCust.last_visit = today;
                // ì°¨ëŸ‰ ì •ë³´ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ìž…ë ¥ëœ ê²½ìš°)
                if (d.vehicle && !existingCust.vehicle) existingCust.vehicle = d.vehicle;
                if (d.plate && !existingCust.plate) existingCust.plate = d.plate;
                await updateInDB('bro_customers', existingCust.id, { 
                    visits: existingCust.visits, 
                    last_visit: today,
                    vehicle: existingCust.vehicle,
                    plate: existingCust.plate
                });
            }
        } else {
            // ì‹ ê·œ ê³ ê° ë“±ë¡
            const custData = {
                name: d.customer,
                phone: d.phone,
                vehicle: d.vehicle || '',
                plate: d.plate || '',
                visits: 1,
                last_visit: today
            };
            const custResult = await insertToDB('bro_customers', custData);
            if (custResult && custResult[0]) {
                broCustList.unshift(custResult[0]);
                // ìž‘ì—…ì— customer_id ì—…ë°ì´íŠ¸
                if (result && result[0]) {
                    await updateInDB('bro_works', result[0].id, { customer_id: custResult[0].id });
                    result[0].customer_id = custResult[0].id;
                }
            }
            showToast('ðŸ‘¤ ì‹ ê·œ ê³ ê°ì´ ìžë™ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        showToast('âœ… ìž‘ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('workModal');
    document.getElementById('workForm').reset();
    document.getElementById('work-edit-id').value = '';
    document.getElementById('work-customer-id').value = '';
    document.getElementById('customer-info-box').classList.add('hidden');
    document.getElementById('new-customer-box').classList.add('hidden');
    workPartsSelected = [];
    loadBroWork();
    loadBroDashboard();
}

function viewWorkDetail(id) {
    const w = broWorkList.find(x => x.id === id);
    if (!w) return;
    
    const [sc, sl] = workStatusBadge(w.status);
    const total = w.labor + w.parts_cost;
    const isPaid = w.status === 'complete';
    const phoneClean = w.phone.replace(/-/g, '');
    
    let statusBtns = '';
    if (w.status === 'waiting') statusBtns = `<button onclick="updateWorkStatus(${w.id}, 'progress')" class="btn-secondary flex-1">â–¶ ì§„í–‰</button>`;
    else if (w.status === 'progress') statusBtns = `<button onclick="updateWorkStatus(${w.id}, 'complete')" class="btn-secondary flex-1">âœ… ì™„ë£Œ</button>`;
    
    const payBtn = isPaid 
        ? '<div class="text-emerald-400 text-center py-3">âœ… ê²°ì œì™„ë£Œ</div>' 
        : `<button onclick="closeModal('workDetailModal'); openBroCardPayModal(${w.id})" class="btn-primary flex-1">ðŸ’³ ì¹´ë“œê²°ì œ</button>`;
    
    // ì‚¬ìš© ë¶€í’ˆ ëª©ë¡ íŒŒì‹±
    let partsHtml = '';
    if (w.used_parts) {
        try {
            const usedParts = JSON.parse(w.used_parts);
            if (usedParts && usedParts.length > 0) {
                let partsRows = '';
                usedParts.forEach(p => {
                    const subtotal = p.price * p.qty;
                    partsRows += `<tr>
                        <td class="text-sm">${p.name}</td>
                        <td class="text-center text-gray-400">${p.qty}ê°œ</td>
                        <td class="text-right text-gray-400">${fmt(p.price)}</td>
                        <td class="text-right text-blue-400 font-bold">${fmt(subtotal)}</td>
                    </tr>`;
                });
                partsHtml = `
                    <div class="p-4 rounded-lg bg-blue-400/10 border border-blue-400/30 mb-4">
                        <div class="text-xs text-blue-400 mb-2">ðŸ”© ì‚¬ìš© ë¶€í’ˆ</div>
                        <table class="w-full text-sm">
                            <thead><tr class="text-xs text-gray-500"><th class="text-left">ë¶€í’ˆëª…</th><th class="text-center">ìˆ˜ëŸ‰</th><th class="text-right">ë‹¨ê°€</th><th class="text-right">ì†Œê³„</th></tr></thead>
                            <tbody>${partsRows}</tbody>
                        </table>
                    </div>
                `;
            }
        } catch (e) {
            console.error('ë¶€í’ˆ íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    }
    
    document.getElementById('work-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì ‘ìˆ˜ë²ˆí˜¸</span><span class="text-lime-400 font-bold">#W${String(w.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${sc}">${sl}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${w.customer}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${w.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${w.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${w.plate || '-'}</span></div>
                <div class="info-row"><span class="info-label">ìž‘ì—…ë‚´ìš©</span><span>${w.content}</span></div>
                <div class="info-row"><span class="info-label">ë‚ ì§œ</span><span>${w.date}</span></div>
            </div>
            ${w.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-sm text-gray-400">ðŸ“ ${w.memo}</div>` : ''}
        </div>
        
        ${partsHtml}
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ðŸ“ž ì „í™”</div>
            </a>
            <a href="sms:${phoneClean}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ðŸ’¬ ë¬¸ìž</div>
            </a>
        </div>
        
        <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 mb-4">
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><div class="text-xs text-gray-400">ê³µìž„</div><div class="font-bold text-blue-400">${fmt(w.labor)}</div></div>
                <div><div class="text-xs text-gray-400">ë¶€í’ˆë¹„</div><div class="font-bold text-orange-400">${fmt(w.parts_cost)}</div></div>
                <div><div class="text-xs text-lime-400">í•©ê³„</div><div class="font-bold text-xl text-lime-400">${fmt(total)}</div></div>
            </div>
        </div>
        
        <div class="flex gap-3 mb-3">
            ${statusBtns}
            ${payBtn}
        </div>
        <div class="flex gap-3">
            <button onclick="deleteBroWork(${w.id})" class="btn-danger flex-1">ðŸ—‘ï¸ ì‚­ì œ</button>
            <button onclick="closeModal('workDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editBroWork(${w.id})" class="btn-primary flex-1">âœï¸ ìˆ˜ì •</button>
        </div>
    `;
    openModal('workDetailModal');
}

// ìž‘ì—… ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openWorkModal() {
    document.getElementById('workModalTitle').textContent = 'ðŸ”§ ìž‘ì—… ë“±ë¡';
    document.getElementById('workSubmitBtn').textContent = 'ë“±ë¡';
    document.getElementById('work-edit-id').value = '';
    document.getElementById('work-customer-id').value = '';
    document.getElementById('workForm').reset();
    document.getElementById('work-total').value = 'â‚©0';
    document.getElementById('customer-info-box').classList.add('hidden');
    document.getElementById('new-customer-box').classList.add('hidden');
    document.getElementById('phone-check-result').innerHTML = '';
    // ë¶€í’ˆ ëª©ë¡ ì´ˆê¸°í™”
    workPartsSelected = [];
    renderWorkPartsList();
    document.getElementById('work-pay-amount').value = '';
    document.getElementById('work-vat-check').checked = false;
    document.getElementById('work-vat-amount').classList.add('hidden');
    openModal('workModal');
}

// ìž‘ì—… ìˆ˜ì •
function editBroWork(id) {
    const w = broWorkList.find(x => x.id === id);
    if (!w) return;
    
    closeModal('workDetailModal');
    
    document.getElementById('workModalTitle').textContent = 'ðŸ”§ ìž‘ì—… ìˆ˜ì •';
    document.getElementById('workSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('work-edit-id').value = w.id;
    document.getElementById('work-customer-id').value = w.customer_id || '';
    document.getElementById('work-customer').value = w.customer;
    document.getElementById('work-phone').value = w.phone;
    document.getElementById('work-vehicle').value = w.vehicle;
    document.getElementById('work-plate').value = w.plate || '';
    document.getElementById('work-content').value = w.content;
    document.getElementById('work-labor').value = w.labor || 0;
    document.getElementById('work-parts').value = w.parts_cost || 0;
    document.getElementById('work-memo').value = w.memo || '';
    document.getElementById('customer-info-box').classList.add('hidden');
    document.getElementById('new-customer-box').classList.add('hidden');
    document.getElementById('phone-check-result').innerHTML = '';
    // ìˆ˜ì • ì‹œ ê¸°ì¡´ ê¸ˆì•¡ìœ¼ë¡œ ì„¤ì •
    workPartsSelected = [];
    renderWorkPartsList();
    const total = (w.labor || 0) + (w.parts_cost || 0);
    document.getElementById('work-pay-amount').value = total;
    document.getElementById('work-vat-check').checked = false;
    document.getElementById('work-vat-amount').classList.add('hidden');
    document.getElementById('work-total').value = fmt(total);
    
    openModal('workModal');
}

// ìž‘ì—… ì‚­ì œ
async function deleteBroWork(id) {
    const w = broWorkList.find(x => x.id === id);
    if (!w) return;
    
    if (!confirm(`ìž‘ì—… #W${String(id).padStart(3,'0')}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê³ ê°: ${w.customer}\nìž‘ì—…: ${w.content}\n\nâš ï¸ ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
    
    await deleteFromDB('bro_works', id);
    broWorkList = broWorkList.filter(x => x.id !== id);
    showToast('âœ… ìž‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('workDetailModal');
    loadBroWork();
}

async function updateWorkStatus(id, status) {
    const w = broWorkList.find(x => x.id === id);
    if (w) {
        w.status = status;
        await updateInDB('bro_works', id, { status });
        
        // ì™„ë£Œ ì‹œ ê¸ˆì „ì¶œë‚©ë¶€ì— ìˆ˜ìž… ìžë™ ë“±ë¡
        if (status === 'complete') {
            const total = (w.labor || 0) + (w.parts_cost || 0);
            if (total > 0) {
                const now = new Date();
                const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
                const today = koreaTime.toISOString().split('T')[0];
                
                const cashbookData = {
                    date: today,
                    type: 'income',
                    category: 'ìž‘ì—…ìˆ˜ìž…',
                    description: `[${w.customer}] ${w.content}`,
                    amount: total
                };
                const result = await insertToDB('bro_cashbook', cashbookData);
                if (result && result[0]) {
                    broCashbookList.unshift(result[0]);
                }
            }
        }
    }
    showToast('âœ… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('workDetailModal');
    loadBroWork();
    loadBroDashboard();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ê¸ˆì „ì¶œë‚©ë¶€ =======================
let currentCbPeriod = '1w';
let cashbookChart = null;
let expenseChart = null;

function filterCashbookPeriod(period) {
    currentCbPeriod = period;
    
    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    ['1w', '1m', '3m', 'all'].forEach(p => {
        const btn = document.getElementById(`cb-filter-${p}`);
        if (btn) {
            btn.className = p === period 
                ? 'px-4 py-2 rounded-lg text-sm font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30'
                : 'px-4 py-2 rounded-lg text-sm font-bold text-gray-500 border border-white/10';
        }
    });
    
    // ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    let startDate = '';
    
    if (period === '1w') {
        const d = new Date(koreaTime);
        d.setDate(d.getDate() - 7);
        startDate = d.toISOString().split('T')[0];
    } else if (period === '1m') {
        const d = new Date(koreaTime);
        d.setMonth(d.getMonth() - 1);
        startDate = d.toISOString().split('T')[0];
    } else if (period === '3m') {
        const d = new Date(koreaTime);
        d.setMonth(d.getMonth() - 3);
        startDate = d.toISOString().split('T')[0];
    }
    
    document.getElementById('b-cb-start-date').value = startDate;
    document.getElementById('b-cb-end-date').value = period === 'all' ? '' : today;
    
    loadBroCashbook();
}

function loadBroCashbook() {
    const typeFilter = document.getElementById('b-cb-type').value;
    const categoryFilter = document.getElementById('b-cb-category-filter')?.value || '';
    const startDate = document.getElementById('b-cb-start-date').value;
    const endDate = document.getElementById('b-cb-end-date').value;
    const search = document.getElementById('b-cb-search').value.toLowerCase();
    
    // ì´ë²ˆë‹¬ ê³„ì‚°
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonth = koreaTime.toISOString().substring(0, 7);
    
    // ì´ë²ˆë‹¬ ë°ì´í„°
    const thisMonthData = broCashbookList.filter(c => c.date && c.date.startsWith(thisMonth));
    const monthIncome = thisMonthData.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
    const monthExpense = thisMonthData.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
    
    // ì „ì²´ ìž”ì•¡
    const totalIncome = broCashbookList.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
    const totalExpense = broCashbookList.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
    
    document.getElementById('b-cb-income').textContent = fmt(monthIncome);
    document.getElementById('b-cb-expense').textContent = fmt(monthExpense);
    document.getElementById('b-cb-profit').textContent = fmt(monthIncome - monthExpense);
    document.getElementById('b-cb-balance').textContent = fmt(totalIncome - totalExpense);
    
    // í•„í„° ì ìš©
    let list = broCashbookList;
    if (typeFilter) list = list.filter(c => c.type === typeFilter);
    if (categoryFilter) list = list.filter(c => c.category === categoryFilter);
    if (startDate) list = list.filter(c => c.date >= startDate);
    if (endDate) list = list.filter(c => c.date <= endDate);
    if (search) list = list.filter(c => c.description && c.description.toLowerCase().includes(search));
    
    // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
    list = list.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    
    // í…Œì´ë¸”
    let h = '', runningBalance = totalIncome - totalExpense;
    list.forEach(c => {
        h += `<tr>
            <td class="text-gray-400">${c.date || '-'}</td>
            <td><span class="badge ${c.type === 'income' ? 'badge-active' : 'badge-failed'}">${c.type === 'income' ? 'ìˆ˜ìž…' : 'ì§€ì¶œ'}</span></td>
            <td class="text-xs">${c.category || '-'}</td>
            <td>${c.description || '-'}</td>
            <td class="${c.type === 'income' ? 'text-lime-400' : 'text-red-400'} font-bold">${c.type === 'income' ? '+' : '-'}${fmt(c.amount || 0)}</td>
            <td class="text-gray-400">${fmt(runningBalance)}</td>
            <td>
                <button onclick="editCashbook(${c.id})" class="text-blue-400 text-xs hover:underline mr-2">ìˆ˜ì •</button>
                <button onclick="deleteCashbook(${c.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
        runningBalance -= c.type === 'income' ? (c.amount || 0) : -(c.amount || 0);
    });
    document.getElementById('b-cb-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ë‚´ì—­ ì—†ìŒ</td></tr>';
    
    // ê·¸ëž˜í”„ ì—…ë°ì´íŠ¸
    updateCashbookCharts();
}

// ê·¸ëž˜í”„ ì—…ë°ì´íŠ¸
function updateCashbookCharts() {
    // ìµœê·¼ 6ê°œì›” ë°ì´í„° ì§‘ê³„
    const months = [];
    const incomeData = [];
    const expenseData = [];
    
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthKey = d.toISOString().substring(0, 7);
        const monthLabel = (d.getMonth() + 1) + 'ì›”';
        
        const monthItems = broCashbookList.filter(c => c.date && c.date.startsWith(monthKey));
        const income = monthItems.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
        const expense = monthItems.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
        
        months.push(monthLabel);
        incomeData.push(income);
        expenseData.push(expense);
    }
    
    // ì›”ë³„ ìˆ˜ìž…/ì§€ì¶œ ì°¨íŠ¸
    const ctx1 = document.getElementById('cashbook-chart');
    if (ctx1) {
        if (cashbookChart) cashbookChart.destroy();
        cashbookChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: 'ìˆ˜ìž…', data: incomeData, backgroundColor: 'rgba(57, 255, 20, 0.6)', borderColor: '#39FF14', borderWidth: 1 },
                    { label: 'ì§€ì¶œ', data: expenseData, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: '#EF4444', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#fff' } } },
                scales: {
                    x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#9CA3AF', callback: v => 'â‚©' + (v/10000).toFixed(0) + 'ë§Œ' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });
    }
    
    // ì§€ì¶œ ë¶„ë¥˜ë³„ ì°¨íŠ¸
    const expenseByCategory = {};
    broCashbookList.filter(c => c.type === 'expense').forEach(c => {
        const cat = c.category || 'ê¸°íƒ€';
        expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (c.amount || 0);
    });
    
    const ctx2 = document.getElementById('expense-chart');
    if (ctx2 && Object.keys(expenseByCategory).length > 0) {
        if (expenseChart) expenseChart.destroy();
        expenseChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(expenseByCategory),
                datasets: [{
                    data: Object.values(expenseByCategory),
                    backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#6B7280', '#14B8A6']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 11 } } } }
            }
        });
    }
}

// ìƒì„¸ ëª¨ë‹¬
function openCashbookDetail(type) {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonth = koreaTime.toISOString().substring(0, 7);
    const monthName = thisMonth.replace('-', 'ë…„ ') + 'ì›”';
    
    const thisMonthData = broCashbookList.filter(c => c.date && c.date.startsWith(thisMonth));
    const totalIncome = broCashbookList.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
    const totalExpense = broCashbookList.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
    
    let title = '', content = '';
    
    if (type === 'income') {
        title = 'ðŸ’µ ì´ë²ˆë‹¬ ìˆ˜ìž… ìƒì„¸';
        const incomeData = thisMonthData.filter(c => c.type === 'income');
        const total = incomeData.reduce((s, c) => s + (c.amount || 0), 0);
        
        // ë¶„ë¥˜ë³„ ì§‘ê³„
        const byCategory = {};
        incomeData.forEach(c => {
            const cat = c.category || 'ê¸°íƒ€';
            byCategory[cat] = (byCategory[cat] || 0) + (c.amount || 0);
        });
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">${monthName}</div>
                <div class="text-3xl font-black text-lime-400">${fmt(total)}</div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
                <div class="text-xs text-lime-400 mb-3">ðŸ“Š ë¶„ë¥˜ë³„ ìˆ˜ìž…</div>
                ${Object.entries(byCategory).map(([cat, amt]) => `
                    <div class="flex justify-between py-2 border-b border-white/5">
                        <span>${cat}</span>
                        <span class="text-lime-400 font-bold">${fmt(amt)}</span>
                    </div>
                `).join('')}
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                <div class="text-xs text-gray-400 mb-3">ðŸ“‹ ìƒì„¸ ë‚´ì—­ (${incomeData.length}ê±´)</div>
                <div class="max-h-48 overflow-y-auto">
                    ${incomeData.slice(0, 10).map(c => `
                        <div class="flex justify-between py-2 border-b border-white/5 text-sm">
                            <span class="text-gray-400">${c.date}</span>
                            <span>${c.description || '-'}</span>
                            <span class="text-lime-400">${fmt(c.amount)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (type === 'expense') {
        title = 'ðŸ’¸ ì´ë²ˆë‹¬ ì§€ì¶œ ìƒì„¸';
        const expenseData = thisMonthData.filter(c => c.type === 'expense');
        const total = expenseData.reduce((s, c) => s + (c.amount || 0), 0);
        
        // ë¶„ë¥˜ë³„ ì§‘ê³„
        const byCategory = {};
        expenseData.forEach(c => {
            const cat = c.category || 'ê¸°íƒ€';
            byCategory[cat] = (byCategory[cat] || 0) + (c.amount || 0);
        });
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">${monthName}</div>
                <div class="text-3xl font-black text-red-400">${fmt(total)}</div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
                <div class="text-xs text-red-400 mb-3">ðŸ“Š ë¶„ë¥˜ë³„ ì§€ì¶œ</div>
                ${Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([cat, amt]) => `
                    <div class="flex justify-between py-2 border-b border-white/5">
                        <span>${cat}</span>
                        <span class="text-red-400 font-bold">${fmt(amt)}</span>
                    </div>
                `).join('')}
            </div>
        `;
    } else if (type === 'profit') {
        title = 'ðŸ“Š ì´ë²ˆë‹¬ ìˆœì´ìµ';
        const income = thisMonthData.filter(c => c.type === 'income').reduce((s, c) => s + (c.amount || 0), 0);
        const expense = thisMonthData.filter(c => c.type === 'expense').reduce((s, c) => s + (c.amount || 0), 0);
        const profit = income - expense;
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">${monthName}</div>
                <div class="text-3xl font-black ${profit >= 0 ? 'text-blue-400' : 'text-red-400'}">${fmt(profit)}</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 text-center">
                    <div class="text-xs text-lime-400 mb-1">ì´ ìˆ˜ìž…</div>
                    <div class="text-xl font-bold text-lime-400">${fmt(income)}</div>
                </div>
                <div class="p-4 rounded-lg bg-red-400/10 border border-red-400/30 text-center">
                    <div class="text-xs text-red-400 mb-1">ì´ ì§€ì¶œ</div>
                    <div class="text-xl font-bold text-red-400">${fmt(expense)}</div>
                </div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                <div class="text-xs text-gray-400 mb-2">ìˆ˜ìµë¥ </div>
                <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-lime-500 to-emerald-500" style="width: ${income > 0 ? Math.min(100, (profit / income) * 100) : 0}%"></div>
                </div>
                <div class="text-right text-sm text-gray-400 mt-1">${income > 0 ? ((profit / income) * 100).toFixed(1) : 0}%</div>
            </div>
        `;
    } else if (type === 'balance') {
        title = 'ðŸ’° í˜„ìž¬ ìž”ì•¡';
        const balance = totalIncome - totalExpense;
        
        content = `
            <div class="text-center mb-4">
                <div class="text-gray-400 text-sm">ëˆ„ì  ìž”ì•¡</div>
                <div class="text-3xl font-black text-purple-400">${fmt(balance)}</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 text-center">
                    <div class="text-xs text-lime-400 mb-1">ëˆ„ì  ìˆ˜ìž…</div>
                    <div class="text-xl font-bold text-lime-400">${fmt(totalIncome)}</div>
                </div>
                <div class="p-4 rounded-lg bg-red-400/10 border border-red-400/30 text-center">
                    <div class="text-xs text-red-400 mb-1">ëˆ„ì  ì§€ì¶œ</div>
                    <div class="text-xl font-bold text-red-400">${fmt(totalExpense)}</div>
                </div>
            </div>
        `;
    }
    
    document.getElementById('cashbookDetailTitle').textContent = title;
    document.getElementById('cashbook-detail-content').innerHTML = content + `
        <div class="flex gap-3 mt-4">
            <button onclick="closeModal('cashbookDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
        </div>
    `;
    openModal('cashbookDetailModal');
}

// ê³ ê° ê²€ìƒ‰ (ìž‘ì—…ë“±ë¡)
function searchBroCustomer() {
    const query = document.getElementById('work-customer').value.toLowerCase();
    const resultsDiv = document.getElementById('customer-search-results');
    
    if (query.length < 1) {
        resultsDiv.classList.add('hidden');
        document.getElementById('customer-info-box').classList.add('hidden');
        document.getElementById('new-customer-box').classList.add('hidden');
        return;
    }
    
    const matches = broCustList.filter(c => c.name.toLowerCase().includes(query) || (c.phone && c.phone.includes(query)));
    
    if (matches.length > 0) {
        resultsDiv.innerHTML = matches.slice(0, 5).map(c => `
            <div class="p-2 hover:bg-lime-400/10 cursor-pointer border-b border-white/5" onclick="selectBroCustomer(${c.id})">
                <div class="font-bold text-sm">${c.name}</div>
                <div class="text-xs text-gray-400">${c.phone || '-'} | ${c.vehicle || '-'}</div>
            </div>
        `).join('');
        resultsDiv.classList.remove('hidden');
        document.getElementById('new-customer-box').classList.add('hidden');
    } else {
        resultsDiv.classList.add('hidden');
        document.getElementById('new-customer-box').classList.remove('hidden');
        document.getElementById('customer-info-box').classList.add('hidden');
    }
}

function selectBroCustomer(id) {
    const c = broCustList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('work-customer-id').value = c.id;
    document.getElementById('work-customer').value = c.name;
    document.getElementById('work-phone').value = c.phone || '';
    document.getElementById('work-vehicle').value = c.vehicle || '';
    document.getElementById('work-plate').value = c.plate || '';
    
    document.getElementById('customer-search-results').classList.add('hidden');
    document.getElementById('new-customer-box').classList.add('hidden');
    document.getElementById('customer-info-box').classList.remove('hidden');
    document.getElementById('customer-info-detail').innerHTML = `
        ${c.name} | ${c.phone || '-'} | ë°©ë¬¸ ${c.visits || 0}íšŒ
    `;
}

// ì—°ë½ì²˜ ì¤‘ë³µ í™•ì¸
function checkPhoneDuplicate() {
    const phone = document.getElementById('work-phone').value;
    const resultDiv = document.getElementById('phone-check-result');
    
    if (!phone) {
        resultDiv.innerHTML = '';
        return;
    }
    
    const existing = broCustList.find(c => c.phone === phone);
    if (existing) {
        resultDiv.innerHTML = `<span class="text-yellow-400">âš ï¸ ê¸°ì¡´ ê³ ê°: ${existing.name}</span>`;
        // ê¸°ì¡´ ê³ ê° ì •ë³´ ìžë™ ì±„ìš°ê¸°
        document.getElementById('work-customer-id').value = existing.id;
        document.getElementById('work-customer').value = existing.name;
        document.getElementById('work-vehicle').value = existing.vehicle || '';
        document.getElementById('work-plate').value = existing.plate || '';
        document.getElementById('customer-info-box').classList.remove('hidden');
        document.getElementById('customer-info-detail').innerHTML = `${existing.name} | ë°©ë¬¸ ${existing.visits || 0}íšŒ`;
    } else {
        resultDiv.innerHTML = `<span class="text-lime-400">âœ… ì‹ ê·œ ì—°ë½ì²˜</span>`;
        document.getElementById('work-customer-id').value = '';
    }
}

// ìž‘ì—…ì— ì¶”ê°€ëœ ë¶€í’ˆ ëª©ë¡
let workPartsSelected = [];

// ë¶€í’ˆ ê²€ìƒ‰ (ìž‘ì—… ë“±ë¡ìš©)
function searchWorkParts() {
    const query = document.getElementById('work-part-search').value.toLowerCase();
    const resultsDiv = document.getElementById('work-part-results');
    
    if (query.length < 1) {
        resultsDiv.classList.add('hidden');
        return;
    }
    
    const matches = broPartsList.filter(p => 
        p.name.toLowerCase().includes(query) || 
        (p.code && p.code.toLowerCase().includes(query))
    ).slice(0, 10);
    
    if (matches.length === 0) {
        resultsDiv.innerHTML = '<div class="p-2 text-gray-500 text-sm">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        resultsDiv.classList.remove('hidden');
        return;
    }
    
    let html = '';
    matches.forEach(p => {
        const stock = p.stock || 0;
        const stockColor = stock > 0 ? 'text-lime-400' : 'text-red-400';
        html += `<div onclick="addWorkPart(${p.id})" class="p-2 hover:bg-lime-400/20 cursor-pointer border-b border-white/10">
            <div class="flex justify-between items-center">
                <span class="font-bold text-sm">${p.name}</span>
                <span class="text-blue-400 text-sm">${fmt(p.price || 0)}</span>
            </div>
            <div class="text-xs text-gray-400">${p.code || '-'} | ìž¬ê³ : <span class="${stockColor}">${stock}ê°œ</span></div>
        </div>`;
    });
    
    resultsDiv.innerHTML = html;
    resultsDiv.classList.remove('hidden');
}

// ë¶€í’ˆ ì¶”ê°€
function addWorkPart(partId) {
    const part = broPartsList.find(p => p.id === partId);
    if (!part) return;
    
    // ì´ë¯¸ ì¶”ê°€ëœ ë¶€í’ˆì¸ì§€ í™•ì¸
    const existing = workPartsSelected.find(p => p.id === partId);
    if (existing) {
        existing.qty += 1;
    } else {
        workPartsSelected.push({
            id: part.id,
            name: part.name,
            price: part.price || 0,
            qty: 1
        });
    }
    
    document.getElementById('work-part-search').value = '';
    document.getElementById('work-part-results').classList.add('hidden');
    renderWorkPartsList();
    calcWorkFromTotal();
}

// ë¶€í’ˆ ìˆ˜ëŸ‰ ë³€ê²½
function changeWorkPartQty(partId, delta) {
    const part = workPartsSelected.find(p => p.id === partId);
    if (!part) return;
    
    part.qty += delta;
    if (part.qty <= 0) {
        workPartsSelected = workPartsSelected.filter(p => p.id !== partId);
    }
    
    renderWorkPartsList();
    calcWorkFromTotal();
}

// ë¶€í’ˆ ì‚­ì œ
function removeWorkPart(partId) {
    workPartsSelected = workPartsSelected.filter(p => p.id !== partId);
    renderWorkPartsList();
    calcWorkFromTotal();
}

// ì¶”ê°€ëœ ë¶€í’ˆ ëª©ë¡ ë Œë”ë§
function renderWorkPartsList() {
    const listDiv = document.getElementById('work-parts-list');
    
    if (workPartsSelected.length === 0) {
        listDiv.innerHTML = '<div class="text-xs text-gray-500">ì¶”ê°€ëœ ë¶€í’ˆ ì—†ìŒ</div>';
        return;
    }
    
    let html = '';
    workPartsSelected.forEach(p => {
        const total = p.price * p.qty;
        html += `<div class="flex items-center justify-between p-2 bg-white/5 rounded">
            <div class="flex-1">
                <span class="text-sm font-bold">${p.name}</span>
                <span class="text-xs text-gray-400 ml-2">${fmt(p.price)} Ã— ${p.qty} = ${fmt(total)}</span>
            </div>
            <div class="flex items-center gap-1">
                <button type="button" onclick="changeWorkPartQty(${p.id}, -1)" class="w-6 h-6 rounded bg-red-400/20 text-red-400 text-sm">-</button>
                <span class="w-6 text-center text-sm">${p.qty}</span>
                <button type="button" onclick="changeWorkPartQty(${p.id}, 1)" class="w-6 h-6 rounded bg-lime-400/20 text-lime-400 text-sm">+</button>
                <button type="button" onclick="removeWorkPart(${p.id})" class="ml-2 text-red-400 text-xs">âœ•</button>
            </div>
        </div>`;
    });
    
    listDiv.innerHTML = html;
}

// ê²°ì œê¸ˆì•¡ ìž…ë ¥ ì‹œ ê³µìž„ ìžë™ ê³„ì‚°
function calcWorkFromTotal() {
    const payAmount = parseInt(document.getElementById('work-pay-amount').value) || 0;
    const vatCheck = document.getElementById('work-vat-check').checked;
    const vatAmountEl = document.getElementById('work-vat-amount');
    
    // ë¶€í’ˆë¹„ í•©ê³„
    const partsCost = workPartsSelected.reduce((sum, p) => sum + (p.price * p.qty), 0);
    document.getElementById('work-parts').value = partsCost;
    
    // ë¶€ê°€ì„¸ ê³„ì‚°
    let finalAmount = payAmount;
    if (vatCheck && payAmount > 0) {
        const vat = Math.round(payAmount * 0.1);
        finalAmount = payAmount + vat;
        vatAmountEl.textContent = `VAT: ${fmt(vat)}`;
        vatAmountEl.classList.remove('hidden');
    } else {
        vatAmountEl.classList.add('hidden');
    }
    
    // ê³µìž„ = ê²°ì œê¸ˆì•¡(+VAT) - ë¶€í’ˆë¹„
    const labor = Math.max(0, finalAmount - partsCost);
    document.getElementById('work-labor').value = labor;
    
    // í•©ê³„ í‘œì‹œ
    document.getElementById('work-total').value = fmt(finalAmount);
}

// í•©ê³„ê¸ˆì•¡ ê³„ì‚° (ê¸°ì¡´ í˜¸í™˜)
function calcWorkTotal() {
    const labor = parseInt(document.getElementById('work-labor').value) || 0;
    const parts = parseInt(document.getElementById('work-parts').value) || 0;
    document.getElementById('work-total').value = fmt(labor + parts);
}

// ê¸ˆì „ì¶œë‚©ë¶€ ìˆ˜ì •
function editCashbook(id) {
    const c = broCashbookList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('cashbook-edit-id').value = c.id;
    document.getElementById('cb-date').value = c.date;
    document.getElementById('cb-type').value = c.type;
    document.getElementById('cb-category').value = c.category;
    document.getElementById('cb-description').value = c.description;
    document.getElementById('cb-amount').value = c.amount;
    
    document.getElementById('cashbookModalTitle').textContent = 'ðŸ’° ë‚´ì—­ ìˆ˜ì •';
    document.getElementById('cashbookSubmitBtn').textContent = 'ìˆ˜ì •';
    openModal('cashbookModal');
}

// ê¸ˆì „ì¶œë‚©ë¶€ ì‚­ì œ
async function deleteCashbook(id) {
    if (!confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await deleteFromDB('bro_cashbook', id);
    broCashbookList = broCashbookList.filter(c => c.id !== id);
    showToast('âœ… ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadBroCashbook();
}

async function submitBroCashbook(e) {
    e.preventDefault();
    const editId = document.getElementById('cashbook-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    const cashData = {
        date: d.date,
        type: d.type,
        category: d.category,
        description: d.description,
        amount: parseInt(d.amount) || 0
    };
    
    if (editId) {
        await updateInDB('bro_cashbook', editId, cashData);
        const c = broCashbookList.find(x => x.id === parseInt(editId));
        if (c) Object.assign(c, cashData);
        showToast('âœ… ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        const result = await insertToDB('bro_cashbook', cashData);
        if (result && result[0]) broCashbookList.unshift(result[0]);
        showToast('âœ… ë‚´ì—­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('cashbookModal');
    e.target.reset();
    document.getElementById('cashbook-edit-id').value = '';
    document.getElementById('cashbookModalTitle').textContent = 'ðŸ’° ë‚´ì—­ ë“±ë¡';
    document.getElementById('cashbookSubmitBtn').textContent = 'ë“±ë¡';
    document.getElementById('cb-date').value = new Date().toISOString().split('T')[0];
    loadBroCashbook();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ì‚¬ê³ ì°¨ ìˆ˜ë¦¬ =======================
let accidentList = [];
let currentAccidentFilter = '';

function filterAccident(status) {
    currentAccidentFilter = status;
    
    // íƒ­ ìŠ¤íƒ€ì¼ ë³€ê²½
    const tabs = { '': 'all', 'ìž…ê³ ': 'pending', 'ìˆ˜ë¦¬ì¤‘': 'progress', 'ì™„ë£Œ': 'complete' };
    Object.entries(tabs).forEach(([s, id]) => {
        const btn = document.getElementById('acc-tab-' + id);
        if (btn) {
            const isActive = s === status;
            if (isActive) {
                const colors = { '': 'lime', 'ìž…ê³ ': 'orange', 'ìˆ˜ë¦¬ì¤‘': 'blue', 'ì™„ë£Œ': 'lime' };
                const color = colors[s];
                btn.className = `flex-1 py-2 rounded-lg font-bold text-sm bg-${color}-500/20 border border-${color}-500/30 text-${color}-400`;
            } else {
                btn.className = 'flex-1 py-2 rounded-lg font-bold text-sm bg-white/5 border border-white/10 text-gray-400';
            }
        }
    });
    
    loadAccidentList();
}

function loadAccidentList() {
    const search = document.getElementById('b-acc-search').value.toLowerCase();
    
    let list = accidentList;
    
    // ìƒíƒœ í•„í„°
    if (currentAccidentFilter === 'ìž…ê³ ') {
        list = list.filter(a => a.status === 'ì ‘ìˆ˜' || a.status === 'ê²¬ì ìš”ì²­' || a.status === 'ìŠ¹ì¸ëŒ€ê¸°');
    } else if (currentAccidentFilter === 'ìˆ˜ë¦¬ì¤‘') {
        list = list.filter(a => a.status === 'ìˆ˜ë¦¬ì¤‘');
    } else if (currentAccidentFilter === 'ì™„ë£Œ') {
        list = list.filter(a => a.status === 'ì™„ë£Œ');
    }
    
    // ê²€ìƒ‰ í•„í„°
    if (search) list = list.filter(a => 
        (a.plate && a.plate.toLowerCase().includes(search)) || 
        (a.customer && a.customer.toLowerCase().includes(search))
    );
    
    // í†µê³„ ê³„ì‚°
    const totalCount = accidentList.length;
    const pendingCount = accidentList.filter(a => a.status === 'ì ‘ìˆ˜' || a.status === 'ê²¬ì ìš”ì²­' || a.status === 'ìŠ¹ì¸ëŒ€ê¸°').length;
    const progressCount = accidentList.filter(a => a.status === 'ìˆ˜ë¦¬ì¤‘').length;
    const completeCount = accidentList.filter(a => a.status === 'ì™„ë£Œ').length;
    
    const totalActualCost = accidentList.reduce((s, a) => s + ((a.parts_cost || 0) + (a.labor_cost || 0)), 0);
    const totalApproved = accidentList.reduce((s, a) => s + (a.estimate_approved || 0), 0);
    const totalProfit = totalApproved - totalActualCost;
    
    // ìš”ì•½ í‘œì‹œ
    document.getElementById('b-acc-total').textContent = totalCount + 'ê±´';
    document.getElementById('b-acc-pending').textContent = pendingCount + 'ê±´';
    document.getElementById('b-acc-progress').textContent = progressCount + 'ê±´';
    document.getElementById('b-acc-complete').textContent = completeCount + 'ê±´';
    document.getElementById('b-acc-profit').textContent = fmt(totalProfit);
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(a => {
        const actualCost = (a.parts_cost || 0) + (a.labor_cost || 0);
        const profit = (a.estimate_approved || 0) - actualCost;
        const statusClass = {
            'ì ‘ìˆ˜': 'badge-pending', 'ê²¬ì ìš”ì²­': 'badge-pending', 'ìŠ¹ì¸ëŒ€ê¸°': 'badge-progress',
            'ìˆ˜ë¦¬ì¤‘': 'badge-progress', 'ì™„ë£Œ': 'badge-complete'
        }[a.status] || 'badge-staff';
        
        h += `<tr onclick="viewAccidentDetail(${a.id})" class="cursor-pointer hover:bg-white/5">
            <td class="text-orange-400">#${String(a.id).padStart(3,'0')}</td>
            <td class="text-gray-400 text-xs">${a.receipt_date || '-'}</td>
            <td class="font-mono font-bold text-lime-400">${a.plate || '-'}</td>
            <td>${a.customer || '-'}</td>
            <td class="text-blue-400 text-xs">${a.insurance || '-'}</td>
            <td class="text-purple-400">${fmt(a.estimate_request || 0)}</td>
            <td class="text-cyan-400">${fmt(a.estimate_approved || 0)}</td>
            <td class="text-orange-400">${fmt(actualCost)}</td>
            <td class="${profit >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${profit >= 0 ? '+' : ''}${fmt(profit)}</td>
            <td><span class="badge ${statusClass}">${a.status}</span></td>
        </tr>`;
    });
    document.getElementById('b-acc-tbody').innerHTML = h || '<tr><td colspan="10" class="text-center text-gray-500 py-6">ë“±ë¡ëœ ì‚¬ê³ ì°¨ ì—†ìŒ</td></tr>';
}

// ì‚¬ê³ ì°¨ ìƒíƒœ ë¹ ë¥¸ ë³€ê²½
async function changeAccidentStatus(id, newStatus) {
    await updateInDB('bro_accidents', id, { status: newStatus });
    const a = accidentList.find(x => x.id === id);
    if (a) a.status = newStatus;
    showToast(`âœ… ìƒíƒœê°€ "${newStatus}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
    loadAccidentList();
    loadBroDashboard();
}

function calcAccidentProfit() {
    const approved = parseInt(document.getElementById('acc-est-appr').value) || 0;
    const parts = parseInt(document.getElementById('acc-parts').value) || 0;
    const labor = parseInt(document.getElementById('acc-labor').value) || 0;
    const actualCost = parts + labor; // ì‹¤ì œ ìˆ˜ë¦¬ë¹„ = ë¶€í’ˆë¹„ + ê³µìž„ë¹„
    const profit = approved - actualCost;
    
    // ì‹¤ì œ ìˆ˜ë¦¬ë¹„ í‘œì‹œ
    document.getElementById('acc-actual-display').textContent = fmt(actualCost);
    
    // ìŠ¹ì¸ê¸ˆì•¡ í‘œì‹œ
    document.getElementById('acc-approved-display').textContent = fmt(approved);
    
    // ìˆ˜ìµ í‘œì‹œ
    document.getElementById('acc-profit-display').textContent = fmt(profit);
    document.getElementById('acc-profit-display').className = profit >= 0 ? 'font-bold text-emerald-400' : 'font-bold text-red-400';
}

async function submitAccident(e) {
    e.preventDefault();
    const editId = document.getElementById('accident-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    const partsCost = parseInt(d.parts_cost) || 0;
    const laborCost = parseInt(d.labor_cost) || 0;
    
    const data = {
        plate: d.plate,
        model: d.model || null,
        customer: d.customer,
        phone: d.phone,
        receipt_date: d.receipt_date,
        accident_type: d.accident_type || null,
        accident_desc: d.accident_desc || null,
        insurance: d.insurance || null,
        insurance_contact: d.insurance_contact || null,
        estimate_request: parseInt(d.estimate_request) || 0,
        estimate_approved: parseInt(d.estimate_approved) || 0,
        actual_cost: partsCost + laborCost, // ìžë™ ê³„ì‚°
        parts_cost: partsCost,
        labor_cost: laborCost,
        status: d.status,
        expected_date: d.expected_date || null,
        memo: d.memo || null
    };
    
    if (editId) {
        await updateInDB('bro_accidents', editId, data);
        const item = accidentList.find(x => x.id === parseInt(editId));
        if (item) Object.assign(item, data);
        showToast('âœ… ì‚¬ê³ ì°¨ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        const result = await insertToDB('bro_accidents', data);
        if (result && result[0]) accidentList.unshift(result[0]);
        showToast('âœ… ì‚¬ê³ ì°¨ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('accidentModal');
    document.getElementById('accidentForm').reset();
    document.getElementById('accident-edit-id').value = '';
    document.getElementById('accidentModalTitle').textContent = 'ðŸš¨ ì‚¬ê³ ì°¨ ë“±ë¡';
    document.getElementById('accidentSubmitBtn').textContent = 'ë“±ë¡';
    loadAccidentList();
}

function viewAccidentDetail(id) {
    const a = accidentList.find(x => x.id === id);
    if (!a) return;
    
    const profit = (a.estimate_approved || 0) - (a.actual_cost || 0);
    const statusClass = { 'ì ‘ìˆ˜': 'badge-pending', 'ê²¬ì ìš”ì²­': 'badge-pending', 'ìŠ¹ì¸ëŒ€ê¸°': 'badge-progress', 'ìˆ˜ë¦¬ì¤‘': 'badge-progress', 'ì™„ë£Œ': 'badge-complete' }[a.status] || 'badge-staff';
    
    document.getElementById('accident-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì ‘ìˆ˜ë²ˆí˜¸</span><span class="text-orange-400 font-bold">#${String(a.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${statusClass}">${a.status}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰ë²ˆí˜¸</span><span class="font-bold">${a.plate || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰ëª¨ë¸</span><span>${a.model || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span>${a.customer || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${a.phone || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì ‘ìˆ˜ì¼</span><span>${a.receipt_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì‚¬ê³ ìœ í˜•</span><span>${a.accident_type || '-'}</span></div>
            </div>
        </div>
        <div class="p-4 rounded-lg bg-blue-400/10 border border-blue-400/30 mb-4">
            <div class="text-xs text-blue-400 mb-2">ðŸ¢ ë³´í—˜ì‚¬</div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-400 text-xs">ë³´í—˜ì‚¬:</span> <span class="font-bold">${a.insurance || '-'}</span></div>
                <div><span class="text-gray-400 text-xs">ë‹´ë‹¹ìž:</span> <span>${a.insurance_contact || '-'}</span></div>
            </div>
        </div>
        <div class="p-4 rounded-lg bg-purple-400/10 border border-purple-400/30 mb-4">
            <div class="text-xs text-purple-400 mb-2">ðŸ’° ê²¬ì /ë¹„ìš©</div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div><div class="text-xs text-gray-400">ê²¬ì ìš”ì²­</div><div class="font-bold text-purple-400">${fmt(a.estimate_request || 0)}</div></div>
                <div><div class="text-xs text-gray-400">ìŠ¹ì¸ê¸ˆì•¡</div><div class="font-bold text-cyan-400">${fmt(a.estimate_approved || 0)}</div></div>
                <div><div class="text-xs text-gray-400">ì‹¤ë¹„ìš©</div><div class="font-bold text-red-400">${fmt(a.actual_cost || 0)}</div></div>
            </div>
            <div class="mt-3 pt-3 border-t border-white/10 flex justify-between">
                <span class="text-gray-400">ì˜ˆìƒ ìˆ˜ìµ</span>
                <span class="font-bold ${profit >= 0 ? 'text-emerald-400' : 'text-red-400'}">${fmt(profit)}</span>
            </div>
        </div>
        ${a.memo ? `<div class="p-3 rounded-lg bg-white/5 text-sm text-gray-400 mb-4">ðŸ“ ${a.memo}</div>` : ''}
        <div class="flex gap-3">
            <button onclick="deleteAccident(${a.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('accidentDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editAccident(${a.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('accidentDetailModal');
}

function editAccident(id) {
    closeModal('accidentDetailModal');
    const a = accidentList.find(x => x.id === id);
    if (!a) return;
    
    document.getElementById('accident-edit-id').value = a.id;
    document.getElementById('acc-plate').value = a.plate || '';
    document.getElementById('acc-model').value = a.model || '';
    document.getElementById('acc-customer').value = a.customer || '';
    document.getElementById('acc-phone').value = a.phone || '';
    document.getElementById('acc-date').value = a.receipt_date || '';
    document.getElementById('acc-type').value = a.accident_type || 'ë‹¨ë…ì‚¬ê³ ';
    document.getElementById('acc-desc').value = a.accident_desc || '';
    document.getElementById('acc-insurance').value = a.insurance || '';
    document.getElementById('acc-ins-contact').value = a.insurance_contact || '';
    document.getElementById('acc-est-req').value = a.estimate_request || 0;
    document.getElementById('acc-est-appr').value = a.estimate_approved || 0;
    document.getElementById('acc-parts').value = a.parts_cost || 0;
    document.getElementById('acc-labor').value = a.labor_cost || 0;
    document.getElementById('acc-status').value = a.status || 'ì ‘ìˆ˜';
    document.getElementById('acc-expected').value = a.expected_date || '';
    document.getElementById('acc-memo').value = a.memo || '';
    
    calcAccidentProfit();
    document.getElementById('accidentModalTitle').textContent = 'ðŸš¨ ì‚¬ê³ ì°¨ ìˆ˜ì •';
    document.getElementById('accidentSubmitBtn').textContent = 'ìˆ˜ì •';
    openModal('accidentModal');
}

async function deleteAccident(id) {
    if (!confirm('ì´ ì‚¬ê³ ì°¨ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await deleteFromDB('bro_accidents', id);
    accidentList = accidentList.filter(a => a.id !== id);
    showToast('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('accidentDetailModal');
    loadAccidentList();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ë§¤ìž…ì°¨ëŸ‰ =======================
let purchaseList = [];

function loadPurchaseList() {
    const statusFilter = document.getElementById('b-pur-status').value;
    const search = document.getElementById('b-pur-search').value.toLowerCase();
    
    let list = purchaseList;
    if (statusFilter) list = list.filter(p => p.status === statusFilter);
    if (search) list = list.filter(p => 
        (p.plate && p.plate.toLowerCase().includes(search)) || 
        (p.model && p.model.toLowerCase().includes(search))
    );
    
    // ìš”ì•½
    document.getElementById('b-pur-total').textContent = purchaseList.length + 'ëŒ€';
    document.getElementById('b-pur-repair').textContent = purchaseList.filter(p => p.status === 'ì§„í–‰ì¤‘').length + 'ëŒ€';
    document.getElementById('b-pur-ready').textContent = purchaseList.filter(p => p.status === 'ì™„ë£Œ').length + 'ëŒ€';
    
    const totalProfit = purchaseList.reduce((s, p) => {
        const cost = (p.purchase_price || 0) + (p.parts_cost || 0) + (p.labor_cost || 0) + (p.other_cost || 0);
        return s + ((p.sell_price || 0) - cost);
    }, 0);
    document.getElementById('b-pur-profit').textContent = fmt(totalProfit);
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(p => {
        const totalCost = (p.purchase_price || 0) + (p.parts_cost || 0) + (p.labor_cost || 0) + (p.other_cost || 0);
        const profit = (p.sell_price || 0) - totalCost;
        const statusClass = { 'ì§„í–‰ì¤‘': 'badge-progress', 'ì™„ë£Œ': 'badge-complete' }[p.status] || 'badge-staff';
        
        h += `<tr onclick="viewPurchaseDetail(${p.id})" class="cursor-pointer hover:bg-white/5">
            <td class="text-cyan-400">#${String(p.id).padStart(3,'0')}</td>
            <td class="text-gray-400">${p.purchase_date || '-'}</td>
            <td class="font-mono font-bold">${p.plate || '-'}</td>
            <td>${p.model || '-'}</td>
            <td class="text-yellow-400">${fmt(p.purchase_price || 0)}</td>
            <td class="text-orange-400">${fmt((p.parts_cost || 0) + (p.labor_cost || 0))}</td>
            <td class="text-red-400">${fmt(totalCost)}</td>
            <td class="text-blue-400">${fmt(p.sell_price || 0)}</td>
            <td class="${profit >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${fmt(profit)}</td>
            <td><span class="badge ${statusClass}">${p.status || '-'}</span></td>
        </tr>`;
    });
    document.getElementById('b-pur-tbody').innerHTML = h || '<tr><td colspan="10" class="text-center text-gray-500 py-6">ë“±ë¡ëœ ë§¤ìž…ì°¨ëŸ‰ ì—†ìŒ</td></tr>';
}

function calcPurchaseProfit() {
    const price = parseInt(document.getElementById('pur-price').value) || 0;
    const parts = parseInt(document.getElementById('pur-parts').value) || 0;
    const labor = parseInt(document.getElementById('pur-labor').value) || 0;
    const other = parseInt(document.getElementById('pur-other').value) || 0;
    const sell = parseInt(document.getElementById('pur-sell').value) || 0;
    
    const totalCost = price + parts + labor + other;
    const profit = sell - totalCost;
    
    document.getElementById('pur-total-cost').textContent = fmt(totalCost);
    document.getElementById('pur-profit-display').textContent = fmt(profit);
    document.getElementById('pur-profit-display').className = profit >= 0 ? 'font-bold text-emerald-400' : 'font-bold text-red-400';
}

async function submitPurchase(e) {
    e.preventDefault();
    const editId = document.getElementById('purchase-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    const data = {
        plate: d.plate,
        model: d.model,
        year: parseInt(d.year) || null,
        mileage: parseInt(d.mileage) || 0,
        color: d.color || null,
        purchase_date: d.purchase_date,
        source: d.source || null,
        purchase_price: parseInt(d.purchase_price) || 0,
        other_cost: parseInt(d.other_cost) || 0,
        parts_cost: parseInt(d.parts_cost) || 0,
        labor_cost: parseInt(d.labor_cost) || 0,
        repair_desc: d.repair_desc || null,
        sell_price: parseInt(d.sell_price) || 0,
        status: d.status,
        memo: d.memo || null
    };
    
    if (editId) {
        await updateInDB('bro_purchases', editId, data);
        const item = purchaseList.find(x => x.id === parseInt(editId));
        if (item) Object.assign(item, data);
        showToast('âœ… ë§¤ìž…ì°¨ëŸ‰ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        const result = await insertToDB('bro_purchases', data);
        if (result && result[0]) purchaseList.unshift(result[0]);
        showToast('âœ… ë§¤ìž…ì°¨ëŸ‰ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('purchaseModal');
    document.getElementById('purchaseForm').reset();
    document.getElementById('purchase-edit-id').value = '';
    document.getElementById('purchaseModalTitle').textContent = 'ðŸš— ë§¤ìž…ì°¨ëŸ‰ ë“±ë¡';
    document.getElementById('purchaseSubmitBtn').textContent = 'ë“±ë¡';
    loadPurchaseList();
}

function viewPurchaseDetail(id) {
    const p = purchaseList.find(x => x.id === id);
    if (!p) return;
    
    const totalCost = (p.purchase_price || 0) + (p.parts_cost || 0) + (p.labor_cost || 0) + (p.other_cost || 0);
    const profit = (p.sell_price || 0) - totalCost;
    const statusClass = { 'ì§„í–‰ì¤‘': 'badge-progress', 'ì™„ë£Œ': 'badge-complete' }[p.status] || 'badge-staff';
    
    document.getElementById('purchase-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê´€ë¦¬ë²ˆí˜¸</span><span class="text-cyan-400 font-bold">#${String(p.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${statusClass}">${p.status}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰ë²ˆí˜¸</span><span class="font-bold">${p.plate || '-'}</span></div>
                <div class="info-row"><span class="info-label">ëª¨ë¸</span><span>${p.model || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì‹</span><span>${p.year || '-'}ë…„ì‹</span></div>
                <div class="info-row"><span class="info-label">ì£¼í–‰ê±°ë¦¬</span><span>${(p.mileage || 0).toLocaleString()}km</span></div>
                <div class="info-row"><span class="info-label">ë§¤ìž…ì¼</span><span>${p.purchase_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ë§¤ìž…ì²˜</span><span>${p.source || '-'}</span></div>
            </div>
        </div>
        <div class="p-4 rounded-lg bg-yellow-400/10 border border-yellow-400/30 mb-4">
            <div class="text-xs text-yellow-400 mb-2">ðŸ’° ë¹„ìš© ë‚´ì—­</div>
            <div class="grid grid-cols-2 gap-2">
                <div class="flex justify-between py-1"><span class="text-gray-400 text-sm">ë§¤ìž…ê°€</span><span class="font-bold">${fmt(p.purchase_price || 0)}</span></div>
                <div class="flex justify-between py-1"><span class="text-gray-400 text-sm">ë¶€í’ˆë¹„</span><span class="font-bold">${fmt(p.parts_cost || 0)}</span></div>
                <div class="flex justify-between py-1"><span class="text-gray-400 text-sm">ê³µìž„</span><span class="font-bold">${fmt(p.labor_cost || 0)}</span></div>
                <div class="flex justify-between py-1"><span class="text-gray-400 text-sm">ê¸°íƒ€</span><span class="font-bold">${fmt(p.other_cost || 0)}</span></div>
            </div>
            <div class="border-t border-white/10 mt-2 pt-2 flex justify-between">
                <span class="font-bold text-red-400">ì´ ë¹„ìš©</span>
                <span class="font-bold text-red-400">${fmt(totalCost)}</span>
            </div>
        </div>
        <div class="p-4 rounded-lg bg-emerald-400/10 border border-emerald-400/30 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-xs text-gray-400">íŒë§¤ ì˜ˆì •ê°€</div>
                    <div class="text-xl font-bold text-blue-400">${fmt(p.sell_price || 0)}</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-400">ì˜ˆìƒ ìˆ˜ìµ</div>
                    <div class="text-xl font-bold ${profit >= 0 ? 'text-emerald-400' : 'text-red-400'}">${fmt(profit)}</div>
                </div>
            </div>
        </div>
        ${p.repair_desc ? `<div class="p-3 rounded-lg bg-orange-400/10 text-sm mb-4"><span class="text-orange-400">ðŸ”§ ìˆ˜ë¦¬ë‚´ì—­:</span> ${p.repair_desc}</div>` : ''}
        ${p.memo ? `<div class="p-3 rounded-lg bg-white/5 text-sm text-gray-400 mb-4">ðŸ“ ${p.memo}</div>` : ''}
        <div class="flex gap-3">
            <button onclick="deletePurchase(${p.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('purchaseDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editPurchase(${p.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('purchaseDetailModal');
}

function editPurchase(id) {
    closeModal('purchaseDetailModal');
    const p = purchaseList.find(x => x.id === id);
    if (!p) return;
    
    document.getElementById('purchase-edit-id').value = p.id;
    document.getElementById('pur-plate').value = p.plate || '';
    document.getElementById('pur-model').value = p.model || '';
    document.getElementById('pur-year').value = p.year || 2024;
    document.getElementById('pur-mileage').value = p.mileage || 0;
    document.getElementById('pur-color').value = p.color || '';
    document.getElementById('pur-date').value = p.purchase_date || '';
    document.getElementById('pur-source').value = p.source || '';
    document.getElementById('pur-price').value = p.purchase_price || 0;
    document.getElementById('pur-other').value = p.other_cost || 0;
    document.getElementById('pur-parts').value = p.parts_cost || 0;
    document.getElementById('pur-labor').value = p.labor_cost || 0;
    document.getElementById('pur-repair-desc').value = p.repair_desc || '';
    document.getElementById('pur-sell').value = p.sell_price || 0;
    document.getElementById('pur-status').value = p.status || 'ë§¤ìž…';
    document.getElementById('pur-memo').value = p.memo || '';
    
    calcPurchaseProfit();
    document.getElementById('purchaseModalTitle').textContent = 'ðŸš— ë§¤ìž…ì°¨ëŸ‰ ìˆ˜ì •';
    document.getElementById('purchaseSubmitBtn').textContent = 'ìˆ˜ì •';
    openModal('purchaseModal');
}

async function deletePurchase(id) {
    if (!confirm('ì´ ë§¤ìž…ì°¨ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await deleteFromDB('bro_purchases', id);
    purchaseList = purchaseList.filter(p => p.id !== id);
    showToast('âœ… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('purchaseDetailModal');
    loadPurchaseList();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ë¶€í’ˆê´€ë¦¬ =======================
function filterBroParts(type) {
    document.getElementById('b-parts-stock-filter').value = type;
    loadBroParts();
}

function loadBroParts() {
    const search = document.getElementById('b-parts-search').value.toLowerCase();
    const categoryFilter = document.getElementById('b-parts-category').value;
    const stockFilter = document.getElementById('b-parts-stock-filter').value;
    
    let parts = broPartsList;
    if (categoryFilter) parts = parts.filter(p => p.category === categoryFilter);
    if (stockFilter === 'low') parts = parts.filter(p => p.stock > 0 && p.stock <= p.min_stock);
    else if (stockFilter === 'normal') parts = parts.filter(p => p.stock > p.min_stock);
    else if (stockFilter === 'zero') parts = parts.filter(p => p.stock === 0);
    if (search) parts = parts.filter(p => p.name.toLowerCase().includes(search) || p.category.toLowerCase().includes(search));
    
    // ìš”ì•½
    const totalQty = broPartsList.reduce((s, p) => s + p.stock, 0);
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock);
    const lowStockNames = lowStockParts.slice(0, 3).map(p => p.name.substring(0, 8)).join(', ');
    const totalValue = broPartsList.reduce((s, p) => s + p.stock * p.price, 0);
    
    document.getElementById('b-parts-total').textContent = broPartsList.length + 'ì¢…';
    document.getElementById('b-parts-total-qty').textContent = 'ì´ ' + totalQty + 'ê°œ';
    document.getElementById('b-parts-low').textContent = lowStockParts.length + 'ì¢…';
    document.getElementById('b-parts-low-list').textContent = lowStockNames ? lowStockNames + (lowStockParts.length > 3 ? '...' : '') : '-';
    document.getElementById('b-parts-value').textContent = fmt(totalValue);
    
    // í…Œì´ë¸”
    let h = '';
    parts.forEach(p => {
        const isLow = p.stock <= p.min_stock;
        const isZero = p.stock === 0;
        const statusBadge = isZero ? ['badge-failed', 'í’ˆì ˆ'] : isLow ? ['badge-low', 'ë¶€ì¡±'] : ['badge-normal', 'ì •ìƒ'];
        h += `<tr class="cursor-pointer hover:bg-white/5">
            <td class="font-bold" onclick="editParts(${p.id})">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td class="${isZero ? 'text-red-400' : isLow ? 'text-orange-400' : ''} font-bold">${p.stock}ê°œ</td>
            <td class="text-gray-500">${p.min_stock}ê°œ</td>
            <td class="text-gray-400">${fmt(p.price)}</td>
            <td class="text-blue-400">${fmt(p.stock * p.price)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td>
                <button onclick="editParts(${p.id})" class="text-lime-400 text-xs hover:underline mr-2">ìˆ˜ì •</button>
                <button onclick="deleteParts(${p.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-parts-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">ë¶€í’ˆ ì—†ìŒ</td></tr>';
}

// ë¶€í’ˆ ì‚­ì œ
function deleteParts(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    broPartsList = broPartsList.filter(p => p.id !== id);
    showToast('ðŸ—‘ï¸ ë¶€í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadBroParts();
}

// ìž¬ê³  ê¸ˆì•¡ ìƒì„¸ ëª¨ë‹¬
function openPartsValueModal() {
    // ë¶„ë¥˜ë³„ ìž¬ê³ ê¸ˆì•¡ ì§‘ê³„
    let categoryStats = {};
    broPartsList.forEach(p => {
        if (!categoryStats[p.category]) {
            categoryStats[p.category] = { count: 0, qty: 0, value: 0 };
        }
        categoryStats[p.category].count++;
        categoryStats[p.category].qty += p.stock;
        categoryStats[p.category].value += p.stock * p.price;
    });
    
    const totalValue = broPartsList.reduce((s, p) => s + p.stock * p.price, 0);
    
    // ë¶„ë¥˜ë³„ ë°” ì°¨íŠ¸
    let barsHtml = '';
    Object.entries(categoryStats).sort((a, b) => b[1].value - a[1].value).forEach(([cat, data]) => {
        const pct = totalValue > 0 ? Math.round((data.value / totalValue) * 100) : 0;
        barsHtml += `<div class="flex items-center gap-3 mb-2">
            <span class="w-16 text-xs text-gray-400">${cat}</span>
            <div class="flex-1 h-5 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full bg-blue-400 rounded-full" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-blue-400 w-24 text-right">${fmt(data.value)}</span>
            <span class="text-xs text-gray-500 w-12">${pct}%</span>
        </div>`;
    });
    
    // ë¶€í’ˆë³„ ìƒìœ„ 5ê°œ
    const topParts = [...broPartsList].sort((a, b) => (b.stock * b.price) - (a.stock * a.price)).slice(0, 5);
    let topRows = '';
    topParts.forEach(p => {
        topRows += `<tr>
            <td class="font-bold">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td>${p.stock}ê°œ</td>
            <td class="text-blue-400 font-bold">${fmt(p.stock * p.price)}</td>
        </tr>`;
    });
    
    document.getElementById('bro-parts-value-content').innerHTML = `
        <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 mb-4 text-center">
            <div class="text-xs text-blue-400 mb-1">ì´ ìž¬ê³  ê¸ˆì•¡</div>
            <div class="text-3xl font-black text-blue-400">${fmt(totalValue)}</div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ“Š ë¶„ë¥˜ë³„ ìž¬ê³  ê¸ˆì•¡</div>
            ${barsHtml || '<div class="text-gray-500 text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ† ìž¬ê³ ê¸ˆì•¡ Top 5</div>
            <table class="data-table">
                <thead><tr><th>ë¶€í’ˆëª…</th><th>ë¶„ë¥˜</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th></tr></thead>
                <tbody>${topRows || '<tr><td colspan="4" class="text-center text-gray-500 py-2">ë°ì´í„° ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broPartsValueModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broPartsValueModal'); showBromotorsTab('parts');" class="btn-primary flex-1">ë¶€í’ˆê´€ë¦¬ ì´ë™</button>
        </div>
    `;
    
    openModal('broPartsValueModal');
}

function openPartsModal(editId = null) {
    document.getElementById('partsForm').reset();
    document.getElementById('parts-edit-id').value = '';
    document.getElementById('parts-min').value = '5';
    
    if (editId) {
        const p = broPartsList.find(x => x.id === editId);
        if (p) {
            document.getElementById('partsModalTitle').textContent = 'ðŸ“¦ ë¶€í’ˆ ìˆ˜ì •';
            document.getElementById('partsSubmitBtn').textContent = 'ìˆ˜ì •';
            document.getElementById('parts-edit-id').value = p.id;
            document.getElementById('parts-name').value = p.name;
            document.getElementById('parts-category').value = p.category;
            document.getElementById('parts-stock').value = p.stock;
            document.getElementById('parts-price').value = p.price;
            document.getElementById('parts-min').value = p.min_stock;
        }
    } else {
        document.getElementById('partsModalTitle').textContent = 'ðŸ“¦ ë¶€í’ˆ ë“±ë¡';
        document.getElementById('partsSubmitBtn').textContent = 'ë“±ë¡';
    }
    
    openModal('partsModal');
}

function editParts(id) {
    openPartsModal(id);
}

async function submitBroParts(e) {
    e.preventDefault();
    const editId = document.getElementById('parts-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    const partData = {
        name: d.name,
        category: d.category,
        stock: parseInt(d.stock) || 0,
        price: parseInt(d.price) || 0,
        min_stock: parseInt(d.min_stock) || 5
    };
    
    console.log('ðŸ“¦ ë¶€í’ˆ ë°ì´í„°:', partData);
    
    if (editId) {
        // ìˆ˜ì • ëª¨ë“œ
        await updateInDB('bro_parts', editId, partData);
        const p = broPartsList.find(x => x.id === parseInt(editId));
        if (p) Object.assign(p, partData);
        showToast('âœ… ë¶€í’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ë“±ë¡ ëª¨ë“œ - DBì— ì €ìž¥
        const result = await insertToDB('bro_parts', partData);
        console.log('ðŸ“¦ ë¶€í’ˆ ë“±ë¡ ê²°ê³¼:', result);
        
        if (result && result[0]) {
            broPartsList.push(result[0]);
            
            // ê¸ˆì „ì¶œë‚©ë¶€ì— ì§€ì¶œ ìžë™ ì¶”ê°€ (ìž¬ê³  * ë‹¨ê°€)
            const totalCost = partData.stock * partData.price;
            console.log('ðŸ’° ì´ ë¹„ìš©:', totalCost);
            
            if (totalCost > 0) {
                const now = new Date();
                const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
                const today = koreaTime.toISOString().split('T')[0];
                
                const cashbookData = {
                    date: today,
                    type: 'expense',
                    category: 'ë¶€í’ˆêµ¬ìž…',
                    amount: totalCost,
                    description: `[ë¶€í’ˆìž…ê³ ] ${partData.name} ${partData.stock}ê°œ Ã— ${fmt(partData.price)}`,
                    memo: 'ë¶€í’ˆ ë“±ë¡ ì‹œ ìžë™ ìƒì„±'
                };
                
                console.log('ðŸ“ ê¸ˆì „ì¶œë‚©ë¶€ ë°ì´í„°:', cashbookData);
                
                const cbResult = await insertToDB('bro_cashbook', cashbookData);
                console.log('ðŸ“ ê¸ˆì „ì¶œë‚©ë¶€ ë“±ë¡ ê²°ê³¼:', cbResult);
                
                if (cbResult && cbResult[0]) {
                    broCashbookList.unshift(cbResult[0]);
                    showToast(`âœ… ë¶€í’ˆ ë“±ë¡ + ê¸ˆì „ì¶œë‚©ë¶€ ì§€ì¶œ ${fmt(totalCost)} ì¶”ê°€`);
                } else {
                    showToast('âœ… ë¶€í’ˆ ë“±ë¡ (ê¸ˆì „ì¶œë‚©ë¶€ ì—°ë™ ì‹¤íŒ¨)');
                }
            } else {
                showToast('âœ… ë¶€í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        } else {
            showToast('âŒ ë¶€í’ˆ ë“±ë¡ ì‹¤íŒ¨');
        }
    }
    
    closeModal('partsModal');
    loadBroParts();
    loadBroCashbook();
    loadBroDashboard();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ê³ ê°ê´€ë¦¬ =======================
function filterBroCustomers(type) {
    document.getElementById('b-cust-filter').value = type;
    loadBroCustomers();
}

function loadBroCustomers() {
    const search = document.getElementById('b-cust-search').value.toLowerCase();
    const filter = document.getElementById('b-cust-filter').value;
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonthStart = koreaTime.toISOString().split('T')[0].substring(0, 7) + '-01';
    
    let custs = broCustList;
    
    // í•„í„° ì ìš©
    if (filter === 'month') custs = custs.filter(c => c.last_visit >= thisMonthStart);
    if (filter === 'vip') custs = custs.filter(c => c.visits >= 3);
    if (search) custs = custs.filter(c => 
        c.name.toLowerCase().includes(search) || 
        c.phone.includes(search) || 
        (c.vehicle && c.vehicle.toLowerCase().includes(search)) ||
        (c.plate && c.plate.toLowerCase().includes(search))
    );
    
    // ìš”ì•½
    document.getElementById('b-cust-total').textContent = broCustList.length + 'ëª…';
    document.getElementById('b-cust-month').textContent = broCustList.filter(c => c.last_visit >= thisMonthStart).length + 'ëª…';
    document.getElementById('b-cust-vip').textContent = broCustList.filter(c => c.visits >= 3).length + 'ëª…';
    
    // í…Œì´ë¸”
    let h = '';
    custs.forEach(c => {
        const vipBadge = c.visits >= 3 ? '<span class="badge badge-vip ml-1">ë‹¨ê³¨</span>' : '';
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewBroCustDetail(${c.id})">
            <td class="font-bold">${c.name}${vipBadge}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle || '-'}</td>
            <td class="text-gray-400">${c.plate || '-'}</td>
            <td class="text-blue-400">${c.visits}íšŒ</td>
            <td class="text-gray-400">${c.last_visit}</td>
            <td class="flex gap-2">
                <button onclick="event.stopPropagation(); editBroCustomer(${c.id})" class="text-blue-400 text-xs hover:underline">ìˆ˜ì •</button>
                <button onclick="event.stopPropagation(); deleteBroCustomer(${c.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-cust-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ê³ ê° ì—†ìŒ</td></tr>';
}

// ê³ ê° ìƒì„¸ ëª¨ë‹¬
function viewBroCustDetail(custId) {
    const c = broCustList.find(x => x.id === custId);
    if (!c) return;
    
    const phoneClean = c.phone.replace(/-/g, '');
    const vipBadge = c.visits >= 3 ? '<span class="badge badge-vip">â­ ë‹¨ê³¨ ê³ ê°</span>' : '';
    
    // í•´ë‹¹ ê³ ê°ì˜ ìž‘ì—… ë‚´ì—­ (customer_idë¡œ ë¨¼ì € ì°¾ê³ , ì—†ìœ¼ë©´ ì´ë¦„/ì—°ë½ì²˜ë¡œ)
    const custWorks = broWorkList.filter(w => 
        w.customer_id === c.id || 
        w.customer === c.name || 
        w.phone === c.phone
    ).slice(0, 5);
    let workRows = '';
    custWorks.forEach(w => {
        const statusBadge = { waiting: ['badge-pending', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[w.status] || ['', ''];
        const total = (w.labor || 0) + (w.parts_cost || 0);
        workRows += `<tr onclick="closeModal('broCustDetailModal'); viewWorkDetail(${w.id})" class="cursor-pointer hover:bg-white/5">
            <td class="text-gray-400">${w.date}</td>
            <td>${w.content}</td>
            <td class="text-blue-400">${fmt(total)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    // ì´ ì´ìš© ê¸ˆì•¡
    const allCustWorks = broWorkList.filter(w => 
        w.customer_id === c.id || 
        w.customer === c.name || 
        w.phone === c.phone
    );
    const totalSpent = allCustWorks.reduce((s, w) => s + (w.labor || 0) + (w.parts_cost || 0), 0);
    
    document.getElementById('bro-cust-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="text-xl font-bold">${c.name} ${vipBadge}</div>
                    <div class="text-gray-400">${c.vehicle || '-'} Â· ${c.plate || '-'}</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">ì´ ì´ìš©ê¸ˆì•¡</div>
                    <div class="text-xl font-black text-emerald-400">${fmt(totalSpent)}</div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ë°©ë¬¸íšŸìˆ˜</span><span class="text-blue-400 font-bold">${c.visits}íšŒ</span></div>
                <div class="info-row"><span class="info-label">ìµœê·¼ë°©ë¬¸</span><span>${c.last_visit}</span></div>
            </div>
            ${c.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-xs text-gray-400">ðŸ“ ${c.memo}</div>` : ''}
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ðŸ“ž ì „í™”</div>
                <div class="text-xs text-gray-400">${c.phone}</div>
            </a>
            <a href="sms:${phoneClean}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ðŸ’¬ ë¬¸ìž</div>
                <div class="text-xs text-gray-400">ë¬¸ìž ë³´ë‚´ê¸°</div>
            </a>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ”§ ìµœê·¼ ìž‘ì—… ë‚´ì—­</div>
            <table class="data-table">
                <thead><tr><th>ë‚ ì§œ</th><th>ìž‘ì—…</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${workRows || '<tr><td colspan="4" class="text-center text-gray-500 py-3">ìž‘ì—… ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="deleteBroCustomer(${c.id}); closeModal('broCustDetailModal');" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('broCustDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broCustDetailModal'); editBroCustomer(${c.id});" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    
    openModal('broCustDetailModal');
}

async function submitBroCustomer(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const editId = document.getElementById('bro-cust-edit-id').value;
    
    // í•„ìˆ˜ê°’ ì²´í¬
    if (!d.name || !d.phone) {
        showToast('âš ï¸ ê³ ê°ëª…ê³¼ ì—°ë½ì²˜ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    const custData = {
        name: d.name,
        phone: d.phone,
        vehicle: d.vehicle || null,
        plate: d.plate || null
    };
    
    try {
        if (editId) {
            // ìˆ˜ì •
            await updateInDB('bro_customers', editId, custData);
            const c = broCustList.find(x => x.id === parseInt(editId));
            if (c) Object.assign(c, custData);
            showToast('âœ… ê³ ê° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
            // ì‹ ê·œ ë“±ë¡
            custData.visits = 0;
            custData.last_visit = today;
            const result = await insertToDB('bro_customers', custData);
            if (result && result[0]) {
                broCustList.unshift(result[0]);
                showToast('âœ… ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
                showToast('âš ï¸ ë“±ë¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
        }
        
        closeModal('broCustModal');
        document.getElementById('broCustForm').reset();
        document.getElementById('bro-cust-edit-id').value = '';
        document.getElementById('broCustModalTitle').textContent = 'ðŸ‘¤ ê³ ê° ë“±ë¡';
        document.getElementById('broCustSubmitBtn').textContent = 'ë“±ë¡';
        loadBroCustomers();
    } catch (err) {
        console.error('ê³ ê° ë“±ë¡ ì˜¤ë¥˜:', err);
        showToast('âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// ê³ ê° ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openBroCustModal() {
    document.getElementById('broCustModalTitle').textContent = 'ðŸ‘¤ ê³ ê° ë“±ë¡';
    document.getElementById('broCustSubmitBtn').textContent = 'ë“±ë¡';
    document.getElementById('bro-cust-edit-id').value = '';
    document.getElementById('broCustForm').reset();
    openModal('broCustModal');
}

// ê³ ê° ìˆ˜ì •
function editBroCustomer(id) {
    const c = broCustList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('broCustModalTitle').textContent = 'ðŸ‘¤ ê³ ê° ìˆ˜ì •';
    document.getElementById('broCustSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('bro-cust-edit-id').value = c.id;
    document.getElementById('bro-cust-name').value = c.name;
    document.getElementById('bro-cust-phone').value = c.phone;
    document.getElementById('bro-cust-vehicle').value = c.vehicle || '';
    document.getElementById('bro-cust-plate').value = c.plate || '';
    
    openModal('broCustModal');
}

// ê³ ê° ì‚­ì œ
async function deleteBroCustomer(id) {
    const c = broCustList.find(x => x.id === id);
    if (!c) return;
    
    if (!confirm(`'${c.name}' ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
    
    await deleteFromDB('bro_customers', id);
    broCustList = broCustList.filter(x => x.id !== id);
    showToast('âœ… ê³ ê°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadBroCustomers();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ëŒ€ì‹œë³´ë“œ =======================
function loadBroDashboard() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // ë‚ ì§œ êµ¬ê°„ ê¸°ë³¸ê°’: ì•žìœ¼ë¡œ 7ì¼ ê¸°ì¤€ (ì˜¤ëŠ˜ - 7ì¼ ì „ ~ ì˜¤ëŠ˜)
    let startDate = document.getElementById('b-dash-start').value;
    let endDate = document.getElementById('b-dash-end').value;
    
    if (!startDate || !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
        endDate = today;
        document.getElementById('b-dash-start').value = startDate;
        document.getElementById('b-dash-end').value = endDate;
    }
    
    // ê¸°ê°„ ë‚´ ê¸ˆì „ì¶œë‚©ë¶€ ìˆ˜ìž…/ì§€ì¶œ
    const periodCashbook = broCashbookList.filter(c => c.date >= startDate && c.date <= endDate);
    const periodCashIncome = periodCashbook.filter(c => c.type === 'income');
    const periodCashExpense = periodCashbook.filter(c => c.type === 'expense');
    const cashIncomeTotal = periodCashIncome.reduce((s, c) => s + (c.amount || 0), 0);
    const cashExpenseTotal = periodCashExpense.reduce((s, c) => s + (c.amount || 0), 0);
    
    // ê¸°ê°„ ë‚´ ìž‘ì—… ë§¤ì¶œ (ì™„ë£Œëœ ìž‘ì—…ë§Œ)
    const periodWorks = broWorkList.filter(w => w.date >= startDate && w.date <= endDate);
    const completedWorks = periodWorks.filter(w => w.status === 'complete');
    const workLabor = completedWorks.reduce((s, w) => s + (w.labor || 0), 0);
    const workParts = completedWorks.reduce((s, w) => s + (w.parts_cost || 0), 0);
    const workTotal = workLabor + workParts;
    
    // ì‚¬ê³ ì°¨ ìˆ˜ìµ (ì™„ë£Œëœ ê²ƒë§Œ)
    const periodAccidents = accidentList.filter(a => a.status === 'ì™„ë£Œ');
    const accidentProfit = periodAccidents.reduce((s, a) => {
        const actualCost = (a.parts_cost || 0) + (a.labor_cost || 0);
        return s + ((a.estimate_approved || 0) - actualCost);
    }, 0);
    
    // ì´ ìˆ˜ìž… = ê¸ˆì „ì¶œë‚©ë¶€ ìˆ˜ìž… + ìž‘ì—… ë§¤ì¶œ + ì‚¬ê³ ì°¨ ìˆ˜ìµ
    const totalIncome = cashIncomeTotal + workTotal + accidentProfit;
    // ì´ ì§€ì¶œ = ê¸ˆì „ì¶œë‚©ë¶€ ì§€ì¶œ
    const totalExpense = cashExpenseTotal;
    // ì†ìµ
    const profit = totalIncome - totalExpense;
    const profitRate = totalIncome > 0 ? Math.round((profit / totalIncome) * 100) : 0;
    
    // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
    document.getElementById('b-today-income').textContent = fmt(totalIncome);
    document.getElementById('b-income-count').textContent = `ê¸ˆì „${periodCashIncome.length} + ìž‘ì—…${completedWorks.length}ê±´`;
    document.getElementById('b-month-expense').textContent = fmt(totalExpense);
    document.getElementById('b-expense-count').textContent = periodCashExpense.length + 'ê±´';
    document.getElementById('b-period-work').textContent = periodWorks.length + 'ê±´';
    document.getElementById('b-work-amount').textContent = fmt(workTotal);
    document.getElementById('b-month-profit').textContent = fmt(profit);
    document.getElementById('b-profit-rate').textContent = profit >= 0 ? `+${profitRate}%` : `${profitRate}%`;
    
    // ì†ìµ ìƒì„¸ (ìž…ê¸ˆ - ì§€ì¶œ)
    if (document.getElementById('b-profit-detail')) {
        document.getElementById('b-profit-detail').innerHTML = `<span class="text-blue-400">+${fmt(totalIncome)}</span> <span class="text-red-400">-${fmt(totalExpense)}</span>`;
    }
    
    // ì‚¬ê³ ì°¨ ìˆ˜ìµ í‘œì‹œ ì¶”ê°€
    if (document.getElementById('b-accident-profit')) {
        document.getElementById('b-accident-profit').textContent = fmt(accidentProfit);
        document.getElementById('b-accident-count').textContent = periodAccidents.length + 'ê±´ ì™„ë£Œ';
    }
    
    // ì‚¬ê³ ì°¨ ìˆ˜ë¦¬ì¤‘
    if (document.getElementById('b-accident-progress')) {
        const accidentInProgress = accidentList.filter(a => a.status === 'ìˆ˜ë¦¬ì¤‘').length;
        document.getElementById('b-accident-progress').textContent = accidentInProgress + 'ê±´';
    }
    
    // ë§¤ìž…ì°¨ëŸ‰ í˜„í™©
    if (document.getElementById('b-purchase-count')) {
        const inProgress = purchaseList.filter(p => p.status === 'ì§„í–‰ì¤‘').length;
        const completed = purchaseList.filter(p => p.status === 'ì™„ë£Œ').length;
        document.getElementById('b-purchase-count').textContent = purchaseList.length + 'ëŒ€';
        document.getElementById('b-purchase-status').textContent = `ì§„í–‰ ${inProgress} / ì™„ë£Œ ${completed}`;
        
        if (document.getElementById('b-purchase-complete')) {
            document.getElementById('b-purchase-complete').textContent = completed + 'ëŒ€';
        }
    }
    
    // ì˜¤ëŠ˜ ìž‘ì—…
    const todayWorks = broWorkList.filter(w => w.date === today);
    document.getElementById('b-today-work-count').textContent = todayWorks.length + 'ê±´';
    
    let workHtml = '';
    todayWorks.slice(0, 4).forEach(w => {
        const statusBadge = { waiting: ['badge-pending', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[w.status] || ['', ''];
        workHtml += `<div class="p-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between cursor-pointer hover:bg-white/10" onclick="viewWorkDetail(${w.id})">
            <div><div class="font-bold text-sm">${w.content}</div><div class="text-xs text-gray-500">${w.customer} Â· ${w.plate}</div></div>
            <span class="badge ${statusBadge[0]}">${statusBadge[1]}</span>
        </div>`;
    });
    if (todayWorks.length > 4) {
        workHtml += `<div class="text-center py-2"><button onclick="openBroTodayWorkModal()" class="text-lime-400 text-xs hover:underline">+ ${todayWorks.length - 4}ê±´ ë”ë³´ê¸°</button></div>`;
    }
    document.getElementById('b-today-work-list').innerHTML = workHtml || '<div class="text-gray-500 text-sm text-center py-4">ì˜¤ëŠ˜ ìž‘ì—… ì—†ìŒ</div>';
    
    // ìž¬ê³  ë¶€ì¡±
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock);
    document.getElementById('b-low-stock-count').textContent = lowStockParts.length + 'ê±´';
    
    let stockHtml = '';
    lowStockParts.slice(0, 4).forEach(p => {
        const critical = p.stock === 0;
        stockHtml += `<div class="p-3 rounded-xl ${critical ? 'bg-red-400/10 border-red-400/30' : 'bg-orange-400/5 border-orange-400/20'} border flex items-center justify-between cursor-pointer hover:bg-orange-400/10" onclick="openBroLowStockModal()">
            <div><div class="font-bold text-sm">${p.name}</div><div class="text-xs text-gray-500">í˜„ìž¬: ${p.stock}ê°œ (ìµœì†Œ: ${p.min_stock})</div></div>
            <span class="badge ${critical ? 'badge-failed' : 'badge-low'}">${critical ? 'í’ˆì ˆ' : 'ë¶€ì¡±'}</span>
        </div>`;
    });
    if (lowStockParts.length > 4) {
        stockHtml += `<div class="text-center py-2"><button onclick="openBroLowStockModal()" class="text-orange-400 text-xs hover:underline">+ ${lowStockParts.length - 4}ê±´ ë”ë³´ê¸°</button></div>`;
    }
    document.getElementById('b-low-stock-list').innerHTML = stockHtml || '<div class="text-gray-500 text-sm text-center py-4">ìž¬ê³  ë¶€ì¡± ì—†ìŒ</div>';
    
    // ë‹¤ë¥¸ íƒ­ ë°ì´í„°ë„ ë¯¸ë¦¬ ë¡œë“œ
    loadBroWorks();
    loadBroParts();
    loadBroCashbook();
    loadBroCustomers();
    loadAccidentList();
    loadPurchaseList();
    
    console.log('âœ… ë¸Œë¡œëª¨í„°ìŠ¤ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ');
}

// ëŒ€ì‹œë³´ë“œ ê¸°ê°„ ì„¤ì •
function setBroDashPeriod(period) {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let startDate = today;
    if (period === 'today') {
        startDate = today;
    } else if (period === 'week') {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
    } else if (period === 'month') {
        startDate = today.substring(0, 7) + '-01';
    }
    
    document.getElementById('b-dash-start').value = startDate;
    document.getElementById('b-dash-end').value = today;
    loadBroDashboard();
}

// ì˜¤ëŠ˜ ìž‘ì—… ìƒì„¸ ëª¨ë‹¬
function openBroTodayWorkModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    const todayWorks = broWorkList.filter(w => w.date === today);
    const totalAmount = todayWorks.reduce((s, w) => s + w.total, 0);
    const completed = todayWorks.filter(w => w.status === 'complete').length;
    
    let tableRows = '';
    todayWorks.forEach(w => {
        const statusBadge = { waiting: ['badge-pending', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[w.status] || ['', ''];
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="closeModal('broTodayWorkModal'); viewWorkDetail(${w.id})">
            <td class="text-lime-400">#${String(w.id).padStart(3, '0')}</td>
            <td class="font-bold">${w.customer}</td>
            <td>${w.work}</td>
            <td class="text-blue-400">${fmt(w.total)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    document.getElementById('bro-today-work-content').innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="p-4 rounded-xl bg-lime-400/10 border border-lime-400/30 text-center">
                <div class="text-xs text-lime-400 mb-1">ì „ì²´</div>
                <div class="text-xl font-black text-lime-400">${todayWorks.length}ê±´</div>
            </div>
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì™„ë£Œ</div>
                <div class="text-xl font-black text-emerald-400">${completed}ê±´</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">ë§¤ì¶œ</div>
                <div class="text-xl font-black text-blue-400">${fmt(totalAmount)}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ì ‘ìˆ˜</th><th>ê³ ê°</th><th>ìž‘ì—…</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">ìž‘ì—… ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broTodayWorkModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broTodayWorkModal'); showBromotorsTab('work');" class="btn-primary flex-1">ìž‘ì—…ë‚´ìš© ì´ë™</button>
        </div>
    `;
    
    openModal('broTodayWorkModal');
}

// ìž¬ê³  ë¶€ì¡± ìƒì„¸ ëª¨ë‹¬
function openBroLowStockModal() {
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock).sort((a, b) => a.stock - b.stock);
    const critical = lowStockParts.filter(p => p.stock === 0).length;
    
    let tableRows = '';
    lowStockParts.forEach(p => {
        const statusBadge = p.stock === 0 ? ['badge-failed', 'í’ˆì ˆ'] : ['badge-low', 'ë¶€ì¡±'];
        tableRows += `<tr>
            <td class="font-bold">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td class="${p.stock === 0 ? 'text-red-400' : 'text-orange-400'} font-bold">${p.stock}ê°œ</td>
            <td class="text-gray-500">${p.min_stock}ê°œ</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    document.getElementById('bro-low-stock-content').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 text-center">
                <div class="text-xs text-orange-400 mb-1">ìž¬ê³  ë¶€ì¡±</div>
                <div class="text-xl font-black text-orange-400">${lowStockParts.length}ê±´</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">í’ˆì ˆ</div>
                <div class="text-xl font-black text-red-400">${critical}ê±´</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ë¶€í’ˆëª…</th><th>ë¶„ë¥˜</th><th>í˜„ìž¬</th><th>ìµœì†Œ</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">ìž¬ê³  ë¶€ì¡± ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broLowStockModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broLowStockModal'); showBromotorsTab('parts');" class="btn-primary flex-1">ë¶€í’ˆê´€ë¦¬ ì´ë™</button>
        </div>
    `;
    
    openModal('broLowStockModal');
}

// ì›”ê°„ ìš”ì•½ ëª¨ë‹¬
function openBroMonthSummary() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonthStart = koreaTime.toISOString().split('T')[0].substring(0, 7) + '-01';
    const monthName = koreaTime.toISOString().split('T')[0].substring(0, 7).replace('-', 'ë…„ ') + 'ì›”';
    
    const monthData = broCashbookList.filter(c => c.date >= thisMonthStart);
    const monthIncome = monthData.filter(c => c.type === 'income').reduce((s, c) => s + c.amount, 0);
    const monthExpense = monthData.filter(c => c.type === 'expense').reduce((s, c) => s + c.amount, 0);
    const monthProfit = monthIncome - monthExpense;
    
    // ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
    let categoryStats = {};
    monthData.forEach(c => {
        const key = c.type + '-' + c.category;
        categoryStats[key] = (categoryStats[key] || 0) + c.amount;
    });
    
    let incomeBars = '', expenseBars = '';
    Object.entries(categoryStats).forEach(([key, amount]) => {
        const [type, cat] = key.split('-');
        const total = type === 'income' ? monthIncome : monthExpense;
        const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
        const bar = `<div class="flex items-center gap-3 mb-2">
            <span class="w-16 text-xs text-gray-400">${cat}</span>
            <div class="flex-1 h-3 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full ${type === 'income' ? 'bg-emerald-400' : 'bg-red-400'}" style="width:${pct}%"></div>
            </div>
            <span class="text-xs ${type === 'income' ? 'text-emerald-400' : 'text-red-400'} w-20 text-right">${fmt(amount)}</span>
        </div>`;
        if (type === 'income') incomeBars += bar;
        else expenseBars += bar;
    });
    
    document.getElementById('bro-month-summary-content').innerHTML = `
        <div class="text-center text-lg font-bold text-lime-400 mb-4">${monthName}</div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ìˆ˜ìž…</div>
                <div class="text-xl font-black text-emerald-400">${fmt(monthIncome)}</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">ì§€ì¶œ</div>
                <div class="text-xl font-black text-red-400">${fmt(monthExpense)}</div>
            </div>
            <div class="p-4 rounded-xl ${monthProfit >= 0 ? 'bg-blue-400/10 border-blue-400/30' : 'bg-orange-400/10 border-orange-400/30'} text-center">
                <div class="text-xs ${monthProfit >= 0 ? 'text-blue-400' : 'text-orange-400'} mb-1">ìˆœì´ìµ</div>
                <div class="text-xl font-black ${monthProfit >= 0 ? 'text-blue-400' : 'text-orange-400'}">${fmt(monthProfit)}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-emerald-400 mb-3">ðŸ“ˆ ìˆ˜ìž… ë‚´ì—­</div>
            ${incomeBars || '<div class="text-gray-500 text-sm text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-red-400 mb-3">ðŸ“‰ ì§€ì¶œ ë‚´ì—­</div>
            ${expenseBars || '<div class="text-gray-500 text-sm text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broMonthSummaryModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broMonthSummaryModal'); showBromotorsTab('cashbook');" class="btn-primary flex-1">ê¸ˆì „ì¶œë‚©ë¶€ ì´ë™</button>
        </div>
    `;
    
    openModal('broMonthSummaryModal');
}

// ê¸ˆì „ì¶œë‚© í•„í„° (ëŒ€ì‹œë³´ë“œì—ì„œ í˜¸ì¶œ)
function filterBroCashbook(type) {
    showBromotorsTab('cashbook');
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    if (type === 'today') {
        document.getElementById('b-cb-date').value = today;
        document.getElementById('b-cb-type').value = '';
    } else if (type === 'month-income') {
        document.getElementById('b-cb-date').value = thisMonthStart;
        document.getElementById('b-cb-type').value = 'income';
    } else if (type === 'month-expense') {
        document.getElementById('b-cb-date').value = thisMonthStart;
        document.getElementById('b-cb-type').value = 'expense';
    }
    loadBroCashbook();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ì¹´ë“œê²°ì œ =======================
let broPaymentHistory = [];

function togglePayerType(type) {
    if (type === 'business') {
        document.getElementById('business-info').classList.remove('hidden');
    } else {
        document.getElementById('business-info').classList.add('hidden');
    }
}

function openBroCardPayModal(workId = null) {
    // ìž‘ì—… ì˜µì…˜ ì—…ë°ì´íŠ¸
    let opts = '<option value="">ìž‘ì—… ì„ íƒ ì•ˆí•¨</option>';
    broWorkList.filter(w => w.status !== 'complete').forEach(w => {
        opts += `<option value="${w.id}" ${workId === w.id ? 'selected' : ''}>#${String(w.id).padStart(3, '0')} ${w.customer} - ${w.work} (${fmt(w.total)})</option>`;
    });
    document.getElementById('bro-pay-work').innerHTML = opts;
    
    // ìž‘ì—… ì„ íƒì‹œ ìžë™ ìž…ë ¥
    if (workId) {
        const work = broWorkList.find(w => w.id === workId);
        if (work) {
            document.getElementById('bro-pay-customer').value = work.customer;
            document.getElementById('bro-pay-amount').value = work.total;
            // ê³ ê° ì •ë³´ ì°¾ê¸°
            const cust = broCustList.find(c => c.name === work.customer);
            if (cust) {
                document.getElementById('bro-pay-phone').value = cust.phone;
            }
        }
    }
    
    openModal('broCardPayModal');
}

// ìž‘ì—… ì„ íƒì‹œ ìžë™ ìž…ë ¥
document.addEventListener('DOMContentLoaded', () => {
    const workSelect = document.getElementById('bro-pay-work');
    if (workSelect) {
        workSelect.addEventListener('change', function() {
            const workId = parseInt(this.value);
            if (workId) {
                const work = broWorkList.find(w => w.id === workId);
                if (work) {
                    document.getElementById('bro-pay-customer').value = work.customer;
                    document.getElementById('bro-pay-amount').value = work.total;
                    const cust = broCustList.find(c => c.name === work.customer);
                    if (cust) {
                        document.getElementById('bro-pay-phone').value = cust.phone;
                    }
                }
            }
        });
    }
});

function processBroCardPayment(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    // ê²°ì œ ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” PGì‚¬ ì—°ë™ í•„ìš”)
    const paymentId = 'PAY' + Date.now();
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const time = koreaTime.toTimeString().slice(0, 5);
    
    const payment = {
        id: paymentId,
        date: today,
        time: time,
        payer_type: d.payer_type,
        customer_name: d.customer_name,
        phone: d.phone,
        card_no: '****-****-****-' + d.card_no.slice(-4),
        amount: parseInt(d.amount) || 0,
        installment: parseInt(d.installment) || 0,
        work_id: d.work_id ? parseInt(d.work_id) : null,
        memo: d.memo || '',
        status: 'success',
        biz_info: d.payer_type === 'business' ? {
            biz_no: d.biz_no,
            biz_name: d.biz_name,
            biz_ceo: d.biz_ceo
        } : null
    };
    
    broPaymentHistory.unshift(payment);
    
    // ê¸ˆì „ì¶œë‚©ë¶€ì— ìˆ˜ìž… ì¶”ê°€
    broCashbookList.unshift({
        id: Math.max(...broCashbookList.map(c => c.id), 0) + 1,
        date: today,
        type: 'income',
        category: 'ì¹´ë“œê²°ì œ',
        description: `${d.customer_name} ${d.memo || 'ì¹´ë“œê²°ì œ'}`,
        amount: payment.amount
    });
    
    // ìž‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
    if (payment.work_id) {
        const work = broWorkList.find(w => w.id === payment.work_id);
        if (work) {
            work.status = 'complete';
            work.payment_id = paymentId;
        }
    }
    
    // ê²°ì œ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
    const installText = payment.installment > 0 ? `${payment.installment}ê°œì›”` : 'ì¼ì‹œë¶ˆ';
    const payerText = payment.payer_type === 'business' ? 'ì‚¬ì—…ìž/ë²•ì¸' : 'ê°œì¸';
    
    document.getElementById('bro-pay-complete-info').innerHTML = `
        <p class="text-lg">${payment.customer_name}ë‹˜</p>
        <p class="text-2xl font-black text-emerald-400">${fmt(payment.amount)}</p>
    `;
    
    document.getElementById('bro-pay-receipt').innerHTML = `
        <div class="text-center text-xs text-gray-500 mb-3">[ ê²°ì œ ì˜ìˆ˜ì¦ ]</div>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">ê²°ì œë²ˆí˜¸</span><span>${paymentId}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">ê²°ì œì¼ì‹œ</span><span>${today} ${time}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">ê²°ì œìž</span><span>${payment.customer_name} (${payerText})</span></div>
            ${payment.biz_info ? `<div class="flex justify-between"><span class="text-gray-400">ì‚¬ì—…ìžë²ˆí˜¸</span><span>${payment.biz_info.biz_no}</span></div>` : ''}
            ${payment.biz_info ? `<div class="flex justify-between"><span class="text-gray-400">ìƒí˜¸ëª…</span><span>${payment.biz_info.biz_name}</span></div>` : ''}
            <div class="flex justify-between"><span class="text-gray-400">ì¹´ë“œë²ˆí˜¸</span><span>${payment.card_no}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">í• ë¶€</span><span>${installText}</span></div>
            <div class="flex justify-between border-t border-white/10 pt-2 mt-2"><span class="text-gray-400">ê²°ì œê¸ˆì•¡</span><span class="text-emerald-400 font-bold">${fmt(payment.amount)}</span></div>
        </div>
    `;
    
    closeModal('broCardPayModal');
    e.target.reset();
    document.getElementById('business-info').classList.add('hidden');
    openModal('broPayCompleteModal');
    
    loadBroWork();
    loadBroCashbook();
    loadBroDashboard();
}

function printBroReceipt() {
    const receiptContent = document.getElementById('bro-pay-receipt').innerHTML;
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>ì˜ìˆ˜ì¦</title>
            <style>
                body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background: #fff; color: #000; }
                .receipt { max-width: 300px; margin: 0 auto; }
                .title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
                .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                .label { color: #666; }
                .total { font-weight: bold; color: #10B981; }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="title">ðŸï¸ ë¸Œë¡œëª¨í„°ìŠ¤</div>
                ${receiptContent.replace(/text-gray-400/g, 'label').replace(/text-emerald-400/g, 'total').replace(/bg-white\/10/g, '').replace(/border-white\/10/g, '')}
                <div style="text-align:center; margin-top:20px; color:#666; font-size:12px;">
                    ê°ì‚¬í•©ë‹ˆë‹¤. ì•ˆì „ìš´í–‰í•˜ì„¸ìš”!
                </div>
            </div>
            <scr` + `ipt>window.print(); window.close();</scr` + `ipt>
        </body>
        </html>
    `);
}

// ìž‘ì—… í…Œì´ë¸”ì— ê²°ì œ ë²„íŠ¼ ì¶”ê°€ë¥¼ ìœ„í•œ loadBroWork ìˆ˜ì • í•„ìš”

// ======================= ì •ì‚°ê´€ë¦¬: ìžë™ê²°ì œ(PG) =======================
const payTypeLabel = t => ({ daily: 'ì¼ì¼ê²°ì œ', weekly: 'ì£¼ì¼ê²°ì œ', monthly: 'ì›”ê²°ì œ', custom: 'ë‚ ì§œì§€ì •' }[t] || '');
const weekdayLabel = d => ['', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'][d] || '';

function filterPgPayments(status) {
    document.getElementById('pg-status').value = status;
    loadPgPayments();
}

function loadPgPayments() {
    const statusFilter = document.getElementById('pg-status').value;
    const contractFilter = document.getElementById('pg-contract-filter').value;
    const search = document.getElementById('pg-search').value.toLowerCase();
    
    let list = pgPaymentsList;
    if (statusFilter === 'active' || statusFilter === 'inactive') {
        list = list.filter(p => p.card_status === statusFilter);
    } else if (statusFilter) {
        list = list.filter(p => p.last_status === statusFilter);
    }
    if (contractFilter) list = list.filter(p => p.contract_id === parseInt(contractFilter));
    if (search) list = list.filter(p => p.customer_name.toLowerCase().includes(search));
    
    // ìš”ì•½
    document.getElementById('pg-cards').textContent = pgPaymentsList.length + 'ê±´';
    document.getElementById('pg-active').textContent = pgPaymentsList.filter(p => p.card_status === 'active').length + 'ê±´';
    document.getElementById('pg-scheduled').textContent = pgPaymentsList.filter(p => p.last_status === 'scheduled').length + 'ê±´';
    document.getElementById('pg-completed').textContent = pgPaymentsList.filter(p => p.last_status === 'success').length + 'ê±´';
    document.getElementById('pg-failed').textContent = pgPaymentsList.filter(p => p.last_status === 'failed').length + 'ê±´';
    
    // ê³„ì•½ select ì—…ë°ì´íŠ¸
    let opts = '<option value="">ê³„ì•½ ì„ íƒ</option>';
    let filterOpts = '<option value="">ì „ì²´ ê³„ì•½</option>';
    contractList.forEach(c => {
        const contractNo = '#' + String(c.id).padStart(3, '0');
        opts += `<option value="${c.id}">${contractNo} ${c.customer_name} - ${c.vehicle}</option>`;
        filterOpts += `<option value="${c.id}">${contractNo} ${c.customer_name}</option>`;
    });
    document.getElementById('pg-contract').innerHTML = opts;
    document.getElementById('pg-contract-filter').innerHTML = filterOpts;
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(p => {
        const contract = contractList.find(c => c.id === p.contract_id);
        const contractNo = '#' + String(p.contract_id).padStart(3, '0');
        const vehicle = contract ? contract.vehicle : '-';
        const contractType = contract ? (contract.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸') : '-';
        
        const cardStatusBadge = p.card_status === 'active' ? ['badge-active', 'í™œì„±'] : ['badge-failed', 'ë¹„í™œì„±'];
        
        let cycleText = '';
        if (p.pay_type === 'daily') cycleText = `ë§¤ì¼ ${p.pay_hour || 9}ì‹œ`;
        else if (p.pay_type === 'weekly') cycleText = `ë§¤ì£¼ ${weekdayLabel(p.pay_weekday)}ìš”ì¼`;
        else if (p.pay_type === 'monthly') cycleText = `ë§¤ì›” ${p.pay_day}ì¼`;
        else if (p.pay_type === 'custom') cycleText = p.pay_date || 'ë‚ ì§œì§€ì •';
        
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewPgDetail(${p.id})">
            <td class="text-lime-400 font-bold">${contractNo}</td>
            <td class="font-bold">${p.customer_name}</td>
            <td class="text-gray-400">${vehicle} <span class="text-xs text-blue-400">(${contractType})</span></td>
            <td class="text-gray-400">${p.card_no}</td>
            <td class="text-blue-400 font-bold">${fmt(p.amount)}</td>
            <td><span class="text-xs px-2 py-1 rounded bg-white/10">${cycleText}</span></td>
            <td class="text-gray-400">${p.last_pay}</td>
            <td><span class="badge ${cardStatusBadge[0]}">${cardStatusBadge[1]}</span></td>
            <td><button onclick="event.stopPropagation(); openManualPayModal(${p.id})" class="text-lime-400 text-xs hover:underline">ê²°ì œ</button></td>
        </tr>`;
    });
    document.getElementById('pg-tbody').innerHTML = h || '<tr><td colspan="9" class="text-center text-gray-500 py-6">ë“±ë¡ëœ ì¹´ë“œ ì—†ìŒ</td></tr>';
}

function togglePayOption(type) {
    document.getElementById('pg-option-daily').classList.add('hidden');
    document.getElementById('pg-option-weekly').classList.add('hidden');
    document.getElementById('pg-option-monthly').classList.add('hidden');
    document.getElementById('pg-option-custom').classList.add('hidden');
    document.getElementById('pg-option-' + type).classList.remove('hidden');
}

function openPgCardModal() {
    document.getElementById('pgForm').reset();
    document.getElementById('pg-edit-id').value = '';
    document.getElementById('pgModalTitle').textContent = 'ðŸ’³ ìžë™ê²°ì œ ì¹´ë“œ ë“±ë¡';
    document.getElementById('pgSubmitBtn').textContent = 'ë“±ë¡';
    
    // ê³„ì•½ ì˜µì…˜ ì—…ë°ì´íŠ¸
    let opts = '<option value="">ê³„ì•½ ì„ íƒ</option>';
    contractList.forEach(c => {
        const contractNo = '#' + String(c.id).padStart(3, '0');
        const contractType = c.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸';
        opts += `<option value="${c.id}" data-monthly="${c.monthly}" data-customer="${c.customer_name}" data-phone="${c.phone}">${contractNo} ${c.customer_name} - ${c.vehicle} (${contractType})</option>`;
    });
    document.getElementById('pg-contract').innerHTML = opts;
    document.querySelectorAll('input[name="pay_type"]')[2].checked = true;
    togglePayOption('monthly');
    openModal('pgModal');
}

// ê³„ì•½ ì„ íƒ ì‹œ ê¸ˆì•¡ ë° ì¹´ë“œ ì†Œìœ ìž ì •ë³´ ìžë™ ìž…ë ¥
function onPgContractChange(select) {
    const option = select.options[select.selectedIndex];
    const monthly = option.getAttribute('data-monthly');
    const customerName = option.getAttribute('data-customer');
    const phone = option.getAttribute('data-phone');
    
    if (monthly) {
        document.getElementById('pg-amount').value = monthly;
    }
    if (customerName) {
        document.getElementById('pg-card-holder').value = customerName;
    }
    if (phone) {
        document.getElementById('pg-card-phone').value = phone;
    }
}

function submitPgCard(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const contract = contractList.find(c => c.id === parseInt(d.contract_id));
    
    const newPg = {
        id: Math.max(...pgPaymentsList.map(p => p.id), 0) + 1,
        contract_id: parseInt(d.contract_id),
        customer_name: contract ? contract.customer_name : '',
        // ì¹´ë“œ ì†Œìœ ìž ì •ë³´
        card_holder: d.card_holder || '',
        birth_date: d.birth_date || '',
        card_phone: d.card_phone || '',
        card_email: d.card_email || '',
        // ì¹´ë“œ ì •ë³´ (ë§ˆìŠ¤í‚¹)
        card_no: '****-****-****-' + d.card_no.slice(-4),
        expiry: d.expiry || '',
        card_company: d.card_company || '',
        // ê²°ì œ ì„¤ì •
        pay_type: d.pay_type,
        amount: parseInt(d.amount) || 0,
        last_pay: '-',
        last_status: 'scheduled',
        card_status: d.card_status || 'active',
        created_at: new Date().toISOString().split('T')[0]
    };
    
    if (d.pay_type === 'daily') newPg.pay_hour = parseInt(d.pay_hour) || 9;
    else if (d.pay_type === 'weekly') newPg.pay_weekday = parseInt(d.pay_weekday) || 1;
    else if (d.pay_type === 'monthly') newPg.pay_day = parseInt(d.pay_day) || 1;
    else if (d.pay_type === 'custom') newPg.pay_date = d.pay_date || '';
    
    pgPaymentsList.push(newPg);
    
    showToast('âœ… ì¹´ë“œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('pgModal');
    e.target.reset();
    loadPgPayments();
}

// PG ì¹´ë“œ ìƒì„¸ë³´ê¸°
function viewPgDetail(id) {
    const p = pgPaymentsList.find(x => x.id === id);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    const contractNo = '#' + String(p.contract_id).padStart(3, '0');
    const contractType = contract ? (contract.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸') : '-';
    const cardStatusBadge = p.card_status === 'active' ? ['badge-active', 'í™œì„±'] : ['badge-failed', 'ë¹„í™œì„±'];
    
    let cycleText = '';
    if (p.pay_type === 'daily') cycleText = `ë§¤ì¼ ${p.pay_hour || 9}ì‹œ`;
    else if (p.pay_type === 'weekly') cycleText = `ë§¤ì£¼ ${weekdayLabel(p.pay_weekday)}ìš”ì¼`;
    else if (p.pay_type === 'monthly') cycleText = `ë§¤ì›” ${p.pay_day}ì¼`;
    else if (p.pay_type === 'custom') cycleText = p.pay_date;
    
    // ê²°ì œ ì´ë ¥
    const history = paymentHistory.filter(h => h.pg_id === p.id).slice(0, 5);
    let historyRows = '';
    history.forEach(h => {
        const statusBadge = h.status === 'success' ? ['badge-success', 'ì„±ê³µ'] : ['badge-failed', 'ì‹¤íŒ¨'];
        historyRows += `<tr>
            <td class="text-gray-400">${h.date}</td>
            <td class="text-blue-400">${fmt(h.amount)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td class="text-gray-500 text-xs">${h.fail_reason || '-'}</td>
        </tr>`;
    });
    
    document.getElementById('pg-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ“‹ ê³„ì•½ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³„ì•½ë²ˆí˜¸</span><span class="text-lime-400 font-bold">${contractNo}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ìœ í˜•</span><span class="text-blue-400">${contractType}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${contract ? contract.vehicle : '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20 mb-4">
            <div class="text-xs text-blue-400 mb-3">ðŸ‘¤ ì¹´ë“œ ì†Œìœ ìž ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì†Œìœ ìžëª…</span><span class="font-bold">${p.card_holder || p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ìƒë…„ì›”ì¼</span><span>${p.birth_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${p.card_phone || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì´ë©”ì¼</span><span>${p.card_email || '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-emerald-400/5 border border-emerald-400/20 mb-4">
            <div class="text-xs text-emerald-400 mb-3">ðŸ’³ ì¹´ë“œ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì¹´ë“œë²ˆí˜¸</span><span class="font-mono">${p.card_no}</span></div>
                <div class="info-row"><span class="info-label">ìœ íš¨ê¸°ê°„</span><span>${p.expiry || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì¹´ë“œì‚¬</span><span>${p.card_company || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì¹´ë“œìƒíƒœ</span><span class="badge ${cardStatusBadge[0]}">${cardStatusBadge[1]}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-gray-400 mb-3">â° ê²°ì œ ì„¤ì •</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê²°ì œê¸ˆì•¡</span><span class="text-blue-400 font-bold">${fmt(p.amount)}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œì£¼ê¸°</span><span>${cycleText}</span></div>
                <div class="info-row"><span class="info-label">ìµœê·¼ê²°ì œ</span><span>${p.last_pay}</span></div>
                <div class="info-row"><span class="info-label">ë“±ë¡ì¼</span><span>${p.created_at}</span></div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ“‹ ìµœê·¼ ê²°ì œ ì´ë ¥</div>
            <table class="data-table">
                <thead><tr><th>ì¼ìž</th><th>ê¸ˆì•¡</th><th>ê²°ê³¼</th><th>ì‚¬ìœ </th></tr></thead>
                <tbody>${historyRows || '<tr><td colspan="4" class="text-center text-gray-500 py-3">ê²°ì œ ì´ë ¥ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="toggleCardStatus(${p.id})" class="btn-secondary flex-1">${p.card_status === 'active' ? 'ðŸ”’ ë¹„í™œì„±í™”' : 'ðŸ”“ í™œì„±í™”'}</button>
            <button onclick="deletePgCard(${p.id})" class="btn-danger flex-1">ðŸ—‘ï¸ ì‚­ì œ</button>
            <button onclick="closeModal('pgDetailModal'); openManualPayModal(${p.id});" class="btn-primary flex-1">ðŸ’³ ê²°ì œ</button>
        </div>
    `;
    
    openModal('pgDetailModal');
}

// ìˆ˜ë™ ê²°ì œ ëª¨ë‹¬
function openManualPayModal(pgId) {
    const p = pgPaymentsList.find(x => x.id === pgId);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    const contractNo = '#' + String(p.contract_id).padStart(3, '0');
    
    document.getElementById('manual-pay-pg-id').value = pgId;
    document.getElementById('manual-pay-amount').value = p.amount;
    document.getElementById('manual-pay-date').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('manual-pay-info').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³„ì•½ë²ˆí˜¸</span><span class="text-lime-400 font-bold">${contractNo}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì¹´ë“œë²ˆí˜¸</span><span>${p.card_no}</span></div>
                <div class="info-row"><span class="info-label">ë¯¸ë‚©ê¸ˆ</span><span class="text-orange-400">${contract ? fmt(contract.arrears) : '-'}</span></div>
            </div>
        </div>
    `;
    
    openModal('manualPayModal');
}

// ìˆ˜ë™ ê²°ì œ ì‹¤í–‰
function executeManualPayment(e) {
    e.preventDefault();
    const pgId = parseInt(document.getElementById('manual-pay-pg-id').value);
    const amount = parseInt(document.getElementById('manual-pay-amount').value) || 0;
    const date = document.getElementById('manual-pay-date').value;
    const memo = e.target.memo ? e.target.memo.value : '';
    
    const p = pgPaymentsList.find(x => x.id === pgId);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    
    // ê²°ì œ ì²˜ë¦¬
    p.last_pay = date;
    p.last_status = 'success';
    
    // ê²°ì œ ì´ë ¥ ì¶”ê°€
    paymentHistory.unshift({
        id: Math.max(...paymentHistory.map(h => h.id), 0) + 1,
        pg_id: pgId,
        contract_id: p.contract_id,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5),
        status: 'success',
        method: 'PG'
    });
    
    // ì›ìž¥ì— ìˆ˜ë‚© ê¸°ë¡
    ledgerList.unshift({
        id: Math.max(...ledgerList.map(l => l.id), 0) + 1,
        date: date,
        contract_id: p.contract_id,
        customer_name: p.customer_name,
        type: 'receipt',
        desc: `ì¹´ë“œê²°ì œ${memo ? ' - ' + memo : ''}`,
        accrual: 0,
        receipt: amount,
        method: 'PG'
    });
    
    // ê³„ì•½ ë¯¸ë‚©ê¸ˆ ì°¨ê°
    if (contract) {
        contract.arrears = Math.max(0, contract.arrears - amount);
        if (contract.arrears === 0) {
            contract.status = 'active';
            contract.delinquent_days = 0;
        }
    }
    
    // ìµœê·¼ê²°ì œ ë‚´ì—­ì— ì¶”ê°€
    recentPayments.unshift({
        id: Math.max(...recentPayments.map(r => r.id), 0) + 1,
        customer_name: p.customer_name,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5)
    });
    
    showToast(`âœ… ${p.customer_name}ë‹˜ ${fmt(amount)} ê²°ì œ ì™„ë£Œ`);
    closeModal('manualPayModal');
    loadPgPayments();
    loadOverview();
}

// ì¹´ë“œ ìƒíƒœ í† ê¸€
function toggleCardStatus(id) {
    const p = pgPaymentsList.find(x => x.id === id);
    if (p) {
        p.card_status = p.card_status === 'active' ? 'inactive' : 'active';
        showToast(`âœ… ì¹´ë“œê°€ ${p.card_status === 'active' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤`);
        closeModal('pgDetailModal');
        loadPgPayments();
    }
}

// ì¹´ë“œ ì‚­ì œ
function deletePgCard(id) {
    if (!confirm('ì •ë§ ì´ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    pgPaymentsList = pgPaymentsList.filter(p => p.id !== id);
    showToast('âœ… ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('pgDetailModal');
    loadPgPayments();
}

// ======================= ì •ì‚°ê´€ë¦¬: ì›ìž¥ =======================
function filterLedger(type) {
    if (type === 'arrears') {
        // ë¯¸ìˆ˜ê¸ˆë§Œ í‘œì‹œ (ìž”ì•¡ì´ ë‚¨ì•„ìžˆëŠ” ê³ ê°)
        document.getElementById('ledger-type').value = '';
    } else {
        document.getElementById('ledger-type').value = type;
    }
    loadLedger();
}

function loadLedger() {
    const typeFilter = document.getElementById('ledger-type').value;
    const contractFilter = document.getElementById('ledger-contract').value;
    const startDate = document.getElementById('ledger-start').value;
    const endDate = document.getElementById('ledger-end').value;
    
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
    const today = koreaTime.toISOString().split('T')[0];
    
    // ì´ë²ˆë‹¬ ì‹œìž‘ì¼ (ìš”ì•½ ì¹´ë“œìš©)
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    // ê¸°ë³¸ê°’: ìµœê·¼ 7ì¼
    if (!startDate && !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        document.getElementById('ledger-start').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('ledger-end').value = today;
    }
    
    const filterStart = document.getElementById('ledger-start').value;
    const filterEnd = document.getElementById('ledger-end').value;
    
    // í…Œì´ë¸”ìš© í•„í„°ë§
    let list = ledgerList;
    if (typeFilter) list = list.filter(l => l.type === typeFilter);
    if (contractFilter) list = list.filter(l => l.contract_id === parseInt(contractFilter));
    if (filterStart) list = list.filter(l => l.date >= filterStart);
    if (filterEnd) list = list.filter(l => l.date <= filterEnd);
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© (contract_payments ê¸°ì¤€)
    const thisMonthPayments = contractPaymentList.filter(p => 
        p.status === 'paid' && p.payment_date >= thisMonthStart && p.payment_date <= today
    );
    const monthReceipt = thisMonthPayments.reduce((s, p) => s + (p.amount || 0), 0);
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© ë‚´ì—­ (ledger ê¸°ì¤€ - ê·¸ëž˜í”„ìš©)
    const thisMonthReceipts = ledgerList.filter(l => 
        l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today
    );
    
    // ì´ë²ˆë‹¬ ì˜ˆìƒ ìˆ˜ìµ (í™œì„± ê³„ì•½ ê¸°ì¤€)
    const activeContracts = contractList.filter(c => c.status === 'active');
    const expectedMonthly = activeContracts.reduce((s, c) => s + (c.monthly || 0), 0);
    
    // ìˆ˜ë‚©ë¥  = ì‹¤ì œìˆ˜ë‚© / ì˜ˆìƒìˆ˜ìµ (%)
    const monthRate = expectedMonthly > 0 ? Math.round((monthReceipt / expectedMonthly) * 100) : 0;
    
    // ì´ ë¯¸ìˆ˜ê¸ˆ (ê³„ì•½ ê¸°ì¤€)
    const contractsWithArrears = contractList.filter(c => (c.arrears || 0) > 0);
    const totalArrears = contractsWithArrears.reduce((s, c) => s + (c.arrears || 0), 0);
    
    document.getElementById('ledger-receipt').textContent = fmt(monthReceipt);
    document.getElementById('ledger-receipt-count').textContent = thisMonthPayments.length + 'ê±´';
    document.getElementById('ledger-arrears').textContent = fmt(totalArrears);
    document.getElementById('ledger-arrears-count').textContent = contractsWithArrears.length + 'ê±´';
    document.getElementById('ledger-rate').textContent = monthRate + '%';
    
    // ê³„ì•½ select ì—…ë°ì´íŠ¸
    let opts = '<option value="">ì „ì²´ ê³„ì•½</option>';
    contractList.forEach(c => {
        opts += `<option value="${c.id}">${c.customer_name} - ${c.vehicle}</option>`;
    });
    document.getElementById('ledger-contract').innerHTML = opts;
    if (contractFilter) document.getElementById('ledger-contract').value = contractFilter;
    
    document.getElementById('ledger-date').value = today;
    
    // í…Œì´ë¸” (ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ)
    list.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    
    let h = '', balance = 0;
    // ìž”ì•¡ ê³„ì‚°ì„ ìœ„í•´ ì „ì²´ ë°ì´í„°ë¡œ ê³„ì‚°
    ledgerList.forEach(l => {
        balance += l.accrual - l.receipt;
    });
    
    list.forEach(l => {
        const typeBadge = { accrual: ['badge-accrual', 'ë°œìƒ'], receipt: ['badge-receipt', 'ìˆ˜ë‚©'], adjust: ['badge-adjust', 'ì¡°ì •'] }[l.type] || ['', ''];
        const methodLabel = l.method ? `<span class="text-xs text-gray-500 ml-1">(${l.method})</span>` : '';
        h += `<tr>
            <td class="text-gray-400">${l.date}</td>
            <td class="font-bold">${l.customer_name}</td>
            <td><span class="badge ${typeBadge[0]}">${typeBadge[1]}</span></td>
            <td>${l.desc}${methodLabel}</td>
            <td class="${l.accrual > 0 ? 'text-orange-400' : 'text-gray-500'}">${l.accrual > 0 ? fmt(l.accrual) : '-'}</td>
            <td class="${l.receipt > 0 ? 'text-emerald-400' : 'text-gray-500'}">${l.receipt > 0 ? fmt(l.receipt) : '-'}</td>
            <td class="font-bold">${fmt(balance)}</td>
        </tr>`;
    });
    document.getElementById('ledger-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ë‚´ì—­ ì—†ìŒ</td></tr>';
    
    // ìˆ˜ë‚© ë°©ë²•ë³„ ê·¸ëž˜í”„ ì—…ë°ì´íŠ¸
    updateLedgerChart(thisMonthReceipts, monthReceipt, today.substring(0, 7).replace('-', 'ë…„ ') + 'ì›”');
}

// ìˆ˜ë‚© ë°©ë²•ë³„ ê·¸ëž˜í”„ ì—…ë°ì´íŠ¸
function updateLedgerChart(receipts, total, monthLabel) {
    document.getElementById('ledger-month-label').textContent = monthLabel;
    document.getElementById('ledger-pie-total').textContent = fmt(total);
    
    // ê²°ì œ ë°©ë²•ë³„ ì§‘ê³„
    let methodStats = { 'ì¹´ë“œ': 0, 'í˜„ê¸ˆ': 0, 'ì´ì²´': 0, 'ê¸°íƒ€': 0 };
    receipts.forEach(l => {
        const method = l.method || 'ê¸°íƒ€';
        if (method.includes('ì¹´ë“œ') || method === 'PG') methodStats['ì¹´ë“œ'] += l.receipt;
        else if (method.includes('í˜„ê¸ˆ')) methodStats['í˜„ê¸ˆ'] += l.receipt;
        else if (method.includes('ì´ì²´') || method.includes('ê³„ì¢Œ')) methodStats['ì´ì²´'] += l.receipt;
        else methodStats['ê¸°íƒ€'] += l.receipt;
    });
    
    const colors = { 'ì¹´ë“œ': '#3B82F6', 'í˜„ê¸ˆ': '#10B981', 'ì´ì²´': '#F59E0B', 'ê¸°íƒ€': '#9CA3AF' };
    const icons = { 'ì¹´ë“œ': 'ðŸ’³', 'í˜„ê¸ˆ': 'ðŸ’µ', 'ì´ì²´': 'ðŸ¦', 'ê¸°íƒ€': 'ðŸ“‹' };
    
    // ë§‰ëŒ€ ê·¸ëž˜í”„
    let barsHtml = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        if (amount > 0 || method !== 'ê¸°íƒ€') {
            const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
            barsHtml += `<div class="flex items-center gap-3">
                <span class="w-12 text-xs">${icons[method]} ${method}</span>
                <div class="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                    <div class="h-full rounded-full" style="width:${pct}%; background:${colors[method]}"></div>
                </div>
                <span class="text-xs w-20 text-right" style="color:${colors[method]}">${fmt(amount)}</span>
                <span class="text-xs text-gray-500 w-10">${pct}%</span>
            </div>`;
        }
    });
    document.getElementById('ledger-method-bars').innerHTML = barsHtml || '<div class="text-gray-500 text-sm text-center py-4">ë°ì´í„° ì—†ìŒ</div>';
    
    // ì›í˜• ê·¸ëž˜í”„ (SVG stroke-dasharray)
    const circumference = 2 * Math.PI * 16; // ì•½ 100.53
    let offset = 0;
    
    const cardPct = total > 0 ? (methodStats['ì¹´ë“œ'] / total) * 100 : 0;
    const cashPct = total > 0 ? (methodStats['í˜„ê¸ˆ'] / total) * 100 : 0;
    const transferPct = total > 0 ? (methodStats['ì´ì²´'] / total) * 100 : 0;
    
    document.getElementById('ledger-pie-card').style.strokeDasharray = `${cardPct} ${100 - cardPct}`;
    document.getElementById('ledger-pie-card').style.strokeDashoffset = -offset;
    offset += cardPct;
    
    document.getElementById('ledger-pie-cash').style.strokeDasharray = `${cashPct} ${100 - cashPct}`;
    document.getElementById('ledger-pie-cash').style.strokeDashoffset = -offset;
    offset += cashPct;
    
    document.getElementById('ledger-pie-transfer').style.strokeDasharray = `${transferPct} ${100 - transferPct}`;
    document.getElementById('ledger-pie-transfer').style.strokeDashoffset = -offset;
    
    // ë²”ë¡€
    let legendHtml = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        if (amount > 0) {
            const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
            legendHtml += `<div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background:${colors[method]}"></div>
                <span class="text-xs text-gray-400">${method}</span>
                <span class="text-xs font-bold" style="color:${colors[method]}">${pct}%</span>
            </div>`;
        }
    });
    document.getElementById('ledger-method-legend').innerHTML = legendHtml || '<div class="text-xs text-gray-500">ë°ì´í„° ì—†ìŒ</div>';
}

// ì´ë²ˆë‹¬ ìˆ˜ë‚© ìƒì„¸ ëª¨ë‹¬
function openMonthlyReceiptModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    const monthName = today.substring(0, 7).replace('-', 'ë…„ ') + 'ì›”';
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© ë‚´ì—­ (contract_payments ê¸°ì¤€)
    const thisMonthPayments = contractPaymentList.filter(p => 
        p.status === 'paid' && p.payment_date >= thisMonthStart && p.payment_date <= today
    );
    const totalReceipt = thisMonthPayments.reduce((s, p) => s + (p.amount || 0), 0);
    
    // ê³ ê°ë³„ ìˆ˜ë‚© ì§‘ê³„
    let customerStats = {};
    thisMonthPayments.forEach(p => {
        const contract = contractList.find(c => c.id === p.contract_id);
        const customerName = contract ? contract.customer_name : 'ì•Œìˆ˜ì—†ìŒ';
        
        if (!customerStats[customerName]) {
            customerStats[customerName] = { name: customerName, amount: 0, count: 0, lastDate: p.payment_date };
        }
        customerStats[customerName].amount += (p.amount || 0);
        customerStats[customerName].count++;
        if (p.payment_date > customerStats[customerName].lastDate) {
            customerStats[customerName].lastDate = p.payment_date;
        }
    });
    
    const customerList = Object.values(customerStats).sort((a, b) => b.amount - a.amount);
    
    // ê²°ì œ ìœ í˜•ë³„ ì§‘ê³„
    let methodStats = {};
    thisMonthPayments.forEach(p => {
        const method = p.payment_type || 'ê¸°íƒ€';
        methodStats[method] = (methodStats[method] || 0) + (p.amount || 0);
    });
    
    let tableRows = '';
    customerList.forEach(c => {
        tableRows += `<tr>
            <td class="font-bold">${c.name}</td>
            <td class="text-emerald-400 font-bold">${fmt(c.amount)}</td>
            <td class="text-gray-400">${c.count}ê±´</td>
            <td class="text-gray-400">${c.lastDate}</td>
        </tr>`;
    });
    
    let methodBars = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        const pct = totalReceipt > 0 ? Math.round((amount / totalReceipt) * 100) : 0;
        methodBars += `<div class="flex items-center gap-3 mb-2">
            <span class="w-20 text-xs text-gray-400">${method}</span>
            <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-400" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-emerald-400 w-16 text-right">${fmt(amount)}</span>
        </div>`;
    });
    
    document.getElementById('monthly-receipt-content').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì´ ìˆ˜ë‚©ê¸ˆì•¡</div>
                <div class="text-2xl font-black text-emerald-400">${fmt(totalReceipt)}</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">ìˆ˜ë‚© ê±´ìˆ˜</div>
                <div class="text-2xl font-black text-blue-400">${thisMonthPayments.length}ê±´</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ðŸ’³ ê²°ì œë°©ë²•ë³„</div>
            ${methodBars || '<div class="text-gray-500 text-sm text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³ ê°ëª…</th><th>ìˆ˜ë‚©ê¸ˆì•¡</th><th>ê±´ìˆ˜</th><th>ìµœê·¼ìˆ˜ë‚©</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="4" class="text-center text-gray-500 py-4">ìˆ˜ë‚© ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('monthlyReceiptModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('monthlyReceiptModal'); showSettlementTab('ledger'); document.getElementById('ledger-type').value='receipt'; loadLedger();" class="btn-primary flex-1">ì „ì²´ ë‚´ì—­ ë³´ê¸°</button>
        </div>
    `;
    
    openModal('monthlyReceiptModal');
}

// ë¯¸ìˆ˜ê¸ˆ í•„í„° (ì›ìž¥ í…Œì´ë¸”ì—ì„œ ë¯¸ìˆ˜ê¸ˆ ìžˆëŠ” ê³„ì•½ë§Œ ë³´ê¸°)
function filterLedgerUnpaid() {
    // ì—°ì²´ì¼ ìž¬ê³„ì‚° (ìµœì‹  ë°ì´í„° ë°˜ì˜)
    calculateDelinquentDays();
    
    // ë¯¸ìˆ˜ê¸ˆ ìžˆëŠ” ê³„ì•½ ëª©ë¡
    const unpaidContracts = contractList.filter(c => c.arrears > 0);
    
    if (unpaidContracts.length === 0) {
        showToast('ë¯¸ìˆ˜ê¸ˆì´ ìžˆëŠ” ê³„ì•½ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
    }
    
    let tableRows = '';
    unpaidContracts.sort((a, b) => b.arrears - a.arrears).forEach(c => {
        const customer = customerList.find(cu => cu.name === c.customer_name);
        const phoneClean = c.phone.replace(/-/g, '');
        
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewArrearsDetail(${c.id})">
            <td class="font-bold text-lime-400">#${String(c.id).padStart(3, '0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="text-red-400">${c.delinquent_days || 0}ì¼</td>
            <td>
                <div class="flex gap-2">
                    <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="text-blue-400 text-xs hover:underline">ðŸ“ž</a>
                    <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" onclick="event.stopPropagation()" class="text-emerald-400 text-xs hover:underline">ðŸ’¬</a>
                </div>
            </td>
        </tr>`;
    });
    
    const totalArrears = unpaidContracts.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('unpaid-list-content').innerHTML = `
        <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 mb-4 text-center">
            <div class="text-xs text-orange-400 mb-1">ì´ ë¯¸ìˆ˜ê¸ˆ</div>
            <div class="text-2xl font-black text-orange-400">${fmt(totalArrears)}</div>
            <div class="text-xs text-gray-500 mt-1">${unpaidContracts.length}ê±´</div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:350px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³„ì•½ë²ˆí˜¸</th><th>ê³ ê°ëª…</th><th>ì°¨ëŸ‰</th><th>ë¯¸ìˆ˜ê¸ˆ</th><th>ì—°ì²´ì¼</th><th>ì—°ë½</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('unpaidListModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('unpaidListModal'); showSettlementTab('delinquent');" class="btn-primary flex-1">ì—°ì²´ê´€ë¦¬ ì´ë™</button>
        </div>
    `;
    
    openModal('unpaidListModal');
}

// ìˆ˜ë‚©ë¥  ìƒì„¸ ëª¨ë‹¬
function openCollectionRateModal() {
    // ì—°ì²´ì¼ ìž¬ê³„ì‚° (ìµœì‹  ë°ì´í„° ë°˜ì˜)
    calculateDelinquentDays();
    
    const totalAccrual = ledgerList.reduce((s, l) => s + (l.accrual || 0), 0);
    const totalReceipt = ledgerList.reduce((s, l) => s + (l.receipt || 0), 0);
    const arrears = totalAccrual - totalReceipt;
    const rate = totalAccrual > 0 ? Math.round((totalReceipt / totalAccrual) * 100) : 0;
    
    // ê³„ì•½ë³„ ìˆ˜ë‚©ë¥  ê³„ì‚° (ì—°ì²´ì¼ í¬í•¨)
    let contractStats = [];
    contractList.forEach(c => {
        const cLedger = ledgerList.filter(l => l.contract_id === c.id);
        const cAccrual = cLedger.reduce((s, l) => s + (l.accrual || 0), 0);
        const cReceipt = cLedger.reduce((s, l) => s + (l.receipt || 0), 0);
        const cArrears = c.arrears || (cAccrual - cReceipt); // ê³„ì•½ì˜ arrears ë˜ëŠ” ê³„ì‚°ê°’
        const cRate = cAccrual > 0 ? Math.round((cReceipt / cAccrual) * 100) : 100;
        
        // ë°œìƒì•¡ì´ ìžˆê±°ë‚˜ ë¯¸ìˆ˜ê¸ˆì´ ìžˆëŠ” ê³„ì•½ë§Œ í‘œì‹œ
        if (cAccrual > 0 || cArrears > 0) {
            contractStats.push({
                id: c.id,
                name: c.customer_name,
                vehicle: c.vehicle || '-',
                accrual: cAccrual,
                receipt: cReceipt,
                arrears: cArrears,
                rate: cRate,
                delinquent_days: c.delinquent_days || 0
            });
        }
    });
    
    // ìˆ˜ë‚©ë¥  ë‚®ì€ ìˆœ ì •ë ¬
    contractStats.sort((a, b) => a.rate - b.rate);
    
    let tableRows = '';
    contractStats.forEach(s => {
        const rateColor = s.rate >= 100 ? 'text-emerald-400' : s.rate >= 80 ? 'text-blue-400' : s.rate >= 50 ? 'text-yellow-400' : 'text-red-400';
        const barWidth = Math.min(s.rate, 100);
        const daysColor = s.delinquent_days >= 60 ? 'text-red-400' : s.delinquent_days >= 30 ? 'text-orange-400' : s.delinquent_days > 0 ? 'text-yellow-400' : 'text-gray-500';
        tableRows += `<tr>
            <td class="font-bold">${s.name}</td>
            <td class="text-gray-400">${s.vehicle}</td>
            <td class="text-orange-400">${fmt(s.accrual)}</td>
            <td class="text-emerald-400">${fmt(s.receipt)}</td>
            <td class="${s.arrears > 0 ? 'text-red-400' : 'text-gray-500'}">${s.arrears > 0 ? fmt(s.arrears) : '-'}</td>
            <td class="${daysColor} font-bold">${s.delinquent_days > 0 ? s.delinquent_days + 'ì¼' : '-'}</td>
            <td>
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full ${s.rate >= 100 ? 'bg-emerald-400' : s.rate >= 80 ? 'bg-blue-400' : s.rate >= 50 ? 'bg-yellow-400' : 'bg-red-400'}" style="width:${barWidth}%"></div>
                    </div>
                    <span class="${rateColor} font-bold text-sm">${s.rate}%</span>
                </div>
            </td>
        </tr>`;
    });
    
    document.getElementById('collection-rate-content').innerHTML = `
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 text-center">
                <div class="text-xs text-orange-400 mb-1">ì´ ë°œìƒì•¡</div>
                <div class="text-xl font-black text-orange-400">${fmt(totalAccrual)}</div>
            </div>
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì´ ìˆ˜ë‚©ì•¡</div>
                <div class="text-xl font-black text-emerald-400">${fmt(totalReceipt)}</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">ë¯¸ìˆ˜ê¸ˆ</div>
                <div class="text-xl font-black text-red-400">${fmt(arrears)}</div>
            </div>
            <div class="p-4 rounded-xl bg-purple-400/10 border border-purple-400/30 text-center">
                <div class="text-xs text-purple-400 mb-1">ì „ì²´ ìˆ˜ë‚©ë¥ </div>
                <div class="text-xl font-black text-purple-400">${rate}%</div>
            </div>
        </div>
        
        <div class="text-sm text-lime-400 font-bold mb-3">ðŸ“‹ ê³„ì•½ë³„ ìˆ˜ë‚©ë¥  (ë‚®ì€ ìˆœ)</div>
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:400px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³ ê°ëª…</th><th>ì°¨ëŸ‰</th><th>ë°œìƒ</th><th>ìˆ˜ë‚©</th><th>ë¯¸ìˆ˜ê¸ˆ</th><th>ì—°ì²´ì¼</th><th>ìˆ˜ë‚©ë¥ </th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="7" class="text-center text-gray-500 py-4">ë°ì´í„° ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('collectionRateModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
        </div>
    `;
    
    openModal('collectionRateModal');
}

// ì›ìž¥ ë‚´ì—­ ë“±ë¡ ëª¨ë‹¬
function openLedgerModal() {
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    document.getElementById('ledger-date').value = koreaTime.toISOString().split('T')[0];
    
    // ê³„ì•½ ì˜µì…˜ ì—…ë°ì´íŠ¸
    let opts = '<option value="">ê³„ì•½ ì„ íƒ</option>';
    contractList.forEach(c => {
        opts += `<option value="${c.id}">${c.customer_name} - ${c.vehicle}</option>`;
    });
    document.getElementById('ledger-contract-select').innerHTML = opts;
    
    openModal('ledgerModal');
}

// ì›ìž¥ ë‚´ì—­ ë“±ë¡ ì²˜ë¦¬
async function submitLedgerEntry(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const contract = contractList.find(c => c.id === parseInt(d.contract_id));
    
    const isAccrual = d.entry_type === 'accrual';
    const isReceipt = d.entry_type === 'receipt';
    
    const ledgerData = {
        date: d.date,
        contract_id: parseInt(d.contract_id),
        customer_name: contract ? contract.customer_name : '',
        type: d.entry_type,
        description: d.desc || (isAccrual ? 'ì²­êµ¬' : isReceipt ? 'ìˆ˜ë‚©' : 'ì¡°ì •'),
        accrual: isAccrual ? parseInt(d.amount) || 0 : 0,
        receipt: isReceipt ? parseInt(d.amount) || 0 : 0,
        method: d.method
    };
    
    const result = await insertToDB('ledger', ledgerData);
    if (result && result[0]) {
        ledgerList.unshift({...result[0], desc: result[0].description});
    }
    
    // ê³„ì•½ ë¯¸ë‚©ê¸ˆ ì—…ë°ì´íŠ¸
    if (contract) {
        if (isAccrual) {
            contract.arrears += parseInt(d.amount) || 0;
        } else if (isReceipt) {
            contract.arrears = Math.max(0, contract.arrears - (parseInt(d.amount) || 0));
        }
        await updateInDB('contracts', contract.id, { arrears: contract.arrears });
    }
    
    showToast('âœ… ë‚´ì—­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('ledgerModal');
    e.target.reset();
    loadLedger();
}

// ======================= ì •ì‚°ê´€ë¦¬: ê³¼íƒœë£Œ ê´€ë¦¬ =======================
// ê³¼íƒœë£Œ ê¸°ê°„ ì„¤ì •
let finePeriodType = '1m';

function setFinePeriod(type) {
    finePeriodType = type;
    
    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    ['1m', '6m', '1y', 'all'].forEach(t => {
        const btn = document.getElementById('fine-period-' + t);
        if (btn) {
            btn.className = t === type && type !== 'custom'
                ? 'px-3 py-1 rounded-lg text-xs font-bold bg-lime-500/20 border border-lime-500 text-lime-400'
                : 'px-3 py-1 rounded-lg text-xs font-bold bg-white/5 border border-white/20 text-gray-400';
        }
    });
    
    // ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    let startDate = '';
    
    if (type === '1m') {
        const d = new Date(koreaTime);
        d.setMonth(d.getMonth() - 1);
        startDate = d.toISOString().split('T')[0];
    } else if (type === '6m') {
        const d = new Date(koreaTime);
        d.setMonth(d.getMonth() - 6);
        startDate = d.toISOString().split('T')[0];
    } else if (type === '1y') {
        const d = new Date(koreaTime);
        d.setFullYear(d.getFullYear() - 1);
        startDate = d.toISOString().split('T')[0];
    } else if (type === 'all') {
        startDate = '';
    }
    
    if (type !== 'custom') {
        document.getElementById('fine-date-start').value = startDate;
        document.getElementById('fine-date-end').value = today;
    }
    
    loadFines();
}

function initFinePeriod() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const oneMonthAgo = new Date(koreaTime);
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
    
    document.getElementById('fine-date-start').value = oneMonthAgo.toISOString().split('T')[0];
    document.getElementById('fine-date-end').value = today;
}

// ê³¼íƒœë£Œ í˜„ìž¬ ê¸ˆì•¡ ê³„ì‚° (ë‚©ë¶€ê¸°í•œ ê¸°ì¤€)
function getCurrentFineAmount(f, today) {
    const amountIn = f.amount_in_period || 0;
    const amountOut = f.amount_out_period || 0;
    const dueIn = f.due_date_in;
    
    // ê¸°ê°„ë‚´/ê¸°ê°„ì™¸ ê¸ˆì•¡ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ amount ì‚¬ìš©
    if (amountIn === 0 && amountOut === 0) {
        return f.amount || 0;
    }
    
    // ë‚©ë¶€ê¸°í•œ ê¸°ì¤€ìœ¼ë¡œ í˜„ìž¬ ê¸ˆì•¡ ê²°ì •
    if (dueIn && today <= dueIn) {
        // ê¸°ê°„ë‚´ ë‚©ë¶€ê¸°í•œ ì „ â†’ ê¸°ê°„ë‚´ ê¸ˆì•¡
        return amountIn;
    } else {
        // ê¸°ê°„ë‚´ ì§€ë‚¨ â†’ ê¸°ê°„ì™¸ ê¸ˆì•¡
        return amountOut || amountIn;
    }
}

function loadFines() {
    const search = (document.getElementById('fine-search')?.value || '').toLowerCase();
    const status = document.getElementById('fine-status')?.value || '';
    const dateStart = document.getElementById('fine-date-start')?.value || '';
    const dateEnd = document.getElementById('fine-date-end')?.value || '';
    
    // ì˜¤ëŠ˜ ë‚ ì§œ (í•œêµ­ì‹œê°„)
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // ì „ì²´ ë¯¸ë‚©ê¸ˆ (ê¸°ê°„ ë¬´ê´€) - ë‚©ë¶€ê¸°í•œ ê¸°ì¤€ í˜„ìž¬ ê¸ˆì•¡ìœ¼ë¡œ ê³„ì‚°
    const allUnpaidFines = fineList.filter(f => f.status === 'unpaid');
    const totalUnpaidAmount = allUnpaidFines.reduce((s, f) => s + getCurrentFineAmount(f, today), 0);
    
    // ìš”ì†Œê°€ ìžˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
    const totalUnpaidEl = document.getElementById('fine-total-unpaid');
    const totalUnpaidCountEl = document.getElementById('fine-total-unpaid-count');
    if (totalUnpaidEl) totalUnpaidEl.textContent = fmt(totalUnpaidAmount);
    if (totalUnpaidCountEl) totalUnpaidCountEl.textContent = allUnpaidFines.length + 'ê±´';
    
    console.log('ê³¼íƒœë£Œ ë¡œë“œ:', fineList.length + 'ê±´, ë¯¸ë‚©:', allUnpaidFines.length + 'ê±´, ì´ì•¡:', totalUnpaidAmount);
    
    // ê¸°ê°„ í•„í„° ì ìš©
    let periodList = [...fineList];
    if (dateStart) periodList = periodList.filter(f => f.fine_date >= dateStart);
    if (dateEnd) periodList = periodList.filter(f => f.fine_date <= dateEnd);
    
    // ê¸°ê°„ ë‚´ í†µê³„ - ë‚©ë¶€ê¸°í•œ ê¸°ì¤€ í˜„ìž¬ ê¸ˆì•¡
    const periodUnpaid = periodList.filter(f => f.status === 'unpaid');
    const periodPaid = periodList.filter(f => f.status === 'paid');
    const periodUnpaidAmount = periodUnpaid.reduce((s, f) => s + getCurrentFineAmount(f, today), 0);
    const periodPaidAmount = periodPaid.reduce((s, f) => s + (f.amount || 0), 0);
    
    const periodCountEl = document.getElementById('fine-period-count');
    const periodUnpaidEl = document.getElementById('fine-period-unpaid');
    const periodPaidEl = document.getElementById('fine-period-paid');
    const periodTotalEl = document.getElementById('fine-period-total');
    
    if (periodCountEl) periodCountEl.textContent = periodList.length + 'ê±´';
    if (periodUnpaidEl) periodUnpaidEl.textContent = fmt(periodUnpaidAmount);
    if (periodPaidEl) periodPaidEl.textContent = fmt(periodPaidAmount);
    if (periodTotalEl) periodTotalEl.textContent = fmt(periodUnpaidAmount + periodPaidAmount);
    
    // ê²€ìƒ‰/ìƒíƒœ í•„í„° ì ìš©
    let list = [...periodList];
    if (status === 'unpaid') list = list.filter(f => f.status === 'unpaid');
    else if (status === 'paid') list = list.filter(f => f.status === 'paid');
    if (search) list = list.filter(f => 
        (f.customer_name || '').toLowerCase().includes(search) || 
        (f.plate || '').toLowerCase().includes(search) ||
        (f.reason || '').toLowerCase().includes(search)
    );
    
    // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
    list.sort((a, b) => (b.fine_date || '').localeCompare(a.fine_date || ''));
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(f => {
        const statusBadge = f.status === 'paid' ? ['badge-complete', 'ë‚©ë¶€ì™„ë£Œ'] : ['badge-failed', 'ë¯¸ë‚©'];
        const contract = contractList.find(c => c.id === f.contract_id);
        const currentAmount = getCurrentFineAmount(f, today);
        const isOverdue = f.due_date_in && today > f.due_date_in;
        
        h += `<tr onclick="viewFineDetail(${f.id})" class="cursor-pointer hover:bg-white/5">
            <td class="text-red-400">#F${String(f.id).padStart(3,'0')}</td>
            <td>${f.fine_date || '-'}</td>
            <td class="text-lime-400">${contract ? '#' + String(contract.id).padStart(3,'0') : '-'}</td>
            <td class="font-bold">${f.customer_name || '-'}</td>
            <td class="font-mono">${f.plate || '-'}</td>
            <td class="text-gray-400">${f.reason || '-'}</td>
            <td class="font-bold ${isOverdue ? 'text-orange-400' : 'text-red-400'}">${fmt(currentAmount)}${isOverdue ? ' â°' : ''}</td>
            <td>${f.receipt_url ? '<span class="text-cyan-400">ðŸ§¾</span>' : '<span class="text-gray-600">-</span>'}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    document.getElementById('fine-tbody').innerHTML = h || '<tr><td colspan="9" class="text-center text-gray-500 py-6">ê³¼íƒœë£Œ ì—†ìŒ</td></tr>';
}

function viewFineDetail(id) {
    const f = fineList.find(x => x.id === id);
    if (!f) return;
    
    const contract = contractList.find(c => c.id === f.contract_id);
    const statusBadge = f.status === 'paid' ? ['badge-complete', 'ë‚©ë¶€ì™„ë£Œ'] : ['badge-failed', 'ë¯¸ë‚©'];
    const phoneClean = (contract?.phone || '').replace(/-/g, '');
    
    document.getElementById('fine-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³¼íƒœë£Œë²ˆí˜¸</span><span class="text-red-400 font-bold">#F${String(f.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ë°œìƒì¼</span><span>${f.fine_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê¸ˆì•¡</span><span class="font-bold text-red-400">${fmt(f.amount)}</span></div>
                <div class="info-row col-span-2"><span class="info-label">ì‚¬ìœ </span><span>${f.reason || '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-blue-400/10 border border-blue-400/30 mb-4">
            <div class="text-xs text-blue-400 mb-2">ðŸ“‹ ì—°ê²° ê³„ì•½</div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-400 text-xs">ê³„ì•½ë²ˆí˜¸:</span> <span class="text-lime-400 font-bold">${contract ? '#' + String(contract.id).padStart(3,'0') : '-'}</span></div>
                <div><span class="text-gray-400 text-xs">ê³ ê°ëª…:</span> <span class="font-bold">${f.customer_name || '-'}</span></div>
                <div><span class="text-gray-400 text-xs">ì°¨ëŸ‰ë²ˆí˜¸:</span> <span class="font-mono">${f.plate || '-'}</span></div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-xs">ì—°ë½ì²˜:</span> 
                    <span>${contract?.phone || '-'}</span>
                    ${phoneClean ? `<a href="tel:${phoneClean}" class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs">ðŸ“ž</a>` : ''}
                </div>
            </div>
        </div>
        
        ${f.status === 'paid' ? `
        <div class="p-4 rounded-lg bg-emerald-400/10 border border-emerald-400/30 mb-4">
            <div class="text-xs text-emerald-400 mb-2">âœ… ë‚©ë¶€ ì •ë³´</div>
            <div><span class="text-gray-400 text-xs">ë‚©ë¶€ì¼:</span> <span class="font-bold">${f.paid_date || '-'}</span></div>
        </div>` : ''}
        
        ${f.receipt_url ? `
        <div class="p-4 rounded-lg bg-cyan-400/10 border border-cyan-400/30 mb-4">
            <div class="text-xs text-cyan-400 mb-2">ðŸ§¾ ì˜ìˆ˜ì¦</div>
            <a href="${f.receipt_url}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 rounded bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30">
                ðŸ“¥ ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ
            </a>
        </div>` : ''}
        
        ${f.memo ? `<div class="p-3 rounded-lg bg-white/5 text-sm text-gray-400 mb-4">ðŸ“ ${f.memo}</div>` : ''}
        
        <div class="flex gap-3">
            <button onclick="deleteFine(${f.id}); closeModal('fineDetailModal');" class="btn-danger flex-1">ì‚­ì œ</button>
            ${f.status === 'unpaid' ? `<button onclick="payFine(${f.id}); closeModal('fineDetailModal');" class="btn-secondary flex-1">ë‚©ë¶€ì²˜ë¦¬</button>` : ''}
            <button onclick="closeModal('fineDetailModal'); editFine(${f.id});" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('fineDetailModal');
}

function openFineModal() {
    document.getElementById('fineModalTitle').textContent = 'ðŸš¨ ê³¼íƒœë£Œ ë“±ë¡';
    document.getElementById('fineSubmitBtn').textContent = 'ë“±ë¡';
    document.getElementById('fine-edit-id').value = '';
    document.getElementById('fineForm').reset();
    document.getElementById('fine-contract-info').classList.add('hidden');
    document.getElementById('fine-receipt-preview').innerHTML = '';
    document.getElementById('fine-total-display').textContent = 'â‚©0';
    
    // ì˜¤ëŠ˜ ë‚ ì§œ
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    document.getElementById('fine-date').value = today;
    
    // ê¸°ë³¸ ë‚©ë¶€ê¸°í•œ (7ì¼ í›„, 14ì¼ í›„)
    const sevenDaysLater = new Date(koreaTime.getTime() + (7 * 24 * 60 * 60 * 1000));
    const fourteenDaysLater = new Date(koreaTime.getTime() + (14 * 24 * 60 * 60 * 1000));
    document.getElementById('fine-due-in').value = sevenDaysLater.toISOString().split('T')[0];
    document.getElementById('fine-due-out').value = fourteenDaysLater.toISOString().split('T')[0];
    
    // ì´ˆê¸° ê¸ˆì•¡ ê³„ì‚°
    calcFineTotals();
    
    // ê³„ì•½ ëª©ë¡ ë¡œë“œ
    loadFineContractOptions();
    
    openModal('fineModal');
}

// ê³¼íƒœë£Œ í˜„ìž¬ ë‚©ë¶€ê¸ˆì•¡ ê³„ì‚° (ë‚ ì§œ ê¸°ì¤€)
function calcFineTotals() {
    const amountIn = parseInt(document.getElementById('fine-amount-in').value) || 0;
    const amountOut = parseInt(document.getElementById('fine-amount-out').value) || 0;
    const dueIn = document.getElementById('fine-due-in').value;
    const dueOut = document.getElementById('fine-due-out').value;
    
    // ì˜¤ëŠ˜ ë‚ ì§œ (í•œêµ­ì‹œê°„)
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let currentAmount = 0;
    let statusText = '';
    
    if (dueIn && today <= dueIn) {
        // ê¸°ê°„ë‚´ ë‚©ë¶€ê¸°í•œ ì „ â†’ ê¸°ê°„ë‚´ ê¸ˆì•¡
        currentAmount = amountIn;
        statusText = `ê¸°ê°„ë‚´ (${dueIn}ê¹Œì§€)`;
    } else if (dueOut && today <= dueOut) {
        // ê¸°ê°„ë‚´ ì§€ë‚¨, ê¸°ê°„ì™¸ ë‚©ë¶€ê¸°í•œ ì „ â†’ ê¸°ê°„ì™¸ ê¸ˆì•¡
        currentAmount = amountOut;
        statusText = `ê¸°ê°„ì™¸ (${dueOut}ê¹Œì§€)`;
    } else if (amountOut > 0) {
        // ê¸°ê°„ì™¸ë„ ì§€ë‚¨ â†’ ê¸°ê°„ì™¸ ê¸ˆì•¡ (ì—°ì²´)
        currentAmount = amountOut;
        statusText = 'âš ï¸ ë‚©ë¶€ê¸°í•œ ì´ˆê³¼';
    } else {
        // ê¸°ê°„ì™¸ ê¸ˆì•¡ ì—†ìœ¼ë©´ ê¸°ê°„ë‚´ ê¸ˆì•¡
        currentAmount = amountIn;
        statusText = 'ë‚©ë¶€ê¸°í•œ í™•ì¸ í•„ìš”';
    }
    
    document.getElementById('fine-total-display').textContent = fmt(currentAmount);
    document.getElementById('fine-due-status').textContent = statusText;
}

function viewFineDetail(id) {
    const f = fineList.find(x => x.id === id);
    if (!f) return;
    
    const contract = contractList.find(c => c.id === f.contract_id);
    const statusBadge = f.status === 'paid' ? ['badge-complete', 'ë‚©ë¶€ì™„ë£Œ'] : ['badge-failed', 'ë¯¸ë‚©'];
    
    document.getElementById('fine-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³¼íƒœë£Œ ë²ˆí˜¸</span><span class="text-red-400 font-bold">#F${String(f.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ë°œìƒì¼</span><span>${f.fine_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê¸ˆì•¡</span><span class="text-red-400 font-bold">${fmt(f.amount)}</span></div>
                <div class="info-row col-span-2"><span class="info-label">ì‚¬ìœ </span><span>${f.reason || '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-blue-400/10 border border-blue-400/30 mb-4">
            <div class="text-xs text-blue-400 mb-2">ðŸ“‹ ì—°ê²° ê³„ì•½</div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-400 text-xs">ê³„ì•½ë²ˆí˜¸:</span> <span class="text-lime-400 font-bold">${contract ? '#' + String(contract.id).padStart(3,'0') : '-'}</span></div>
                <div><span class="text-gray-400 text-xs">ê³ ê°:</span> <span class="font-bold">${f.customer_name || '-'}</span></div>
                <div><span class="text-gray-400 text-xs">ì°¨ëŸ‰ë²ˆí˜¸:</span> <span>${f.plate || '-'}</span></div>
                <div><span class="text-gray-400 text-xs">ì—°ë½ì²˜:</span> <span>${contract?.phone || '-'}</span></div>
            </div>
        </div>
        
        ${f.status === 'paid' ? `
        <div class="p-4 rounded-lg bg-emerald-400/10 border border-emerald-400/30 mb-4">
            <div class="text-xs text-emerald-400 mb-2">âœ… ë‚©ë¶€ ì •ë³´</div>
            <div><span class="text-gray-400 text-xs">ë‚©ë¶€ì¼:</span> <span class="font-bold">${f.paid_date || '-'}</span></div>
        </div>` : ''}
        
        ${f.receipt_url ? `
        <div class="p-4 rounded-lg bg-cyan-400/10 border border-cyan-400/30 mb-4">
            <div class="text-xs text-cyan-400 mb-2">ðŸ§¾ ì˜ìˆ˜ì¦</div>
            <a href="${f.receipt_url}" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 rounded bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30">
                ðŸ“¥ ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ
            </a>
        </div>` : ''}
        
        ${f.memo ? `<div class="p-3 rounded-lg bg-white/5 text-sm text-gray-400 mb-4">ðŸ“ ${f.memo}</div>` : ''}
        
        <div class="flex gap-3">
            <button onclick="deleteFine(${f.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            ${f.status === 'unpaid' ? `<button onclick="closeModal('fineDetailModal'); payFine(${f.id})" class="btn-secondary flex-1">ë‚©ë¶€ì²˜ë¦¬</button>` : ''}
            <button onclick="closeModal('fineDetailModal'); editFine(${f.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('fineDetailModal');
}

// ê³„ì•½ ìƒì„¸ì—ì„œ ê³¼íƒœë£Œ ë“±ë¡
function openFineModalForContract(contractId) {
    openFineModal();
    document.getElementById('fine-contract-id').value = contractId;
    onFineContractChange();
}

function loadFineContractOptions() {
    const select = document.getElementById('fine-contract-id');
    select.innerHTML = '<option value="">ê³„ì•½ ì„ íƒ...</option>';
    
    // ì§„í–‰ì¤‘ì¸ ê³„ì•½ë§Œ
    const activeContracts = contractList.filter(c => c.status === 'active');
    activeContracts.forEach(c => {
        const typeLabel = (c.type || 'rent') === 'rent' ? 'ë ŒíŠ¸' : 'ë¦¬ìŠ¤';
        select.innerHTML += `<option value="${c.id}">[${typeLabel}] ${c.customer_name} - ${c.plate}</option>`;
    });
}

function onFineContractChange() {
    const contractId = document.getElementById('fine-contract-id').value;
    const infoBox = document.getElementById('fine-contract-info');
    
    if (!contractId) {
        infoBox.classList.add('hidden');
        return;
    }
    
    const contract = contractList.find(c => c.id === parseInt(contractId));
    if (contract) {
        infoBox.classList.remove('hidden');
        infoBox.innerHTML = `
            <div class="text-xs text-gray-400">ê³ ê°: <span class="text-white font-bold">${contract.customer_name}</span></div>
            <div class="text-xs text-gray-400">ì°¨ëŸ‰: <span class="text-white">${contract.vehicle}</span> Â· <span class="text-lime-400">${contract.plate}</span></div>
            <div class="text-xs text-gray-400">ì—°ë½ì²˜: <span class="text-white">${contract.phone}</span></div>
        `;
    }
}

async function submitFine(e) {
    e.preventDefault();
    showToast('ì €ìž¥ ì¤‘...', 'info');
    
    const editId = document.getElementById('fine-edit-id').value;
    const contractId = document.getElementById('fine-contract-id').value;
    
    if (!contractId) {
        showToast('ê³„ì•½ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
        return;
    }
    
    const contract = contractList.find(c => c.id === parseInt(contractId));
    
    // ê¸ˆì•¡ ê³„ì‚°
    const amountIn = parseInt(document.getElementById('fine-amount-in').value) || 0;
    const amountOut = parseInt(document.getElementById('fine-amount-out').value) || 0;
    const dueIn = document.getElementById('fine-due-in').value;
    const dueOut = document.getElementById('fine-due-out').value;
    
    if (amountIn <= 0 && amountOut <= 0) {
        showToast('ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    // í˜„ìž¬ ë‚©ë¶€ê¸ˆì•¡ ê³„ì‚° (ë‚ ì§œ ê¸°ì¤€)
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let currentAmount = amountIn; // ê¸°ë³¸ê°’
    if (dueIn && today <= dueIn) {
        currentAmount = amountIn;
    } else if (amountOut > 0) {
        currentAmount = amountOut;
    }
    
    // ì˜ìˆ˜ì¦ íŒŒì¼ ì—…ë¡œë“œ
    const receiptFile = document.getElementById('fine-receipt').files[0];
    let receiptUrl = null;
    
    if (receiptFile) {
        receiptUrl = await uploadFile(receiptFile, 'fine_receipts');
    }
    
    // ê¸°ì¡´ ì˜ìˆ˜ì¦ URL ìœ ì§€ (ìˆ˜ì • ì‹œ ìƒˆ íŒŒì¼ ì—†ìœ¼ë©´)
    const existingFine = editId ? fineList.find(f => f.id === parseInt(editId)) : null;
    
    const fineData = {
        contract_id: parseInt(contractId),
        customer_name: contract ? contract.customer_name : '',
        plate: contract ? contract.plate : '',
        fine_date: document.getElementById('fine-date').value,
        amount: currentAmount,
        amount_in_period: amountIn,
        amount_out_period: amountOut,
        due_date_in: dueIn || null,
        due_date_out: dueOut || null,
        reason: document.getElementById('fine-reason').value,
        status: document.getElementById('fine-paid-status').value,
        paid_date: document.getElementById('fine-paid-date').value || null,
        memo: document.getElementById('fine-memo').value || null,
        receipt_url: receiptUrl || (existingFine ? existingFine.receipt_url : null)
    };
    
    if (editId) {
        await updateInDB('fines', editId, fineData);
        const f = fineList.find(x => x.id === parseInt(editId));
        if (f) Object.assign(f, fineData);
        showToast('âœ… ê³¼íƒœë£Œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        const result = await insertToDB('fines', fineData);
        if (result && result[0]) fineList.unshift(result[0]);
        showToast('âœ… ê³¼íƒœë£Œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('fineModal');
    loadFines();
}

function editFine(id) {
    const f = fineList.find(x => x.id === id);
    if (!f) return;
    
    document.getElementById('fineModalTitle').textContent = 'ðŸš¨ ê³¼íƒœë£Œ ìˆ˜ì •';
    document.getElementById('fineSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('fine-edit-id').value = f.id;
    
    loadFineContractOptions();
    document.getElementById('fine-contract-id').value = f.contract_id || '';
    onFineContractChange();
    
    document.getElementById('fine-date').value = f.fine_date || '';
    document.getElementById('fine-reason').value = f.reason || '';
    document.getElementById('fine-amount-in').value = f.amount_in_period || 0;
    document.getElementById('fine-amount-out').value = f.amount_out_period || 0;
    document.getElementById('fine-due-in').value = f.due_date_in || '';
    document.getElementById('fine-due-out').value = f.due_date_out || '';
    document.getElementById('fine-paid-status').value = f.status || 'unpaid';
    document.getElementById('fine-paid-date').value = f.paid_date || '';
    document.getElementById('fine-memo').value = f.memo || '';
    
    // í•©ê³„ ê³„ì‚°
    calcFineTotals();
    
    // ê¸°ì¡´ ì˜ìˆ˜ì¦ í‘œì‹œ
    const previewEl = document.getElementById('fine-receipt-preview');
    if (f.receipt_url) {
        previewEl.innerHTML = `<div class="flex items-center gap-2 p-2 rounded bg-white/5">
            <span class="text-cyan-400">âœ… ì˜ìˆ˜ì¦ ì²¨ë¶€ë¨</span>
            <a href="${f.receipt_url}" target="_blank" class="text-blue-400 hover:underline">ðŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
            <span class="text-gray-500 text-xs">(ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ êµì²´ë¨)</span>
        </div>`;
    } else {
        previewEl.innerHTML = '';
    }
    
    openModal('fineModal');
}

async function deleteFine(id) {
    if (!confirm('ê³¼íƒœë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await deleteFromDB('fines', id);
    fineList = fineList.filter(f => f.id !== id);
    showToast('ðŸ—‘ï¸ ê³¼íƒœë£Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('fineDetailModal');
    loadFines();
}

async function payFine(id) {
    if (!confirm('ë‚©ë¶€ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    await updateInDB('fines', id, { status: 'paid', paid_date: today });
    const f = fineList.find(x => x.id === id);
    if (f) {
        f.status = 'paid';
        f.paid_date = today;
    }
    showToast('âœ… ë‚©ë¶€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    loadFines();
}

// ======================= ì •ì‚°ê´€ë¦¬: ì—°ì²´ê´€ë¦¬ =======================
function filterDelinquent(period) {
    document.getElementById('del-period').value = period;
    loadDelinquent();
}

function loadDelinquent() {
    // ì—°ì²´ì¼ ìž¬ê³„ì‚°
    calculateDelinquentDays();
    
    const periodFilter = document.getElementById('del-period').value;
    const sortBy = document.getElementById('del-sort').value;
    const search = document.getElementById('del-search').value.toLowerCase();
    
    let list = contractList.filter(c => c.arrears > 0);
    
    if (periodFilter === '30') list = list.filter(c => (c.delinquent_days || 0) < 30);
    else if (periodFilter === '60') list = list.filter(c => (c.delinquent_days || 0) >= 30 && (c.delinquent_days || 0) < 60);
    else if (periodFilter === '90') list = list.filter(c => (c.delinquent_days || 0) >= 60);
    
    if (search) list = list.filter(c => 
        c.customer_name.toLowerCase().includes(search) || 
        c.vehicle.toLowerCase().includes(search) ||
        c.plate.toLowerCase().includes(search)
    );
    
    // ì •ë ¬
    if (sortBy === 'amount') list.sort((a, b) => b.arrears - a.arrears);
    else if (sortBy === 'days') list.sort((a, b) => (b.delinquent_days || 0) - (a.delinquent_days || 0));
    else if (sortBy === 'name') list.sort((a, b) => a.customer_name.localeCompare(b.customer_name));
    
    // ìš”ì•½
    const allDel = contractList.filter(c => c.arrears > 0);
    document.getElementById('del-count').textContent = allDel.length + 'ê±´';
    document.getElementById('del-total').textContent = fmt(allDel.reduce((s, c) => s + c.arrears, 0));
    document.getElementById('del-30').textContent = allDel.filter(c => (c.delinquent_days || 0) < 30).length + 'ê±´';
    document.getElementById('del-60').textContent = allDel.filter(c => (c.delinquent_days || 0) >= 60).length + 'ê±´';
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(c => {
        const days = c.delinquent_days || 0;
        const severity = days >= 60 ? 'text-red-500' : days >= 30 ? 'text-orange-400' : 'text-yellow-400';
        const phoneClean = c.phone.replace(/-/g, '');
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewArrearsDetail(${c.id})">
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="${severity} font-bold">${days}ì¼</td>
            <td class="text-gray-400">-</td>
            <td><span class="badge badge-delinquent">ì—°ì²´</span></td>
            <td>
                <div class="flex gap-2">
                    <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="text-blue-400 text-xs hover:underline">ðŸ“ž</a>
                    <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" onclick="event.stopPropagation()" class="text-emerald-400 text-xs hover:underline">ðŸ’¬</a>
                    <button onclick="event.stopPropagation(); openDelAction(${c.id})" class="text-lime-400 text-xs hover:underline">ê´€ë¦¬</button>
                </div>
            </td>
        </tr>`;
    });
    document.getElementById('del-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">ì—°ì²´ ê³„ì•½ ì—†ìŒ</td></tr>';
}

function openDelAction(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    // ì „í™”ë²ˆí˜¸ì—ì„œ í•˜ì´í”ˆ ì œê±°
    const phoneClean = c.phone.replace(/-/g, '');
    
    document.getElementById('del-action-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì²´ê¸ˆì•¡</span><span class="text-orange-400 font-bold">${fmt(c.arrears)}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì²´ì¼ìˆ˜</span><span class="text-red-400 font-bold">${c.delinquent_days || 0}ì¼</span></div>
            </div>
        </div>
        
        <div class="space-y-3 mb-4">
            <a href="tel:${phoneClean}" class="block w-full p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-left hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ðŸ“ž ì „í™” ê±¸ê¸°</div>
                <div class="text-xs text-gray-400">${c.phone}ë¡œ ë°”ë¡œ ì „í™” ì—°ê²°</div>
            </a>
            <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" class="block w-full p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-left hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ðŸ’¬ ë¬¸ìž ë³´ë‚´ê¸°</div>
                <div class="text-xs text-gray-400">ë…ì´‰ ë¬¸ìž ë°”ë¡œ ë°œì†¡</div>
            </a>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('delActionModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="viewArrearsDetail(${c.id}); closeModal('delActionModal');" class="btn-primary flex-1">ë¯¸ìˆ˜ê¸ˆ ìƒì„¸</button>
        </div>
    `;
    openModal('delActionModal');
}

function exportDelinquent() {
    downloadExcel('delinquent');
}

// ======================= ë’¤ë¡œê°€ê¸° ì²˜ë¦¬ =======================
window.addEventListener('popstate', (e) => {
    // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœë©´ ë¬´ì‹œ
    if (!currentUser) return;
    
    // ì—´ë¦° ëª¨ë‹¬ ìžˆìœ¼ë©´ ë‹«ê¸°
    const openModals = document.querySelectorAll('.modal-overlay:not(.hidden)');
    if (openModals.length > 0) {
        openModals.forEach(m => m.classList.add('hidden'));
        // ëª¨ë‹¬ ë‹«ì„ ë•ŒëŠ” ížˆìŠ¤í† ë¦¬ ì¶”ê°€í•´ì„œ ë‹¤ì‹œ ë’¤ë¡œê°€ê¸° ê°€ëŠ¥í•˜ê²Œ
        history.pushState({ system: currentSystem, tab: currentTab }, '', `#${currentSystem === 'settlement' ? 's' : 'b'}-${currentTab}`);
        return;
    }
    
    // stateê°€ ìžˆìœ¼ë©´ í•´ë‹¹ íƒ­ìœ¼ë¡œ ì´ë™
    if (e.state && e.state.system && e.state.tab) {
        if (e.state.system === 'settlement') {
            if (currentSystem !== 'settlement') {
                document.getElementById('bromotorsSystem').classList.add('hidden');
                document.getElementById('settlementSystem').classList.remove('hidden');
                currentSystem = 'settlement';
            }
            showSettlementTab(e.state.tab, true);
        } else if (e.state.system === 'bromotors') {
            if (currentSystem !== 'bromotors') {
                document.getElementById('settlementSystem').classList.add('hidden');
                document.getElementById('bromotorsSystem').classList.remove('hidden');
                currentSystem = 'bromotors';
            }
            showBromotorsTab(e.state.tab, true);
        }
    }
});

// URL í•´ì‹œë¡œ íƒ­ ë³µì›
function restoreFromHash() {
    const hash = window.location.hash;
    if (hash.startsWith('#s-')) {
        const tab = hash.substring(3);
        if (currentSystem === 'settlement') {
            showSettlementTab(tab, true);
        }
    } else if (hash.startsWith('#b-')) {
        const tab = hash.substring(3);
        if (currentSystem === 'bromotors') {
            showBromotorsTab(tab, true);
        }
    }
}

// ======================= ì„¸ì…˜ ë³µì› =======================
async function restoreSession() {
    console.log('ðŸ”„ ì„¸ì…˜ ë³µì› ì‹œë„...');
    const sessionData = sessionStorage.getItem('teambro_session');
    
    if (!sessionData) {
        console.log('âŒ ì €ìž¥ëœ ì„¸ì…˜ ì—†ìŒ');
        return false;
    }
    
    try {
        const session = JSON.parse(sessionData);
        console.log('ðŸ“‹ ì„¸ì…˜ ë°ì´í„°:', session);
        
        // ì„¸ì…˜ ë§Œë£Œ ì²´í¬ (24ì‹œê°„)
        const sessionAge = Date.now() - session.timestamp;
        if (sessionAge > 24 * 60 * 60 * 1000) {
            console.log('âŒ ì„¸ì…˜ ë§Œë£Œ (24ì‹œê°„ ì´ˆê³¼)');
            sessionStorage.removeItem('teambro_session');
            return false;
        }
        
        // ì‚¬ìš©ìž ì •ë³´ ë¡œë“œ
        console.log('ðŸ‘¤ ì‚¬ìš©ìž ì •ë³´ ë¡œë“œ ì¤‘...', session.userId);
        const users = await supabaseCall('staff', 'GET', null, `?id=eq.${session.userId}`);
        
        if (!users || users.length === 0) {
            console.log('âŒ ì‚¬ìš©ìž ì •ë³´ ì—†ìŒ');
            sessionStorage.removeItem('teambro_session');
            return false;
        }
        
        const user = users[0];
        console.log('âœ… ì‚¬ìš©ìž ì°¾ìŒ:', user.name);
        
        // ë¹„í™œì„± ì‚¬ìš©ìž ì²´í¬
        if (user.status !== 'active') {
            console.log('âŒ ë¹„í™œì„± ì‚¬ìš©ìž');
            sessionStorage.removeItem('teambro_session');
            return false;
        }
        
        currentUser = user;
        currentSystem = session.system;
        const savedTab = session.tab || 'overview';
        
        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        await loadAllData();
        
        document.getElementById('loginPage').classList.add('hidden');
        
        // ì‹œìŠ¤í…œ í‘œì‹œ ë° ì €ìž¥ëœ íƒ­ìœ¼ë¡œ ì´ë™
        if (currentSystem === 'settlement') {
            document.getElementById('settlementSystem').classList.remove('hidden');
            document.getElementById('s-userName').textContent = user.name;
            document.getElementById('s-userRole').textContent = roleBadge(user.role)[1];
            renderStaffList();
            initDates();
            loadSettlementDashboard(); // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            showSettlementTab(savedTab, true);
        } else {
            document.getElementById('bromotorsSystem').classList.remove('hidden');
            document.getElementById('b-userName').textContent = user.name;
            document.getElementById('b-userRole').textContent = roleBadge(user.role)[1];
            initDates();
            loadBroDashboard(); // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            showBromotorsTab(savedTab, true);
        }
        
        // ì„¸ì…˜ íƒ€ìž„ìŠ¤íƒ¬í”„ ê°±ì‹ 
        session.timestamp = Date.now();
        sessionStorage.setItem('teambro_session', JSON.stringify(session));
        
        showToast(`${user.name}ë‹˜, ë‹¤ì‹œ ì˜¤ì…¨êµ°ìš”!`);
        return true;
    } catch (e) {
        console.error('ì„¸ì…˜ ë³µì› ì‹¤íŒ¨:', e);
        sessionStorage.removeItem('teambro_session');
        return false;
    }
}

// íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ë³µì› ì‹œë„
document.addEventListener('DOMContentLoaded', async () => {
    const restored = await restoreSession();
    
    // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
    document.getElementById('loadingScreen').classList.add('hidden');
    
    // ì„¸ì…˜ ë³µì› ì•ˆ ëìœ¼ë©´ ë¡œê·¸ì¸ íŽ˜ì´ì§€ í‘œì‹œ
    if (!restored) {
        document.getElementById('loginPage').classList.remove('hidden');
    }
});
</script>
</body>
</html>

<!-- 위루트 PG 연동 스크립트 추가 -->
<script>
// ======================= 위루트 파이낸셜 PG 연동 =======================
// 위루트 API 설정
const WEROUTE_CONFIG = {
    MID: 'M470717',
    TID: '4025090156',
    PAY_KEY: '15554qAwtcZ46rvYVAWlppg9azslGzcFfCexkRP8g5OrKmmgPgXKiqU9QvY6jWqd'
};

// 빌링 결제 내역 (DB 연동)
let billingPaymentHistory = [];

// 배치 결제 실행 (미납자 일괄 / 정기결제)
async function runBatchPayment(target) {
    const targetLabel = target === 'arrears' ? '미납자 일괄결제' : '정기결제';
    
    if (!confirm(targetLabel + '를 실행하시겠습니까?\n\n활성화된 빌링키가 있는 계약에 대해 자동 결제가 진행됩니다.')) {
        return;
    }
    
    try {
        // DB에서 빌링키 있는 미납 계약 조회
        const arrearsContracts = contractList.filter(function(c) {
            return c.status === 'active' && c.arrears > 0 && c.billing_key_id;
        });
        
        if (arrearsContracts.length === 0) {
            showToast('⚠️ 결제 대상이 없습니다 (빌링키 등록된 미납 계약 없음)', 'info');
            return;
        }
        
        let successCount = 0;
        let failedCount = 0;
        
        for (let i = 0; i < arrearsContracts.length; i++) {
            const contract = arrearsContracts[i];
            try {
                // 결제 시뮬레이션 (실제로는 위루트 API 호출)
                const isSuccess = Math.random() > 0.2; // 80% 성공률
                
                if (isSuccess) {
                    successCount++;
                    
                    // 원장에 수납 기록
                    const today = new Date().toISOString().split('T')[0];
                    const ledgerData = {
                        date: today,
                        contract_id: contract.id,
                        customer_name: contract.customer_name,
                        type: 'receipt',
                        description: '자동결제 (' + (target === 'arrears' ? '미납금' : '정기') + ')',
                        accrual: 0,
                        receipt: contract.arrears,
                        method: 'card'
                    };
                    
                    const ledgerResult = await insertToDB('ledger', ledgerData);
                    if (ledgerResult && ledgerResult[0]) {
                        ledgerList.unshift(Object.assign({}, ledgerResult[0], {desc: ledgerResult[0].description}));
                    }
                    
                    // 계약 미납금 감소
                    const paidAmount = contract.arrears;
                    contract.arrears = 0;
                    await updateInDB('contracts', contract.id, { arrears: 0 });
                    
                    // 결제 내역 저장
                    const paymentData = {
                        billing_key_id: contract.billing_key_id,
                        contract_id: contract.id,
                        customer_name: contract.customer_name,
                        amount: paidAmount,
                        order_id: 'PY' + Date.now() + '_' + contract.id,
                        order_name: contract.customer_name + ' ' + (target === 'arrears' ? '미납금' : '정기결제'),
                        status: 'success',
                        result_code: '0000',
                        result_msg: '결제 성공',
                        paid_at: new Date().toISOString()
                    };
                    await insertToDB('billing_payments', paymentData);
                    
                } else {
                    failedCount++;
                }
            } catch (err) {
                failedCount++;
                console.error('계약 ' + contract.id + ' 결제 실패:', err);
            }
        }
        
        showToast('✅ ' + targetLabel + ' 완료: ' + successCount + '건 성공, ' + failedCount + '건 실패');
        
        // 데이터 새로고침
        await loadAllData();
        loadPgPayments();
        loadContracts();
        loadLedger();
        
    } catch (error) {
        showToast('❌ 배치 결제 실패: ' + error.message, 'error');
    }
}

// 결제 내역 모달 열기
async function openBillingHistoryModal() {
    // DB에서 결제 내역 조회
    const payments = await loadFromDB('billing_payments');
    billingPaymentHistory = payments || [];
    
    var h = '<div class="modal-overlay" id="billingHistoryModal" onclick="if(event.target===this)closeModal(\'billingHistoryModal\')">' +
        '<div class="modal-content" style="max-width:800px">' +
        '<div class="flex justify-between items-center mb-4">' +
        '<h2 class="text-lg font-bold text-lime-400">📜 자동결제 내역</h2>' +
        '<button onclick="closeModal(\'billingHistoryModal\')" class="text-gray-400 hover:text-white text-xl">&times;</button>' +
        '</div>' +
        '<div class="overflow-x-auto">' +
        '<table class="data-table">' +
        '<thead><tr><th>일시</th><th>고객명</th><th>금액</th><th>상태</th><th>결과</th></tr></thead>' +
        '<tbody>';
    
    if (billingPaymentHistory.length === 0) {
        h += '<tr><td colspan="5" class="text-center text-gray-500 py-6">결제 내역이 없습니다</td></tr>';
    } else {
        billingPaymentHistory.forEach(function(p) {
            var statusBadge = p.status === 'success' ? 'badge-success' : p.status === 'failed' ? 'badge-failed' : 'badge-pending';
            var statusText = p.status === 'success' ? '성공' : p.status === 'failed' ? '실패' : '대기';
            var paidAt = p.paid_at ? new Date(p.paid_at).toLocaleString('ko-KR') : '-';
            
            h += '<tr>' +
                '<td class="text-gray-400">' + paidAt + '</td>' +
                '<td class="font-bold">' + (p.customer_name || '-') + '</td>' +
                '<td class="text-blue-400 font-bold">' + fmt(p.amount) + '</td>' +
                '<td><span class="badge ' + statusBadge + '">' + statusText + '</span></td>' +
                '<td class="text-gray-500 text-xs">' + (p.result_msg || '-') + '</td>' +
                '</tr>';
        });
    }
    
    h += '</tbody></table></div>' +
        '<div class="mt-4 flex justify-end">' +
        '<button onclick="closeModal(\'billingHistoryModal\')" class="btn-secondary">닫기</button>' +
        '</div></div></div>';
    
    // 기존 모달 제거 후 추가
    var existingModal = document.getElementById('billingHistoryModal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', h);
}

// 빌링키 등록 (카드 등록 시 DB에 저장)
async function registerBillingKey(contractId, cardData) {
    var contract = contractList.find(function(c) { return c.id === contractId; });
    if (!contract) return null;
    
    try {
        // 빌링키 데이터 생성
        var billingKeyData = {
            contract_id: contractId,
            customer_name: contract.customer_name,
            billing_key: 'BK_' + Date.now() + '_' + contractId,
            card_name: cardData.card_company || '카드',
            card_last4: cardData.card_no.slice(-4),
            card_type: cardData.card_type || 'personal',
            pg_provider: 'weroute',
            status: 'active'
        };
        
        var result = await insertToDB('billing_keys', billingKeyData);
        
        if (result && result[0]) {
            // 계약에 빌링키 연결
            await updateInDB('contracts', contractId, { billing_key_id: result[0].id });
            contract.billing_key_id = result[0].id;
            
            showToast('✅ 빌링키 등록 완료');
            return result[0];
        }
    } catch (error) {
        console.error('빌링키 등록 오류:', error);
        showToast('❌ 빌링키 등록 실패', 'error');
    }
    
    return null;
}

// PG 연결 상태 확인
function checkPgConnectionStatus() {
    var statusEl = document.getElementById('pg-connection-status');
    if (statusEl) {
        statusEl.className = 'badge badge-active';
        statusEl.textContent = '연결됨';
    }
}

// 자동결제 탭 로드 시 연결 상태 확인
setTimeout(function() {
    var origLoadPgPayments = window.loadPgPayments;
    if (origLoadPgPayments) {
        window.loadPgPayments = function() {
            origLoadPgPayments();
            checkPgConnectionStatus();
        };
    }
}, 1000);

console.log('✅ 위루트 파이낸셜 PG 연동 모듈 로드 완료');
</script>
