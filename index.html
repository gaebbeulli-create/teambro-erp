<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TEAM BRO - 본사 ERP</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @keyframes neonGlow { 0%, 100% { filter: drop-shadow(0 0 10px #39FF14); } 50% { filter: drop-shadow(0 0 20px #39FF14); } }
        .neon-text { color: #FFF; animation: neonGlow 2s ease-in-out infinite; }
        .glass-card { background: rgba(15, 15, 15, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(57, 255, 20, 0.2); }
        body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .hidden { display: none; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: rgba(57, 255, 20, 0.1); padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #39FF14; }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 13px; }
        .data-table tr:hover { background: rgba(57, 255, 20, 0.05); }
        .input-field { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(57, 255, 20, 0.3); color: white; padding: 10px 14px; border-radius: 8px; width: 100%; }
        .input-field:focus { outline: none; border-color: #39FF14; }
        .btn-primary { background: linear-gradient(135deg, #39FF14, #32CD32); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; }
        .btn-secondary { background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); color: #39FF14; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 10px; }
        .modal-content { background: #0a0a0a; border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 16px; padding: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-active { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-inactive { background: rgba(107, 114, 128, 0.2); color: #9CA3AF; }
        .badge-pending { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-biz { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-nonbiz { background: rgba(251, 146, 60, 0.2); color: #FB923C; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 200; }
        .toast-success { background: rgba(16, 185, 129, 0.9); }
        .toast-error { background: rgba(239, 68, 68, 0.9); }
        .toast-info { background: rgba(59, 130, 246, 0.9); }
        .nav-btn { color: #9CA3AF; transition: all 0.2s; }
        .nav-btn:hover { background: rgba(57, 255, 20, 0.1); color: #fff; }
        .nav-btn.active { background: rgba(57, 255, 20, 0.2); color: #39FF14; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #39FF14; color: #39FF14; }
        @media (max-width: 768px) { .sidebar { display: none !important; } .mobile-nav { display: flex !important; } }
    </style>
</head>
<body class="min-h-screen">
    <div id="toast-container"></div>

    <!-- 로딩 -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <div class="text-center">
            <h1 class="text-4xl font-black neon-text mb-4">TEAM BRO</h1>
            <p class="text-gray-500 text-xs mt-4">로딩 중...</p>
        </div>
    </div>

    <!-- 로그인 -->
    <div id="loginPage" class="hidden relative z-10 min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-black neon-text mb-3">TEAM BRO</h1>
                <p class="text-lime-400/70 text-sm">본사 ERP 시스템</p>
            </div>
            <div class="glass-card rounded-2xl p-8">
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div><label class="block text-sm font-bold text-lime-400 mb-2">아이디</label><input type="text" id="loginUsername" class="input-field" required></div>
                    <div><label class="block text-sm font-bold text-lime-400 mb-2">비밀번호</label><input type="password" id="loginPassword" class="input-field" required></div>
                    <div id="loginError" class="hidden p-3 rounded-lg bg-red-400/10 text-red-400 text-sm"></div>
                    <button type="submit" class="w-full btn-primary text-lg py-3">⚡ 로그인</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 메인 -->
    <div id="mainSystem" class="hidden">
        <header class="relative z-10 border-b border-lime-500/30" style="background:linear-gradient(180deg,rgba(57,255,20,0.15) 0%,rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="text-lime-400 text-2xl hover:text-lime-300 hidden md:block" id="hamburgerBtn">☰</button>
                    <div class="flex items-center gap-3 cursor-pointer" onclick="showTab('dashboard')">
                        <h1 class="text-2xl font-black text-lime-400">🏢 TEAM BRO</h1>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span id="headerUserName" class="text-lime-400 font-bold hidden md:inline">관리자</span>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-400 text-sm">로그아웃</button>
                </div>
            </div>
        </header>

        <div class="flex">
            <aside class="sidebar w-56 min-h-screen border-r border-lime-500/20 bg-black/50 hidden md:block" id="sidebarMenu" style="overflow-y:auto; max-height:calc(100vh - 60px)">
                <nav class="p-4 space-y-1">
                    <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-btn active w-full text-left px-3 py-2 rounded-lg text-sm">📊 대시보드</button>
                    
                    <!-- 기초정보 -->
                    <div class="mt-4">
                        <button onclick="toggleMenu('basic')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>👥 기초정보</span><span id="arrow-basic" class="text-xs">▶</span>
                        </button>
                        <div id="menu-basic" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('riders')" id="nav-riders" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 라이더 관리</button>
                            <button onclick="showTab('partners')" id="nav-partners" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 협력사 관리</button>
                            <button onclick="showTab('sales')" id="nav-sales" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 영업자 관리</button>
                        </div>
                    </div>
                    
                    <!-- 정산관리 -->
                    <div class="mt-2">
                        <button onclick="toggleMenu('settlement')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>💰 정산관리</span><span id="arrow-settlement" class="text-xs">▶</span>
                        </button>
                        <div id="menu-settlement" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('sett-dashboard')" id="nav-sett-dashboard" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 정산 현황</button>
                            <button onclick="showTab('platform')" id="nav-platform" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 플랫폼정산입금</button>
                            <button onclick="showTab('sett-advance')" id="nav-sett-advance" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 선정산 지급</button>
                            <button onclick="showTab('weekly-payout')" id="nav-weekly-payout" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 주정산 지급</button>
                            <button onclick="showTab('reconcile')" id="nav-reconcile" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 대사 관리</button>
                        </div>
                    </div>
                    
                    <!-- 재무관리 -->
                    <div class="mt-2">
                        <button onclick="toggleMenu('finance')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>💵 재무관리</span><span id="arrow-finance" class="text-xs">▶</span>
                        </button>
                        <div id="menu-finance" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('bank')" id="nav-bank" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 현금출납장</button>
                            <button onclick="showTab('accounting')" id="nav-accounting" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 매입매출장</button>
                            <button onclick="showTab('taxinvoice')" id="nav-taxinvoice" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 세금계산서</button>
                            <button onclick="showTab('ledger')" id="nav-ledger" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 총계정원장</button>
                            <button onclick="showTab('journal')" id="nav-journal" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 분개장</button>
                        </div>
                    </div>
                    
                    <!-- 카드/자산 -->
                    <div class="mt-2">
                        <button onclick="toggleMenu('card')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>💳 카드/자산</span><span id="arrow-card" class="text-xs">▶</span>
                        </button>
                        <div id="menu-card" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('cards')" id="nav-cards" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 법인카드 관리</button>
                            <button onclick="showTab('card-usage')" id="nav-card-usage" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 카드 사용내역</button>
                        </div>
                    </div>
                    
                    <!-- 인사관리 -->
                    <div class="mt-2">
                        <button onclick="toggleMenu('hr')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>👥 인사관리</span><span id="arrow-hr" class="text-xs">▶</span>
                        </button>
                        <div id="menu-hr" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('employees')" id="nav-employees" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 직원 관리</button>
                            <button onclick="showTab('payroll')" id="nav-payroll" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 급여 관리</button>
                            <button onclick="showTab('contracts')" id="nav-contracts" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 근로계약</button>
                        </div>
                    </div>
                    
                    <!-- 문서/세무 -->
                    <div class="mt-2">
                        <button onclick="toggleMenu('docs')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>📋 문서/세무</span><span id="arrow-docs" class="text-xs">▶</span>
                        </button>
                        <div id="menu-docs" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('tax')" id="nav-tax" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 세무 관리</button>
                            <button onclick="showTab('docsmenu')" id="nav-docsmenu" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 문서 관리</button>
                            <button onclick="showTab('excel')" id="nav-excel" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 업로드 양식</button>
                        </div>
                    </div>
                    
                    <!-- 시스템 -->
                    <div class="mt-2">
                        <button onclick="toggleMenu('system')" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center">
                            <span>⚙️ 시스템</span><span id="arrow-system" class="text-xs">▶</span>
                        </button>
                        <div id="menu-system" class="ml-4 space-y-1 mt-1 hidden">
                            <button onclick="showTab('users')" id="nav-users" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 사용자 관리</button>
                            <button onclick="showTab('logs')" id="nav-logs" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 감사 로그</button>
                            <button onclick="showTab('settings')" id="nav-settings" class="nav-btn w-full text-left px-3 py-2 rounded-lg text-xs">└ 시스템 설정</button>
                        </div>
                    </div>
                </nav>
            </aside>

            <div class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-black border-t border-lime-500/20 z-40">
                <button onclick="showTab('dashboard')" class="flex-1 py-3 text-center text-xs text-gray-400">📊<br>대시보드</button>
                <button onclick="showTab('riders')" class="flex-1 py-3 text-center text-xs text-gray-400">🏍️<br>라이더</button>
                <button onclick="showTab('partners')" class="flex-1 py-3 text-center text-xs text-gray-400">🤝<br>협력사</button>
                <button onclick="showTab('sales')" class="flex-1 py-3 text-center text-xs text-gray-400">💼<br>영업자</button>
            </div>

            <main class="flex-1 p-4 md:p-6 pb-24 md:pb-6">
                <!-- 대시보드 -->
                <div id="tab-dashboard" class="tab-content">
                    <h2 class="text-2xl font-bold mb-6">📊 대시보드</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-card rounded-xl p-4 text-center cursor-pointer" onclick="showTab('riders')"><div class="text-gray-400 text-xs mb-1">라이더</div><div class="text-2xl font-bold text-lime-400" id="stat-riders">0명</div></div>
                        <div class="glass-card rounded-xl p-4 text-center cursor-pointer" onclick="showTab('partners')"><div class="text-gray-400 text-xs mb-1">협력사</div><div class="text-2xl font-bold text-blue-400" id="stat-partners">0개</div></div>
                        <div class="glass-card rounded-xl p-4 text-center cursor-pointer" onclick="showTab('sales')"><div class="text-gray-400 text-xs mb-1">영업자</div><div class="text-2xl font-bold text-purple-400" id="stat-sales">0명</div></div>
                        <div class="glass-card rounded-xl p-4 text-center"><div class="text-gray-400 text-xs mb-1">이번달 수수료</div><div class="text-2xl font-bold text-green-400">₩0</div></div>
                    </div>
                </div>

                <!-- 라이더 관리 -->
                <div id="tab-riders" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">🏍️ 라이더 관리</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('rider')" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('riderExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportToExcel('rider')" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openRiderModal()" class="btn-primary btn-sm">+ 등록</button>
                            <input type="file" id="riderExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('rider', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="rider-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterList('rider','active')"><div class="text-gray-400 text-xs">활성</div><div class="text-xl font-bold text-green-400" id="rider-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterList('rider','inactive')"><div class="text-gray-400 text-xs">비활성</div><div class="text-xl font-bold text-gray-400" id="rider-inactive">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">주민번호 미등록</div><div class="text-xl font-bold text-red-400" id="rider-nossn">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="riderStatusFilter" class="input-field" style="width:100px" onchange="renderTable('rider')"><option value="">전체</option><option value="active">활성</option><option value="inactive">비활성</option></select>
                            <select id="riderPartnerFilter" class="input-field" style="width:150px" onchange="renderTable('rider')"><option value="">전체 협력사</option></select>
                            <input type="text" id="riderSearch" class="input-field flex-1" style="min-width:150px" placeholder="검색..." onkeyup="renderTable('rider')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>이름</th><th>연락처</th><th>협력사</th><th>원천징수</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="riderTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 협력사 관리 -->
                <div id="tab-partners" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">🤝 협력사 관리</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('partner')" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('partnerExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportToExcel('partner')" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openPartnerModal()" class="btn-primary btn-sm">+ 등록</button>
                            <input type="file" id="partnerExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('partner', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="partner-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">사업자</div><div class="text-xl font-bold text-blue-400" id="partner-biz">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">비사업자</div><div class="text-xl font-bold text-orange-400" id="partner-nonbiz">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">소속 라이더</div><div class="text-xl font-bold text-purple-400" id="partner-riders">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>협력사명</th><th>코드</th><th>구분</th><th>대표자</th><th>연락처</th><th>라이더수</th><th>관리</th></tr></thead>
                        <tbody id="partnerTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 영업자 관리 -->
                <div id="tab-sales" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">💼 영업자 관리</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('sales')" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('salesExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportToExcel('sales')" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openSalesModal()" class="btn-primary btn-sm">+ 등록</button>
                            <input type="file" id="salesExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('sales', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="sales-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">개인</div><div class="text-xl font-bold text-purple-400" id="sales-ind">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">개인사업자</div><div class="text-xl font-bold text-blue-400" id="sales-sole">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">법인</div><div class="text-xl font-bold text-pink-400" id="sales-corp">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="salesStatusFilter" class="input-field" style="width:100px" onchange="renderTable('sales')"><option value="">전체</option><option value="active">활성</option><option value="inactive">비활성</option></select>
                            <select id="salesTypeFilter" class="input-field" style="width:120px" onchange="renderTable('sales')"><option value="">전체유형</option><option value="individual">개인</option><option value="sole_prop">개인사업자</option><option value="corporation">법인</option></select>
                            <input type="text" id="salesSearch" class="input-field flex-1" style="min-width:150px" placeholder="검색..." onkeyup="renderTable('sales')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>코드</th><th>이름</th><th>유형</th><th>연락처</th><th>지급주기</th><th>원천징수</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="salesTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 사용자 관리 -->
                <div id="tab-users" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">👥 사용자 관리</h2>
                        <button onclick="openUserModal()" class="btn-primary btn-sm">+ 사용자 등록</button>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>이름</th><th>아이디</th><th>권한</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="userTableBody"><tr><td colspan="5" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 법인 관리 -->
                <div id="tab-entities" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">🏢 법인 관리</h2>
                    <div class="glass-card rounded-xl p-8 text-center"><div class="text-4xl mb-4">🏢</div><p class="text-gray-400">법인 관리 기능 준비중</p></div>
                </div>

                <!-- 정산 관리 -->
                <div id="tab-settlement" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">💰 정산 관리</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('settlement')" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('settlementExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportToExcel('settlement')" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openSettlementModal()" class="btn-primary btn-sm">+ 정산 등록</button>
                            <input type="file" id="settlementExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('settlement', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="sett-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('pending')"><div class="text-gray-400 text-xs">대기</div><div class="text-xl font-bold text-yellow-400" id="sett-pending">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('confirmed')"><div class="text-gray-400 text-xs">확정</div><div class="text-xl font-bold text-blue-400" id="sett-confirmed">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('paid')"><div class="text-gray-400 text-xs">지급완료</div><div class="text-xl font-bold text-green-400" id="sett-paid">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 정산금</div><div class="text-xl font-bold text-purple-400" id="sett-amount">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="settWeekFilter" class="input-field" style="width:130px" onchange="renderTable('settlement')"><option value="">전체 주차</option></select>
                            <select id="settStatusFilter" class="input-field" style="width:100px" onchange="renderTable('settlement')"><option value="">전체</option><option value="pending">대기</option><option value="confirmed">확정</option><option value="paid">지급완료</option></select>
                            <select id="settPartnerFilter" class="input-field" style="width:150px" onchange="renderTable('settlement')"><option value="">전체 협력사</option></select>
                            <input type="text" id="settSearch" class="input-field flex-1" style="min-width:150px" placeholder="라이더 검색..." onkeyup="renderTable('settlement')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>주차</th><th>근무기간</th><th>라이더</th><th>협력사</th><th>총수입</th><th>공제</th><th>선정산</th><th>실지급</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="settlementTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 지급 관리 (직원 급여) -->
                <div id="tab-payout" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">👥 인사관리</h2>
                        <div class="flex gap-2">
                            <button onclick="openEmployeeModal()" class="btn-secondary btn-sm">+ 직원 등록</button>
                            <button onclick="openPayrollModal()" class="btn-primary btn-sm">+ 급여 등록</button>
                        </div>
                    </div>
                    
                    <!-- 직원 목록 -->
                    <h3 class="text-lg font-bold mb-3 text-lime-400">👤 직원 목록</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="emp-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">정규직</div><div class="text-xl font-bold text-blue-400" id="emp-regular">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">계약직</div><div class="text-xl font-bold text-yellow-400" id="emp-contract">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">4대보험</div><div class="text-xl font-bold text-green-400" id="emp-insured">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>사번</th><th>이름</th><th>구분</th><th>부서</th><th>기본급</th><th>4대보험</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="employeeTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                    
                    <!-- 급여 내역 -->
                    <h3 class="text-lg font-bold mb-3 text-purple-400">💰 급여 지급 내역</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">이번달 지급</div><div class="text-xl font-bold text-lime-400" id="pay-count">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 지급액</div><div class="text-xl font-bold text-blue-400" id="pay-gross">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 공제액</div><div class="text-xl font-bold text-red-400" id="pay-deduct">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">실지급 합계</div><div class="text-xl font-bold text-green-400" id="pay-net">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>지급월</th><th>직원</th><th>기본급</th><th>수당</th><th>총지급</th><th>공제</th><th>실지급</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="payrollTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                    
                    <!-- 근로계약서 업로드 -->
                    <h3 class="text-lg font-bold mb-3 text-orange-400">📄 근로계약서 관리</h3>
                    <div class="glass-card rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4">
                            <select id="contractEmpSelect" class="input-field" style="width:200px">
                                <option value="">직원 선택</option>
                            </select>
                            <label class="btn-secondary btn-sm cursor-pointer">
                                📎 파일 선택
                                <input type="file" id="contractFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="hidden" onchange="handleContractUpload(this)">
                            </label>
                            <span id="contractFileName" class="text-gray-400 text-sm">선택된 파일 없음</span>
                            <button onclick="uploadContract()" class="btn-primary btn-sm">업로드</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">* PDF, 이미지(JPG, PNG), Word 파일 업로드 가능</div>
                        <div class="glass-card rounded-lg overflow-hidden">
                            <table class="data-table"><thead><tr><th>직원</th><th>파일명</th><th>업로드일</th><th>관리</th></tr></thead>
                            <tbody id="contractTableBody"><tr><td colspan="4" class="text-center py-4 text-gray-500">업로드된 파일 없음</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- 장부 관리 -->
                <div id="tab-books" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">📒 장부 관리</h2>
                    <div class="glass-card rounded-xl p-8 text-center"><div class="text-4xl mb-4">📒</div><p class="text-gray-400">장부 관리 기능 준비중</p></div>
                </div>

                <!-- 세무 관리 -->
                <div id="tab-tax" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📋 세무 서류 보관함</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openTaxUploadModal()" class="btn-primary btn-sm">📤 파일 업로드</button>
                        </div>
                    </div>
                    
                    <!-- 설명 배너 -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-blue-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">📁</span>
                            <div>
                                <p class="text-blue-400 font-bold">세무서류 클라우드 보관함</p>
                                <p class="text-gray-400 text-sm">세무서에서 받은 원천세 신고서, 지급명세서 등 서류를 업로드하고 보관합니다</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 카테고리 탭 -->
                    <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                        <button onclick="filterTaxDocs('all')" id="taxDocTab-all" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-lime-500/20 text-lime-400">전체</button>
                        <button onclick="filterTaxDocs('withholding')" id="taxDocTab-withholding" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">원천세 신고</button>
                        <button onclick="filterTaxDocs('statement')" id="taxDocTab-statement" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">지급명세서</button>
                        <button onclick="filterTaxDocs('other')" id="taxDocTab-other" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">기타 서류</button>
                    </div>
                    
                    <!-- 통계 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체 파일</div><div class="text-xl font-bold text-lime-400" id="taxdoc-total">0개</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">원천세 신고</div><div class="text-xl font-bold text-blue-400" id="taxdoc-withholding">0개</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">지급명세서</div><div class="text-xl font-bold text-purple-400" id="taxdoc-statement">0개</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">기타 서류</div><div class="text-xl font-bold text-yellow-400" id="taxdoc-other">0개</div></div>
                    </div>
                    
                    <!-- 검색/필터 -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="taxDocSearch" class="input-field flex-1" style="min-width:200px" placeholder="파일명 검색..." onkeyup="renderTaxDocTable()">
                            <input type="month" id="taxDocMonth" class="input-field" style="width:150px" onchange="renderTaxDocTable()">
                        </div>
                    </div>
                    
                    <!-- 파일 목록 -->
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>카테고리</th><th>파일명</th><th>서류일자</th><th>설명</th><th>크기</th><th>업로드일</th><th>관리</th></tr></thead>
                        <tbody id="taxDocTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">업로드된 파일이 없습니다</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 문서 관리 -->
                <div id="tab-docs" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">📁 문서 관리</h2>
                    <div class="glass-card rounded-xl p-8 text-center"><div class="text-4xl mb-4">📁</div><p class="text-gray-400">문서 관리 기능 준비중</p></div>
                </div>

                <!-- 엑셀 관리 -->
                <div id="tab-excel" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">📊 엑셀 관리</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">🏍️</div><div><h4 class="font-bold">라이더 템플릿</h4><p class="text-xs text-gray-400">일괄 업로드용</p></div></div>
                            <button onclick="downloadTemplate('rider')" class="btn-secondary btn-sm w-full">다운로드</button>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">🤝</div><div><h4 class="font-bold">협력사 템플릿</h4><p class="text-xs text-gray-400">일괄 업로드용</p></div></div>
                            <button onclick="downloadTemplate('partner')" class="btn-secondary btn-sm w-full">다운로드</button>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">💼</div><div><h4 class="font-bold">영업자 템플릿</h4><p class="text-xs text-gray-400">일괄 업로드용</p></div></div>
                            <button onclick="downloadTemplate('sales')" class="btn-secondary btn-sm w-full">다운로드</button>
                        </div>
                    </div>
                </div>

                <!-- 카드 관리 -->
                <div id="tab-cards" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">💳 카드 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="openCardModal()" class="btn-primary btn-sm">+ 카드 등록</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="card-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">사용중</div><div class="text-xl font-bold text-green-400" id="card-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">일시중지</div><div class="text-xl font-bold text-yellow-400" id="card-suspended">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">이번달 사용액</div><div class="text-xl font-bold text-purple-400" id="card-monthly">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>카드별칭</th><th>카드번호</th><th>카드사</th><th>담당자</th><th>일한도</th><th>월한도</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="cardTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                    <h3 class="text-lg font-bold mb-4">📋 최근 사용내역</h3>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>일시</th><th>카드</th><th>가맹점</th><th>금액</th><th>증빙</th><th>회계</th></tr></thead>
                        <tbody id="cardTransTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 정산 현황 대시보드 -->
                <div id="tab-sett-dashboard" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">📊 정산 현황</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">플랫폼 받을금액</div>
                            <div class="text-2xl font-bold text-blue-400" id="sett-dash-platform">₩0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">선정산 지급액</div>
                            <div class="text-2xl font-bold text-red-400" id="sett-dash-advance">₩0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">차액 (수익)</div>
                            <div class="text-2xl font-bold text-lime-400" id="sett-dash-profit">₩0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">대사 미완료</div>
                            <div class="text-2xl font-bold text-yellow-400" id="sett-dash-pending">0건</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="font-bold mb-4 text-lime-400">📥 최근 플랫폼 정산</h3>
                            <table class="data-table"><thead><tr><th>주차</th><th>플랫폼</th><th>금액</th><th>상태</th></tr></thead>
                            <tbody id="settDashPlatformTable"><tr><td colspan="4" class="text-center py-4 text-gray-500">데이터 없음</td></tr></tbody></table>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="font-bold mb-4 text-red-400">📤 최근 선정산 지급</h3>
                            <table class="data-table"><thead><tr><th>일자</th><th>협력사</th><th>금액</th><th>상태</th></tr></thead>
                            <tbody id="settDashAdvanceTable"><tr><td colspan="4" class="text-center py-4 text-gray-500">데이터 없음</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- 플랫폼 정산 -->
                <div id="tab-platform" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📥 플랫폼정산입금</h2>
                        <button onclick="openPlatformModal()" class="btn-primary btn-sm">+ 정산 등록</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="plat-total">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 건수</div><div class="text-xl font-bold text-yellow-400" id="plat-count-stat">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">공급가 합계</div><div class="text-xl font-bold text-green-400" id="plat-supply-stat">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 금액</div><div class="text-xl font-bold text-blue-400" id="plat-amount">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>주차</th><th>플랫폼</th><th>셋트기간</th><th>완료건수</th><th>공급가</th><th>부가세</th><th>합계</th><th>결제입금일</th><th>관리</th></tr></thead>
                        <tbody id="platformTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 선정산 지급 -->
                <div id="tab-sett-advance" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📤 선정산 지급 (하위법인)</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="syncFromPlatformSettlement()" class="btn-secondary btn-sm">🔄 플랫폼정산 연동</button>
                            <button onclick="downloadSettAdvanceTemplate()" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('settAdvanceExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportSettAdvanceExcel()" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openSettAdvanceModal()" class="btn-primary btn-sm">+ 지급 등록</button>
                            <input type="file" id="settAdvanceExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadSettAdvanceExcel(this)">
                        </div>
                    </div>
                    
                    <!-- 설명 배너 -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-yellow-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">💡</span>
                            <div>
                                <p class="text-yellow-400 font-bold">선정산이란?</p>
                                <p class="text-gray-400 text-sm">플랫폼(배민/쿠팡) 정산금 입금 전, 팀브로가 하위법인(협력사)에게 먼저 익일 정산해주는 것</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="settadv-total">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">대기</div><div class="text-xl font-bold text-yellow-400" id="settadv-pending">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">지급완료</div><div class="text-xl font-bold text-green-400" id="settadv-transferred">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 지급액</div><div class="text-xl font-bold text-red-400" id="settadv-amount">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">수수료 수익</div><div class="text-xl font-bold text-lime-400" id="settadv-fee-income">₩0</div></div>
                    </div>
                    
                    <!-- 필터 -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="settAdvMonthFilter" class="input-field" style="width:150px" onchange="renderSettAdvanceTable()">
                            <select id="settAdvPartnerFilter" class="input-field" style="width:150px" onchange="renderSettAdvanceTable()"><option value="">전체 협력사</option></select>
                            <select id="settAdvStatusFilter" class="input-field" style="width:100px" onchange="renderSettAdvanceTable()"><option value="">전체</option><option value="pending">대기</option><option value="transferred">완료</option></select>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>지급일</th><th>협력사(하위법인)</th><th>주차</th><th>공급가</th><th>부가세</th><th>합계</th><th>수수료</th><th>실지급</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="settAdvanceTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 대사관리 -->
                <div id="tab-reconcile" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">🔄 대사관리 (매칭)</h2>
                        <div class="flex gap-2">
                            <button onclick="autoReconcile()" class="btn-secondary btn-sm">⚡ 자동 대사</button>
                            <button onclick="openReconcileModal()" class="btn-primary btn-sm">+ 수동 대사</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="rec-total">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">대기</div><div class="text-xl font-bold text-yellow-400" id="rec-pending">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">완료</div><div class="text-xl font-bold text-green-400" id="rec-matched">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">불일치</div><div class="text-xl font-bold text-red-400" id="rec-issue">0건</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>주차</th><th>협력사</th><th>플랫폼금액</th><th>선정산금액</th><th>차액</th><th>수수료수익</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="reconcileTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 주정산 지급 -->
                <div id="tab-weekly-payout" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📆 주정산 지급</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadWeeklyPayoutTemplate()" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('weeklyPayoutExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportWeeklyPayoutExcel()" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openWeeklyPayoutModal()" class="btn-primary btn-sm">+ 주정산 등록</button>
                            <input type="file" id="weeklyPayoutExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadWeeklyPayoutExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="weekly-total">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">대기</div><div class="text-xl font-bold text-yellow-400" id="weekly-pending">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">지급완료</div><div class="text-xl font-bold text-green-400" id="weekly-paid">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 지급액</div><div class="text-xl font-bold text-blue-400" id="weekly-amount">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="weeklyWeekFilter" class="input-field" style="width:130px" placeholder="주차 (2025-W03)">
                            <select id="weeklyStatusFilter" class="input-field" style="width:100px" onchange="renderWeeklyPayoutTable()"><option value="">전체</option><option value="pending">대기</option><option value="paid">지급완료</option></select>
                            <input type="text" id="weeklySearch" class="input-field flex-1" style="min-width:150px" placeholder="라이더/협력사 검색..." onkeyup="renderWeeklyPayoutTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>주차</th><th>라이더</th><th>협력사</th><th>배달건수</th><th>배달수익</th><th>공제액</th><th>실지급액</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="weeklyPayoutTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 현금출납장 -->
                <div id="tab-bank" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📒 현금출납장</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadCashbookTemplate()" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('bankExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportCashbookExcel()" class="btn-secondary btn-sm">📊 다운</button>
                            <button onclick="openCashbookModal()" class="btn-primary btn-sm">+ 거래 등록</button>
                            <input type="file" id="bankExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadBankExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 입금</div><div class="text-xl font-bold text-blue-400" id="bank-deposit">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 출금</div><div class="text-xl font-bold text-red-400" id="bank-withdrawal">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">현재 잔액</div><div class="text-xl font-bold text-lime-400" id="bank-balance">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">거래건수</div><div class="text-xl font-bold text-purple-400" id="bank-count">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">미연결</div><div class="text-xl font-bold text-yellow-400" id="bank-unlinked">0건</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2 items-center">
                            <input type="month" id="cashbookMonth" class="input-field" style="width:150px" onchange="renderCashbookTable()">
                            <select id="cashbookType" class="input-field" style="width:100px" onchange="renderCashbookTable()">
                                <option value="">전체</option>
                                <option value="deposit">입금</option>
                                <option value="withdrawal">출금</option>
                            </select>
                            <select id="cashbookLink" class="input-field" style="width:120px" onchange="renderCashbookTable()">
                                <option value="">연결상태</option>
                                <option value="linked">연결됨</option>
                                <option value="unlinked">미연결</option>
                            </select>
                            <input type="text" id="cashbookSearch" class="input-field flex-1" style="min-width:150px" placeholder="거래처/적요 검색..." onkeyup="renderCashbookTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>일자</th><th>구분</th><th>거래처</th><th>입금</th><th>출금</th><th>잔액</th><th>적요</th><th>연결</th><th>관리</th></tr></thead>
                        <tbody id="bankTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 세금계산서 관리 -->
                <div id="tab-taxinvoice" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">🧾 세금계산서 관리</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('taxinvoice')" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('taxInvoiceExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportTaxInvoiceExcel()" class="btn-secondary btn-sm">📊 다운로드</button>
                            <button onclick="syncTaxToSalesPurchase()" class="btn-secondary btn-sm">🔄 매입매출 연동</button>
                            <button onclick="openTaxInvoiceModal()" class="btn-primary btn-sm">+ 등록</button>
                            <input type="file" id="taxInvoiceExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadTaxInvoiceExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">매입 건수</div><div class="text-xl font-bold text-red-400" id="inv-purchase">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">매입 금액</div><div class="text-xl font-bold text-red-400" id="inv-purchase-amt">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">매출 건수</div><div class="text-xl font-bold text-blue-400" id="inv-sales">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">매출 금액</div><div class="text-xl font-bold text-blue-400" id="inv-sales-amt">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">미연동</div><div class="text-xl font-bold text-yellow-400" id="inv-unsynced">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="invTypeFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">전체</option><option value="purchase">매입</option><option value="sales">매출</option></select>
                            <select id="invStatusFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">전체</option><option value="unpaid">미지급</option><option value="paid">지급완료</option></select>
                            <select id="invSyncFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">연동상태</option><option value="synced">연동됨</option><option value="unsynced">미연동</option></select>
                            <input type="month" id="invMonthFilter" class="input-field" style="width:150px" onchange="renderTaxInvoiceTable()">
                            <input type="text" id="invSearch" class="input-field flex-1" style="min-width:150px" placeholder="거래처 검색..." onkeyup="renderTaxInvoiceTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>유형</th><th>발행일</th><th>거래처</th><th>공급가</th><th>부가세</th><th>합계</th><th>지급상태</th><th>연동</th><th>관리</th></tr></thead>
                        <tbody id="taxInvoiceTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 회계 관리 -->
                <div id="tab-accounting" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📊 회계 관리</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="showAccSubTab('salesPurchase')" class="btn-primary btn-sm" id="btn-salesPurchase">📋 매입매출</button>
                            <button onclick="showAccSubTab('ledger')" class="btn-secondary btn-sm" id="btn-ledger">📚 총계정원장</button>
                            <button onclick="showAccSubTab('journal')" class="btn-secondary btn-sm" id="btn-journal">📒 분개장</button>
                        </div>
                    </div>
                    
                    <!-- 요약 대시보드 -->
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">이번달 매출</div><div class="text-xl font-bold text-blue-400" id="acc-sales">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">이번달 매입</div><div class="text-xl font-bold text-red-400" id="acc-purchase">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">매출 부가세</div><div class="text-xl font-bold text-blue-300" id="acc-sales-vat">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">매입 부가세</div><div class="text-xl font-bold text-red-300" id="acc-purchase-vat">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">납부 부가세</div><div class="text-xl font-bold text-yellow-400" id="acc-vat-pay">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">순이익</div><div class="text-xl font-bold text-lime-400" id="acc-profit">₩0</div></div>
                    </div>
                    
                    <!-- 매입매출장 -->
                    <div id="accSubTab-salesPurchase">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">📋 매입매출장</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadSalesPurchaseTemplate()" class="btn-secondary btn-sm">📥 양식</button>
                                <button onclick="document.getElementById('salesPurchaseExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                                <button onclick="exportSalesPurchaseExcel()" class="btn-secondary btn-sm">📊 다운</button>
                                <button onclick="syncFromSettlements()" class="btn-secondary btn-sm">🔄 정산 연동</button>
                                <button onclick="openSalesPurchaseModal()" class="btn-primary btn-sm">+ 등록</button>
                                <input type="file" id="salesPurchaseExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadSalesPurchaseExcel(this)">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="spMonthFilter" class="input-field" style="width:150px" onchange="renderSalesPurchaseTable()">
                                <select id="spTypeFilter" class="input-field" style="width:100px" onchange="renderSalesPurchaseTable()">
                                    <option value="">전체</option>
                                    <option value="sales">매출</option>
                                    <option value="purchase">매입</option>
                                </select>
                                <select id="spTaxFilter" class="input-field" style="width:120px" onchange="renderSalesPurchaseTable()">
                                    <option value="">세금계산서</option>
                                    <option value="issued">발행</option>
                                    <option value="received">수취</option>
                                    <option value="pending">미발행</option>
                                </select>
                                <input type="text" id="spSearch" class="input-field flex-1" style="min-width:150px" placeholder="거래처/품목 검색..." onkeyup="renderSalesPurchaseTable()">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden mb-6">
                            <table class="data-table"><thead><tr><th>일자</th><th>구분</th><th>거래처</th><th>품목</th><th>공급가</th><th>부가세</th><th>합계</th><th>세금계산서</th><th>연결</th><th>관리</th></tr></thead>
                            <tbody id="salesPurchaseTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                        </div>
                    </div>
                    
                    <!-- 분개장 -->
                    <div id="accSubTab-journal" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">📒 분개장</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadTemplate('journal')" class="btn-secondary btn-sm">📥 양식</button>
                                <button onclick="document.getElementById('journalExcelInput').click()" class="btn-secondary btn-sm">📤 업로드</button>
                                <button onclick="exportJournalExcel()" class="btn-secondary btn-sm">📊 다운로드</button>
                                <button onclick="openJournalModal()" class="btn-primary btn-sm">+ 분개 등록</button>
                                <input type="file" id="journalExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadJournalExcel(this)">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="accMonthFilter" class="input-field" style="width:150px" onchange="renderJournalTable()">
                                <select id="accStatusFilter" class="input-field" style="width:100px" onchange="renderJournalTable()"><option value="">전체</option><option value="created">생성</option><option value="confirmed">확정</option></select>
                                <select id="accAccountFilter" class="input-field" style="width:150px" onchange="renderJournalTable()">
                                    <option value="">전체 계정</option>
                                    <optgroup label="자산">
                                        <option value="101">현금</option>
                                        <option value="102">보통예금</option>
                                        <option value="108">매출채권</option>
                                        <option value="120">재고자산</option>
                                    </optgroup>
                                    <optgroup label="부채">
                                        <option value="201">매입채무</option>
                                        <option value="210">미지급금</option>
                                        <option value="220">예수금</option>
                                    </optgroup>
                                    <optgroup label="수익">
                                        <option value="401">매출</option>
                                        <option value="402">수수료수익</option>
                                    </optgroup>
                                    <optgroup label="비용">
                                        <option value="501">급여</option>
                                        <option value="502">임차료</option>
                                        <option value="503">통신비</option>
                                        <option value="504">소모품비</option>
                                        <option value="510">차량유지비</option>
                                    </optgroup>
                                </select>
                                <input type="text" id="accSearch" class="input-field flex-1" style="min-width:150px" placeholder="적요 검색..." onkeyup="renderJournalTable()">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden">
                            <table class="data-table"><thead><tr><th>일자</th><th>분개번호</th><th>차변계정</th><th>차변금액</th><th>대변계정</th><th>대변금액</th><th>적요</th><th>상태</th><th>관리</th></tr></thead>
                            <tbody id="journalTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                        </div>
                    </div>
                    
                    <!-- 총계정원장 -->
                    <div id="accSubTab-ledger" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">📚 총계정원장</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="exportLedgerExcel()" class="btn-secondary btn-sm">📊 엑셀 다운</button>
                                <button onclick="renderLedgerTable()" class="btn-secondary btn-sm">🔄 새로고침</button>
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="ledgerMonthFilter" class="input-field" style="width:150px" onchange="renderLedgerTable()">
                                <select id="ledgerCategoryFilter" class="input-field" style="width:120px" onchange="renderLedgerTable()">
                                    <option value="">전체 분류</option>
                                    <option value="asset">자산</option>
                                    <option value="liability">부채</option>
                                    <option value="equity">자본</option>
                                    <option value="revenue">수익</option>
                                    <option value="expense">비용</option>
                                </select>
                            </div>
                        </div>
                        <!-- 계정과목별 요약 카드 -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-blue-400">
                                <div class="text-gray-400 text-xs">자산 총계</div>
                                <div class="text-xl font-bold text-blue-400" id="ledger-asset">₩0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-red-400">
                                <div class="text-gray-400 text-xs">부채 총계</div>
                                <div class="text-xl font-bold text-red-400" id="ledger-liability">₩0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-green-400">
                                <div class="text-gray-400 text-xs">수익 총계</div>
                                <div class="text-xl font-bold text-green-400" id="ledger-revenue">₩0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-orange-400">
                                <div class="text-gray-400 text-xs">비용 총계</div>
                                <div class="text-xl font-bold text-orange-400" id="ledger-expense">₩0</div>
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden">
                            <table class="data-table"><thead><tr><th>계정코드</th><th>계정과목</th><th>분류</th><th>차변 합계</th><th>대변 합계</th><th>잔액</th><th>거래건수</th></tr></thead>
                            <tbody id="ledgerTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- 총계정원장 (독립탭) -->
                <div id="tab-ledger" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📚 총계정원장</h2>
                        <div class="flex gap-2">
                            <button onclick="exportLedgerExcel()" class="btn-secondary btn-sm">📊 엑셀 다운</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-blue-400"><div class="text-gray-400 text-xs">자산 총계</div><div class="text-xl font-bold text-blue-400" id="ledger2-asset">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-red-400"><div class="text-gray-400 text-xs">부채 총계</div><div class="text-xl font-bold text-red-400" id="ledger2-liability">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-green-400"><div class="text-gray-400 text-xs">수익 총계</div><div class="text-xl font-bold text-green-400" id="ledger2-revenue">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-orange-400"><div class="text-gray-400 text-xs">비용 총계</div><div class="text-xl font-bold text-orange-400" id="ledger2-expense">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="ledger2MonthFilter" class="input-field" style="width:150px" onchange="renderLedgerTable2()">
                            <select id="ledger2CategoryFilter" class="input-field" style="width:120px" onchange="renderLedgerTable2()">
                                <option value="">전체 분류</option>
                                <option value="asset">자산</option>
                                <option value="liability">부채</option>
                                <option value="revenue">수익</option>
                                <option value="expense">비용</option>
                            </select>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>계정코드</th><th>계정과목</th><th>분류</th><th>차변 합계</th><th>대변 합계</th><th>잔액</th><th>거래건수</th></tr></thead>
                        <tbody id="ledger2TableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 분개장 (독립탭) -->
                <div id="tab-journal" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📒 분개장</h2>
                        <div class="flex gap-2">
                            <button onclick="downloadTemplate('journal')" class="btn-secondary btn-sm">📥 양식</button>
                            <button onclick="document.getElementById('journalExcelInput2').click()" class="btn-secondary btn-sm">📤 업로드</button>
                            <button onclick="exportJournalExcel()" class="btn-secondary btn-sm">📊 다운로드</button>
                            <button onclick="openJournalModal()" class="btn-primary btn-sm">+ 분개 등록</button>
                            <input type="file" id="journalExcelInput2" accept=".xlsx,.xls" class="hidden" onchange="uploadJournalExcel(this)">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="journal2MonthFilter" class="input-field" style="width:150px" onchange="renderJournalTable2()">
                            <select id="journal2StatusFilter" class="input-field" style="width:100px" onchange="renderJournalTable2()"><option value="">전체</option><option value="created">생성</option><option value="confirmed">확정</option></select>
                            <input type="text" id="journal2Search" class="input-field flex-1" style="min-width:150px" placeholder="적요 검색..." onkeyup="renderJournalTable2()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>일자</th><th>분개번호</th><th>차변계정</th><th>차변금액</th><th>대변계정</th><th>대변금액</th><th>적요</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="journal2TableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 카드 사용내역 -->
                <div id="tab-card-usage" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">💳 카드 사용내역</h2>
                        <div class="flex gap-2">
                            <button onclick="exportCardTransExcel()" class="btn-secondary btn-sm">📊 다운로드</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">이번달 사용</div><div class="text-xl font-bold text-red-400" id="card-usage-monthly">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">사용건수</div><div class="text-xl font-bold text-blue-400" id="card-usage-count">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">미증빙</div><div class="text-xl font-bold text-yellow-400" id="card-usage-noreceipt">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">미처리</div><div class="text-xl font-bold text-orange-400" id="card-usage-pending">0건</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>일시</th><th>카드</th><th>가맹점</th><th>금액</th><th>증빙</th><th>회계처리</th><th>관리</th></tr></thead>
                        <tbody id="cardUsageTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 직원 관리 -->
                <div id="tab-employees" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">👤 직원 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="openEmployeeModal()" class="btn-primary btn-sm">+ 직원 등록</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체</div><div class="text-xl font-bold text-lime-400" id="emp2-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">정규직</div><div class="text-xl font-bold text-blue-400" id="emp2-regular">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">계약직</div><div class="text-xl font-bold text-yellow-400" id="emp2-contract">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">4대보험</div><div class="text-xl font-bold text-green-400" id="emp2-insured">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>사번</th><th>이름</th><th>구분</th><th>부서</th><th>기본급</th><th>4대보험</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="employees2TableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 급여 관리 -->
                <div id="tab-payroll" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">💰 급여 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="openPayrollModal()" class="btn-primary btn-sm">+ 급여 등록</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">이번달 지급</div><div class="text-xl font-bold text-lime-400" id="pay2-count">0건</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 지급액</div><div class="text-xl font-bold text-blue-400" id="pay2-gross">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">총 공제액</div><div class="text-xl font-bold text-red-400" id="pay2-deduct">₩0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">실지급액</div><div class="text-xl font-bold text-lime-400" id="pay2-net">₩0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>지급월</th><th>직원</th><th>기본급</th><th>수당</th><th>공제</th><th>실지급</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="payroll2TableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 근로계약 -->
                <div id="tab-contracts" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">📝 근로계약 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="openContractModal()" class="btn-primary btn-sm">+ 계약 등록</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">전체 계약</div><div class="text-xl font-bold text-lime-400" id="contract-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">유효 계약</div><div class="text-xl font-bold text-green-400" id="contract-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">만료 예정</div><div class="text-xl font-bold text-yellow-400" id="contract-expiring">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">만료됨</div><div class="text-xl font-bold text-red-400" id="contract-expired">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>직원</th><th>계약유형</th><th>시작일</th><th>종료일</th><th>기본급</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="contracts2TableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 감사 로그 -->
                <div id="tab-logs" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">📜 감사 로그</h2>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="logTableFilter" class="input-field" style="width:150px" onchange="renderAuditLogs()"><option value="">전체 테이블</option><option value="corporate_cards">법인카드</option><option value="card_transactions">카드사용</option><option value="hq_tax_invoices">세금계산서</option><option value="accounting_journals">회계분개</option></select>
                            <select id="logActionFilter" class="input-field" style="width:100px" onchange="renderAuditLogs()"><option value="">전체</option><option value="INSERT">등록</option><option value="UPDATE">수정</option><option value="DELETE">삭제</option></select>
                            <input type="date" id="logDateFilter" class="input-field" style="width:150px" onchange="renderAuditLogs()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>일시</th><th>테이블</th><th>액션</th><th>레코드ID</th><th>변경자</th><th>상세</th></tr></thead>
                        <tbody id="auditLogTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">로딩중...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- 시스템 설정 -->
                <div id="tab-settings" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">⚙️ 시스템 설정</h2>
                    <div class="glass-card rounded-xl p-8 text-center"><div class="text-4xl mb-4">⚙️</div><p class="text-gray-400">시스템 설정 기능 준비중</p></div>
                </div>
            </main>
        </div>
    </div>

    <!-- 라이더 모달 -->
    <div id="riderModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 id="riderModalTitle" class="text-xl font-bold text-lime-400">🏍️ 라이더 등록</h3><button onclick="closeModal('riderModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="riderForm" onsubmit="submitForm('rider',event)" class="space-y-4">
                <input type="hidden" id="rider-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">이름 *</label><input type="text" id="rider-name" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">연락처</label><input type="tel" id="rider-phone" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">협력사</label><select id="rider-partner" class="input-field"><option value="">선택안함</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="rider-status" class="input-field"><option value="active">활성</option><option value="inactive">비활성</option></select></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">주소</label><input type="text" id="rider-address" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">은행</label><select id="rider-bank" class="input-field"><option value="">선택</option><option value="KB">국민</option><option value="SHINHAN">신한</option><option value="WOORI">우리</option><option value="HANA">하나</option><option value="NH">농협</option><option value="KAKAO">카카오</option><option value="TOSS">토스</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">계좌번호</label><input type="text" id="rider-account-no" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">예금주</label><input type="text" id="rider-account-holder" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">주민번호</label><input type="text" id="rider-ssn" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">원천징수</label><select id="rider-tax-type" class="input-field"><option value="">선택</option><option value="3.3">3.3%</option><option value="8.8">8.8%</option><option value="none">없음</option></select></div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="rider-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('riderModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 협력사 모달 -->
    <div id="partnerModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 id="partnerModalTitle" class="text-xl font-bold text-lime-400">🤝 협력사 등록</h3><button onclick="closeModal('partnerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="partnerForm" onsubmit="submitForm('partner',event)" class="space-y-4">
                <input type="hidden" id="partner-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">협력사명 *</label><input type="text" id="partner-name" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">협력사코드 *</label><input type="text" id="partner-code" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">구분</label><select id="partner-type" class="input-field" onchange="toggleBizFields()"><option value="non_biz">비사업자</option><option value="biz">사업자</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">대표자명</label><input type="text" id="partner-rep" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">연락처</label><input type="tel" id="partner-phone" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">이메일</label><input type="email" id="partner-email" class="input-field"></div>
                </div>
                <div id="partnerBizFields" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">사업자번호</label><input type="text" id="partner-bizno" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">업종</label><input type="text" id="partner-biztype" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">주소</label><input type="text" id="partner-address" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">은행</label><select id="partner-bank" class="input-field"><option value="">선택</option><option value="KB">국민</option><option value="SHINHAN">신한</option><option value="WOORI">우리</option><option value="HANA">하나</option><option value="NH">농협</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">계좌번호</label><input type="text" id="partner-accountno" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="partner-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('partnerModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 영업자 모달 -->
    <div id="salesModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px">
            <div class="flex justify-between items-center mb-4"><h3 id="salesModalTitle" class="text-xl font-bold text-lime-400">💼 영업자 등록</h3><button onclick="closeModal('salesModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="salesForm" onsubmit="submitForm('sales',event)" class="space-y-4">
                <input type="hidden" id="sales-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">영업자코드 *</label><input type="text" id="sales-code" class="input-field" placeholder="SB-0001" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">유형 *</label><select id="sales-type" class="input-field" required onchange="toggleSalesBizFields()"><option value="individual">개인</option><option value="sole_prop">개인사업자</option><option value="corporation">법인</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">이름 *</label><input type="text" id="sales-name" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">연락처</label><input type="tel" id="sales-phone" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">이메일</label><input type="email" id="sales-email" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">지역</label><input type="text" id="sales-region" class="input-field"></div>
                </div>
                <div id="salesBizFields" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">사업자번호</label><input type="text" id="sales-bizno" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">대표자명</label><input type="text" id="sales-repname" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">주소</label><input type="text" id="sales-address" class="input-field"></div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">은행</label><select id="sales-bank" class="input-field"><option value="">선택</option><option value="KB">국민</option><option value="SHINHAN">신한</option><option value="WOORI">우리</option><option value="HANA">하나</option><option value="NH">농협</option><option value="KAKAO">카카오</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">예금주</label><input type="text" id="sales-bank-holder" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">계좌번호</label><input type="text" id="sales-bank-account" class="input-field"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">지급주기</label><select id="sales-payout-cycle" class="input-field"><option value="monthly">월</option><option value="weekly">주</option><option value="per_case">건별</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">원천징수율</label><select id="sales-withholding-rate" class="input-field"><option value="0.033">3.3%</option><option value="0.088">8.8%</option><option value="0">없음</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="sales-status" class="input-field"><option value="active">활성</option><option value="inactive">비활성</option></select></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="sales-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('salesModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 사용자 모달 -->
    <div id="userModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 id="userModalTitle" class="text-xl font-bold text-lime-400">👤 사용자 등록</h3><button onclick="closeModal('userModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="userForm" onsubmit="submitUser(event)" class="space-y-4">
                <input type="hidden" id="user-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">이름 *</label><input type="text" id="user-name" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">아이디 *</label><input type="text" id="user-username" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">비밀번호</label><input type="password" id="user-password" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">권한</label><select id="user-role" class="input-field"><option value="STAFF">직원</option><option value="MANAGER">매니저</option><option value="ADMIN">관리자</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="user-status" class="input-field"><option value="true">활성</option><option value="false">비활성</option></select></div>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('userModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 정산 모달 -->
    <div id="settlementModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:900px">
            <div class="flex justify-between items-center mb-4"><h3 id="settlementModalTitle" class="text-xl font-bold text-lime-400">💰 정산 등록</h3><button onclick="closeModal('settlementModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="settlementForm" onsubmit="submitSettlement(event)" class="space-y-4">
                <input type="hidden" id="sett-id">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">정산주차 *</label><input type="text" id="sett-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">근무시작(수)</label><input type="date" id="sett-start" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">근무종료(화)</label><input type="date" id="sett-end" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">지급예정일(금)</label><input type="date" id="sett-paydate" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">라이더 *</label><select id="sett-rider" class="input-field" required><option value="">선택</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">협력사</label><select id="sett-partner" class="input-field"><option value="">선택</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">플랫폼</label><select id="sett-platform" class="input-field"><option value="">선택</option><option value="baemin">배민</option><option value="coupang">쿠팡이츠</option><option value="yogiyo">요기요</option></select></div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-lime-400 font-bold mb-3">💵 수입 항목</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">배달료</label><input type="number" id="sett-delivery" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">미션비</label><input type="number" id="sett-mission" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">추가지급</label><input type="number" id="sett-extra" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">페이백</label><input type="number" id="sett-payback" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">인센티브</label><input type="number" id="sett-incentive" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">팁</label><input type="number" id="sett-tip" class="input-field" value="0" onchange="calcSettlement()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-red-400 font-bold mb-3">📉 공제 항목</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">보험료</label><input type="number" id="sett-insurance" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">장비대여료</label><input type="number" id="sett-rental" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">패널티</label><input type="number" id="sett-penalty" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">기타공제</label><input type="number" id="sett-other" class="input-field" value="0" onchange="calcSettlement()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-purple-400 font-bold mb-3">⚡ 선정산</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">선정산 금액</label><input type="number" id="sett-advance" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">상태</label><select id="sett-status" class="input-field"><option value="pending">대기</option><option value="confirmed">확정</option><option value="paid">지급완료</option></select></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">총 수입</div><div class="text-lg font-bold text-lime-400" id="calc-gross">₩0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">총 공제</div><div class="text-lg font-bold text-red-400" id="calc-deduct">₩0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">선정산</div><div class="text-lg font-bold text-purple-400" id="calc-advance">₩0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">실지급액</div><div class="text-lg font-bold text-green-400" id="calc-net">₩0</div></div>
                    </div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="sett-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('settlementModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 카드 등록 모달 -->
    <div id="cardModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="cardModalTitle" class="text-xl font-bold text-lime-400">💳 카드 등록</h3><button onclick="closeModal('cardModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="cardForm" onsubmit="submitCard(event)" class="space-y-4">
                <input type="hidden" id="card-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">카드별칭 *</label><input type="text" id="card-alias" class="input-field" placeholder="운영비카드" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">소속법인</label><input type="text" id="card-company" class="input-field" placeholder="팀브로"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">카드사 *</label><select id="card-company-name" class="input-field" required><option value="">선택</option><option value="KB">국민</option><option value="SHINHAN">신한</option><option value="WOORI">우리</option><option value="HANA">하나</option><option value="NH">농협</option><option value="BC">BC</option><option value="SAMSUNG">삼성</option><option value="LOTTE">롯데</option><option value="HYUNDAI">현대</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">카드번호 (마스킹)</label><input type="text" id="card-number" class="input-field" placeholder="1234-****-****-5678"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">연결통장</label><input type="text" id="card-bank" class="input-field" placeholder="우리은행 1002-xxx"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">유효기간</label><input type="date" id="card-valid" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">사용부서</label><input type="text" id="card-dept" class="input-field" placeholder="경영지원팀"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">실사용자</label><input type="text" id="card-user" class="input-field" placeholder="홍길동"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-lime-400 font-bold mb-3">💰 한도 설정</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">일 한도</label><input type="number" id="card-daily" class="input-field" value="0"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">월 한도</label><input type="number" id="card-monthly" class="input-field" value="0"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <label class="flex items-center gap-2"><input type="checkbox" id="card-online" checked> <span class="text-sm">온라인 결제 허용</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="card-overseas"> <span class="text-sm">해외 결제 허용</span></label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">발급일</label><input type="date" id="card-issued" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="card-status" class="input-field"><option value="active">사용중</option><option value="suspended">일시중지</option><option value="terminated">해지</option></select></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="card-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('cardModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 플랫폼 정산 모달 -->
    <div id="platformModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-lime-400">📥 플랫폼 정산 등록</h3><button onclick="closeModal('platformModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="platformForm" onsubmit="submitPlatform(event)" class="space-y-4">
                <input type="hidden" id="plat-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">플랫폼 *</label><select id="plat-platform" class="input-field" required><option value="">선택</option><option value="baemin">배민</option><option value="coupang">쿠팡이츠</option><option value="yogiyo">요기요</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">정산주차 *</label><input type="text" id="plat-week" class="input-field" placeholder="2025-W03" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">셋트시작</label><input type="date" id="plat-start" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">셋트종료</label><input type="date" id="plat-end" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">결제입금일</label><input type="date" id="plat-expected" class="input-field"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">총 완료건수</label><input type="number" id="plat-count" class="input-field" value="0"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-lime-400 font-bold mb-3">💰 금액</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">공급가액</label><input type="number" id="plat-supply" class="input-field" value="0" onchange="calcPlatformVat()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">부가세 (10%)</label><input type="number" id="plat-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">합계</label><input type="number" id="plat-total-amt" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="plat-memo" class="input-field" rows="4"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('platformModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 선정산 지급 모달 -->
    <div id="settAdvanceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-red-400">📤 선정산 지급 등록</h3><button onclick="closeModal('settAdvanceModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="settAdvanceForm" onsubmit="submitSettAdvance(event)" class="space-y-4">
                <input type="hidden" id="settadv-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">협력사 *</label><select id="settadv-partner" class="input-field" required><option value="">선택</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">지급일 *</label><input type="date" id="settadv-date" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">정산주차</label><input type="text" id="settadv-week" class="input-field" placeholder="2025-W03"></div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-lime-400 font-bold mb-3">💰 금액</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">공급가액</label><input type="number" id="settadv-supply" class="input-field" value="0" onchange="calcSettAdvanceTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">부가세 (10%)</label><input type="number" id="settadv-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">합계</label><input type="number" id="settadv-total-amt" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-yellow-400 font-bold mb-3">💸 수수료</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">수수료율 (%)</label><input type="number" id="settadv-fee-rate" class="input-field" value="0" step="0.01" onchange="calcSettAdvanceTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">수수료 금액</label><input type="number" id="settadv-fee" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">실지급액</label><input type="number" id="settadv-net" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="settadv-status" class="input-field"><option value="pending">대기</option><option value="transferred">지급완료</option></select></div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="settadv-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('settAdvanceModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 세무서류 업로드 모달 -->
    <div id="taxUploadModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-lime-400">📤 세무서류 업로드</h3><button onclick="closeModal('taxUploadModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="taxUploadForm" onsubmit="submitTaxUpload(event)" class="space-y-4">
                <div><label class="block text-sm text-lime-400 mb-1">카테고리 *</label>
                    <select id="taxdoc-category" class="input-field" required>
                        <option value="">선택</option>
                        <option value="withholding">원천세 신고</option>
                        <option value="statement">지급명세서</option>
                        <option value="other">기타 서류</option>
                    </select>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">서류일자</label>
                    <input type="date" id="taxdoc-date" class="input-field">
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">파일 선택 *</label>
                    <input type="file" id="taxdoc-file" class="input-field" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.doc,.docx" required>
                    <p class="text-gray-500 text-xs mt-1">PDF, 이미지, 엑셀, 워드 파일 지원</p>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">설명</label>
                    <input type="text" id="taxdoc-desc" class="input-field" placeholder="2025년 1월 원천세 신고서">
                </div>
                <div id="uploadProgress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="uploadProgressBar" class="bg-lime-400 h-2 rounded-full transition-all" style="width:0%"></div>
                    </div>
                    <p class="text-center text-sm text-gray-400 mt-1">업로드 중...</p>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('taxUploadModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">업로드</button></div>
            </form>
        </div>
    </div>

    <!-- 현금출납장 모달 -->
    <div id="bankModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-lime-400">📒 거래 등록</h3><button onclick="closeModal('bankModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="bankForm" onsubmit="submitCashbook(event)" class="space-y-4">
                <input type="hidden" id="bank-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">일자 *</label><input type="date" id="bank-date" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">구분 *</label><select id="bank-type" class="input-field" required onchange="toggleCashbookLink()"><option value="deposit">입금</option><option value="withdrawal">출금</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">거래처</label><input type="text" id="bank-counterparty" class="input-field" placeholder="배민, 협력사A 등"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">금액 *</label><input type="number" id="bank-amount" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">적요</label><input type="text" id="bank-desc" class="input-field" placeholder="W03 정산금, 선정산 지급 등"></div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">🔗 연결 (선택)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">연결유형</label>
                            <select id="bank-link-type" class="input-field" onchange="loadLinkOptions()">
                                <option value="">연결안함</option>
                                <option value="platform">플랫폼 정산</option>
                                <option value="advance">선정산 지급</option>
                                <option value="weekly">주정산 지급</option>
                            </select>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">연결대상</label>
                            <select id="bank-link-id" class="input-field"><option value="">선택</option></select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="bank-memo2" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('bankModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 매입매출장 모달 -->
    <div id="salesPurchaseModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-lime-400">📋 매입매출 등록</h3><button onclick="closeModal('salesPurchaseModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="salesPurchaseForm" onsubmit="submitSalesPurchase(event)" class="space-y-4">
                <input type="hidden" id="sp-id">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">일자 *</label><input type="date" id="sp-date" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">구분 *</label>
                        <select id="sp-type" class="input-field" required onchange="toggleSPType()">
                            <option value="sales">매출</option>
                            <option value="purchase">매입</option>
                        </select>
                    </div>
                    <div><label class="block text-sm text-lime-400 mb-1">세금계산서</label>
                        <select id="sp-tax-status" class="input-field">
                            <option value="pending">미발행</option>
                            <option value="issued">발행</option>
                            <option value="received">수취</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">거래처 *</label><input type="text" id="sp-counterparty" class="input-field" placeholder="배민, 협력사A 등" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">품목</label><input type="text" id="sp-item" class="input-field" placeholder="W03 정산금, 용역비 등"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-lime-400 font-bold mb-3">💰 금액</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">공급가액 *</label><input type="number" id="sp-supply" class="input-field" value="0" required onchange="calcSPTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">부가세 (10%)</label><input type="number" id="sp-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">합계</label><input type="number" id="sp-total" class="input-field font-bold" value="0" readonly></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">🔗 연결 (선택)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">연결유형</label>
                            <select id="sp-link-type" class="input-field" onchange="loadSPLinkOptions()">
                                <option value="">연결안함</option>
                                <option value="platform">플랫폼 정산</option>
                                <option value="advance">선정산 지급</option>
                            </select>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">연결대상</label>
                            <select id="sp-link-id" class="input-field"><option value="">선택</option></select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="sp-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('salesPurchaseModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>
    <div id="weeklyPayoutModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-lime-400">📆 주정산 지급 등록</h3><button onclick="closeModal('weeklyPayoutModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="weeklyPayoutForm" onsubmit="submitWeeklyPayout(event)" class="space-y-4">
                <input type="hidden" id="weekly-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">정산주차 *</label><input type="text" id="weekly-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">지급일 *</label><input type="date" id="weekly-date" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">라이더 *</label><select id="weekly-rider" class="input-field" required><option value="">선택</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">협력사</label><select id="weekly-partner" class="input-field"><option value="">선택</option></select></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-lime-400 font-bold mb-3">📊 배달 실적</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">배달건수</label><input type="number" id="weekly-count" class="input-field" value="0"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">배달수익</label><input type="number" id="weekly-revenue" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-red-400 font-bold mb-3">💸 공제 항목</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">수수료</label><input type="number" id="weekly-fee" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">보험료</label><input type="number" id="weekly-insurance" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">기타공제</label><input type="number" id="weekly-other" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">총 공제액</label><input type="number" id="weekly-deduction" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">실지급액</label><input type="number" id="weekly-net" class="input-field font-bold text-lime-400" value="0" readonly></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="weekly-status" class="input-field"><option value="pending">대기</option><option value="paid">지급완료</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">지급계좌</label><input type="text" id="weekly-account" class="input-field" placeholder="은행 계좌번호"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="weekly-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('weeklyPayoutModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 세금계산서 모달 -->
    <div id="taxInvoiceModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="taxInvoiceModalTitle" class="text-xl font-bold text-lime-400">🧾 세금계산서 등록</h3><button onclick="closeModal('taxInvoiceModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="taxInvoiceForm" onsubmit="submitTaxInvoice(event)" class="space-y-4">
                <input type="hidden" id="inv-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">유형 *</label><select id="inv-type" class="input-field" required><option value="purchase">매입</option><option value="sales">매출</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">발행일 *</label><input type="date" id="inv-date" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">거래처명 *</label><input type="text" id="inv-vendor" class="input-field" required placeholder="거래처명"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">사업자번호</label><input type="text" id="inv-bizno" class="input-field" placeholder="123-45-67890"></div>
                    <div><label class="block text-sm text-lime-400 mb-1">대표자명</label><input type="text" id="inv-ceo" class="input-field"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-lime-400 font-bold mb-3">💰 금액</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">공급가액</label><input type="number" id="inv-supply" class="input-field" value="0" onchange="calcTaxInvoice()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">부가세 (10%)</label><input type="number" id="inv-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">합계</label><input type="number" id="inv-total" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">지급상태</label><select id="inv-status" class="input-field"><option value="unpaid">미지급</option><option value="paid">지급완료</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">지급일</label><input type="date" id="inv-paiddate" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">품목</label><input type="text" id="inv-item" class="input-field" placeholder="품목/서비스명"></div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="inv-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('taxInvoiceModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

    <!-- 분개 모달 -->
    <div id="journalModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4"><h3 id="journalModalTitle" class="text-xl font-bold text-lime-400">📊 분개 등록</h3><button onclick="closeModal('journalModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="journalForm" onsubmit="submitJournal(event)" class="space-y-4">
                <input type="hidden" id="jnl-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">일자 *</label><input type="date" id="jnl-date" class="input-field" required></div>
                    <div><label class="block text-sm text-lime-400 mb-1">분개번호</label><input type="text" id="jnl-number" class="input-field" placeholder="자동생성" readonly></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">📥 차변 (Debit)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">계정과목</label><select id="jnl-debit-account" class="input-field">
                            <option value="">선택</option>
                            <optgroup label="자산"><option value="101-현금">현금</option><option value="102-보통예금">보통예금</option><option value="108-매출채권">매출채권</option><option value="120-재고자산">재고자산</option></optgroup>
                            <optgroup label="비용"><option value="501-급여">급여</option><option value="502-임차료">임차료</option><option value="503-통신비">통신비</option><option value="504-소모품비">소모품비</option><option value="510-차량유지비">차량유지비</option></optgroup>
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">금액</label><input type="number" id="jnl-debit-amount" class="input-field" value="0"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-red-400 font-bold mb-3">📤 대변 (Credit)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">계정과목</label><select id="jnl-credit-account" class="input-field">
                            <option value="">선택</option>
                            <optgroup label="부채"><option value="201-매입채무">매입채무</option><option value="210-미지급금">미지급금</option><option value="220-예수금">예수금</option></optgroup>
                            <optgroup label="자산"><option value="101-현금">현금</option><option value="102-보통예금">보통예금</option></optgroup>
                            <optgroup label="수익"><option value="401-매출">매출</option><option value="402-수수료수익">수수료수익</option></optgroup>
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">금액</label><input type="number" id="jnl-credit-amount" class="input-field" value="0"></div>
                    </div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">적요 *</label><input type="text" id="jnl-desc" class="input-field" placeholder="거래 내용" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-lime-400 mb-1">상태</label><select id="jnl-status" class="input-field"><option value="created">생성</option><option value="confirmed">확정</option></select></div>
                    <div><label class="block text-sm text-lime-400 mb-1">증빙</label><input type="text" id="jnl-evidence" class="input-field" placeholder="영수증번호 등"></div>
                </div>
                <div><label class="block text-sm text-lime-400 mb-1">메모</label><textarea id="jnl-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('journalModal')" class="flex-1 btn-secondary">취소</button><button type="submit" class="flex-1 btn-primary">저장</button></div>
            </form>
        </div>
    </div>

<script>
const SUPABASE_URL = 'https://jizaefuhiikpkcxolibc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppemFlZnVoaWlrcGtjeG9saWJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDM3MDIsImV4cCI6MjA4MzY3OTcwMn0.WXFNYvSl1n9pp0yZpD8ndNZdEHvL53wtDzrJz9Y_ssg';

let currentUser = null;
let riderList = [], partnerList = [], salesList = [], userList = [], settlementList = [];
let cardList = [], cardTransList = [], taxInvoiceList = [], journalList = [], auditLogList = [];
let employeeList = [], payrollList = [];
let platformList = [], advanceTransferList = [], reconcileList = [], bankList = [], weeklyPayoutList = [];
let salesPurchaseList = [];

async function supabaseCall(table, method, body = null, query = '') {
    try {
        const options = { method, headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': method === 'POST' ? 'return=representation' : '' } };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + query, options);
        if (!res.ok) throw new Error('API Error: ' + res.status);
        const text = await res.text();
        return text ? JSON.parse(text) : null;
    } catch (e) { console.error('Supabase Error:', e); return null; }
}

function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.textContent = msg;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function toggleMenu(menu) {
    const el = document.getElementById('menu-' + menu);
    const arrow = document.getElementById('arrow-' + menu);
    if (el.classList.contains('hidden')) {
        el.classList.remove('hidden');
        arrow.textContent = '▼';
    } else {
        el.classList.add('hidden');
        arrow.textContent = '▶';
    }
}

let sidebarOpen = true;
function toggleSidebar() {
    const sidebar = document.getElementById('sidebarMenu');
    if (sidebarOpen) {
        sidebar.style.display = 'none';
        sidebarOpen = false;
    } else {
        sidebar.style.display = 'block';
        sidebarOpen = true;
    }
}

function showTab(tab) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('nav-' + tab);
    if (btn) btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    const tabEl = document.getElementById('tab-' + tab);
    if (tabEl) tabEl.classList.remove('hidden');
    
    // 기초정보
    if (tab === 'dashboard') loadDashboard();
    if (tab === 'riders') { loadStats('rider'); renderTable('rider'); loadPartnerOptions(); }
    if (tab === 'partners') { loadStats('partner'); renderTable('partner'); }
    if (tab === 'sales') { loadStats('sales'); renderTable('sales'); }
    
    // 정산관리
    if (tab === 'sett-dashboard') loadSettlementDashboard();
    if (tab === 'platform') renderPlatformTable();
    if (tab === 'sett-advance') { renderSettAdvanceTable(); loadSettAdvancePartnerOptions(); }
    if (tab === 'weekly-payout') { renderWeeklyPayoutTable(); loadWeeklyPayoutOptions(); }
    if (tab === 'reconcile') renderReconcileTable();
    
    // 재무관리
    if (tab === 'bank') renderCashbookTable();
    if (tab === 'accounting') { renderSalesPurchaseTable(); }
    if (tab === 'taxinvoice') renderTaxInvoiceTable();
    if (tab === 'ledger') renderLedgerTable();
    if (tab === 'journal') renderJournalTable();
    
    // 카드/자산
    if (tab === 'cards') renderCardTable();
    if (tab === 'card-usage') renderCardTransTable();
    
    // 인사관리
    if (tab === 'employees') renderEmployeeTable();
    if (tab === 'payroll') renderPayrollTable();
    if (tab === 'contracts') { loadContractEmpOptions(); renderContractTable(); }
    
    // 문서/세무
    if (tab === 'tax') { loadTaxDocuments(); }
    
    // 시스템
    if (tab === 'users') renderUserTable();
    if (tab === 'logs') renderAuditLogs();
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const users = await supabaseCall('hq_users', 'GET', null, '?username=eq.' + encodeURIComponent(username));
    if (users && users.length > 0 && users[0].password_hash === password && users[0].is_active) {
        currentUser = users[0];
        sessionStorage.setItem('teambro_hq_session', JSON.stringify({ userId: currentUser.id, timestamp: Date.now() }));
        await loadAllData();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainSystem').classList.remove('hidden');
        document.getElementById('headerUserName').textContent = currentUser.name;
        loadDashboard();
        showToast(currentUser.name + '님 환영합니다!');
    } else {
        document.getElementById('loginError').textContent = '로그인 실패';
        document.getElementById('loginError').classList.remove('hidden');
    }
}

function logout() {
    sessionStorage.removeItem('teambro_hq_session');
    document.getElementById('mainSystem').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
}

async function restoreSession() {
    const data = sessionStorage.getItem('teambro_hq_session');
    if (!data) return false;
    try {
        const session = JSON.parse(data);
        if (Date.now() - session.timestamp > 86400000) return false;
        const users = await supabaseCall('hq_users', 'GET', null, '?id=eq.' + session.userId);
        if (!users || !users.length || !users[0].is_active) return false;
        currentUser = users[0];
        await loadAllData();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainSystem').classList.remove('hidden');
        document.getElementById('headerUserName').textContent = currentUser.name;
        loadDashboard();
        return true;
    } catch (e) { return false; }
}

async function loadAllData() {
    const [r, p, s, u, st, cd, ct, ti, jn, emp, pay, plat, advt, recon, bnk, wkly, sp] = await Promise.all([
        supabaseCall('riders', 'GET', null, '?order=created_at.desc'),
        supabaseCall('partners', 'GET', null, '?order=created_at.desc'),
        supabaseCall('sales_reps', 'GET', null, '?order=created_at.desc'),
        supabaseCall('hq_users', 'GET', null, '?order=id.asc'),
        supabaseCall('settlements', 'GET', null, '?order=created_at.desc'),
        supabaseCall('corporate_cards', 'GET', null, '?order=created_at.desc'),
        supabaseCall('card_transactions', 'GET', null, '?order=transaction_date.desc&limit=50'),
        supabaseCall('hq_tax_invoices', 'GET', null, '?order=invoice_date.desc'),
        supabaseCall('accounting_journals', 'GET', null, '?order=journal_date.desc'),
        supabaseCall('employees', 'GET', null, '?order=created_at.desc'),
        supabaseCall('payrolls', 'GET', null, '?order=pay_year.desc,pay_month.desc'),
        supabaseCall('platform_settlements', 'GET', null, '?order=created_at.desc'),
        supabaseCall('advance_transfers', 'GET', null, '?order=created_at.desc'),
        supabaseCall('settlement_reconciliation', 'GET', null, '?order=created_at.desc'),
        supabaseCall('bank_transactions', 'GET', null, '?order=transaction_date.desc'),
        supabaseCall('weekly_payouts', 'GET', null, '?order=created_at.desc'),
        supabaseCall('sales_purchases', 'GET', null, '?order=transaction_date.desc')
    ]);
    riderList = r || [];
    partnerList = p || [];
    salesList = s || [];
    userList = u || [];
    settlementList = st || [];
    cardList = cd || [];
    cardTransList = ct || [];
    taxInvoiceList = ti || [];
    journalList = jn || [];
    employeeList = emp || [];
    platformList = plat || [];
    advanceTransferList = advt || [];
    reconcileList = recon || [];
    bankList = bnk || [];
    weeklyPayoutList = wkly || [];
    payrollList = pay || [];
    salesPurchaseList = sp || [];
}

function loadDashboard() {
    document.getElementById('stat-riders').textContent = riderList.length + '명';
    document.getElementById('stat-partners').textContent = partnerList.length + '개';
    document.getElementById('stat-sales').textContent = salesList.length + '명';
}

function loadStats(type) {
    if (type === 'rider') {
        document.getElementById('rider-total').textContent = riderList.length;
        document.getElementById('rider-active').textContent = riderList.filter(r => r.status === 'active').length;
        document.getElementById('rider-inactive').textContent = riderList.filter(r => r.status === 'inactive').length;
        document.getElementById('rider-nossn').textContent = riderList.filter(r => !r.ssn).length;
    } else if (type === 'partner') {
        document.getElementById('partner-total').textContent = partnerList.length;
        document.getElementById('partner-biz').textContent = partnerList.filter(p => p.type === 'biz').length;
        document.getElementById('partner-nonbiz').textContent = partnerList.filter(p => p.type !== 'biz').length;
        document.getElementById('partner-riders').textContent = riderList.filter(r => r.partner_id).length;
    } else if (type === 'sales') {
        document.getElementById('sales-total').textContent = salesList.length;
        document.getElementById('sales-ind').textContent = salesList.filter(s => s.sales_type === 'individual').length;
        document.getElementById('sales-sole').textContent = salesList.filter(s => s.sales_type === 'sole_prop').length;
        document.getElementById('sales-corp').textContent = salesList.filter(s => s.sales_type === 'corporation').length;
    } else if (type === 'settlement') {
        document.getElementById('sett-total').textContent = settlementList.length;
        document.getElementById('sett-pending').textContent = settlementList.filter(s => s.status === 'pending').length;
        document.getElementById('sett-confirmed').textContent = settlementList.filter(s => s.status === 'confirmed').length;
        document.getElementById('sett-paid').textContent = settlementList.filter(s => s.status === 'paid').length;
        const total = settlementList.reduce((sum, s) => sum + parseFloat(s.gross_amount || 0), 0);
        document.getElementById('sett-amount').textContent = '₩' + total.toLocaleString();
    }
}

function renderTable(type) {
    if (type === 'rider') {
        const sf = document.getElementById('riderStatusFilter').value;
        const pf = document.getElementById('riderPartnerFilter').value;
        const q = (document.getElementById('riderSearch').value || '').toLowerCase();
        let list = riderList;
        if (sf) list = list.filter(r => r.status === sf);
        if (pf) list = list.filter(r => r.partner_id == pf);
        if (q) list = list.filter(r => (r.name||'').toLowerCase().includes(q) || (r.phone||'').includes(q));
        const tbody = document.getElementById('riderTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
        tbody.innerHTML = list.map(r => {
            const p = partnerList.find(x => x.id == r.partner_id);
            return '<tr><td class="font-bold">' + r.name + '</td><td>' + (r.phone||'-') + '</td><td>' + (p?p.name:'-') + '</td><td>' + (r.tax_type||'-') + '</td><td><span class="badge ' + (r.status==='active'?'badge-active">활성':'badge-inactive">비활성') + '</span></td><td><button onclick="editItem(\'rider\',' + r.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
        }).join('');
    } else if (type === 'partner') {
        const tbody = document.getElementById('partnerTableBody');
        if (!partnerList.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
        tbody.innerHTML = partnerList.map(p => {
            const cnt = riderList.filter(r => r.partner_id == p.id).length;
            return '<tr><td class="font-bold">' + p.name + '</td><td>' + (p.code||'-') + '</td><td><span class="badge ' + (p.type==='biz'?'badge-biz">사업자':'badge-nonbiz">비사업자') + '</span></td><td>' + (p.rep_name||'-') + '</td><td>' + (p.phone||'-') + '</td><td>' + cnt + '명</td><td><button onclick="editItem(\'partner\',' + p.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
        }).join('');
    } else if (type === 'sales') {
        const sf = document.getElementById('salesStatusFilter').value;
        const tf = document.getElementById('salesTypeFilter').value;
        const q = (document.getElementById('salesSearch').value || '').toLowerCase();
        let list = salesList;
        if (sf) list = list.filter(s => s.status === sf);
        if (tf) list = list.filter(s => s.sales_type === tf);
        if (q) list = list.filter(s => (s.name||'').toLowerCase().includes(q) || (s.sales_code||'').toLowerCase().includes(q));
        const tbody = document.getElementById('salesTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
        const types = { individual: '개인', sole_prop: '개인사업자', corporation: '법인' };
        const cycles = { monthly: '월', weekly: '주', per_case: '건별' };
        tbody.innerHTML = list.map(s => '<tr><td class="font-bold text-lime-400">' + (s.sales_code||'-') + '</td><td>' + s.name + '</td><td><span class="badge badge-biz">' + (types[s.sales_type]||s.sales_type) + '</span></td><td>' + (s.phone||'-') + '</td><td>' + (cycles[s.payout_cycle]||'-') + '</td><td>' + (s.withholding_rate?(parseFloat(s.withholding_rate)*100).toFixed(1)+'%':'-') + '</td><td><span class="badge ' + (s.status==='active'?'badge-active">활성':'badge-inactive">비활성') + '</span></td><td><button onclick="editItem(\'sales\',' + s.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
    } else if (type === 'settlement') {
        const wf = document.getElementById('settWeekFilter').value;
        const sf = document.getElementById('settStatusFilter').value;
        const pf = document.getElementById('settPartnerFilter').value;
        const q = (document.getElementById('settSearch').value || '').toLowerCase();
        let list = settlementList;
        if (wf) list = list.filter(s => s.settlement_week === wf);
        if (sf) list = list.filter(s => s.status === sf);
        if (pf) list = list.filter(s => s.partner_id == pf);
        if (q) { const rids = riderList.filter(r => (r.name||'').toLowerCase().includes(q)).map(r => r.id); list = list.filter(s => rids.includes(s.rider_id)); }
        const tbody = document.getElementById('settlementTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
        const statuses = { pending: '대기', confirmed: '확정', paid: '지급완료' };
        const statusClass = { pending: 'badge-pending', confirmed: 'badge-biz', paid: 'badge-active' };
        tbody.innerHTML = list.map(s => {
            const r = riderList.find(x => x.id == s.rider_id);
            const p = partnerList.find(x => x.id == s.partner_id);
            return '<tr><td class="font-bold text-lime-400">' + (s.settlement_week||'-') + '</td><td class="text-xs">' + (s.work_start_date||'') + '<br>~' + (s.work_end_date||'') + '</td><td>' + (r?r.name:'-') + '</td><td>' + (p?p.name:'-') + '</td><td class="text-right">₩' + parseInt(s.gross_amount||0).toLocaleString() + '</td><td class="text-right text-red-400">₩' + parseInt(s.deduction_amount||0).toLocaleString() + '</td><td class="text-right text-purple-400">₩' + parseInt(s.advance_amount||0).toLocaleString() + '</td><td class="text-right font-bold text-green-400">₩' + parseInt(s.net_amount||0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[s.status]||'badge-inactive') + '">' + (statuses[s.status]||s.status) + '</span></td><td><button onclick="editSettlement(' + s.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
        }).join('');
    }
}

function filterList(type, status) {
    if (type === 'rider') { document.getElementById('riderStatusFilter').value = status; renderTable('rider'); }
}

function loadPartnerOptions() {
    const opt = '<option value="">전체 협력사</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    document.getElementById('riderPartnerFilter').innerHTML = opt;
    document.getElementById('rider-partner').innerHTML = '<option value="">선택안함</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

function toggleBizFields() { document.getElementById('partnerBizFields').classList.toggle('hidden', document.getElementById('partner-type').value !== 'biz'); }
function toggleSalesBizFields() { document.getElementById('salesBizFields').classList.toggle('hidden', document.getElementById('sales-type').value === 'individual'); }

function openRiderModal() { document.getElementById('riderModalTitle').textContent = '🏍️ 라이더 등록'; document.getElementById('riderForm').reset(); document.getElementById('rider-id').value = ''; openModal('riderModal'); }
function openPartnerModal() { document.getElementById('partnerModalTitle').textContent = '🤝 협력사 등록'; document.getElementById('partnerForm').reset(); document.getElementById('partner-id').value = ''; document.getElementById('partnerBizFields').classList.add('hidden'); openModal('partnerModal'); }
function openSalesModal() { document.getElementById('salesModalTitle').textContent = '💼 영업자 등록'; document.getElementById('salesForm').reset(); document.getElementById('sales-id').value = ''; document.getElementById('salesBizFields').classList.add('hidden'); openModal('salesModal'); }

function editItem(type, id) {
    if (type === 'rider') {
        const r = riderList.find(x => x.id === id); if (!r) return;
        document.getElementById('riderModalTitle').textContent = '🏍️ 라이더 수정';
        document.getElementById('rider-id').value = r.id;
        document.getElementById('rider-name').value = r.name || '';
        document.getElementById('rider-phone').value = r.phone || '';
        document.getElementById('rider-partner').value = r.partner_id || '';
        document.getElementById('rider-status').value = r.status || 'active';
        document.getElementById('rider-address').value = r.address || '';
        document.getElementById('rider-bank').value = r.bank || '';
        document.getElementById('rider-account-no').value = r.account_no || '';
        document.getElementById('rider-account-holder').value = r.account_holder || '';
        document.getElementById('rider-ssn').value = r.ssn || '';
        document.getElementById('rider-tax-type').value = r.tax_type || '';
        document.getElementById('rider-memo').value = r.memo || '';
        openModal('riderModal');
    } else if (type === 'partner') {
        const p = partnerList.find(x => x.id === id); if (!p) return;
        document.getElementById('partnerModalTitle').textContent = '🤝 협력사 수정';
        document.getElementById('partner-id').value = p.id;
        document.getElementById('partner-name').value = p.name || '';
        document.getElementById('partner-code').value = p.code || '';
        document.getElementById('partner-type').value = p.type || 'non_biz';
        document.getElementById('partner-rep').value = p.rep_name || '';
        document.getElementById('partner-phone').value = p.phone || '';
        document.getElementById('partner-email').value = p.email || '';
        document.getElementById('partner-bizno').value = p.biz_no || '';
        document.getElementById('partner-biztype').value = p.biz_type || '';
        document.getElementById('partner-address').value = p.address || '';
        document.getElementById('partner-bank').value = p.bank || '';
        document.getElementById('partner-accountno').value = p.account_no || '';
        document.getElementById('partner-memo').value = p.memo || '';
        toggleBizFields();
        openModal('partnerModal');
    } else if (type === 'sales') {
        const s = salesList.find(x => x.id === id); if (!s) return;
        document.getElementById('salesModalTitle').textContent = '💼 영업자 수정';
        document.getElementById('sales-id').value = s.id;
        document.getElementById('sales-code').value = s.sales_code || '';
        document.getElementById('sales-type').value = s.sales_type || 'individual';
        document.getElementById('sales-name').value = s.name || '';
        document.getElementById('sales-phone').value = s.phone || '';
        document.getElementById('sales-email').value = s.email || '';
        document.getElementById('sales-region').value = s.region || '';
        document.getElementById('sales-bizno').value = s.biz_no || '';
        document.getElementById('sales-repname').value = s.rep_name || '';
        document.getElementById('sales-address').value = s.address || '';
        document.getElementById('sales-bank').value = s.bank_name || '';
        document.getElementById('sales-bank-holder').value = s.bank_holder || '';
        document.getElementById('sales-bank-account').value = s.bank_account || '';
        document.getElementById('sales-payout-cycle').value = s.payout_cycle || 'monthly';
        document.getElementById('sales-withholding-rate').value = s.withholding_rate || '0.033';
        document.getElementById('sales-status').value = s.status || 'active';
        document.getElementById('sales-memo').value = s.memo || '';
        toggleSalesBizFields();
        openModal('salesModal');
    }
}

async function submitForm(type, e) {
    e.preventDefault();
    let id, data, table, list;
    if (type === 'rider') {
        id = document.getElementById('rider-id').value;
        data = { name: document.getElementById('rider-name').value, phone: document.getElementById('rider-phone').value || null, partner_id: document.getElementById('rider-partner').value || null, status: document.getElementById('rider-status').value, address: document.getElementById('rider-address').value || null, bank: document.getElementById('rider-bank').value || null, account_no: document.getElementById('rider-account-no').value || null, account_holder: document.getElementById('rider-account-holder').value || null, ssn: document.getElementById('rider-ssn').value || null, tax_type: document.getElementById('rider-tax-type').value || null, memo: document.getElementById('rider-memo').value || null };
        table = 'riders'; list = riderList;
    } else if (type === 'partner') {
        id = document.getElementById('partner-id').value;
        data = { name: document.getElementById('partner-name').value, code: document.getElementById('partner-code').value, type: document.getElementById('partner-type').value, rep_name: document.getElementById('partner-rep').value || null, phone: document.getElementById('partner-phone').value || null, email: document.getElementById('partner-email').value || null, biz_no: document.getElementById('partner-bizno').value || null, biz_type: document.getElementById('partner-biztype').value || null, address: document.getElementById('partner-address').value || null, bank: document.getElementById('partner-bank').value || null, account_no: document.getElementById('partner-accountno').value || null, memo: document.getElementById('partner-memo').value || null };
        table = 'partners'; list = partnerList;
    } else if (type === 'sales') {
        id = document.getElementById('sales-id').value;
        data = { sales_code: document.getElementById('sales-code').value, sales_type: document.getElementById('sales-type').value, name: document.getElementById('sales-name').value, phone: document.getElementById('sales-phone').value || null, email: document.getElementById('sales-email').value || null, region: document.getElementById('sales-region').value || null, biz_no: document.getElementById('sales-bizno').value || null, rep_name: document.getElementById('sales-repname').value || null, address: document.getElementById('sales-address').value || null, bank_name: document.getElementById('sales-bank').value || null, bank_holder: document.getElementById('sales-bank-holder').value || null, bank_account: document.getElementById('sales-bank-account').value || null, payout_cycle: document.getElementById('sales-payout-cycle').value, withholding_rate: parseFloat(document.getElementById('sales-withholding-rate').value), withholding_enabled: true, status: document.getElementById('sales-status').value, memo: document.getElementById('sales-memo').value || null };
        table = 'sales_reps'; list = salesList;
    }
    try {
        if (id) {
            await supabaseCall(table, 'PATCH', data, '?id=eq.' + id);
            const idx = list.findIndex(x => x.id == id);
            if (idx >= 0) list[idx] = { ...list[idx], ...data };
            showToast('수정 완료');
        } else {
            const r = await supabaseCall(table, 'POST', data);
            if (r && r[0]) list.unshift(r[0]);
            showToast('등록 완료');
        }
        closeModal(type + 'Modal');
        loadStats(type); renderTable(type); loadDashboard();
        if (type === 'partner') loadPartnerOptions();
    } catch (err) { showToast('저장 실패', 'error'); }
}

// 정산 관리
function loadSettlementFilters() {
    const weeks = [...new Set(settlementList.map(s => s.settlement_week))].sort().reverse();
    document.getElementById('settWeekFilter').innerHTML = '<option value="">전체 주차</option>' + weeks.map(w => '<option value="' + w + '">' + w + '</option>').join('');
    document.getElementById('settPartnerFilter').innerHTML = '<option value="">전체 협력사</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    document.getElementById('sett-rider').innerHTML = '<option value="">선택</option>' + riderList.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    document.getElementById('sett-partner').innerHTML = '<option value="">선택</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

function filterSettlement(status) { document.getElementById('settStatusFilter').value = status; renderTable('settlement'); }

function openSettlementModal() {
    document.getElementById('settlementModalTitle').textContent = '💰 정산 등록';
    document.getElementById('settlementForm').reset();
    document.getElementById('sett-id').value = '';
    loadSettlementFilters();
    calcSettlement();
    openModal('settlementModal');
}

function editSettlement(id) {
    const s = settlementList.find(x => x.id === id); if (!s) return;
    document.getElementById('settlementModalTitle').textContent = '💰 정산 수정';
    document.getElementById('sett-id').value = s.id;
    document.getElementById('sett-week').value = s.settlement_week || '';
    document.getElementById('sett-start').value = s.work_start_date || '';
    document.getElementById('sett-end').value = s.work_end_date || '';
    document.getElementById('sett-paydate').value = s.payment_date || '';
    document.getElementById('sett-rider').value = s.rider_id || '';
    document.getElementById('sett-partner').value = s.partner_id || '';
    document.getElementById('sett-platform').value = s.platform || '';
    document.getElementById('sett-delivery').value = s.delivery_fee || 0;
    document.getElementById('sett-mission').value = s.mission_fee || 0;
    document.getElementById('sett-extra').value = s.extra_pay || 0;
    document.getElementById('sett-payback').value = s.payback || 0;
    document.getElementById('sett-incentive').value = s.incentive || 0;
    document.getElementById('sett-tip').value = s.tip || 0;
    document.getElementById('sett-insurance').value = s.insurance_fee || 0;
    document.getElementById('sett-rental').value = s.rental_fee || 0;
    document.getElementById('sett-penalty').value = s.penalty || 0;
    document.getElementById('sett-other').value = s.other_deduction || 0;
    document.getElementById('sett-advance').value = s.advance_amount || 0;
    document.getElementById('sett-status').value = s.status || 'pending';
    document.getElementById('sett-memo').value = s.memo || '';
    loadSettlementFilters();
    calcSettlement();
    openModal('settlementModal');
}

function calcSettlement() {
    const gross = parseFloat(document.getElementById('sett-delivery').value||0) + parseFloat(document.getElementById('sett-mission').value||0) + parseFloat(document.getElementById('sett-extra').value||0) + parseFloat(document.getElementById('sett-payback').value||0) + parseFloat(document.getElementById('sett-incentive').value||0) + parseFloat(document.getElementById('sett-tip').value||0);
    const deduct = parseFloat(document.getElementById('sett-insurance').value||0) + parseFloat(document.getElementById('sett-rental').value||0) + parseFloat(document.getElementById('sett-penalty').value||0) + parseFloat(document.getElementById('sett-other').value||0);
    const advance = parseFloat(document.getElementById('sett-advance').value||0);
    const net = gross - deduct - advance;
    document.getElementById('calc-gross').textContent = '₩' + gross.toLocaleString();
    document.getElementById('calc-deduct').textContent = '₩' + deduct.toLocaleString();
    document.getElementById('calc-advance').textContent = '₩' + advance.toLocaleString();
    document.getElementById('calc-net').textContent = '₩' + net.toLocaleString();
}

async function submitSettlement(e) {
    e.preventDefault();
    const id = document.getElementById('sett-id').value;
    const gross = parseFloat(document.getElementById('sett-delivery').value||0) + parseFloat(document.getElementById('sett-mission').value||0) + parseFloat(document.getElementById('sett-extra').value||0) + parseFloat(document.getElementById('sett-payback').value||0) + parseFloat(document.getElementById('sett-incentive').value||0) + parseFloat(document.getElementById('sett-tip').value||0);
    const deduct = parseFloat(document.getElementById('sett-insurance').value||0) + parseFloat(document.getElementById('sett-rental').value||0) + parseFloat(document.getElementById('sett-penalty').value||0) + parseFloat(document.getElementById('sett-other').value||0);
    const advance = parseFloat(document.getElementById('sett-advance').value||0);
    const data = {
        settlement_week: document.getElementById('sett-week').value,
        work_start_date: document.getElementById('sett-start').value || null,
        work_end_date: document.getElementById('sett-end').value || null,
        payment_date: document.getElementById('sett-paydate').value || null,
        rider_id: document.getElementById('sett-rider').value || null,
        partner_id: document.getElementById('sett-partner').value || null,
        platform: document.getElementById('sett-platform').value || null,
        delivery_fee: document.getElementById('sett-delivery').value || 0,
        mission_fee: document.getElementById('sett-mission').value || 0,
        extra_pay: document.getElementById('sett-extra').value || 0,
        payback: document.getElementById('sett-payback').value || 0,
        incentive: document.getElementById('sett-incentive').value || 0,
        tip: document.getElementById('sett-tip').value || 0,
        insurance_fee: document.getElementById('sett-insurance').value || 0,
        rental_fee: document.getElementById('sett-rental').value || 0,
        penalty: document.getElementById('sett-penalty').value || 0,
        other_deduction: document.getElementById('sett-other').value || 0,
        gross_amount: gross,
        deduction_amount: deduct,
        advance_amount: advance,
        net_amount: gross - deduct - advance,
        status: document.getElementById('sett-status').value,
        memo: document.getElementById('sett-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('settlements', 'PATCH', data, '?id=eq.' + id);
            const idx = settlementList.findIndex(x => x.id == id);
            if (idx >= 0) settlementList[idx] = { ...settlementList[idx], ...data };
            showToast('정산 수정 완료');
        } else {
            const r = await supabaseCall('settlements', 'POST', data);
            if (r && r[0]) settlementList.unshift(r[0]);
            showToast('정산 등록 완료');
        }
        closeModal('settlementModal');
        loadStats('settlement');
        renderTable('settlement');
    } catch (err) { showToast('저장 실패', 'error'); }
}

// 사용자 관리
function renderUserTable() {
    const tbody = document.getElementById('userTableBody');
    if (!userList.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    tbody.innerHTML = userList.map(u => '<tr><td class="font-bold">' + u.name + '</td><td>' + u.username + '</td><td><span class="badge ' + (u.role==='ADMIN'?'badge-active':'badge-inactive') + '">' + u.role + '</span></td><td><span class="badge ' + (u.is_active?'badge-active">활성':'badge-inactive">비활성') + '</span></td><td><button onclick="editUser(' + u.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

function openUserModal() { document.getElementById('userModalTitle').textContent = '👤 사용자 등록'; document.getElementById('userForm').reset(); document.getElementById('user-id').value = ''; openModal('userModal'); }

function editUser(id) {
    const u = userList.find(x => x.id === id); if (!u) return;
    document.getElementById('userModalTitle').textContent = '👤 사용자 수정';
    document.getElementById('user-id').value = u.id;
    document.getElementById('user-name').value = u.name || '';
    document.getElementById('user-username').value = u.username || '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = u.role || 'STAFF';
    document.getElementById('user-status').value = u.is_active ? 'true' : 'false';
    openModal('userModal');
}

async function submitUser(e) {
    e.preventDefault();
    const id = document.getElementById('user-id').value;
    const data = { name: document.getElementById('user-name').value, username: document.getElementById('user-username').value, role: document.getElementById('user-role').value, is_active: document.getElementById('user-status').value === 'true' };
    const pw = document.getElementById('user-password').value;
    if (pw) data.password_hash = pw;
    try {
        if (id) {
            await supabaseCall('hq_users', 'PATCH', data, '?id=eq.' + id);
            const idx = userList.findIndex(x => x.id == id);
            if (idx >= 0) userList[idx] = { ...userList[idx], ...data };
            showToast('사용자 수정 완료');
        } else {
            if (!pw) { showToast('비밀번호를 입력해주세요', 'error'); return; }
            const r = await supabaseCall('hq_users', 'POST', data);
            if (r && r[0]) userList.push(r[0]);
            showToast('사용자 등록 완료');
        }
        closeModal('userModal');
        renderUserTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

// 엑셀 기능
const TEMPLATES = {
    rider: { filename: '라이더_양식.xlsx', headers: ['이름*','연락처','협력사코드','주소','은행','예금주','계좌번호','주민번호','원천징수','상태','메모'], fields: ['name','phone','partner_code','address','bank','account_holder','account_no','ssn','tax_type','status','memo'], sample: ['홍길동','010-1234-5678','DP123','서울','KB','홍길동','1234567890','900101-1234567','3.3','active','메모'] },
    partner: { filename: '협력사_양식.xlsx', headers: ['협력사명*','협력사코드*','구분','대표자','연락처','이메일','사업자번호','업종','주소','은행','계좌번호','메모'], fields: ['name','code','type','rep_name','phone','email','biz_no','biz_type','address','bank','account_no','memo'], sample: ['배민팀브로','DP123','biz','김대표','02-1234-5678','test@test.com','123-45-67890','운송업','서울','KB','1234567890','메모'] },
    sales: { filename: '영업자_양식.xlsx', headers: ['영업자코드*','이름*','유형','연락처','이메일','지역','주소','사업자번호','대표자명','은행','예금주','계좌번호','원천징수율','지급주기','상태','메모'], fields: ['sales_code','name','sales_type','phone','email','region','address','biz_no','rep_name','bank_name','bank_holder','bank_account','withholding_rate','payout_cycle','status','memo'], sample: ['SB-0001','김영업','individual','010-1234-5678','sales@test.com','서울','서울시','','','KB','김영업','1234567890','0.033','monthly','active','메모'] },
    taxinvoice: { filename: '세금계산서_양식.xlsx', headers: ['유형(매입/매출)*','발행일*','거래처*','사업자번호','대표자','공급가액*','부가세','합계','지급상태','품목','메모'], sample: ['매입','2025-01-15','(주)테스트','123-45-67890','김대표','1000000','100000','1100000','미지급','물품대','메모'] },
    journal: { filename: '분개장_양식.xlsx', headers: ['일자*','분개번호','차변계정','차변금액*','대변계정','대변금액*','적요*','상태','메모'], sample: ['2025-01-15','JNL-001','102-보통예금','1000000','401-매출','1000000','매출대금 입금','생성','메모'] }
};

function downloadTemplate(type) {
    const tpl = TEMPLATES[type];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([tpl.headers, tpl.sample]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, tpl.filename);
    showToast('양식 다운로드 완료', 'info');
}

function exportToExcel(type) {
    let data, filename, headers;
    if (type === 'rider') {
        headers = ['이름','연락처','협력사','주소','은행','예금주','계좌번호','주민번호','원천징수','상태','메모'];
        data = riderList.map(r => { const p = partnerList.find(x => x.id == r.partner_id); return [r.name, r.phone, p?p.name:'', r.address, r.bank, r.account_holder, r.account_no, r.ssn, r.tax_type, r.status, r.memo]; });
        filename = '라이더목록.xlsx';
    } else if (type === 'partner') {
        headers = ['협력사명','코드','구분','대표자','연락처','이메일','사업자번호','업종','주소','은행','계좌번호','메모'];
        data = partnerList.map(p => [p.name, p.code, p.type, p.rep_name, p.phone, p.email, p.biz_no, p.biz_type, p.address, p.bank, p.account_no, p.memo]);
        filename = '협력사목록.xlsx';
    } else if (type === 'sales') {
        headers = ['코드','이름','유형','연락처','이메일','지역','주소','은행','예금주','계좌번호','원천징수율','지급주기','상태','메모'];
        data = salesList.map(s => [s.sales_code, s.name, s.sales_type, s.phone, s.email, s.region, s.address, s.bank_name, s.bank_holder, s.bank_account, s.withholding_rate, s.payout_cycle, s.status, s.memo]);
        filename = '영업자목록.xlsx';
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename);
    showToast('엑셀 다운로드 완료', 'info');
}

async function uploadExcel(type, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (rows.length < 2) { showToast('데이터 없음', 'error'); return; }
            const tpl = TEMPLATES[type];
            let count = 0;
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                const data = {};
                tpl.fields.forEach((f, idx) => {
                    if (row[idx] !== undefined && row[idx] !== '') {
                        if (f === 'partner_code') {
                            const p = partnerList.find(x => x.code === row[idx]);
                            if (p) data['partner_id'] = p.id;
                        } else if (f === 'withholding_rate') {
                            data[f] = parseFloat(row[idx]) || 0.033;
                        } else {
                            data[f] = row[idx];
                        }
                    }
                });
                if (!data.name && !data.sales_code) continue;
                const table = type === 'rider' ? 'riders' : type === 'partner' ? 'partners' : 'sales_reps';
                if (type === 'sales') data.withholding_enabled = true;
                const result = await supabaseCall(table, 'POST', data);
                if (result) count++;
            }
            showToast(count + '건 업로드 완료');
            await loadAllData();
            loadStats(type); renderTable(type); loadDashboard();
            if (type === 'partner') loadPartnerOptions();
        } catch (err) { console.error(err); showToast('업로드 실패', 'error'); }
    };
    reader.readAsBinaryString(file);
    input.value = '';
}

document.addEventListener('DOMContentLoaded', async () => {
    const restored = await restoreSession();
    document.getElementById('loadingScreen').classList.add('hidden');
    if (!restored) document.getElementById('loginPage').classList.remove('hidden');
});

// ==================== 법인카드 관리 ====================
function renderCardTable() {
    document.getElementById('card-total').textContent = cardList.length;
    document.getElementById('card-active').textContent = cardList.filter(c => c.status === 'active').length;
    document.getElementById('card-suspended').textContent = cardList.filter(c => c.status === 'suspended').length;
    const monthly = cardTransList.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    document.getElementById('card-monthly').textContent = '₩' + monthly.toLocaleString();
    
    const tbody = document.getElementById('cardTableBody');
    if (!cardList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const statuses = { active: '사용중', suspended: '일시중지', terminated: '해지' };
    const statusClass = { active: 'badge-active', suspended: 'badge-pending', terminated: 'badge-inactive' };
    tbody.innerHTML = cardList.map(c => '<tr><td class="font-bold">' + (c.card_alias || '-') + '</td><td>' + (c.card_number_masked || '-') + '</td><td>' + (c.card_company || '-') + '</td><td>' + (c.primary_user || '-') + '</td><td class="text-right">₩' + parseInt(c.daily_limit || 0).toLocaleString() + '</td><td class="text-right">₩' + parseInt(c.monthly_limit || 0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[c.status] || 'badge-inactive') + '">' + (statuses[c.status] || c.status) + '</span></td><td><button onclick="editCard(' + c.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

function renderCardTransTable() {
    const tbody = document.getElementById('cardTransTableBody');
    if (!cardTransList.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const evidenceStatus = { pending: '미제출', submitted: '제출', approved: '승인' };
    const accStatus = { pending: '미분개', journalized: '완료' };
    tbody.innerHTML = cardTransList.slice(0, 10).map(t => {
        const card = cardList.find(c => c.id == t.card_id);
        return '<tr><td>' + t.transaction_date + '</td><td>' + (card ? card.card_alias : '-') + '</td><td>' + (t.merchant_name || '-') + '</td><td class="text-right font-bold">₩' + parseInt(t.amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.evidence_status === 'approved' ? 'badge-active' : 'badge-pending') + '">' + (evidenceStatus[t.evidence_status] || '미제출') + '</span></td><td><span class="badge ' + (t.accounting_status === 'journalized' ? 'badge-active' : 'badge-pending') + '">' + (accStatus[t.accounting_status] || '미분개') + '</span></td></tr>';
    }).join('');
}

function openCardModal() {
    document.getElementById('cardModalTitle').textContent = '💳 카드 등록';
    document.getElementById('cardForm').reset();
    document.getElementById('card-id').value = '';
    openModal('cardModal');
}

function editCard(id) {
    const c = cardList.find(x => x.id === id); if (!c) return;
    document.getElementById('cardModalTitle').textContent = '💳 카드 수정';
    document.getElementById('card-id').value = c.id;
    document.getElementById('card-alias').value = c.card_alias || '';
    document.getElementById('card-company').value = c.company_name || '';
    document.getElementById('card-company-name').value = c.card_company || '';
    document.getElementById('card-number').value = c.card_number_masked || '';
    document.getElementById('card-bank').value = c.linked_bank_account || '';
    document.getElementById('card-valid').value = c.valid_until || '';
    document.getElementById('card-dept').value = c.department || '';
    document.getElementById('card-user').value = c.primary_user || '';
    document.getElementById('card-daily').value = c.daily_limit || 0;
    document.getElementById('card-monthly').value = c.monthly_limit || 0;
    document.getElementById('card-online').checked = c.allow_online !== false;
    document.getElementById('card-overseas').checked = c.allow_overseas === true;
    document.getElementById('card-issued').value = c.issued_at || '';
    document.getElementById('card-status').value = c.status || 'active';
    document.getElementById('card-memo').value = c.memo || '';
    openModal('cardModal');
}

async function submitCard(e) {
    e.preventDefault();
    const id = document.getElementById('card-id').value;
    const data = {
        card_alias: document.getElementById('card-alias').value,
        company_name: document.getElementById('card-company').value || null,
        card_company: document.getElementById('card-company-name').value,
        card_number_masked: document.getElementById('card-number').value || null,
        linked_bank_account: document.getElementById('card-bank').value || null,
        valid_until: document.getElementById('card-valid').value || null,
        department: document.getElementById('card-dept').value || null,
        primary_user: document.getElementById('card-user').value || null,
        daily_limit: parseFloat(document.getElementById('card-daily').value) || 0,
        monthly_limit: parseFloat(document.getElementById('card-monthly').value) || 0,
        allow_online: document.getElementById('card-online').checked,
        allow_overseas: document.getElementById('card-overseas').checked,
        issued_at: document.getElementById('card-issued').value || null,
        status: document.getElementById('card-status').value,
        memo: document.getElementById('card-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('corporate_cards', 'PATCH', data, '?id=eq.' + id);
            const idx = cardList.findIndex(x => x.id == id);
            if (idx >= 0) cardList[idx] = { ...cardList[idx], ...data };
            showToast('카드 수정 완료');
        } else {
            const r = await supabaseCall('corporate_cards', 'POST', data);
            if (r && r[0]) cardList.unshift(r[0]);
            showToast('카드 등록 완료');
        }
        closeModal('cardModal');
        renderCardTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

// ==================== 세금계산서 관리 ====================
function renderTaxInvoiceTable() {
    const purchases = taxInvoiceList.filter(t => t.invoice_type === 'purchase');
    const sales = taxInvoiceList.filter(t => t.invoice_type === 'sales');
    const unsynced = taxInvoiceList.filter(t => !t.synced_to_ledger);
    
    document.getElementById('inv-purchase').textContent = purchases.length;
    document.getElementById('inv-purchase-amt').textContent = '₩' + purchases.reduce((s, t) => s + parseFloat(t.total_amount || 0), 0).toLocaleString();
    document.getElementById('inv-sales').textContent = sales.length;
    document.getElementById('inv-sales-amt').textContent = '₩' + sales.reduce((s, t) => s + parseFloat(t.total_amount || 0), 0).toLocaleString();
    document.getElementById('inv-unsynced').textContent = unsynced.length;
    
    const typeFilter = document.getElementById('invTypeFilter').value;
    const statusFilter = document.getElementById('invStatusFilter').value;
    const syncFilter = document.getElementById('invSyncFilter')?.value || '';
    const search = (document.getElementById('invSearch').value || '').toLowerCase();
    let list = taxInvoiceList;
    if (typeFilter) list = list.filter(t => t.invoice_type === typeFilter);
    if (statusFilter) list = list.filter(t => t.payment_status === statusFilter);
    if (syncFilter === 'synced') list = list.filter(t => t.synced_to_ledger);
    if (syncFilter === 'unsynced') list = list.filter(t => !t.synced_to_ledger);
    if (search) list = list.filter(t => (t.partner_name || '').toLowerCase().includes(search));
    
    const tbody = document.getElementById('taxInvoiceTableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const types = { purchase: '매입', sales: '매출' };
    const payStatus = { unpaid: '미지급', paid: '지급완료' };
    tbody.innerHTML = list.map(t => {
        const syncBadge = t.synced_to_ledger ? '<span class="badge badge-active text-xs">연동</span>' : '<span class="badge badge-pending text-xs">미연동</span>';
        return '<tr><td><span class="badge ' + (t.invoice_type === 'purchase' ? 'badge-error' : 'badge-info') + '">' + (types[t.invoice_type] || t.invoice_type) + '</span></td><td>' + t.invoice_date + '</td><td class="font-bold">' + (t.partner_name || '-') + '</td><td class="text-right">₩' + parseInt(t.supply_amount || 0).toLocaleString() + '</td><td class="text-right">₩' + parseInt(t.vat_amount || 0).toLocaleString() + '</td><td class="text-right font-bold">₩' + parseInt(t.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.payment_status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (payStatus[t.payment_status] || '미지급') + '</span></td><td>' + syncBadge + '</td><td><button onclick="editTaxInvoice(' + t.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
    }).join('');
}

function openTaxInvoiceModal() {
    document.getElementById('taxInvoiceModalTitle').textContent = '🧾 세금계산서 등록';
    document.getElementById('taxInvoiceForm').reset();
    document.getElementById('inv-id').value = '';
    document.getElementById('inv-date').value = new Date().toISOString().split('T')[0];
    openModal('taxInvoiceModal');
}

function editTaxInvoice(id) {
    const t = taxInvoiceList.find(x => x.id === id); if (!t) return;
    document.getElementById('taxInvoiceModalTitle').textContent = '🧾 세금계산서 수정';
    document.getElementById('inv-id').value = t.id;
    document.getElementById('inv-type').value = t.invoice_type || 'purchase';
    document.getElementById('inv-date').value = t.invoice_date || '';
    document.getElementById('inv-vendor').value = t.partner_name || '';
    document.getElementById('inv-bizno').value = t.biz_no || '';
    document.getElementById('inv-ceo').value = t.ceo_name || '';
    document.getElementById('inv-supply').value = t.supply_amount || 0;
    document.getElementById('inv-vat').value = t.vat_amount || 0;
    document.getElementById('inv-total').value = t.total_amount || 0;
    document.getElementById('inv-status').value = t.payment_status || 'unpaid';
    document.getElementById('inv-paiddate').value = t.paid_date || '';
    document.getElementById('inv-item').value = t.item_name || '';
    document.getElementById('inv-memo').value = t.memo || '';
    openModal('taxInvoiceModal');
}

function calcTaxInvoice() {
    const supply = parseFloat(document.getElementById('inv-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('inv-vat').value = vat;
    document.getElementById('inv-total').value = supply + vat;
}

async function submitTaxInvoice(e) {
    e.preventDefault();
    const id = document.getElementById('inv-id').value;
    const data = {
        invoice_type: document.getElementById('inv-type').value,
        invoice_date: document.getElementById('inv-date').value,
        partner_name: document.getElementById('inv-vendor').value,
        biz_no: document.getElementById('inv-bizno').value || null,
        ceo_name: document.getElementById('inv-ceo').value || null,
        supply_amount: parseFloat(document.getElementById('inv-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('inv-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('inv-total').value) || 0,
        payment_status: document.getElementById('inv-status').value,
        paid_date: document.getElementById('inv-paiddate').value || null,
        item_name: document.getElementById('inv-item').value || null,
        memo: document.getElementById('inv-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('hq_tax_invoices', 'PATCH', data, '?id=eq.' + id);
            const idx = taxInvoiceList.findIndex(x => x.id == id);
            if (idx >= 0) taxInvoiceList[idx] = { ...taxInvoiceList[idx], ...data };
            showToast('세금계산서 수정 완료');
        } else {
            const r = await supabaseCall('hq_tax_invoices', 'POST', data);
            if (r && r[0]) taxInvoiceList.unshift(r[0]);
            showToast('세금계산서 등록 완료');
        }
        closeModal('taxInvoiceModal');
        renderTaxInvoiceTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

// 세금계산서 엑셀
function exportTaxInvoiceExcel() {
    const headers = ['유형','발행일','거래처','사업자번호','대표자','공급가액','부가세','합계','지급상태','품목','메모'];
    const data = taxInvoiceList.map(t => [t.invoice_type === 'purchase' ? '매입' : '매출', t.invoice_date, t.partner_name, t.biz_no, t.ceo_name, t.supply_amount, t.vat_amount, t.total_amount, t.payment_status === 'paid' ? '지급완료' : '미지급', t.item_name, t.memo]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, '세금계산서');
    XLSX.writeFile(wb, '세금계산서목록.xlsx');
    showToast('다운로드 완료');
}

async function uploadTaxInvoiceExcel(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (rows.length < 2) { showToast('데이터가 없습니다', 'error'); return; }
        let count = 0;
        for (let i = 1; i < rows.length; i++) {
            const r = rows[i]; if (!r[2]) continue;
            const data = {
                invoice_type: r[0] === '매입' ? 'purchase' : 'sales',
                invoice_date: r[1],
                partner_name: r[2],
                biz_no: r[3] || null,
                ceo_name: r[4] || null,
                supply_amount: parseFloat(r[5]) || 0,
                vat_amount: parseFloat(r[6]) || 0,
                total_amount: parseFloat(r[7]) || 0,
                payment_status: r[8] === '지급완료' ? 'paid' : 'unpaid',
                item_name: r[9] || null,
                memo: r[10] || null
            };
            const res = await supabaseCall('hq_tax_invoices', 'POST', data);
            if (res && res[0]) { taxInvoiceList.unshift(res[0]); count++; }
        }
        showToast(count + '건 업로드 완료');
        renderTaxInvoiceTable();
    };
    reader.readAsBinaryString(input.files[0]);
    input.value = '';
}

// ==================== 회계 관리 ====================
function renderJournalTable() {
    document.getElementById('acc-count').textContent = journalList.length + '건';
    document.getElementById('acc-debit').textContent = '₩' + journalList.reduce((s, j) => s + parseFloat(j.debit_amount || 0), 0).toLocaleString();
    document.getElementById('acc-credit').textContent = '₩' + journalList.reduce((s, j) => s + parseFloat(j.credit_amount || 0), 0).toLocaleString();
    document.getElementById('acc-pending').textContent = journalList.filter(j => j.status === 'created').length + '건';
    
    const tbody = document.getElementById('journalTableBody');
    if (!journalList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const statuses = { created: '생성', confirmed: '확정', cancelled: '취소' };
    const statusClass = { created: 'badge-pending', confirmed: 'badge-active', cancelled: 'badge-inactive' };
    tbody.innerHTML = journalList.map(j => '<tr><td>' + j.journal_date + '</td><td class="font-bold text-lime-400">' + (j.journal_no || '-') + '</td><td>' + (j.debit_account || '-') + '</td><td class="text-right text-blue-400">₩' + parseInt(j.debit_amount || 0).toLocaleString() + '</td><td>' + (j.credit_account || '-') + '</td><td class="text-right text-red-400">₩' + parseInt(j.credit_amount || 0).toLocaleString() + '</td><td class="text-xs">' + (j.description || '-') + '</td><td><span class="badge ' + (statusClass[j.status] || 'badge-pending') + '">' + (statuses[j.status] || j.status) + '</span></td><td><button onclick="editJournal(' + j.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

function openJournalModal() {
    document.getElementById('journalModalTitle').textContent = '📊 분개 등록';
    document.getElementById('journalForm').reset();
    document.getElementById('jnl-id').value = '';
    document.getElementById('jnl-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('jnl-number').value = 'JNL-' + Date.now();
    openModal('journalModal');
}

function editJournal(id) {
    const j = journalList.find(x => x.id === id); if (!j) return;
    document.getElementById('journalModalTitle').textContent = '📊 분개 수정';
    document.getElementById('jnl-id').value = j.id;
    document.getElementById('jnl-date').value = j.journal_date || '';
    document.getElementById('jnl-number').value = j.journal_no || '';
    document.getElementById('jnl-debit-account').value = j.debit_account || '';
    document.getElementById('jnl-debit-amount').value = j.debit_amount || 0;
    document.getElementById('jnl-credit-account').value = j.credit_account || '';
    document.getElementById('jnl-credit-amount').value = j.credit_amount || 0;
    document.getElementById('jnl-desc').value = j.description || '';
    document.getElementById('jnl-status').value = j.status || 'created';
    document.getElementById('jnl-evidence').value = j.evidence_no || '';
    document.getElementById('jnl-memo').value = j.memo || '';
    openModal('journalModal');
}

async function submitJournal(e) {
    e.preventDefault();
    const id = document.getElementById('jnl-id').value;
    const data = {
        journal_date: document.getElementById('jnl-date').value,
        journal_no: document.getElementById('jnl-number').value,
        debit_account: document.getElementById('jnl-debit-account').value,
        debit_amount: parseFloat(document.getElementById('jnl-debit-amount').value) || 0,
        credit_account: document.getElementById('jnl-credit-account').value,
        credit_amount: parseFloat(document.getElementById('jnl-credit-amount').value) || 0,
        description: document.getElementById('jnl-desc').value,
        status: document.getElementById('jnl-status').value,
        evidence_no: document.getElementById('jnl-evidence').value || null,
        memo: document.getElementById('jnl-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('accounting_journals', 'PATCH', data, '?id=eq.' + id);
            const idx = journalList.findIndex(x => x.id == id);
            if (idx >= 0) journalList[idx] = { ...journalList[idx], ...data };
            showToast('분개 수정 완료');
        } else {
            const r = await supabaseCall('accounting_journals', 'POST', data);
            if (r && r[0]) journalList.unshift(r[0]);
            showToast('분개 등록 완료');
        }
        closeModal('journalModal');
        renderJournalTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

// 분개 엑셀
function exportJournalExcel() {
    const headers = ['일자','분개번호','차변계정','차변금액','대변계정','대변금액','적요','상태','메모'];
    const data = journalList.map(j => [j.journal_date, j.journal_no, j.debit_account, j.debit_amount, j.credit_account, j.credit_amount, j.description, j.status === 'confirmed' ? '확정' : '생성', j.memo]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, '분개장');
    XLSX.writeFile(wb, '분개장.xlsx');
    showToast('다운로드 완료');
}

async function uploadJournalExcel(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (rows.length < 2) { showToast('데이터가 없습니다', 'error'); return; }
        let count = 0;
        for (let i = 1; i < rows.length; i++) {
            const r = rows[i]; if (!r[0]) continue;
            const data = {
                journal_date: r[0],
                journal_no: r[1] || 'JNL-' + Date.now() + i,
                debit_account: r[2] || '',
                debit_amount: parseFloat(r[3]) || 0,
                credit_account: r[4] || '',
                credit_amount: parseFloat(r[5]) || 0,
                description: r[6] || '',
                status: r[7] === '확정' ? 'confirmed' : 'created',
                memo: r[8] || null
            };
            const res = await supabaseCall('accounting_journals', 'POST', data);
            if (res && res[0]) { journalList.unshift(res[0]); count++; }
        }
        showToast(count + '건 업로드 완료');
        renderJournalTable();
    };
    reader.readAsBinaryString(input.files[0]);
    input.value = '';
}

// ==================== 감사 로그 ====================
async function renderAuditLogs() {
    const logs = await supabaseCall('audit_logs', 'GET', null, '?order=changed_at.desc&limit=50');
    auditLogList = logs || [];
    const tbody = document.getElementById('auditLogTableBody');
    if (!auditLogList.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const actions = { INSERT: '등록', UPDATE: '수정', DELETE: '삭제' };
    const actionClass = { INSERT: 'badge-active', UPDATE: 'badge-pending', DELETE: 'badge-error' };
    tbody.innerHTML = auditLogList.map(l => '<tr><td class="text-xs">' + (l.changed_at || '').substring(0, 19) + '</td><td>' + (l.table_name || '-') + '</td><td><span class="badge ' + (actionClass[l.action_type] || 'badge-info') + '">' + (actions[l.action_type] || l.action_type) + '</span></td><td>' + l.record_id + '</td><td>' + (l.changed_by || '-') + '</td><td><button onclick="viewAuditDetail(' + l.id + ')" class="btn-secondary btn-sm">상세</button></td></tr>').join('');
}

function viewAuditDetail(id) { showToast('감사 로그 상세 보기 준비중', 'info'); }

// ==================== 지급 관리 (직원/급여) ====================
function renderEmployeeTable() {
    document.getElementById('emp-total').textContent = employeeList.length;
    document.getElementById('emp-regular').textContent = employeeList.filter(e => e.emp_type === 'regular').length;
    document.getElementById('emp-contract').textContent = employeeList.filter(e => e.emp_type === 'contract').length;
    document.getElementById('emp-insured').textContent = employeeList.filter(e => e.insurance_enabled).length;
    
    const tbody = document.getElementById('employeeTableBody');
    if (!employeeList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const types = { regular: '정규직', contract: '계약직' };
    const typeClass = { regular: 'badge-info', contract: 'badge-pending' };
    tbody.innerHTML = employeeList.map(e => '<tr><td class="font-bold text-lime-400">' + (e.emp_code || '-') + '</td><td>' + e.name + '</td><td><span class="badge ' + (typeClass[e.emp_type] || 'badge-info') + '">' + (types[e.emp_type] || e.emp_type) + '</span></td><td>' + (e.department || '-') + '</td><td class="text-right">₩' + parseInt(e.base_salary || 0).toLocaleString() + '</td><td>' + (e.insurance_enabled ? '<span class="text-green-400">✓</span>' : '<span class="text-gray-500">-</span>') + '</td><td><span class="badge ' + (e.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (e.status === 'active' ? '재직' : '퇴사') + '</span></td><td><button onclick="editEmployee(' + e.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

function renderPayrollTable() {
    const thisMonth = new Date().getMonth() + 1;
    const thisYear = new Date().getFullYear();
    const thisMonthPayrolls = payrollList.filter(p => p.pay_year == thisYear && p.pay_month == thisMonth);
    
    document.getElementById('pay-count').textContent = thisMonthPayrolls.length + '건';
    document.getElementById('pay-gross').textContent = '₩' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.gross_pay || 0), 0).toLocaleString();
    document.getElementById('pay-deduct').textContent = '₩' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.total_deduction || 0), 0).toLocaleString();
    document.getElementById('pay-net').textContent = '₩' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.net_pay || 0), 0).toLocaleString();
    
    const tbody = document.getElementById('payrollTableBody');
    if (!payrollList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    tbody.innerHTML = payrollList.map(p => {
        const emp = employeeList.find(e => e.id == p.employee_id);
        const allowance = parseFloat(p.overtime_pay || 0) + parseFloat(p.bonus || 0) + parseFloat(p.meal_allowance || 0) + parseFloat(p.transport_allowance || 0) + parseFloat(p.other_allowance || 0);
        return '<tr><td class="font-bold">' + p.pay_year + '년 ' + p.pay_month + '월</td><td>' + (emp ? emp.name : '-') + '</td><td class="text-right">₩' + parseInt(p.base_salary || 0).toLocaleString() + '</td><td class="text-right text-blue-400">₩' + parseInt(allowance).toLocaleString() + '</td><td class="text-right">₩' + parseInt(p.gross_pay || 0).toLocaleString() + '</td><td class="text-right text-red-400">₩' + parseInt(p.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-green-400">₩' + parseInt(p.net_pay || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (p.status === 'paid' ? '지급완료' : '대기') + '</span></td><td><button onclick="editPayroll(' + p.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
    }).join('');
}

function openEmployeeModal() { showToast('직원 등록 모달 준비중', 'info'); }
function editEmployee(id) { showToast('직원 수정 모달 준비중', 'info'); }
function openPayrollModal() { showToast('급여 등록 모달 준비중', 'info'); }
function editPayroll(id) { showToast('급여 수정 모달 준비중', 'info'); }

// 근로계약서 업로드
let selectedContractFile = null;

function loadContractEmpOptions() {
    const sel = document.getElementById('contractEmpSelect');
    sel.innerHTML = '<option value="">직원 선택</option>' + employeeList.map(e => '<option value="' + e.id + '">' + e.name + ' (' + (e.emp_code || '-') + ')</option>').join('');
}

function handleContractUpload(input) {
    if (input.files && input.files[0]) {
        selectedContractFile = input.files[0];
        document.getElementById('contractFileName').textContent = selectedContractFile.name;
    }
}

async function uploadContract() {
    const empId = document.getElementById('contractEmpSelect').value;
    if (!empId) { showToast('직원을 선택하세요', 'error'); return; }
    if (!selectedContractFile) { showToast('파일을 선택하세요', 'error'); return; }
    
    // 파일을 Base64로 변환해서 저장 (간단한 방법)
    const reader = new FileReader();
    reader.onload = async (e) => {
        const emp = employeeList.find(x => x.id == empId);
        const contract = {
            employee_id: parseInt(empId),
            employee_name: emp ? emp.name : '',
            file_name: selectedContractFile.name,
            file_size: selectedContractFile.size,
            file_type: selectedContractFile.type,
            file_data: e.target.result,
            uploaded_at: new Date().toISOString()
        };
        
        // localStorage에 저장 (임시)
        let contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
        contracts.push(contract);
        localStorage.setItem('employee_contracts', JSON.stringify(contracts));
        
        showToast('업로드 완료');
        selectedContractFile = null;
        document.getElementById('contractFileName').textContent = '선택된 파일 없음';
        document.getElementById('contractFileInput').value = '';
        renderContractTable();
    };
    reader.readAsDataURL(selectedContractFile);
}

function renderContractTable() {
    const contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    const tbody = document.getElementById('contractTableBody');
    if (!contracts.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">업로드된 파일 없음</td></tr>'; return; }
    tbody.innerHTML = contracts.map((c, idx) => '<tr><td>' + (c.employee_name || '-') + '</td><td class="text-lime-400">' + c.file_name + '</td><td>' + (c.uploaded_at || '').substring(0, 10) + '</td><td><button onclick="downloadContract(' + idx + ')" class="btn-secondary btn-sm mr-1">다운</button><button onclick="deleteContract(' + idx + ')" class="btn-sm" style="background:rgba(239,68,68,0.2);color:#EF4444;border:1px solid rgba(239,68,68,0.3);border-radius:8px">삭제</button></td></tr>').join('');
}

function downloadContract(idx) {
    const contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    const c = contracts[idx];
    if (!c) return;
    const link = document.createElement('a');
    link.href = c.file_data;
    link.download = c.file_name;
    link.click();
}

function deleteContract(idx) {
    if (!confirm('삭제하시겠습니까?')) return;
    let contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    contracts.splice(idx, 1);
    localStorage.setItem('employee_contracts', JSON.stringify(contracts));
    showToast('삭제 완료');
    renderContractTable();
}

// ==================== 정산관리 시스템 ====================
function loadSettlementDashboard() {
    const platTotal = platformList.reduce((s, p) => s + parseFloat(p.total_amount || 0), 0);
    const advTotal = advanceTransferList.reduce((s, a) => s + parseFloat(a.total_amount || 0), 0);
    document.getElementById('sett-dash-platform').textContent = '₩' + platTotal.toLocaleString();
    document.getElementById('sett-dash-advance').textContent = '₩' + advTotal.toLocaleString();
    document.getElementById('sett-dash-profit').textContent = '₩' + (platTotal - advTotal).toLocaleString();
    document.getElementById('sett-dash-pending').textContent = reconcileList.filter(r => r.status === 'pending').length + '건';
    
    const platforms = { baemin: '배민', coupang: '쿠팡', yogiyo: '요기요' };
    const statuses = { pending: '대기', received: '입금완료', transferred: '지급완료' };
    document.getElementById('settDashPlatformTable').innerHTML = platformList.slice(0, 5).map(p => '<tr><td>' + p.settlement_week + '</td><td>' + (platforms[p.platform] || p.platform) + '</td><td>₩' + parseInt(p.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'received' ? 'badge-active' : 'badge-pending') + '">' + (statuses[p.status] || p.status) + '</span></td></tr>').join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">데이터 없음</td></tr>';
    document.getElementById('settDashAdvanceTable').innerHTML = advanceTransferList.slice(0, 5).map(a => { const pt = partnerList.find(x => x.id == a.partner_id); return '<tr><td>' + a.transfer_date + '</td><td>' + (pt ? pt.name : '-') + '</td><td>₩' + parseInt(a.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (a.status === 'transferred' ? 'badge-active' : 'badge-pending') + '">' + (statuses[a.status] || a.status) + '</span></td></tr>'; }).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">데이터 없음</td></tr>';
}

function renderPlatformTable() {
    document.getElementById('plat-total').textContent = platformList.length + '건';
    document.getElementById('plat-count-stat').textContent = platformList.reduce((s, p) => s + parseInt(p.delivery_count || 0), 0).toLocaleString() + '건';
    document.getElementById('plat-supply-stat').textContent = '₩' + platformList.reduce((s, p) => s + parseFloat(p.supply_amount || 0), 0).toLocaleString();
    document.getElementById('plat-amount').textContent = '₩' + platformList.reduce((s, p) => s + parseFloat(p.total_amount || 0), 0).toLocaleString();
    
    const platforms = { baemin: '배민', coupang: '쿠팡', yogiyo: '요기요' };
    const tbody = document.getElementById('platformTableBody');
    if (!platformList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    tbody.innerHTML = platformList.map(p => '<tr><td class="font-bold text-lime-400">' + p.settlement_week + '</td><td>' + (platforms[p.platform] || p.platform) + '</td><td class="text-xs">' + (p.work_start_date || '') + '<br>~' + (p.work_end_date || '') + '</td><td class="text-right">' + parseInt(p.delivery_count || 0).toLocaleString() + '</td><td class="text-right">₩' + parseInt(p.supply_amount || 0).toLocaleString() + '</td><td class="text-right">₩' + parseInt(p.vat_amount || 0).toLocaleString() + '</td><td class="text-right font-bold">₩' + parseInt(p.total_amount || 0).toLocaleString() + '</td><td>' + (p.expected_date || '-') + '</td><td><button onclick="editPlatform(' + p.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

function renderSettAdvanceTable() {
    document.getElementById('settadv-total').textContent = advanceTransferList.length + '건';
    document.getElementById('settadv-pending').textContent = advanceTransferList.filter(a => a.status === 'pending').length + '건';
    document.getElementById('settadv-transferred').textContent = advanceTransferList.filter(a => a.status === 'transferred').length + '건';
    document.getElementById('settadv-amount').textContent = '₩' + advanceTransferList.reduce((s, a) => s + parseFloat(a.net_amount || 0), 0).toLocaleString();
    document.getElementById('settadv-fee-income').textContent = '₩' + advanceTransferList.reduce((s, a) => s + parseFloat(a.fee_amount || 0), 0).toLocaleString();
    
    // 필터 적용
    const monthFilter = document.getElementById('settAdvMonthFilter')?.value || '';
    const partnerFilter = document.getElementById('settAdvPartnerFilter')?.value || '';
    const statusFilter = document.getElementById('settAdvStatusFilter')?.value || '';
    
    let filtered = advanceTransferList.filter(a => {
        if (monthFilter && !a.transfer_date?.startsWith(monthFilter)) return false;
        if (partnerFilter && a.partner_id != partnerFilter) return false;
        if (statusFilter && a.status !== statusFilter) return false;
        return true;
    });
    
    // 협력사 필터 옵션 로드
    const partnerFilterEl = document.getElementById('settAdvPartnerFilter');
    if (partnerFilterEl && partnerFilterEl.options.length <= 1) {
        partnerList.forEach(p => { partnerFilterEl.add(new Option(p.name, p.id)); });
    }
    
    const tbody = document.getElementById('settAdvanceTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    tbody.innerHTML = filtered.map(a => { const pt = partnerList.find(x => x.id == a.partner_id); return '<tr><td>' + a.transfer_date + '</td><td class="font-bold">' + (pt ? pt.name : '-') + '</td><td>' + (a.settlement_week || '-') + '</td><td class="text-right">₩' + parseInt(a.supply_amount || 0).toLocaleString() + '</td><td class="text-right">₩' + parseInt(a.vat_amount || 0).toLocaleString() + '</td><td class="text-right">₩' + parseInt(a.total_amount || 0).toLocaleString() + '</td><td class="text-right text-yellow-400">₩' + parseInt(a.fee_amount || 0).toLocaleString() + '</td><td class="text-right font-bold text-red-400">₩' + parseInt(a.net_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (a.status === 'transferred' ? 'badge-active' : 'badge-pending') + '">' + (a.status === 'transferred' ? '지급완료' : '대기') + '</span></td><td><button onclick="editSettAdvance(' + a.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>'; }).join('');
}

// 플랫폼 정산 → 선정산 지급 연동
async function syncFromPlatformSettlement() {
    // 플랫폼 정산 중 아직 선정산 안 된 것 찾기
    const unsynced = platformSettList.filter(p => !p.synced_to_advance && p.status === 'received');
    
    if (!unsynced.length) {
        showToast('연동할 플랫폼 정산 내역이 없습니다', 'info');
        return;
    }
    
    if (!confirm(unsynced.length + '건의 플랫폼 정산을 선정산 지급으로 연동하시겠습니까?')) return;
    
    let cnt = 0;
    for (const p of unsynced) {
        // 플랫폼별 협력사 매핑 (필요시)
        const partner = partnerList.find(pt => pt.name?.includes(p.platform) || pt.id == p.partner_id);
        
        const supplyAmount = Math.round(parseFloat(p.total_amount || 0) / 1.1);
        const vatAmount = parseFloat(p.total_amount || 0) - supplyAmount;
        const feeRate = 0.02; // 기본 수수료율 2%
        const feeAmount = Math.round(parseFloat(p.total_amount || 0) * feeRate);
        const netAmount = parseFloat(p.total_amount || 0) - feeAmount;
        
        const data = {
            partner_id: partner?.id || null,
            transfer_date: new Date().toISOString().slice(0, 10),
            settlement_week: p.settlement_week,
            supply_amount: supplyAmount,
            vat_amount: vatAmount,
            total_amount: parseFloat(p.total_amount || 0),
            fee_rate: feeRate,
            fee_amount: feeAmount,
            net_amount: netAmount,
            status: 'pending',
            platform_settlement_id: p.id,
            memo: p.platform + ' ' + p.settlement_week + ' 연동'
        };
        
        const r = await supabaseCall('advance_transfers', 'POST', data);
        if (r && r[0]) { advanceTransferList.unshift(r[0]); cnt++; }
        
        // 플랫폼 정산에 연동 표시
        await supabaseCall('platform_settlements', 'PATCH', { synced_to_advance: true }, '?id=eq.' + p.id);
        p.synced_to_advance = true;
    }
    
    showToast(cnt + '건 선정산 지급 연동 완료');
    renderSettAdvanceTable();
    renderPlatformTable();
}

function renderReconcileTable() {
    document.getElementById('rec-total').textContent = reconcileList.length + '건';
    document.getElementById('rec-pending').textContent = reconcileList.filter(r => r.status === 'pending').length + '건';
    document.getElementById('rec-matched').textContent = reconcileList.filter(r => r.status === 'matched').length + '건';
    document.getElementById('rec-issue').textContent = reconcileList.filter(r => r.status === 'issue').length + '건';
    
    const tbody = document.getElementById('reconcileTableBody');
    if (!reconcileList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    const statuses = { pending: '대기', matched: '완료', issue: '불일치' };
    const statusClass = { pending: 'badge-pending', matched: 'badge-active', issue: 'badge-error' };
    tbody.innerHTML = reconcileList.map(r => { const pt = partnerList.find(x => x.id == r.partner_id); return '<tr><td class="font-bold text-lime-400">' + r.settlement_week + '</td><td>' + (pt ? pt.name : '-') + '</td><td class="text-right text-blue-400">₩' + parseInt(r.platform_total || 0).toLocaleString() + '</td><td class="text-right text-red-400">₩' + parseInt(r.advance_total || 0).toLocaleString() + '</td><td class="text-right font-bold">₩' + parseInt(r.difference_amount || 0).toLocaleString() + '</td><td class="text-right text-lime-400">₩' + parseInt(r.fee_income || 0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[r.status] || 'badge-pending') + '">' + (statuses[r.status] || r.status) + '</span></td><td><button onclick="editReconcile(' + r.id + ')" class="btn-secondary btn-sm">상세</button></td></tr>'; }).join('');
}

function renderCashbookTable() {
    // 필터 적용
    const monthFilter = document.getElementById('cashbookMonth')?.value || '';
    const typeFilter = document.getElementById('cashbookType')?.value || '';
    const linkFilter = document.getElementById('cashbookLink')?.value || '';
    const searchFilter = (document.getElementById('cashbookSearch')?.value || '').toLowerCase();
    
    let filtered = bankList.filter(b => {
        if (monthFilter && !b.transaction_date?.startsWith(monthFilter)) return false;
        if (typeFilter && b.transaction_type !== typeFilter) return false;
        if (linkFilter === 'linked' && !b.link_type) return false;
        if (linkFilter === 'unlinked' && b.link_type) return false;
        if (searchFilter && !(b.counterparty || '').toLowerCase().includes(searchFilter) && !(b.description || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    // 통계
    const deposits = bankList.filter(b => b.transaction_type === 'deposit').reduce((s, b) => s + parseFloat(b.amount || 0), 0);
    const withdrawals = bankList.filter(b => b.transaction_type === 'withdrawal').reduce((s, b) => s + parseFloat(b.amount || 0), 0);
    const unlinked = bankList.filter(b => !b.link_type).length;
    
    document.getElementById('bank-deposit').textContent = '₩' + deposits.toLocaleString();
    document.getElementById('bank-withdrawal').textContent = '₩' + withdrawals.toLocaleString();
    document.getElementById('bank-balance').textContent = '₩' + (deposits - withdrawals).toLocaleString();
    document.getElementById('bank-count').textContent = bankList.length + '건';
    document.getElementById('bank-unlinked').textContent = unlinked + '건';
    
    // 잔액 계산 (날짜순 정렬 후)
    const sorted = [...filtered].sort((a, b) => (a.transaction_date || '').localeCompare(b.transaction_date || ''));
    let runningBalance = 0;
    sorted.forEach(b => {
        if (b.transaction_type === 'deposit') runningBalance += parseFloat(b.amount || 0);
        else runningBalance -= parseFloat(b.amount || 0);
        b._balance = runningBalance;
    });
    
    const tbody = document.getElementById('bankTableBody');
    if (!sorted.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    tbody.innerHTML = sorted.map(b => {
        const linkBadge = b.link_type ? '<span class="badge badge-active text-xs">' + getLinkLabel(b.link_type) + '</span>' : '<span class="badge badge-pending text-xs">미연결</span>';
        const isDeposit = b.transaction_type === 'deposit';
        return '<tr>' +
            '<td>' + b.transaction_date + '</td>' +
            '<td><span class="badge ' + (isDeposit ? 'badge-info' : 'badge-error') + '">' + (isDeposit ? '입금' : '출금') + '</span></td>' +
            '<td class="font-bold">' + (b.counterparty || '-') + '</td>' +
            '<td class="text-right text-blue-400">' + (isDeposit ? '₩' + parseInt(b.amount || 0).toLocaleString() : '') + '</td>' +
            '<td class="text-right text-red-400">' + (!isDeposit ? '₩' + parseInt(b.amount || 0).toLocaleString() : '') + '</td>' +
            '<td class="text-right font-bold">₩' + parseInt(b._balance || 0).toLocaleString() + '</td>' +
            '<td class="text-xs">' + (b.description || '-') + '</td>' +
            '<td>' + linkBadge + '</td>' +
            '<td><button onclick="editCashbook(' + b.id + ')" class="btn-secondary btn-sm">수정</button></td>' +
            '</tr>';
    }).join('');
}

function renderBankTable() { renderCashbookTable(); }

function getLinkLabel(type) {
    const labels = { platform: '플랫폼', advance: '선정산', weekly: '주정산', taxinvoice: '세금계산서' };
    return labels[type] || type;
}

function loadSettAdvancePartnerOptions() {
    const opts = '<option value="">선택</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    const el = document.getElementById('settadv-partner');
    if (el) el.innerHTML = opts;
}

// 모달 열기
function openPlatformModal() { document.getElementById('platformForm').reset(); document.getElementById('plat-id').value = ''; openModal('platformModal'); }
function openSettAdvanceModal() { document.getElementById('settAdvanceForm').reset(); document.getElementById('settadv-id').value = ''; loadSettAdvancePartnerOptions(); openModal('settAdvanceModal'); }
function openCashbookModal() { 
    document.getElementById('bankForm').reset(); 
    document.getElementById('bank-id').value = ''; 
    document.getElementById('bank-link-id').innerHTML = '<option value="">선택</option>';
    openModal('bankModal'); 
}
function openBankModal() { openCashbookModal(); }
function openReconcileModal() { showToast('대사 등록 모달 준비중', 'info'); }

// 연결 옵션 로드
function loadLinkOptions() {
    const linkType = document.getElementById('bank-link-type').value;
    const linkIdSelect = document.getElementById('bank-link-id');
    linkIdSelect.innerHTML = '<option value="">선택</option>';
    
    if (linkType === 'platform') {
        const platforms = { baemin: '배민', coupang: '쿠팡', yogiyo: '요기요' };
        platformList.forEach(p => {
            const label = (platforms[p.platform] || p.platform) + ' ' + p.settlement_week + ' (₩' + parseInt(p.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + p.id + '">' + label + '</option>';
        });
    } else if (linkType === 'advance') {
        advanceTransferList.forEach(a => {
            const partner = partnerList.find(p => p.id == a.partner_id);
            const label = (partner?.name || '협력사') + ' ' + (a.settlement_week || '') + ' (₩' + parseInt(a.net_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + a.id + '">' + label + '</option>';
        });
    } else if (linkType === 'weekly') {
        weeklyPayoutList.forEach(w => {
            const rider = riderList.find(r => r.id == w.rider_id);
            const label = (rider?.name || '라이더') + ' ' + (w.settlement_week || '') + ' (₩' + parseInt(w.net_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + w.id + '">' + label + '</option>';
        });
    }
}

// 부가세 자동계산
function calcPlatformVat() {
    const supply = parseFloat(document.getElementById('plat-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('plat-vat').value = vat;
    document.getElementById('plat-total-amt').value = supply + vat;
}

function calcSettAdvanceTotal() {
    const supply = parseFloat(document.getElementById('settadv-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    const feeRate = parseFloat(document.getElementById('settadv-fee-rate').value) || 0;
    const total = supply + vat;
    const fee = Math.round(total * feeRate / 100);
    document.getElementById('settadv-vat').value = vat;
    document.getElementById('settadv-total-amt').value = total;
    document.getElementById('settadv-fee').value = fee;
    document.getElementById('settadv-net').value = total - fee;
}

// 저장
async function submitPlatform(e) {
    e.preventDefault();
    const id = document.getElementById('plat-id').value;
    const data = {
        platform: document.getElementById('plat-platform').value,
        settlement_week: document.getElementById('plat-week').value,
        work_start_date: document.getElementById('plat-start').value || null,
        work_end_date: document.getElementById('plat-end').value || null,
        expected_date: document.getElementById('plat-expected').value || null,
        delivery_count: parseInt(document.getElementById('plat-count').value) || 0,
        supply_amount: parseFloat(document.getElementById('plat-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('plat-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('plat-total-amt').value) || 0,
        memo: document.getElementById('plat-memo').value || null
    };
    try {
        if (id) { await supabaseCall('platform_settlements', 'PATCH', data, '?id=eq.' + id); showToast('수정 완료'); }
        else { const r = await supabaseCall('platform_settlements', 'POST', data); if (r && r[0]) platformList.unshift(r[0]); showToast('등록 완료'); }
        closeModal('platformModal');
        renderPlatformTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

async function submitSettAdvance(e) {
    e.preventDefault();
    const id = document.getElementById('settadv-id').value;
    const data = {
        partner_id: document.getElementById('settadv-partner').value || null,
        transfer_date: document.getElementById('settadv-date').value,
        settlement_week: document.getElementById('settadv-week').value || null,
        supply_amount: parseFloat(document.getElementById('settadv-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('settadv-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('settadv-total-amt').value) || 0,
        fee_rate: parseFloat(document.getElementById('settadv-fee-rate').value) / 100 || 0,
        fee_amount: parseFloat(document.getElementById('settadv-fee').value) || 0,
        net_amount: parseFloat(document.getElementById('settadv-net').value) || 0,
        status: document.getElementById('settadv-status').value,
        memo: document.getElementById('settadv-memo').value || null
    };
    try {
        if (id) { await supabaseCall('advance_transfers', 'PATCH', data, '?id=eq.' + id); showToast('수정 완료'); }
        else { const r = await supabaseCall('advance_transfers', 'POST', data); if (r && r[0]) advanceTransferList.unshift(r[0]); showToast('등록 완료'); }
        closeModal('settAdvanceModal');
        renderSettAdvanceTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

async function submitCashbook(e) {
    e.preventDefault();
    const id = document.getElementById('bank-id').value;
    const data = {
        transaction_date: document.getElementById('bank-date').value,
        transaction_type: document.getElementById('bank-type').value,
        counterparty: document.getElementById('bank-counterparty').value || null,
        amount: parseFloat(document.getElementById('bank-amount').value) || 0,
        description: document.getElementById('bank-desc').value || null,
        link_type: document.getElementById('bank-link-type').value || null,
        link_id: document.getElementById('bank-link-id').value || null,
        bank_memo: document.getElementById('bank-memo2').value || null
    };
    try {
        if (id) { 
            await supabaseCall('bank_transactions', 'PATCH', data, '?id=eq.' + id); 
            const idx = bankList.findIndex(b => b.id == id);
            if (idx >= 0) bankList[idx] = { ...bankList[idx], ...data };
            showToast('수정 완료'); 
        } else { 
            const r = await supabaseCall('bank_transactions', 'POST', data); 
            if (r && r[0]) bankList.unshift(r[0]); 
            showToast('등록 완료'); 
        }
        closeModal('bankModal');
        renderCashbookTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

async function submitBank(e) { return submitCashbook(e); }

function editCashbook(id) {
    const b = bankList.find(x => x.id === id); if (!b) return;
    document.getElementById('bank-id').value = b.id;
    document.getElementById('bank-date').value = b.transaction_date || '';
    document.getElementById('bank-type').value = b.transaction_type || 'deposit';
    document.getElementById('bank-counterparty').value = b.counterparty || '';
    document.getElementById('bank-amount').value = b.amount || 0;
    document.getElementById('bank-desc').value = b.description || '';
    document.getElementById('bank-link-type').value = b.link_type || '';
    loadLinkOptions();
    document.getElementById('bank-link-id').value = b.link_id || '';
    document.getElementById('bank-memo2').value = b.bank_memo || '';
    openModal('bankModal');
}

function editBank(id) { editCashbook(id); }

// 수정
function editPlatform(id) {
    const p = platformList.find(x => x.id === id); if (!p) return;
    document.getElementById('plat-id').value = p.id;
    document.getElementById('plat-platform').value = p.platform || '';
    document.getElementById('plat-week').value = p.settlement_week || '';
    document.getElementById('plat-start').value = p.work_start_date || '';
    document.getElementById('plat-end').value = p.work_end_date || '';
    document.getElementById('plat-expected').value = p.expected_date || '';
    document.getElementById('plat-count').value = p.delivery_count || 0;
    document.getElementById('plat-supply').value = p.supply_amount || 0;
    document.getElementById('plat-vat').value = p.vat_amount || 0;
    document.getElementById('plat-total-amt').value = p.total_amount || 0;
    document.getElementById('plat-memo').value = p.memo || '';
    openModal('platformModal');
}

function editSettAdvance(id) {
    const a = advanceTransferList.find(x => x.id === id); if (!a) return;
    loadSettAdvancePartnerOptions();
    document.getElementById('settadv-id').value = a.id;
    document.getElementById('settadv-partner').value = a.partner_id || '';
    document.getElementById('settadv-date').value = a.transfer_date || '';
    document.getElementById('settadv-week').value = a.settlement_week || '';
    document.getElementById('settadv-supply').value = a.supply_amount || 0;
    document.getElementById('settadv-vat').value = a.vat_amount || 0;
    document.getElementById('settadv-total-amt').value = a.total_amount || 0;
    document.getElementById('settadv-fee-rate').value = (a.fee_rate || 0) * 100;
    document.getElementById('settadv-fee').value = a.fee_amount || 0;
    document.getElementById('settadv-net').value = a.net_amount || 0;
    document.getElementById('settadv-status').value = a.status || 'pending';
    document.getElementById('settadv-memo').value = a.memo || '';
    openModal('settAdvanceModal');
}

function editBank(id) {
    const b = bankList.find(x => x.id === id); if (!b) return;
    document.getElementById('bank-id').value = b.id;
    document.getElementById('bank-date').value = b.transaction_date || '';
    document.getElementById('bank-type').value = b.transaction_type || 'deposit';
    document.getElementById('bank-amount').value = b.amount || 0;
    document.getElementById('bank-desc').value = b.description || '';
    document.getElementById('bank-memo2').value = b.bank_memo || '';
    openModal('bankModal');
}

function editReconcile(id) { showToast('대사 상세 모달 준비중', 'info'); }
async function autoReconcile() { showToast('자동 대사 기능 준비중', 'info'); }

// ==================== 주정산 지급 ====================
function renderWeeklyPayoutTable() {
    document.getElementById('weekly-total').textContent = weeklyPayoutList.length + '건';
    document.getElementById('weekly-pending').textContent = weeklyPayoutList.filter(w => w.status === 'pending').length + '건';
    document.getElementById('weekly-paid').textContent = weeklyPayoutList.filter(w => w.status === 'paid').length + '건';
    document.getElementById('weekly-amount').textContent = '₩' + weeklyPayoutList.reduce((s, w) => s + parseFloat(w.net_amount || 0), 0).toLocaleString();
    
    const sf = document.getElementById('weeklyStatusFilter').value;
    const wf = document.getElementById('weeklyWeekFilter').value;
    const q = (document.getElementById('weeklySearch').value || '').toLowerCase();
    
    let list = weeklyPayoutList;
    if (sf) list = list.filter(w => w.status === sf);
    if (wf) list = list.filter(w => (w.settlement_week || '').includes(wf));
    if (q) list = list.filter(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return (rider?.name || '').toLowerCase().includes(q) || (partner?.name || '').toLowerCase().includes(q);
    });
    
    const tbody = document.getElementById('weeklyPayoutTableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    tbody.innerHTML = list.map(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return '<tr><td class="font-bold text-lime-400">' + (w.settlement_week || '-') + '</td><td>' + (rider?.name || '-') + '</td><td>' + (partner?.name || '-') + '</td><td class="text-right">' + parseInt(w.delivery_count || 0).toLocaleString() + '</td><td class="text-right text-blue-400">₩' + parseInt(w.delivery_revenue || 0).toLocaleString() + '</td><td class="text-right text-red-400">₩' + parseInt(w.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-lime-400">₩' + parseInt(w.net_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (w.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (w.status === 'paid' ? '지급완료' : '대기') + '</span></td><td><button onclick="editWeeklyPayout(' + w.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
    }).join('');
}

function loadWeeklyPayoutOptions() {
    const riderOpts = '<option value="">선택</option>' + riderList.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    const partnerOpts = '<option value="">선택</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    const riderEl = document.getElementById('weekly-rider');
    const partnerEl = document.getElementById('weekly-partner');
    if (riderEl) riderEl.innerHTML = riderOpts;
    if (partnerEl) partnerEl.innerHTML = partnerOpts;
}

function openWeeklyPayoutModal() {
    document.getElementById('weeklyPayoutForm').reset();
    document.getElementById('weekly-id').value = '';
    loadWeeklyPayoutOptions();
    openModal('weeklyPayoutModal');
}

function calcWeeklyPayout() {
    const revenue = parseFloat(document.getElementById('weekly-revenue').value) || 0;
    const fee = parseFloat(document.getElementById('weekly-fee').value) || 0;
    const insurance = parseFloat(document.getElementById('weekly-insurance').value) || 0;
    const other = parseFloat(document.getElementById('weekly-other').value) || 0;
    const deduction = fee + insurance + other;
    const net = revenue - deduction;
    document.getElementById('weekly-deduction').value = deduction;
    document.getElementById('weekly-net').value = net;
}

async function submitWeeklyPayout(e) {
    e.preventDefault();
    const id = document.getElementById('weekly-id').value;
    const data = {
        settlement_week: document.getElementById('weekly-week').value,
        payout_date: document.getElementById('weekly-date').value,
        rider_id: document.getElementById('weekly-rider').value || null,
        partner_id: document.getElementById('weekly-partner').value || null,
        delivery_count: parseInt(document.getElementById('weekly-count').value) || 0,
        delivery_revenue: parseFloat(document.getElementById('weekly-revenue').value) || 0,
        fee_amount: parseFloat(document.getElementById('weekly-fee').value) || 0,
        insurance_amount: parseFloat(document.getElementById('weekly-insurance').value) || 0,
        other_deduction: parseFloat(document.getElementById('weekly-other').value) || 0,
        total_deduction: parseFloat(document.getElementById('weekly-deduction').value) || 0,
        net_amount: parseFloat(document.getElementById('weekly-net').value) || 0,
        status: document.getElementById('weekly-status').value,
        bank_account: document.getElementById('weekly-account').value || null,
        memo: document.getElementById('weekly-memo').value || null
    };
    try {
        if (id) { await supabaseCall('weekly_payouts', 'PATCH', data, '?id=eq.' + id); showToast('수정 완료'); }
        else { const r = await supabaseCall('weekly_payouts', 'POST', data); if (r && r[0]) weeklyPayoutList.unshift(r[0]); showToast('등록 완료'); }
        closeModal('weeklyPayoutModal');
        renderWeeklyPayoutTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

function editWeeklyPayout(id) {
    const w = weeklyPayoutList.find(x => x.id === id); if (!w) return;
    loadWeeklyPayoutOptions();
    document.getElementById('weekly-id').value = w.id;
    document.getElementById('weekly-week').value = w.settlement_week || '';
    document.getElementById('weekly-date').value = w.payout_date || '';
    document.getElementById('weekly-rider').value = w.rider_id || '';
    document.getElementById('weekly-partner').value = w.partner_id || '';
    document.getElementById('weekly-count').value = w.delivery_count || 0;
    document.getElementById('weekly-revenue').value = w.delivery_revenue || 0;
    document.getElementById('weekly-fee').value = w.fee_amount || 0;
    document.getElementById('weekly-insurance').value = w.insurance_amount || 0;
    document.getElementById('weekly-other').value = w.other_deduction || 0;
    document.getElementById('weekly-deduction').value = w.total_deduction || 0;
    document.getElementById('weekly-net').value = w.net_amount || 0;
    document.getElementById('weekly-status').value = w.status || 'pending';
    document.getElementById('weekly-account').value = w.bank_account || '';
    document.getElementById('weekly-memo').value = w.memo || '';
    openModal('weeklyPayoutModal');
}

// ==================== 선정산 지급 엑셀 ====================
function downloadSettAdvanceTemplate() {
    const headers = ['지급일', '협력사명', '정산주차', '공급가액', '부가세', '합계', '수수료율(%)', '수수료금액', '실지급액', '상태', '메모'];
    const sample = ['2025-01-20', '협력사A', '2025-W03', '1000000', '100000', '1100000', '3', '33000', '1067000', 'pending', ''];
    downloadExcelTemplate('선정산지급_양식', headers, sample);
}

async function uploadSettAdvanceExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('데이터가 없습니다', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const partnerName = row[1];
            const partner = partnerList.find(p => p.name === partnerName);
            const obj = {
                transfer_date: formatExcelDate(row[0]),
                partner_id: partner?.id || null,
                settlement_week: row[2] || null,
                supply_amount: parseFloat(row[3]) || 0,
                vat_amount: parseFloat(row[4]) || 0,
                total_amount: parseFloat(row[5]) || 0,
                fee_rate: (parseFloat(row[6]) || 0) / 100,
                fee_amount: parseFloat(row[7]) || 0,
                net_amount: parseFloat(row[8]) || 0,
                status: row[9] || 'pending',
                memo: row[10] || null
            };
            const r = await supabaseCall('advance_transfers', 'POST', obj);
            if (r && r[0]) { advanceTransferList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + '건 업로드 완료');
        renderSettAdvanceTable();
    } catch (e) { showToast('업로드 실패: ' + e.message, 'error'); }
    input.value = '';
}

function exportSettAdvanceExcel() {
    const headers = ['지급일', '협력사명', '정산주차', '공급가액', '부가세', '합계', '수수료율(%)', '수수료금액', '실지급액', '상태', '메모'];
    const rows = advanceTransferList.map(a => {
        const partner = partnerList.find(p => p.id == a.partner_id);
        return [a.transfer_date, partner?.name || '', a.settlement_week || '', a.supply_amount, a.vat_amount, a.total_amount, (a.fee_rate || 0) * 100, a.fee_amount, a.net_amount, a.status, a.memo || ''];
    });
    downloadExcel('선정산지급_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== 주정산 지급 엑셀 ====================
function downloadWeeklyPayoutTemplate() {
    const headers = ['정산주차', '지급일', '라이더명', '협력사명', '배달건수', '배달수익', '수수료', '보험료', '기타공제', '총공제액', '실지급액', '상태', '지급계좌', '메모'];
    const sample = ['2025-W03', '2025-01-20', '홍길동', '협력사A', '100', '500000', '15000', '10000', '5000', '30000', '470000', 'pending', '국민 123-456-789', ''];
    downloadExcelTemplate('주정산지급_양식', headers, sample);
}

async function uploadWeeklyPayoutExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('데이터가 없습니다', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const riderName = row[2];
            const partnerName = row[3];
            const rider = riderList.find(r => r.name === riderName);
            const partner = partnerList.find(p => p.name === partnerName);
            const obj = {
                settlement_week: row[0] || null,
                payout_date: formatExcelDate(row[1]),
                rider_id: rider?.id || null,
                partner_id: partner?.id || null,
                delivery_count: parseInt(row[4]) || 0,
                delivery_revenue: parseFloat(row[5]) || 0,
                fee_amount: parseFloat(row[6]) || 0,
                insurance_amount: parseFloat(row[7]) || 0,
                other_deduction: parseFloat(row[8]) || 0,
                total_deduction: parseFloat(row[9]) || 0,
                net_amount: parseFloat(row[10]) || 0,
                status: row[11] || 'pending',
                bank_account: row[12] || null,
                memo: row[13] || null
            };
            const r = await supabaseCall('weekly_payouts', 'POST', obj);
            if (r && r[0]) { weeklyPayoutList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + '건 업로드 완료');
        renderWeeklyPayoutTable();
    } catch (e) { showToast('업로드 실패: ' + e.message, 'error'); }
    input.value = '';
}

function exportWeeklyPayoutExcel() {
    const headers = ['정산주차', '지급일', '라이더명', '협력사명', '배달건수', '배달수익', '수수료', '보험료', '기타공제', '총공제액', '실지급액', '상태', '지급계좌', '메모'];
    const rows = weeklyPayoutList.map(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return [w.settlement_week || '', w.payout_date, rider?.name || '', partner?.name || '', w.delivery_count, w.delivery_revenue, w.fee_amount, w.insurance_amount, w.other_deduction, w.total_deduction, w.net_amount, w.status, w.bank_account || '', w.memo || ''];
    });
    downloadExcel('주정산지급_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== 입출금 내역 엑셀 ====================
function downloadCashbookTemplate() {
    const headers = ['거래일자', '구분(deposit/withdrawal)', '거래처', '금액', '적요', '연결유형(platform/advance/weekly)', '메모'];
    const sample = ['2025-01-20', 'deposit', '배민', '5000000', 'W03 정산금 입금', 'platform', ''];
    downloadExcelTemplate('현금출납장_양식', headers, sample);
}

function downloadBankTemplate() { downloadCashbookTemplate(); }

async function uploadBankExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('데이터가 없습니다', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 4) continue;
            const obj = {
                transaction_date: formatExcelDate(row[0]),
                transaction_type: (row[1] || '').toLowerCase() === 'withdrawal' ? 'withdrawal' : 'deposit',
                counterparty: row[2] || null,
                amount: parseFloat(row[3]) || 0,
                description: row[4] || null,
                link_type: row[5] || null,
                bank_memo: row[6] || null
            };
            const r = await supabaseCall('bank_transactions', 'POST', obj);
            if (r && r[0]) { bankList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + '건 업로드 완료');
        renderCashbookTable();
    } catch (e) { showToast('업로드 실패: ' + e.message, 'error'); }
    input.value = '';
}

function exportCashbookExcel() {
    // 잔액 계산
    const sorted = [...bankList].sort((a, b) => (a.transaction_date || '').localeCompare(b.transaction_date || ''));
    let runningBalance = 0;
    sorted.forEach(b => {
        if (b.transaction_type === 'deposit') runningBalance += parseFloat(b.amount || 0);
        else runningBalance -= parseFloat(b.amount || 0);
        b._balance = runningBalance;
    });
    
    const headers = ['거래일자', '구분', '거래처', '입금', '출금', '잔액', '적요', '연결유형', '메모'];
    const rows = sorted.map(b => [
        b.transaction_date, 
        b.transaction_type === 'deposit' ? '입금' : '출금',
        b.counterparty || '',
        b.transaction_type === 'deposit' ? b.amount : '',
        b.transaction_type === 'withdrawal' ? b.amount : '',
        b._balance,
        b.description || '', 
        getLinkLabel(b.link_type) || '',
        b.bank_memo || ''
    ]);
    downloadExcel('현금출납장_' + new Date().toISOString().slice(0,10), headers, rows);
}

function exportBankExcel() { exportCashbookExcel(); }

// ==================== 엑셀 공통 함수 ====================
function downloadExcelTemplate(filename, headers, sample) {
    const ws = XLSX.utils.aoa_to_sheet([headers, sample]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename + '.xlsx');
}

function downloadExcel(filename, headers, rows) {
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename + '.xlsx');
}

function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const wb = XLSX.read(e.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                resolve(data);
            } catch (err) { reject(err); }
        };
        reader.onerror = () => reject(new Error('파일 읽기 실패'));
        reader.readAsBinaryString(file);
    });
}

function formatExcelDate(val) {
    if (!val) return null;
    if (typeof val === 'number') {
        const d = new Date((val - 25569) * 86400000);
        return d.toISOString().slice(0, 10);
    }
    if (typeof val === 'string' && val.includes('-')) return val.slice(0, 10);
    return null;
}

// ==================== 매입매출장 ====================
function showAccSubTab(sub) {
    document.getElementById('accSubTab-salesPurchase').classList.add('hidden');
    document.getElementById('accSubTab-journal').classList.add('hidden');
    document.getElementById('accSubTab-ledger').classList.add('hidden');
    document.getElementById('accSubTab-' + sub).classList.remove('hidden');
    document.getElementById('btn-salesPurchase').classList.remove('btn-primary');
    document.getElementById('btn-journal').classList.remove('btn-primary');
    document.getElementById('btn-ledger').classList.remove('btn-primary');
    document.getElementById('btn-salesPurchase').classList.add('btn-secondary');
    document.getElementById('btn-journal').classList.add('btn-secondary');
    document.getElementById('btn-ledger').classList.add('btn-secondary');
    document.getElementById('btn-' + sub).classList.remove('btn-secondary');
    document.getElementById('btn-' + sub).classList.add('btn-primary');
    if (sub === 'ledger') renderLedgerTable();
}

function renderSalesPurchaseTable() {
    // 필터
    const monthFilter = document.getElementById('spMonthFilter')?.value || '';
    const typeFilter = document.getElementById('spTypeFilter')?.value || '';
    const taxFilter = document.getElementById('spTaxFilter')?.value || '';
    const searchFilter = (document.getElementById('spSearch')?.value || '').toLowerCase();
    
    let filtered = salesPurchaseList.filter(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return false;
        if (typeFilter && sp.transaction_type !== typeFilter) return false;
        if (taxFilter && sp.tax_invoice_status !== taxFilter) return false;
        if (searchFilter && !(sp.counterparty || '').toLowerCase().includes(searchFilter) && !(sp.item_name || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    // 통계 계산
    const salesItems = salesPurchaseList.filter(sp => sp.transaction_type === 'sales');
    const purchaseItems = salesPurchaseList.filter(sp => sp.transaction_type === 'purchase');
    const salesTotal = salesItems.reduce((s, sp) => s + parseFloat(sp.supply_amount || 0), 0);
    const purchaseTotal = purchaseItems.reduce((s, sp) => s + parseFloat(sp.supply_amount || 0), 0);
    const salesVat = salesItems.reduce((s, sp) => s + parseFloat(sp.vat_amount || 0), 0);
    const purchaseVat = purchaseItems.reduce((s, sp) => s + parseFloat(sp.vat_amount || 0), 0);
    
    document.getElementById('acc-sales').textContent = '₩' + salesTotal.toLocaleString();
    document.getElementById('acc-purchase').textContent = '₩' + purchaseTotal.toLocaleString();
    document.getElementById('acc-sales-vat').textContent = '₩' + salesVat.toLocaleString();
    document.getElementById('acc-purchase-vat').textContent = '₩' + purchaseVat.toLocaleString();
    document.getElementById('acc-vat-pay').textContent = '₩' + (salesVat - purchaseVat).toLocaleString();
    document.getElementById('acc-profit').textContent = '₩' + (salesTotal - purchaseTotal).toLocaleString();
    
    const tbody = document.getElementById('salesPurchaseTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    tbody.innerHTML = filtered.map(sp => {
        const isSales = sp.transaction_type === 'sales';
        const taxBadge = sp.tax_invoice_status === 'issued' ? '<span class="badge badge-active">발행</span>' : 
                         sp.tax_invoice_status === 'received' ? '<span class="badge badge-info">수취</span>' : 
                         '<span class="badge badge-pending">미발행</span>';
        const linkBadge = sp.link_type ? '<span class="badge badge-active text-xs">' + getLinkLabel(sp.link_type) + '</span>' : '-';
        return '<tr>' +
            '<td>' + sp.transaction_date + '</td>' +
            '<td><span class="badge ' + (isSales ? 'badge-info' : 'badge-error') + '">' + (isSales ? '매출' : '매입') + '</span></td>' +
            '<td class="font-bold">' + (sp.counterparty || '-') + '</td>' +
            '<td>' + (sp.item_name || '-') + '</td>' +
            '<td class="text-right">₩' + parseInt(sp.supply_amount || 0).toLocaleString() + '</td>' +
            '<td class="text-right">₩' + parseInt(sp.vat_amount || 0).toLocaleString() + '</td>' +
            '<td class="text-right font-bold ' + (isSales ? 'text-blue-400' : 'text-red-400') + '">₩' + parseInt(sp.total_amount || 0).toLocaleString() + '</td>' +
            '<td>' + taxBadge + '</td>' +
            '<td>' + linkBadge + '</td>' +
            '<td><button onclick="editSalesPurchase(' + sp.id + ')" class="btn-secondary btn-sm">수정</button></td>' +
            '</tr>';
    }).join('');
}

function openSalesPurchaseModal() {
    document.getElementById('salesPurchaseForm').reset();
    document.getElementById('sp-id').value = '';
    document.getElementById('sp-link-id').innerHTML = '<option value="">선택</option>';
    openModal('salesPurchaseModal');
}

function calcSPTotal() {
    const supply = parseFloat(document.getElementById('sp-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('sp-vat').value = vat;
    document.getElementById('sp-total').value = supply + vat;
}

function toggleSPType() {
    const type = document.getElementById('sp-type').value;
    const taxStatus = document.getElementById('sp-tax-status');
    if (type === 'sales') {
        taxStatus.innerHTML = '<option value="pending">미발행</option><option value="issued">발행</option>';
    } else {
        taxStatus.innerHTML = '<option value="pending">미수취</option><option value="received">수취</option>';
    }
}

function loadSPLinkOptions() {
    const linkType = document.getElementById('sp-link-type').value;
    const linkIdSelect = document.getElementById('sp-link-id');
    linkIdSelect.innerHTML = '<option value="">선택</option>';
    
    if (linkType === 'platform') {
        const platforms = { baemin: '배민', coupang: '쿠팡', yogiyo: '요기요' };
        platformList.forEach(p => {
            const label = (platforms[p.platform] || p.platform) + ' ' + p.settlement_week + ' (₩' + parseInt(p.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + p.id + '">' + label + '</option>';
        });
    } else if (linkType === 'advance') {
        advanceTransferList.forEach(a => {
            const partner = partnerList.find(p => p.id == a.partner_id);
            const label = (partner?.name || '협력사') + ' ' + (a.settlement_week || '') + ' (₩' + parseInt(a.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + a.id + '">' + label + '</option>';
        });
    }
}

async function submitSalesPurchase(e) {
    e.preventDefault();
    const id = document.getElementById('sp-id').value;
    const data = {
        transaction_date: document.getElementById('sp-date').value,
        transaction_type: document.getElementById('sp-type').value,
        counterparty: document.getElementById('sp-counterparty').value,
        item_name: document.getElementById('sp-item').value || null,
        supply_amount: parseFloat(document.getElementById('sp-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('sp-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('sp-total').value) || 0,
        tax_invoice_status: document.getElementById('sp-tax-status').value,
        link_type: document.getElementById('sp-link-type').value || null,
        link_id: document.getElementById('sp-link-id').value || null,
        memo: document.getElementById('sp-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('sales_purchases', 'PATCH', data, '?id=eq.' + id);
            const idx = salesPurchaseList.findIndex(sp => sp.id == id);
            if (idx >= 0) salesPurchaseList[idx] = { ...salesPurchaseList[idx], ...data };
            showToast('수정 완료');
        } else {
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) salesPurchaseList.unshift(r[0]);
            showToast('등록 완료');
        }
        closeModal('salesPurchaseModal');
        renderSalesPurchaseTable();
    } catch (err) { showToast('저장 실패', 'error'); }
}

function editSalesPurchase(id) {
    const sp = salesPurchaseList.find(x => x.id === id); if (!sp) return;
    document.getElementById('sp-id').value = sp.id;
    document.getElementById('sp-date').value = sp.transaction_date || '';
    document.getElementById('sp-type').value = sp.transaction_type || 'sales';
    toggleSPType();
    document.getElementById('sp-tax-status').value = sp.tax_invoice_status || 'pending';
    document.getElementById('sp-counterparty').value = sp.counterparty || '';
    document.getElementById('sp-item').value = sp.item_name || '';
    document.getElementById('sp-supply').value = sp.supply_amount || 0;
    document.getElementById('sp-vat').value = sp.vat_amount || 0;
    document.getElementById('sp-total').value = sp.total_amount || 0;
    document.getElementById('sp-link-type').value = sp.link_type || '';
    loadSPLinkOptions();
    document.getElementById('sp-link-id').value = sp.link_id || '';
    document.getElementById('sp-memo').value = sp.memo || '';
    openModal('salesPurchaseModal');
}

// 정산 연동 - 플랫폼 정산 → 매출, 선정산 지급 → 매입 자동 등록
async function syncFromSettlements() {
    let cnt = 0;
    const platforms = { baemin: '배민', coupang: '쿠팡이츠', yogiyo: '요기요' };
    
    // 플랫폼 정산 → 매출
    for (const p of platformList) {
        const exists = salesPurchaseList.find(sp => sp.link_type === 'platform' && sp.link_id == p.id);
        if (!exists && p.total_amount > 0) {
            const data = {
                transaction_date: p.expected_date || p.work_end_date,
                transaction_type: 'sales',
                counterparty: platforms[p.platform] || p.platform,
                item_name: p.settlement_week + ' 정산금',
                supply_amount: p.supply_amount || 0,
                vat_amount: p.vat_amount || 0,
                total_amount: p.total_amount || 0,
                tax_invoice_status: 'pending',
                link_type: 'platform',
                link_id: p.id
            };
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
    }
    
    // 선정산 지급 → 매입
    for (const a of advanceTransferList) {
        const exists = salesPurchaseList.find(sp => sp.link_type === 'advance' && sp.link_id == a.id);
        if (!exists && a.total_amount > 0) {
            const partner = partnerList.find(pt => pt.id == a.partner_id);
            const data = {
                transaction_date: a.transfer_date,
                transaction_type: 'purchase',
                counterparty: partner?.name || '협력사',
                item_name: (a.settlement_week || '') + ' 선정산',
                supply_amount: a.supply_amount || 0,
                vat_amount: a.vat_amount || 0,
                total_amount: a.total_amount || 0,
                tax_invoice_status: 'pending',
                link_type: 'advance',
                link_id: a.id
            };
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
    }
    
    showToast(cnt + '건 연동 완료');
    renderSalesPurchaseTable();
}

// 매입매출장 엑셀
function downloadSalesPurchaseTemplate() {
    const headers = ['거래일자', '구분(sales/purchase)', '거래처', '품목', '공급가액', '부가세', '합계', '세금계산서상태', '메모'];
    const sample = ['2025-01-20', 'sales', '배민', 'W03 정산금', '5000000', '500000', '5500000', 'issued', ''];
    downloadExcelTemplate('매입매출장_양식', headers, sample);
}

async function uploadSalesPurchaseExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('데이터가 없습니다', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const obj = {
                transaction_date: formatExcelDate(row[0]),
                transaction_type: (row[1] || '').toLowerCase() === 'purchase' ? 'purchase' : 'sales',
                counterparty: row[2] || null,
                item_name: row[3] || null,
                supply_amount: parseFloat(row[4]) || 0,
                vat_amount: parseFloat(row[5]) || 0,
                total_amount: parseFloat(row[6]) || 0,
                tax_invoice_status: row[7] || 'pending',
                memo: row[8] || null
            };
            const r = await supabaseCall('sales_purchases', 'POST', obj);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + '건 업로드 완료');
        renderSalesPurchaseTable();
    } catch (e) { showToast('업로드 실패: ' + e.message, 'error'); }
    input.value = '';
}

function exportSalesPurchaseExcel() {
    const headers = ['거래일자', '구분', '거래처', '품목', '공급가액', '부가세', '합계', '세금계산서', '연결', '메모'];
    const rows = salesPurchaseList.map(sp => [
        sp.transaction_date,
        sp.transaction_type === 'sales' ? '매출' : '매입',
        sp.counterparty || '',
        sp.item_name || '',
        sp.supply_amount,
        sp.vat_amount,
        sp.total_amount,
        sp.tax_invoice_status === 'issued' ? '발행' : sp.tax_invoice_status === 'received' ? '수취' : '미발행',
        getLinkLabel(sp.link_type) || '',
        sp.memo || ''
    ]);
    downloadExcel('매입매출장_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== 총계정원장 ====================
const ACCOUNT_CODES = {
    // 자산
    '101': { name: '현금', category: 'asset' },
    '102': { name: '보통예금', category: 'asset' },
    '103': { name: '정기예금', category: 'asset' },
    '108': { name: '매출채권', category: 'asset' },
    '110': { name: '미수금', category: 'asset' },
    '120': { name: '재고자산', category: 'asset' },
    '150': { name: '차량운반구', category: 'asset' },
    '160': { name: '비품', category: 'asset' },
    // 부채
    '201': { name: '매입채무', category: 'liability' },
    '210': { name: '미지급금', category: 'liability' },
    '220': { name: '예수금', category: 'liability' },
    '230': { name: '부가세예수금', category: 'liability' },
    '240': { name: '부가세대급금', category: 'asset' },
    // 자본
    '301': { name: '자본금', category: 'equity' },
    '310': { name: '이익잉여금', category: 'equity' },
    // 수익
    '401': { name: '매출', category: 'revenue' },
    '402': { name: '수수료수익', category: 'revenue' },
    '403': { name: '이자수익', category: 'revenue' },
    '410': { name: '기타수익', category: 'revenue' },
    // 비용
    '501': { name: '급여', category: 'expense' },
    '502': { name: '임차료', category: 'expense' },
    '503': { name: '통신비', category: 'expense' },
    '504': { name: '소모품비', category: 'expense' },
    '505': { name: '접대비', category: 'expense' },
    '506': { name: '광고선전비', category: 'expense' },
    '510': { name: '차량유지비', category: 'expense' },
    '520': { name: '보험료', category: 'expense' },
    '530': { name: '수수료비용', category: 'expense' },
    '590': { name: '기타비용', category: 'expense' }
};

const CATEGORY_NAMES = { asset: '자산', liability: '부채', equity: '자본', revenue: '수익', expense: '비용' };

function renderLedgerTable() {
    const monthFilter = document.getElementById('ledgerMonthFilter')?.value || '';
    const categoryFilter = document.getElementById('ledgerCategoryFilter')?.value || '';
    
    // 분개장 데이터 기반 계정별 집계
    const accountTotals = {};
    
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        
        // 차변 처리
        if (j.debit_account && j.debit_amount > 0) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
            accountTotals[code].count++;
        }
        // 대변 처리
        if (j.credit_account && j.credit_amount > 0) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
            accountTotals[code].count++;
        }
    });
    
    // 매입매출장에서도 집계 추가
    salesPurchaseList.forEach(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return;
        
        if (sp.transaction_type === 'sales') {
            // 매출 → 401 대변, 매출채권 108 차변
            if (!accountTotals['401']) accountTotals['401'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['401'].credit += parseFloat(sp.supply_amount) || 0;
            accountTotals['401'].count++;
            
            if (!accountTotals['108']) accountTotals['108'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['108'].debit += parseFloat(sp.total_amount) || 0;
            
            // 부가세예수금
            if (sp.vat_amount > 0) {
                if (!accountTotals['230']) accountTotals['230'] = { debit: 0, credit: 0, count: 0 };
                accountTotals['230'].credit += parseFloat(sp.vat_amount) || 0;
            }
        } else {
            // 매입 → 비용 차변, 매입채무 201 대변
            if (!accountTotals['530']) accountTotals['530'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['530'].debit += parseFloat(sp.supply_amount) || 0;
            accountTotals['530'].count++;
            
            if (!accountTotals['201']) accountTotals['201'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['201'].credit += parseFloat(sp.total_amount) || 0;
            
            // 부가세대급금
            if (sp.vat_amount > 0) {
                if (!accountTotals['240']) accountTotals['240'] = { debit: 0, credit: 0, count: 0 };
                accountTotals['240'].debit += parseFloat(sp.vat_amount) || 0;
            }
        }
    });
    
    // 총계 계산
    let assetTotal = 0, liabilityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    
    Object.keys(accountTotals).forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (!acc) return;
        const balance = accountTotals[code].debit - accountTotals[code].credit;
        
        if (acc.category === 'asset') assetTotal += balance;
        else if (acc.category === 'liability') liabilityTotal -= balance;
        else if (acc.category === 'revenue') revenueTotal -= balance;
        else if (acc.category === 'expense') expenseTotal += balance;
    });
    
    document.getElementById('ledger-asset').textContent = '₩' + assetTotal.toLocaleString();
    document.getElementById('ledger-liability').textContent = '₩' + liabilityTotal.toLocaleString();
    document.getElementById('ledger-revenue').textContent = '₩' + revenueTotal.toLocaleString();
    document.getElementById('ledger-expense').textContent = '₩' + expenseTotal.toLocaleString();
    
    // 테이블 렌더링
    const tbody = document.getElementById('ledgerTableBody');
    const rows = [];
    
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (categoryFilter && acc.category !== categoryFilter) return;
        
        const totals = accountTotals[code] || { debit: 0, credit: 0, count: 0 };
        if (totals.debit === 0 && totals.credit === 0) return; // 거래 없으면 스킵
        
        const balance = totals.debit - totals.credit;
        const balanceClass = balance >= 0 ? 'text-blue-400' : 'text-red-400';
        const categoryClass = acc.category === 'asset' ? 'text-blue-300' : 
                              acc.category === 'liability' ? 'text-red-300' :
                              acc.category === 'revenue' ? 'text-green-300' :
                              acc.category === 'expense' ? 'text-orange-300' : 'text-gray-300';
        
        rows.push('<tr>' +
            '<td class="font-mono">' + code + '</td>' +
            '<td class="font-bold">' + acc.name + '</td>' +
            '<td><span class="' + categoryClass + '">' + CATEGORY_NAMES[acc.category] + '</span></td>' +
            '<td class="text-right text-blue-400">₩' + totals.debit.toLocaleString() + '</td>' +
            '<td class="text-right text-red-400">₩' + totals.credit.toLocaleString() + '</td>' +
            '<td class="text-right font-bold ' + balanceClass + '">₩' + balance.toLocaleString() + '</td>' +
            '<td class="text-center">' + totals.count + '건</td>' +
            '</tr>');
    });
    
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">데이터 없음</td></tr>';
    } else {
        tbody.innerHTML = rows.join('');
    }
}

function exportLedgerExcel() {
    const monthFilter = document.getElementById('ledgerMonthFilter')?.value || '';
    const headers = ['계정코드', '계정과목', '분류', '차변합계', '대변합계', '잔액'];
    const rows = [];
    
    // 위 로직 반복 (간소화)
    const accountTotals = {};
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        if (j.debit_account) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
        }
        if (j.credit_account) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
        }
    });
    
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        const totals = accountTotals[code] || { debit: 0, credit: 0 };
        if (totals.debit === 0 && totals.credit === 0) return;
        rows.push([code, acc.name, CATEGORY_NAMES[acc.category], totals.debit, totals.credit, totals.debit - totals.credit]);
    });
    
    downloadExcel('총계정원장_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== 세금계산서 → 매입매출장 연동 ====================
async function syncTaxToSalesPurchase() {
    let cnt = 0;
    
    for (const inv of taxInvoiceList) {
        // 이미 연동된 건 확인
        const exists = salesPurchaseList.find(sp => sp.link_type === 'taxinvoice' && sp.link_id == inv.id);
        if (exists) continue;
        
        const data = {
            transaction_date: inv.invoice_date,
            transaction_type: inv.invoice_type === 'sales' ? 'sales' : 'purchase',
            counterparty: inv.counterparty_name || '',
            item_name: inv.item_name || '세금계산서',
            supply_amount: inv.supply_amount || 0,
            vat_amount: inv.vat_amount || 0,
            total_amount: inv.total_amount || 0,
            tax_invoice_status: inv.invoice_type === 'sales' ? 'issued' : 'received',
            link_type: 'taxinvoice',
            link_id: inv.id
        };
        
        const r = await supabaseCall('sales_purchases', 'POST', data);
        if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        
        // 세금계산서에 연동 표시 업데이트
        await supabaseCall('hq_tax_invoices', 'PATCH', { synced_to_ledger: true }, '?id=eq.' + inv.id);
        inv.synced_to_ledger = true;
    }
    
    showToast(cnt + '건 매입매출장 연동 완료');
    renderTaxInvoiceTable();
    renderSalesPurchaseTable();
}

// ==================== 독립 탭 렌더 함수들 ====================

// 총계정원장 (독립탭)
function renderLedgerTable2() {
    const monthFilter = document.getElementById('ledger2MonthFilter')?.value || '';
    const categoryFilter = document.getElementById('ledger2CategoryFilter')?.value || '';
    
    const accountTotals = {};
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        if (j.debit_account && j.debit_amount > 0) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
            accountTotals[code].count++;
        }
        if (j.credit_account && j.credit_amount > 0) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
            accountTotals[code].count++;
        }
    });
    
    salesPurchaseList.forEach(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return;
        if (sp.transaction_type === 'sales') {
            if (!accountTotals['401']) accountTotals['401'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['401'].credit += parseFloat(sp.supply_amount) || 0;
            accountTotals['401'].count++;
        } else {
            if (!accountTotals['530']) accountTotals['530'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['530'].debit += parseFloat(sp.supply_amount) || 0;
            accountTotals['530'].count++;
        }
    });
    
    let assetTotal = 0, liabilityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    Object.keys(accountTotals).forEach(code => {
        const acc = ACCOUNT_CODES[code]; if (!acc) return;
        const balance = accountTotals[code].debit - accountTotals[code].credit;
        if (acc.category === 'asset') assetTotal += balance;
        else if (acc.category === 'liability') liabilityTotal -= balance;
        else if (acc.category === 'revenue') revenueTotal -= balance;
        else if (acc.category === 'expense') expenseTotal += balance;
    });
    
    document.getElementById('ledger2-asset').textContent = '₩' + assetTotal.toLocaleString();
    document.getElementById('ledger2-liability').textContent = '₩' + liabilityTotal.toLocaleString();
    document.getElementById('ledger2-revenue').textContent = '₩' + revenueTotal.toLocaleString();
    document.getElementById('ledger2-expense').textContent = '₩' + expenseTotal.toLocaleString();
    
    const tbody = document.getElementById('ledger2TableBody');
    const rows = [];
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (categoryFilter && acc.category !== categoryFilter) return;
        const totals = accountTotals[code] || { debit: 0, credit: 0, count: 0 };
        if (totals.debit === 0 && totals.credit === 0) return;
        const balance = totals.debit - totals.credit;
        const balanceClass = balance >= 0 ? 'text-blue-400' : 'text-red-400';
        const categoryClass = acc.category === 'asset' ? 'text-blue-300' : acc.category === 'liability' ? 'text-red-300' : acc.category === 'revenue' ? 'text-green-300' : 'text-orange-300';
        rows.push('<tr><td class="font-mono">' + code + '</td><td class="font-bold">' + acc.name + '</td><td><span class="' + categoryClass + '">' + CATEGORY_NAMES[acc.category] + '</span></td><td class="text-right text-blue-400">₩' + totals.debit.toLocaleString() + '</td><td class="text-right text-red-400">₩' + totals.credit.toLocaleString() + '</td><td class="text-right font-bold ' + balanceClass + '">₩' + balance.toLocaleString() + '</td><td class="text-center">' + totals.count + '건</td></tr>');
    });
    tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="7" class="text-center py-8 text-gray-500">데이터 없음</td></tr>';
}

// 분개장 (독립탭)
function renderJournalTable2() {
    const monthFilter = document.getElementById('journal2MonthFilter')?.value || '';
    const statusFilter = document.getElementById('journal2StatusFilter')?.value || '';
    const search = (document.getElementById('journal2Search')?.value || '').toLowerCase();
    
    let list = journalList.filter(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return false;
        if (statusFilter && j.status !== statusFilter) return false;
        if (search && !(j.description || '').toLowerCase().includes(search)) return false;
        return true;
    });
    
    const tbody = document.getElementById('journal2TableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    const getAccName = (code) => { if (!code) return '-'; const c = code.split('-')[0]; return ACCOUNT_CODES[c]?.name || code; };
    tbody.innerHTML = list.map(j => '<tr><td>' + j.journal_date + '</td><td class="font-mono text-xs">' + (j.journal_no || '-') + '</td><td>' + getAccName(j.debit_account) + '</td><td class="text-right text-blue-400">₩' + parseInt(j.debit_amount || 0).toLocaleString() + '</td><td>' + getAccName(j.credit_account) + '</td><td class="text-right text-red-400">₩' + parseInt(j.credit_amount || 0).toLocaleString() + '</td><td class="text-xs">' + (j.description || '-') + '</td><td><span class="badge ' + (j.status === 'confirmed' ? 'badge-active' : 'badge-pending') + '">' + (j.status === 'confirmed' ? '확정' : '생성') + '</span></td><td><button onclick="editJournal(' + j.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

// 카드 사용내역
function renderCardUsageTable() {
    const thisMonth = new Date().toISOString().slice(0,7);
    const monthlyUsage = cardTransList.filter(t => t.transaction_date?.startsWith(thisMonth)).reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    
    document.getElementById('card-usage-monthly').textContent = '₩' + monthlyUsage.toLocaleString();
    document.getElementById('card-usage-count').textContent = cardTransList.length + '건';
    document.getElementById('card-usage-noreceipt').textContent = cardTransList.filter(t => !t.receipt_status || t.receipt_status === 'none').length + '건';
    document.getElementById('card-usage-pending').textContent = cardTransList.filter(t => !t.accounting_status || t.accounting_status === 'pending').length + '건';
    
    const tbody = document.getElementById('cardUsageTableBody');
    if (!cardTransList.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    tbody.innerHTML = cardTransList.map(t => {
        const card = cardList.find(c => c.id == t.card_id);
        return '<tr><td>' + t.transaction_date + '</td><td>' + (card?.card_alias || '-') + '</td><td>' + (t.merchant_name || '-') + '</td><td class="text-right text-red-400">₩' + parseInt(t.amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.receipt_status === 'received' ? 'badge-active' : 'badge-pending') + '">' + (t.receipt_status === 'received' ? '수취' : '미수취') + '</span></td><td><span class="badge ' + (t.accounting_status === 'processed' ? 'badge-active' : 'badge-pending') + '">' + (t.accounting_status === 'processed' ? '처리' : '미처리') + '</span></td><td><button class="btn-secondary btn-sm">수정</button></td></tr>';
    }).join('');
}

// 직원 관리 (독립탭)
function renderEmployeeTable2() {
    document.getElementById('emp2-total').textContent = employeeList.length;
    document.getElementById('emp2-regular').textContent = employeeList.filter(e => e.employee_type === 'regular').length;
    document.getElementById('emp2-contract').textContent = employeeList.filter(e => e.employee_type === 'contract').length;
    document.getElementById('emp2-insured').textContent = employeeList.filter(e => e.has_insurance).length;
    
    const tbody = document.getElementById('employees2TableBody');
    if (!employeeList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    const types = { regular: '정규직', contract: '계약직', parttime: '파트타임' };
    tbody.innerHTML = employeeList.map(e => '<tr><td class="font-mono">' + (e.employee_no || '-') + '</td><td class="font-bold">' + e.name + '</td><td><span class="badge badge-info">' + (types[e.employee_type] || e.employee_type) + '</span></td><td>' + (e.department || '-') + '</td><td class="text-right">₩' + parseInt(e.base_salary || 0).toLocaleString() + '</td><td>' + (e.has_insurance ? '✅' : '❌') + '</td><td><span class="badge ' + (e.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (e.status === 'active' ? '재직' : '퇴직') + '</span></td><td><button onclick="editEmployee(' + e.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>').join('');
}

// 급여 관리 (독립탭)
function renderPayrollTable2() {
    const thisMonth = new Date().toISOString().slice(0,7);
    const thisMonthPay = payrollList.filter(p => (p.pay_year + '-' + String(p.pay_month).padStart(2, '0')) === thisMonth);
    
    document.getElementById('pay2-count').textContent = thisMonthPay.length + '건';
    document.getElementById('pay2-gross').textContent = '₩' + thisMonthPay.reduce((s, p) => s + parseFloat(p.gross_salary || 0), 0).toLocaleString();
    document.getElementById('pay2-deduct').textContent = '₩' + thisMonthPay.reduce((s, p) => s + parseFloat(p.total_deduction || 0), 0).toLocaleString();
    document.getElementById('pay2-net').textContent = '₩' + thisMonthPay.reduce((s, p) => s + parseFloat(p.net_salary || 0), 0).toLocaleString();
    
    const tbody = document.getElementById('payroll2TableBody');
    if (!payrollList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    tbody.innerHTML = payrollList.map(p => {
        const emp = employeeList.find(e => e.id == p.employee_id);
        return '<tr><td>' + p.pay_year + '-' + String(p.pay_month).padStart(2, '0') + '</td><td class="font-bold">' + (emp?.name || '-') + '</td><td class="text-right">₩' + parseInt(p.base_salary || 0).toLocaleString() + '</td><td class="text-right text-blue-400">₩' + parseInt(p.total_allowance || 0).toLocaleString() + '</td><td class="text-right text-red-400">₩' + parseInt(p.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-lime-400">₩' + parseInt(p.net_salary || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (p.status === 'paid' ? '지급완료' : '대기') + '</span></td><td><button onclick="editPayroll(' + p.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
    }).join('');
}

// 근로계약 (독립탭)
function renderContractTable2() {
    const today = new Date().toISOString().slice(0, 10);
    const contracts = contractList || [];
    
    document.getElementById('contract-total').textContent = contracts.length;
    document.getElementById('contract-active').textContent = contracts.filter(c => c.status === 'active').length;
    document.getElementById('contract-expiring').textContent = contracts.filter(c => { 
        if (!c.end_date) return false;
        const daysLeft = Math.floor((new Date(c.end_date) - new Date()) / 86400000);
        return daysLeft > 0 && daysLeft <= 30;
    }).length;
    document.getElementById('contract-expired').textContent = contracts.filter(c => c.end_date && c.end_date < today).length;
    
    const tbody = document.getElementById('contracts2TableBody');
    if (!contracts.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">데이터 없음</td></tr>'; return; }
    
    const types = { full_time: '정규직', contract: '계약직', part_time: '파트타임' };
    tbody.innerHTML = contracts.map(c => {
        const emp = employeeList.find(e => e.id == c.employee_id);
        return '<tr><td class="font-bold">' + (emp?.name || '-') + '</td><td><span class="badge badge-info">' + (types[c.contract_type] || c.contract_type) + '</span></td><td>' + (c.start_date || '-') + '</td><td>' + (c.end_date || '무기한') + '</td><td class="text-right">₩' + parseInt(c.base_salary || 0).toLocaleString() + '</td><td><span class="badge ' + (c.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (c.status === 'active' ? '유효' : '만료') + '</span></td><td><button onclick="editContract(' + c.id + ')" class="btn-secondary btn-sm">수정</button></td></tr>';
    }).join('');
}

// 독립탭용 wrapper
function renderLedgerTable() { 
    // 회계관리 서브탭용
    const el = document.getElementById('ledgerTableBody');
    if (el) {
        const origFunc = renderLedgerTable.toString();
        // 기존 함수 실행
    }
    // 독립탭용
    renderLedgerTable2();
}

// ==================== 세무서류 보관함 ====================

let taxDocList = [];
let currentTaxFilter = 'all';

// 초기 데이터 로드
async function loadTaxDocuments() {
    const data = await supabaseCall('tax_documents', 'GET', null, '?order=created_at.desc');
    if (data) taxDocList = data;
    renderTaxDocTable();
}

// 카테고리 필터
function filterTaxDocs(category) {
    currentTaxFilter = category;
    ['all', 'withholding', 'statement', 'other'].forEach(c => {
        const tab = document.getElementById('taxDocTab-' + c);
        if (tab) {
            tab.classList.remove('bg-lime-500/20', 'text-lime-400');
            tab.classList.add('text-gray-400');
        }
    });
    const activeTab = document.getElementById('taxDocTab-' + category);
    if (activeTab) {
        activeTab.classList.add('bg-lime-500/20', 'text-lime-400');
        activeTab.classList.remove('text-gray-400');
    }
    renderTaxDocTable();
}

// 테이블 렌더
function renderTaxDocTable() {
    const searchFilter = (document.getElementById('taxDocSearch')?.value || '').toLowerCase();
    const monthFilter = document.getElementById('taxDocMonth')?.value || '';
    
    let filtered = taxDocList.filter(d => {
        if (currentTaxFilter !== 'all' && d.category !== currentTaxFilter) return false;
        if (searchFilter && !(d.file_name || '').toLowerCase().includes(searchFilter) && !(d.description || '').toLowerCase().includes(searchFilter)) return false;
        if (monthFilter && !d.document_date?.startsWith(monthFilter)) return false;
        return true;
    });
    
    // 통계
    document.getElementById('taxdoc-total').textContent = taxDocList.length + '개';
    document.getElementById('taxdoc-withholding').textContent = taxDocList.filter(d => d.category === 'withholding').length + '개';
    document.getElementById('taxdoc-statement').textContent = taxDocList.filter(d => d.category === 'statement').length + '개';
    document.getElementById('taxdoc-other').textContent = taxDocList.filter(d => d.category === 'other').length + '개';
    
    const tbody = document.getElementById('taxDocTableBody');
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">업로드된 파일이 없습니다</td></tr>';
        return;
    }
    
    const categoryNames = { withholding: '원천세 신고', statement: '지급명세서', other: '기타 서류' };
    const categoryColors = { withholding: 'badge-info', statement: 'badge-active', other: 'badge-pending' };
    
    tbody.innerHTML = filtered.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge ' + (categoryColors[d.category] || 'badge-pending') + '">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td>' + (d.document_date || '-') + '</td>' +
            '<td class="text-sm text-gray-400">' + (d.description || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td>' +
            '<button onclick="downloadTaxDoc(' + d.id + ')" class="btn-secondary btn-sm mr-1">📥</button>' +
            '<button onclick="deleteTaxDoc(' + d.id + ')" class="btn-danger btn-sm">🗑️</button>' +
            '</td>' +
            '</tr>';
    }).join('');
}

// 업로드 모달 열기
function openTaxUploadModal() {
    document.getElementById('taxUploadForm').reset();
    document.getElementById('uploadProgress').classList.add('hidden');
    openModal('taxUploadModal');
}

// 파일 업로드
async function submitTaxUpload(e) {
    e.preventDefault();
    
    const category = document.getElementById('taxdoc-category').value;
    const docDate = document.getElementById('taxdoc-date').value;
    const description = document.getElementById('taxdoc-desc').value;
    const fileInput = document.getElementById('taxdoc-file');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('파일을 선택해주세요', 'error');
        return;
    }
    
    // 프로그레스 표시
    document.getElementById('uploadProgress').classList.remove('hidden');
    document.getElementById('uploadProgressBar').style.width = '30%';
    
    try {
        // 파일 경로 생성
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9가-힣._-]/g, '_');
        const filePath = category + '/' + timestamp + '_' + safeName;
        
        // Supabase Storage에 업로드
        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
            .from('tax-documents')
            .upload(filePath, file);
        
        document.getElementById('uploadProgressBar').style.width = '70%';
        
        if (uploadError) {
            throw uploadError;
        }
        
        // 메타데이터 저장
        const docData = {
            category: category,
            file_name: file.name,
            file_path: filePath,
            file_size: file.size,
            file_type: file.type,
            description: description || null,
            document_date: docDate || null,
            uploaded_by: currentUser?.username || 'system'
        };
        
        const result = await supabaseCall('tax_documents', 'POST', docData);
        
        document.getElementById('uploadProgressBar').style.width = '100%';
        
        if (result && result[0]) {
            taxDocList.unshift(result[0]);
            showToast('파일 업로드 완료');
            closeModal('taxUploadModal');
            renderTaxDocTable();
        }
    } catch (err) {
        console.error('Upload error:', err);
        showToast('업로드 실패: ' + (err.message || err), 'error');
    }
    
    document.getElementById('uploadProgress').classList.add('hidden');
}

// 파일 다운로드
async function downloadTaxDoc(id) {
    const doc = taxDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        const { data, error } = await window.supabaseClient.storage
            .from('tax-documents')
            .download(doc.file_path);
        
        if (error) throw error;
        
        // 다운로드 트리거
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = doc.file_name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('다운로드 완료');
    } catch (err) {
        console.error('Download error:', err);
        showToast('다운로드 실패', 'error');
    }
}

// 파일 삭제
async function deleteTaxDoc(id) {
    if (!confirm('이 파일을 삭제하시겠습니까?')) return;
    
    const doc = taxDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        // Storage에서 삭제
        await window.supabaseClient.storage
            .from('tax-documents')
            .remove([doc.file_path]);
        
        // DB에서 삭제
        await supabaseCall('tax_documents', 'DELETE', null, '?id=eq.' + id);
        
        taxDocList = taxDocList.filter(d => d.id !== id);
        showToast('파일 삭제 완료');
        renderTaxDocTable();
    } catch (err) {
        console.error('Delete error:', err);
        showToast('삭제 실패', 'error');
    }
}
</script>
</body>
</html>
