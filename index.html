<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEAM BRO - í†µí•© ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes neonGlow { 0%, 100% { filter: drop-shadow(0 0 10px #39FF14); } 50% { filter: drop-shadow(0 0 20px #39FF14); } }
        .neon-text { color: #FFF; animation: neonGlow 2s ease-in-out infinite; }
        .glass-card { background: rgba(15, 15, 15, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(57, 255, 20, 0.2); }
        .cyber-grid { background-image: linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px); background-size: 50px 50px; }
        body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .hidden { display: none; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: rgba(57, 255, 20, 0.1); padding: 12px; text-align: left; font-size: 12px; font-weight: bold; color: #39FF14; }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 13px; }
        .data-table tr:hover { background: rgba(57, 255, 20, 0.05); cursor: pointer; }
        .input-field { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(57, 255, 20, 0.3); color: white; padding: 10px 14px; border-radius: 8px; width: 100%; }
        .input-field:focus { outline: none; border-color: #39FF14; box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #39FF14, #32CD32); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(57, 255, 20, 0.5); }
        .btn-secondary { background: rgba(57, 255, 20, 0.1); border: 1px solid rgba(57, 255, 20, 0.3); color: #39FF14; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #EF4444; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: #0a0a0a; border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 16px; padding: 24px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; }
        .badge-active { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-delinquent { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-completed { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-rent { background: rgba(147, 51, 234, 0.2); color: #9333EA; }
        .badge-lease { background: rgba(236, 72, 153, 0.2); color: #EC4899; }
        .badge-pending { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-failed { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-accrual { background: rgba(57, 255, 20, 0.2); color: #39FF14; }
        .badge-receipt { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-adjust { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-admin { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-manager { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-staff { background: rgba(107, 114, 128, 0.2); color: #9CA3AF; }
        .badge-waiting { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .badge-progress { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-complete { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-paid { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-unpaid { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-low { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-normal { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-vip { background: rgba(234, 179, 8, 0.2); color: #EAB308; }
        .tab-active { color: #39FF14 !important; border-bottom: 2px solid #39FF14; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-label { color: #9CA3AF; font-size: 13px; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(57,255,20,0.3); border-top-color: #39FF14; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(57, 255, 20, 0.3); border-radius: 4px; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; z-index: 200; }
        .toast-success { background: rgba(16, 185, 129, 0.9); }
        .toast-error { background: rgba(239, 68, 68, 0.9); }
        .system-card { transition: all 0.3s; cursor: pointer; }
        .system-card:hover { transform: translateY(-4px); border-color: rgba(57, 255, 20, 0.5); }
        .system-card.selected { border-color: #39FF14; box-shadow: 0 0 20px rgba(57, 255, 20, 0.3); }
        .setting-tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .setting-tab:hover { background: rgba(57, 255, 20, 0.05); }
        .setting-tab.active { border-bottom-color: #39FF14; color: #39FF14; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen">
    <div class="cyber-grid fixed inset-0 pointer-events-none"></div>
    <div id="toast-container"></div>

    <!-- ======================= ë¡œê·¸ì¸ í˜ì´ì§€ ======================= -->
    <div id="loginPage" class="relative z-10 min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-lg">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-black neon-text mb-3">TEAM BRO</h1>
                <p class="text-lime-400/70 text-sm">í†µí•© ERP ì‹œìŠ¤í…œ</p>
            </div>
            <div class="glass-card rounded-2xl p-8">
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-2">ì•„ì´ë””</label>
                        <input type="text" id="username" class="input-field" placeholder="ì•„ì´ë”” ì…ë ¥" required />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required />
                    </div>
                    
                    <!-- ì‹œìŠ¤í…œ ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-bold text-lime-400 mb-3">ì‹œìŠ¤í…œ ì„ íƒ</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="system-card glass-card rounded-xl p-4 text-center selected" onclick="selectSystem('settlement')">
                                <div class="text-3xl mb-2">ğŸ’°</div>
                                <div class="font-bold">ì •ì‚°ê´€ë¦¬</div>
                                <div class="text-xs text-gray-400 mt-1">ë ŒíŠ¸Â·ë¦¬ìŠ¤ ì •ì‚°</div>
                                <input type="radio" name="system" value="settlement" checked class="hidden">
                            </div>
                            <div class="system-card glass-card rounded-xl p-4 text-center" onclick="selectSystem('bromotors')">
                                <div class="text-3xl mb-2">ğŸ”§</div>
                                <div class="font-bold">ë¸Œë¡œëª¨í„°ìŠ¤</div>
                                <div class="text-xs text-gray-400 mt-1">ì§ì˜ìˆ˜ë¦¬ì </div>
                                <input type="radio" name="system" value="bromotors" class="hidden">
                            </div>
                        </div>
                    </div>
                    
                    <div id="loginError" class="hidden p-3 rounded-lg bg-red-400/10 text-red-400 text-sm"></div>
                    <button type="submit" class="w-full btn-primary text-lg py-3">âš¡ ë¡œê·¸ì¸</button>
                </form>
            </div>
            <p class="text-center text-gray-500 text-xs mt-4">ê¿ˆì´ ìˆëŠ” ê±°ë¶ì´ëŠ” ì§€ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ======================= -->
    <div id="settlementSystem" class="hidden">
        <!-- í—¤ë” -->
        <div class="relative z-10 border-b border-lime-500/30" style="background: linear-gradient(180deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <div onclick="showSettlementTab('overview')" class="cursor-pointer">
                    <h1 class="text-2xl font-black neon-text">ì •ì‚°ê´€ë¦¬</h1>
                    <p class="text-lime-400/50 text-xs italic">TEAM BRO</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-center">
                        <div class="text-xs text-lime-400/70">ì˜¤ëŠ˜ ë‚ ì§œ</div>
                        <div class="text-sm font-bold text-lime-400" id="s-today-date"></div>
                    </div>
                    <button onclick="switchSystem()" class="btn-secondary btn-sm">ğŸ”§ ë¸Œë¡œëª¨í„°ìŠ¤</button>
                    <div class="px-3 py-2 rounded-lg glass-card text-right">
                        <div class="text-xs text-lime-400/70" id="s-userRole">ê´€ë¦¬ì</div>
                        <div class="text-sm font-bold" id="s-userName">Admin</div>
                    </div>
                    <button onclick="handleLogout()" class="btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="relative z-10 border-b border-lime-500/20 bg-black/50">
            <div class="max-w-7xl mx-auto px-6 flex space-x-1 overflow-x-auto">
                <button onclick="showSettlementTab('overview')" id="s-tab-overview" class="px-4 py-3 font-bold text-sm tab-active">ğŸ“Š í†µí•©í˜„í™©</button>
                <button onclick="showSettlementTab('contracts')" id="s-tab-contracts" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ“‹ ê³„ì•½ê´€ë¦¬</button>
                <button onclick="showSettlementTab('vehicles')" id="s-tab-vehicles" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸš— ì°¨ëŸ‰ê´€ë¦¬</button>
                <button onclick="showSettlementTab('customers')" id="s-tab-customers" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ‘¥ ê³ ê°ê´€ë¦¬</button>
                <button onclick="showSettlementTab('charges')" id="s-tab-charges" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ’³ ìë™ê²°ì œ</button>
                <button onclick="showSettlementTab('ledger')" id="s-tab-ledger" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ“– ì›ì¥</button>
                <button onclick="showSettlementTab('delinquent')" id="s-tab-delinquent" class="px-4 py-3 font-bold text-sm text-gray-500">âš ï¸ ì—°ì²´</button>
                <button onclick="showSettlementTab('settings')" id="s-tab-settings" class="px-4 py-3 font-bold text-sm text-gray-500">âš™ï¸ ì„¤ì •</button>
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-6">
            <!-- í†µí•©í˜„í™© -->
            <div id="s-content-overview" class="s-tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-lime-400/50" onclick="showSettlementTab('contracts')">
                        <div class="text-3xl mb-2">ğŸ“‹</div>
                        <div class="text-gray-400 text-xs mb-1">ì´ ê³„ì•½</div>
                        <div class="text-2xl font-black text-lime-400" id="s-total">12ê±´</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-emerald-400/50" onclick="openMonthlyReceiptModal()">
                        <div class="text-3xl mb-2">ğŸ’°</div>
                        <div class="text-gray-400 text-xs mb-1">ì´ë²ˆë‹¬ ìˆ˜ë‚©</div>
                        <div class="text-2xl font-black text-emerald-400" id="s-revenue">â‚©6,500,000</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-orange-400/50" onclick="openArrearsModal()">
                        <div class="text-3xl mb-2">âš ï¸</div>
                        <div class="text-gray-400 text-xs mb-1">ë¯¸ë‚© ì´ì•¡</div>
                        <div class="text-2xl font-black text-orange-400" id="s-arrears">â‚©850,000</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5 relative overflow-hidden cursor-pointer hover:border-blue-400/50" onclick="showSettlementTab('ledger')">
                        <div class="text-3xl mb-2">ğŸ“…</div>
                        <div class="text-gray-400 text-xs mb-1">ì˜¤ëŠ˜ ë°œìƒ</div>
                        <div class="text-2xl font-black text-blue-400" id="s-today">â‚©217,000</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="font-bold text-orange-400 mb-4">ğŸš¨ ì—°ì²´ ê³„ì•½</h3>
                        <div class="space-y-2" id="s-delinquent-list"></div>
                    </div>
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="font-bold text-emerald-400 mb-4">ğŸ’³ ìµœê·¼ ê²°ì œ</h3>
                        <div class="space-y-2" id="s-recent-payments"></div>
                    </div>
                </div>
            </div>

            <!-- ê³„ì•½ê´€ë¦¬ -->
            <div id="s-content-contracts" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterContracts('')"><div class="text-2xl mb-1">ğŸ“‹</div><div class="text-gray-400 text-xs">ì „ì²´ ê³„ì•½</div><div class="text-xl font-black text-lime-400" id="contract-total">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterContracts('active')"><div class="text-2xl mb-1">âœ…</div><div class="text-gray-400 text-xs">ì§„í–‰ì¤‘</div><div class="text-xl font-black text-blue-400" id="contract-active">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterContracts('delinquent')"><div class="text-2xl mb-1">âš ï¸</div><div class="text-gray-400 text-xs">ì—°ì²´</div><div class="text-xl font-black text-orange-400" id="contract-delinquent">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-emerald-400/50" onclick="openMonthlyRevenueModal()"><div class="text-2xl mb-1">ğŸ’°</div><div class="text-gray-400 text-xs">ì›” ì •ì‚°ê¸ˆì•¡</div><div class="text-xl font-black text-emerald-400" id="contract-revenue">-</div><div class="text-xs text-gray-500 mt-1" id="contract-revenue-count">- ê±´</div></div>
                </div>
                <!-- ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ­ -->
                <div class="flex gap-2 mb-4">
                    <button onclick="switchContractType('rent')" id="contract-tab-rent" class="px-6 py-2 rounded-lg font-bold text-sm bg-purple-500/20 text-purple-400 border border-purple-500/30">ğŸï¸ ë ŒíŠ¸</button>
                    <button onclick="switchContractType('lease')" id="contract-tab-lease" class="px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10">ğŸ“„ ë¦¬ìŠ¤</button>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="contract-search" class="input-field" style="width:180px" placeholder="ê³ ê°ëª…, ë²ˆí˜¸íŒ ê²€ìƒ‰...">
                        <select id="contract-status" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="active">ì§„í–‰ì¤‘</option>
                            <option value="delinquent">ì—°ì²´</option>
                        </select>
                        <button onclick="loadContracts()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('contracts')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('contractModal')" class="btn-primary btn-sm">+ ê³„ì•½ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë²ˆí˜¸</th><th>ê³ ê°</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ë²ˆí˜¸íŒ</th><th>ì—°ë£Œ</th><th>ê³„ì•½ê¸°ê°„</th><th>ì›”ë‚©ì…</th><th>ë¯¸ë‚©</th><th>ìƒíƒœ</th><th>ì„œë¥˜</th></tr></thead>
                        <tbody id="contract-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì°¨ëŸ‰ê´€ë¦¬ -->
            <div id="s-content-vehicles" class="s-tab-content hidden">
                <div class="grid grid-cols-5 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterVehicles('ì…ê³ ')"><div class="text-2xl mb-1">ğŸ“¥</div><div class="text-gray-400 text-xs">ì…ê³ (ëŒ€ê¸°)</div><div class="text-xl font-black text-lime-400" id="v-stock">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterVehicles('ì¶œê³ ')"><div class="text-2xl mb-1">ğŸ“¤</div><div class="text-gray-400 text-xs">ì¶œê³ (ê³„ì•½ì¤‘)</div><div class="text-xl font-black text-blue-400" id="v-out">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterVehicles('ë°˜ë‚©')"><div class="text-2xl mb-1">ğŸ”„</div><div class="text-gray-400 text-xs">ë°˜ë‚©(ì ê²€)</div><div class="text-xl font-black text-yellow-400" id="v-return">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterVehicles('ì •ë¹„')"><div class="text-2xl mb-1">ğŸ”§</div><div class="text-gray-400 text-xs">ì •ë¹„ì¤‘</div><div class="text-xl font-black text-orange-400" id="v-repair">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-gray-400/50" onclick="filterVehicles('íì°¨')"><div class="text-2xl mb-1">ğŸš«</div><div class="text-gray-400 text-xs">íì°¨/ë§¤ê°</div><div class="text-xl font-black text-gray-400" id="v-disposed">-</div></div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="vehicle-search" class="input-field" style="width:180px" placeholder="ë²ˆí˜¸íŒ, ëª¨ë¸ ê²€ìƒ‰...">
                        <select id="vehicle-status" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="ì…ê³ ">ì…ê³ (ëŒ€ê¸°)</option>
                            <option value="ì¶œê³ ">ì¶œê³ (ê³„ì•½ì¤‘)</option>
                            <option value="ë°˜ë‚©">ë°˜ë‚©(ì ê²€)</option>
                            <option value="ì •ë¹„">ì •ë¹„ì¤‘</option>
                            <option value="íì°¨">íì°¨/ë§¤ê°</option>
                        </select>
                        <button onclick="loadVehicles()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('vehicles')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('vehicleModal')" class="btn-primary btn-sm">+ ì°¨ëŸ‰ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë²ˆí˜¸íŒ</th><th>ëª¨ë¸</th><th>ì—°ì‹</th><th>ìƒ‰ìƒ</th><th>ì£¼í–‰ê±°ë¦¬</th><th>ìƒíƒœ</th><th>ì—°ê²°ê³„ì•½</th></tr></thead>
                        <tbody id="vehicle-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³ ê°ê´€ë¦¬ -->
            <div id="s-content-customers" class="s-tab-content hidden">
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterCustomers('')"><div class="text-2xl mb-1">ğŸ‘¥</div><div class="text-gray-400 text-xs">ì „ì²´ ê³ ê°</div><div class="text-xl font-black text-lime-400" id="cust-total">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterCustomers('ìƒ')"><div class="text-2xl mb-1">â­</div><div class="text-gray-400 text-xs">ë“±ê¸‰ ìƒ</div><div class="text-xl font-black text-yellow-400" id="cust-high">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterCustomers('ì¤‘')"><div class="text-2xl mb-1">âœ…</div><div class="text-gray-400 text-xs">ë“±ê¸‰ ì¤‘</div><div class="text-xl font-black text-blue-400" id="cust-mid">-</div></div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-gray-400/50" onclick="filterCustomers('í•˜')"><div class="text-2xl mb-1">ğŸ“‹</div><div class="text-gray-400 text-xs">ë“±ê¸‰ í•˜</div><div class="text-xl font-black text-gray-400" id="cust-low">-</div></div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="text" id="cust-search" class="input-field" style="width:180px" placeholder="ì´ë¦„, ì—°ë½ì²˜ ê²€ìƒ‰...">
                        <select id="cust-grade" class="input-field" style="width:100px">
                            <option value="">ì „ì²´ ë“±ê¸‰</option>
                            <option value="ìƒ">ìƒ</option>
                            <option value="ì¤‘">ì¤‘</option>
                            <option value="í•˜">í•˜</option>
                        </select>
                        <button onclick="loadCustomers()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('customers')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openCustomerModal()" class="btn-primary btn-sm">+ ê³ ê° ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì£¼ì†Œ</th><th>ê±°ë˜ë“±ê¸‰</th><th>ë©”ëª¨</th><th>ë“±ë¡ì¼</th></tr></thead>
                        <tbody id="cust-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ìë™ê²°ì œ(PG) -->
            <div id="s-content-charges" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 cursor-pointer hover:bg-lime-400/5" onclick="filterPgPayments('')">
                        <div class="text-lime-400 text-xs mb-1">ğŸ’³ ë“±ë¡ ì¹´ë“œ</div>
                        <div class="text-2xl font-black text-lime-400" id="pg-cards">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 cursor-pointer hover:bg-blue-400/5" onclick="filterPgPayments('active')">
                        <div class="text-blue-400 text-xs mb-1">âœ… í™œì„± ì¹´ë“œ</div>
                        <div class="text-2xl font-black text-blue-400" id="pg-active">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 cursor-pointer hover:bg-yellow-400/5" onclick="filterPgPayments('scheduled')">
                        <div class="text-yellow-400 text-xs mb-1">ğŸ“… ê²°ì œ ì˜ˆì •</div>
                        <div class="text-2xl font-black text-yellow-400" id="pg-scheduled">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 cursor-pointer hover:bg-emerald-400/5" onclick="filterPgPayments('success')">
                        <div class="text-emerald-400 text-xs mb-1">ğŸ’° ê²°ì œ ì™„ë£Œ</div>
                        <div class="text-2xl font-black text-emerald-400" id="pg-completed">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="filterPgPayments('failed')">
                        <div class="text-red-400 text-xs mb-1">âŒ ê²°ì œ ì‹¤íŒ¨</div>
                        <div class="text-2xl font-black text-red-400" id="pg-failed">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="pg-status" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                            <option value="scheduled">ì˜ˆì •</option>
                            <option value="success">ì„±ê³µ</option>
                            <option value="failed">ì‹¤íŒ¨</option>
                        </select>
                        <select id="pg-contract-filter" class="input-field" style="width:150px">
                            <option value="">ì „ì²´ ê³„ì•½</option>
                        </select>
                        <input type="text" id="pg-search" class="input-field" style="width:150px" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                        <button onclick="loadPgPayments()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('pg')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openPgCardModal()" class="btn-primary btn-sm">+ ì¹´ë“œ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³„ì•½ë²ˆí˜¸</th><th>ê³ ê°ëª…</th><th>ì°¨ëŸ‰</th><th>ì¹´ë“œì •ë³´</th><th>ê²°ì œê¸ˆì•¡</th><th>ê²°ì œì£¼ê¸°</th><th>ìµœê·¼ê²°ì œ</th><th>ì¹´ë“œìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="pg-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì›ì¥ -->
            <div id="s-content-ledger" class="s-tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 cursor-pointer hover:bg-emerald-400/5" onclick="openMonthlyReceiptModal()">
                        <div class="text-emerald-400 text-xs mb-1">âœ… ì´ë²ˆë‹¬ ìˆ˜ë‚©</div>
                        <div class="text-2xl font-black text-emerald-400" id="ledger-receipt">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="ledger-receipt-count">- ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 cursor-pointer hover:bg-orange-400/5" onclick="filterLedgerUnpaid()">
                        <div class="text-orange-400 text-xs mb-1">âš ï¸ ì´ ë¯¸ìˆ˜ê¸ˆ</div>
                        <div class="text-2xl font-black text-orange-400" id="ledger-arrears">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="ledger-arrears-count">- ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400 cursor-pointer hover:bg-purple-400/5" onclick="openCollectionRateModal()">
                        <div class="text-purple-400 text-xs mb-1">ğŸ“Š ì´ë²ˆë‹¬ ìˆ˜ë‚©ë¥ </div>
                        <div class="text-2xl font-black text-purple-400" id="ledger-rate">-</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                </div>
                
                <!-- ìˆ˜ë‚© ë°©ë²•ë³„ ê·¸ë˜í”„ -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lime-400">ğŸ’³ ì´ë²ˆë‹¬ ìˆ˜ë‚© í˜„í™©</h3>
                        <span class="text-xs text-gray-500" id="ledger-month-label">-</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- ìˆ˜ë‚© ë°©ë²•ë³„ ë§‰ëŒ€ ê·¸ë˜í”„ -->
                        <div>
                            <div class="text-xs text-gray-400 mb-3">ê²°ì œ ë°©ë²•ë³„</div>
                            <div class="space-y-3" id="ledger-method-bars"></div>
                        </div>
                        <!-- ìˆ˜ë‚© ë°©ë²•ë³„ ì›í˜• ë¹„ìœ¨ -->
                        <div>
                            <div class="text-xs text-gray-400 mb-3">ë¹„ìœ¨</div>
                            <div class="flex items-center justify-center gap-6">
                                <div class="relative w-32 h-32">
                                    <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                        <circle id="ledger-pie-card" cx="18" cy="18" r="16" fill="none" stroke="#3B82F6" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                        <circle id="ledger-pie-cash" cx="18" cy="18" r="16" fill="none" stroke="#10B981" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                        <circle id="ledger-pie-transfer" cx="18" cy="18" r="16" fill="none" stroke="#F59E0B" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="text-xs text-gray-400">ì´ì•¡</div>
                                            <div class="text-sm font-bold text-emerald-400" id="ledger-pie-total">â‚©0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2" id="ledger-method-legend"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="ledger-type" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="accrual">ë°œìƒ</option>
                            <option value="receipt">ìˆ˜ë‚©</option>
                            <option value="adjust">ì¡°ì •</option>
                        </select>
                        <select id="ledger-contract" class="input-field" style="width:150px">
                            <option value="">ì „ì²´ ê³„ì•½</option>
                        </select>
                        <input type="date" id="ledger-start" class="input-field" style="width:140px">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="ledger-end" class="input-field" style="width:140px">
                        <button onclick="loadLedger()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('ledger')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openLedgerModal()" class="btn-primary btn-sm">+ ë‚´ì—­ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ì¼ì</th><th>ê³ ê°ëª…</th><th>êµ¬ë¶„</th><th>ë‚´ìš©</th><th>ë°œìƒ</th><th>ìˆ˜ë‚©</th><th>ì”ì•¡</th></tr></thead>
                        <tbody id="ledger-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì—°ì²´ -->
            <div id="s-content-delinquent" class="s-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 cursor-pointer hover:bg-red-400/5" onclick="filterDelinquent('')">
                        <div class="text-red-400 text-xs mb-1">ğŸš¨ ì—°ì²´ ê³„ì•½</div>
                        <div class="text-2xl font-black text-red-400" id="del-count">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-orange-400 cursor-pointer hover:bg-orange-400/5" onclick="filterDelinquent('')">
                        <div class="text-orange-400 text-xs mb-1">ğŸ’¸ ì—°ì²´ ì´ì•¡</div>
                        <div class="text-2xl font-black text-orange-400" id="del-total">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-yellow-400 cursor-pointer hover:bg-yellow-400/5" onclick="filterDelinquent('30')">
                        <div class="text-yellow-400 text-xs mb-1">â° 30ì¼ ë¯¸ë§Œ</div>
                        <div class="text-2xl font-black text-yellow-400" id="del-30">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-600 cursor-pointer hover:bg-red-600/5" onclick="filterDelinquent('90')">
                        <div class="text-red-600 text-xs mb-1">ğŸ”¥ 60ì¼ ì´ìƒ</div>
                        <div class="text-2xl font-black text-red-600" id="del-60">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="del-period" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ê¸°ê°„</option>
                            <option value="30">30ì¼ ë¯¸ë§Œ</option>
                            <option value="60">30~60ì¼</option>
                            <option value="90">60ì¼ ì´ìƒ</option>
                        </select>
                        <select id="del-sort" class="input-field" style="width:100px">
                            <option value="amount">ê¸ˆì•¡ìˆœ</option>
                            <option value="days">ê¸°ê°„ìˆœ</option>
                            <option value="name">ì´ë¦„ìˆœ</option>
                        </select>
                        <input type="text" id="del-search" class="input-field" style="width:150px" placeholder="ê³ ê°ëª…, ì°¨ëŸ‰ ê²€ìƒ‰...">
                        <button onclick="loadDelinquent()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <button onclick="downloadExcel('delinquent')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ì—°ì²´ê¸ˆì•¡</th><th>ì—°ì²´ì¼ìˆ˜</th><th>ìµœê·¼ì—°ë½</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="del-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì„¤ì • -->
            <div id="s-content-settings" class="s-tab-content hidden">
                <div class="flex border-b border-white/10 mb-6">
                    <div class="setting-tab active" onclick="showSettingTab('staff', this)">ğŸ‘¥ ì§ì› ê´€ë¦¬</div>
                    <div class="setting-tab" onclick="showSettingTab('pg', this)">ğŸ’³ PG ì„¤ì •</div>
                    <div class="setting-tab" onclick="showSettingTab('system', this)">ğŸ”§ ì‹œìŠ¤í…œ ì„¤ì •</div>
                </div>
                
                <!-- ì§ì› ê´€ë¦¬ -->
                <div id="setting-staff" class="setting-content">
                    <div class="glass-card rounded-xl p-4 mb-4 flex justify-between items-center">
                        <div><h3 class="font-bold text-lime-400 text-lg">ì§ì› ê´€ë¦¬</h3><p class="text-gray-400 text-sm mt-1">í†µí•© ERP ì‹œìŠ¤í…œ ì§ì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (ì •ì‚°ê´€ë¦¬ + ë¸Œë¡œëª¨í„°ìŠ¤)</p></div>
                        <button onclick="openStaffModal()" class="btn-primary">+ ì§ì› ë“±ë¡</button>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>ë¶€ì„œ</th><th>ê¶Œí•œë“±ê¸‰</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="staff-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PG ì„¤ì • -->
                <div id="setting-pg" class="setting-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- PG ê°€ë§¹ì  ì„¤ì • -->
                        <div class="glass-card rounded-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="font-bold text-lime-400 text-lg">ğŸ’³ PG ê°€ë§¹ì  ì„¤ì •</h3>
                                    <p class="text-gray-400 text-xs mt-1">ê²°ì œ ëŒ€í–‰ì‚¬ ì—°ë™ ì„¤ì •</p>
                                </div>
                                <span class="badge badge-active" id="pg-status-badge">ì—°ë™ì¤‘</span>
                            </div>
                            
                            <form id="pgSettingsForm" class="space-y-4">
                                <div>
                                    <label class="block text-xs text-lime-400 mb-1">PGì‚¬ ì„ íƒ*</label>
                                    <select id="pg-provider" class="input-field" onchange="onPgProviderChange(this.value)">
                                        <option value="nicepay">ë‚˜ì´ìŠ¤í˜ì´ (NicePay)</option>
                                        <option value="inicis">KGì´ë‹ˆì‹œìŠ¤</option>
                                        <option value="toss">í† ìŠ¤í˜ì´ë¨¼ì¸ </option>
                                        <option value="kakao">ì¹´ì¹´ì˜¤í˜ì´</option>
                                        <option value="danal">ë‹¤ë‚ </option>
                                        <option value="settle">ì„¸í‹€ë±…í¬</option>
                                        <option value="kcp">NHN KCP</option>
                                    </select>
                                </div>
                                
                                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                    <div class="text-xs text-blue-400 mb-3">ğŸ”‘ API ì¸ì¦ ì •ë³´</div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê°€ë§¹ì  ID (MID)*</label>
                                            <input type="text" id="pg-mid" class="input-field font-mono" placeholder="ì˜ˆ: nicepay00m">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ìƒì  í‚¤ (Merchant Key)*</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="pg-merchant-key" class="input-field font-mono flex-1" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                                <button type="button" onclick="toggleKeyVisibility('pg-merchant-key')" class="btn-secondary btn-sm">ğŸ‘ï¸</button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ì‹œí¬ë¦¿ í‚¤ (Secret Key)</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="pg-secret-key" class="input-field font-mono flex-1" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                                <button type="button" onclick="toggleKeyVisibility('pg-secret-key')" class="btn-secondary btn-sm">ğŸ‘ï¸</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                    <div class="text-xs text-emerald-400 mb-3">ğŸŒ API ì—”ë“œí¬ì¸íŠ¸</div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê²°ì œ ìš”ì²­ URL</label>
                                            <input type="text" id="pg-api-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/payments">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê²°ì œ ì·¨ì†Œ URL</label>
                                            <input type="text" id="pg-cancel-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/payments/cancel">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ë¹Œë§í‚¤ ë°œê¸‰ URL</label>
                                            <input type="text" id="pg-billing-url" class="input-field font-mono text-xs" placeholder="https://api.nicepay.co.kr/v1/subscribe/regist">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">ìš´ì˜ ëª¨ë“œ</label>
                                        <select id="pg-mode" class="input-field">
                                            <option value="test">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</option>
                                            <option value="production">ìš´ì˜ ëª¨ë“œ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">íƒ€ì„ì•„ì›ƒ (ì´ˆ)</label>
                                        <input type="number" id="pg-timeout" class="input-field" value="30" min="10" max="120">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-2">
                                    <button type="button" onclick="testPgConnection()" class="btn-secondary flex-1">ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                                    <button type="button" onclick="savePgSettings()" class="btn-primary flex-1">ğŸ’¾ ì €ì¥</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- API ë¬¸ì„œ ë° ê²°ì œ ì„¤ì • -->
                        <div class="space-y-6">
                            <!-- ë¹Œë§ ì„¤ì • -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-blue-400 text-lg mb-4">ğŸ”„ ì •ê¸°ê²°ì œ (ë¹Œë§) ì„¤ì •</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">ìë™ ë¹Œë§ í™œì„±í™”</div>
                                            <div class="text-xs text-gray-400">ë“±ë¡ëœ ì¹´ë“œë¡œ ìë™ ê²°ì œ</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-billing-enabled" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê¸°ë³¸ ê²°ì œì¼</label>
                                            <select id="pg-default-pay-day" class="input-field">
                                                <option value="1">ë§¤ì›” 1ì¼</option>
                                                <option value="5">ë§¤ì›” 5ì¼</option>
                                                <option value="10" selected>ë§¤ì›” 10ì¼</option>
                                                <option value="15">ë§¤ì›” 15ì¼</option>
                                                <option value="20">ë§¤ì›” 20ì¼</option>
                                                <option value="25">ë§¤ì›” 25ì¼</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ê²°ì œ ì‹œê°„</label>
                                            <select id="pg-pay-time" class="input-field">
                                                <option value="09">ì˜¤ì „ 9ì‹œ</option>
                                                <option value="10">ì˜¤ì „ 10ì‹œ</option>
                                                <option value="14">ì˜¤í›„ 2ì‹œ</option>
                                                <option value="18">ì˜¤í›„ 6ì‹œ</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„</label>
                                            <select id="pg-retry-count" class="input-field">
                                                <option value="0">ì¬ì‹œë„ ì•ˆí•¨</option>
                                                <option value="1">1íšŒ</option>
                                                <option value="2">2íšŒ</option>
                                                <option value="3" selected>3íšŒ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">ì¬ì‹œë„ ê°„ê²©</label>
                                            <select id="pg-retry-interval" class="input-field">
                                                <option value="1">1ì¼</option>
                                                <option value="2" selected>2ì¼</option>
                                                <option value="3">3ì¼</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- API ë¬¸ì„œ ì°¸ì¡° -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-purple-400 text-lg mb-4">ğŸ“š API ë¬¸ì„œ</h3>
                                <div class="space-y-3">
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('nicepay')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">ë‚˜ì´ìŠ¤í˜ì´ API ë¬¸ì„œ</div>
                                                <div class="text-xs text-gray-400">developers.nicepay.co.kr</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('inicis')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">KGì´ë‹ˆì‹œìŠ¤ API ë¬¸ì„œ</div>
                                                <div class="text-xs text-gray-400">manual.inicis.com</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </div>
                                    </div>
                                    <div class="p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-purple-400/50" onclick="openPgDocs('toss')">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-bold text-sm">í† ìŠ¤í˜ì´ë¨¼ì¸  API ë¬¸ì„œ</div>
                                                <div class="text-xs text-gray-400">docs.tosspayments.com</div>
                                            </div>
                                            <span class="text-purple-400">â†’</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Webhook ì„¤ì • -->
                            <div class="glass-card rounded-xl p-6">
                                <h3 class="font-bold text-orange-400 text-lg mb-4">ğŸ”” Webhook ì„¤ì •</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Webhook URL</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="pg-webhook-url" class="input-field font-mono text-xs flex-1" placeholder="https://yourdomain.com/api/webhook/pg">
                                            <button type="button" onclick="copyWebhookUrl()" class="btn-secondary btn-sm">ğŸ“‹</button>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">ê²°ì œ ì™„ë£Œ ì•Œë¦¼</div>
                                            <div class="text-xs text-gray-400">ê²°ì œ ì„±ê³µ ì‹œ Webhook ë°œì†¡</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-webhook-success" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10">
                                        <div>
                                            <div class="font-bold text-sm">ê²°ì œ ì‹¤íŒ¨ ì•Œë¦¼</div>
                                            <div class="text-xs text-gray-400">ê²°ì œ ì‹¤íŒ¨ ì‹œ Webhook ë°œì†¡</div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="pg-webhook-fail" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-lime-500 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
                <div id="setting-system" class="setting-content hidden">
                    <div class="glass-card rounded-xl p-6">
                        <div class="text-lime-400 font-bold mb-4">ğŸ”§ ì‹œìŠ¤í…œ ì„¤ì •</div>
                        <div class="text-gray-500">ì‹œìŠ¤í…œ ì„¤ì • (ì¤€ë¹„ì¤‘)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ì‹œìŠ¤í…œ ======================= -->
    <div id="bromotorsSystem" class="hidden">
        <!-- í—¤ë” -->
        <div class="relative z-10 border-b border-lime-500/30" style="background: linear-gradient(180deg, rgba(57,255,20,0.1) 0%, rgba(0,0,0,0.8) 100%)">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                <div onclick="showBromotorsTab('overview')" class="cursor-pointer">
                    <h1 class="text-2xl font-black neon-text">ë¸Œë¡œëª¨í„°ìŠ¤</h1>
                    <p class="text-lime-400/50 text-xs italic">ì§ì˜ìˆ˜ë¦¬ì </p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-center">
                        <div class="text-xs text-lime-400/70">ì˜¤ëŠ˜ ë‚ ì§œ</div>
                        <div class="text-sm font-bold text-lime-400" id="b-today-date"></div>
                    </div>
                    <button onclick="switchSystem()" class="btn-secondary btn-sm">ğŸ’° ì •ì‚°ê´€ë¦¬</button>
                    <div class="px-3 py-2 rounded-lg glass-card text-right">
                        <div class="text-xs text-lime-400/70" id="b-userRole">ê´€ë¦¬ì</div>
                        <div class="text-sm font-bold" id="b-userName">Admin</div>
                    </div>
                    <button onclick="handleLogout()" class="btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="relative z-10 border-b border-lime-500/20 bg-black/50">
            <div class="max-w-7xl mx-auto px-6 flex space-x-1 overflow-x-auto">
                <button onclick="showBromotorsTab('overview')" id="b-tab-overview" class="px-4 py-3 font-bold text-sm tab-active">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button onclick="showBromotorsTab('work')" id="b-tab-work" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ“ ì‘ì—…ë‚´ìš©</button>
                <button onclick="showBromotorsTab('cashbook')" id="b-tab-cashbook" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ’° ê¸ˆì „ì¶œë‚©ë¶€</button>
                <button onclick="showBromotorsTab('parts')" id="b-tab-parts" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ“¦ ë¶€í’ˆê´€ë¦¬</button>
                <button onclick="showBromotorsTab('customers')" id="b-tab-customers" class="px-4 py-3 font-bold text-sm text-gray-500">ğŸ‘¥ ê³ ê°</button>
                <button onclick="showBromotorsTab('settings')" id="b-tab-settings" class="px-4 py-3 font-bold text-sm text-gray-500">âš™ï¸ ì„¤ì •</button>
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-6">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="b-content-overview" class="b-tab-content">
                <!-- ë‚ ì§œ êµ¬ê°„ í•„í„° -->
                <div class="glass-card rounded-xl p-4 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-lime-400 text-sm font-bold">ğŸ“… ì¡°íšŒ ê¸°ê°„</span>
                            <input type="date" id="b-dash-start" class="input-field" style="width:140px">
                            <span class="text-gray-500">~</span>
                            <input type="date" id="b-dash-end" class="input-field" style="width:140px">
                            <button onclick="loadBroDashboard()" class="btn-secondary btn-sm">ì¡°íšŒ</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setBroDashPeriod('today')" class="btn-secondary btn-sm">ì˜¤ëŠ˜</button>
                            <button onclick="setBroDashPeriod('week')" class="btn-secondary btn-sm">7ì¼</button>
                            <button onclick="setBroDashPeriod('month')" class="btn-secondary btn-sm">ì´ë²ˆë‹¬</button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400 stat-card cursor-pointer hover:border-lime-400" onclick="filterBroCashbook('today')">
                        <div class="text-lime-400 text-xs mb-1">ğŸ’µ ê¸°ê°„ ìˆ˜ì…</div>
                        <div class="text-2xl font-black" id="b-today-income">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-income-count">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400 stat-card cursor-pointer hover:border-red-400" onclick="filterBroCashbook('month-expense')">
                        <div class="text-red-400 text-xs mb-1">ğŸ’¸ ê¸°ê°„ ì§€ì¶œ</div>
                        <div class="text-2xl font-black" id="b-month-expense">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-expense-count">0ê±´</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400 stat-card cursor-pointer hover:border-blue-400" onclick="openBroTodayWorkModal()">
                        <div class="text-blue-400 text-xs mb-1">ğŸ”§ ê¸°ê°„ ì‘ì—…</div>
                        <div class="text-2xl font-black" id="b-period-work">0ê±´</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-work-amount">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-emerald-400 stat-card cursor-pointer hover:border-emerald-400" onclick="openBroMonthSummary()">
                        <div class="text-emerald-400 text-xs mb-1">ğŸ“Š ê¸°ê°„ ìˆœì´ìµ</div>
                        <div class="text-2xl font-black" id="b-month-profit">â‚©0</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-profit-rate">-</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lime-400">ğŸ“‹ ì˜¤ëŠ˜ ì‘ì—…</h3>
                            <span class="text-xs text-gray-500" id="b-today-work-count">0ê±´</span>
                        </div>
                        <div class="space-y-2" id="b-today-work-list"></div>
                    </div>
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-orange-400">âš ï¸ ì¬ê³  ì•Œë¦¼</h3>
                            <span class="text-xs text-gray-500" id="b-low-stock-count">0ê±´</span>
                        </div>
                        <div class="space-y-2" id="b-low-stock-list"></div>
                    </div>
                </div>
            </div>

            <!-- ì‘ì—…ë‚´ìš© -->
            <div id="b-content-work" class="b-tab-content hidden">
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="date" id="b-work-start" class="input-field" style="width:140px">
                        <span class="text-gray-500">~</span>
                        <input type="date" id="b-work-end" class="input-field" style="width:140px">
                        <select id="b-work-status" class="input-field" style="width:100px">
                            <option value="">ì „ì²´ìƒíƒœ</option>
                            <option value="waiting">ëŒ€ê¸°</option>
                            <option value="progress">ì§„í–‰ì¤‘</option>
                            <option value="complete">ì™„ë£Œ</option>
                        </select>
                        <input type="text" id="b-work-search" class="input-field" style="width:150px" placeholder="ê³ ê°ëª…, ì°¨ëŸ‰...">
                        <button onclick="loadBroWork()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBroCardPayModal()" class="btn-secondary btn-sm">ğŸ’³ ì¹´ë“œê²°ì œ</button>
                        <button onclick="downloadExcel('broWork')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('workModal')" class="btn-primary btn-sm">+ ì‘ì—… ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ì ‘ìˆ˜ë²ˆí˜¸</th><th>ë‚ ì§œ</th><th>ê³ ê°</th><th>ì°¨ëŸ‰</th><th>ì‘ì—…ë‚´ìš©</th><th>ê³µì„</th><th>ë¶€í’ˆ</th><th>í•©ê³„</th><th>ìƒíƒœ</th><th>ê²°ì œ</th></tr></thead>
                        <tbody id="b-work-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê¸ˆì „ì¶œë‚©ë¶€ -->
            <div id="b-content-cashbook" class="b-tab-content hidden">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 border-l-4 border-lime-400">
                        <div class="text-lime-400 text-xs mb-1">ğŸ’µ ì´ë²ˆë‹¬ ìˆ˜ì…</div>
                        <div class="text-2xl font-black text-lime-400" id="b-cb-income">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-red-400">
                        <div class="text-red-400 text-xs mb-1">ğŸ’¸ ì´ë²ˆë‹¬ ì§€ì¶œ</div>
                        <div class="text-2xl font-black text-red-400" id="b-cb-expense">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-blue-400">
                        <div class="text-blue-400 text-xs mb-1">ğŸ“Š ìˆœì´ìµ</div>
                        <div class="text-2xl font-black text-blue-400" id="b-cb-profit">â‚©0</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 border-l-4 border-purple-400">
                        <div class="text-purple-400 text-xs mb-1">ğŸ’° í˜„ì¬ ì”ì•¡</div>
                        <div class="text-2xl font-black text-purple-400" id="b-cb-balance">â‚©0</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <input type="date" id="b-cb-date" class="input-field" style="width:140px">
                        <select id="b-cb-type" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="income">ìˆ˜ì…</option>
                            <option value="expense">ì§€ì¶œ</option>
                        </select>
                        <input type="text" id="b-cb-search" class="input-field" style="width:180px" placeholder="ë‚´ìš© ê²€ìƒ‰...">
                        <button onclick="loadBroCashbook()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('broCashbook')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openModal('cashbookModal')" class="btn-primary btn-sm">+ ë‚´ì—­ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ë¶„ë¥˜</th><th>ë‚´ìš©</th><th>ê¸ˆì•¡</th><th>ì”ì•¡</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="b-cb-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ë¶€í’ˆê´€ë¦¬ -->
            <div id="b-content-parts" class="b-tab-content hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterBroParts('')">
                        <div class="text-2xl mb-1">ğŸ“¦</div>
                        <div class="text-gray-400 text-xs">ì „ì²´ ë¶€í’ˆ</div>
                        <div class="text-xl font-black text-lime-400" id="b-parts-total">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-parts-total-qty">ì´ 0ê°œ</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-orange-400/50" onclick="filterBroParts('low')">
                        <div class="text-2xl mb-1">âš ï¸</div>
                        <div class="text-gray-400 text-xs">ì¬ê³  ë¶€ì¡±</div>
                        <div class="text-xl font-black text-orange-400" id="b-parts-low">-</div>
                        <div class="text-xs text-gray-500 mt-1" id="b-parts-low-list">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="openPartsValueModal()">
                        <div class="text-2xl mb-1">ğŸ’°</div>
                        <div class="text-gray-400 text-xs">ì¬ê³  ê¸ˆì•¡</div>
                        <div class="text-xl font-black text-blue-400" id="b-parts-value">-</div>
                        <div class="text-xs text-gray-500 mt-1">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-parts-category" class="input-field" style="width:120px">
                            <option value="">ì „ì²´ ë¶„ë¥˜</option>
                            <option value="ì˜¤ì¼ë¥˜">ì˜¤ì¼ë¥˜</option>
                            <option value="íƒ€ì´ì–´">íƒ€ì´ì–´</option>
                            <option value="ë¸Œë ˆì´í¬">ë¸Œë ˆì´í¬</option>
                            <option value="í•„í„°">í•„í„°</option>
                            <option value="ë°°í„°ë¦¬">ë°°í„°ë¦¬</option>
                            <option value="ì „ì¥">ì „ì¥</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                        <select id="b-parts-stock-filter" class="input-field" style="width:100px">
                            <option value="">ì „ì²´ìƒíƒœ</option>
                            <option value="low">ë¶€ì¡±</option>
                            <option value="normal">ì •ìƒ</option>
                            <option value="zero">í’ˆì ˆ</option>
                        </select>
                        <input type="text" id="b-parts-search" class="input-field" style="width:150px" placeholder="ë¶€í’ˆëª… ê²€ìƒ‰...">
                        <button onclick="loadBroParts()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel('broParts')" class="btn-secondary btn-sm">ğŸ“¥ ì—‘ì…€</button>
                        <button onclick="openPartsModal()" class="btn-primary btn-sm">+ ë¶€í’ˆ ë“±ë¡</button>
                    </div>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ë¶€í’ˆëª…</th><th>ë¶„ë¥˜</th><th>ì¬ê³ </th><th>ìµœì†Œì¬ê³ </th><th>ë‹¨ê°€</th><th>ì¬ê³ ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="b-parts-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³ ê° -->
            <div id="b-content-customers" class="b-tab-content hidden">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-lime-400/50" onclick="filterBroCustomers('')">
                        <div class="text-2xl mb-1">ğŸ‘¥</div>
                        <div class="text-gray-400 text-xs">ì „ì²´ ê³ ê°</div>
                        <div class="text-xl font-black text-lime-400" id="b-cust-total">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-blue-400/50" onclick="filterBroCustomers('month')">
                        <div class="text-2xl mb-1">ğŸ”§</div>
                        <div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ë°©ë¬¸</div>
                        <div class="text-xl font-black text-blue-400" id="b-cust-month">-</div>
                    </div>
                    <div class="glass-card rounded-xl p-4 text-center cursor-pointer hover:border-yellow-400/50" onclick="filterBroCustomers('vip')">
                        <div class="text-2xl mb-1">â­</div>
                        <div class="text-gray-400 text-xs">ë‹¨ê³¨ ê³ ê°</div>
                        <div class="text-xl font-black text-yellow-400" id="b-cust-vip">-</div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 mb-4 flex flex-wrap items-center justify-between gap-3">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="b-cust-filter" class="input-field" style="width:100px">
                            <option value="">ì „ì²´</option>
                            <option value="month">ì´ë²ˆë‹¬ ë°©ë¬¸</option>
                            <option value="vip">ë‹¨ê³¨ (3íšŒ+)</option>
                        </select>
                        <input type="text" id="b-cust-search" class="input-field" style="width:180px" placeholder="ê³ ê°ëª…, ì—°ë½ì²˜, ì°¨ëŸ‰ ê²€ìƒ‰...">
                        <button onclick="loadBroCustomers()" class="btn-secondary btn-sm">ê²€ìƒ‰</button>
                    </div>
                    <button onclick="openModal('broCustModal')" class="btn-primary btn-sm">+ ê³ ê° ë“±ë¡</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table">
                        <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ë²ˆí˜¸íŒ</th><th>ë°©ë¬¸íšŸìˆ˜</th><th>ìµœê·¼ë°©ë¬¸</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="b-cust-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì„¤ì • -->
            <div id="b-content-settings" class="b-tab-content hidden">
                <div class="glass-card rounded-xl p-6">
                    <div class="text-lime-400 font-bold mb-4">âš™ï¸ ì„¤ì •</div>
                    <div class="text-gray-400 text-sm">ì§ì› ê´€ë¦¬ëŠ” <span class="text-lime-400 cursor-pointer" onclick="goToSettlementSettings()">ì •ì‚°ê´€ë¦¬ â†’ ì„¤ì •</span>ì—ì„œ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= ëª¨ë‹¬: ì§ì› ë“±ë¡ ======================= -->
    <div id="staffModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="staffModalTitle" class="text-xl font-bold text-lime-400">ğŸ‘¤ ì§ì› ë“±ë¡</h2><button onclick="closeModal('staffModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitStaff(event)" id="staffForm" class="space-y-4">
                <input type="hidden" id="staff-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì´ë¦„*</label><input name="name" id="staff-name" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì•„ì´ë””*</label><input name="username" id="staff-username" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë¹„ë°€ë²ˆí˜¸*</label><input type="password" name="password" id="staff-password" class="input-field"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸*</label><input type="password" name="password_confirm" id="staff-password-confirm" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="staff-phone" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì´ë©”ì¼</label><input type="email" name="email" id="staff-email" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë¶€ì„œ*</label>
                        <select name="department" id="staff-department" class="input-field" required>
                            <option value="">ì„ íƒ</option>
                            <option value="ì •ì‚°íŒ€">ì •ì‚°íŒ€</option>
                            <option value="ì •ë¹„íŒ€">ì •ë¹„íŒ€</option>
                            <option value="ì˜ì—…íŒ€">ì˜ì—…íŒ€</option>
                            <option value="ê³ ê°ì§€ì›íŒ€">ê³ ê°ì§€ì›íŒ€</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìƒíƒœ*</label>
                        <select name="status" id="staff-status" class="input-field" required>
                            <option value="active">ì¬ì§</option>
                            <option value="inactive">í‡´ì‚¬</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ê¶Œí•œ ë“±ê¸‰* (1~4ë‹¨ê³„)</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-gray-400/50 has-[:checked]:border-gray-400 has-[:checked]:bg-gray-400/10">
                            <input type="radio" name="level" value="1" class="hidden" checked>
                            <span class="text-lg mb-1">ğŸ‘¤</span>
                            <span class="text-xs font-bold text-gray-400">Lv.1</span>
                            <span class="text-[10px] text-gray-500">ì‚¬ì›</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-blue-400/50 has-[:checked]:border-blue-400 has-[:checked]:bg-blue-400/10">
                            <input type="radio" name="level" value="2" class="hidden">
                            <span class="text-lg mb-1">â­</span>
                            <span class="text-xs font-bold text-blue-400">Lv.2</span>
                            <span class="text-[10px] text-gray-500">íŒ€ì›</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-orange-400/50 has-[:checked]:border-orange-400 has-[:checked]:bg-orange-400/10">
                            <input type="radio" name="level" value="3" class="hidden">
                            <span class="text-lg mb-1">ğŸ‘‘</span>
                            <span class="text-xs font-bold text-orange-400">Lv.3</span>
                            <span class="text-[10px] text-gray-500">ë§¤ë‹ˆì €</span>
                        </label>
                        <label class="flex flex-col items-center p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-red-400/50 has-[:checked]:border-red-400 has-[:checked]:bg-red-400/10">
                            <input type="radio" name="level" value="4" class="hidden">
                            <span class="text-lg mb-1">ğŸ”¥</span>
                            <span class="text-xs font-bold text-red-400">Lv.4</span>
                            <span class="text-[10px] text-gray-500">ìµœê³ ê´€ë¦¬ì</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('staffModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="staffSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ëª¨ë‹¬: ê³ ê° ë“±ë¡/ìˆ˜ì • ======================= -->
    <div id="customerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="customerModalTitle" class="text-xl font-bold text-lime-400">ğŸ‘¤ ê³ ê° ë“±ë¡</h2><button onclick="closeModal('customerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitCustomer(event)" id="customerForm" class="space-y-4">
                <input type="hidden" id="cust-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="name" id="cust-name" class="input-field" placeholder="í™ê¸¸ë™" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì£¼ë¯¼ë²ˆí˜¸</label><input name="ssn" id="cust-ssn" class="input-field" placeholder="000000-0000000"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="cust-phone" class="input-field" placeholder="010-0000-0000" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì´ë©”ì¼</label><input type="email" name="email" id="cust-email" class="input-field" placeholder="example@email.com"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ì£¼ì†Œ</label><input name="address" id="cust-address" class="input-field" placeholder="ì£¼ì†Œ"></div>
                <div><label class="block text-xs text-lime-400 mb-1">ê±°ë˜ë“±ê¸‰*</label>
                    <select name="grade" id="cust-grade-select" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="ìƒ">ìƒ</option>
                        <option value="ì¤‘">ì¤‘</option>
                        <option value="í•˜">í•˜</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="cust-memo" class="input-field" rows="2" placeholder="ê³ ê° ë©”ëª¨"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('customerModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="customerSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ëª¨ë‹¬: ê³ ê° ìƒì„¸ ======================= -->
    <div id="customerDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ‘¤ ê³ ê° ìƒì„¸</h2><button onclick="closeModal('customerDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="customer-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì‘ì—… ë“±ë¡ ======================= -->
    <div id="workModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ”§ ì‘ì—… ë“±ë¡</h2><button onclick="closeModal('workModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroWork(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="customer" id="work-customer" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="work-phone" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì°¨ëŸ‰*</label><input name="vehicle" id="work-vehicle" class="input-field" placeholder="PCX 125" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ë²ˆí˜¸íŒ</label><input name="plate" id="work-plate" class="input-field" placeholder="12ê°€3456"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ì‘ì—…ë‚´ìš©*</label><input name="content" id="work-content" class="input-field" placeholder="ì—”ì§„ì˜¤ì¼ êµí™˜" required></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³µì„</label><input type="number" name="labor" id="work-labor" class="input-field" value="0"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ë¶€í’ˆë¹„</label><input type="number" name="parts_cost" id="work-parts" class="input-field" value="0"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="work-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('workModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê¸ˆì „ì¶œë‚© ë“±ë¡ ======================= -->
    <div id="cashbookModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="cashbookModalTitle" class="text-xl font-bold text-lime-400">ğŸ’° ë‚´ì—­ ë“±ë¡</h2><button onclick="closeModal('cashbookModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroCashbook(event)" class="space-y-4">
                <input type="hidden" id="cashbook-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë‚ ì§œ*</label><input type="date" name="date" id="cb-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">êµ¬ë¶„*</label>
                        <select name="type" id="cb-type" class="input-field" required>
                            <option value="income">ìˆ˜ì…</option>
                            <option value="expense">ì§€ì¶œ</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë¶„ë¥˜*</label>
                    <select name="category" id="cb-category" class="input-field" required>
                        <option value="ì •ë¹„ìˆ˜ì…">ì •ë¹„ìˆ˜ì…</option>
                        <option value="ë¶€í’ˆíŒë§¤">ë¶€í’ˆíŒë§¤</option>
                        <option value="ë¶€í’ˆêµ¬ë§¤">ë¶€í’ˆêµ¬ë§¤</option>
                        <option value="ì„ëŒ€ë£Œ">ì„ëŒ€ë£Œ</option>
                        <option value="ì¸ê±´ë¹„">ì¸ê±´ë¹„</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë‚´ìš©*</label><input name="description" id="cb-description" class="input-field" required></div>
                <div><label class="block text-xs text-lime-400 mb-1">ê¸ˆì•¡*</label><input type="number" name="amount" id="cb-amount" class="input-field" required></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('cashbookModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="cashbookSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ë¶€í’ˆ ë“±ë¡/ìˆ˜ì • ======================= -->
    <div id="partsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 id="partsModalTitle" class="text-xl font-bold text-lime-400">ğŸ“¦ ë¶€í’ˆ ë“±ë¡</h2><button onclick="closeModal('partsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroParts(event)" id="partsForm" class="space-y-4">
                <input type="hidden" id="parts-edit-id">
                <div><label class="block text-xs text-lime-400 mb-1">ë¶€í’ˆëª…*</label><input name="name" id="parts-name" class="input-field" required></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë¶„ë¥˜*</label>
                        <select name="category" id="parts-category" class="input-field" required>
                            <option value="ì˜¤ì¼ë¥˜">ì˜¤ì¼ë¥˜</option>
                            <option value="íƒ€ì´ì–´">íƒ€ì´ì–´</option>
                            <option value="ë¸Œë ˆì´í¬">ë¸Œë ˆì´í¬</option>
                            <option value="í•„í„°">í•„í„°</option>
                            <option value="ë°°í„°ë¦¬">ë°°í„°ë¦¬</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì¬ê³ ìˆ˜ëŸ‰*</label><input type="number" name="stock" id="parts-stock" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë‹¨ê°€*</label><input type="number" name="price" id="parts-price" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìµœì†Œì¬ê³ </label><input type="number" name="min_stock" id="parts-min" class="input-field" value="5"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('partsModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" id="partsSubmitBtn" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê³ ê° ë“±ë¡ ======================= -->
    <div id="broCustModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ‘¤ ê³ ê° ë“±ë¡</h2><button onclick="closeModal('broCustModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitBroCustomer(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="name" id="bro-cust-name" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="bro-cust-phone" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì°¨ëŸ‰</label><input name="vehicle" id="bro-cust-vehicle" class="input-field" placeholder="PCX 125"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ë²ˆí˜¸íŒ</label><input name="plate" id="bro-cust-plate" class="input-field" placeholder="12ê°€3456"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="bro-cust-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('broCustModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì‘ì—… ìƒì„¸ ======================= -->
    <div id="workDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ”§ ì‘ì—… ìƒì„¸</h2><button onclick="closeModal('workDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="work-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê³ ê° ìƒì„¸ ======================= -->
    <div id="broCustDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ‘¤ ê³ ê° ìƒì„¸ ì •ë³´</h2><button onclick="closeModal('broCustDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-cust-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì›”ê°„ ìš”ì•½ ======================= -->
    <div id="broMonthSummaryModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ğŸ“Š ì´ë²ˆë‹¬ ìˆ˜ìµ í˜„í™©</h2><button onclick="closeModal('broMonthSummaryModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-month-summary-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì˜¤ëŠ˜ ì‘ì—… ìƒì„¸ ======================= -->
    <div id="broTodayWorkModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ“‹ ì˜¤ëŠ˜ ì‘ì—… í˜„í™©</h2><button onclick="closeModal('broTodayWorkModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-today-work-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì¬ê³  ì•Œë¦¼ ìƒì„¸ ======================= -->
    <div id="broLowStockModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">âš ï¸ ì¬ê³  ë¶€ì¡± í˜„í™©</h2><button onclick="closeModal('broLowStockModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-low-stock-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì¬ê³  ê¸ˆì•¡ ìƒì„¸ ======================= -->
    <div id="broPartsValueModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-blue-400">ğŸ’° ì¬ê³  ê¸ˆì•¡ í˜„í™©</h2><button onclick="closeModal('broPartsValueModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="bro-parts-value-content"></div>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ì¹´ë“œê²°ì œ ======================= -->
    <div id="broCardPayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-blue-400">ğŸ’³ ì¹´ë“œ ìˆ˜ë™ê²°ì œ</h2><button onclick="closeModal('broCardPayModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="processBroCardPayment(event)" class="space-y-4">
                <!-- ê²°ì œì ìœ í˜• -->
                <div>
                    <label class="block text-xs text-lime-400 mb-2">ê²°ì œì ìœ í˜•*</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50 has-[:checked]:border-lime-400 has-[:checked]:bg-lime-400/10">
                            <input type="radio" name="payer_type" value="personal" class="accent-lime-400" checked onchange="togglePayerType(this.value)">
                            <div><div class="font-bold">ğŸ‘¤ ê°œì¸</div><div class="text-xs text-gray-400">ê°œì¸ ì¹´ë“œ ê²°ì œ</div></div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-blue-400/50 has-[:checked]:border-blue-400 has-[:checked]:bg-blue-400/10">
                            <input type="radio" name="payer_type" value="business" class="accent-blue-400" onchange="togglePayerType(this.value)">
                            <div><div class="font-bold">ğŸ¢ ì‚¬ì—…ì/ë²•ì¸</div><div class="text-xs text-gray-400">ì‚¬ì—…ì/ë²•ì¸ ì¹´ë“œ</div></div>
                        </label>
                    </div>
                </div>
                
                <!-- ì‚¬ì—…ì ì •ë³´ (ì‚¬ì—…ì ì„ íƒì‹œë§Œ í‘œì‹œ) -->
                <div id="business-info" class="hidden space-y-3 p-4 rounded-lg bg-blue-400/5 border border-blue-400/20">
                    <div class="text-xs text-blue-400 font-bold mb-2">ğŸ¢ ì‚¬ì—…ì ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input name="biz_no" class="input-field" placeholder="000-00-00000"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒí˜¸ëª…</label><input name="biz_name" class="input-field" placeholder="íšŒì‚¬ëª…"></div>
                    </div>
                    <div><label class="block text-xs text-gray-400 mb-1">ëŒ€í‘œìëª…</label><input name="biz_ceo" class="input-field" placeholder="ëŒ€í‘œìëª…"></div>
                </div>
                
                <!-- ê²°ì œ ì •ë³´ -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê³ ê°ëª…*</label><input name="customer_name" id="bro-pay-customer" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="bro-pay-phone" class="input-field" required></div>
                </div>
                
                <!-- ì¹´ë“œ ì •ë³´ -->
                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 font-bold mb-3">ğŸ’³ ì¹´ë“œ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œë²ˆí˜¸*</label><input name="card_no" id="bro-card-no" class="input-field" placeholder="0000-0000-0000-0000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìœ íš¨ê¸°ê°„*</label><input name="card_expiry" id="bro-card-expiry" class="input-field" placeholder="MM/YY" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">CVC*</label><input name="card_cvc" type="password" maxlength="4" class="input-field" placeholder="000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">í• ë¶€</label>
                            <select name="installment" class="input-field">
                                <option value="0">ì¼ì‹œë¶ˆ</option>
                                <option value="2">2ê°œì›”</option>
                                <option value="3">3ê°œì›”</option>
                                <option value="6">6ê°œì›”</option>
                                <option value="12">12ê°œì›”</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê²°ì œê¸ˆì•¡*</label><input type="number" name="amount" id="bro-pay-amount" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- ì‘ì—… ì„ íƒ (ì„ íƒì‚¬í•­) -->
                <div>
                    <label class="block text-xs text-lime-400 mb-1">ì—°ê²° ì‘ì—… (ì„ íƒ)</label>
                    <select name="work_id" id="bro-pay-work" class="input-field">
                        <option value="">ì‘ì—… ì„ íƒ ì•ˆí•¨</option>
                    </select>
                </div>
                
                <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œ ë©”ëª¨</label><input name="memo" class="input-field" placeholder="ê²°ì œ ë‚´ìš© ë©”ëª¨"></div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('broCardPayModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ğŸ’³ ê²°ì œ ì‹¤í–‰</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ë¸Œë¡œëª¨í„°ìŠ¤ ëª¨ë‹¬: ê²°ì œ ì™„ë£Œ ======================= -->
    <div id="broPayCompleteModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:450px">
            <div class="text-center py-6">
                <div class="text-6xl mb-4">âœ…</div>
                <h2 class="text-2xl font-black text-emerald-400 mb-2">ê²°ì œ ì™„ë£Œ</h2>
                <div id="bro-pay-complete-info" class="text-gray-400"></div>
            </div>
            <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4" id="bro-pay-receipt"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('broPayCompleteModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
                <button onclick="printBroReceipt()" class="btn-primary flex-1">ğŸ–¨ï¸ ì˜ìˆ˜ì¦ ì¶œë ¥</button>
            </div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¯¸ë‚© ê³ ê° ëª©ë¡ ======================= -->
    <div id="arrearsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">âš ï¸ ë¯¸ë‚© ê³ ê° ëª©ë¡</h2><button onclick="closeModal('arrearsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div class="mb-4 p-4 rounded-xl bg-orange-400/10 border border-orange-400/30">
                <div class="flex justify-between items-center">
                    <span class="text-orange-400 font-bold">ì´ ë¯¸ë‚© ê¸ˆì•¡</span>
                    <span class="text-2xl font-black text-orange-400" id="arrears-total-amount">â‚©0</span>
                </div>
            </div>
            <div class="glass-card rounded-xl overflow-hidden">
                <table class="data-table">
                    <thead><tr><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ì°¨ëŸ‰</th><th>ë¯¸ë‚©ê¸ˆì•¡</th><th>ì—°ì²´ì¼</th><th>ìƒì„¸</th></tr></thead>
                    <tbody id="arrears-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¯¸ìˆ˜ê¸ˆ ìƒì„¸ ======================= -->
    <div id="arrearsDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">ğŸ“‹ ë¯¸ìˆ˜ê¸ˆ ìƒì„¸</h2><button onclick="closeModal('arrearsDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="arrears-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìˆ˜ë‚© ì²˜ë¦¬ ======================= -->
    <div id="paymentProcessModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ğŸ’° ìˆ˜ë‚© ì²˜ë¦¬</h2><button onclick="closeModal('paymentProcessModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="payment-info" class="mb-4"></div>
            <form onsubmit="processPayment(event)" class="space-y-4">
                <input type="hidden" id="payment-contract-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ìˆ˜ë‚©ì¼*</label><input type="date" name="pay_date" id="payment-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìˆ˜ë‚©ê¸ˆì•¡*</label><input type="number" name="pay_amount" id="payment-amount" class="input-field" required></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ìˆ˜ë‚©ë°©ë²•*</label>
                    <select name="pay_method" class="input-field" required>
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                    </select>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><input type="text" name="pay_memo" class="input-field" placeholder="ë©”ëª¨ ì…ë ¥..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('paymentProcessModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ìˆ˜ë‚© ì²˜ë¦¬</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìµœê·¼ ê²°ì œ ë‚´ì—­ ======================= -->
    <div id="recentPaymentsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ğŸ’³ ìµœê·¼ ê²°ì œ ë‚´ì—­</h2><button onclick="closeModal('recentPaymentsModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="recent-payments-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ê³„ì•½ ë“±ë¡ ======================= -->
    <div id="contractModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px; max-height:90vh; overflow-y:auto;">
            <div class="flex justify-between mb-4"><h2 id="contractModalTitle" class="text-xl font-bold text-lime-400">ğŸ“‹ ê³„ì•½ ë“±ë¡</h2><button onclick="closeModal('contractModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitContract(event)" id="contractForm" class="space-y-4">
                <input type="hidden" id="contract-edit-id">
                
                <!-- ê³„ì•½ ìœ í˜• -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <label class="block text-xs text-lime-400 mb-2">ê³„ì•½ ìœ í˜•*</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="contract_type" value="rent" checked class="accent-purple-500">
                            <span class="text-purple-400 font-bold">ğŸï¸ ë ŒíŠ¸</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="contract_type" value="lease" class="accent-pink-500">
                            <span class="text-pink-400 font-bold">ğŸ“„ ë¦¬ìŠ¤</span>
                        </label>
                    </div>
                </div>
                
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-blue-400 mb-3">ğŸ‘¤ ê³„ì•½ì ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ê³ ê°ëª…*</label><input name="customer_name" id="con-customer" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë½ì²˜*</label><input name="phone" id="con-phone" class="input-field" required></div>
                    </div>
                </div>
                
                <!-- ì°¨ëŸ‰ ì •ë³´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-emerald-400 mb-3">ğŸš— ì°¨ëŸ‰ ì •ë³´</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰*</label><input name="vehicle" id="con-vehicle" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ë²ˆí˜¸íŒ*</label><input name="plate" id="con-plate" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë£Œ*</label>
                            <select name="fuel_type" id="con-fuel" class="input-field" required>
                                <option value="íœ˜ë°œìœ ">íœ˜ë°œìœ </option>
                                <option value="ê²½ìœ ">ê²½ìœ </option>
                                <option value="LPG">LPG</option>
                                <option value="ì „ê¸°">ì „ê¸°</option>
                                <option value="í•˜ì´ë¸Œë¦¬ë“œ">í•˜ì´ë¸Œë¦¬ë“œ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ê³„ì•½ ì¡°ê±´ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-orange-400 mb-3">ğŸ“… ê³„ì•½ ì¡°ê±´</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì›” ë‚©ì…ê¸ˆ*</label><input type="number" name="monthly" id="con-monthly" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³„ì•½ ì‹œì‘ì¼*</label><input type="date" name="start_date" id="con-start" class="input-field" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ê³„ì•½ ì¢…ë£Œì¼*</label><input type="date" name="end_date" id="con-end" class="input-field" required></div>
                    </div>
                    <div class="mt-3"><label class="block text-xs text-gray-400 mb-1">ë©”ëª¨</label><textarea name="memo" id="con-memo" class="input-field" rows="2" placeholder="ê³„ì•½ ê´€ë ¨ ë©”ëª¨..."></textarea></div>
                </div>
                
                <!-- ê³„ì•½ì ì„œë¥˜ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-cyan-400 mb-3">ğŸ“ ê³„ì•½ì ì„œë¥˜</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ì‹ ë¶„ì¦</label>
                            <input type="file" name="contractor_id" id="con-contractor-id" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            <div id="con-contractor-id-preview" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ê¸°íƒ€ì„œë¥˜</label>
                            <input type="file" name="contractor_doc" id="con-contractor-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            <div id="con-contractor-doc-preview" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ì—°ëŒ€ë³´ì¦ì¸ (ì„ íƒ) -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="con-has-guarantor" onchange="toggleGuarantor()" class="accent-lime-500">
                        <label class="text-xs text-yellow-400 cursor-pointer" for="con-has-guarantor">ğŸ‘¥ ì—°ëŒ€ë³´ì¦ì¸ ì¶”ê°€</label>
                    </div>
                    <div id="guarantor-section" class="hidden space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ì´ë¦„</label><input name="guarantor_name" id="con-guarantor-name" class="input-field"></div>
                            <div><label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ì—°ë½ì²˜</label><input name="guarantor_phone" id="con-guarantor-phone" class="input-field"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ì‹ ë¶„ì¦</label>
                                <input type="file" name="guarantor_id" id="con-guarantor-id" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">ë³´ì¦ì¸ ê¸°íƒ€ì„œë¥˜</label>
                                <input type="file" name="guarantor_doc" id="con-guarantor-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì°¨ëŸ‰ ì„œë¥˜ -->
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-purple-400 mb-3">ğŸš— ì°¨ëŸ‰ ì„œë¥˜</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ì°¨ëŸ‰ë“±ë¡ì¦</label>
                            <input type="file" name="vehicle_reg" id="con-vehicle-reg" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">íì§€ì„œë¥˜</label>
                            <input type="file" name="vehicle_disposal" id="con-vehicle-disposal" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">ê¸°íƒ€ì„œë¥˜</label>
                            <input type="file" name="vehicle_doc" id="con-vehicle-doc" class="input-field text-xs" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('contractModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="contractSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ê³„ì•½ ìƒì„¸ ======================= -->
    <div id="contractDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ“‹ ê³„ì•½ ìƒì„¸</h2><button onclick="closeModal('contractDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="contract-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì°¨ëŸ‰ ë“±ë¡ ======================= -->
    <div id="vehicleModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 id="vehicleModalTitle" class="text-xl font-bold text-lime-400">ğŸš— ì°¨ëŸ‰ ë“±ë¡</h2><button onclick="closeModal('vehicleModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitVehicle(event)" id="vehicleForm" class="space-y-4">
                <input type="hidden" id="vehicle-edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ë²ˆí˜¸íŒ*</label><input name="plate" id="veh-plate" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ëª¨ë¸*</label><input name="model" id="veh-model" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì—°ì‹</label><input type="number" name="year" id="veh-year" class="input-field" value="2024"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ìƒ‰ìƒ</label><input name="color" id="veh-color" class="input-field"></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì£¼í–‰ê±°ë¦¬</label><input type="number" name="mileage" id="veh-mileage" class="input-field" value="0"></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><input name="memo" id="veh-memo" class="input-field"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('vehicleModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="vehicleSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì°¨ëŸ‰ ìƒì„¸ ======================= -->
    <div id="vehicleDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸš— ì°¨ëŸ‰ ìƒì„¸</h2><button onclick="closeModal('vehicleDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="vehicle-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: PG ì¹´ë“œ ë“±ë¡ ======================= -->
    <div id="pgModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 id="pgModalTitle" class="text-xl font-bold text-lime-400">ğŸ’³ ìë™ê²°ì œ ì¹´ë“œ ë“±ë¡</h2><button onclick="closeModal('pgModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitPgCard(event)" id="pgForm" class="space-y-4">
                <input type="hidden" id="pg-edit-id">
                <div><label class="block text-xs text-lime-400 mb-1">ê³„ì•½ ì„ íƒ*</label>
                    <select name="contract_id" id="pg-contract" class="input-field" required onchange="onPgContractChange(this)">
                        <option value="">ê³„ì•½ ì„ íƒ</option>
                    </select>
                </div>
                
                <!-- ì¹´ë“œ ì†Œìœ ì ì •ë³´ -->
                <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-xs text-lime-400 font-bold mb-3">ğŸ‘¤ ì¹´ë“œ ì†Œìœ ì ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œ ì†Œìœ ìëª…*</label><input name="card_holder" id="pg-card-holder" class="input-field" placeholder="í™ê¸¸ë™" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìƒë…„ì›”ì¼ (6ìë¦¬)*</label><input name="birth_date" id="pg-birth-date" class="input-field" placeholder="990101" maxlength="6" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì—°ë½ì²˜*</label><input name="card_phone" id="pg-card-phone" class="input-field" placeholder="010-1234-5678" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì´ë©”ì¼</label><input type="email" name="card_email" id="pg-card-email" class="input-field" placeholder="email@example.com"></div>
                    </div>
                </div>
                
                <!-- ì¹´ë“œ ì •ë³´ -->
                <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20">
                    <div class="text-xs text-blue-400 font-bold mb-3">ğŸ’³ ì¹´ë“œ ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œë²ˆí˜¸*</label><input name="card_no" id="pg-card-no" class="input-field" placeholder="0000-0000-0000-0000" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ìœ íš¨ê¸°ê°„*</label><input name="expiry" id="pg-expiry" class="input-field" placeholder="MM/YY" required></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div><label class="block text-xs text-gray-400 mb-1">CVC*</label><input name="cvc" id="pg-cvc" type="password" class="input-field" placeholder="000" maxlength="4" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œ ë¹„ë°€ë²ˆí˜¸ ì•2ìë¦¬*</label><input name="card_pw" id="pg-card-pw" type="password" class="input-field" placeholder="**" maxlength="2" required></div>
                        <div><label class="block text-xs text-gray-400 mb-1">ì¹´ë“œì‚¬</label>
                            <select name="card_company" id="pg-card-company" class="input-field">
                                <option value="">ì„ íƒ</option>
                                <option value="ì‚¼ì„±">ì‚¼ì„±ì¹´ë“œ</option>
                                <option value="í˜„ëŒ€">í˜„ëŒ€ì¹´ë“œ</option>
                                <option value="KB">KBêµ­ë¯¼ì¹´ë“œ</option>
                                <option value="ì‹ í•œ">ì‹ í•œì¹´ë“œ</option>
                                <option value="ë¡¯ë°">ë¡¯ë°ì¹´ë“œ</option>
                                <option value="í•˜ë‚˜">í•˜ë‚˜ì¹´ë“œ</option>
                                <option value="ìš°ë¦¬">ìš°ë¦¬ì¹´ë“œ</option>
                                <option value="NH">NHë†í˜‘ì¹´ë“œ</option>
                                <option value="BC">BCì¹´ë“œ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ê²°ì œ ì„¤ì • -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œê¸ˆì•¡*</label><input type="number" name="amount" id="pg-amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ì¹´ë“œìƒíƒœ</label>
                        <select name="card_status" id="pg-card-status" class="input-field">
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œ íƒ€ì…*</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="daily" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">ì¼ì¼ê²°ì œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="weekly" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">ì£¼ì¼ê²°ì œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="monthly" onchange="togglePayOption(this.value)" class="accent-lime-400" checked>
                            <span class="text-sm">ì›”ê²°ì œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="pay_type" value="custom" onchange="togglePayOption(this.value)" class="accent-lime-400">
                            <span class="text-sm">ë‚ ì§œì§€ì •</span>
                        </label>
                    </div>
                </div>
                <div id="pg-option-daily" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">ë§¤ì¼ ê²°ì œ ì‹œê°„</label>
                    <select name="pay_hour" id="pg-pay-hour" class="input-field">
                        <option value="9">ì˜¤ì „ 9ì‹œ</option>
                        <option value="12">ì˜¤í›„ 12ì‹œ</option>
                        <option value="18">ì˜¤í›„ 6ì‹œ</option>
                    </select>
                </div>
                <div id="pg-option-weekly" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">ë§¤ì£¼ ê²°ì œ ìš”ì¼</label>
                    <select name="pay_weekday" id="pg-pay-weekday" class="input-field">
                        <option value="1">ì›”ìš”ì¼</option>
                        <option value="2">í™”ìš”ì¼</option>
                        <option value="3">ìˆ˜ìš”ì¼</option>
                        <option value="4">ëª©ìš”ì¼</option>
                        <option value="5">ê¸ˆìš”ì¼</option>
                    </select>
                </div>
                <div id="pg-option-monthly">
                    <label class="block text-xs text-lime-400 mb-1">ë§¤ì›” ê²°ì œì¼</label>
                    <select name="pay_day" id="pg-pay-day" class="input-field">
                        <option value="1">ë§¤ì›” 1ì¼</option>
                        <option value="5">ë§¤ì›” 5ì¼</option>
                        <option value="10">ë§¤ì›” 10ì¼</option>
                        <option value="15">ë§¤ì›” 15ì¼</option>
                        <option value="20">ë§¤ì›” 20ì¼</option>
                        <option value="25">ë§¤ì›” 25ì¼</option>
                    </select>
                </div>
                <div id="pg-option-custom" class="hidden">
                    <label class="block text-xs text-lime-400 mb-1">ê²°ì œ ì‹œì‘ì¼</label>
                    <input type="date" name="pay_date" id="pg-pay-date" class="input-field">
                </div>
                
                <div class="p-3 rounded-lg bg-yellow-400/10 border border-yellow-400/30 text-xs text-yellow-400">
                    âš ï¸ ì¹´ë“œ ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤. ë“±ë¡ í›„ ìë™ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('pgModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1" id="pgSubmitBtn">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: PG ì¹´ë“œ ìƒì„¸ ======================= -->
    <div id="pgDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ’³ ì¹´ë“œ ìƒì„¸ ì •ë³´</h2><button onclick="closeModal('pgDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="pg-detail-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìˆ˜ë™ ê²°ì œ ======================= -->
    <div id="manualPayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ğŸ’° ìˆ˜ë™ ê²°ì œ ì‹¤í–‰</h2><button onclick="closeModal('manualPayModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="manual-pay-info" class="mb-4"></div>
            <form onsubmit="executeManualPayment(event)" class="space-y-4">
                <input type="hidden" id="manual-pay-pg-id">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œê¸ˆì•¡*</label><input type="number" name="amount" id="manual-pay-amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œì¼*</label><input type="date" name="pay_date" id="manual-pay-date" class="input-field" required></div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë©”ëª¨</label><input type="text" name="memo" class="input-field" placeholder="ê²°ì œ ë©”ëª¨..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('manualPayModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ğŸ’³ ê²°ì œ ì‹¤í–‰</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì›ì¥ ë‚´ì—­ ë“±ë¡ ======================= -->
    <div id="ledgerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:550px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-lime-400">ğŸ“ ì›ì¥ ë‚´ì—­ ë“±ë¡</h2><button onclick="closeModal('ledgerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form onsubmit="submitLedgerEntry(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ì¼ì*</label><input type="date" name="date" id="ledger-date" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ê³„ì•½ ì„ íƒ*</label>
                        <select name="contract_id" id="ledger-contract-select" class="input-field" required>
                            <option value="">ê³„ì•½ ì„ íƒ</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">êµ¬ë¶„*</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="accrual" class="accent-lime-400" checked>
                            <span class="text-sm">ë°œìƒ(ì²­êµ¬)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="receipt" class="accent-lime-400">
                            <span class="text-sm">ìˆ˜ë‚©(ì…ê¸ˆ)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:border-lime-400/50">
                            <input type="radio" name="entry_type" value="adjust" class="accent-lime-400">
                            <span class="text-sm">ì¡°ì •</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs text-lime-400 mb-1">ê¸ˆì•¡*</label><input type="number" name="amount" class="input-field" required></div>
                    <div><label class="block text-xs text-lime-400 mb-1">ê²°ì œë°©ë²•</label>
                        <select name="method" class="input-field">
                            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                            <option value="ì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="PG">PG(ìë™ê²°ì œ)</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-xs text-lime-400 mb-1">ë‚´ìš©</label><input type="text" name="desc" class="input-field" placeholder="ë‚´ìš© ì…ë ¥..."></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('ledgerModal')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary flex-1">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì´ë²ˆë‹¬ ìˆ˜ë‚© ìƒì„¸ ======================= -->
    <div id="monthlyReceiptModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">âœ… ì´ë²ˆë‹¬ ìˆ˜ë‚© í˜„í™©</h2><button onclick="closeModal('monthlyReceiptModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="monthly-receipt-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì›” ì •ì‚°ê¸ˆì•¡ ìƒì„¸ ======================= -->
    <div id="monthlyRevenueModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-emerald-400">ğŸ’° ì›” ì •ì‚°ê¸ˆì•¡ í˜„í™©</h2><button onclick="closeModal('monthlyRevenueModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="monthly-revenue-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ë¯¸ìˆ˜ê¸ˆ ëª©ë¡ ======================= -->
    <div id="unpaidListModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">âš ï¸ ë¯¸ìˆ˜ê¸ˆ í˜„í™©</h2><button onclick="closeModal('unpaidListModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="unpaid-list-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ìˆ˜ë‚©ë¥  ìƒì„¸ ======================= -->
    <div id="collectionRateModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-purple-400">ğŸ“Š ìˆ˜ë‚©ë¥  ìƒì„¸ ë¶„ì„</h2><button onclick="closeModal('collectionRateModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="collection-rate-content"></div>
        </div>
    </div>

    <!-- ======================= ì •ì‚°ê´€ë¦¬ ëª¨ë‹¬: ì—°ì²´ ê´€ë¦¬ ======================= -->
    <div id="delActionModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-orange-400">ğŸ“ ì—°ì²´ ê´€ë¦¬</h2><button onclick="closeModal('delActionModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <div id="del-action-content"></div>
        </div>
    </div>

<script>
// ======================= Supabase ì„¤ì • =======================
const SUPABASE_URL = 'https://jizaefuhiikpkcxolibc.supabase.co';
const SUPABASE_KEY = 'sb_publishable_GmXxpaZB2wffSDKJn5P1kg_22B7VGpD';

// Supabase API í˜¸ì¶œ í•¨ìˆ˜
async function supabaseCall(table, method = 'GET', data = null, query = '') {
    const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
    const options = {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'
        }
    };
    if (data && (method === 'POST' || method === 'PATCH')) {
        options.body = JSON.stringify(data);
    }
    try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        if (method === 'DELETE') return true;
        const text = await res.text();
        return text ? JSON.parse(text) : [];
    } catch (e) {
        console.error('Supabase error:', e);
        return null;
    }
}

// ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤
async function loadFromDB(table) {
    return await supabaseCall(table, 'GET', null, '?order=id.desc');
}

async function insertToDB(table, data) {
    return await supabaseCall(table, 'POST', data);
}

async function updateInDB(table, id, data) {
    return await supabaseCall(table, 'PATCH', data, `?id=eq.${id}`);
}

async function deleteFromDB(table, id) {
    return await supabaseCall(table, 'DELETE', null, `?id=eq.${id}`);
}

// ======================= ì „ì—­ ë³€ìˆ˜ =======================
let currentSystem = 'settlement'; // 'settlement' or 'bromotors'
let currentUser = null;

// ë°ì´í„° ë°°ì—´ (DBì—ì„œ ë¡œë“œ)
let staffList = [];
let customerList = [];
let contractList = [];
let arrearsDetailList = [];
let recentPayments = [];
let pgPaymentsList = [];
let paymentHistory = [];
let ledgerList = [];
let vehicleList = [];
let broWorkList = [];
let broCashbookList = [];
let broPartsList = [];
let broCustList = [];

// ======================= ìœ í‹¸ë¦¬í‹° =======================
const fmt = n => 'â‚©' + (n||0).toLocaleString();
const roleBadge = r => ({admin:['badge-admin','ê´€ë¦¬ì'],manager:['badge-manager','ë§¤ë‹ˆì €'],staff:['badge-staff','ì¼ë°˜']}[r]||['','']);
const statusBadge = s => s==='active'?['badge-active','í™œì„±']:['badge-failed','ë¹„í™œì„±'];
const gradeBadge = g => ({ 'ìƒ': ['badge-active', 'ìƒ'], 'ì¤‘': ['badge-completed', 'ì¤‘'], 'í•˜': ['badge-failed', 'í•˜'] }[g] || ['badge-staff', '-']);

function showToast(msg, type = 'success') {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast toast-${type}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ======================= ë¡œê·¸ì¸ =======================
function selectSystem(system) {
    document.querySelectorAll('.system-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    currentSystem = system;
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    // DBì—ì„œ ì§ì› ì •ë³´ í™•ì¸
    const users = await supabaseCall('staff', 'GET', null, `?username=eq.${username}&password=eq.${password}`);
    
    if (users && users.length > 0) {
        const user = users[0];
        currentUser = user;
        
        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        await loadAllData();
        
        document.getElementById('loginPage').classList.add('hidden');
        
        // ì„ íƒí•œ ì‹œìŠ¤í…œìœ¼ë¡œ ì´ë™
        if (currentSystem === 'settlement') {
            document.getElementById('settlementSystem').classList.remove('hidden');
            document.getElementById('s-userName').textContent = user.name;
            document.getElementById('s-userRole').textContent = roleBadge(user.role)[1];
            renderStaffList();
            loadOverview();
            initDates();
        } else {
            document.getElementById('bromotorsSystem').classList.remove('hidden');
            document.getElementById('b-userName').textContent = user.name;
            document.getElementById('b-userRole').textContent = roleBadge(user.role)[1];
            initDates();
        }
        
        showToast(`${user.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
    } else {
        document.getElementById('loginError').textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        document.getElementById('loginError').classList.remove('hidden');
    }
}

// ëª¨ë“  ë°ì´í„° ë¡œë“œ
async function loadAllData() {
    showToast('ë°ì´í„° ë¡œë”© ì¤‘...', 'info');
    
    const [staff, customers, contracts, vehicles, ledger, pgPayments, works, cashbook, parts, broCustomers] = await Promise.all([
        loadFromDB('staff'),
        loadFromDB('customers'),
        loadFromDB('contracts'),
        loadFromDB('vehicles'),
        loadFromDB('ledger'),
        loadFromDB('pg_payments'),
        loadFromDB('bro_works'),
        loadFromDB('bro_cashbook'),
        loadFromDB('bro_parts'),
        loadFromDB('bro_customers')
    ]);
    
    staffList = staff || [];
    customerList = customers || [];
    contractList = contracts || [];
    vehicleList = vehicles || [];
    ledgerList = (ledger || []).map(l => ({...l, desc: l.description}));
    pgPaymentsList = pgPayments || [];
    broWorkList = works || [];
    broCashbookList = cashbook || [];
    broPartsList = parts || [];
    broCustList = broCustomers || [];
    
    // recentPaymentsëŠ” ledgerì—ì„œ ì¶”ì¶œ
    recentPayments = ledgerList.filter(l => l.type === 'receipt').slice(0, 5).map((l, i) => ({
        id: i + 1,
        customer_name: l.customer_name,
        amount: l.receipt,
        date: l.date,
        time: '09:00'
    }));
}

// ë‚ ì§œ ì´ˆê¸°í™” í•¨ìˆ˜
function initDates() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const today = `${year}-${month}-${day}`;
    const todayKor = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // í—¤ë” ë‚ ì§œ í‘œì‹œ
    if (document.getElementById('s-today-date')) document.getElementById('s-today-date').textContent = todayKor;
    if (document.getElementById('b-today-date')) document.getElementById('b-today-date').textContent = todayKor;
    
    // ëª¨ë“  date input ê¸°ë³¸ê°’ ì„¤ì •
    document.querySelectorAll('input[type="date"]').forEach(el => {
        if (!el.value) el.value = today;
    });
    
    // month input ê¸°ë³¸ê°’ ì„¤ì •
    document.querySelectorAll('input[type="month"]').forEach(el => {
        if (!el.value) el.value = `${year}-${month}`;
    });
}

function handleLogout() {
    currentUser = null;
    location.reload();
}

// ======================= ì‹œìŠ¤í…œ ì „í™˜ =======================
function switchSystem() {
    if (currentSystem === 'settlement') {
        document.getElementById('settlementSystem').classList.add('hidden');
        document.getElementById('bromotorsSystem').classList.remove('hidden');
        document.getElementById('b-userName').textContent = currentUser.name;
        document.getElementById('b-userRole').textContent = roleBadge(currentUser.role)[1];
        currentSystem = 'bromotors';
        showBromotorsTab('overview');
    } else {
        document.getElementById('bromotorsSystem').classList.add('hidden');
        document.getElementById('settlementSystem').classList.remove('hidden');
        document.getElementById('s-userName').textContent = currentUser.name;
        document.getElementById('s-userRole').textContent = roleBadge(currentUser.role)[1];
        currentSystem = 'settlement';
        showSettlementTab('overview');
    }
}

function goToSettlementSettings() {
    document.getElementById('bromotorsSystem').classList.add('hidden');
    document.getElementById('settlementSystem').classList.remove('hidden');
    currentSystem = 'settlement';
    showSettlementTab('settings');
}

// ======================= ì •ì‚°ê´€ë¦¬ íƒ­ =======================
function showSettlementTab(name) {
    document.querySelectorAll('[id^="s-tab-"]').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
    document.getElementById('s-tab-' + name).classList.add('tab-active');
    document.getElementById('s-tab-' + name).classList.remove('text-gray-500');
    document.querySelectorAll('.s-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('s-content-' + name).classList.remove('hidden');
    
    if (name === 'overview') loadOverview();
    if (name === 'contracts') loadContracts();
    if (name === 'vehicles') loadVehicles();
    if (name === 'customers') loadCustomers();
    if (name === 'charges') loadPgPayments();
    if (name === 'ledger') loadLedger();
    if (name === 'delinquent') loadDelinquent();
    if (name === 'settings') renderStaffList();
}

function showSettingTab(name, el) {
    document.querySelectorAll('.setting-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.setting-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('setting-' + name).classList.remove('hidden');
    
    if (name === 'pg') loadPgSettings();
}

// ======================= PG ì„¤ì • =======================
let pgSettings = {
    provider: 'nicepay',
    mid: '',
    merchantKey: '',
    secretKey: '',
    apiUrl: 'https://api.nicepay.co.kr/v1/payments',
    cancelUrl: 'https://api.nicepay.co.kr/v1/payments/cancel',
    billingUrl: 'https://api.nicepay.co.kr/v1/subscribe/regist',
    mode: 'test',
    timeout: 30,
    billingEnabled: true,
    defaultPayDay: 10,
    payTime: '09',
    retryCount: 3,
    retryInterval: 2,
    webhookUrl: '',
    webhookSuccess: true,
    webhookFail: true
};

const pgProviderInfo = {
    nicepay: {
        name: 'ë‚˜ì´ìŠ¤í˜ì´',
        apiUrl: 'https://api.nicepay.co.kr/v1/payments',
        cancelUrl: 'https://api.nicepay.co.kr/v1/payments/cancel',
        billingUrl: 'https://api.nicepay.co.kr/v1/subscribe/regist',
        docsUrl: 'https://developers.nicepay.co.kr'
    },
    inicis: {
        name: 'KGì´ë‹ˆì‹œìŠ¤',
        apiUrl: 'https://iniapi.inicis.com/api/v1/pay',
        cancelUrl: 'https://iniapi.inicis.com/api/v1/cancel',
        billingUrl: 'https://iniapi.inicis.com/api/v1/billing',
        docsUrl: 'https://manual.inicis.com'
    },
    toss: {
        name: 'í† ìŠ¤í˜ì´ë¨¼ì¸ ',
        apiUrl: 'https://api.tosspayments.com/v1/payments',
        cancelUrl: 'https://api.tosspayments.com/v1/payments/cancel',
        billingUrl: 'https://api.tosspayments.com/v1/billing/authorizations',
        docsUrl: 'https://docs.tosspayments.com'
    },
    kakao: {
        name: 'ì¹´ì¹´ì˜¤í˜ì´',
        apiUrl: 'https://kapi.kakao.com/v1/payment/ready',
        cancelUrl: 'https://kapi.kakao.com/v1/payment/cancel',
        billingUrl: 'https://kapi.kakao.com/v1/payment/subscription',
        docsUrl: 'https://developers.kakao.com/docs/latest/ko/kakaopay'
    },
    danal: {
        name: 'ë‹¤ë‚ ',
        apiUrl: 'https://api.danal.co.kr/payment',
        cancelUrl: 'https://api.danal.co.kr/payment/cancel',
        billingUrl: 'https://api.danal.co.kr/billing',
        docsUrl: 'https://developers.danal.co.kr'
    },
    settle: {
        name: 'ì„¸í‹€ë±…í¬',
        apiUrl: 'https://api.settlebank.co.kr/v1/payment',
        cancelUrl: 'https://api.settlebank.co.kr/v1/cancel',
        billingUrl: 'https://api.settlebank.co.kr/v1/billing',
        docsUrl: 'https://developers.settlebank.co.kr'
    },
    kcp: {
        name: 'NHN KCP',
        apiUrl: 'https://api.kcp.co.kr/v1/payment',
        cancelUrl: 'https://api.kcp.co.kr/v1/cancel',
        billingUrl: 'https://api.kcp.co.kr/v1/batch',
        docsUrl: 'https://developer.kcp.co.kr'
    }
};

function loadPgSettings() {
    document.getElementById('pg-provider').value = pgSettings.provider;
    document.getElementById('pg-mid').value = pgSettings.mid;
    document.getElementById('pg-merchant-key').value = pgSettings.merchantKey;
    document.getElementById('pg-secret-key').value = pgSettings.secretKey;
    document.getElementById('pg-api-url').value = pgSettings.apiUrl;
    document.getElementById('pg-cancel-url').value = pgSettings.cancelUrl;
    document.getElementById('pg-billing-url').value = pgSettings.billingUrl;
    document.getElementById('pg-mode').value = pgSettings.mode;
    document.getElementById('pg-timeout').value = pgSettings.timeout;
    document.getElementById('pg-billing-enabled').checked = pgSettings.billingEnabled;
    document.getElementById('pg-default-pay-day').value = pgSettings.defaultPayDay;
    document.getElementById('pg-pay-time').value = pgSettings.payTime;
    document.getElementById('pg-retry-count').value = pgSettings.retryCount;
    document.getElementById('pg-retry-interval').value = pgSettings.retryInterval;
    document.getElementById('pg-webhook-url').value = pgSettings.webhookUrl;
    document.getElementById('pg-webhook-success').checked = pgSettings.webhookSuccess;
    document.getElementById('pg-webhook-fail').checked = pgSettings.webhookFail;
    
    updatePgStatusBadge();
}

function onPgProviderChange(provider) {
    const info = pgProviderInfo[provider];
    if (info) {
        document.getElementById('pg-api-url').value = info.apiUrl;
        document.getElementById('pg-cancel-url').value = info.cancelUrl;
        document.getElementById('pg-billing-url').value = info.billingUrl;
    }
}

function toggleKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

function savePgSettings() {
    pgSettings = {
        provider: document.getElementById('pg-provider').value,
        mid: document.getElementById('pg-mid').value,
        merchantKey: document.getElementById('pg-merchant-key').value,
        secretKey: document.getElementById('pg-secret-key').value,
        apiUrl: document.getElementById('pg-api-url').value,
        cancelUrl: document.getElementById('pg-cancel-url').value,
        billingUrl: document.getElementById('pg-billing-url').value,
        mode: document.getElementById('pg-mode').value,
        timeout: parseInt(document.getElementById('pg-timeout').value) || 30,
        billingEnabled: document.getElementById('pg-billing-enabled').checked,
        defaultPayDay: parseInt(document.getElementById('pg-default-pay-day').value) || 10,
        payTime: document.getElementById('pg-pay-time').value,
        retryCount: parseInt(document.getElementById('pg-retry-count').value) || 3,
        retryInterval: parseInt(document.getElementById('pg-retry-interval').value) || 2,
        webhookUrl: document.getElementById('pg-webhook-url').value,
        webhookSuccess: document.getElementById('pg-webhook-success').checked,
        webhookFail: document.getElementById('pg-webhook-fail').checked
    };
    
    updatePgStatusBadge();
    showToast('âœ… PG ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updatePgStatusBadge() {
    const badge = document.getElementById('pg-status-badge');
    if (pgSettings.mid && pgSettings.merchantKey) {
        if (pgSettings.mode === 'production') {
            badge.className = 'badge badge-active';
            badge.textContent = 'ğŸŸ¢ ìš´ì˜ì¤‘';
        } else {
            badge.className = 'badge badge-pending';
            badge.textContent = 'ğŸŸ¡ í…ŒìŠ¤íŠ¸';
        }
    } else {
        badge.className = 'badge badge-failed';
        badge.textContent = 'âšª ë¯¸ì„¤ì •';
    }
}

function testPgConnection() {
    const mid = document.getElementById('pg-mid').value;
    const merchantKey = document.getElementById('pg-merchant-key').value;
    
    if (!mid || !merchantKey) {
        showToast('âŒ ê°€ë§¹ì  IDì™€ ìƒì  í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    // í…ŒìŠ¤íŠ¸ ì—°ê²° ì‹œë®¬ë ˆì´ì…˜
    showToast('ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
    setTimeout(() => {
        // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œí•˜ì—¬ í™•ì¸
        showToast('âœ… PG ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
    }, 1500);
}

function openPgDocs(provider) {
    const info = pgProviderInfo[provider];
    if (info && info.docsUrl) {
        window.open(info.docsUrl, '_blank');
    }
}

function copyWebhookUrl() {
    const url = document.getElementById('pg-webhook-url').value;
    if (url) {
        navigator.clipboard.writeText(url);
        showToast('ğŸ“‹ Webhook URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        showToast('âŒ Webhook URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    }
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤ íƒ­ =======================
function showBromotorsTab(name) {
    document.querySelectorAll('[id^="b-tab-"]').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
    document.getElementById('b-tab-' + name).classList.add('tab-active');
    document.getElementById('b-tab-' + name).classList.remove('text-gray-500');
    document.querySelectorAll('.b-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('b-content-' + name).classList.remove('hidden');
    
    if (name === 'overview') loadBroDashboard();
    if (name === 'work') loadBroWork();
    if (name === 'cashbook') loadBroCashbook();
    if (name === 'parts') loadBroParts();
    if (name === 'customers') loadBroCustomers();
}

// ======================= ì§ì› ê´€ë¦¬ =======================
const levelBadge = l => ({ 
    1: ['bg-gray-500/20 text-gray-400', 'ğŸ‘¤ Lv.1 ì‚¬ì›'], 
    2: ['bg-blue-500/20 text-blue-400', 'â­ Lv.2 íŒ€ì›'], 
    3: ['bg-orange-500/20 text-orange-400', 'ğŸ‘‘ Lv.3 ë§¤ë‹ˆì €'], 
    4: ['bg-red-500/20 text-red-400', 'ğŸ”¥ Lv.4 ìµœê³ ê´€ë¦¬ì'] 
}[l] || ['', '']);

function renderStaffList() {
    let h = '';
    staffList.forEach(s => {
        const [lc, ll] = levelBadge(s.level || 1);
        const [stc, stl] = statusBadge(s.status);
        h += `<tr>
            <td class="font-bold">${s.name}</td>
            <td class="text-lime-400">${s.username}</td>
            <td class="text-gray-400">${s.phone}</td>
            <td>${s.department}</td>
            <td><span class="badge ${lc}">${ll}</span></td>
            <td><span class="badge ${stc}">${stl}</span></td>
            <td class="text-gray-400 text-xs">${s.created_at}</td>
            <td>
                <button onclick="editStaff(${s.id})" class="text-lime-400 text-xs hover:underline mr-2">ìˆ˜ì •</button>
                <button onclick="deleteStaff(${s.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
    });
    document.getElementById('staff-tbody').innerHTML = h;
}

function openStaffModal(editId = null) {
    document.getElementById('staffForm').reset();
    document.getElementById('staff-edit-id').value = '';
    document.querySelector('input[name="level"][value="1"]').checked = true;
    document.getElementById('staff-password').required = true;
    document.getElementById('staff-password-confirm').required = true;
    
    if (editId) {
        const s = staffList.find(x => x.id === editId);
        if (s) {
            document.getElementById('staffModalTitle').textContent = 'ğŸ‘¤ ì§ì› ìˆ˜ì •';
            document.getElementById('staffSubmitBtn').textContent = 'ìˆ˜ì •';
            document.getElementById('staff-edit-id').value = s.id;
            document.getElementById('staff-name').value = s.name;
            document.getElementById('staff-username').value = s.username;
            document.getElementById('staff-phone').value = s.phone;
            document.getElementById('staff-email').value = s.email || '';
            document.getElementById('staff-department').value = s.department;
            document.getElementById('staff-status').value = s.status;
            document.querySelector(`input[name="level"][value="${s.level || 1}"]`).checked = true;
            // ìˆ˜ì •ì‹œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì„ íƒì‚¬í•­
            document.getElementById('staff-password').required = false;
            document.getElementById('staff-password-confirm').required = false;
            document.getElementById('staff-password').placeholder = 'ë³€ê²½ì‹œì—ë§Œ ì…ë ¥';
            document.getElementById('staff-password-confirm').placeholder = 'ë³€ê²½ì‹œì—ë§Œ ì…ë ¥';
        }
    } else {
        document.getElementById('staffModalTitle').textContent = 'ğŸ‘¤ ì§ì› ë“±ë¡';
        document.getElementById('staffSubmitBtn').textContent = 'ë“±ë¡';
        document.getElementById('staff-password').placeholder = '';
        document.getElementById('staff-password-confirm').placeholder = '';
    }
    
    openModal('staffModal');
}

async function submitStaff(e) {
    e.preventDefault();
    const editId = document.getElementById('staff-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // ìˆ˜ì • ëª¨ë“œ
        const s = staffList.find(x => x.id === parseInt(editId));
        if (s) {
            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ëŠ” ê²½ìš°ì—ë§Œ ì²´í¬
            if (d.password || d.password_confirm) {
                if (d.password !== d.password_confirm) {
                    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                s.password = d.password;
            }
            
            // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ (ë³¸ì¸ ì œì™¸)
            if (staffList.find(x => x.username === d.username && x.id !== parseInt(editId))) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤', 'error');
                return;
            }
            
            s.name = d.name;
            s.username = d.username;
            s.phone = d.phone;
            s.email = d.email || null;
            s.department = d.department;
            s.level = parseInt(d.level) || 1;
            s.status = d.status;
            
            await updateInDB('staff', editId, {
                name: s.name, username: s.username, password: s.password,
                phone: s.phone, email: s.email, department: s.department,
                level: s.level, status: s.status
            });
        }
        showToast('âœ… ì§ì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ë“±ë¡ ëª¨ë“œ
        if (d.password !== d.password_confirm) {
            showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        // ì¤‘ë³µ ì•„ì´ë”” ì²´í¬
        if (staffList.find(s => s.username === d.username)) {
            showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤', 'error');
            return;
        }
        
        const staffData = {
            name: d.name,
            username: d.username,
            password: d.password,
            phone: d.phone,
            email: d.email || null,
            department: d.department,
            level: parseInt(d.level) || 1,
            role: d.level >= 3 ? 'manager' : 'staff',
            status: d.status || 'active'
        };
        
        const result = await insertToDB('staff', staffData);
        if (result && result[0]) staffList.unshift(result[0]);
        showToast('âœ… ì§ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('staffModal');
    renderStaffList();
}

function editStaff(id) {
    openStaffModal(id);
}

async function deleteStaff(id) {
    const s = staffList.find(x => x.id === id);
    if (!s) return;
    
    if (s.level === 4) {
        showToast('ìµœê³ ê´€ë¦¬ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    if (!confirm(`${s.name} ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    await deleteFromDB('staff', id);
    staffList = staffList.filter(x => x.id !== id);
    showToast('âœ… ì§ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    renderStaffList();
}

// ======================= ì •ì‚°ê´€ë¦¬: ê³„ì•½ê´€ë¦¬ =======================
function filterContracts(status) {
    document.getElementById('contract-status').value = status;
    loadContracts();
}

function loadContracts() {
    const search = document.getElementById('contract-search').value.toLowerCase();
    const status = document.getElementById('contract-status').value;
    
    let list = contractList;
    
    // ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ€ì… í•„í„°
    list = list.filter(c => (c.type || 'rent') === currentContractType);
    
    if (status === 'delinquent') list = list.filter(c => c.arrears > 0);
    else if (status === 'active') list = list.filter(c => c.status === 'active' && c.arrears === 0);
    else if (status) list = list.filter(c => c.status === status);
    if (search) list = list.filter(c => c.customer_name.toLowerCase().includes(search) || c.plate.toLowerCase().includes(search));
    
    // ìš”ì•½ (í˜„ì¬ íƒ€ì… ê¸°ì¤€)
    const typeContracts = contractList.filter(c => (c.type || 'rent') === currentContractType);
    const activeContracts = typeContracts.filter(c => c.status === 'active');
    const delinquentContracts = typeContracts.filter(c => c.arrears > 0);
    const monthlyRevenue = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    document.getElementById('contract-total').textContent = typeContracts.length + 'ê±´';
    document.getElementById('contract-active').textContent = activeContracts.length + 'ê±´';
    document.getElementById('contract-delinquent').textContent = delinquentContracts.length + 'ê±´';
    document.getElementById('contract-revenue').textContent = fmt(monthlyRevenue);
    document.getElementById('contract-revenue-count').textContent = activeContracts.length + 'ê±´ ê³„ì•½';
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(c => {
        const hasArrears = c.arrears > 0;
        const statusBadge = hasArrears ? ['badge-delinquent', 'ì—°ì²´'] : c.status === 'active' ? ['badge-active', 'ì§„í–‰ì¤‘'] : ['badge-pending', 'ëŒ€ê¸°'];
        const period = c.start_date && c.end_date ? `${c.start_date.substring(5)} ~ ${c.end_date.substring(5)}` : c.start_date ? c.start_date.substring(5) + ' ~' : '-';
        const hasDoc = c.contractor_id_url || c.vehicle_reg_url;
        
        h += `<tr onclick="viewContractDetail(${c.id})" class="cursor-pointer hover:bg-white/5">
            <td class="text-lime-400">#${String(c.id).padStart(3,'0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="font-mono">${c.plate}</td>
            <td class="text-xs">${c.fuel_type || '-'}</td>
            <td class="text-xs text-gray-400">${period}</td>
            <td class="font-bold">${fmt(c.monthly)}</td>
            <td class="${hasArrears ? 'text-orange-400 font-bold' : 'text-gray-500'}">${hasArrears ? fmt(c.arrears) : '-'}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td>${hasDoc ? '<span class="text-cyan-400">ğŸ“</span>' : '<span class="text-gray-600">-</span>'}</td>
        </tr>`;
    });
    document.getElementById('contract-tbody').innerHTML = h || '<tr><td colspan="11" class="text-center text-gray-500 py-6">ê³„ì•½ ì—†ìŒ</td></tr>';
}

// ì›” ì •ì‚°ê¸ˆì•¡ ìƒì„¸ ëª¨ë‹¬
function openMonthlyRevenueModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    const monthName = today.substring(0, 7).replace('-', 'ë…„ ') + 'ì›”';
    
    const activeContracts = contractList.filter(c => c.status === 'active');
    const monthlyRevenue = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© ê¸ˆì•¡ (ì›ì¥ ê¸°ì¤€)
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const actualReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    const receiptRate = monthlyRevenue > 0 ? Math.round((actualReceipt / monthlyRevenue) * 100) : 0;
    
    // ê³„ì•½ ìœ í˜•ë³„ ì§‘ê³„
    const leaseContracts = activeContracts.filter(c => c.type === 'lease');
    const rentContracts = activeContracts.filter(c => c.type === 'rent');
    const leaseRevenue = leaseContracts.reduce((s, c) => s + c.monthly, 0);
    const rentRevenue = rentContracts.reduce((s, c) => s + c.monthly, 0);
    
    // ê³„ì•½ë³„ í…Œì´ë¸”
    let tableRows = '';
    activeContracts.sort((a, b) => b.monthly - a.monthly).forEach(c => {
        const typeLabel = c.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸';
        const typeBadge = c.type === 'lease' ? 'badge-progress' : 'badge-pending';
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="closeModal('monthlyRevenueModal'); viewContractDetail(${c.id});">
            <td class="text-lime-400">#${String(c.id).padStart(3, '0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td>${c.vehicle}</td>
            <td><span class="badge ${typeBadge}">${typeLabel}</span></td>
            <td class="text-blue-400 font-bold">${fmt(c.monthly)}</td>
        </tr>`;
    });
    
    document.getElementById('monthly-revenue-content').innerHTML = `
        <div class="text-center text-lg font-bold text-lime-400 mb-4">${monthName}</div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì›” ì˜ˆìƒ ìˆ˜ìµ</div>
                <div class="text-xl font-black text-emerald-400">${fmt(monthlyRevenue)}</div>
                <div class="text-xs text-gray-500">${activeContracts.length}ê±´ ê³„ì•½</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">ì‹¤ì œ ìˆ˜ë‚©</div>
                <div class="text-xl font-black text-blue-400">${fmt(actualReceipt)}</div>
                <div class="text-xs text-gray-500">${thisMonthReceipts.length}ê±´</div>
            </div>
            <div class="p-4 rounded-xl ${receiptRate >= 80 ? 'bg-emerald-400/10 border-emerald-400/30' : 'bg-orange-400/10 border-orange-400/30'} text-center">
                <div class="text-xs ${receiptRate >= 80 ? 'text-emerald-400' : 'text-orange-400'} mb-1">ìˆ˜ë‚©ë¥ </div>
                <div class="text-xl font-black ${receiptRate >= 80 ? 'text-emerald-400' : 'text-orange-400'}">${receiptRate}%</div>
                <div class="text-xs text-gray-500">${receiptRate >= 80 ? 'ì–‘í˜¸' : 'ë¯¸ë‹¬'}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ“Š ê³„ì•½ ìœ í˜•ë³„</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-400 w-12">ë¦¬ìŠ¤</span>
                    <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-400" style="width:${monthlyRevenue > 0 ? Math.round((leaseRevenue / monthlyRevenue) * 100) : 0}%"></div>
                    </div>
                    <span class="text-xs text-blue-400 w-24 text-right">${fmt(leaseRevenue)}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-400 w-12">ë ŒíŠ¸</span>
                    <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-yellow-400" style="width:${monthlyRevenue > 0 ? Math.round((rentRevenue / monthlyRevenue) * 100) : 0}%"></div>
                    </div>
                    <span class="text-xs text-yellow-400 w-24 text-right">${fmt(rentRevenue)}</span>
                </div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:250px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³„ì•½</th><th>ê³ ê°</th><th>ì°¨ëŸ‰</th><th>ìœ í˜•</th><th>ì›”ë‚©ì…</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">ê³„ì•½ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('monthlyRevenueModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('monthlyRevenueModal'); showSettlementTab('ledger');" class="btn-primary flex-1">ì›ì¥ ë³´ê¸°</button>
        </div>
    `;
    
    openModal('monthlyRevenueModal');
}

function viewContractDetail(id) {
    const c = contractList.find(x => x.id === id);
    if (!c) return;
    
    const statusBadge = c.status === 'active' ? ['badge-active', 'ì§„í–‰ì¤‘'] : ['badge-delinquent', 'ì—°ì²´'];
    const typeBadge = (c.type || 'rent') === 'rent' ? ['badge-rent', 'ë ŒíŠ¸'] : ['badge-lease', 'ë¦¬ìŠ¤'];
    
    // ì„œë¥˜ ë§í¬ ìƒì„±
    const docLinks = [];
    if (c.contractor_id_url) docLinks.push(`<a href="${c.contractor_id_url}" target="_blank" class="text-cyan-400 hover:underline text-xs">ğŸ“ ê³„ì•½ì ì‹ ë¶„ì¦</a>`);
    if (c.contractor_doc_url) docLinks.push(`<a href="${c.contractor_doc_url}" target="_blank" class="text-cyan-400 hover:underline text-xs">ğŸ“ ê³„ì•½ì ê¸°íƒ€ì„œë¥˜</a>`);
    if (c.guarantor_id_url) docLinks.push(`<a href="${c.guarantor_id_url}" target="_blank" class="text-yellow-400 hover:underline text-xs">ğŸ“ ë³´ì¦ì¸ ì‹ ë¶„ì¦</a>`);
    if (c.guarantor_doc_url) docLinks.push(`<a href="${c.guarantor_doc_url}" target="_blank" class="text-yellow-400 hover:underline text-xs">ğŸ“ ë³´ì¦ì¸ ê¸°íƒ€ì„œë¥˜</a>`);
    if (c.vehicle_reg_url) docLinks.push(`<a href="${c.vehicle_reg_url}" target="_blank" class="text-purple-400 hover:underline text-xs">ğŸ“ ì°¨ëŸ‰ë“±ë¡ì¦</a>`);
    if (c.vehicle_disposal_url) docLinks.push(`<a href="${c.vehicle_disposal_url}" target="_blank" class="text-purple-400 hover:underline text-xs">ğŸ“ íì§€ì„œë¥˜</a>`);
    if (c.vehicle_doc_url) docLinks.push(`<a href="${c.vehicle_doc_url}" target="_blank" class="text-purple-400 hover:underline text-xs">ğŸ“ ì°¨ëŸ‰ ê¸°íƒ€ì„œë¥˜</a>`);
    
    document.getElementById('contract-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³„ì•½ë²ˆí˜¸</span><span class="text-lime-400 font-bold">#${String(c.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ìœ í˜•</span><span class="badge ${typeBadge[0]}">${typeBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${c.plate}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë£Œ</span><span>${c.fuel_type || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì›” ë‚©ì…ê¸ˆ</span><span class="text-blue-400 font-bold">${fmt(c.monthly)}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ ì‹œì‘ì¼</span><span>${c.start_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ ì¢…ë£Œì¼</span><span>${c.end_date || '-'}</span></div>
            </div>
            ${c.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-sm text-gray-400">ğŸ“ ${c.memo}</div>` : ''}
        </div>
        
        ${c.guarantor_name ? `
        <div class="p-4 rounded-lg bg-yellow-400/10 border border-yellow-400/30 mb-4">
            <div class="text-xs text-yellow-400 mb-2">ğŸ‘¥ ì—°ëŒ€ë³´ì¦ì¸</div>
            <div class="grid grid-cols-2 gap-2">
                <div><span class="text-gray-400 text-xs">ì´ë¦„:</span> <span class="font-bold">${c.guarantor_name}</span></div>
                <div><span class="text-gray-400 text-xs">ì—°ë½ì²˜:</span> <span>${c.guarantor_phone || '-'}</span></div>
            </div>
        </div>` : ''}
        
        ${docLinks.length > 0 ? `
        <div class="p-4 rounded-lg bg-cyan-400/10 border border-cyan-400/30 mb-4">
            <div class="text-xs text-cyan-400 mb-2">ğŸ“ ì²¨ë¶€ ì„œë¥˜</div>
            <div class="flex flex-wrap gap-3">${docLinks.join('')}</div>
        </div>` : ''}
        
        ${c.arrears > 0 ? `
        <div class="p-4 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-orange-400 font-bold">ë¯¸ë‚© ê¸ˆì•¡</span>
                <span class="text-xl font-black text-orange-400">${fmt(c.arrears)}</span>
            </div>
        </div>` : ''}
        <div class="flex gap-3">
            <button onclick="deleteContract(${c.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('contractDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editContract(${c.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('contractDetailModal');
}

function editContract(id) {
    closeModal('contractDetailModal');
    const c = contractList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('contractModalTitle').textContent = 'ğŸ“‹ ê³„ì•½ ìˆ˜ì •';
    document.getElementById('contractSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('contract-edit-id').value = c.id;
    document.getElementById('con-customer').value = c.customer_name;
    document.getElementById('con-phone').value = c.phone;
    document.getElementById('con-vehicle').value = c.vehicle;
    document.getElementById('con-plate').value = c.plate;
    document.getElementById('con-monthly').value = c.monthly;
    document.getElementById('con-start').value = c.start_date;
    document.getElementById('con-end').value = c.end_date || '';
    document.getElementById('con-fuel').value = c.fuel_type || 'íœ˜ë°œìœ ';
    document.getElementById('con-memo').value = c.memo || '';
    
    // ê³„ì•½ ìœ í˜• ì„ íƒ
    const typeRadio = document.querySelector(`input[name="contract_type"][value="${c.type || 'rent'}"]`);
    if (typeRadio) typeRadio.checked = true;
    
    // ì—°ëŒ€ë³´ì¦ì¸
    if (c.guarantor_name) {
        document.getElementById('con-has-guarantor').checked = true;
        toggleGuarantor();
        document.getElementById('con-guarantor-name').value = c.guarantor_name || '';
        document.getElementById('con-guarantor-phone').value = c.guarantor_phone || '';
    }
    
    openModal('contractModal');
}

// ì—°ëŒ€ë³´ì¦ì¸ í† ê¸€
function toggleGuarantor() {
    const checked = document.getElementById('con-has-guarantor').checked;
    document.getElementById('guarantor-section').classList.toggle('hidden', !checked);
}

// ë ŒíŠ¸/ë¦¬ìŠ¤ íƒ­ ì „í™˜
let currentContractType = 'rent';
function switchContractType(type) {
    currentContractType = type;
    document.getElementById('contract-tab-rent').className = type === 'rent' 
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-purple-500/20 text-purple-400 border border-purple-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    document.getElementById('contract-tab-lease').className = type === 'lease'
        ? 'px-6 py-2 rounded-lg font-bold text-sm bg-pink-500/20 text-pink-400 border border-pink-500/30'
        : 'px-6 py-2 rounded-lg font-bold text-sm text-gray-500 border border-white/10';
    loadContracts();
}

// íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
async function uploadFile(file, folder) {
    if (!file) return null;
    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const filePath = `${folder}/${fileName}`;
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const res = await fetch(`${SUPABASE_URL}/storage/v1/object/documents/${filePath}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'apikey': SUPABASE_KEY,
                'Content-Type': file.type || 'application/octet-stream',
                'x-upsert': 'true'
            },
            body: arrayBuffer
        });
        
        if (res.ok) {
            console.log('Upload success:', filePath);
            return `${SUPABASE_URL}/storage/v1/object/public/documents/${filePath}`;
        } else {
            const err = await res.text();
            console.error('Upload failed:', res.status, err);
        }
    } catch (e) {
        console.error('Upload error:', e);
    }
    return null;
}

async function submitContract(e) {
    e.preventDefault();
    showToast('ì €ì¥ ì¤‘...', 'info');
    
    const editId = document.getElementById('contract-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    // íŒŒì¼ ì—…ë¡œë“œ
    const contractorIdFile = document.getElementById('con-contractor-id').files[0];
    const contractorDocFile = document.getElementById('con-contractor-doc').files[0];
    const guarantorIdFile = document.getElementById('con-guarantor-id').files[0];
    const guarantorDocFile = document.getElementById('con-guarantor-doc').files[0];
    const vehicleRegFile = document.getElementById('con-vehicle-reg').files[0];
    const vehicleDisposalFile = document.getElementById('con-vehicle-disposal').files[0];
    const vehicleDocFile = document.getElementById('con-vehicle-doc').files[0];
    
    const [contractorIdUrl, contractorDocUrl, guarantorIdUrl, guarantorDocUrl, vehicleRegUrl, vehicleDisposalUrl, vehicleDocUrl] = await Promise.all([
        uploadFile(contractorIdFile, 'contractor'),
        uploadFile(contractorDocFile, 'contractor'),
        uploadFile(guarantorIdFile, 'guarantor'),
        uploadFile(guarantorDocFile, 'guarantor'),
        uploadFile(vehicleRegFile, 'vehicle'),
        uploadFile(vehicleDisposalFile, 'vehicle'),
        uploadFile(vehicleDocFile, 'vehicle')
    ]);
    
    const contractData = {
        customer_name: d.customer_name,
        phone: d.phone,
        vehicle: d.vehicle,
        plate: d.plate,
        monthly: parseInt(d.monthly) || 0,
        start_date: d.start_date,
        end_date: d.end_date || null,
        fuel_type: d.fuel_type || 'íœ˜ë°œìœ ',
        memo: d.memo || null,
        type: d.contract_type || 'rent',
        guarantor_name: d.guarantor_name || null,
        guarantor_phone: d.guarantor_phone || null
    };
    
    // ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œëœ ê²½ìš°ì—ë§Œ URL ì—…ë°ì´íŠ¸
    if (contractorIdUrl) contractData.contractor_id_url = contractorIdUrl;
    if (contractorDocUrl) contractData.contractor_doc_url = contractorDocUrl;
    if (guarantorIdUrl) contractData.guarantor_id_url = guarantorIdUrl;
    if (guarantorDocUrl) contractData.guarantor_doc_url = guarantorDocUrl;
    if (vehicleRegUrl) contractData.vehicle_reg_url = vehicleRegUrl;
    if (vehicleDisposalUrl) contractData.vehicle_disposal_url = vehicleDisposalUrl;
    if (vehicleDocUrl) contractData.vehicle_doc_url = vehicleDocUrl;
    
    if (editId) {
        await updateInDB('contracts', editId, contractData);
        const c = contractList.find(x => x.id === parseInt(editId));
        if (c) Object.assign(c, contractData);
        showToast('âœ… ê³„ì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        contractData.arrears = 0;
        contractData.status = 'active';
        const result = await insertToDB('contracts', contractData);
        if (result && result[0]) contractList.unshift(result[0]);
        showToast('âœ… ê³„ì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('contractModal');
    document.getElementById('contractForm').reset();
    document.getElementById('contract-edit-id').value = '';
    document.getElementById('guarantor-section').classList.add('hidden');
    document.getElementById('con-has-guarantor').checked = false;
    document.getElementById('contractModalTitle').textContent = 'ğŸ“‹ ê³„ì•½ ë“±ë¡';
    document.getElementById('contractSubmitBtn').textContent = 'ë“±ë¡';
    loadContracts();
}

async function deleteContract(id) {
    if (!confirm('ì •ë§ ì´ ê³„ì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await deleteFromDB('contracts', id);
    contractList = contractList.filter(c => c.id !== id);
    showToast('âœ… ê³„ì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('contractDetailModal');
    loadContracts();
}

// ======================= ì •ì‚°ê´€ë¦¬: ì°¨ëŸ‰ê´€ë¦¬ =======================
const vStatusBadge = s => ({ 'ì…ê³ ': ['badge-active', 'ì…ê³ (ëŒ€ê¸°)'], 'ì¶œê³ ': ['badge-completed', 'ì¶œê³ (ê³„ì•½ì¤‘)'], 'ë°˜ë‚©': ['badge-pending', 'ë°˜ë‚©(ì ê²€)'], 'ì •ë¹„': ['badge-delinquent', 'ì •ë¹„ì¤‘'], 'íì°¨': ['badge-staff', 'íì°¨/ë§¤ê°'] }[s] || ['', '']);

function loadVehicles() {
    const search = document.getElementById('vehicle-search').value.toLowerCase();
    const status = document.getElementById('vehicle-status').value;
    
    let list = vehicleList;
    if (status) list = list.filter(v => v.status === status);
    if (search) list = list.filter(v => v.plate.toLowerCase().includes(search) || v.model.toLowerCase().includes(search));
    
    // ìš”ì•½
    document.getElementById('v-stock').textContent = vehicleList.filter(v => v.status === 'ì…ê³ ').length + 'ëŒ€';
    document.getElementById('v-out').textContent = vehicleList.filter(v => v.status === 'ì¶œê³ ').length + 'ëŒ€';
    document.getElementById('v-return').textContent = vehicleList.filter(v => v.status === 'ë°˜ë‚©').length + 'ëŒ€';
    document.getElementById('v-repair').textContent = vehicleList.filter(v => v.status === 'ì •ë¹„').length + 'ëŒ€';
    document.getElementById('v-disposed').textContent = vehicleList.filter(v => v.status === 'íì°¨').length + 'ëŒ€';
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(v => {
        const [sc, sl] = vStatusBadge(v.status);
        const contract = v.contract_id ? contractList.find(c => c.id === v.contract_id) : null;
        h += `<tr onclick="viewVehicleDetail(${v.id})" class="cursor-pointer">
            <td class="font-mono font-bold text-lime-400">${v.plate}</td>
            <td>${v.model}</td>
            <td>${v.year}</td>
            <td>${v.color || '-'}</td>
            <td>${v.mileage.toLocaleString()} km</td>
            <td><span class="badge ${sc}">${sl}</span></td>
            <td class="${contract ? 'text-blue-400' : 'text-gray-500'}">${contract ? '#' + String(contract.id).padStart(3,'0') : '-'}</td>
        </tr>`;
    });
    document.getElementById('vehicle-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ì°¨ëŸ‰ ì—†ìŒ</td></tr>';
}

function filterVehicles(status) {
    document.getElementById('vehicle-status').value = status;
    loadVehicles();
}

function viewVehicleDetail(id) {
    const v = vehicleList.find(x => x.id === id);
    if (!v) return;
    
    const [sc, sl] = vStatusBadge(v.status);
    const contract = v.contract_id ? contractList.find(c => c.id === v.contract_id) : null;
    
    let actionBtns = '';
    if (v.status === 'ì…ê³ ') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ì¶œê³ ')" class="btn-primary flex-1">ğŸ“¤ ì¶œê³ </button><button onclick="changeVehicleStatus(${v.id}, 'ì •ë¹„')" class="btn-secondary flex-1">ğŸ”§ ì •ë¹„</button>`;
    else if (v.status === 'ì¶œê³ ') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ë°˜ë‚©')" class="btn-primary flex-1">ğŸ”„ ë°˜ë‚©</button>`;
    else if (v.status === 'ë°˜ë‚©') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ì…ê³ ')" class="btn-primary flex-1">âœ… ì ê²€ì™„ë£Œ</button><button onclick="changeVehicleStatus(${v.id}, 'ì •ë¹„')" class="btn-secondary flex-1">ğŸ”§ ì •ë¹„</button>`;
    else if (v.status === 'ì •ë¹„') actionBtns = `<button onclick="changeVehicleStatus(${v.id}, 'ì…ê³ ')" class="btn-primary flex-1">âœ… ì •ë¹„ì™„ë£Œ</button>`;
    
    // íì°¨/ë§¤ê° ë²„íŠ¼ (ì¶œê³  ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ)
    if (v.status !== 'ì¶œê³ ' && v.status !== 'íì°¨') {
        actionBtns += `<button onclick="changeVehicleStatus(${v.id}, 'íì°¨')" class="flex-1 p-2 rounded-lg bg-red-500/20 border border-red-500/50 text-red-400 text-sm hover:bg-red-500/30">ğŸš« íì°¨/ë§¤ê°</button>`;
    }
    
    document.getElementById('vehicle-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span class="text-lime-400 font-bold">${v.plate}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${sc}">${sl}</span></div>
                <div class="info-row"><span class="info-label">ëª¨ë¸</span><span class="font-bold">${v.model}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì‹</span><span>${v.year}ë…„</span></div>
                <div class="info-row"><span class="info-label">ìƒ‰ìƒ</span><span>${v.color || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì£¼í–‰ê±°ë¦¬</span><span>${v.mileage.toLocaleString()} km</span></div>
                ${contract ? `<div class="info-row col-span-2"><span class="info-label">ì—°ê²°ê³„ì•½</span><span class="text-blue-400">#${String(contract.id).padStart(3,'0')} ${contract.customer_name}</span></div>` : ''}
            </div>
        </div>
        ${v.memo ? `<div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4"><div class="text-xs text-lime-400 mb-2">ğŸ“ ë©”ëª¨</div><div class="text-sm">${v.memo}</div></div>` : ''}
        <div class="flex gap-3 mb-3">${actionBtns}</div>
        <div class="flex gap-3">
            <button onclick="deleteVehicle(${v.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('vehicleDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editVehicle(${v.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('vehicleDetailModal');
}

function changeVehicleStatus(id, newStatus) {
    const v = vehicleList.find(x => x.id === id);
    if (v) {
        v.status = newStatus;
        if (newStatus !== 'ì¶œê³ ') v.contract_id = null;
    }
    showToast(`âœ… ì°¨ëŸ‰ ìƒíƒœê°€ "${newStatus}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
    closeModal('vehicleDetailModal');
    loadVehicles();
}

function editVehicle(id) {
    closeModal('vehicleDetailModal');
    const v = vehicleList.find(x => x.id === id);
    if (!v) return;
    
    document.getElementById('vehicleModalTitle').textContent = 'ğŸš— ì°¨ëŸ‰ ìˆ˜ì •';
    document.getElementById('vehicleSubmitBtn').textContent = 'ìˆ˜ì •';
    document.getElementById('vehicle-edit-id').value = v.id;
    document.getElementById('veh-plate').value = v.plate;
    document.getElementById('veh-model').value = v.model;
    document.getElementById('veh-year').value = v.year;
    document.getElementById('veh-color').value = v.color || '';
    document.getElementById('veh-mileage').value = v.mileage;
    document.getElementById('veh-memo').value = v.memo || '';
    openModal('vehicleModal');
}

function submitVehicle(e) {
    e.preventDefault();
    const editId = document.getElementById('vehicle-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        const v = vehicleList.find(x => x.id === parseInt(editId));
        if (v) {
            v.plate = d.plate;
            v.model = d.model;
            v.year = parseInt(d.year) || 2024;
            v.color = d.color || '';
            v.mileage = parseInt(d.mileage) || 0;
            v.memo = d.memo || '';
        }
        showToast('âœ… ì°¨ëŸ‰ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        vehicleList.push({
            id: Math.max(...vehicleList.map(v => v.id), 0) + 1,
            plate: d.plate,
            model: d.model,
            year: parseInt(d.year) || 2024,
            color: d.color || '',
            mileage: parseInt(d.mileage) || 0,
            status: 'ì…ê³ ',
            contract_id: null,
            memo: d.memo || ''
        });
        showToast('âœ… ì°¨ëŸ‰ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('vehicleModal');
    document.getElementById('vehicleForm').reset();
    document.getElementById('vehicle-edit-id').value = '';
    document.getElementById('vehicleModalTitle').textContent = 'ğŸš— ì°¨ëŸ‰ ë“±ë¡';
    document.getElementById('vehicleSubmitBtn').textContent = 'ë“±ë¡';
    loadVehicles();
}

function deleteVehicle(id) {
    if (!confirm('ì •ë§ ì´ ì°¨ëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    vehicleList = vehicleList.filter(v => v.id !== id);
    showToast('âœ… ì°¨ëŸ‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('vehicleDetailModal');
    loadVehicles();
}

// ======================= ê³ ê° ê´€ë¦¬ =======================
function filterCustomers(grade) {
    document.getElementById('cust-grade').value = grade;
    loadCustomers();
}

function loadCustomers() {
    const search = document.getElementById('cust-search').value.toLowerCase();
    const grade = document.getElementById('cust-grade').value;
    
    let customers = customerList;
    if (grade) customers = customers.filter(c => c.grade === grade);
    if (search) customers = customers.filter(c => c.name.toLowerCase().includes(search) || c.phone.includes(search));
    
    // ìš”ì•½ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('cust-total').textContent = customerList.length + 'ëª…';
    document.getElementById('cust-high').textContent = customerList.filter(c => c.grade === 'ìƒ').length + 'ëª…';
    document.getElementById('cust-mid').textContent = customerList.filter(c => c.grade === 'ì¤‘').length + 'ëª…';
    document.getElementById('cust-low').textContent = customerList.filter(c => c.grade === 'í•˜').length + 'ëª…';
    
    // í…Œì´ë¸” ë Œë”ë§
    let h = '';
    customers.forEach(c => {
        const [gc, gl] = gradeBadge(c.grade);
        h += `<tr onclick="viewCustomerDetail(${c.id})">
            <td class="font-bold">${c.name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td class="text-gray-400 text-xs">${c.address || '-'}</td>
            <td><span class="badge ${gc}">${gl}</span></td>
            <td class="text-gray-500 text-xs">${c.memo || '-'}</td>
            <td class="text-gray-500 text-xs">${c.created_at}</td>
        </tr>`;
    });
    document.getElementById('cust-tbody').innerHTML = h || '<tr><td colspan="6" class="text-center text-gray-500 py-6">ê³ ê° ì—†ìŒ</td></tr>';
}

function openCustomerModal(editId = null) {
    document.getElementById('customerForm').reset();
    document.getElementById('cust-edit-id').value = '';
    
    if (editId) {
        const c = customerList.find(x => x.id === editId);
        if (c) {
            document.getElementById('customerModalTitle').textContent = 'ğŸ‘¤ ê³ ê° ìˆ˜ì •';
            document.getElementById('customerSubmitBtn').textContent = 'ìˆ˜ì •';
            document.getElementById('cust-edit-id').value = c.id;
            document.getElementById('cust-name').value = c.name;
            document.getElementById('cust-ssn').value = c.ssn || '';
            document.getElementById('cust-phone').value = c.phone;
            document.getElementById('cust-email').value = c.email || '';
            document.getElementById('cust-address').value = c.address || '';
            document.getElementById('cust-grade-select').value = c.grade || '';
            document.getElementById('cust-memo').value = c.memo || '';
        }
    } else {
        document.getElementById('customerModalTitle').textContent = 'ğŸ‘¤ ê³ ê° ë“±ë¡';
        document.getElementById('customerSubmitBtn').textContent = 'ë“±ë¡';
    }
    
    openModal('customerModal');
}

function submitCustomer(e) {
    e.preventDefault();
    const editId = document.getElementById('cust-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // ìˆ˜ì • ëª¨ë“œ
        const c = customerList.find(x => x.id === parseInt(editId));
        if (c) {
            c.name = d.name;
            c.ssn = d.ssn || null;
            c.phone = d.phone;
            c.email = d.email || null;
            c.address = d.address || null;
            c.grade = d.grade;
            c.memo = d.memo || null;
        }
        showToast('âœ… ê³ ê° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ë“±ë¡ ëª¨ë“œ
        customerList.push({
            id: Math.max(...customerList.map(c => c.id)) + 1,
            name: d.name,
            ssn: d.ssn || null,
            phone: d.phone,
            email: d.email || null,
            address: d.address || null,
            grade: d.grade,
            memo: d.memo || null,
            created_at: new Date().toISOString().split('T')[0]
        });
        showToast('âœ… ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('customerModal');
    loadCustomers();
}

function viewCustomerDetail(id) {
    const c = customerList.find(x => x.id === id);
    if (!c) return;
    
    const [gc, gl] = gradeBadge(c.grade);
    
    document.getElementById('customer-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 font-bold mb-3">ğŸ‘¤ ê³ ê° ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.name}</span></div>
                <div class="info-row"><span class="info-label">ì£¼ë¯¼ë²ˆí˜¸</span><span>${c.ssn || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì´ë©”ì¼</span><span>${c.email || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì£¼ì†Œ</span><span>${c.address || '-'}</span></div>
                <div class="info-row"><span class="info-label">ê±°ë˜ë“±ê¸‰</span><span class="badge ${gc}">${gl}</span></div>
            </div>
        </div>
        
        ${c.memo ? `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 font-bold mb-3">ğŸ“ ë©”ëª¨</div>
            <div class="text-sm text-gray-300">${c.memo}</div>
        </div>
        ` : ''}
        
        <div class="flex gap-3">
            <button onclick="deleteCustomer(${c.id})" class="btn-danger flex-1">ì‚­ì œ</button>
            <button onclick="closeModal('customerDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="editCustomer(${c.id})" class="btn-primary flex-1">ìˆ˜ì •</button>
        </div>
    `;
    openModal('customerDetailModal');
}

function editCustomer(id) {
    closeModal('customerDetailModal');
    openCustomerModal(id);
}

function deleteCustomer(id) {
    const c = customerList.find(x => x.id === id);
    if (!c) return;
    
    if (!confirm(`ì •ë§ "${c.name}" ê³ ê°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    customerList = customerList.filter(x => x.id !== id);
    showToast('âœ… ê³ ê°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('customerDetailModal');
    loadCustomers();
}

// ======================= ì •ì‚°ê´€ë¦¬: í†µí•©í˜„í™© =======================
function loadOverview() {
    // í•œêµ­ì‹œê°„ ê¸°ì¤€
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
    const totalContracts = contractList.length;
    const totalArrears = contractList.reduce((s, c) => s + c.arrears, 0);
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© ê¸ˆì•¡ (ì›ì¥ì—ì„œ ê³„ì‚°)
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const monthlyReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    
    // ì˜¤ëŠ˜ ë°œìƒ ê¸ˆì•¡
    const todayAccrual = ledgerList.filter(l => l.type === 'accrual' && l.date === today).reduce((s, l) => s + l.accrual, 0);
    
    document.getElementById('s-total').textContent = totalContracts + 'ê±´';
    document.getElementById('s-revenue').textContent = fmt(monthlyReceipt);
    document.getElementById('s-arrears').textContent = fmt(totalArrears);
    document.getElementById('s-today').textContent = fmt(todayAccrual);
    
    // ì—°ì²´ ê³„ì•½ ëª©ë¡ (ë¯¸ìˆ˜ê¸ˆ ìˆëŠ” ê³„ì•½)
    const delinquents = contractList.filter(c => c.arrears > 0);
    let dh = '';
    delinquents.forEach(c => {
        dh += `<div class="p-3 rounded-xl bg-orange-400/5 border border-orange-400/20 flex items-center justify-between cursor-pointer hover:bg-orange-400/10" onclick="viewArrearsDetail(${c.id})">
            <div><div class="font-bold text-sm">${c.customer_name}</div><div class="text-xs text-gray-500">${c.vehicle} Â· ${c.plate}</div></div>
            <div class="text-orange-400 font-bold">${fmt(c.arrears)}</div>
        </div>`;
    });
    document.getElementById('s-delinquent-list').innerHTML = dh || '<div class="text-gray-500 text-sm text-center py-4">ì—°ì²´ ê³„ì•½ ì—†ìŒ</div>';
    
    // ìµœê·¼ ê²°ì œ ëª©ë¡
    let ph = '';
    recentPayments.forEach(p => {
        const dateStr = p.date === today ? 'ì˜¤ëŠ˜' : p.date === new Date(koreaTime.getTime() - 86400000).toISOString().split('T')[0] ? 'ì–´ì œ' : p.date;
        ph += `<div class="p-3 rounded-xl bg-emerald-400/5 border border-emerald-400/20 flex items-center justify-between cursor-pointer hover:bg-emerald-400/10" onclick="viewPaymentDetail(${p.id})">
            <div><div class="font-bold text-sm">${p.customer_name}</div><div class="text-xs text-gray-500">${dateStr} ${p.time}</div></div>
            <div class="text-emerald-400 font-bold">${fmt(p.amount)}</div>
        </div>`;
    });
    document.getElementById('s-recent-payments').innerHTML = ph || '<div class="text-gray-500 text-sm text-center py-4">ìµœê·¼ ê²°ì œ ì—†ìŒ</div>';
}

function viewPaymentDetail(paymentId) {
    const p = recentPayments.find(x => x.id === paymentId);
    if (!p) return;
    
    // í•´ë‹¹ ê³ ê° ê³„ì•½ ì°¾ê¸°
    const contract = contractList.find(c => c.customer_name === p.customer_name);
    
    let content = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œê¸ˆì•¡</span><span class="text-emerald-400 font-bold">${fmt(p.amount)}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œì¼ì‹œ</span><span>${p.date} ${p.time}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œë°©ë²•</span><span>ì¹´ë“œ</span></div>
            </div>
        </div>
    `;
    
    if (contract) {
        content += `
            <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20 mb-4">
                <div class="text-xs text-blue-400 mb-2">ğŸ“‹ ê³„ì•½ ì •ë³´</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${contract.vehicle}</span></div>
                    <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${contract.plate}</span></div>
                    <div class="info-row"><span class="info-label">ì›” ë‚©ì…ê¸ˆ</span><span>${fmt(contract.monthly)}</span></div>
                    <div class="info-row"><span class="info-label">ë¯¸ë‚©ê¸ˆ</span><span class="${contract.arrears > 0 ? 'text-orange-400' : ''}">${fmt(contract.arrears)}</span></div>
                </div>
            </div>
        `;
    }
    
    content += `
        <div class="flex gap-3">
            <button onclick="closeModal('recentPaymentsModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="showSettlementTab('ledger'); closeModal('recentPaymentsModal');" class="btn-primary flex-1">ì›ì¥ì—ì„œ ë³´ê¸°</button>
        </div>
    `;
    
    document.getElementById('recent-payments-content').innerHTML = content;
    openModal('recentPaymentsModal');
}

function openArrearsModal() {
    const delinquents = contractList.filter(c => c.arrears > 0);
    const totalArrears = delinquents.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('arrears-total-amount').textContent = fmt(totalArrears);
    
    let h = '';
    delinquents.forEach(c => {
        h += `<tr>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="text-red-400">${c.delinquent_days || 0}ì¼</td>
            <td><button onclick="viewArrearsDetail(${c.id})" class="text-lime-400 text-xs hover:underline">ìƒì„¸</button></td>
        </tr>`;
    });
    document.getElementById('arrears-tbody').innerHTML = h || '<tr><td colspan="6" class="text-center text-gray-500 py-6">ë¯¸ë‚© ê³ ê° ì—†ìŒ</td></tr>';
    
    openModal('arrearsModal');
}

function viewArrearsDetail(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    closeModal('arrearsModal');
    
    // í•´ë‹¹ ê³„ì•½ì˜ ë¯¸ìˆ˜ê¸ˆ ë‚´ì—­
    const details = arrearsDetailList.filter(d => d.contract_id === contractId);
    
    // ê³ ê° ì •ë³´ ì°¾ê¸°
    const customer = customerList.find(cu => cu.name === c.customer_name);
    const phoneClean = c.phone.replace(/-/g, '');
    
    let detailRows = '';
    details.forEach(d => {
        const statusBadge = d.status === 'unpaid' ? '<span class="badge badge-failed">ë¯¸ë‚©</span>' : '<span class="badge badge-pending">ì¼ë¶€ë‚©</span>';
        const paidInfo = d.status === 'partial' ? `<div class="text-xs text-gray-500">ë‚©ë¶€: ${fmt(d.paid)}</div>` : '';
        detailRows += `<tr>
            <td class="text-gray-400">${d.date}</td>
            <td>${d.type}</td>
            <td class="text-orange-400 font-bold">${fmt(d.amount)}</td>
            <td>${statusBadge}${paidInfo}</td>
        </tr>`;
    });
    
    document.getElementById('arrears-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold text-lime-400 cursor-pointer hover:underline" onclick="closeModal('arrearsDetailModal'); ${customer ? `viewCustomerDetail(${customer.id})` : `showToast('ê³ ê°ì •ë³´ ì—†ìŒ', 'error')`}">${c.customer_name} â†’</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${c.plate}</span></div>
                <div class="info-row"><span class="info-label">ì›” ë ŒíŠ¸ë£Œ</span><span class="text-blue-400 font-bold">${fmt(c.monthly)}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì²´ì¼ìˆ˜</span><span class="text-red-400 font-bold">${c.delinquent_days || 0}ì¼</span></div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ğŸ“ ì „í™”</div>
                <div class="text-xs text-gray-400">${c.phone}</div>
            </a>
            <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ğŸ’¬ ë¬¸ì</div>
                <div class="text-xs text-gray-400">ë…ì´‰ ë¬¸ì ë°œì†¡</div>
            </a>
        </div>
        
        <div class="p-4 rounded-lg bg-orange-400/10 border border-orange-400/30 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-orange-400 font-bold">ì´ ë¯¸ë‚© ê¸ˆì•¡</span>
                <span class="text-2xl font-black text-orange-400">${fmt(c.arrears)}</span>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4">
            <table class="data-table">
                <thead><tr><th>ë°œìƒì¼</th><th>êµ¬ë¶„</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${detailRows || '<tr><td colspan="4" class="text-center text-gray-500 py-4">ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('arrearsDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="openPaymentModal(${c.id})" class="btn-primary flex-1">ğŸ’° ìˆ˜ë‚© ì²˜ë¦¬</button>
        </div>
    `;
    
    openModal('arrearsDetailModal');
}

// ìˆ˜ë‚© ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
function openPaymentModal(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    closeModal('arrearsDetailModal');
    
    document.getElementById('payment-contract-id').value = contractId;
    document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('payment-amount').value = c.arrears;
    
    document.getElementById('payment-info').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${c.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë¯¸ë‚©ê¸ˆì•¡</span><span class="text-orange-400 font-bold">${fmt(c.arrears)}</span></div>
            </div>
        </div>
    `;
    
    openModal('paymentProcessModal');
}

// ìˆ˜ë‚© ì²˜ë¦¬ ì‹¤í–‰
function processPayment(e) {
    e.preventDefault();
    const contractId = parseInt(document.getElementById('payment-contract-id').value);
    const amount = parseInt(document.getElementById('payment-amount').value) || 0;
    const date = document.getElementById('payment-date').value;
    const method = e.target.pay_method.value;
    const memo = e.target.pay_memo.value;
    
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    // ë¯¸ë‚©ê¸ˆ ì°¨ê°
    c.arrears = Math.max(0, c.arrears - amount);
    if (c.arrears === 0) {
        c.status = 'active';
        c.delinquent_days = 0;
    }
    
    // ì›ì¥ì— ìˆ˜ë‚© ê¸°ë¡ ì¶”ê°€
    ledgerList.unshift({
        id: Math.max(...ledgerList.map(l => l.id), 0) + 1,
        date: date,
        contract_id: contractId,
        customer_name: c.customer_name,
        type: 'receipt',
        desc: `ìˆ˜ë‚© (${method})${memo ? ' - ' + memo : ''}`,
        accrual: 0,
        receipt: amount
    });
    
    // ìµœê·¼ê²°ì œ ë‚´ì—­ì— ì¶”ê°€
    recentPayments.unshift({
        id: Math.max(...recentPayments.map(p => p.id), 0) + 1,
        customer_name: c.customer_name,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5)
    });
    
    showToast(`âœ… ${c.customer_name}ë‹˜ ${fmt(amount)} ìˆ˜ë‚© ì™„ë£Œ`);
    closeModal('paymentProcessModal');
    loadOverview();
}

// ======================= ì—‘ì…€ ë‹¤ìš´ë¡œë“œ =======================
function downloadExcel(type) {
    let data = [];
    let filename = '';
    
    switch(type) {
        case 'contracts':
            filename = 'ê³„ì•½ëª©ë¡';
            data = contractList.map(c => ({
                'ê³„ì•½ë²ˆí˜¸': '#' + String(c.id).padStart(3, '0'),
                'ê³ ê°ëª…': c.customer_name,
                'ì—°ë½ì²˜': c.phone,
                'ì°¨ëŸ‰': c.vehicle,
                'ë²ˆí˜¸íŒ': c.plate,
                'ì›”ë‚©ì…ê¸ˆ': c.monthly,
                'ë¯¸ë‚©ê¸ˆ': c.arrears,
                'ìƒíƒœ': c.status === 'active' ? 'ì§„í–‰ì¤‘' : 'ì—°ì²´',
                'ê³„ì•½ì‹œì‘ì¼': c.start_date
            }));
            break;
        case 'vehicles':
            filename = 'ì°¨ëŸ‰ëª©ë¡';
            data = vehicleList.map(v => ({
                'ë²ˆí˜¸íŒ': v.plate,
                'ëª¨ë¸': v.model,
                'ì—°ì‹': v.year,
                'ìƒ‰ìƒ': v.color,
                'ì£¼í–‰ê±°ë¦¬': v.mileage,
                'ìƒíƒœ': v.status,
                'ë©”ëª¨': v.memo || ''
            }));
            break;
        case 'customers':
            filename = 'ê³ ê°ëª©ë¡';
            data = customerList.map(c => ({
                'ê³ ê°ëª…': c.name,
                'ì—°ë½ì²˜': c.phone,
                'ì´ë©”ì¼': c.email || '',
                'ì£¼ì†Œ': c.address || '',
                'ë“±ê¸‰': c.grade,
                'ë©”ëª¨': c.memo || '',
                'ë“±ë¡ì¼': c.created_at
            }));
            break;
        case 'ledger':
            filename = 'ì›ì¥ë‚´ì—­';
            data = ledgerList.map(l => ({
                'ì¼ì': l.date,
                'ê³ ê°ëª…': l.customer_name,
                'êµ¬ë¶„': l.type === 'accrual' ? 'ë°œìƒ' : l.type === 'receipt' ? 'ìˆ˜ë‚©' : 'ì¡°ì •',
                'ë‚´ìš©': l.desc,
                'ë°œìƒ': l.accrual,
                'ìˆ˜ë‚©': l.receipt
            }));
            break;
        case 'delinquent':
            filename = 'ì—°ì²´ëª©ë¡';
            data = contractList.filter(c => c.arrears > 0).map(c => ({
                'ê³ ê°ëª…': c.customer_name,
                'ì—°ë½ì²˜': c.phone,
                'ì°¨ëŸ‰': c.vehicle,
                'ë²ˆí˜¸íŒ': c.plate,
                'ì—°ì²´ê¸ˆì•¡': c.arrears,
                'ì—°ì²´ì¼ìˆ˜': c.delinquent_days || 0,
                'ì›”ë‚©ì…ê¸ˆ': c.monthly
            }));
            break;
        case 'pg':
            filename = 'ìë™ê²°ì œëª©ë¡';
            data = pgPaymentsList.map(p => ({
                'ê³ ê°ëª…': p.customer_name,
                'ì¹´ë“œë²ˆí˜¸': p.card_no,
                'ê²°ì œíƒ€ì…': payTypeLabel(p.pay_type),
                'ê²°ì œê¸ˆì•¡': p.amount,
                'ìµœê·¼ê²°ì œ': p.last_pay,
                'ìƒíƒœ': p.status === 'success' ? 'ì„±ê³µ' : p.status === 'failed' ? 'ì‹¤íŒ¨' : 'ì˜ˆì •'
            }));
            break;
        case 'broWork':
            filename = 'ì‘ì—…ë‚´ì—­';
            data = broWorkList.map(w => ({
                'ì ‘ìˆ˜ë²ˆí˜¸': '#W' + String(w.id).padStart(3, '0'),
                'ê³ ê°ëª…': w.customer,
                'ì—°ë½ì²˜': w.phone,
                'ì°¨ëŸ‰': w.vehicle,
                'ë²ˆí˜¸íŒ': w.plate,
                'ì‘ì—…ë‚´ìš©': w.content,
                'ê³µì„': w.labor,
                'ë¶€í’ˆë¹„': w.parts_cost,
                'í•©ê³„': w.labor + w.parts_cost,
                'ìƒíƒœ': w.status === 'complete' ? 'ì™„ë£Œ' : w.status === 'progress' ? 'ì§„í–‰ì¤‘' : 'ëŒ€ê¸°',
                'ë‚ ì§œ': w.date
            }));
            break;
        case 'broCashbook':
            filename = 'ê¸ˆì „ì¶œë‚©ë¶€';
            data = broCashbookList.map(c => ({
                'ë‚ ì§œ': c.date,
                'êµ¬ë¶„': c.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ',
                'ë¶„ë¥˜': c.category,
                'ë‚´ìš©': c.description,
                'ê¸ˆì•¡': c.amount
            }));
            break;
        case 'broParts':
            filename = 'ë¶€í’ˆì¬ê³ ';
            data = broPartsList.map(p => ({
                'ë¶€í’ˆëª…': p.name,
                'ë¶„ë¥˜': p.category,
                'ì¬ê³ ': p.stock,
                'ë‹¨ê°€': p.price,
                'ìµœì†Œì¬ê³ ': p.min_stock
            }));
            break;
        default:
            showToast('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜', 'error');
            return;
    }
    
    if (data.length === 0) {
        showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    // CSV ìƒì„±
    const headers = Object.keys(data[0]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    data.forEach(row => {
        csv += headers.map(h => {
            let val = row[h];
            if (typeof val === 'string' && (val.includes(',') || val.includes('\n'))) {
                val = '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
        }).join(',') + '\n';
    });
    
    // ë‹¤ìš´ë¡œë“œ
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showToast(`âœ… ${filename} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ì‘ì—…ë‚´ìš© =======================
const workStatusBadge = s => ({ waiting: ['badge-waiting', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[s] || ['', '']);

function loadBroWork() {
    const search = document.getElementById('b-work-search').value.toLowerCase();
    const statusFilter = document.getElementById('b-work-status').value;
    
    // ë‚ ì§œ êµ¬ê°„ ê¸°ë³¸ê°’: ì•ìœ¼ë¡œ 7ì¼
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let startDate = document.getElementById('b-work-start').value;
    let endDate = document.getElementById('b-work-end').value;
    
    if (!startDate || !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
        endDate = today;
        document.getElementById('b-work-start').value = startDate;
        document.getElementById('b-work-end').value = endDate;
    }
    
    let works = broWorkList.filter(w => w.date >= startDate && w.date <= endDate);
    if (statusFilter) works = works.filter(w => w.status === statusFilter);
    if (search) works = works.filter(w => 
        w.customer.toLowerCase().includes(search) || 
        w.vehicle.toLowerCase().includes(search) ||
        (w.plate && w.plate.toLowerCase().includes(search)) ||
        w.content.toLowerCase().includes(search)
    );
    
    // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    works.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    
    let h = '';
    works.forEach(w => {
        const [sc, sl] = workStatusBadge(w.status);
        const total = w.labor + w.parts_cost;
        const isPaid = w.status === 'complete';
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewWorkDetail(${w.id})">
            <td class="text-lime-400">#W${String(w.id).padStart(3,'0')}</td>
            <td class="text-gray-400">${w.date}</td>
            <td class="font-bold">${w.customer}</td>
            <td>${w.vehicle}</td>
            <td>${w.content}</td>
            <td class="text-gray-400">${fmt(w.labor)}</td>
            <td class="text-gray-400">${fmt(w.parts_cost)}</td>
            <td class="font-bold">${fmt(total)}</td>
            <td><span class="badge ${sc}">${sl}</span></td>
            <td>
                ${isPaid 
                    ? '<span class="text-emerald-400 text-xs">âœ… ì™„ë£Œ</span>' 
                    : `<button onclick="event.stopPropagation(); openBroCardPayModal(${w.id})" class="text-blue-400 text-xs hover:underline">ğŸ’³</button>`
                }
            </td>
        </tr>`;
    });
    document.getElementById('b-work-tbody').innerHTML = h || '<tr><td colspan="10" class="text-center text-gray-500 py-6">ì‘ì—… ì—†ìŒ</td></tr>';
}

async function submitBroWork(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // ì‘ì—… ë“±ë¡
    const workData = {
        customer: d.customer,
        phone: d.phone,
        vehicle: d.vehicle,
        plate: d.plate || '',
        content: d.content,
        labor: parseInt(d.labor) || 0,
        parts_cost: parseInt(d.parts_cost) || 0,
        status: 'waiting',
        memo: d.memo || '',
        date: today
    };
    
    const result = await insertToDB('bro_works', workData);
    if (result && result[0]) broWorkList.unshift(result[0]);
    
    // ê³ ê° ì •ë³´ ìë™ ì €ì¥/ì—…ë°ì´íŠ¸
    const existingCust = broCustList.find(c => c.name === d.customer || c.phone === d.phone);
    if (existingCust) {
        existingCust.visits = (existingCust.visits || 0) + 1;
        existingCust.last_visit = today;
        await updateInDB('bro_customers', existingCust.id, { visits: existingCust.visits, last_visit: today });
    } else {
        const custData = {
            name: d.customer,
            phone: d.phone,
            vehicle: d.vehicle || '',
            plate: d.plate || '',
            visits: 1,
            last_visit: today
        };
        const custResult = await insertToDB('bro_customers', custData);
        if (custResult && custResult[0]) broCustList.unshift(custResult[0]);
        showToast('ğŸ‘¤ ì‹ ê·œ ê³ ê°ì´ ìë™ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    showToast('âœ… ì‘ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('workModal');
    e.target.reset();
    loadBroWork();
    loadBroDashboard();
}

function viewWorkDetail(id) {
    const w = broWorkList.find(x => x.id === id);
    if (!w) return;
    
    const [sc, sl] = workStatusBadge(w.status);
    const total = w.labor + w.parts_cost;
    const isPaid = w.status === 'complete';
    const phoneClean = w.phone.replace(/-/g, '');
    
    let statusBtns = '';
    if (w.status === 'waiting') statusBtns = `<button onclick="updateWorkStatus(${w.id}, 'progress')" class="btn-secondary flex-1">â–¶ ì§„í–‰</button>`;
    else if (w.status === 'progress') statusBtns = `<button onclick="updateWorkStatus(${w.id}, 'complete')" class="btn-secondary flex-1">âœ… ì™„ë£Œ</button>`;
    
    const payBtn = isPaid 
        ? '<div class="text-emerald-400 text-center py-3">âœ… ê²°ì œì™„ë£Œ</div>' 
        : `<button onclick="closeModal('workDetailModal'); openBroCardPayModal(${w.id})" class="btn-primary flex-1">ğŸ’³ ì¹´ë“œê²°ì œ</button>`;
    
    document.getElementById('work-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì ‘ìˆ˜ë²ˆí˜¸</span><span class="text-lime-400 font-bold">#W${String(w.id).padStart(3,'0')}</span></div>
                <div class="info-row"><span class="info-label">ìƒíƒœ</span><span class="badge ${sc}">${sl}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${w.customer}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${w.phone}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${w.vehicle}</span></div>
                <div class="info-row"><span class="info-label">ë²ˆí˜¸íŒ</span><span>${w.plate || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì‘ì—…ë‚´ìš©</span><span>${w.content}</span></div>
                <div class="info-row"><span class="info-label">ë‚ ì§œ</span><span>${w.date}</span></div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ğŸ“ ì „í™”</div>
            </a>
            <a href="sms:${phoneClean}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ğŸ’¬ ë¬¸ì</div>
            </a>
        </div>
        
        <div class="p-4 rounded-lg bg-lime-400/10 border border-lime-400/30 mb-4">
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><div class="text-xs text-gray-400">ê³µì„</div><div class="font-bold text-blue-400">${fmt(w.labor)}</div></div>
                <div><div class="text-xs text-gray-400">ë¶€í’ˆë¹„</div><div class="font-bold text-orange-400">${fmt(w.parts_cost)}</div></div>
                <div><div class="text-xs text-lime-400">í•©ê³„</div><div class="font-bold text-xl text-lime-400">${fmt(total)}</div></div>
            </div>
        </div>
        
        <div class="flex gap-3">
            ${statusBtns}
            ${payBtn}
            <button onclick="closeModal('workDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
        </div>
    `;
    openModal('workDetailModal');
}

function updateWorkStatus(id, status) {
    const w = broWorkList.find(x => x.id === id);
    if (w) w.status = status;
    showToast('âœ… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('workDetailModal');
    loadBroWork();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ê¸ˆì „ì¶œë‚©ë¶€ =======================
function loadBroCashbook() {
    const typeFilter = document.getElementById('b-cb-type').value;
    const dateFilter = document.getElementById('b-cb-date').value;
    const search = document.getElementById('b-cb-search').value.toLowerCase();
    
    let list = broCashbookList;
    if (typeFilter) list = list.filter(c => c.type === typeFilter);
    if (dateFilter) list = list.filter(c => c.date >= dateFilter);
    if (search) list = list.filter(c => c.description.toLowerCase().includes(search));
    
    // ìš”ì•½ ê³„ì‚° (í•„í„°ëœ ë°ì´í„° ê¸°ì¤€)
    const income = list.filter(c => c.type === 'income').reduce((s, c) => s + c.amount, 0);
    const expense = list.filter(c => c.type === 'expense').reduce((s, c) => s + c.amount, 0);
    const profit = income - expense;
    
    // ì „ì²´ ì”ì•¡
    const totalIncome = broCashbookList.filter(c => c.type === 'income').reduce((s, c) => s + c.amount, 0);
    const totalExpense = broCashbookList.filter(c => c.type === 'expense').reduce((s, c) => s + c.amount, 0);
    
    document.getElementById('b-cb-income').textContent = fmt(income);
    document.getElementById('b-cb-expense').textContent = fmt(expense);
    document.getElementById('b-cb-profit').textContent = fmt(profit);
    document.getElementById('b-cb-balance').textContent = fmt(totalIncome - totalExpense);
    
    // í…Œì´ë¸”
    let h = '', balance = 0;
    list.forEach(c => {
        balance += c.type === 'income' ? c.amount : -c.amount;
        h += `<tr>
            <td class="text-gray-400">${c.date}</td>
            <td><span class="badge ${c.type === 'income' ? 'badge-active' : 'badge-failed'}">${c.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'}</span></td>
            <td>${c.category}</td>
            <td>${c.description}</td>
            <td class="${c.type === 'income' ? 'text-lime-400' : 'text-red-400'} font-bold">${c.type === 'income' ? '+' : '-'}${fmt(c.amount)}</td>
            <td class="text-gray-400">${fmt(balance)}</td>
            <td>
                <button onclick="editCashbook(${c.id})" class="text-blue-400 text-xs hover:underline mr-2">ìˆ˜ì •</button>
                <button onclick="deleteCashbook(${c.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-cb-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ë‚´ì—­ ì—†ìŒ</td></tr>';
}

// ê¸ˆì „ì¶œë‚©ë¶€ ìˆ˜ì •
function editCashbook(id) {
    const c = broCashbookList.find(x => x.id === id);
    if (!c) return;
    
    document.getElementById('cashbook-edit-id').value = c.id;
    document.getElementById('cb-date').value = c.date;
    document.getElementById('cb-type').value = c.type;
    document.getElementById('cb-category').value = c.category;
    document.getElementById('cb-description').value = c.description;
    document.getElementById('cb-amount').value = c.amount;
    
    document.getElementById('cashbookModalTitle').textContent = 'ğŸ’° ë‚´ì—­ ìˆ˜ì •';
    document.getElementById('cashbookSubmitBtn').textContent = 'ìˆ˜ì •';
    openModal('cashbookModal');
}

// ê¸ˆì „ì¶œë‚©ë¶€ ì‚­ì œ
async function deleteCashbook(id) {
    if (!confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await deleteFromDB('bro_cashbook', id);
    broCashbookList = broCashbookList.filter(c => c.id !== id);
    showToast('âœ… ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadBroCashbook();
}

async function submitBroCashbook(e) {
    e.preventDefault();
    const editId = document.getElementById('cashbook-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    const cashData = {
        date: d.date,
        type: d.type,
        category: d.category,
        description: d.description,
        amount: parseInt(d.amount) || 0
    };
    
    if (editId) {
        await updateInDB('bro_cashbook', editId, cashData);
        const c = broCashbookList.find(x => x.id === parseInt(editId));
        if (c) Object.assign(c, cashData);
        showToast('âœ… ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        const result = await insertToDB('bro_cashbook', cashData);
        if (result && result[0]) broCashbookList.unshift(result[0]);
        showToast('âœ… ë‚´ì—­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('cashbookModal');
    e.target.reset();
    document.getElementById('cashbook-edit-id').value = '';
    document.getElementById('cashbookModalTitle').textContent = 'ğŸ’° ë‚´ì—­ ë“±ë¡';
    document.getElementById('cashbookSubmitBtn').textContent = 'ë“±ë¡';
    document.getElementById('cb-date').value = new Date().toISOString().split('T')[0];
    loadBroCashbook();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ë¶€í’ˆê´€ë¦¬ =======================
function filterBroParts(type) {
    document.getElementById('b-parts-stock-filter').value = type;
    loadBroParts();
}

function loadBroParts() {
    const search = document.getElementById('b-parts-search').value.toLowerCase();
    const categoryFilter = document.getElementById('b-parts-category').value;
    const stockFilter = document.getElementById('b-parts-stock-filter').value;
    
    let parts = broPartsList;
    if (categoryFilter) parts = parts.filter(p => p.category === categoryFilter);
    if (stockFilter === 'low') parts = parts.filter(p => p.stock > 0 && p.stock <= p.min_stock);
    else if (stockFilter === 'normal') parts = parts.filter(p => p.stock > p.min_stock);
    else if (stockFilter === 'zero') parts = parts.filter(p => p.stock === 0);
    if (search) parts = parts.filter(p => p.name.toLowerCase().includes(search) || p.category.toLowerCase().includes(search));
    
    // ìš”ì•½
    const totalQty = broPartsList.reduce((s, p) => s + p.stock, 0);
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock);
    const lowStockNames = lowStockParts.slice(0, 3).map(p => p.name.substring(0, 8)).join(', ');
    const totalValue = broPartsList.reduce((s, p) => s + p.stock * p.price, 0);
    
    document.getElementById('b-parts-total').textContent = broPartsList.length + 'ì¢…';
    document.getElementById('b-parts-total-qty').textContent = 'ì´ ' + totalQty + 'ê°œ';
    document.getElementById('b-parts-low').textContent = lowStockParts.length + 'ì¢…';
    document.getElementById('b-parts-low-list').textContent = lowStockNames ? lowStockNames + (lowStockParts.length > 3 ? '...' : '') : '-';
    document.getElementById('b-parts-value').textContent = fmt(totalValue);
    
    // í…Œì´ë¸”
    let h = '';
    parts.forEach(p => {
        const isLow = p.stock <= p.min_stock;
        const isZero = p.stock === 0;
        const statusBadge = isZero ? ['badge-failed', 'í’ˆì ˆ'] : isLow ? ['badge-low', 'ë¶€ì¡±'] : ['badge-normal', 'ì •ìƒ'];
        h += `<tr class="cursor-pointer hover:bg-white/5">
            <td class="font-bold" onclick="editParts(${p.id})">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td class="${isZero ? 'text-red-400' : isLow ? 'text-orange-400' : ''} font-bold">${p.stock}ê°œ</td>
            <td class="text-gray-500">${p.min_stock}ê°œ</td>
            <td class="text-gray-400">${fmt(p.price)}</td>
            <td class="text-blue-400">${fmt(p.stock * p.price)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td>
                <button onclick="editParts(${p.id})" class="text-lime-400 text-xs hover:underline mr-2">ìˆ˜ì •</button>
                <button onclick="deleteParts(${p.id})" class="text-red-400 text-xs hover:underline">ì‚­ì œ</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-parts-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">ë¶€í’ˆ ì—†ìŒ</td></tr>';
}

// ë¶€í’ˆ ì‚­ì œ
function deleteParts(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    broPartsList = broPartsList.filter(p => p.id !== id);
    showToast('ğŸ—‘ï¸ ë¶€í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadBroParts();
}

// ì¬ê³  ê¸ˆì•¡ ìƒì„¸ ëª¨ë‹¬
function openPartsValueModal() {
    // ë¶„ë¥˜ë³„ ì¬ê³ ê¸ˆì•¡ ì§‘ê³„
    let categoryStats = {};
    broPartsList.forEach(p => {
        if (!categoryStats[p.category]) {
            categoryStats[p.category] = { count: 0, qty: 0, value: 0 };
        }
        categoryStats[p.category].count++;
        categoryStats[p.category].qty += p.stock;
        categoryStats[p.category].value += p.stock * p.price;
    });
    
    const totalValue = broPartsList.reduce((s, p) => s + p.stock * p.price, 0);
    
    // ë¶„ë¥˜ë³„ ë°” ì°¨íŠ¸
    let barsHtml = '';
    Object.entries(categoryStats).sort((a, b) => b[1].value - a[1].value).forEach(([cat, data]) => {
        const pct = totalValue > 0 ? Math.round((data.value / totalValue) * 100) : 0;
        barsHtml += `<div class="flex items-center gap-3 mb-2">
            <span class="w-16 text-xs text-gray-400">${cat}</span>
            <div class="flex-1 h-5 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full bg-blue-400 rounded-full" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-blue-400 w-24 text-right">${fmt(data.value)}</span>
            <span class="text-xs text-gray-500 w-12">${pct}%</span>
        </div>`;
    });
    
    // ë¶€í’ˆë³„ ìƒìœ„ 5ê°œ
    const topParts = [...broPartsList].sort((a, b) => (b.stock * b.price) - (a.stock * a.price)).slice(0, 5);
    let topRows = '';
    topParts.forEach(p => {
        topRows += `<tr>
            <td class="font-bold">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td>${p.stock}ê°œ</td>
            <td class="text-blue-400 font-bold">${fmt(p.stock * p.price)}</td>
        </tr>`;
    });
    
    document.getElementById('bro-parts-value-content').innerHTML = `
        <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 mb-4 text-center">
            <div class="text-xs text-blue-400 mb-1">ì´ ì¬ê³  ê¸ˆì•¡</div>
            <div class="text-3xl font-black text-blue-400">${fmt(totalValue)}</div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ“Š ë¶„ë¥˜ë³„ ì¬ê³  ê¸ˆì•¡</div>
            ${barsHtml || '<div class="text-gray-500 text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ† ì¬ê³ ê¸ˆì•¡ Top 5</div>
            <table class="data-table">
                <thead><tr><th>ë¶€í’ˆëª…</th><th>ë¶„ë¥˜</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th></tr></thead>
                <tbody>${topRows || '<tr><td colspan="4" class="text-center text-gray-500 py-2">ë°ì´í„° ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broPartsValueModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broPartsValueModal'); showBromotorsTab('parts');" class="btn-primary flex-1">ë¶€í’ˆê´€ë¦¬ ì´ë™</button>
        </div>
    `;
    
    openModal('broPartsValueModal');
}

function openPartsModal(editId = null) {
    document.getElementById('partsForm').reset();
    document.getElementById('parts-edit-id').value = '';
    document.getElementById('parts-min').value = '5';
    
    if (editId) {
        const p = broPartsList.find(x => x.id === editId);
        if (p) {
            document.getElementById('partsModalTitle').textContent = 'ğŸ“¦ ë¶€í’ˆ ìˆ˜ì •';
            document.getElementById('partsSubmitBtn').textContent = 'ìˆ˜ì •';
            document.getElementById('parts-edit-id').value = p.id;
            document.getElementById('parts-name').value = p.name;
            document.getElementById('parts-category').value = p.category;
            document.getElementById('parts-stock').value = p.stock;
            document.getElementById('parts-price').value = p.price;
            document.getElementById('parts-min').value = p.min_stock;
        }
    } else {
        document.getElementById('partsModalTitle').textContent = 'ğŸ“¦ ë¶€í’ˆ ë“±ë¡';
        document.getElementById('partsSubmitBtn').textContent = 'ë“±ë¡';
    }
    
    openModal('partsModal');
}

function editParts(id) {
    openPartsModal(id);
}

function submitBroParts(e) {
    e.preventDefault();
    const editId = document.getElementById('parts-edit-id').value;
    const d = Object.fromEntries(new FormData(e.target));
    
    if (editId) {
        // ìˆ˜ì • ëª¨ë“œ
        const p = broPartsList.find(x => x.id === parseInt(editId));
        if (p) {
            p.name = d.name;
            p.category = d.category;
            p.stock = parseInt(d.stock) || 0;
            p.price = parseInt(d.price) || 0;
            p.min_stock = parseInt(d.min_stock) || 5;
        }
        showToast('âœ… ë¶€í’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
        // ë“±ë¡ ëª¨ë“œ
        broPartsList.push({
            id: Math.max(...broPartsList.map(p => p.id), 0) + 1,
            name: d.name,
            category: d.category,
            stock: parseInt(d.stock) || 0,
            price: parseInt(d.price) || 0,
            min_stock: parseInt(d.min_stock) || 5
        });
        showToast('âœ… ë¶€í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    
    closeModal('partsModal');
    loadBroParts();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ê³ ê°ê´€ë¦¬ =======================
function filterBroCustomers(type) {
    document.getElementById('b-cust-filter').value = type;
    loadBroCustomers();
}

function loadBroCustomers() {
    const search = document.getElementById('b-cust-search').value.toLowerCase();
    const filter = document.getElementById('b-cust-filter').value;
    
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonthStart = koreaTime.toISOString().split('T')[0].substring(0, 7) + '-01';
    
    let custs = broCustList;
    
    // í•„í„° ì ìš©
    if (filter === 'month') custs = custs.filter(c => c.last_visit >= thisMonthStart);
    if (filter === 'vip') custs = custs.filter(c => c.visits >= 3);
    if (search) custs = custs.filter(c => 
        c.name.toLowerCase().includes(search) || 
        c.phone.includes(search) || 
        (c.vehicle && c.vehicle.toLowerCase().includes(search)) ||
        (c.plate && c.plate.toLowerCase().includes(search))
    );
    
    // ìš”ì•½
    document.getElementById('b-cust-total').textContent = broCustList.length + 'ëª…';
    document.getElementById('b-cust-month').textContent = broCustList.filter(c => c.last_visit >= thisMonthStart).length + 'ëª…';
    document.getElementById('b-cust-vip').textContent = broCustList.filter(c => c.visits >= 3).length + 'ëª…';
    
    // í…Œì´ë¸”
    let h = '';
    custs.forEach(c => {
        const vipBadge = c.visits >= 3 ? '<span class="badge badge-vip ml-1">ë‹¨ê³¨</span>' : '';
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewBroCustDetail(${c.id})">
            <td class="font-bold">${c.name}${vipBadge}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle || '-'}</td>
            <td class="text-gray-400">${c.plate || '-'}</td>
            <td class="text-blue-400">${c.visits}íšŒ</td>
            <td class="text-gray-400">${c.last_visit}</td>
            <td>
                <button onclick="event.stopPropagation(); viewBroCustDetail(${c.id})" class="text-lime-400 text-xs hover:underline">ìƒì„¸</button>
            </td>
        </tr>`;
    });
    document.getElementById('b-cust-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ê³ ê° ì—†ìŒ</td></tr>';
}

// ê³ ê° ìƒì„¸ ëª¨ë‹¬
function viewBroCustDetail(custId) {
    const c = broCustList.find(x => x.id === custId);
    if (!c) return;
    
    const phoneClean = c.phone.replace(/-/g, '');
    const vipBadge = c.visits >= 3 ? '<span class="badge badge-vip">â­ ë‹¨ê³¨ ê³ ê°</span>' : '';
    
    // í•´ë‹¹ ê³ ê°ì˜ ì‘ì—… ë‚´ì—­
    const custWorks = broWorkList.filter(w => w.customer === c.name).slice(0, 5);
    let workRows = '';
    custWorks.forEach(w => {
        const statusBadge = { waiting: ['badge-pending', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[w.status] || ['', ''];
        workRows += `<tr>
            <td class="text-gray-400">${w.date}</td>
            <td>${w.work}</td>
            <td class="text-blue-400">${fmt(w.total)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    // ì´ ì´ìš© ê¸ˆì•¡
    const totalSpent = broWorkList.filter(w => w.customer === c.name).reduce((s, w) => s + w.total, 0);
    
    document.getElementById('bro-cust-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <div class="text-xl font-bold">${c.name} ${vipBadge}</div>
                    <div class="text-gray-400">${c.vehicle || '-'} Â· ${c.plate || '-'}</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">ì´ ì´ìš©ê¸ˆì•¡</div>
                    <div class="text-xl font-black text-emerald-400">${fmt(totalSpent)}</div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ë°©ë¬¸íšŸìˆ˜</span><span class="text-blue-400 font-bold">${c.visits}íšŒ</span></div>
                <div class="info-row"><span class="info-label">ìµœê·¼ë°©ë¬¸</span><span>${c.last_visit}</span></div>
            </div>
            ${c.memo ? `<div class="mt-3 p-2 rounded bg-white/5 text-xs text-gray-400">ğŸ“ ${c.memo}</div>` : ''}
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <a href="tel:${phoneClean}" class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-center hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ğŸ“ ì „í™”</div>
                <div class="text-xs text-gray-400">${c.phone}</div>
            </a>
            <a href="sms:${phoneClean}" class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-center hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ğŸ’¬ ë¬¸ì</div>
                <div class="text-xs text-gray-400">ë¬¸ì ë³´ë‚´ê¸°</div>
            </a>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ”§ ìµœê·¼ ì‘ì—… ë‚´ì—­</div>
            <table class="data-table">
                <thead><tr><th>ë‚ ì§œ</th><th>ì‘ì—…</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${workRows || '<tr><td colspan="4" class="text-center text-gray-500 py-3">ì‘ì—… ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broCustDetailModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broCustDetailModal'); showBromotorsTab('work'); document.getElementById('b-work-search').value='${c.name}'; loadBroWork();" class="btn-primary flex-1">ì „ì²´ ì‘ì—… ë³´ê¸°</button>
        </div>
    `;
    
    openModal('broCustDetailModal');
}

function submitBroCustomer(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    broCustList.push({
        id: Math.max(...broCustList.map(c => c.id), 0) + 1,
        name: d.name,
        phone: d.phone,
        vehicle: d.vehicle || '',
        plate: d.plate || '',
        memo: d.memo || '',
        visits: 0,
        last_visit: new Date().toISOString().split('T')[0]
    });
    
    showToast('âœ… ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('broCustModal');
    e.target.reset();
    loadBroCustomers();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ëŒ€ì‹œë³´ë“œ =======================
function loadBroDashboard() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // ë‚ ì§œ êµ¬ê°„ ê¸°ë³¸ê°’: ì•ìœ¼ë¡œ 7ì¼ ê¸°ì¤€ (ì˜¤ëŠ˜ - 7ì¼ ì „ ~ ì˜¤ëŠ˜)
    let startDate = document.getElementById('b-dash-start').value;
    let endDate = document.getElementById('b-dash-end').value;
    
    if (!startDate || !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
        endDate = today;
        document.getElementById('b-dash-start').value = startDate;
        document.getElementById('b-dash-end').value = endDate;
    }
    
    // ê¸°ê°„ ë‚´ ìˆ˜ì…/ì§€ì¶œ ê³„ì‚°
    const periodCashbook = broCashbookList.filter(c => c.date >= startDate && c.date <= endDate);
    const periodIncome = periodCashbook.filter(c => c.type === 'income');
    const periodExpense = periodCashbook.filter(c => c.type === 'expense');
    const incomeTotal = periodIncome.reduce((s, c) => s + c.amount, 0);
    const expenseTotal = periodExpense.reduce((s, c) => s + c.amount, 0);
    const profit = incomeTotal - expenseTotal;
    const profitRate = incomeTotal > 0 ? Math.round((profit / incomeTotal) * 100) : 0;
    
    // ê¸°ê°„ ë‚´ ì‘ì—…
    const periodWorks = broWorkList.filter(w => w.date >= startDate && w.date <= endDate);
    const workAmount = periodWorks.reduce((s, w) => s + (w.labor + w.parts_cost), 0);
    
    document.getElementById('b-today-income').textContent = fmt(incomeTotal);
    document.getElementById('b-income-count').textContent = periodIncome.length + 'ê±´';
    document.getElementById('b-month-expense').textContent = fmt(expenseTotal);
    document.getElementById('b-expense-count').textContent = periodExpense.length + 'ê±´';
    document.getElementById('b-period-work').textContent = periodWorks.length + 'ê±´';
    document.getElementById('b-work-amount').textContent = fmt(workAmount);
    document.getElementById('b-month-profit').textContent = fmt(profit);
    document.getElementById('b-profit-rate').textContent = profit >= 0 ? `ì´ìµë¥  ${profitRate}%` : 'ì ì';
    
    // ì˜¤ëŠ˜ ì‘ì—…
    const todayWorks = broWorkList.filter(w => w.date === today);
    document.getElementById('b-today-work-count').textContent = todayWorks.length + 'ê±´';
    
    let workHtml = '';
    todayWorks.slice(0, 4).forEach(w => {
        const statusBadge = { waiting: ['badge-pending', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[w.status] || ['', ''];
        workHtml += `<div class="p-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between cursor-pointer hover:bg-white/10" onclick="viewWorkDetail(${w.id})">
            <div><div class="font-bold text-sm">${w.content}</div><div class="text-xs text-gray-500">${w.customer} Â· ${w.plate}</div></div>
            <span class="badge ${statusBadge[0]}">${statusBadge[1]}</span>
        </div>`;
    });
    if (todayWorks.length > 4) {
        workHtml += `<div class="text-center py-2"><button onclick="openBroTodayWorkModal()" class="text-lime-400 text-xs hover:underline">+ ${todayWorks.length - 4}ê±´ ë”ë³´ê¸°</button></div>`;
    }
    document.getElementById('b-today-work-list').innerHTML = workHtml || '<div class="text-gray-500 text-sm text-center py-4">ì˜¤ëŠ˜ ì‘ì—… ì—†ìŒ</div>';
    
    // ì¬ê³  ë¶€ì¡±
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock);
    document.getElementById('b-low-stock-count').textContent = lowStockParts.length + 'ê±´';
    
    let stockHtml = '';
    lowStockParts.slice(0, 4).forEach(p => {
        const critical = p.stock === 0;
        stockHtml += `<div class="p-3 rounded-xl ${critical ? 'bg-red-400/10 border-red-400/30' : 'bg-orange-400/5 border-orange-400/20'} border flex items-center justify-between cursor-pointer hover:bg-orange-400/10" onclick="openBroLowStockModal()">
            <div><div class="font-bold text-sm">${p.name}</div><div class="text-xs text-gray-500">í˜„ì¬: ${p.stock}ê°œ (ìµœì†Œ: ${p.min_stock})</div></div>
            <span class="badge ${critical ? 'badge-failed' : 'badge-low'}">${critical ? 'í’ˆì ˆ' : 'ë¶€ì¡±'}</span>
        </div>`;
    });
    if (lowStockParts.length > 4) {
        stockHtml += `<div class="text-center py-2"><button onclick="openBroLowStockModal()" class="text-orange-400 text-xs hover:underline">+ ${lowStockParts.length - 4}ê±´ ë”ë³´ê¸°</button></div>`;
    }
    document.getElementById('b-low-stock-list').innerHTML = stockHtml || '<div class="text-gray-500 text-sm text-center py-4">ì¬ê³  ë¶€ì¡± ì—†ìŒ</div>';
}

// ëŒ€ì‹œë³´ë“œ ê¸°ê°„ ì„¤ì •
function setBroDashPeriod(period) {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    let startDate = today;
    if (period === 'today') {
        startDate = today;
    } else if (period === 'week') {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        startDate = sevenDaysAgo.toISOString().split('T')[0];
    } else if (period === 'month') {
        startDate = today.substring(0, 7) + '-01';
    }
    
    document.getElementById('b-dash-start').value = startDate;
    document.getElementById('b-dash-end').value = today;
    loadBroDashboard();
}

// ì˜¤ëŠ˜ ì‘ì—… ìƒì„¸ ëª¨ë‹¬
function openBroTodayWorkModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    const todayWorks = broWorkList.filter(w => w.date === today);
    const totalAmount = todayWorks.reduce((s, w) => s + w.total, 0);
    const completed = todayWorks.filter(w => w.status === 'complete').length;
    
    let tableRows = '';
    todayWorks.forEach(w => {
        const statusBadge = { waiting: ['badge-pending', 'ëŒ€ê¸°'], progress: ['badge-progress', 'ì§„í–‰ì¤‘'], complete: ['badge-complete', 'ì™„ë£Œ'] }[w.status] || ['', ''];
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="closeModal('broTodayWorkModal'); viewWorkDetail(${w.id})">
            <td class="text-lime-400">#${String(w.id).padStart(3, '0')}</td>
            <td class="font-bold">${w.customer}</td>
            <td>${w.work}</td>
            <td class="text-blue-400">${fmt(w.total)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    document.getElementById('bro-today-work-content').innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="p-4 rounded-xl bg-lime-400/10 border border-lime-400/30 text-center">
                <div class="text-xs text-lime-400 mb-1">ì „ì²´</div>
                <div class="text-xl font-black text-lime-400">${todayWorks.length}ê±´</div>
            </div>
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì™„ë£Œ</div>
                <div class="text-xl font-black text-emerald-400">${completed}ê±´</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">ë§¤ì¶œ</div>
                <div class="text-xl font-black text-blue-400">${fmt(totalAmount)}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ì ‘ìˆ˜</th><th>ê³ ê°</th><th>ì‘ì—…</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">ì‘ì—… ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broTodayWorkModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broTodayWorkModal'); showBromotorsTab('work');" class="btn-primary flex-1">ì‘ì—…ë‚´ìš© ì´ë™</button>
        </div>
    `;
    
    openModal('broTodayWorkModal');
}

// ì¬ê³  ë¶€ì¡± ìƒì„¸ ëª¨ë‹¬
function openBroLowStockModal() {
    const lowStockParts = broPartsList.filter(p => p.stock <= p.min_stock).sort((a, b) => a.stock - b.stock);
    const critical = lowStockParts.filter(p => p.stock === 0).length;
    
    let tableRows = '';
    lowStockParts.forEach(p => {
        const statusBadge = p.stock === 0 ? ['badge-failed', 'í’ˆì ˆ'] : ['badge-low', 'ë¶€ì¡±'];
        tableRows += `<tr>
            <td class="font-bold">${p.name}</td>
            <td class="text-gray-400">${p.category}</td>
            <td class="${p.stock === 0 ? 'text-red-400' : 'text-orange-400'} font-bold">${p.stock}ê°œ</td>
            <td class="text-gray-500">${p.min_stock}ê°œ</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
        </tr>`;
    });
    
    document.getElementById('bro-low-stock-content').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 text-center">
                <div class="text-xs text-orange-400 mb-1">ì¬ê³  ë¶€ì¡±</div>
                <div class="text-xl font-black text-orange-400">${lowStockParts.length}ê±´</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">í’ˆì ˆ</div>
                <div class="text-xl font-black text-red-400">${critical}ê±´</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ë¶€í’ˆëª…</th><th>ë¶„ë¥˜</th><th>í˜„ì¬</th><th>ìµœì†Œ</th><th>ìƒíƒœ</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="5" class="text-center text-gray-500 py-4">ì¬ê³  ë¶€ì¡± ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broLowStockModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broLowStockModal'); showBromotorsTab('parts');" class="btn-primary flex-1">ë¶€í’ˆê´€ë¦¬ ì´ë™</button>
        </div>
    `;
    
    openModal('broLowStockModal');
}

// ì›”ê°„ ìš”ì•½ ëª¨ë‹¬
function openBroMonthSummary() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const thisMonthStart = koreaTime.toISOString().split('T')[0].substring(0, 7) + '-01';
    const monthName = koreaTime.toISOString().split('T')[0].substring(0, 7).replace('-', 'ë…„ ') + 'ì›”';
    
    const monthData = broCashbookList.filter(c => c.date >= thisMonthStart);
    const monthIncome = monthData.filter(c => c.type === 'income').reduce((s, c) => s + c.amount, 0);
    const monthExpense = monthData.filter(c => c.type === 'expense').reduce((s, c) => s + c.amount, 0);
    const monthProfit = monthIncome - monthExpense;
    
    // ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
    let categoryStats = {};
    monthData.forEach(c => {
        const key = c.type + '-' + c.category;
        categoryStats[key] = (categoryStats[key] || 0) + c.amount;
    });
    
    let incomeBars = '', expenseBars = '';
    Object.entries(categoryStats).forEach(([key, amount]) => {
        const [type, cat] = key.split('-');
        const total = type === 'income' ? monthIncome : monthExpense;
        const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
        const bar = `<div class="flex items-center gap-3 mb-2">
            <span class="w-16 text-xs text-gray-400">${cat}</span>
            <div class="flex-1 h-3 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full ${type === 'income' ? 'bg-emerald-400' : 'bg-red-400'}" style="width:${pct}%"></div>
            </div>
            <span class="text-xs ${type === 'income' ? 'text-emerald-400' : 'text-red-400'} w-20 text-right">${fmt(amount)}</span>
        </div>`;
        if (type === 'income') incomeBars += bar;
        else expenseBars += bar;
    });
    
    document.getElementById('bro-month-summary-content').innerHTML = `
        <div class="text-center text-lg font-bold text-lime-400 mb-4">${monthName}</div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ìˆ˜ì…</div>
                <div class="text-xl font-black text-emerald-400">${fmt(monthIncome)}</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">ì§€ì¶œ</div>
                <div class="text-xl font-black text-red-400">${fmt(monthExpense)}</div>
            </div>
            <div class="p-4 rounded-xl ${monthProfit >= 0 ? 'bg-blue-400/10 border-blue-400/30' : 'bg-orange-400/10 border-orange-400/30'} text-center">
                <div class="text-xs ${monthProfit >= 0 ? 'text-blue-400' : 'text-orange-400'} mb-1">ìˆœì´ìµ</div>
                <div class="text-xl font-black ${monthProfit >= 0 ? 'text-blue-400' : 'text-orange-400'}">${fmt(monthProfit)}</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-emerald-400 mb-3">ğŸ“ˆ ìˆ˜ì… ë‚´ì—­</div>
            ${incomeBars || '<div class="text-gray-500 text-sm text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-red-400 mb-3">ğŸ“‰ ì§€ì¶œ ë‚´ì—­</div>
            ${expenseBars || '<div class="text-gray-500 text-sm text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('broMonthSummaryModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('broMonthSummaryModal'); showBromotorsTab('cashbook');" class="btn-primary flex-1">ê¸ˆì „ì¶œë‚©ë¶€ ì´ë™</button>
        </div>
    `;
    
    openModal('broMonthSummaryModal');
}

// ê¸ˆì „ì¶œë‚© í•„í„° (ëŒ€ì‹œë³´ë“œì—ì„œ í˜¸ì¶œ)
function filterBroCashbook(type) {
    showBromotorsTab('cashbook');
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    if (type === 'today') {
        document.getElementById('b-cb-date').value = today;
        document.getElementById('b-cb-type').value = '';
    } else if (type === 'month-income') {
        document.getElementById('b-cb-date').value = thisMonthStart;
        document.getElementById('b-cb-type').value = 'income';
    } else if (type === 'month-expense') {
        document.getElementById('b-cb-date').value = thisMonthStart;
        document.getElementById('b-cb-type').value = 'expense';
    }
    loadBroCashbook();
}

// ======================= ë¸Œë¡œëª¨í„°ìŠ¤: ì¹´ë“œê²°ì œ =======================
let broPaymentHistory = [];

function togglePayerType(type) {
    if (type === 'business') {
        document.getElementById('business-info').classList.remove('hidden');
    } else {
        document.getElementById('business-info').classList.add('hidden');
    }
}

function openBroCardPayModal(workId = null) {
    // ì‘ì—… ì˜µì…˜ ì—…ë°ì´íŠ¸
    let opts = '<option value="">ì‘ì—… ì„ íƒ ì•ˆí•¨</option>';
    broWorkList.filter(w => w.status !== 'complete').forEach(w => {
        opts += `<option value="${w.id}" ${workId === w.id ? 'selected' : ''}>#${String(w.id).padStart(3, '0')} ${w.customer} - ${w.work} (${fmt(w.total)})</option>`;
    });
    document.getElementById('bro-pay-work').innerHTML = opts;
    
    // ì‘ì—… ì„ íƒì‹œ ìë™ ì…ë ¥
    if (workId) {
        const work = broWorkList.find(w => w.id === workId);
        if (work) {
            document.getElementById('bro-pay-customer').value = work.customer;
            document.getElementById('bro-pay-amount').value = work.total;
            // ê³ ê° ì •ë³´ ì°¾ê¸°
            const cust = broCustList.find(c => c.name === work.customer);
            if (cust) {
                document.getElementById('bro-pay-phone').value = cust.phone;
            }
        }
    }
    
    openModal('broCardPayModal');
}

// ì‘ì—… ì„ íƒì‹œ ìë™ ì…ë ¥
document.addEventListener('DOMContentLoaded', () => {
    const workSelect = document.getElementById('bro-pay-work');
    if (workSelect) {
        workSelect.addEventListener('change', function() {
            const workId = parseInt(this.value);
            if (workId) {
                const work = broWorkList.find(w => w.id === workId);
                if (work) {
                    document.getElementById('bro-pay-customer').value = work.customer;
                    document.getElementById('bro-pay-amount').value = work.total;
                    const cust = broCustList.find(c => c.name === work.customer);
                    if (cust) {
                        document.getElementById('bro-pay-phone').value = cust.phone;
                    }
                }
            }
        });
    }
});

function processBroCardPayment(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    
    // ê²°ì œ ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” PGì‚¬ ì—°ë™ í•„ìš”)
    const paymentId = 'PAY' + Date.now();
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const time = koreaTime.toTimeString().slice(0, 5);
    
    const payment = {
        id: paymentId,
        date: today,
        time: time,
        payer_type: d.payer_type,
        customer_name: d.customer_name,
        phone: d.phone,
        card_no: '****-****-****-' + d.card_no.slice(-4),
        amount: parseInt(d.amount) || 0,
        installment: parseInt(d.installment) || 0,
        work_id: d.work_id ? parseInt(d.work_id) : null,
        memo: d.memo || '',
        status: 'success',
        biz_info: d.payer_type === 'business' ? {
            biz_no: d.biz_no,
            biz_name: d.biz_name,
            biz_ceo: d.biz_ceo
        } : null
    };
    
    broPaymentHistory.unshift(payment);
    
    // ê¸ˆì „ì¶œë‚©ë¶€ì— ìˆ˜ì… ì¶”ê°€
    broCashbookList.unshift({
        id: Math.max(...broCashbookList.map(c => c.id), 0) + 1,
        date: today,
        type: 'income',
        category: 'ì¹´ë“œê²°ì œ',
        description: `${d.customer_name} ${d.memo || 'ì¹´ë“œê²°ì œ'}`,
        amount: payment.amount
    });
    
    // ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
    if (payment.work_id) {
        const work = broWorkList.find(w => w.id === payment.work_id);
        if (work) {
            work.status = 'complete';
            work.payment_id = paymentId;
        }
    }
    
    // ê²°ì œ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
    const installText = payment.installment > 0 ? `${payment.installment}ê°œì›”` : 'ì¼ì‹œë¶ˆ';
    const payerText = payment.payer_type === 'business' ? 'ì‚¬ì—…ì/ë²•ì¸' : 'ê°œì¸';
    
    document.getElementById('bro-pay-complete-info').innerHTML = `
        <p class="text-lg">${payment.customer_name}ë‹˜</p>
        <p class="text-2xl font-black text-emerald-400">${fmt(payment.amount)}</p>
    `;
    
    document.getElementById('bro-pay-receipt').innerHTML = `
        <div class="text-center text-xs text-gray-500 mb-3">[ ê²°ì œ ì˜ìˆ˜ì¦ ]</div>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">ê²°ì œë²ˆí˜¸</span><span>${paymentId}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">ê²°ì œì¼ì‹œ</span><span>${today} ${time}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">ê²°ì œì</span><span>${payment.customer_name} (${payerText})</span></div>
            ${payment.biz_info ? `<div class="flex justify-between"><span class="text-gray-400">ì‚¬ì—…ìë²ˆí˜¸</span><span>${payment.biz_info.biz_no}</span></div>` : ''}
            ${payment.biz_info ? `<div class="flex justify-between"><span class="text-gray-400">ìƒí˜¸ëª…</span><span>${payment.biz_info.biz_name}</span></div>` : ''}
            <div class="flex justify-between"><span class="text-gray-400">ì¹´ë“œë²ˆí˜¸</span><span>${payment.card_no}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">í• ë¶€</span><span>${installText}</span></div>
            <div class="flex justify-between border-t border-white/10 pt-2 mt-2"><span class="text-gray-400">ê²°ì œê¸ˆì•¡</span><span class="text-emerald-400 font-bold">${fmt(payment.amount)}</span></div>
        </div>
    `;
    
    closeModal('broCardPayModal');
    e.target.reset();
    document.getElementById('business-info').classList.add('hidden');
    openModal('broPayCompleteModal');
    
    loadBroWork();
    loadBroCashbook();
    loadBroDashboard();
}

function printBroReceipt() {
    const receiptContent = document.getElementById('bro-pay-receipt').innerHTML;
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>ì˜ìˆ˜ì¦</title>
            <style>
                body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background: #fff; color: #000; }
                .receipt { max-width: 300px; margin: 0 auto; }
                .title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
                .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                .label { color: #666; }
                .total { font-weight: bold; color: #10B981; }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="title">ğŸï¸ ë¸Œë¡œëª¨í„°ìŠ¤</div>
                ${receiptContent.replace(/text-gray-400/g, 'label').replace(/text-emerald-400/g, 'total').replace(/bg-white\/10/g, '').replace(/border-white\/10/g, '')}
                <div style="text-align:center; margin-top:20px; color:#666; font-size:12px;">
                    ê°ì‚¬í•©ë‹ˆë‹¤. ì•ˆì „ìš´í–‰í•˜ì„¸ìš”!
                </div>
            </div>
            <scr` + `ipt>window.print(); window.close();</scr` + `ipt>
        </body>
        </html>
    `);
}

// ì‘ì—… í…Œì´ë¸”ì— ê²°ì œ ë²„íŠ¼ ì¶”ê°€ë¥¼ ìœ„í•œ loadBroWork ìˆ˜ì • í•„ìš”

// ======================= ì •ì‚°ê´€ë¦¬: ìë™ê²°ì œ(PG) =======================
const payTypeLabel = t => ({ daily: 'ì¼ì¼ê²°ì œ', weekly: 'ì£¼ì¼ê²°ì œ', monthly: 'ì›”ê²°ì œ', custom: 'ë‚ ì§œì§€ì •' }[t] || '');
const weekdayLabel = d => ['', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'][d] || '';

function filterPgPayments(status) {
    document.getElementById('pg-status').value = status;
    loadPgPayments();
}

function loadPgPayments() {
    const statusFilter = document.getElementById('pg-status').value;
    const contractFilter = document.getElementById('pg-contract-filter').value;
    const search = document.getElementById('pg-search').value.toLowerCase();
    
    let list = pgPaymentsList;
    if (statusFilter === 'active' || statusFilter === 'inactive') {
        list = list.filter(p => p.card_status === statusFilter);
    } else if (statusFilter) {
        list = list.filter(p => p.last_status === statusFilter);
    }
    if (contractFilter) list = list.filter(p => p.contract_id === parseInt(contractFilter));
    if (search) list = list.filter(p => p.customer_name.toLowerCase().includes(search));
    
    // ìš”ì•½
    document.getElementById('pg-cards').textContent = pgPaymentsList.length + 'ê±´';
    document.getElementById('pg-active').textContent = pgPaymentsList.filter(p => p.card_status === 'active').length + 'ê±´';
    document.getElementById('pg-scheduled').textContent = pgPaymentsList.filter(p => p.last_status === 'scheduled').length + 'ê±´';
    document.getElementById('pg-completed').textContent = pgPaymentsList.filter(p => p.last_status === 'success').length + 'ê±´';
    document.getElementById('pg-failed').textContent = pgPaymentsList.filter(p => p.last_status === 'failed').length + 'ê±´';
    
    // ê³„ì•½ select ì—…ë°ì´íŠ¸
    let opts = '<option value="">ê³„ì•½ ì„ íƒ</option>';
    let filterOpts = '<option value="">ì „ì²´ ê³„ì•½</option>';
    contractList.forEach(c => {
        const contractNo = '#' + String(c.id).padStart(3, '0');
        opts += `<option value="${c.id}">${contractNo} ${c.customer_name} - ${c.vehicle}</option>`;
        filterOpts += `<option value="${c.id}">${contractNo} ${c.customer_name}</option>`;
    });
    document.getElementById('pg-contract').innerHTML = opts;
    document.getElementById('pg-contract-filter').innerHTML = filterOpts;
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(p => {
        const contract = contractList.find(c => c.id === p.contract_id);
        const contractNo = '#' + String(p.contract_id).padStart(3, '0');
        const vehicle = contract ? contract.vehicle : '-';
        const contractType = contract ? (contract.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸') : '-';
        
        const cardStatusBadge = p.card_status === 'active' ? ['badge-active', 'í™œì„±'] : ['badge-failed', 'ë¹„í™œì„±'];
        
        let cycleText = '';
        if (p.pay_type === 'daily') cycleText = `ë§¤ì¼ ${p.pay_hour || 9}ì‹œ`;
        else if (p.pay_type === 'weekly') cycleText = `ë§¤ì£¼ ${weekdayLabel(p.pay_weekday)}ìš”ì¼`;
        else if (p.pay_type === 'monthly') cycleText = `ë§¤ì›” ${p.pay_day}ì¼`;
        else if (p.pay_type === 'custom') cycleText = p.pay_date || 'ë‚ ì§œì§€ì •';
        
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewPgDetail(${p.id})">
            <td class="text-lime-400 font-bold">${contractNo}</td>
            <td class="font-bold">${p.customer_name}</td>
            <td class="text-gray-400">${vehicle} <span class="text-xs text-blue-400">(${contractType})</span></td>
            <td class="text-gray-400">${p.card_no}</td>
            <td class="text-blue-400 font-bold">${fmt(p.amount)}</td>
            <td><span class="text-xs px-2 py-1 rounded bg-white/10">${cycleText}</span></td>
            <td class="text-gray-400">${p.last_pay}</td>
            <td><span class="badge ${cardStatusBadge[0]}">${cardStatusBadge[1]}</span></td>
            <td><button onclick="event.stopPropagation(); openManualPayModal(${p.id})" class="text-lime-400 text-xs hover:underline">ê²°ì œ</button></td>
        </tr>`;
    });
    document.getElementById('pg-tbody').innerHTML = h || '<tr><td colspan="9" class="text-center text-gray-500 py-6">ë“±ë¡ëœ ì¹´ë“œ ì—†ìŒ</td></tr>';
}

function togglePayOption(type) {
    document.getElementById('pg-option-daily').classList.add('hidden');
    document.getElementById('pg-option-weekly').classList.add('hidden');
    document.getElementById('pg-option-monthly').classList.add('hidden');
    document.getElementById('pg-option-custom').classList.add('hidden');
    document.getElementById('pg-option-' + type).classList.remove('hidden');
}

function openPgCardModal() {
    document.getElementById('pgForm').reset();
    document.getElementById('pg-edit-id').value = '';
    document.getElementById('pgModalTitle').textContent = 'ğŸ’³ ìë™ê²°ì œ ì¹´ë“œ ë“±ë¡';
    document.getElementById('pgSubmitBtn').textContent = 'ë“±ë¡';
    
    // ê³„ì•½ ì˜µì…˜ ì—…ë°ì´íŠ¸
    let opts = '<option value="">ê³„ì•½ ì„ íƒ</option>';
    contractList.forEach(c => {
        const contractNo = '#' + String(c.id).padStart(3, '0');
        const contractType = c.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸';
        opts += `<option value="${c.id}" data-monthly="${c.monthly}" data-customer="${c.customer_name}" data-phone="${c.phone}">${contractNo} ${c.customer_name} - ${c.vehicle} (${contractType})</option>`;
    });
    document.getElementById('pg-contract').innerHTML = opts;
    document.querySelectorAll('input[name="pay_type"]')[2].checked = true;
    togglePayOption('monthly');
    openModal('pgModal');
}

// ê³„ì•½ ì„ íƒ ì‹œ ê¸ˆì•¡ ë° ì¹´ë“œ ì†Œìœ ì ì •ë³´ ìë™ ì…ë ¥
function onPgContractChange(select) {
    const option = select.options[select.selectedIndex];
    const monthly = option.getAttribute('data-monthly');
    const customerName = option.getAttribute('data-customer');
    const phone = option.getAttribute('data-phone');
    
    if (monthly) {
        document.getElementById('pg-amount').value = monthly;
    }
    if (customerName) {
        document.getElementById('pg-card-holder').value = customerName;
    }
    if (phone) {
        document.getElementById('pg-card-phone').value = phone;
    }
}

function submitPgCard(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const contract = contractList.find(c => c.id === parseInt(d.contract_id));
    
    const newPg = {
        id: Math.max(...pgPaymentsList.map(p => p.id), 0) + 1,
        contract_id: parseInt(d.contract_id),
        customer_name: contract ? contract.customer_name : '',
        // ì¹´ë“œ ì†Œìœ ì ì •ë³´
        card_holder: d.card_holder || '',
        birth_date: d.birth_date || '',
        card_phone: d.card_phone || '',
        card_email: d.card_email || '',
        // ì¹´ë“œ ì •ë³´ (ë§ˆìŠ¤í‚¹)
        card_no: '****-****-****-' + d.card_no.slice(-4),
        expiry: d.expiry || '',
        card_company: d.card_company || '',
        // ê²°ì œ ì„¤ì •
        pay_type: d.pay_type,
        amount: parseInt(d.amount) || 0,
        last_pay: '-',
        last_status: 'scheduled',
        card_status: d.card_status || 'active',
        created_at: new Date().toISOString().split('T')[0]
    };
    
    if (d.pay_type === 'daily') newPg.pay_hour = parseInt(d.pay_hour) || 9;
    else if (d.pay_type === 'weekly') newPg.pay_weekday = parseInt(d.pay_weekday) || 1;
    else if (d.pay_type === 'monthly') newPg.pay_day = parseInt(d.pay_day) || 1;
    else if (d.pay_type === 'custom') newPg.pay_date = d.pay_date || '';
    
    pgPaymentsList.push(newPg);
    
    showToast('âœ… ì¹´ë“œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('pgModal');
    e.target.reset();
    loadPgPayments();
}

// PG ì¹´ë“œ ìƒì„¸ë³´ê¸°
function viewPgDetail(id) {
    const p = pgPaymentsList.find(x => x.id === id);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    const contractNo = '#' + String(p.contract_id).padStart(3, '0');
    const contractType = contract ? (contract.type === 'lease' ? 'ë¦¬ìŠ¤' : 'ë ŒíŠ¸') : '-';
    const cardStatusBadge = p.card_status === 'active' ? ['badge-active', 'í™œì„±'] : ['badge-failed', 'ë¹„í™œì„±'];
    
    let cycleText = '';
    if (p.pay_type === 'daily') cycleText = `ë§¤ì¼ ${p.pay_hour || 9}ì‹œ`;
    else if (p.pay_type === 'weekly') cycleText = `ë§¤ì£¼ ${weekdayLabel(p.pay_weekday)}ìš”ì¼`;
    else if (p.pay_type === 'monthly') cycleText = `ë§¤ì›” ${p.pay_day}ì¼`;
    else if (p.pay_type === 'custom') cycleText = p.pay_date;
    
    // ê²°ì œ ì´ë ¥
    const history = paymentHistory.filter(h => h.pg_id === p.id).slice(0, 5);
    let historyRows = '';
    history.forEach(h => {
        const statusBadge = h.status === 'success' ? ['badge-success', 'ì„±ê³µ'] : ['badge-failed', 'ì‹¤íŒ¨'];
        historyRows += `<tr>
            <td class="text-gray-400">${h.date}</td>
            <td class="text-blue-400">${fmt(h.amount)}</td>
            <td><span class="badge ${statusBadge[0]}">${statusBadge[1]}</span></td>
            <td class="text-gray-500 text-xs">${h.fail_reason || '-'}</td>
        </tr>`;
    });
    
    document.getElementById('pg-detail-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ“‹ ê³„ì•½ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³„ì•½ë²ˆí˜¸</span><span class="text-lime-400 font-bold">${contractNo}</span></div>
                <div class="info-row"><span class="info-label">ê³„ì•½ìœ í˜•</span><span class="text-blue-400">${contractType}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì°¨ëŸ‰</span><span>${contract ? contract.vehicle : '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-blue-400/5 border border-blue-400/20 mb-4">
            <div class="text-xs text-blue-400 mb-3">ğŸ‘¤ ì¹´ë“œ ì†Œìœ ì ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì†Œìœ ìëª…</span><span class="font-bold">${p.card_holder || p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ìƒë…„ì›”ì¼</span><span>${p.birth_date || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${p.card_phone || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì´ë©”ì¼</span><span>${p.card_email || '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-emerald-400/5 border border-emerald-400/20 mb-4">
            <div class="text-xs text-emerald-400 mb-3">ğŸ’³ ì¹´ë“œ ì •ë³´</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ì¹´ë“œë²ˆí˜¸</span><span class="font-mono">${p.card_no}</span></div>
                <div class="info-row"><span class="info-label">ìœ íš¨ê¸°ê°„</span><span>${p.expiry || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì¹´ë“œì‚¬</span><span>${p.card_company || '-'}</span></div>
                <div class="info-row"><span class="info-label">ì¹´ë“œìƒíƒœ</span><span class="badge ${cardStatusBadge[0]}">${cardStatusBadge[1]}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="text-xs text-gray-400 mb-3">â° ê²°ì œ ì„¤ì •</div>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê²°ì œê¸ˆì•¡</span><span class="text-blue-400 font-bold">${fmt(p.amount)}</span></div>
                <div class="info-row"><span class="info-label">ê²°ì œì£¼ê¸°</span><span>${cycleText}</span></div>
                <div class="info-row"><span class="info-label">ìµœê·¼ê²°ì œ</span><span>${p.last_pay}</span></div>
                <div class="info-row"><span class="info-label">ë“±ë¡ì¼</span><span>${p.created_at}</span></div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ“‹ ìµœê·¼ ê²°ì œ ì´ë ¥</div>
            <table class="data-table">
                <thead><tr><th>ì¼ì</th><th>ê¸ˆì•¡</th><th>ê²°ê³¼</th><th>ì‚¬ìœ </th></tr></thead>
                <tbody>${historyRows || '<tr><td colspan="4" class="text-center text-gray-500 py-3">ê²°ì œ ì´ë ¥ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="toggleCardStatus(${p.id})" class="btn-secondary flex-1">${p.card_status === 'active' ? 'ğŸ”’ ë¹„í™œì„±í™”' : 'ğŸ”“ í™œì„±í™”'}</button>
            <button onclick="deletePgCard(${p.id})" class="btn-danger flex-1">ğŸ—‘ï¸ ì‚­ì œ</button>
            <button onclick="closeModal('pgDetailModal'); openManualPayModal(${p.id});" class="btn-primary flex-1">ğŸ’³ ê²°ì œ</button>
        </div>
    `;
    
    openModal('pgDetailModal');
}

// ìˆ˜ë™ ê²°ì œ ëª¨ë‹¬
function openManualPayModal(pgId) {
    const p = pgPaymentsList.find(x => x.id === pgId);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    const contractNo = '#' + String(p.contract_id).padStart(3, '0');
    
    document.getElementById('manual-pay-pg-id').value = pgId;
    document.getElementById('manual-pay-amount').value = p.amount;
    document.getElementById('manual-pay-date').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('manual-pay-info').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³„ì•½ë²ˆí˜¸</span><span class="text-lime-400 font-bold">${contractNo}</span></div>
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${p.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì¹´ë“œë²ˆí˜¸</span><span>${p.card_no}</span></div>
                <div class="info-row"><span class="info-label">ë¯¸ë‚©ê¸ˆ</span><span class="text-orange-400">${contract ? fmt(contract.arrears) : '-'}</span></div>
            </div>
        </div>
    `;
    
    openModal('manualPayModal');
}

// ìˆ˜ë™ ê²°ì œ ì‹¤í–‰
function executeManualPayment(e) {
    e.preventDefault();
    const pgId = parseInt(document.getElementById('manual-pay-pg-id').value);
    const amount = parseInt(document.getElementById('manual-pay-amount').value) || 0;
    const date = document.getElementById('manual-pay-date').value;
    const memo = e.target.memo ? e.target.memo.value : '';
    
    const p = pgPaymentsList.find(x => x.id === pgId);
    if (!p) return;
    
    const contract = contractList.find(c => c.id === p.contract_id);
    
    // ê²°ì œ ì²˜ë¦¬
    p.last_pay = date;
    p.last_status = 'success';
    
    // ê²°ì œ ì´ë ¥ ì¶”ê°€
    paymentHistory.unshift({
        id: Math.max(...paymentHistory.map(h => h.id), 0) + 1,
        pg_id: pgId,
        contract_id: p.contract_id,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5),
        status: 'success',
        method: 'PG'
    });
    
    // ì›ì¥ì— ìˆ˜ë‚© ê¸°ë¡
    ledgerList.unshift({
        id: Math.max(...ledgerList.map(l => l.id), 0) + 1,
        date: date,
        contract_id: p.contract_id,
        customer_name: p.customer_name,
        type: 'receipt',
        desc: `ì¹´ë“œê²°ì œ${memo ? ' - ' + memo : ''}`,
        accrual: 0,
        receipt: amount,
        method: 'PG'
    });
    
    // ê³„ì•½ ë¯¸ë‚©ê¸ˆ ì°¨ê°
    if (contract) {
        contract.arrears = Math.max(0, contract.arrears - amount);
        if (contract.arrears === 0) {
            contract.status = 'active';
            contract.delinquent_days = 0;
        }
    }
    
    // ìµœê·¼ê²°ì œ ë‚´ì—­ì— ì¶”ê°€
    recentPayments.unshift({
        id: Math.max(...recentPayments.map(r => r.id), 0) + 1,
        customer_name: p.customer_name,
        amount: amount,
        date: date,
        time: new Date().toTimeString().slice(0, 5)
    });
    
    showToast(`âœ… ${p.customer_name}ë‹˜ ${fmt(amount)} ê²°ì œ ì™„ë£Œ`);
    closeModal('manualPayModal');
    loadPgPayments();
    loadOverview();
}

// ì¹´ë“œ ìƒíƒœ í† ê¸€
function toggleCardStatus(id) {
    const p = pgPaymentsList.find(x => x.id === id);
    if (p) {
        p.card_status = p.card_status === 'active' ? 'inactive' : 'active';
        showToast(`âœ… ì¹´ë“œê°€ ${p.card_status === 'active' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤`);
        closeModal('pgDetailModal');
        loadPgPayments();
    }
}

// ì¹´ë“œ ì‚­ì œ
function deletePgCard(id) {
    if (!confirm('ì •ë§ ì´ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    pgPaymentsList = pgPaymentsList.filter(p => p.id !== id);
    showToast('âœ… ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('pgDetailModal');
    loadPgPayments();
}

// ======================= ì •ì‚°ê´€ë¦¬: ì›ì¥ =======================
function filterLedger(type) {
    if (type === 'arrears') {
        // ë¯¸ìˆ˜ê¸ˆë§Œ í‘œì‹œ (ì”ì•¡ì´ ë‚¨ì•„ìˆëŠ” ê³ ê°)
        document.getElementById('ledger-type').value = '';
    } else {
        document.getElementById('ledger-type').value = type;
    }
    loadLedger();
}

function loadLedger() {
    const typeFilter = document.getElementById('ledger-type').value;
    const contractFilter = document.getElementById('ledger-contract').value;
    const startDate = document.getElementById('ledger-start').value;
    const endDate = document.getElementById('ledger-end').value;
    
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
    const today = koreaTime.toISOString().split('T')[0];
    
    // ì´ë²ˆë‹¬ ì‹œì‘ì¼ (ìš”ì•½ ì¹´ë“œìš©)
    const thisMonthStart = today.substring(0, 7) + '-01';
    
    // ê¸°ë³¸ê°’: ìµœê·¼ 7ì¼
    if (!startDate && !endDate) {
        const sevenDaysAgo = new Date(koreaTime.getTime() - (6 * 24 * 60 * 60 * 1000));
        document.getElementById('ledger-start').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('ledger-end').value = today;
    }
    
    const filterStart = document.getElementById('ledger-start').value;
    const filterEnd = document.getElementById('ledger-end').value;
    
    // í…Œì´ë¸”ìš© í•„í„°ë§
    let list = ledgerList;
    if (typeFilter) list = list.filter(l => l.type === typeFilter);
    if (contractFilter) list = list.filter(l => l.contract_id === parseInt(contractFilter));
    if (filterStart) list = list.filter(l => l.date >= filterStart);
    if (filterEnd) list = list.filter(l => l.date <= filterEnd);
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© (ì›ì¥ ê¸°ì¤€)
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const monthReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    
    // ì´ë²ˆë‹¬ ì˜ˆìƒ ìˆ˜ìµ (í™œì„± ê³„ì•½ ê¸°ì¤€)
    const activeContracts = contractList.filter(c => c.status === 'active');
    const expectedMonthly = activeContracts.reduce((s, c) => s + c.monthly, 0);
    
    // ìˆ˜ë‚©ë¥  = ì‹¤ì œìˆ˜ë‚© / ì˜ˆìƒìˆ˜ìµ (%)
    const monthRate = expectedMonthly > 0 ? Math.round((monthReceipt / expectedMonthly) * 100) : 0;
    
    // ì´ ë¯¸ìˆ˜ê¸ˆ (ê³„ì•½ ê¸°ì¤€)
    const contractsWithArrears = contractList.filter(c => c.arrears > 0);
    const totalArrears = contractsWithArrears.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('ledger-receipt').textContent = fmt(monthReceipt);
    document.getElementById('ledger-receipt-count').textContent = thisMonthReceipts.length + 'ê±´';
    document.getElementById('ledger-arrears').textContent = fmt(totalArrears);
    document.getElementById('ledger-arrears-count').textContent = contractsWithArrears.length + 'ê±´';
    document.getElementById('ledger-rate').textContent = monthRate + '%';
    
    // ê³„ì•½ select ì—…ë°ì´íŠ¸
    let opts = '<option value="">ì „ì²´ ê³„ì•½</option>';
    contractList.forEach(c => {
        opts += `<option value="${c.id}">${c.customer_name} - ${c.vehicle}</option>`;
    });
    document.getElementById('ledger-contract').innerHTML = opts;
    if (contractFilter) document.getElementById('ledger-contract').value = contractFilter;
    
    document.getElementById('ledger-date').value = today;
    
    // í…Œì´ë¸” (ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ)
    list.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    
    let h = '', balance = 0;
    // ì”ì•¡ ê³„ì‚°ì„ ìœ„í•´ ì „ì²´ ë°ì´í„°ë¡œ ê³„ì‚°
    ledgerList.forEach(l => {
        balance += l.accrual - l.receipt;
    });
    
    list.forEach(l => {
        const typeBadge = { accrual: ['badge-accrual', 'ë°œìƒ'], receipt: ['badge-receipt', 'ìˆ˜ë‚©'], adjust: ['badge-adjust', 'ì¡°ì •'] }[l.type] || ['', ''];
        const methodLabel = l.method ? `<span class="text-xs text-gray-500 ml-1">(${l.method})</span>` : '';
        h += `<tr>
            <td class="text-gray-400">${l.date}</td>
            <td class="font-bold">${l.customer_name}</td>
            <td><span class="badge ${typeBadge[0]}">${typeBadge[1]}</span></td>
            <td>${l.desc}${methodLabel}</td>
            <td class="${l.accrual > 0 ? 'text-orange-400' : 'text-gray-500'}">${l.accrual > 0 ? fmt(l.accrual) : '-'}</td>
            <td class="${l.receipt > 0 ? 'text-emerald-400' : 'text-gray-500'}">${l.receipt > 0 ? fmt(l.receipt) : '-'}</td>
            <td class="font-bold">${fmt(balance)}</td>
        </tr>`;
    });
    document.getElementById('ledger-tbody').innerHTML = h || '<tr><td colspan="7" class="text-center text-gray-500 py-6">ë‚´ì—­ ì—†ìŒ</td></tr>';
    
    // ìˆ˜ë‚© ë°©ë²•ë³„ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
    updateLedgerChart(thisMonthReceipts, monthReceipt, today.substring(0, 7).replace('-', 'ë…„ ') + 'ì›”');
}

// ìˆ˜ë‚© ë°©ë²•ë³„ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
function updateLedgerChart(receipts, total, monthLabel) {
    document.getElementById('ledger-month-label').textContent = monthLabel;
    document.getElementById('ledger-pie-total').textContent = fmt(total);
    
    // ê²°ì œ ë°©ë²•ë³„ ì§‘ê³„
    let methodStats = { 'ì¹´ë“œ': 0, 'í˜„ê¸ˆ': 0, 'ì´ì²´': 0, 'ê¸°íƒ€': 0 };
    receipts.forEach(l => {
        const method = l.method || 'ê¸°íƒ€';
        if (method.includes('ì¹´ë“œ') || method === 'PG') methodStats['ì¹´ë“œ'] += l.receipt;
        else if (method.includes('í˜„ê¸ˆ')) methodStats['í˜„ê¸ˆ'] += l.receipt;
        else if (method.includes('ì´ì²´') || method.includes('ê³„ì¢Œ')) methodStats['ì´ì²´'] += l.receipt;
        else methodStats['ê¸°íƒ€'] += l.receipt;
    });
    
    const colors = { 'ì¹´ë“œ': '#3B82F6', 'í˜„ê¸ˆ': '#10B981', 'ì´ì²´': '#F59E0B', 'ê¸°íƒ€': '#9CA3AF' };
    const icons = { 'ì¹´ë“œ': 'ğŸ’³', 'í˜„ê¸ˆ': 'ğŸ’µ', 'ì´ì²´': 'ğŸ¦', 'ê¸°íƒ€': 'ğŸ“‹' };
    
    // ë§‰ëŒ€ ê·¸ë˜í”„
    let barsHtml = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        if (amount > 0 || method !== 'ê¸°íƒ€') {
            const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
            barsHtml += `<div class="flex items-center gap-3">
                <span class="w-12 text-xs">${icons[method]} ${method}</span>
                <div class="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                    <div class="h-full rounded-full" style="width:${pct}%; background:${colors[method]}"></div>
                </div>
                <span class="text-xs w-20 text-right" style="color:${colors[method]}">${fmt(amount)}</span>
                <span class="text-xs text-gray-500 w-10">${pct}%</span>
            </div>`;
        }
    });
    document.getElementById('ledger-method-bars').innerHTML = barsHtml || '<div class="text-gray-500 text-sm text-center py-4">ë°ì´í„° ì—†ìŒ</div>';
    
    // ì›í˜• ê·¸ë˜í”„ (SVG stroke-dasharray)
    const circumference = 2 * Math.PI * 16; // ì•½ 100.53
    let offset = 0;
    
    const cardPct = total > 0 ? (methodStats['ì¹´ë“œ'] / total) * 100 : 0;
    const cashPct = total > 0 ? (methodStats['í˜„ê¸ˆ'] / total) * 100 : 0;
    const transferPct = total > 0 ? (methodStats['ì´ì²´'] / total) * 100 : 0;
    
    document.getElementById('ledger-pie-card').style.strokeDasharray = `${cardPct} ${100 - cardPct}`;
    document.getElementById('ledger-pie-card').style.strokeDashoffset = -offset;
    offset += cardPct;
    
    document.getElementById('ledger-pie-cash').style.strokeDasharray = `${cashPct} ${100 - cashPct}`;
    document.getElementById('ledger-pie-cash').style.strokeDashoffset = -offset;
    offset += cashPct;
    
    document.getElementById('ledger-pie-transfer').style.strokeDasharray = `${transferPct} ${100 - transferPct}`;
    document.getElementById('ledger-pie-transfer').style.strokeDashoffset = -offset;
    
    // ë²”ë¡€
    let legendHtml = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        if (amount > 0) {
            const pct = total > 0 ? Math.round((amount / total) * 100) : 0;
            legendHtml += `<div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background:${colors[method]}"></div>
                <span class="text-xs text-gray-400">${method}</span>
                <span class="text-xs font-bold" style="color:${colors[method]}">${pct}%</span>
            </div>`;
        }
    });
    document.getElementById('ledger-method-legend').innerHTML = legendHtml || '<div class="text-xs text-gray-500">ë°ì´í„° ì—†ìŒ</div>';
}

// ì´ë²ˆë‹¬ ìˆ˜ë‚© ìƒì„¸ ëª¨ë‹¬
function openMonthlyReceiptModal() {
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const thisMonthStart = today.substring(0, 7) + '-01';
    const monthName = today.substring(0, 7).replace('-', 'ë…„ ') + 'ì›”';
    
    // ì´ë²ˆë‹¬ ìˆ˜ë‚© ë‚´ì—­
    const thisMonthReceipts = ledgerList.filter(l => l.type === 'receipt' && l.date >= thisMonthStart && l.date <= today);
    const totalReceipt = thisMonthReceipts.reduce((s, l) => s + l.receipt, 0);
    
    // ê³ ê°ë³„ ìˆ˜ë‚© ì§‘ê³„
    let customerStats = {};
    thisMonthReceipts.forEach(l => {
        if (!customerStats[l.customer_name]) {
            customerStats[l.customer_name] = { name: l.customer_name, amount: 0, count: 0, lastDate: l.date };
        }
        customerStats[l.customer_name].amount += l.receipt;
        customerStats[l.customer_name].count++;
        if (l.date > customerStats[l.customer_name].lastDate) {
            customerStats[l.customer_name].lastDate = l.date;
        }
    });
    
    const customerList = Object.values(customerStats).sort((a, b) => b.amount - a.amount);
    
    // ê²°ì œ ë°©ë²•ë³„ ì§‘ê³„
    let methodStats = {};
    thisMonthReceipts.forEach(l => {
        const method = l.method || 'ê¸°íƒ€';
        methodStats[method] = (methodStats[method] || 0) + l.receipt;
    });
    
    let tableRows = '';
    customerList.forEach(c => {
        tableRows += `<tr>
            <td class="font-bold">${c.name}</td>
            <td class="text-emerald-400 font-bold">${fmt(c.amount)}</td>
            <td class="text-gray-400">${c.count}ê±´</td>
            <td class="text-gray-400">${c.lastDate}</td>
        </tr>`;
    });
    
    let methodBars = '';
    Object.entries(methodStats).forEach(([method, amount]) => {
        const pct = totalReceipt > 0 ? Math.round((amount / totalReceipt) * 100) : 0;
        methodBars += `<div class="flex items-center gap-3 mb-2">
            <span class="w-20 text-xs text-gray-400">${method}</span>
            <div class="flex-1 h-4 bg-white/10 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-400" style="width:${pct}%"></div>
            </div>
            <span class="text-xs text-emerald-400 w-16 text-right">${fmt(amount)}</span>
        </div>`;
    });
    
    document.getElementById('monthly-receipt-content').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì´ ìˆ˜ë‚©ê¸ˆì•¡</div>
                <div class="text-2xl font-black text-emerald-400">${fmt(totalReceipt)}</div>
            </div>
            <div class="p-4 rounded-xl bg-blue-400/10 border border-blue-400/30 text-center">
                <div class="text-xs text-blue-400 mb-1">ìˆ˜ë‚© ê±´ìˆ˜</div>
                <div class="text-2xl font-black text-blue-400">${thisMonthReceipts.length}ê±´</div>
            </div>
        </div>
        
        <div class="glass-card rounded-xl p-4 mb-4">
            <div class="text-xs text-lime-400 mb-3">ğŸ’³ ê²°ì œë°©ë²•ë³„</div>
            ${methodBars || '<div class="text-gray-500 text-sm text-center py-2">ë°ì´í„° ì—†ìŒ</div>'}
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:300px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³ ê°ëª…</th><th>ìˆ˜ë‚©ê¸ˆì•¡</th><th>ê±´ìˆ˜</th><th>ìµœê·¼ìˆ˜ë‚©</th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="4" class="text-center text-gray-500 py-4">ìˆ˜ë‚© ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('monthlyReceiptModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('monthlyReceiptModal'); showSettlementTab('ledger'); document.getElementById('ledger-type').value='receipt'; loadLedger();" class="btn-primary flex-1">ì „ì²´ ë‚´ì—­ ë³´ê¸°</button>
        </div>
    `;
    
    openModal('monthlyReceiptModal');
}

// ë¯¸ìˆ˜ê¸ˆ í•„í„° (ì›ì¥ í…Œì´ë¸”ì—ì„œ ë¯¸ìˆ˜ê¸ˆ ìˆëŠ” ê³„ì•½ë§Œ ë³´ê¸°)
function filterLedgerUnpaid() {
    // ë¯¸ìˆ˜ê¸ˆ ìˆëŠ” ê³„ì•½ ëª©ë¡
    const unpaidContracts = contractList.filter(c => c.arrears > 0);
    
    if (unpaidContracts.length === 0) {
        showToast('ë¯¸ìˆ˜ê¸ˆì´ ìˆëŠ” ê³„ì•½ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
    }
    
    let tableRows = '';
    unpaidContracts.sort((a, b) => b.arrears - a.arrears).forEach(c => {
        const customer = customerList.find(cu => cu.name === c.customer_name);
        const phoneClean = c.phone.replace(/-/g, '');
        
        tableRows += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewArrearsDetail(${c.id})">
            <td class="font-bold text-lime-400">#${String(c.id).padStart(3, '0')}</td>
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="text-red-400">${c.delinquent_days || 0}ì¼</td>
            <td>
                <div class="flex gap-2">
                    <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="text-blue-400 text-xs hover:underline">ğŸ“</a>
                    <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" onclick="event.stopPropagation()" class="text-emerald-400 text-xs hover:underline">ğŸ’¬</a>
                </div>
            </td>
        </tr>`;
    });
    
    const totalArrears = unpaidContracts.reduce((s, c) => s + c.arrears, 0);
    
    document.getElementById('unpaid-list-content').innerHTML = `
        <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 mb-4 text-center">
            <div class="text-xs text-orange-400 mb-1">ì´ ë¯¸ìˆ˜ê¸ˆ</div>
            <div class="text-2xl font-black text-orange-400">${fmt(totalArrears)}</div>
            <div class="text-xs text-gray-500 mt-1">${unpaidContracts.length}ê±´</div>
        </div>
        
        <div class="glass-card rounded-xl overflow-hidden mb-4" style="max-height:350px; overflow-y:auto;">
            <table class="data-table">
                <thead><tr><th>ê³„ì•½ë²ˆí˜¸</th><th>ê³ ê°ëª…</th><th>ì°¨ëŸ‰</th><th>ë¯¸ìˆ˜ê¸ˆ</th><th>ì—°ì²´ì¼</th><th>ì—°ë½</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('unpaidListModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="closeModal('unpaidListModal'); showSettlementTab('delinquent');" class="btn-primary flex-1">ì—°ì²´ê´€ë¦¬ ì´ë™</button>
        </div>
    `;
    
    openModal('unpaidListModal');
}

// ìˆ˜ë‚©ë¥  ìƒì„¸ ëª¨ë‹¬
function openCollectionRateModal() {
    const totalAccrual = ledgerList.reduce((s, l) => s + l.accrual, 0);
    const totalReceipt = ledgerList.reduce((s, l) => s + l.receipt, 0);
    const arrears = totalAccrual - totalReceipt;
    const rate = totalAccrual > 0 ? Math.round((totalReceipt / totalAccrual) * 100) : 0;
    
    // ê³„ì•½ë³„ ìˆ˜ë‚©ë¥  ê³„ì‚°
    let contractStats = [];
    contractList.forEach(c => {
        const cLedger = ledgerList.filter(l => l.contract_id === c.id);
        const cAccrual = cLedger.reduce((s, l) => s + l.accrual, 0);
        const cReceipt = cLedger.reduce((s, l) => s + l.receipt, 0);
        const cRate = cAccrual > 0 ? Math.round((cReceipt / cAccrual) * 100) : 100;
        contractStats.push({
            id: c.id,
            name: c.customer_name,
            vehicle: c.vehicle,
            accrual: cAccrual,
            receipt: cReceipt,
            arrears: cAccrual - cReceipt,
            rate: cRate
        });
    });
    
    // ìˆ˜ë‚©ë¥  ë‚®ì€ ìˆœ ì •ë ¬
    contractStats.sort((a, b) => a.rate - b.rate);
    
    let tableRows = '';
    contractStats.forEach(s => {
        const rateColor = s.rate >= 100 ? 'text-emerald-400' : s.rate >= 80 ? 'text-blue-400' : s.rate >= 50 ? 'text-yellow-400' : 'text-red-400';
        const barWidth = Math.min(s.rate, 100);
        tableRows += `<tr>
            <td class="font-bold">${s.name}</td>
            <td class="text-gray-400">${s.vehicle}</td>
            <td class="text-orange-400">${fmt(s.accrual)}</td>
            <td class="text-emerald-400">${fmt(s.receipt)}</td>
            <td class="${s.arrears > 0 ? 'text-red-400' : 'text-gray-500'}">${s.arrears > 0 ? fmt(s.arrears) : '-'}</td>
            <td>
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full ${s.rate >= 100 ? 'bg-emerald-400' : s.rate >= 80 ? 'bg-blue-400' : s.rate >= 50 ? 'bg-yellow-400' : 'bg-red-400'}" style="width:${barWidth}%"></div>
                    </div>
                    <span class="${rateColor} font-bold text-sm">${s.rate}%</span>
                </div>
            </td>
        </tr>`;
    });
    
    document.getElementById('collection-rate-content').innerHTML = `
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="p-4 rounded-xl bg-orange-400/10 border border-orange-400/30 text-center">
                <div class="text-xs text-orange-400 mb-1">ì´ ë°œìƒì•¡</div>
                <div class="text-xl font-black text-orange-400">${fmt(totalAccrual)}</div>
            </div>
            <div class="p-4 rounded-xl bg-emerald-400/10 border border-emerald-400/30 text-center">
                <div class="text-xs text-emerald-400 mb-1">ì´ ìˆ˜ë‚©ì•¡</div>
                <div class="text-xl font-black text-emerald-400">${fmt(totalReceipt)}</div>
            </div>
            <div class="p-4 rounded-xl bg-red-400/10 border border-red-400/30 text-center">
                <div class="text-xs text-red-400 mb-1">ë¯¸ìˆ˜ê¸ˆ</div>
                <div class="text-xl font-black text-red-400">${fmt(arrears)}</div>
            </div>
            <div class="p-4 rounded-xl bg-purple-400/10 border border-purple-400/30 text-center">
                <div class="text-xs text-purple-400 mb-1">ì „ì²´ ìˆ˜ë‚©ë¥ </div>
                <div class="text-xl font-black text-purple-400">${rate}%</div>
            </div>
        </div>
        
        <div class="text-sm text-lime-400 font-bold mb-3">ğŸ“‹ ê³„ì•½ë³„ ìˆ˜ë‚©ë¥  (ë‚®ì€ ìˆœ)</div>
        <div class="glass-card rounded-xl overflow-hidden mb-4">
            <table class="data-table">
                <thead><tr><th>ê³ ê°ëª…</th><th>ì°¨ëŸ‰</th><th>ë°œìƒ</th><th>ìˆ˜ë‚©</th><th>ë¯¸ìˆ˜ê¸ˆ</th><th>ìˆ˜ë‚©ë¥ </th></tr></thead>
                <tbody>${tableRows || '<tr><td colspan="6" class="text-center text-gray-500 py-4">ë°ì´í„° ì—†ìŒ</td></tr>'}</tbody>
            </table>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('collectionRateModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
        </div>
    `;
    
    openModal('collectionRateModal');
}

// ì›ì¥ ë‚´ì—­ ë“±ë¡ ëª¨ë‹¬
function openLedgerModal() {
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜
    const now = new Date();
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    document.getElementById('ledger-date').value = koreaTime.toISOString().split('T')[0];
    
    // ê³„ì•½ ì˜µì…˜ ì—…ë°ì´íŠ¸
    let opts = '<option value="">ê³„ì•½ ì„ íƒ</option>';
    contractList.forEach(c => {
        opts += `<option value="${c.id}">${c.customer_name} - ${c.vehicle}</option>`;
    });
    document.getElementById('ledger-contract-select').innerHTML = opts;
    
    openModal('ledgerModal');
}

// ì›ì¥ ë‚´ì—­ ë“±ë¡ ì²˜ë¦¬
async function submitLedgerEntry(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(e.target));
    const contract = contractList.find(c => c.id === parseInt(d.contract_id));
    
    const isAccrual = d.entry_type === 'accrual';
    const isReceipt = d.entry_type === 'receipt';
    
    const ledgerData = {
        date: d.date,
        contract_id: parseInt(d.contract_id),
        customer_name: contract ? contract.customer_name : '',
        type: d.entry_type,
        description: d.desc || (isAccrual ? 'ì²­êµ¬' : isReceipt ? 'ìˆ˜ë‚©' : 'ì¡°ì •'),
        accrual: isAccrual ? parseInt(d.amount) || 0 : 0,
        receipt: isReceipt ? parseInt(d.amount) || 0 : 0,
        method: d.method
    };
    
    const result = await insertToDB('ledger', ledgerData);
    if (result && result[0]) {
        ledgerList.unshift({...result[0], desc: result[0].description});
    }
    
    // ê³„ì•½ ë¯¸ë‚©ê¸ˆ ì—…ë°ì´íŠ¸
    if (contract) {
        if (isAccrual) {
            contract.arrears += parseInt(d.amount) || 0;
        } else if (isReceipt) {
            contract.arrears = Math.max(0, contract.arrears - (parseInt(d.amount) || 0));
        }
        await updateInDB('contracts', contract.id, { arrears: contract.arrears });
    }
    
    showToast('âœ… ë‚´ì—­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeModal('ledgerModal');
    e.target.reset();
    loadLedger();
}

// ======================= ì •ì‚°ê´€ë¦¬: ì—°ì²´ê´€ë¦¬ =======================
function filterDelinquent(period) {
    document.getElementById('del-period').value = period;
    loadDelinquent();
}

function loadDelinquent() {
    const periodFilter = document.getElementById('del-period').value;
    const sortBy = document.getElementById('del-sort').value;
    const search = document.getElementById('del-search').value.toLowerCase();
    
    let list = contractList.filter(c => c.arrears > 0);
    
    if (periodFilter === '30') list = list.filter(c => (c.delinquent_days || 0) < 30);
    else if (periodFilter === '60') list = list.filter(c => (c.delinquent_days || 0) >= 30 && (c.delinquent_days || 0) < 60);
    else if (periodFilter === '90') list = list.filter(c => (c.delinquent_days || 0) >= 60);
    
    if (search) list = list.filter(c => 
        c.customer_name.toLowerCase().includes(search) || 
        c.vehicle.toLowerCase().includes(search) ||
        c.plate.toLowerCase().includes(search)
    );
    
    // ì •ë ¬
    if (sortBy === 'amount') list.sort((a, b) => b.arrears - a.arrears);
    else if (sortBy === 'days') list.sort((a, b) => (b.delinquent_days || 0) - (a.delinquent_days || 0));
    else if (sortBy === 'name') list.sort((a, b) => a.customer_name.localeCompare(b.customer_name));
    
    // ìš”ì•½
    const allDel = contractList.filter(c => c.arrears > 0);
    document.getElementById('del-count').textContent = allDel.length + 'ê±´';
    document.getElementById('del-total').textContent = fmt(allDel.reduce((s, c) => s + c.arrears, 0));
    document.getElementById('del-30').textContent = allDel.filter(c => (c.delinquent_days || 0) < 30).length + 'ê±´';
    document.getElementById('del-60').textContent = allDel.filter(c => (c.delinquent_days || 0) >= 60).length + 'ê±´';
    
    // í…Œì´ë¸”
    let h = '';
    list.forEach(c => {
        const days = c.delinquent_days || 0;
        const severity = days >= 60 ? 'text-red-500' : days >= 30 ? 'text-orange-400' : 'text-yellow-400';
        const phoneClean = c.phone.replace(/-/g, '');
        h += `<tr class="cursor-pointer hover:bg-white/5" onclick="viewArrearsDetail(${c.id})">
            <td class="font-bold">${c.customer_name}</td>
            <td class="text-gray-400">${c.phone}</td>
            <td>${c.vehicle}</td>
            <td class="text-orange-400 font-bold">${fmt(c.arrears)}</td>
            <td class="${severity} font-bold">${days}ì¼</td>
            <td class="text-gray-400">-</td>
            <td><span class="badge badge-delinquent">ì—°ì²´</span></td>
            <td>
                <div class="flex gap-2">
                    <a href="tel:${phoneClean}" onclick="event.stopPropagation()" class="text-blue-400 text-xs hover:underline">ğŸ“</a>
                    <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" onclick="event.stopPropagation()" class="text-emerald-400 text-xs hover:underline">ğŸ’¬</a>
                    <button onclick="event.stopPropagation(); openDelAction(${c.id})" class="text-lime-400 text-xs hover:underline">ê´€ë¦¬</button>
                </div>
            </td>
        </tr>`;
    });
    document.getElementById('del-tbody').innerHTML = h || '<tr><td colspan="8" class="text-center text-gray-500 py-6">ì—°ì²´ ê³„ì•½ ì—†ìŒ</td></tr>';
}

function openDelAction(contractId) {
    const c = contractList.find(x => x.id === contractId);
    if (!c) return;
    
    // ì „í™”ë²ˆí˜¸ì—ì„œ í•˜ì´í”ˆ ì œê±°
    const phoneClean = c.phone.replace(/-/g, '');
    
    document.getElementById('del-action-content').innerHTML = `
        <div class="p-4 rounded-lg bg-white/5 border border-white/10 mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="info-row"><span class="info-label">ê³ ê°ëª…</span><span class="font-bold">${c.customer_name}</span></div>
                <div class="info-row"><span class="info-label">ì—°ë½ì²˜</span><span>${c.phone}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì²´ê¸ˆì•¡</span><span class="text-orange-400 font-bold">${fmt(c.arrears)}</span></div>
                <div class="info-row"><span class="info-label">ì—°ì²´ì¼ìˆ˜</span><span class="text-red-400 font-bold">${c.delinquent_days || 0}ì¼</span></div>
            </div>
        </div>
        
        <div class="space-y-3 mb-4">
            <a href="tel:${phoneClean}" class="block w-full p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-left hover:bg-blue-500/20">
                <div class="font-bold text-blue-400">ğŸ“ ì „í™” ê±¸ê¸°</div>
                <div class="text-xs text-gray-400">${c.phone}ë¡œ ë°”ë¡œ ì „í™” ì—°ê²°</div>
            </a>
            <a href="sms:${phoneClean}?body=${encodeURIComponent('[íŒ€ë¸Œë¡œ] ' + c.customer_name + 'ë‹˜, ë¯¸ë‚©ê¸ˆ ' + fmt(c.arrears) + ' ë‚©ë¶€ ë¶€íƒë“œë¦½ë‹ˆë‹¤.')}" class="block w-full p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-left hover:bg-emerald-500/20">
                <div class="font-bold text-emerald-400">ğŸ’¬ ë¬¸ì ë³´ë‚´ê¸°</div>
                <div class="text-xs text-gray-400">ë…ì´‰ ë¬¸ì ë°”ë¡œ ë°œì†¡</div>
            </a>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('delActionModal')" class="btn-secondary flex-1">ë‹«ê¸°</button>
            <button onclick="viewArrearsDetail(${c.id}); closeModal('delActionModal');" class="btn-primary flex-1">ë¯¸ìˆ˜ê¸ˆ ìƒì„¸</button>
        </div>
    `;
    openModal('delActionModal');
}

function exportDelinquent() {
    downloadExcel('delinquent');
}
</script>
</body>
</html>
